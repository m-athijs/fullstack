(function () {
require.config({

  urlArgs: 'bust=' + window.directusData.cacheBuster,

  //deps: ["main"],

  paths: {

    // Libraries.
    "jquery":     "../assets/js/libs/jquery",
    "underscore": "../assets/js/libs/underscore",
    "backbone":   "../assets/js/libs/backbone",
    "handlebars": "../assets/js/libs/handlebars",
    "sortable":  "../assets/js/libs/sortable",
    "marked":    "../assets/js/libs/marked.min",
    "moment":     "../assets/js/libs/moment.min",
    "noty":     "../assets/js/libs/noty",
    "noty_theme": "../assets/js/libs/noty_theme",
    "polyglot":   "../assets/js/libs/polyglot.min",

    // JavaScript folders.
    "libs":       "../assets/js/libs",
    "plugins":    "../assets/js/plugins",
    "vendor":     "../assets/vendor",

    // Extensions
    "extensions": '../customs/extensions',
    "listviews":  '../customs/listviews',
    "uis":         '../customs/uis'
  },

  shim: {

    "backbone": {
      deps: ["underscore", "jquery"],
      exports: "Backbone"
    },

    "handlebars": {
      exports: "Handlebars"
    },

    "underscore": {
      exports: '_'
    },

    "noty": {
      deps: ["jquery"]
    },

    "noty_theme": {
      deps: ["jquery", "noty"]
    },

    "marked": {
      exports: 'marked'
    },

    "polyglot": {
      exports: 'Polyglot'
    },

    "plugins/jquery.flashrow": ['jquery'],

    "plugins/backbone.layoutmanager": ["backbone"],
    'plugins/backbone.trackit': ['backbone'],
    "plugins/bootstrap-dropdown": ["jquery"],
    "plugins/typeahead": ["jquery"],
    "plugins/bootstrap-tooltip": ["jquery"]
  }

});

define("config", function(){});

define('polyfills',[],function() {
  if (!String.prototype.trim) {
    String.prototype.trim = function () {
      return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
    };
  }

  if (!String.prototype.startsWith) {
    String.prototype.startsWith = function(suffix){
      return this.indexOf(suffix, this.length - suffix.length) !== -1;
    };
  }

  if (!String.prototype.endsWith) {
    String.prototype.endsWith = function(prefix) {
      return this.lastIndexOf(prefix, 0) === 0;
    }
  }
});

/*

Copyright (C) 2011 by Yehuda Katz

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/

// lib/handlebars/browser-prefix.js
var Handlebars = {};

(function(Handlebars, undefined) {
;
// lib/handlebars/base.js

Handlebars.VERSION = "1.0.0";
Handlebars.COMPILER_REVISION = 4;

Handlebars.REVISION_CHANGES = {
  1: '<= 1.0.rc.2', // 1.0.rc.2 is actually rev2 but doesn't report it
  2: '== 1.0.0-rc.3',
  3: '== 1.0.0-rc.4',
  4: '>= 1.0.0'
};

Handlebars.helpers  = {};
Handlebars.partials = {};

var toString = Object.prototype.toString,
    functionType = '[object Function]',
    objectType = '[object Object]';

Handlebars.registerHelper = function(name, fn, inverse) {
  if (toString.call(name) === objectType) {
    if (inverse || fn) { throw new Handlebars.Exception('Arg not supported with multiple helpers'); }
    Handlebars.Utils.extend(this.helpers, name);
  } else {
    if (inverse) { fn.not = inverse; }
    this.helpers[name] = fn;
  }
};

Handlebars.registerPartial = function(name, str) {
  if (toString.call(name) === objectType) {
    Handlebars.Utils.extend(this.partials,  name);
  } else {
    this.partials[name] = str;
  }
};

Handlebars.registerHelper('helperMissing', function(arg) {
  if(arguments.length === 2) {
    return undefined;
  } else {
    throw new Error("Missing helper: '" + arg + "'");
  }
});

Handlebars.registerHelper('blockHelperMissing', function(context, options) {
  var inverse = options.inverse || function() {}, fn = options.fn;

  var type = toString.call(context);

  if(type === functionType) { context = context.call(this); }

  if(context === true) {
    return fn(this);
  } else if(context === false || context == null) {
    return inverse(this);
  } else if(type === "[object Array]") {
    if(context.length > 0) {
      return Handlebars.helpers.each(context, options);
    } else {
      return inverse(this);
    }
  } else {
    return fn(context);
  }
});

Handlebars.K = function() {};

Handlebars.createFrame = Object.create || function(object) {
  Handlebars.K.prototype = object;
  var obj = new Handlebars.K();
  Handlebars.K.prototype = null;
  return obj;
};

Handlebars.logger = {
  DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3, level: 3,

  methodMap: {0: 'debug', 1: 'info', 2: 'warn', 3: 'error'},

  // can be overridden in the host environment
  log: function(level, obj) {
    if (Handlebars.logger.level <= level) {
      var method = Handlebars.logger.methodMap[level];
      if (typeof console !== 'undefined' && console[method]) {
        console[method].call(console, obj);
      }
    }
  }
};

Handlebars.log = function(level, obj) { Handlebars.logger.log(level, obj); };

Handlebars.registerHelper('each', function(context, options) {
  var fn = options.fn, inverse = options.inverse;
  var i = 0, ret = "", data;

  var type = toString.call(context);
  if(type === functionType) { context = context.call(this); }

  if (options.data) {
    data = Handlebars.createFrame(options.data);
  }

  if(context && typeof context === 'object') {
    if(context instanceof Array){
      for(var j = context.length; i<j; i++) {
        if (data) { data.index = i; }
        ret = ret + fn(context[i], { data: data });
      }
    } else {
      for(var key in context) {
        if(context.hasOwnProperty(key)) {
          if(data) { data.key = key; }
          ret = ret + fn(context[key], {data: data});
          i++;
        }
      }
    }
  }

  if(i === 0){
    ret = inverse(this);
  }

  return ret;
});

Handlebars.registerHelper('if', function(conditional, options) {
  var type = toString.call(conditional);
  if(type === functionType) { conditional = conditional.call(this); }

  if(!conditional || Handlebars.Utils.isEmpty(conditional)) {
    return options.inverse(this);
  } else {
    return options.fn(this);
  }
});

Handlebars.registerHelper('unless', function(conditional, options) {
  return Handlebars.helpers['if'].call(this, conditional, {fn: options.inverse, inverse: options.fn});
});

Handlebars.registerHelper('with', function(context, options) {
  var type = toString.call(context);
  if(type === functionType) { context = context.call(this); }

  if (!Handlebars.Utils.isEmpty(context)) return options.fn(context);
});

Handlebars.registerHelper('log', function(context, options) {
  var level = options.data && options.data.level != null ? parseInt(options.data.level, 10) : 1;
  Handlebars.log(level, context);
});
;
// lib/handlebars/compiler/parser.js
/* Jison generated parser */
var handlebars = (function(){
var parser = {trace: function trace() { },
yy: {},
symbols_: {"error":2,"root":3,"program":4,"EOF":5,"simpleInverse":6,"statements":7,"statement":8,"openInverse":9,"closeBlock":10,"openBlock":11,"mustache":12,"partial":13,"CONTENT":14,"COMMENT":15,"OPEN_BLOCK":16,"inMustache":17,"CLOSE":18,"OPEN_INVERSE":19,"OPEN_ENDBLOCK":20,"path":21,"OPEN":22,"OPEN_UNESCAPED":23,"CLOSE_UNESCAPED":24,"OPEN_PARTIAL":25,"partialName":26,"params":27,"hash":28,"dataName":29,"param":30,"STRING":31,"INTEGER":32,"BOOLEAN":33,"hashSegments":34,"hashSegment":35,"ID":36,"EQUALS":37,"DATA":38,"pathSegments":39,"SEP":40,"$accept":0,"$end":1},
terminals_: {2:"error",5:"EOF",14:"CONTENT",15:"COMMENT",16:"OPEN_BLOCK",18:"CLOSE",19:"OPEN_INVERSE",20:"OPEN_ENDBLOCK",22:"OPEN",23:"OPEN_UNESCAPED",24:"CLOSE_UNESCAPED",25:"OPEN_PARTIAL",31:"STRING",32:"INTEGER",33:"BOOLEAN",36:"ID",37:"EQUALS",38:"DATA",40:"SEP"},
productions_: [0,[3,2],[4,2],[4,3],[4,2],[4,1],[4,1],[4,0],[7,1],[7,2],[8,3],[8,3],[8,1],[8,1],[8,1],[8,1],[11,3],[9,3],[10,3],[12,3],[12,3],[13,3],[13,4],[6,2],[17,3],[17,2],[17,2],[17,1],[17,1],[27,2],[27,1],[30,1],[30,1],[30,1],[30,1],[30,1],[28,1],[34,2],[34,1],[35,3],[35,3],[35,3],[35,3],[35,3],[26,1],[26,1],[26,1],[29,2],[21,1],[39,3],[39,1]],
performAction: function anonymous(yytext,yyleng,yylineno,yy,yystate,$$,_$) {

var $0 = $$.length - 1;
switch (yystate) {
case 1: return $$[$0-1]; 
break;
case 2: this.$ = new yy.ProgramNode([], $$[$0]); 
break;
case 3: this.$ = new yy.ProgramNode($$[$0-2], $$[$0]); 
break;
case 4: this.$ = new yy.ProgramNode($$[$0-1], []); 
break;
case 5: this.$ = new yy.ProgramNode($$[$0]); 
break;
case 6: this.$ = new yy.ProgramNode([], []); 
break;
case 7: this.$ = new yy.ProgramNode([]); 
break;
case 8: this.$ = [$$[$0]]; 
break;
case 9: $$[$0-1].push($$[$0]); this.$ = $$[$0-1]; 
break;
case 10: this.$ = new yy.BlockNode($$[$0-2], $$[$0-1].inverse, $$[$0-1], $$[$0]); 
break;
case 11: this.$ = new yy.BlockNode($$[$0-2], $$[$0-1], $$[$0-1].inverse, $$[$0]); 
break;
case 12: this.$ = $$[$0]; 
break;
case 13: this.$ = $$[$0]; 
break;
case 14: this.$ = new yy.ContentNode($$[$0]); 
break;
case 15: this.$ = new yy.CommentNode($$[$0]); 
break;
case 16: this.$ = new yy.MustacheNode($$[$0-1][0], $$[$0-1][1]); 
break;
case 17: this.$ = new yy.MustacheNode($$[$0-1][0], $$[$0-1][1]); 
break;
case 18: this.$ = $$[$0-1]; 
break;
case 19:
    // Parsing out the '&' escape token at this level saves ~500 bytes after min due to the removal of one parser node.
    this.$ = new yy.MustacheNode($$[$0-1][0], $$[$0-1][1], $$[$0-2][2] === '&');
  
break;
case 20: this.$ = new yy.MustacheNode($$[$0-1][0], $$[$0-1][1], true); 
break;
case 21: this.$ = new yy.PartialNode($$[$0-1]); 
break;
case 22: this.$ = new yy.PartialNode($$[$0-2], $$[$0-1]); 
break;
case 23: 
break;
case 24: this.$ = [[$$[$0-2]].concat($$[$0-1]), $$[$0]]; 
break;
case 25: this.$ = [[$$[$0-1]].concat($$[$0]), null]; 
break;
case 26: this.$ = [[$$[$0-1]], $$[$0]]; 
break;
case 27: this.$ = [[$$[$0]], null]; 
break;
case 28: this.$ = [[$$[$0]], null]; 
break;
case 29: $$[$0-1].push($$[$0]); this.$ = $$[$0-1]; 
break;
case 30: this.$ = [$$[$0]]; 
break;
case 31: this.$ = $$[$0]; 
break;
case 32: this.$ = new yy.StringNode($$[$0]); 
break;
case 33: this.$ = new yy.IntegerNode($$[$0]); 
break;
case 34: this.$ = new yy.BooleanNode($$[$0]); 
break;
case 35: this.$ = $$[$0]; 
break;
case 36: this.$ = new yy.HashNode($$[$0]); 
break;
case 37: $$[$0-1].push($$[$0]); this.$ = $$[$0-1]; 
break;
case 38: this.$ = [$$[$0]]; 
break;
case 39: this.$ = [$$[$0-2], $$[$0]]; 
break;
case 40: this.$ = [$$[$0-2], new yy.StringNode($$[$0])]; 
break;
case 41: this.$ = [$$[$0-2], new yy.IntegerNode($$[$0])]; 
break;
case 42: this.$ = [$$[$0-2], new yy.BooleanNode($$[$0])]; 
break;
case 43: this.$ = [$$[$0-2], $$[$0]]; 
break;
case 44: this.$ = new yy.PartialNameNode($$[$0]); 
break;
case 45: this.$ = new yy.PartialNameNode(new yy.StringNode($$[$0])); 
break;
case 46: this.$ = new yy.PartialNameNode(new yy.IntegerNode($$[$0])); 
break;
case 47: this.$ = new yy.DataNode($$[$0]); 
break;
case 48: this.$ = new yy.IdNode($$[$0]); 
break;
case 49: $$[$0-2].push({part: $$[$0], separator: $$[$0-1]}); this.$ = $$[$0-2]; 
break;
case 50: this.$ = [{part: $$[$0]}]; 
break;
}
},
table: [{3:1,4:2,5:[2,7],6:3,7:4,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,5],22:[1,14],23:[1,15],25:[1,16]},{1:[3]},{5:[1,17]},{5:[2,6],7:18,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,19],20:[2,6],22:[1,14],23:[1,15],25:[1,16]},{5:[2,5],6:20,8:21,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,5],20:[2,5],22:[1,14],23:[1,15],25:[1,16]},{17:23,18:[1,22],21:24,29:25,36:[1,28],38:[1,27],39:26},{5:[2,8],14:[2,8],15:[2,8],16:[2,8],19:[2,8],20:[2,8],22:[2,8],23:[2,8],25:[2,8]},{4:29,6:3,7:4,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,5],20:[2,7],22:[1,14],23:[1,15],25:[1,16]},{4:30,6:3,7:4,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,5],20:[2,7],22:[1,14],23:[1,15],25:[1,16]},{5:[2,12],14:[2,12],15:[2,12],16:[2,12],19:[2,12],20:[2,12],22:[2,12],23:[2,12],25:[2,12]},{5:[2,13],14:[2,13],15:[2,13],16:[2,13],19:[2,13],20:[2,13],22:[2,13],23:[2,13],25:[2,13]},{5:[2,14],14:[2,14],15:[2,14],16:[2,14],19:[2,14],20:[2,14],22:[2,14],23:[2,14],25:[2,14]},{5:[2,15],14:[2,15],15:[2,15],16:[2,15],19:[2,15],20:[2,15],22:[2,15],23:[2,15],25:[2,15]},{17:31,21:24,29:25,36:[1,28],38:[1,27],39:26},{17:32,21:24,29:25,36:[1,28],38:[1,27],39:26},{17:33,21:24,29:25,36:[1,28],38:[1,27],39:26},{21:35,26:34,31:[1,36],32:[1,37],36:[1,28],39:26},{1:[2,1]},{5:[2,2],8:21,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,19],20:[2,2],22:[1,14],23:[1,15],25:[1,16]},{17:23,21:24,29:25,36:[1,28],38:[1,27],39:26},{5:[2,4],7:38,8:6,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,19],20:[2,4],22:[1,14],23:[1,15],25:[1,16]},{5:[2,9],14:[2,9],15:[2,9],16:[2,9],19:[2,9],20:[2,9],22:[2,9],23:[2,9],25:[2,9]},{5:[2,23],14:[2,23],15:[2,23],16:[2,23],19:[2,23],20:[2,23],22:[2,23],23:[2,23],25:[2,23]},{18:[1,39]},{18:[2,27],21:44,24:[2,27],27:40,28:41,29:48,30:42,31:[1,45],32:[1,46],33:[1,47],34:43,35:49,36:[1,50],38:[1,27],39:26},{18:[2,28],24:[2,28]},{18:[2,48],24:[2,48],31:[2,48],32:[2,48],33:[2,48],36:[2,48],38:[2,48],40:[1,51]},{21:52,36:[1,28],39:26},{18:[2,50],24:[2,50],31:[2,50],32:[2,50],33:[2,50],36:[2,50],38:[2,50],40:[2,50]},{10:53,20:[1,54]},{10:55,20:[1,54]},{18:[1,56]},{18:[1,57]},{24:[1,58]},{18:[1,59],21:60,36:[1,28],39:26},{18:[2,44],36:[2,44]},{18:[2,45],36:[2,45]},{18:[2,46],36:[2,46]},{5:[2,3],8:21,9:7,11:8,12:9,13:10,14:[1,11],15:[1,12],16:[1,13],19:[1,19],20:[2,3],22:[1,14],23:[1,15],25:[1,16]},{14:[2,17],15:[2,17],16:[2,17],19:[2,17],20:[2,17],22:[2,17],23:[2,17],25:[2,17]},{18:[2,25],21:44,24:[2,25],28:61,29:48,30:62,31:[1,45],32:[1,46],33:[1,47],34:43,35:49,36:[1,50],38:[1,27],39:26},{18:[2,26],24:[2,26]},{18:[2,30],24:[2,30],31:[2,30],32:[2,30],33:[2,30],36:[2,30],38:[2,30]},{18:[2,36],24:[2,36],35:63,36:[1,64]},{18:[2,31],24:[2,31],31:[2,31],32:[2,31],33:[2,31],36:[2,31],38:[2,31]},{18:[2,32],24:[2,32],31:[2,32],32:[2,32],33:[2,32],36:[2,32],38:[2,32]},{18:[2,33],24:[2,33],31:[2,33],32:[2,33],33:[2,33],36:[2,33],38:[2,33]},{18:[2,34],24:[2,34],31:[2,34],32:[2,34],33:[2,34],36:[2,34],38:[2,34]},{18:[2,35],24:[2,35],31:[2,35],32:[2,35],33:[2,35],36:[2,35],38:[2,35]},{18:[2,38],24:[2,38],36:[2,38]},{18:[2,50],24:[2,50],31:[2,50],32:[2,50],33:[2,50],36:[2,50],37:[1,65],38:[2,50],40:[2,50]},{36:[1,66]},{18:[2,47],24:[2,47],31:[2,47],32:[2,47],33:[2,47],36:[2,47],38:[2,47]},{5:[2,10],14:[2,10],15:[2,10],16:[2,10],19:[2,10],20:[2,10],22:[2,10],23:[2,10],25:[2,10]},{21:67,36:[1,28],39:26},{5:[2,11],14:[2,11],15:[2,11],16:[2,11],19:[2,11],20:[2,11],22:[2,11],23:[2,11],25:[2,11]},{14:[2,16],15:[2,16],16:[2,16],19:[2,16],20:[2,16],22:[2,16],23:[2,16],25:[2,16]},{5:[2,19],14:[2,19],15:[2,19],16:[2,19],19:[2,19],20:[2,19],22:[2,19],23:[2,19],25:[2,19]},{5:[2,20],14:[2,20],15:[2,20],16:[2,20],19:[2,20],20:[2,20],22:[2,20],23:[2,20],25:[2,20]},{5:[2,21],14:[2,21],15:[2,21],16:[2,21],19:[2,21],20:[2,21],22:[2,21],23:[2,21],25:[2,21]},{18:[1,68]},{18:[2,24],24:[2,24]},{18:[2,29],24:[2,29],31:[2,29],32:[2,29],33:[2,29],36:[2,29],38:[2,29]},{18:[2,37],24:[2,37],36:[2,37]},{37:[1,65]},{21:69,29:73,31:[1,70],32:[1,71],33:[1,72],36:[1,28],38:[1,27],39:26},{18:[2,49],24:[2,49],31:[2,49],32:[2,49],33:[2,49],36:[2,49],38:[2,49],40:[2,49]},{18:[1,74]},{5:[2,22],14:[2,22],15:[2,22],16:[2,22],19:[2,22],20:[2,22],22:[2,22],23:[2,22],25:[2,22]},{18:[2,39],24:[2,39],36:[2,39]},{18:[2,40],24:[2,40],36:[2,40]},{18:[2,41],24:[2,41],36:[2,41]},{18:[2,42],24:[2,42],36:[2,42]},{18:[2,43],24:[2,43],36:[2,43]},{5:[2,18],14:[2,18],15:[2,18],16:[2,18],19:[2,18],20:[2,18],22:[2,18],23:[2,18],25:[2,18]}],
defaultActions: {17:[2,1]},
parseError: function parseError(str, hash) {
    throw new Error(str);
},
parse: function parse(input) {
    var self = this, stack = [0], vstack = [null], lstack = [], table = this.table, yytext = "", yylineno = 0, yyleng = 0, recovering = 0, TERROR = 2, EOF = 1;
    this.lexer.setInput(input);
    this.lexer.yy = this.yy;
    this.yy.lexer = this.lexer;
    this.yy.parser = this;
    if (typeof this.lexer.yylloc == "undefined")
        this.lexer.yylloc = {};
    var yyloc = this.lexer.yylloc;
    lstack.push(yyloc);
    var ranges = this.lexer.options && this.lexer.options.ranges;
    if (typeof this.yy.parseError === "function")
        this.parseError = this.yy.parseError;
    function popStack(n) {
        stack.length = stack.length - 2 * n;
        vstack.length = vstack.length - n;
        lstack.length = lstack.length - n;
    }
    function lex() {
        var token;
        token = self.lexer.lex() || 1;
        if (typeof token !== "number") {
            token = self.symbols_[token] || token;
        }
        return token;
    }
    var symbol, preErrorSymbol, state, action, a, r, yyval = {}, p, len, newState, expected;
    while (true) {
        state = stack[stack.length - 1];
        if (this.defaultActions[state]) {
            action = this.defaultActions[state];
        } else {
            if (symbol === null || typeof symbol == "undefined") {
                symbol = lex();
            }
            action = table[state] && table[state][symbol];
        }
        if (typeof action === "undefined" || !action.length || !action[0]) {
            var errStr = "";
            if (!recovering) {
                expected = [];
                for (p in table[state])
                    if (this.terminals_[p] && p > 2) {
                        expected.push("'" + this.terminals_[p] + "'");
                    }
                if (this.lexer.showPosition) {
                    errStr = "Parse error on line " + (yylineno + 1) + ":\n" + this.lexer.showPosition() + "\nExpecting " + expected.join(", ") + ", got '" + (this.terminals_[symbol] || symbol) + "'";
                } else {
                    errStr = "Parse error on line " + (yylineno + 1) + ": Unexpected " + (symbol == 1?"end of input":"'" + (this.terminals_[symbol] || symbol) + "'");
                }
                this.parseError(errStr, {text: this.lexer.match, token: this.terminals_[symbol] || symbol, line: this.lexer.yylineno, loc: yyloc, expected: expected});
            }
        }
        if (action[0] instanceof Array && action.length > 1) {
            throw new Error("Parse Error: multiple actions possible at state: " + state + ", token: " + symbol);
        }
        switch (action[0]) {
        case 1:
            stack.push(symbol);
            vstack.push(this.lexer.yytext);
            lstack.push(this.lexer.yylloc);
            stack.push(action[1]);
            symbol = null;
            if (!preErrorSymbol) {
                yyleng = this.lexer.yyleng;
                yytext = this.lexer.yytext;
                yylineno = this.lexer.yylineno;
                yyloc = this.lexer.yylloc;
                if (recovering > 0)
                    recovering--;
            } else {
                symbol = preErrorSymbol;
                preErrorSymbol = null;
            }
            break;
        case 2:
            len = this.productions_[action[1]][1];
            yyval.$ = vstack[vstack.length - len];
            yyval._$ = {first_line: lstack[lstack.length - (len || 1)].first_line, last_line: lstack[lstack.length - 1].last_line, first_column: lstack[lstack.length - (len || 1)].first_column, last_column: lstack[lstack.length - 1].last_column};
            if (ranges) {
                yyval._$.range = [lstack[lstack.length - (len || 1)].range[0], lstack[lstack.length - 1].range[1]];
            }
            r = this.performAction.call(yyval, yytext, yyleng, yylineno, this.yy, action[1], vstack, lstack);
            if (typeof r !== "undefined") {
                return r;
            }
            if (len) {
                stack = stack.slice(0, -1 * len * 2);
                vstack = vstack.slice(0, -1 * len);
                lstack = lstack.slice(0, -1 * len);
            }
            stack.push(this.productions_[action[1]][0]);
            vstack.push(yyval.$);
            lstack.push(yyval._$);
            newState = table[stack[stack.length - 2]][stack[stack.length - 1]];
            stack.push(newState);
            break;
        case 3:
            return true;
        }
    }
    return true;
}
};
/* Jison generated lexer */
var lexer = (function(){
var lexer = ({EOF:1,
parseError:function parseError(str, hash) {
        if (this.yy.parser) {
            this.yy.parser.parseError(str, hash);
        } else {
            throw new Error(str);
        }
    },
setInput:function (input) {
        this._input = input;
        this._more = this._less = this.done = false;
        this.yylineno = this.yyleng = 0;
        this.yytext = this.matched = this.match = '';
        this.conditionStack = ['INITIAL'];
        this.yylloc = {first_line:1,first_column:0,last_line:1,last_column:0};
        if (this.options.ranges) this.yylloc.range = [0,0];
        this.offset = 0;
        return this;
    },
input:function () {
        var ch = this._input[0];
        this.yytext += ch;
        this.yyleng++;
        this.offset++;
        this.match += ch;
        this.matched += ch;
        var lines = ch.match(/(?:\r\n?|\n).*/g);
        if (lines) {
            this.yylineno++;
            this.yylloc.last_line++;
        } else {
            this.yylloc.last_column++;
        }
        if (this.options.ranges) this.yylloc.range[1]++;

        this._input = this._input.slice(1);
        return ch;
    },
unput:function (ch) {
        var len = ch.length;
        var lines = ch.split(/(?:\r\n?|\n)/g);

        this._input = ch + this._input;
        this.yytext = this.yytext.substr(0, this.yytext.length-len-1);
        //this.yyleng -= len;
        this.offset -= len;
        var oldLines = this.match.split(/(?:\r\n?|\n)/g);
        this.match = this.match.substr(0, this.match.length-1);
        this.matched = this.matched.substr(0, this.matched.length-1);

        if (lines.length-1) this.yylineno -= lines.length-1;
        var r = this.yylloc.range;

        this.yylloc = {first_line: this.yylloc.first_line,
          last_line: this.yylineno+1,
          first_column: this.yylloc.first_column,
          last_column: lines ?
              (lines.length === oldLines.length ? this.yylloc.first_column : 0) + oldLines[oldLines.length - lines.length].length - lines[0].length:
              this.yylloc.first_column - len
          };

        if (this.options.ranges) {
            this.yylloc.range = [r[0], r[0] + this.yyleng - len];
        }
        return this;
    },
more:function () {
        this._more = true;
        return this;
    },
less:function (n) {
        this.unput(this.match.slice(n));
    },
pastInput:function () {
        var past = this.matched.substr(0, this.matched.length - this.match.length);
        return (past.length > 20 ? '...':'') + past.substr(-20).replace(/\n/g, "");
    },
upcomingInput:function () {
        var next = this.match;
        if (next.length < 20) {
            next += this._input.substr(0, 20-next.length);
        }
        return (next.substr(0,20)+(next.length > 20 ? '...':'')).replace(/\n/g, "");
    },
showPosition:function () {
        var pre = this.pastInput();
        var c = new Array(pre.length + 1).join("-");
        return pre + this.upcomingInput() + "\n" + c+"^";
    },
next:function () {
        if (this.done) {
            return this.EOF;
        }
        if (!this._input) this.done = true;

        var token,
            match,
            tempMatch,
            index,
            col,
            lines;
        if (!this._more) {
            this.yytext = '';
            this.match = '';
        }
        var rules = this._currentRules();
        for (var i=0;i < rules.length; i++) {
            tempMatch = this._input.match(this.rules[rules[i]]);
            if (tempMatch && (!match || tempMatch[0].length > match[0].length)) {
                match = tempMatch;
                index = i;
                if (!this.options.flex) break;
            }
        }
        if (match) {
            lines = match[0].match(/(?:\r\n?|\n).*/g);
            if (lines) this.yylineno += lines.length;
            this.yylloc = {first_line: this.yylloc.last_line,
                           last_line: this.yylineno+1,
                           first_column: this.yylloc.last_column,
                           last_column: lines ? lines[lines.length-1].length-lines[lines.length-1].match(/\r?\n?/)[0].length : this.yylloc.last_column + match[0].length};
            this.yytext += match[0];
            this.match += match[0];
            this.matches = match;
            this.yyleng = this.yytext.length;
            if (this.options.ranges) {
                this.yylloc.range = [this.offset, this.offset += this.yyleng];
            }
            this._more = false;
            this._input = this._input.slice(match[0].length);
            this.matched += match[0];
            token = this.performAction.call(this, this.yy, this, rules[index],this.conditionStack[this.conditionStack.length-1]);
            if (this.done && this._input) this.done = false;
            if (token) return token;
            else return;
        }
        if (this._input === "") {
            return this.EOF;
        } else {
            return this.parseError('Lexical error on line '+(this.yylineno+1)+'. Unrecognized text.\n'+this.showPosition(),
                    {text: "", token: null, line: this.yylineno});
        }
    },
lex:function lex() {
        var r = this.next();
        if (typeof r !== 'undefined') {
            return r;
        } else {
            return this.lex();
        }
    },
begin:function begin(condition) {
        this.conditionStack.push(condition);
    },
popState:function popState() {
        return this.conditionStack.pop();
    },
_currentRules:function _currentRules() {
        return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules;
    },
topState:function () {
        return this.conditionStack[this.conditionStack.length-2];
    },
pushState:function begin(condition) {
        this.begin(condition);
    }});
lexer.options = {};
lexer.performAction = function anonymous(yy,yy_,$avoiding_name_collisions,YY_START) {

var YYSTATE=YY_START
switch($avoiding_name_collisions) {
case 0: yy_.yytext = "\\"; return 14; 
break;
case 1:
                                   if(yy_.yytext.slice(-1) !== "\\") this.begin("mu");
                                   if(yy_.yytext.slice(-1) === "\\") yy_.yytext = yy_.yytext.substr(0,yy_.yyleng-1), this.begin("emu");
                                   if(yy_.yytext) return 14;
                                 
break;
case 2: return 14; 
break;
case 3:
                                   if(yy_.yytext.slice(-1) !== "\\") this.popState();
                                   if(yy_.yytext.slice(-1) === "\\") yy_.yytext = yy_.yytext.substr(0,yy_.yyleng-1);
                                   return 14;
                                 
break;
case 4: yy_.yytext = yy_.yytext.substr(0, yy_.yyleng-4); this.popState(); return 15; 
break;
case 5: return 25; 
break;
case 6: return 16; 
break;
case 7: return 20; 
break;
case 8: return 19; 
break;
case 9: return 19; 
break;
case 10: return 23; 
break;
case 11: return 22; 
break;
case 12: this.popState(); this.begin('com'); 
break;
case 13: yy_.yytext = yy_.yytext.substr(3,yy_.yyleng-5); this.popState(); return 15; 
break;
case 14: return 22; 
break;
case 15: return 37; 
break;
case 16: return 36; 
break;
case 17: return 36; 
break;
case 18: return 40; 
break;
case 19: /*ignore whitespace*/ 
break;
case 20: this.popState(); return 24; 
break;
case 21: this.popState(); return 18; 
break;
case 22: yy_.yytext = yy_.yytext.substr(1,yy_.yyleng-2).replace(/\\"/g,'"'); return 31; 
break;
case 23: yy_.yytext = yy_.yytext.substr(1,yy_.yyleng-2).replace(/\\'/g,"'"); return 31; 
break;
case 24: return 38; 
break;
case 25: return 33; 
break;
case 26: return 33; 
break;
case 27: return 32; 
break;
case 28: return 36; 
break;
case 29: yy_.yytext = yy_.yytext.substr(1, yy_.yyleng-2); return 36; 
break;
case 30: return 'INVALID'; 
break;
case 31: return 5; 
break;
}
};
lexer.rules = [/^(?:\\\\(?=(\{\{)))/,/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|$)))/,/^(?:[\s\S]*?--\}\})/,/^(?:\{\{>)/,/^(?:\{\{#)/,/^(?:\{\{\/)/,/^(?:\{\{\^)/,/^(?:\{\{\s*else\b)/,/^(?:\{\{\{)/,/^(?:\{\{&)/,/^(?:\{\{!--)/,/^(?:\{\{![\s\S]*?\}\})/,/^(?:\{\{)/,/^(?:=)/,/^(?:\.(?=[}\/ ]))/,/^(?:\.\.)/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}\}\})/,/^(?:\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@)/,/^(?:true(?=[}\s]))/,/^(?:false(?=[}\s]))/,/^(?:-?[0-9]+(?=[}\s]))/,/^(?:[^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=[=}\s\/.]))/,/^(?:\[[^\]]*\])/,/^(?:.)/,/^(?:$)/];
lexer.conditions = {"mu":{"rules":[5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],"inclusive":false},"emu":{"rules":[3],"inclusive":false},"com":{"rules":[4],"inclusive":false},"INITIAL":{"rules":[0,1,2,31],"inclusive":true}};
return lexer;})()
parser.lexer = lexer;
function Parser () { this.yy = {}; }Parser.prototype = parser;parser.Parser = Parser;
return new Parser;
})();;
// lib/handlebars/compiler/base.js

Handlebars.Parser = handlebars;

Handlebars.parse = function(input) {

  // Just return if an already-compile AST was passed in.
  if(input.constructor === Handlebars.AST.ProgramNode) { return input; }

  Handlebars.Parser.yy = Handlebars.AST;
  return Handlebars.Parser.parse(input);
};
;
// lib/handlebars/compiler/ast.js
Handlebars.AST = {};

Handlebars.AST.ProgramNode = function(statements, inverse) {
  this.type = "program";
  this.statements = statements;
  if(inverse) { this.inverse = new Handlebars.AST.ProgramNode(inverse); }
};

Handlebars.AST.MustacheNode = function(rawParams, hash, unescaped) {
  this.type = "mustache";
  this.escaped = !unescaped;
  this.hash = hash;

  var id = this.id = rawParams[0];
  var params = this.params = rawParams.slice(1);

  // a mustache is an eligible helper if:
  // * its id is simple (a single part, not `this` or `..`)
  var eligibleHelper = this.eligibleHelper = id.isSimple;

  // a mustache is definitely a helper if:
  // * it is an eligible helper, and
  // * it has at least one parameter or hash segment
  this.isHelper = eligibleHelper && (params.length || hash);

  // if a mustache is an eligible helper but not a definite
  // helper, it is ambiguous, and will be resolved in a later
  // pass or at runtime.
};

Handlebars.AST.PartialNode = function(partialName, context) {
  this.type         = "partial";
  this.partialName  = partialName;
  this.context      = context;
};

Handlebars.AST.BlockNode = function(mustache, program, inverse, close) {
  var verifyMatch = function(open, close) {
    if(open.original !== close.original) {
      throw new Handlebars.Exception(open.original + " doesn't match " + close.original);
    }
  };

  verifyMatch(mustache.id, close);
  this.type = "block";
  this.mustache = mustache;
  this.program  = program;
  this.inverse  = inverse;

  if (this.inverse && !this.program) {
    this.isInverse = true;
  }
};

Handlebars.AST.ContentNode = function(string) {
  this.type = "content";
  this.string = string;
};

Handlebars.AST.HashNode = function(pairs) {
  this.type = "hash";
  this.pairs = pairs;
};

Handlebars.AST.IdNode = function(parts) {
  this.type = "ID";

  var original = "",
      dig = [],
      depth = 0;

  for(var i=0,l=parts.length; i<l; i++) {
    var part = parts[i].part;
    original += (parts[i].separator || '') + part;

    if (part === ".." || part === "." || part === "this") {
      if (dig.length > 0) { throw new Handlebars.Exception("Invalid path: " + original); }
      else if (part === "..") { depth++; }
      else { this.isScoped = true; }
    }
    else { dig.push(part); }
  }

  this.original = original;
  this.parts    = dig;
  this.string   = dig.join('.');
  this.depth    = depth;

  // an ID is simple if it only has one part, and that part is not
  // `..` or `this`.
  this.isSimple = parts.length === 1 && !this.isScoped && depth === 0;

  this.stringModeValue = this.string;
};

Handlebars.AST.PartialNameNode = function(name) {
  this.type = "PARTIAL_NAME";
  this.name = name.original;
};

Handlebars.AST.DataNode = function(id) {
  this.type = "DATA";
  this.id = id;
};

Handlebars.AST.StringNode = function(string) {
  this.type = "STRING";
  this.original =
    this.string =
    this.stringModeValue = string;
};

Handlebars.AST.IntegerNode = function(integer) {
  this.type = "INTEGER";
  this.original =
    this.integer = integer;
  this.stringModeValue = Number(integer);
};

Handlebars.AST.BooleanNode = function(bool) {
  this.type = "BOOLEAN";
  this.bool = bool;
  this.stringModeValue = bool === "true";
};

Handlebars.AST.CommentNode = function(comment) {
  this.type = "comment";
  this.comment = comment;
};
;
// lib/handlebars/utils.js

var errorProps = ['description', 'fileName', 'lineNumber', 'message', 'name', 'number', 'stack'];

Handlebars.Exception = function(message) {
  var tmp = Error.prototype.constructor.apply(this, arguments);

  // Unfortunately errors are not enumerable in Chrome (at least), so `for prop in tmp` doesn't work.
  for (var idx = 0; idx < errorProps.length; idx++) {
    this[errorProps[idx]] = tmp[errorProps[idx]];
  }
};
Handlebars.Exception.prototype = new Error();

// Build out our basic SafeString type
Handlebars.SafeString = function(string) {
  this.string = string;
};
Handlebars.SafeString.prototype.toString = function() {
  return this.string.toString();
};

var escape = {
  "&": "&amp;",
  "<": "&lt;",
  ">": "&gt;",
  '"': "&quot;",
  "'": "&#x27;",
  "`": "&#x60;"
};

var badChars = /[&<>"'`]/g;
var possible = /[&<>"'`]/;

var escapeChar = function(chr) {
  return escape[chr] || "&amp;";
};

Handlebars.Utils = {
  extend: function(obj, value) {
    for(var key in value) {
      if(value.hasOwnProperty(key)) {
        obj[key] = value[key];
      }
    }
  },

  escapeExpression: function(string) {
    // don't escape SafeStrings, since they're already safe
    if (string instanceof Handlebars.SafeString) {
      return string.toString();
    } else if (string == null || string === false) {
      return "";
    }

    // Force a string conversion as this will be done by the append regardless and
    // the regex test will do this transparently behind the scenes, causing issues if
    // an object's to string has escaped characters in it.
    string = string.toString();

    if(!possible.test(string)) { return string; }
    return string.replace(badChars, escapeChar);
  },

  isEmpty: function(value) {
    if (!value && value !== 0) {
      return true;
    } else if(toString.call(value) === "[object Array]" && value.length === 0) {
      return true;
    } else {
      return false;
    }
  }
};
;
// lib/handlebars/compiler/compiler.js

/*jshint eqnull:true*/
var Compiler = Handlebars.Compiler = function() {};
var JavaScriptCompiler = Handlebars.JavaScriptCompiler = function() {};

// the foundHelper register will disambiguate helper lookup from finding a
// function in a context. This is necessary for mustache compatibility, which
// requires that context functions in blocks are evaluated by blockHelperMissing,
// and then proceed as if the resulting value was provided to blockHelperMissing.

Compiler.prototype = {
  compiler: Compiler,

  disassemble: function() {
    var opcodes = this.opcodes, opcode, out = [], params, param;

    for (var i=0, l=opcodes.length; i<l; i++) {
      opcode = opcodes[i];

      if (opcode.opcode === 'DECLARE') {
        out.push("DECLARE " + opcode.name + "=" + opcode.value);
      } else {
        params = [];
        for (var j=0; j<opcode.args.length; j++) {
          param = opcode.args[j];
          if (typeof param === "string") {
            param = "\"" + param.replace("\n", "\\n") + "\"";
          }
          params.push(param);
        }
        out.push(opcode.opcode + " " + params.join(" "));
      }
    }

    return out.join("\n");
  },
  equals: function(other) {
    var len = this.opcodes.length;
    if (other.opcodes.length !== len) {
      return false;
    }

    for (var i = 0; i < len; i++) {
      var opcode = this.opcodes[i],
          otherOpcode = other.opcodes[i];
      if (opcode.opcode !== otherOpcode.opcode || opcode.args.length !== otherOpcode.args.length) {
        return false;
      }
      for (var j = 0; j < opcode.args.length; j++) {
        if (opcode.args[j] !== otherOpcode.args[j]) {
          return false;
        }
      }
    }

    len = this.children.length;
    if (other.children.length !== len) {
      return false;
    }
    for (i = 0; i < len; i++) {
      if (!this.children[i].equals(other.children[i])) {
        return false;
      }
    }

    return true;
  },

  guid: 0,

  compile: function(program, options) {
    this.children = [];
    this.depths = {list: []};
    this.options = options;

    // These changes will propagate to the other compiler components
    var knownHelpers = this.options.knownHelpers;
    this.options.knownHelpers = {
      'helperMissing': true,
      'blockHelperMissing': true,
      'each': true,
      'if': true,
      'unless': true,
      'with': true,
      'log': true
    };
    if (knownHelpers) {
      for (var name in knownHelpers) {
        this.options.knownHelpers[name] = knownHelpers[name];
      }
    }

    return this.program(program);
  },

  accept: function(node) {
    return this[node.type](node);
  },

  program: function(program) {
    var statements = program.statements, statement;
    this.opcodes = [];

    for(var i=0, l=statements.length; i<l; i++) {
      statement = statements[i];
      this[statement.type](statement);
    }
    this.isSimple = l === 1;

    this.depths.list = this.depths.list.sort(function(a, b) {
      return a - b;
    });

    return this;
  },

  compileProgram: function(program) {
    var result = new this.compiler().compile(program, this.options);
    var guid = this.guid++, depth;

    this.usePartial = this.usePartial || result.usePartial;

    this.children[guid] = result;

    for(var i=0, l=result.depths.list.length; i<l; i++) {
      depth = result.depths.list[i];

      if(depth < 2) { continue; }
      else { this.addDepth(depth - 1); }
    }

    return guid;
  },

  block: function(block) {
    var mustache = block.mustache,
        program = block.program,
        inverse = block.inverse;

    if (program) {
      program = this.compileProgram(program);
    }

    if (inverse) {
      inverse = this.compileProgram(inverse);
    }

    var type = this.classifyMustache(mustache);

    if (type === "helper") {
      this.helperMustache(mustache, program, inverse);
    } else if (type === "simple") {
      this.simpleMustache(mustache);

      // now that the simple mustache is resolved, we need to
      // evaluate it by executing `blockHelperMissing`
      this.opcode('pushProgram', program);
      this.opcode('pushProgram', inverse);
      this.opcode('emptyHash');
      this.opcode('blockValue');
    } else {
      this.ambiguousMustache(mustache, program, inverse);

      // now that the simple mustache is resolved, we need to
      // evaluate it by executing `blockHelperMissing`
      this.opcode('pushProgram', program);
      this.opcode('pushProgram', inverse);
      this.opcode('emptyHash');
      this.opcode('ambiguousBlockValue');
    }

    this.opcode('append');
  },

  hash: function(hash) {
    var pairs = hash.pairs, pair, val;

    this.opcode('pushHash');

    for(var i=0, l=pairs.length; i<l; i++) {
      pair = pairs[i];
      val  = pair[1];

      if (this.options.stringParams) {
        if(val.depth) {
          this.addDepth(val.depth);
        }
        this.opcode('getContext', val.depth || 0);
        this.opcode('pushStringParam', val.stringModeValue, val.type);
      } else {
        this.accept(val);
      }

      this.opcode('assignToHash', pair[0]);
    }
    this.opcode('popHash');
  },

  partial: function(partial) {
    var partialName = partial.partialName;
    this.usePartial = true;

    if(partial.context) {
      this.ID(partial.context);
    } else {
      this.opcode('push', 'depth0');
    }

    this.opcode('invokePartial', partialName.name);
    this.opcode('append');
  },

  content: function(content) {
    this.opcode('appendContent', content.string);
  },

  mustache: function(mustache) {
    var options = this.options;
    var type = this.classifyMustache(mustache);

    if (type === "simple") {
      this.simpleMustache(mustache);
    } else if (type === "helper") {
      this.helperMustache(mustache);
    } else {
      this.ambiguousMustache(mustache);
    }

    if(mustache.escaped && !options.noEscape) {
      this.opcode('appendEscaped');
    } else {
      this.opcode('append');
    }
  },

  ambiguousMustache: function(mustache, program, inverse) {
    var id = mustache.id,
        name = id.parts[0],
        isBlock = program != null || inverse != null;

    this.opcode('getContext', id.depth);

    this.opcode('pushProgram', program);
    this.opcode('pushProgram', inverse);

    this.opcode('invokeAmbiguous', name, isBlock);
  },

  simpleMustache: function(mustache) {
    var id = mustache.id;

    if (id.type === 'DATA') {
      this.DATA(id);
    } else if (id.parts.length) {
      this.ID(id);
    } else {
      // Simplified ID for `this`
      this.addDepth(id.depth);
      this.opcode('getContext', id.depth);
      this.opcode('pushContext');
    }

    this.opcode('resolvePossibleLambda');
  },

  helperMustache: function(mustache, program, inverse) {
    var params = this.setupFullMustacheParams(mustache, program, inverse),
        name = mustache.id.parts[0];

    if (this.options.knownHelpers[name]) {
      this.opcode('invokeKnownHelper', params.length, name);
    } else if (this.options.knownHelpersOnly) {
      throw new Error("You specified knownHelpersOnly, but used the unknown helper " + name);
    } else {
      this.opcode('invokeHelper', params.length, name);
    }
  },

  ID: function(id) {
    this.addDepth(id.depth);
    this.opcode('getContext', id.depth);

    var name = id.parts[0];
    if (!name) {
      this.opcode('pushContext');
    } else {
      this.opcode('lookupOnContext', id.parts[0]);
    }

    for(var i=1, l=id.parts.length; i<l; i++) {
      this.opcode('lookup', id.parts[i]);
    }
  },

  DATA: function(data) {
    this.options.data = true;
    if (data.id.isScoped || data.id.depth) {
      throw new Handlebars.Exception('Scoped data references are not supported: ' + data.original);
    }

    this.opcode('lookupData');
    var parts = data.id.parts;
    for(var i=0, l=parts.length; i<l; i++) {
      this.opcode('lookup', parts[i]);
    }
  },

  STRING: function(string) {
    this.opcode('pushString', string.string);
  },

  INTEGER: function(integer) {
    this.opcode('pushLiteral', integer.integer);
  },

  BOOLEAN: function(bool) {
    this.opcode('pushLiteral', bool.bool);
  },

  comment: function() {},

  // HELPERS
  opcode: function(name) {
    this.opcodes.push({ opcode: name, args: [].slice.call(arguments, 1) });
  },

  declare: function(name, value) {
    this.opcodes.push({ opcode: 'DECLARE', name: name, value: value });
  },

  addDepth: function(depth) {
    if(isNaN(depth)) { throw new Error("EWOT"); }
    if(depth === 0) { return; }

    if(!this.depths[depth]) {
      this.depths[depth] = true;
      this.depths.list.push(depth);
    }
  },

  classifyMustache: function(mustache) {
    var isHelper   = mustache.isHelper;
    var isEligible = mustache.eligibleHelper;
    var options    = this.options;

    // if ambiguous, we can possibly resolve the ambiguity now
    if (isEligible && !isHelper) {
      var name = mustache.id.parts[0];

      if (options.knownHelpers[name]) {
        isHelper = true;
      } else if (options.knownHelpersOnly) {
        isEligible = false;
      }
    }

    if (isHelper) { return "helper"; }
    else if (isEligible) { return "ambiguous"; }
    else { return "simple"; }
  },

  pushParams: function(params) {
    var i = params.length, param;

    while(i--) {
      param = params[i];

      if(this.options.stringParams) {
        if(param.depth) {
          this.addDepth(param.depth);
        }

        this.opcode('getContext', param.depth || 0);
        this.opcode('pushStringParam', param.stringModeValue, param.type);
      } else {
        this[param.type](param);
      }
    }
  },

  setupMustacheParams: function(mustache) {
    var params = mustache.params;
    this.pushParams(params);

    if(mustache.hash) {
      this.hash(mustache.hash);
    } else {
      this.opcode('emptyHash');
    }

    return params;
  },

  // this will replace setupMustacheParams when we're done
  setupFullMustacheParams: function(mustache, program, inverse) {
    var params = mustache.params;
    this.pushParams(params);

    this.opcode('pushProgram', program);
    this.opcode('pushProgram', inverse);

    if(mustache.hash) {
      this.hash(mustache.hash);
    } else {
      this.opcode('emptyHash');
    }

    return params;
  }
};

var Literal = function(value) {
  this.value = value;
};

JavaScriptCompiler.prototype = {
  // PUBLIC API: You can override these methods in a subclass to provide
  // alternative compiled forms for name lookup and buffering semantics
  nameLookup: function(parent, name /* , type*/) {
    if (/^[0-9]+$/.test(name)) {
      return parent + "[" + name + "]";
    } else if (JavaScriptCompiler.isValidJavaScriptVariableName(name)) {
      return parent + "." + name;
    }
    else {
      return parent + "['" + name + "']";
    }
  },

  appendToBuffer: function(string) {
    if (this.environment.isSimple) {
      return "return " + string + ";";
    } else {
      return {
        appendToBuffer: true,
        content: string,
        toString: function() { return "buffer += " + string + ";"; }
      };
    }
  },

  initializeBuffer: function() {
    return this.quotedString("");
  },

  namespace: "Handlebars",
  // END PUBLIC API

  compile: function(environment, options, context, asObject) {
    this.environment = environment;
    this.options = options || {};

    Handlebars.log(Handlebars.logger.DEBUG, this.environment.disassemble() + "\n\n");

    this.name = this.environment.name;
    this.isChild = !!context;
    this.context = context || {
      programs: [],
      environments: [],
      aliases: { }
    };

    this.preamble();

    this.stackSlot = 0;
    this.stackVars = [];
    this.registers = { list: [] };
    this.compileStack = [];
    this.inlineStack = [];

    this.compileChildren(environment, options);

    var opcodes = environment.opcodes, opcode;

    this.i = 0;

    for(l=opcodes.length; this.i<l; this.i++) {
      opcode = opcodes[this.i];

      if(opcode.opcode === 'DECLARE') {
        this[opcode.name] = opcode.value;
      } else {
        this[opcode.opcode].apply(this, opcode.args);
      }
    }

    return this.createFunctionContext(asObject);
  },

  nextOpcode: function() {
    var opcodes = this.environment.opcodes;
    return opcodes[this.i + 1];
  },

  eat: function() {
    this.i = this.i + 1;
  },

  preamble: function() {
    var out = [];

    if (!this.isChild) {
      var namespace = this.namespace;

      var copies = "helpers = this.merge(helpers, " + namespace + ".helpers);";
      if (this.environment.usePartial) { copies = copies + " partials = this.merge(partials, " + namespace + ".partials);"; }
      if (this.options.data) { copies = copies + " data = data || {};"; }
      out.push(copies);
    } else {
      out.push('');
    }

    if (!this.environment.isSimple) {
      out.push(", buffer = " + this.initializeBuffer());
    } else {
      out.push("");
    }

    // track the last context pushed into place to allow skipping the
    // getContext opcode when it would be a noop
    this.lastContext = 0;
    this.source = out;
  },

  createFunctionContext: function(asObject) {
    var locals = this.stackVars.concat(this.registers.list);

    if(locals.length > 0) {
      this.source[1] = this.source[1] + ", " + locals.join(", ");
    }

    // Generate minimizer alias mappings
    if (!this.isChild) {
      for (var alias in this.context.aliases) {
        if (this.context.aliases.hasOwnProperty(alias)) {
          this.source[1] = this.source[1] + ', ' + alias + '=' + this.context.aliases[alias];
        }
      }
    }

    if (this.source[1]) {
      this.source[1] = "var " + this.source[1].substring(2) + ";";
    }

    // Merge children
    if (!this.isChild) {
      this.source[1] += '\n' + this.context.programs.join('\n') + '\n';
    }

    if (!this.environment.isSimple) {
      this.source.push("return buffer;");
    }

    var params = this.isChild ? ["depth0", "data"] : ["Handlebars", "depth0", "helpers", "partials", "data"];

    for(var i=0, l=this.environment.depths.list.length; i<l; i++) {
      params.push("depth" + this.environment.depths.list[i]);
    }

    // Perform a second pass over the output to merge content when possible
    var source = this.mergeSource();

    if (!this.isChild) {
      var revision = Handlebars.COMPILER_REVISION,
          versions = Handlebars.REVISION_CHANGES[revision];
      source = "this.compilerInfo = ["+revision+",'"+versions+"'];\n"+source;
    }

    if (asObject) {
      params.push(source);

      return Function.apply(this, params);
    } else {
      var functionSource = 'function ' + (this.name || '') + '(' + params.join(',') + ') {\n  ' + source + '}';
      Handlebars.log(Handlebars.logger.DEBUG, functionSource + "\n\n");
      return functionSource;
    }
  },
  mergeSource: function() {
    // WARN: We are not handling the case where buffer is still populated as the source should
    // not have buffer append operations as their final action.
    var source = '',
        buffer;
    for (var i = 0, len = this.source.length; i < len; i++) {
      var line = this.source[i];
      if (line.appendToBuffer) {
        if (buffer) {
          buffer = buffer + '\n    + ' + line.content;
        } else {
          buffer = line.content;
        }
      } else {
        if (buffer) {
          source += 'buffer += ' + buffer + ';\n  ';
          buffer = undefined;
        }
        source += line + '\n  ';
      }
    }
    return source;
  },

  // [blockValue]
  //
  // On stack, before: hash, inverse, program, value
  // On stack, after: return value of blockHelperMissing
  //
  // The purpose of this opcode is to take a block of the form
  // `{{#foo}}...{{/foo}}`, resolve the value of `foo`, and
  // replace it on the stack with the result of properly
  // invoking blockHelperMissing.
  blockValue: function() {
    this.context.aliases.blockHelperMissing = 'helpers.blockHelperMissing';

    var params = ["depth0"];
    this.setupParams(0, params);

    this.replaceStack(function(current) {
      params.splice(1, 0, current);
      return "blockHelperMissing.call(" + params.join(", ") + ")";
    });
  },

  // [ambiguousBlockValue]
  //
  // On stack, before: hash, inverse, program, value
  // Compiler value, before: lastHelper=value of last found helper, if any
  // On stack, after, if no lastHelper: same as [blockValue]
  // On stack, after, if lastHelper: value
  ambiguousBlockValue: function() {
    this.context.aliases.blockHelperMissing = 'helpers.blockHelperMissing';

    var params = ["depth0"];
    this.setupParams(0, params);

    var current = this.topStack();
    params.splice(1, 0, current);

    // Use the options value generated from the invocation
    params[params.length-1] = 'options';

    this.source.push("if (!" + this.lastHelper + ") { " + current + " = blockHelperMissing.call(" + params.join(", ") + "); }");
  },

  // [appendContent]
  //
  // On stack, before: ...
  // On stack, after: ...
  //
  // Appends the string value of `content` to the current buffer
  appendContent: function(content) {
    this.source.push(this.appendToBuffer(this.quotedString(content)));
  },

  // [append]
  //
  // On stack, before: value, ...
  // On stack, after: ...
  //
  // Coerces `value` to a String and appends it to the current buffer.
  //
  // If `value` is truthy, or 0, it is coerced into a string and appended
  // Otherwise, the empty string is appended
  append: function() {
    // Force anything that is inlined onto the stack so we don't have duplication
    // when we examine local
    this.flushInline();
    var local = this.popStack();
    this.source.push("if(" + local + " || " + local + " === 0) { " + this.appendToBuffer(local) + " }");
    if (this.environment.isSimple) {
      this.source.push("else { " + this.appendToBuffer("''") + " }");
    }
  },

  // [appendEscaped]
  //
  // On stack, before: value, ...
  // On stack, after: ...
  //
  // Escape `value` and append it to the buffer
  appendEscaped: function() {
    this.context.aliases.escapeExpression = 'this.escapeExpression';

    this.source.push(this.appendToBuffer("escapeExpression(" + this.popStack() + ")"));
  },

  // [getContext]
  //
  // On stack, before: ...
  // On stack, after: ...
  // Compiler value, after: lastContext=depth
  //
  // Set the value of the `lastContext` compiler value to the depth
  getContext: function(depth) {
    if(this.lastContext !== depth) {
      this.lastContext = depth;
    }
  },

  // [lookupOnContext]
  //
  // On stack, before: ...
  // On stack, after: currentContext[name], ...
  //
  // Looks up the value of `name` on the current context and pushes
  // it onto the stack.
  lookupOnContext: function(name) {
    this.push(this.nameLookup('depth' + this.lastContext, name, 'context'));
  },

  // [pushContext]
  //
  // On stack, before: ...
  // On stack, after: currentContext, ...
  //
  // Pushes the value of the current context onto the stack.
  pushContext: function() {
    this.pushStackLiteral('depth' + this.lastContext);
  },

  // [resolvePossibleLambda]
  //
  // On stack, before: value, ...
  // On stack, after: resolved value, ...
  //
  // If the `value` is a lambda, replace it on the stack by
  // the return value of the lambda
  resolvePossibleLambda: function() {
    this.context.aliases.functionType = '"function"';

    this.replaceStack(function(current) {
      return "typeof " + current + " === functionType ? " + current + ".apply(depth0) : " + current;
    });
  },

  // [lookup]
  //
  // On stack, before: value, ...
  // On stack, after: value[name], ...
  //
  // Replace the value on the stack with the result of looking
  // up `name` on `value`
  lookup: function(name) {
    this.replaceStack(function(current) {
      return current + " == null || " + current + " === false ? " + current + " : " + this.nameLookup(current, name, 'context');
    });
  },

  // [lookupData]
  //
  // On stack, before: ...
  // On stack, after: data[id], ...
  //
  // Push the result of looking up `id` on the current data
  lookupData: function(id) {
    this.push('data');
  },

  // [pushStringParam]
  //
  // On stack, before: ...
  // On stack, after: string, currentContext, ...
  //
  // This opcode is designed for use in string mode, which
  // provides the string value of a parameter along with its
  // depth rather than resolving it immediately.
  pushStringParam: function(string, type) {
    this.pushStackLiteral('depth' + this.lastContext);

    this.pushString(type);

    if (typeof string === 'string') {
      this.pushString(string);
    } else {
      this.pushStackLiteral(string);
    }
  },

  emptyHash: function() {
    this.pushStackLiteral('{}');

    if (this.options.stringParams) {
      this.register('hashTypes', '{}');
      this.register('hashContexts', '{}');
    }
  },
  pushHash: function() {
    this.hash = {values: [], types: [], contexts: []};
  },
  popHash: function() {
    var hash = this.hash;
    this.hash = undefined;

    if (this.options.stringParams) {
      this.register('hashContexts', '{' + hash.contexts.join(',') + '}');
      this.register('hashTypes', '{' + hash.types.join(',') + '}');
    }
    this.push('{\n    ' + hash.values.join(',\n    ') + '\n  }');
  },

  // [pushString]
  //
  // On stack, before: ...
  // On stack, after: quotedString(string), ...
  //
  // Push a quoted version of `string` onto the stack
  pushString: function(string) {
    this.pushStackLiteral(this.quotedString(string));
  },

  // [push]
  //
  // On stack, before: ...
  // On stack, after: expr, ...
  //
  // Push an expression onto the stack
  push: function(expr) {
    this.inlineStack.push(expr);
    return expr;
  },

  // [pushLiteral]
  //
  // On stack, before: ...
  // On stack, after: value, ...
  //
  // Pushes a value onto the stack. This operation prevents
  // the compiler from creating a temporary variable to hold
  // it.
  pushLiteral: function(value) {
    this.pushStackLiteral(value);
  },

  // [pushProgram]
  //
  // On stack, before: ...
  // On stack, after: program(guid), ...
  //
  // Push a program expression onto the stack. This takes
  // a compile-time guid and converts it into a runtime-accessible
  // expression.
  pushProgram: function(guid) {
    if (guid != null) {
      this.pushStackLiteral(this.programExpression(guid));
    } else {
      this.pushStackLiteral(null);
    }
  },

  // [invokeHelper]
  //
  // On stack, before: hash, inverse, program, params..., ...
  // On stack, after: result of helper invocation
  //
  // Pops off the helper's parameters, invokes the helper,
  // and pushes the helper's return value onto the stack.
  //
  // If the helper is not found, `helperMissing` is called.
  invokeHelper: function(paramSize, name) {
    this.context.aliases.helperMissing = 'helpers.helperMissing';

    var helper = this.lastHelper = this.setupHelper(paramSize, name, true);
    var nonHelper = this.nameLookup('depth' + this.lastContext, name, 'context');

    this.push(helper.name + ' || ' + nonHelper);
    this.replaceStack(function(name) {
      return name + ' ? ' + name + '.call(' +
          helper.callParams + ") " + ": helperMissing.call(" +
          helper.helperMissingParams + ")";
    });
  },

  // [invokeKnownHelper]
  //
  // On stack, before: hash, inverse, program, params..., ...
  // On stack, after: result of helper invocation
  //
  // This operation is used when the helper is known to exist,
  // so a `helperMissing` fallback is not required.
  invokeKnownHelper: function(paramSize, name) {
    var helper = this.setupHelper(paramSize, name);
    this.push(helper.name + ".call(" + helper.callParams + ")");
  },

  // [invokeAmbiguous]
  //
  // On stack, before: hash, inverse, program, params..., ...
  // On stack, after: result of disambiguation
  //
  // This operation is used when an expression like `{{foo}}`
  // is provided, but we don't know at compile-time whether it
  // is a helper or a path.
  //
  // This operation emits more code than the other options,
  // and can be avoided by passing the `knownHelpers` and
  // `knownHelpersOnly` flags at compile-time.
  invokeAmbiguous: function(name, helperCall) {
    this.context.aliases.functionType = '"function"';

    this.pushStackLiteral('{}');    // Hash value
    var helper = this.setupHelper(0, name, helperCall);

    var helperName = this.lastHelper = this.nameLookup('helpers', name, 'helper');

    var nonHelper = this.nameLookup('depth' + this.lastContext, name, 'context');
    var nextStack = this.nextStack();

    this.source.push('if (' + nextStack + ' = ' + helperName + ') { ' + nextStack + ' = ' + nextStack + '.call(' + helper.callParams + '); }');
    this.source.push('else { ' + nextStack + ' = ' + nonHelper + '; ' + nextStack + ' = typeof ' + nextStack + ' === functionType ? ' + nextStack + '.apply(depth0) : ' + nextStack + '; }');
  },

  // [invokePartial]
  //
  // On stack, before: context, ...
  // On stack after: result of partial invocation
  //
  // This operation pops off a context, invokes a partial with that context,
  // and pushes the result of the invocation back.
  invokePartial: function(name) {
    var params = [this.nameLookup('partials', name, 'partial'), "'" + name + "'", this.popStack(), "helpers", "partials"];

    if (this.options.data) {
      params.push("data");
    }

    this.context.aliases.self = "this";
    this.push("self.invokePartial(" + params.join(", ") + ")");
  },

  // [assignToHash]
  //
  // On stack, before: value, hash, ...
  // On stack, after: hash, ...
  //
  // Pops a value and hash off the stack, assigns `hash[key] = value`
  // and pushes the hash back onto the stack.
  assignToHash: function(key) {
    var value = this.popStack(),
        context,
        type;

    if (this.options.stringParams) {
      type = this.popStack();
      context = this.popStack();
    }

    var hash = this.hash;
    if (context) {
      hash.contexts.push("'" + key + "': " + context);
    }
    if (type) {
      hash.types.push("'" + key + "': " + type);
    }
    hash.values.push("'" + key + "': (" + value + ")");
  },

  // HELPERS

  compiler: JavaScriptCompiler,

  compileChildren: function(environment, options) {
    var children = environment.children, child, compiler;

    for(var i=0, l=children.length; i<l; i++) {
      child = children[i];
      compiler = new this.compiler();

      var index = this.matchExistingProgram(child);

      if (index == null) {
        this.context.programs.push('');     // Placeholder to prevent name conflicts for nested children
        index = this.context.programs.length;
        child.index = index;
        child.name = 'program' + index;
        this.context.programs[index] = compiler.compile(child, options, this.context);
        this.context.environments[index] = child;
      } else {
        child.index = index;
        child.name = 'program' + index;
      }
    }
  },
  matchExistingProgram: function(child) {
    for (var i = 0, len = this.context.environments.length; i < len; i++) {
      var environment = this.context.environments[i];
      if (environment && environment.equals(child)) {
        return i;
      }
    }
  },

  programExpression: function(guid) {
    this.context.aliases.self = "this";

    if(guid == null) {
      return "self.noop";
    }

    var child = this.environment.children[guid],
        depths = child.depths.list, depth;

    var programParams = [child.index, child.name, "data"];

    for(var i=0, l = depths.length; i<l; i++) {
      depth = depths[i];

      if(depth === 1) { programParams.push("depth0"); }
      else { programParams.push("depth" + (depth - 1)); }
    }

    return (depths.length === 0 ? "self.program(" : "self.programWithDepth(") + programParams.join(", ") + ")";
  },

  register: function(name, val) {
    this.useRegister(name);
    this.source.push(name + " = " + val + ";");
  },

  useRegister: function(name) {
    if(!this.registers[name]) {
      this.registers[name] = true;
      this.registers.list.push(name);
    }
  },

  pushStackLiteral: function(item) {
    return this.push(new Literal(item));
  },

  pushStack: function(item) {
    this.flushInline();

    var stack = this.incrStack();
    if (item) {
      this.source.push(stack + " = " + item + ";");
    }
    this.compileStack.push(stack);
    return stack;
  },

  replaceStack: function(callback) {
    var prefix = '',
        inline = this.isInline(),
        stack;

    // If we are currently inline then we want to merge the inline statement into the
    // replacement statement via ','
    if (inline) {
      var top = this.popStack(true);

      if (top instanceof Literal) {
        // Literals do not need to be inlined
        stack = top.value;
      } else {
        // Get or create the current stack name for use by the inline
        var name = this.stackSlot ? this.topStackName() : this.incrStack();

        prefix = '(' + this.push(name) + ' = ' + top + '),';
        stack = this.topStack();
      }
    } else {
      stack = this.topStack();
    }

    var item = callback.call(this, stack);

    if (inline) {
      if (this.inlineStack.length || this.compileStack.length) {
        this.popStack();
      }
      this.push('(' + prefix + item + ')');
    } else {
      // Prevent modification of the context depth variable. Through replaceStack
      if (!/^stack/.test(stack)) {
        stack = this.nextStack();
      }

      this.source.push(stack + " = (" + prefix + item + ");");
    }
    return stack;
  },

  nextStack: function() {
    return this.pushStack();
  },

  incrStack: function() {
    this.stackSlot++;
    if(this.stackSlot > this.stackVars.length) { this.stackVars.push("stack" + this.stackSlot); }
    return this.topStackName();
  },
  topStackName: function() {
    return "stack" + this.stackSlot;
  },
  flushInline: function() {
    var inlineStack = this.inlineStack;
    if (inlineStack.length) {
      this.inlineStack = [];
      for (var i = 0, len = inlineStack.length; i < len; i++) {
        var entry = inlineStack[i];
        if (entry instanceof Literal) {
          this.compileStack.push(entry);
        } else {
          this.pushStack(entry);
        }
      }
    }
  },
  isInline: function() {
    return this.inlineStack.length;
  },

  popStack: function(wrapped) {
    var inline = this.isInline(),
        item = (inline ? this.inlineStack : this.compileStack).pop();

    if (!wrapped && (item instanceof Literal)) {
      return item.value;
    } else {
      if (!inline) {
        this.stackSlot--;
      }
      return item;
    }
  },

  topStack: function(wrapped) {
    var stack = (this.isInline() ? this.inlineStack : this.compileStack),
        item = stack[stack.length - 1];

    if (!wrapped && (item instanceof Literal)) {
      return item.value;
    } else {
      return item;
    }
  },

  quotedString: function(str) {
    return '"' + str
      .replace(/\\/g, '\\\\')
      .replace(/"/g, '\\"')
      .replace(/\n/g, '\\n')
      .replace(/\r/g, '\\r')
      .replace(/\u2028/g, '\\u2028')   // Per Ecma-262 7.3 + 7.8.4
      .replace(/\u2029/g, '\\u2029') + '"';
  },

  setupHelper: function(paramSize, name, missingParams) {
    var params = [];
    this.setupParams(paramSize, params, missingParams);
    var foundHelper = this.nameLookup('helpers', name, 'helper');

    return {
      params: params,
      name: foundHelper,
      callParams: ["depth0"].concat(params).join(", "),
      helperMissingParams: missingParams && ["depth0", this.quotedString(name)].concat(params).join(", ")
    };
  },

  // the params and contexts arguments are passed in arrays
  // to fill in
  setupParams: function(paramSize, params, useRegister) {
    var options = [], contexts = [], types = [], param, inverse, program;

    options.push("hash:" + this.popStack());

    inverse = this.popStack();
    program = this.popStack();

    // Avoid setting fn and inverse if neither are set. This allows
    // helpers to do a check for `if (options.fn)`
    if (program || inverse) {
      if (!program) {
        this.context.aliases.self = "this";
        program = "self.noop";
      }

      if (!inverse) {
       this.context.aliases.self = "this";
        inverse = "self.noop";
      }

      options.push("inverse:" + inverse);
      options.push("fn:" + program);
    }

    for(var i=0; i<paramSize; i++) {
      param = this.popStack();
      params.push(param);

      if(this.options.stringParams) {
        types.push(this.popStack());
        contexts.push(this.popStack());
      }
    }

    if (this.options.stringParams) {
      options.push("contexts:[" + contexts.join(",") + "]");
      options.push("types:[" + types.join(",") + "]");
      options.push("hashContexts:hashContexts");
      options.push("hashTypes:hashTypes");
    }

    if(this.options.data) {
      options.push("data:data");
    }

    options = "{" + options.join(",") + "}";
    if (useRegister) {
      this.register('options', options);
      params.push('options');
    } else {
      params.push(options);
    }
    return params.join(", ");
  }
};

var reservedWords = (
  "break else new var" +
  " case finally return void" +
  " catch for switch while" +
  " continue function this with" +
  " default if throw" +
  " delete in try" +
  " do instanceof typeof" +
  " abstract enum int short" +
  " boolean export interface static" +
  " byte extends long super" +
  " char final native synchronized" +
  " class float package throws" +
  " const goto private transient" +
  " debugger implements protected volatile" +
  " double import public let yield"
).split(" ");

var compilerWords = JavaScriptCompiler.RESERVED_WORDS = {};

for(var i=0, l=reservedWords.length; i<l; i++) {
  compilerWords[reservedWords[i]] = true;
}

JavaScriptCompiler.isValidJavaScriptVariableName = function(name) {
  if(!JavaScriptCompiler.RESERVED_WORDS[name] && /^[a-zA-Z_$][0-9a-zA-Z_$]+$/.test(name)) {
    return true;
  }
  return false;
};

Handlebars.precompile = function(input, options) {
  if (input == null || (typeof input !== 'string' && input.constructor !== Handlebars.AST.ProgramNode)) {
    throw new Handlebars.Exception("You must pass a string or Handlebars AST to Handlebars.precompile. You passed " + input);
  }

  options = options || {};
  if (!('data' in options)) {
    options.data = true;
  }
  var ast = Handlebars.parse(input);
  var environment = new Compiler().compile(ast, options);
  return new JavaScriptCompiler().compile(environment, options);
};

Handlebars.compile = function(input, options) {
  if (input == null || (typeof input !== 'string' && input.constructor !== Handlebars.AST.ProgramNode)) {
    throw new Handlebars.Exception("You must pass a string or Handlebars AST to Handlebars.compile. You passed " + input);
  }

  options = options || {};
  if (!('data' in options)) {
    options.data = true;
  }
  var compiled;
  function compile() {
    var ast = Handlebars.parse(input);
    var environment = new Compiler().compile(ast, options);
    var templateSpec = new JavaScriptCompiler().compile(environment, options, undefined, true);
    return Handlebars.template(templateSpec);
  }

  // Template is only compiled on first use and cached after that point.
  return function(context, options) {
    if (!compiled) {
      compiled = compile();
    }
    return compiled.call(this, context, options);
  };
};

;
// lib/handlebars/runtime.js

Handlebars.VM = {
  template: function(templateSpec) {
    // Just add water
    var container = {
      escapeExpression: Handlebars.Utils.escapeExpression,
      invokePartial: Handlebars.VM.invokePartial,
      programs: [],
      program: function(i, fn, data) {
        var programWrapper = this.programs[i];
        if(data) {
          programWrapper = Handlebars.VM.program(i, fn, data);
        } else if (!programWrapper) {
          programWrapper = this.programs[i] = Handlebars.VM.program(i, fn);
        }
        return programWrapper;
      },
      merge: function(param, common) {
        var ret = param || common;

        if (param && common) {
          ret = {};
          Handlebars.Utils.extend(ret, common);
          Handlebars.Utils.extend(ret, param);
        }
        return ret;
      },
      programWithDepth: Handlebars.VM.programWithDepth,
      noop: Handlebars.VM.noop,
      compilerInfo: null
    };

    return function(context, options) {
      options = options || {};
      var result = templateSpec.call(container, Handlebars, context, options.helpers, options.partials, options.data);

      var compilerInfo = container.compilerInfo || [],
          compilerRevision = compilerInfo[0] || 1,
          currentRevision = Handlebars.COMPILER_REVISION;

      if (compilerRevision !== currentRevision) {
        if (compilerRevision < currentRevision) {
          var runtimeVersions = Handlebars.REVISION_CHANGES[currentRevision],
              compilerVersions = Handlebars.REVISION_CHANGES[compilerRevision];
          throw "Template was precompiled with an older version of Handlebars than the current runtime. "+
                "Please update your precompiler to a newer version ("+runtimeVersions+") or downgrade your runtime to an older version ("+compilerVersions+").";
        } else {
          // Use the embedded version info since the runtime doesn't know about this revision yet
          throw "Template was precompiled with a newer version of Handlebars than the current runtime. "+
                "Please update your runtime to a newer version ("+compilerInfo[1]+").";
        }
      }

      return result;
    };
  },

  programWithDepth: function(i, fn, data /*, $depth */) {
    var args = Array.prototype.slice.call(arguments, 3);

    var program = function(context, options) {
      options = options || {};

      return fn.apply(this, [context, options.data || data].concat(args));
    };
    program.program = i;
    program.depth = args.length;
    return program;
  },
  program: function(i, fn, data) {
    var program = function(context, options) {
      options = options || {};

      return fn(context, options.data || data);
    };
    program.program = i;
    program.depth = 0;
    return program;
  },
  noop: function() { return ""; },
  invokePartial: function(partial, name, context, helpers, partials, data) {
    var options = { helpers: helpers, partials: partials, data: data };

    if(partial === undefined) {
      throw new Handlebars.Exception("The partial " + name + " could not be found");
    } else if(partial instanceof Function) {
      return partial(context, options);
    } else if (!Handlebars.compile) {
      throw new Handlebars.Exception("The partial " + name + " could not be compiled when running in runtime-only mode");
    } else {
      partials[name] = Handlebars.compile(partial, {data: data !== undefined});
      return partials[name](context, options);
    }
  }
};

Handlebars.template = Handlebars.VM.template;
;
// lib/handlebars/browser-suffix.js
})(Handlebars);
;
define("handlebars", (function (global) {
    return function () {
        var ret, fn;
        return ret || global.Handlebars;
    };
}(this)));

//! moment.js
//! version : 2.4.0
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
(function(a){function b(a,b){return function(c){return i(a.call(this,c),b)}}function c(a,b){return function(c){return this.lang().ordinal(a.call(this,c),b)}}function d(){}function e(a){u(a),g(this,a)}function f(a){var b=o(a),c=b.year||0,d=b.month||0,e=b.week||0,f=b.day||0,g=b.hour||0,h=b.minute||0,i=b.second||0,j=b.millisecond||0;this._input=a,this._milliseconds=+j+1e3*i+6e4*h+36e5*g,this._days=+f+7*e,this._months=+d+12*c,this._data={},this._bubble()}function g(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return b.hasOwnProperty("toString")&&(a.toString=b.toString),b.hasOwnProperty("valueOf")&&(a.valueOf=b.valueOf),a}function h(a){return 0>a?Math.ceil(a):Math.floor(a)}function i(a,b){for(var c=a+"";c.length<b;)c="0"+c;return c}function j(a,b,c,d){var e,f,g=b._milliseconds,h=b._days,i=b._months;g&&a._d.setTime(+a._d+g*c),(h||i)&&(e=a.minute(),f=a.hour()),h&&a.date(a.date()+h*c),i&&a.month(a.month()+i*c),g&&!d&&bb.updateOffset(a),(h||i)&&(a.minute(e),a.hour(f))}function k(a){return"[object Array]"===Object.prototype.toString.call(a)}function l(a){return"[object Date]"===Object.prototype.toString.call(a)||a instanceof Date}function m(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;e>d;d++)(c&&a[d]!==b[d]||!c&&q(a[d])!==q(b[d]))&&g++;return g+f}function n(a){if(a){var b=a.toLowerCase().replace(/(.)s$/,"$1");a=Kb[a]||Lb[b]||b}return a}function o(a){var b,c,d={};for(c in a)a.hasOwnProperty(c)&&(b=n(c),b&&(d[b]=a[c]));return d}function p(b){var c,d;if(0===b.indexOf("week"))c=7,d="day";else{if(0!==b.indexOf("month"))return;c=12,d="month"}bb[b]=function(e,f){var g,h,i=bb.fn._lang[b],j=[];if("number"==typeof e&&(f=e,e=a),h=function(a){var b=bb().utc().set(d,a);return i.call(bb.fn._lang,b,e||"")},null!=f)return h(f);for(g=0;c>g;g++)j.push(h(g));return j}}function q(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}function r(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function s(a){return t(a)?366:365}function t(a){return 0===a%4&&0!==a%100||0===a%400}function u(a){var b;a._a&&-2===a._pf.overflow&&(b=a._a[gb]<0||a._a[gb]>11?gb:a._a[hb]<1||a._a[hb]>r(a._a[fb],a._a[gb])?hb:a._a[ib]<0||a._a[ib]>23?ib:a._a[jb]<0||a._a[jb]>59?jb:a._a[kb]<0||a._a[kb]>59?kb:a._a[lb]<0||a._a[lb]>999?lb:-1,a._pf._overflowDayOfYear&&(fb>b||b>hb)&&(b=hb),a._pf.overflow=b)}function v(a){a._pf={empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function w(a){return null==a._isValid&&(a._isValid=!isNaN(a._d.getTime())&&a._pf.overflow<0&&!a._pf.empty&&!a._pf.invalidMonth&&!a._pf.nullInput&&!a._pf.invalidFormat&&!a._pf.userInvalidated,a._strict&&(a._isValid=a._isValid&&0===a._pf.charsLeftOver&&0===a._pf.unusedTokens.length)),a._isValid}function x(a){return a?a.toLowerCase().replace("_","-"):a}function y(a,b){return b.abbr=a,mb[a]||(mb[a]=new d),mb[a].set(b),mb[a]}function z(a){delete mb[a]}function A(a){var b,c,d,e,f=0,g=function(a){if(!mb[a]&&nb)try{require("./lang/"+a)}catch(b){}return mb[a]};if(!a)return bb.fn._lang;if(!k(a)){if(c=g(a))return c;a=[a]}for(;f<a.length;){for(e=x(a[f]).split("-"),b=e.length,d=x(a[f+1]),d=d?d.split("-"):null;b>0;){if(c=g(e.slice(0,b).join("-")))return c;if(d&&d.length>=b&&m(e,d,!0)>=b-1)break;b--}f++}return bb.fn._lang}function B(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function C(a){var b,c,d=a.match(rb);for(b=0,c=d.length;c>b;b++)d[b]=Pb[d[b]]?Pb[d[b]]:B(d[b]);return function(e){var f="";for(b=0;c>b;b++)f+=d[b]instanceof Function?d[b].call(e,a):d[b];return f}}function D(a,b){return a.isValid()?(b=E(b,a.lang()),Mb[b]||(Mb[b]=C(b)),Mb[b](a)):a.lang().invalidDate()}function E(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(sb.lastIndex=0;d>=0&&sb.test(a);)a=a.replace(sb,c),sb.lastIndex=0,d-=1;return a}function F(a,b){var c;switch(a){case"DDDD":return vb;case"YYYY":case"GGGG":case"gggg":return wb;case"YYYYY":case"GGGGG":case"ggggg":return xb;case"S":case"SS":case"SSS":case"DDD":return ub;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return zb;case"a":case"A":return A(b._l)._meridiemParse;case"X":return Cb;case"Z":case"ZZ":return Ab;case"T":return Bb;case"SSSS":return yb;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"ww":case"W":case"WW":case"e":case"E":return tb;default:return c=new RegExp(N(M(a.replace("\\","")),"i"))}}function G(a){var b=(Ab.exec(a)||[])[0],c=(b+"").match(Hb)||["-",0,0],d=+(60*c[1])+q(c[2]);return"+"===c[0]?-d:d}function H(a,b,c){var d,e=c._a;switch(a){case"M":case"MM":null!=b&&(e[gb]=q(b)-1);break;case"MMM":case"MMMM":d=A(c._l).monthsParse(b),null!=d?e[gb]=d:c._pf.invalidMonth=b;break;case"D":case"DD":null!=b&&(e[hb]=q(b));break;case"DDD":case"DDDD":null!=b&&(c._dayOfYear=q(b));break;case"YY":e[fb]=q(b)+(q(b)>68?1900:2e3);break;case"YYYY":case"YYYYY":e[fb]=q(b);break;case"a":case"A":c._isPm=A(c._l).isPM(b);break;case"H":case"HH":case"h":case"hh":e[ib]=q(b);break;case"m":case"mm":e[jb]=q(b);break;case"s":case"ss":e[kb]=q(b);break;case"S":case"SS":case"SSS":case"SSSS":e[lb]=q(1e3*("0."+b));break;case"X":c._d=new Date(1e3*parseFloat(b));break;case"Z":case"ZZ":c._useUTC=!0,c._tzm=G(b);break;case"w":case"ww":case"W":case"WW":case"d":case"dd":case"ddd":case"dddd":case"e":case"E":a=a.substr(0,1);case"gg":case"gggg":case"GG":case"GGGG":case"GGGGG":a=a.substr(0,2),b&&(c._w=c._w||{},c._w[a]=b)}}function I(a){var b,c,d,e,f,g,h,i,j,k,l=[];if(!a._d){for(d=K(a),a._w&&null==a._a[hb]&&null==a._a[gb]&&(f=function(b){return b?b.length<3?parseInt(b,10)>68?"19"+b:"20"+b:b:null==a._a[fb]?bb().weekYear():a._a[fb]},g=a._w,null!=g.GG||null!=g.W||null!=g.E?h=X(f(g.GG),g.W||1,g.E,4,1):(i=A(a._l),j=null!=g.d?T(g.d,i):null!=g.e?parseInt(g.e,10)+i._week.dow:0,k=parseInt(g.w,10)||1,null!=g.d&&j<i._week.dow&&k++,h=X(f(g.gg),k,j,i._week.doy,i._week.dow)),a._a[fb]=h.year,a._dayOfYear=h.dayOfYear),a._dayOfYear&&(e=null==a._a[fb]?d[fb]:a._a[fb],a._dayOfYear>s(e)&&(a._pf._overflowDayOfYear=!0),c=S(e,0,a._dayOfYear),a._a[gb]=c.getUTCMonth(),a._a[hb]=c.getUTCDate()),b=0;3>b&&null==a._a[b];++b)a._a[b]=l[b]=d[b];for(;7>b;b++)a._a[b]=l[b]=null==a._a[b]?2===b?1:0:a._a[b];l[ib]+=q((a._tzm||0)/60),l[jb]+=q((a._tzm||0)%60),a._d=(a._useUTC?S:R).apply(null,l)}}function J(a){var b;a._d||(b=o(a._i),a._a=[b.year,b.month,b.day,b.hour,b.minute,b.second,b.millisecond],I(a))}function K(a){var b=new Date;return a._useUTC?[b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]:[b.getFullYear(),b.getMonth(),b.getDate()]}function L(a){a._a=[],a._pf.empty=!0;var b,c,d,e,f,g=A(a._l),h=""+a._i,i=h.length,j=0;for(d=E(a._f,g).match(rb)||[],b=0;b<d.length;b++)e=d[b],c=(F(e,a).exec(h)||[])[0],c&&(f=h.substr(0,h.indexOf(c)),f.length>0&&a._pf.unusedInput.push(f),h=h.slice(h.indexOf(c)+c.length),j+=c.length),Pb[e]?(c?a._pf.empty=!1:a._pf.unusedTokens.push(e),H(e,c,a)):a._strict&&!c&&a._pf.unusedTokens.push(e);a._pf.charsLeftOver=i-j,h.length>0&&a._pf.unusedInput.push(h),a._isPm&&a._a[ib]<12&&(a._a[ib]+=12),a._isPm===!1&&12===a._a[ib]&&(a._a[ib]=0),I(a),u(a)}function M(a){return a.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e})}function N(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function O(a){var b,c,d,e,f;if(0===a._f.length)return a._pf.invalidFormat=!0,a._d=new Date(0/0),void 0;for(e=0;e<a._f.length;e++)f=0,b=g({},a),v(b),b._f=a._f[e],L(b),w(b)&&(f+=b._pf.charsLeftOver,f+=10*b._pf.unusedTokens.length,b._pf.score=f,(null==d||d>f)&&(d=f,c=b));g(a,c||b)}function P(a){var b,c=a._i,d=Db.exec(c);if(d){for(a._pf.iso=!0,b=4;b>0;b--)if(d[b]){a._f=Fb[b-1]+(d[6]||" ");break}for(b=0;4>b;b++)if(Gb[b][1].exec(c)){a._f+=Gb[b][0];break}Ab.exec(c)&&(a._f+="Z"),L(a)}else a._d=new Date(c)}function Q(b){var c=b._i,d=ob.exec(c);c===a?b._d=new Date:d?b._d=new Date(+d[1]):"string"==typeof c?P(b):k(c)?(b._a=c.slice(0),I(b)):l(c)?b._d=new Date(+c):"object"==typeof c?J(b):b._d=new Date(c)}function R(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return 1970>a&&h.setFullYear(a),h}function S(a){var b=new Date(Date.UTC.apply(null,arguments));return 1970>a&&b.setUTCFullYear(a),b}function T(a,b){if("string"==typeof a)if(isNaN(a)){if(a=b.weekdaysParse(a),"number"!=typeof a)return null}else a=parseInt(a,10);return a}function U(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function V(a,b,c){var d=eb(Math.abs(a)/1e3),e=eb(d/60),f=eb(e/60),g=eb(f/24),h=eb(g/365),i=45>d&&["s",d]||1===e&&["m"]||45>e&&["mm",e]||1===f&&["h"]||22>f&&["hh",f]||1===g&&["d"]||25>=g&&["dd",g]||45>=g&&["M"]||345>g&&["MM",eb(g/30)]||1===h&&["y"]||["yy",h];return i[2]=b,i[3]=a>0,i[4]=c,U.apply({},i)}function W(a,b,c){var d,e=c-b,f=c-a.day();return f>e&&(f-=7),e-7>f&&(f+=7),d=bb(a).add("d",f),{week:Math.ceil(d.dayOfYear()/7),year:d.year()}}function X(a,b,c,d,e){var f,g,h=new Date(Date.UTC(a,0)).getUTCDay();return c=null!=c?c:e,f=e-h+(h>d?7:0),g=7*(b-1)+(c-e)+f+1,{year:g>0?a:a-1,dayOfYear:g>0?g:s(a-1)+g}}function Y(a){var b=a._i,c=a._f;return"undefined"==typeof a._pf&&v(a),null===b?bb.invalid({nullInput:!0}):("string"==typeof b&&(a._i=b=A().preparse(b)),bb.isMoment(b)?(a=g({},b),a._d=new Date(+b._d)):c?k(c)?O(a):L(a):Q(a),new e(a))}function Z(a,b){bb.fn[a]=bb.fn[a+"s"]=function(a){var c=this._isUTC?"UTC":"";return null!=a?(this._d["set"+c+b](a),bb.updateOffset(this),this):this._d["get"+c+b]()}}function $(a){bb.duration.fn[a]=function(){return this._data[a]}}function _(a,b){bb.duration.fn["as"+a]=function(){return+this/b}}function ab(a){var b=!1,c=bb;"undefined"==typeof ender&&(this.moment=a?function(){return!b&&console&&console.warn&&(b=!0,console.warn("Accessing Moment through the global scope is deprecated, and will be removed in an upcoming release.")),c.apply(null,arguments)}:bb)}for(var bb,cb,db="2.4.0",eb=Math.round,fb=0,gb=1,hb=2,ib=3,jb=4,kb=5,lb=6,mb={},nb="undefined"!=typeof module&&module.exports,ob=/^\/?Date\((\-?\d+)/i,pb=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,qb=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,rb=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,sb=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,tb=/\d\d?/,ub=/\d{1,3}/,vb=/\d{3}/,wb=/\d{1,4}/,xb=/[+\-]?\d{1,6}/,yb=/\d+/,zb=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Ab=/Z|[\+\-]\d\d:?\d\d/i,Bb=/T/i,Cb=/[\+\-]?\d+(\.\d{1,3})?/,Db=/^\s*\d{4}-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d:?\d\d|Z)?)?$/,Eb="YYYY-MM-DDTHH:mm:ssZ",Fb=["YYYY-MM-DD","GGGG-[W]WW","GGGG-[W]WW-E","YYYY-DDD"],Gb=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],Hb=/([\+\-]|\d\d)/gi,Ib="Date|Hours|Minutes|Seconds|Milliseconds".split("|"),Jb={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},Kb={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},Lb={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},Mb={},Nb="DDD w W M D d".split(" "),Ob="M D H h m s w W".split(" "),Pb={M:function(){return this.month()+1},MMM:function(a){return this.lang().monthsShort(this,a)},MMMM:function(a){return this.lang().months(this,a)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(a){return this.lang().weekdaysMin(this,a)},ddd:function(a){return this.lang().weekdaysShort(this,a)},dddd:function(a){return this.lang().weekdays(this,a)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return i(this.year()%100,2)},YYYY:function(){return i(this.year(),4)},YYYYY:function(){return i(this.year(),5)},gg:function(){return i(this.weekYear()%100,2)},gggg:function(){return this.weekYear()},ggggg:function(){return i(this.weekYear(),5)},GG:function(){return i(this.isoWeekYear()%100,2)},GGGG:function(){return this.isoWeekYear()},GGGGG:function(){return i(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return q(this.milliseconds()/100)},SS:function(){return i(q(this.milliseconds()/10),2)},SSS:function(){return i(this.milliseconds(),3)},SSSS:function(){return i(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";return 0>a&&(a=-a,b="-"),b+i(q(a/60),2)+":"+i(q(a)%60,2)},ZZ:function(){var a=-this.zone(),b="+";return 0>a&&(a=-a,b="-"),b+i(q(10*a/6),4)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()}},Qb=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];Nb.length;)cb=Nb.pop(),Pb[cb+"o"]=c(Pb[cb],cb);for(;Ob.length;)cb=Ob.pop(),Pb[cb+cb]=b(Pb[cb],2);for(Pb.DDDD=b(Pb.DDD,3),g(d.prototype,{set:function(a){var b,c;for(c in a)b=a[c],"function"==typeof b?this[c]=b:this["_"+c]=b},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(a){return this._months[a.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(a){return this._monthsShort[a.month()]},monthsParse:function(a){var b,c,d;for(this._monthsParse||(this._monthsParse=[]),b=0;12>b;b++)if(this._monthsParse[b]||(c=bb.utc([2e3,b]),d="^"+this.months(c,"")+"|^"+this.monthsShort(c,""),this._monthsParse[b]=new RegExp(d.replace(".",""),"i")),this._monthsParse[b].test(a))return b},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(a){return this._weekdays[a.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(a){return this._weekdaysShort[a.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(a){return this._weekdaysMin[a.day()]},weekdaysParse:function(a){var b,c,d;for(this._weekdaysParse||(this._weekdaysParse=[]),b=0;7>b;b++)if(this._weekdaysParse[b]||(c=bb([2e3,1]).day(b),d="^"+this.weekdays(c,"")+"|^"+this.weekdaysShort(c,"")+"|^"+this.weekdaysMin(c,""),this._weekdaysParse[b]=new RegExp(d.replace(".",""),"i")),this._weekdaysParse[b].test(a))return b},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(a){var b=this._longDateFormat[a];return!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a]=b),b},isPM:function(a){return"p"===(a+"").toLowerCase().charAt(0)},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(a,b){var c=this._calendar[a];return"function"==typeof c?c.apply(b):c},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(a,b,c,d){var e=this._relativeTime[c];return"function"==typeof e?e(a,b,c,d):e.replace(/%d/i,a)},pastFuture:function(a,b){var c=this._relativeTime[a>0?"future":"past"];return"function"==typeof c?c(b):c.replace(/%s/i,b)},ordinal:function(a){return this._ordinal.replace("%d",a)},_ordinal:"%d",preparse:function(a){return a},postformat:function(a){return a},week:function(a){return W(a,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}}),bb=function(b,c,d,e){return"boolean"==typeof d&&(e=d,d=a),Y({_i:b,_f:c,_l:d,_strict:e,_isUTC:!1})},bb.utc=function(b,c,d,e){var f;return"boolean"==typeof d&&(e=d,d=a),f=Y({_useUTC:!0,_isUTC:!0,_l:d,_i:b,_f:c,_strict:e}).utc()},bb.unix=function(a){return bb(1e3*a)},bb.duration=function(a,b){var c,d,e,g=bb.isDuration(a),h="number"==typeof a,i=g?a._input:h?{}:a,j=null;return h?b?i[b]=a:i.milliseconds=a:(j=pb.exec(a))?(c="-"===j[1]?-1:1,i={y:0,d:q(j[hb])*c,h:q(j[ib])*c,m:q(j[jb])*c,s:q(j[kb])*c,ms:q(j[lb])*c}):(j=qb.exec(a))&&(c="-"===j[1]?-1:1,e=function(a){var b=a&&parseFloat(a.replace(",","."));return(isNaN(b)?0:b)*c},i={y:e(j[2]),M:e(j[3]),d:e(j[4]),h:e(j[5]),m:e(j[6]),s:e(j[7]),w:e(j[8])}),d=new f(i),g&&a.hasOwnProperty("_lang")&&(d._lang=a._lang),d},bb.version=db,bb.defaultFormat=Eb,bb.updateOffset=function(){},bb.lang=function(a,b){var c;return a?(b?y(x(a),b):null===b?(z(a),a="en"):mb[a]||A(a),c=bb.duration.fn._lang=bb.fn._lang=A(a),c._abbr):bb.fn._lang._abbr},bb.langData=function(a){return a&&a._lang&&a._lang._abbr&&(a=a._lang._abbr),A(a)},bb.isMoment=function(a){return a instanceof e},bb.isDuration=function(a){return a instanceof f},cb=Qb.length-1;cb>=0;--cb)p(Qb[cb]);for(bb.normalizeUnits=function(a){return n(a)},bb.invalid=function(a){var b=bb.utc(0/0);return null!=a?g(b._pf,a):b._pf.userInvalidated=!0,b},bb.parseZone=function(a){return bb(a).parseZone()},g(bb.fn=e.prototype,{clone:function(){return bb(this)},valueOf:function(){return+this._d+6e4*(this._offset||0)},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){return D(bb(this).utc(),"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var a=this;return[a.year(),a.month(),a.date(),a.hours(),a.minutes(),a.seconds(),a.milliseconds()]},isValid:function(){return w(this)},isDSTShifted:function(){return this._a?this.isValid()&&m(this._a,(this._isUTC?bb.utc(this._a):bb(this._a)).toArray())>0:!1},parsingFlags:function(){return g({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(){return this.zone(0)},local:function(){return this.zone(0),this._isUTC=!1,this},format:function(a){var b=D(this,a||bb.defaultFormat);return this.lang().postformat(b)},add:function(a,b){var c;return c="string"==typeof a?bb.duration(+b,a):bb.duration(a,b),j(this,c,1),this},subtract:function(a,b){var c;return c="string"==typeof a?bb.duration(+b,a):bb.duration(a,b),j(this,c,-1),this},diff:function(a,b,c){var d,e,f=this._isUTC?bb(a).zone(this._offset||0):bb(a).local(),g=6e4*(this.zone()-f.zone());return b=n(b),"year"===b||"month"===b?(d=432e5*(this.daysInMonth()+f.daysInMonth()),e=12*(this.year()-f.year())+(this.month()-f.month()),e+=(this-bb(this).startOf("month")-(f-bb(f).startOf("month")))/d,e-=6e4*(this.zone()-bb(this).startOf("month").zone()-(f.zone()-bb(f).startOf("month").zone()))/d,"year"===b&&(e/=12)):(d=this-f,e="second"===b?d/1e3:"minute"===b?d/6e4:"hour"===b?d/36e5:"day"===b?(d-g)/864e5:"week"===b?(d-g)/6048e5:d),c?e:h(e)},from:function(a,b){return bb.duration(this.diff(a)).lang(this.lang()._abbr).humanize(!b)},fromNow:function(a){return this.from(bb(),a)},calendar:function(){var a=this.diff(bb().zone(this.zone()).startOf("day"),"days",!0),b=-6>a?"sameElse":-1>a?"lastWeek":0>a?"lastDay":1>a?"sameDay":2>a?"nextDay":7>a?"nextWeek":"sameElse";return this.format(this.lang().calendar(b,this))},isLeapYear:function(){return t(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=T(a,this.lang()),this.add({d:a-b})):b},month:function(a){var b,c=this._isUTC?"UTC":"";return null!=a?"string"==typeof a&&(a=this.lang().monthsParse(a),"number"!=typeof a)?this:(b=this.date(),this.date(1),this._d["set"+c+"Month"](a),this.date(Math.min(b,this.daysInMonth())),bb.updateOffset(this),this):this._d["get"+c+"Month"]()},startOf:function(a){switch(a=n(a)){case"year":this.month(0);case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a?this.weekday(0):"isoWeek"===a&&this.isoWeekday(1),this},endOf:function(a){return a=n(a),this.startOf(a).add("isoWeek"===a?"week":a,1).subtract("ms",1)},isAfter:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)>+bb(a).startOf(b)},isBefore:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)<+bb(a).startOf(b)},isSame:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)===+bb(a).startOf(b)},min:function(a){return a=bb.apply(null,arguments),this>a?this:a},max:function(a){return a=bb.apply(null,arguments),a>this?this:a},zone:function(a){var b=this._offset||0;return null==a?this._isUTC?b:this._d.getTimezoneOffset():("string"==typeof a&&(a=G(a)),Math.abs(a)<16&&(a=60*a),this._offset=a,this._isUTC=!0,b!==a&&j(this,bb.duration(b-a,"m"),1,!0),this)},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){return"string"==typeof this._i&&this.zone(this._i),this},hasAlignedHourOffset:function(a){return a=a?bb(a).zone():0,0===(this.zone()-a)%60},daysInMonth:function(){return r(this.year(),this.month())},dayOfYear:function(a){var b=eb((bb(this).startOf("day")-bb(this).startOf("year"))/864e5)+1;return null==a?b:this.add("d",a-b)},weekYear:function(a){var b=W(this,this.lang()._week.dow,this.lang()._week.doy).year;return null==a?b:this.add("y",a-b)},isoWeekYear:function(a){var b=W(this,1,4).year;return null==a?b:this.add("y",a-b)},week:function(a){var b=this.lang().week(this);return null==a?b:this.add("d",7*(a-b))},isoWeek:function(a){var b=W(this,1,4).week;return null==a?b:this.add("d",7*(a-b))},weekday:function(a){var b=(this.day()+7-this.lang()._week.dow)%7;return null==a?b:this.add("d",a-b)},isoWeekday:function(a){return null==a?this.day()||7:this.day(this.day()%7?a:a-7)},get:function(a){return a=n(a),this[a]()},set:function(a,b){return a=n(a),"function"==typeof this[a]&&this[a](b),this},lang:function(b){return b===a?this._lang:(this._lang=A(b),this)}}),cb=0;cb<Ib.length;cb++)Z(Ib[cb].toLowerCase().replace(/s$/,""),Ib[cb]);Z("year","FullYear"),bb.fn.days=bb.fn.day,bb.fn.months=bb.fn.month,bb.fn.weeks=bb.fn.week,bb.fn.isoWeeks=bb.fn.isoWeek,bb.fn.toJSON=bb.fn.toISOString,g(bb.duration.fn=f.prototype,{_bubble:function(){var a,b,c,d,e=this._milliseconds,f=this._days,g=this._months,i=this._data;i.milliseconds=e%1e3,a=h(e/1e3),i.seconds=a%60,b=h(a/60),i.minutes=b%60,c=h(b/60),i.hours=c%24,f+=h(c/24),i.days=f%30,g+=h(f/30),i.months=g%12,d=h(g/12),i.years=d},weeks:function(){return h(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+2592e6*(this._months%12)+31536e6*q(this._months/12)},humanize:function(a){var b=+this,c=V(b,!a,this.lang());return a&&(c=this.lang().pastFuture(b,c)),this.lang().postformat(c)},add:function(a,b){var c=bb.duration(a,b);return this._milliseconds+=c._milliseconds,this._days+=c._days,this._months+=c._months,this._bubble(),this},subtract:function(a,b){var c=bb.duration(a,b);return this._milliseconds-=c._milliseconds,this._days-=c._days,this._months-=c._months,this._bubble(),this},get:function(a){return a=n(a),this[a.toLowerCase()+"s"]()},as:function(a){return a=n(a),this["as"+a.charAt(0).toUpperCase()+a.slice(1)+"s"]()},lang:bb.fn.lang,toIsoString:function(){var a=Math.abs(this.years()),b=Math.abs(this.months()),c=Math.abs(this.days()),d=Math.abs(this.hours()),e=Math.abs(this.minutes()),f=Math.abs(this.seconds()+this.milliseconds()/1e3);return this.asSeconds()?(this.asSeconds()<0?"-":"")+"P"+(a?a+"Y":"")+(b?b+"M":"")+(c?c+"D":"")+(d||e||f?"T":"")+(d?d+"H":"")+(e?e+"M":"")+(f?f+"S":""):"P0D"}});for(cb in Jb)Jb.hasOwnProperty(cb)&&(_(cb,Jb[cb]),$(cb.toLowerCase()));_("Weeks",6048e5),bb.duration.fn.asMonths=function(){return(+this-31536e6*this.years())/2592e6+12*this.years()},bb.lang("en",{ordinal:function(a){var b=a%10,c=1===q(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),nb?(module.exports=bb,ab(!0)):"function"==typeof define&&define.amd?define("moment",['require','exports','module'],function(b,c,d){return d.config().noGlobal!==!0&&ab(d.config().noGlobal===a),bb}):ab()}).call(this);
//     Underscore.js 1.4.4
//     http://underscorejs.org
//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

(function() {

  // Baseline setup
  // --------------

  // Establish the root object, `window` in the browser, or `global` on the server.
  var root = this;

  // Save the previous value of the `_` variable.
  var previousUnderscore = root._;

  // Establish the object that gets returned to break out of a loop iteration.
  var breaker = {};

  // Save bytes in the minified (but not gzipped) version:
  var ArrayProto = Array.prototype, ObjProto = Object.prototype, FuncProto = Function.prototype;

  // Create quick reference variables for speed access to core prototypes.
  var push             = ArrayProto.push,
      slice            = ArrayProto.slice,
      concat           = ArrayProto.concat,
      toString         = ObjProto.toString,
      hasOwnProperty   = ObjProto.hasOwnProperty;

  // All **ECMAScript 5** native function implementations that we hope to use
  // are declared here.
  var
    nativeForEach      = ArrayProto.forEach,
    nativeMap          = ArrayProto.map,
    nativeReduce       = ArrayProto.reduce,
    nativeReduceRight  = ArrayProto.reduceRight,
    nativeFilter       = ArrayProto.filter,
    nativeEvery        = ArrayProto.every,
    nativeSome         = ArrayProto.some,
    nativeIndexOf      = ArrayProto.indexOf,
    nativeLastIndexOf  = ArrayProto.lastIndexOf,
    nativeIsArray      = Array.isArray,
    nativeKeys         = Object.keys,
    nativeBind         = FuncProto.bind;

  // Create a safe reference to the Underscore object for use below.
  var _ = function(obj) {
    if (obj instanceof _) return obj;
    if (!(this instanceof _)) return new _(obj);
    this._wrapped = obj;
  };

  // Export the Underscore object for **Node.js**, with
  // backwards-compatibility for the old `require()` API. If we're in
  // the browser, add `_` as a global object via a string identifier,
  // for Closure Compiler "advanced" mode.
  if (typeof exports !== 'undefined') {
    if (typeof module !== 'undefined' && module.exports) {
      exports = module.exports = _;
    }
    exports._ = _;
  } else {
    root._ = _;
  }

  // Current version.
  _.VERSION = '1.4.4';

  // Collection Functions
  // --------------------

  // The cornerstone, an `each` implementation, aka `forEach`.
  // Handles objects with the built-in `forEach`, arrays, and raw objects.
  // Delegates to **ECMAScript 5**'s native `forEach` if available.
  var each = _.each = _.forEach = function(obj, iterator, context) {
    if (obj == null) return;
    if (nativeForEach && obj.forEach === nativeForEach) {
      obj.forEach(iterator, context);
    } else if (obj.length === +obj.length) {
      for (var i = 0, l = obj.length; i < l; i++) {
        if (iterator.call(context, obj[i], i, obj) === breaker) return;
      }
    } else {
      for (var key in obj) {
        if (_.has(obj, key)) {
          if (iterator.call(context, obj[key], key, obj) === breaker) return;
        }
      }
    }
  };

  // Return the results of applying the iterator to each element.
  // Delegates to **ECMAScript 5**'s native `map` if available.
  _.map = _.collect = function(obj, iterator, context) {
    var results = [];
    if (obj == null) return results;
    if (nativeMap && obj.map === nativeMap) return obj.map(iterator, context);
    each(obj, function(value, index, list) {
      results[results.length] = iterator.call(context, value, index, list);
    });
    return results;
  };

  var reduceError = 'Reduce of empty array with no initial value';

  // **Reduce** builds up a single result from a list of values, aka `inject`,
  // or `foldl`. Delegates to **ECMAScript 5**'s native `reduce` if available.
  _.reduce = _.foldl = _.inject = function(obj, iterator, memo, context) {
    var initial = arguments.length > 2;
    if (obj == null) obj = [];
    if (nativeReduce && obj.reduce === nativeReduce) {
      if (context) iterator = _.bind(iterator, context);
      return initial ? obj.reduce(iterator, memo) : obj.reduce(iterator);
    }
    each(obj, function(value, index, list) {
      if (!initial) {
        memo = value;
        initial = true;
      } else {
        memo = iterator.call(context, memo, value, index, list);
      }
    });
    if (!initial) throw new TypeError(reduceError);
    return memo;
  };

  // The right-associative version of reduce, also known as `foldr`.
  // Delegates to **ECMAScript 5**'s native `reduceRight` if available.
  _.reduceRight = _.foldr = function(obj, iterator, memo, context) {
    var initial = arguments.length > 2;
    if (obj == null) obj = [];
    if (nativeReduceRight && obj.reduceRight === nativeReduceRight) {
      if (context) iterator = _.bind(iterator, context);
      return initial ? obj.reduceRight(iterator, memo) : obj.reduceRight(iterator);
    }
    var length = obj.length;
    if (length !== +length) {
      var keys = _.keys(obj);
      length = keys.length;
    }
    each(obj, function(value, index, list) {
      index = keys ? keys[--length] : --length;
      if (!initial) {
        memo = obj[index];
        initial = true;
      } else {
        memo = iterator.call(context, memo, obj[index], index, list);
      }
    });
    if (!initial) throw new TypeError(reduceError);
    return memo;
  };

  // Return the first value which passes a truth test. Aliased as `detect`.
  _.find = _.detect = function(obj, iterator, context) {
    var result;
    any(obj, function(value, index, list) {
      if (iterator.call(context, value, index, list)) {
        result = value;
        return true;
      }
    });
    return result;
  };

  // Return all the elements that pass a truth test.
  // Delegates to **ECMAScript 5**'s native `filter` if available.
  // Aliased as `select`.
  _.filter = _.select = function(obj, iterator, context) {
    var results = [];
    if (obj == null) return results;
    if (nativeFilter && obj.filter === nativeFilter) return obj.filter(iterator, context);
    each(obj, function(value, index, list) {
      if (iterator.call(context, value, index, list)) results[results.length] = value;
    });
    return results;
  };

  // Return all the elements for which a truth test fails.
  _.reject = function(obj, iterator, context) {
    return _.filter(obj, function(value, index, list) {
      return !iterator.call(context, value, index, list);
    }, context);
  };

  // Determine whether all of the elements match a truth test.
  // Delegates to **ECMAScript 5**'s native `every` if available.
  // Aliased as `all`.
  _.every = _.all = function(obj, iterator, context) {
    iterator || (iterator = _.identity);
    var result = true;
    if (obj == null) return result;
    if (nativeEvery && obj.every === nativeEvery) return obj.every(iterator, context);
    each(obj, function(value, index, list) {
      if (!(result = result && iterator.call(context, value, index, list))) return breaker;
    });
    return !!result;
  };

  // Determine if at least one element in the object matches a truth test.
  // Delegates to **ECMAScript 5**'s native `some` if available.
  // Aliased as `any`.
  var any = _.some = _.any = function(obj, iterator, context) {
    iterator || (iterator = _.identity);
    var result = false;
    if (obj == null) return result;
    if (nativeSome && obj.some === nativeSome) return obj.some(iterator, context);
    each(obj, function(value, index, list) {
      if (result || (result = iterator.call(context, value, index, list))) return breaker;
    });
    return !!result;
  };

  // Determine if the array or object contains a given value (using `===`).
  // Aliased as `include`.
  _.contains = _.include = function(obj, target) {
    if (obj == null) return false;
    if (nativeIndexOf && obj.indexOf === nativeIndexOf) return obj.indexOf(target) != -1;
    return any(obj, function(value) {
      return value === target;
    });
  };

  // Invoke a method (with arguments) on every item in a collection.
  _.invoke = function(obj, method) {
    var args = slice.call(arguments, 2);
    var isFunc = _.isFunction(method);
    return _.map(obj, function(value) {
      return (isFunc ? method : value[method]).apply(value, args);
    });
  };

  // Convenience version of a common use case of `map`: fetching a property.
  _.pluck = function(obj, key) {
    return _.map(obj, function(value){ return value[key]; });
  };

  // Convenience version of a common use case of `filter`: selecting only objects
  // containing specific `key:value` pairs.
  _.where = function(obj, attrs, first) {
    if (_.isEmpty(attrs)) return first ? void 0 : [];
    return _[first ? 'find' : 'filter'](obj, function(value) {
      for (var key in attrs) {
        if (attrs[key] !== value[key]) return false;
      }
      return true;
    });
  };

  // Convenience version of a common use case of `find`: getting the first object
  // containing specific `key:value` pairs.
  _.findWhere = function(obj, attrs) {
    return _.where(obj, attrs, true);
  };

  // Return the maximum element or (element-based computation).
  // Can't optimize arrays of integers longer than 65,535 elements.
  // See: https://bugs.webkit.org/show_bug.cgi?id=80797
  _.max = function(obj, iterator, context) {
    if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {
      return Math.max.apply(Math, obj);
    }
    if (!iterator && _.isEmpty(obj)) return -Infinity;
    var result = {computed : -Infinity, value: -Infinity};
    each(obj, function(value, index, list) {
      var computed = iterator ? iterator.call(context, value, index, list) : value;
      computed >= result.computed && (result = {value : value, computed : computed});
    });
    return result.value;
  };

  // Return the minimum element (or element-based computation).
  _.min = function(obj, iterator, context) {
    if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {
      return Math.min.apply(Math, obj);
    }
    if (!iterator && _.isEmpty(obj)) return Infinity;
    var result = {computed : Infinity, value: Infinity};
    each(obj, function(value, index, list) {
      var computed = iterator ? iterator.call(context, value, index, list) : value;
      computed < result.computed && (result = {value : value, computed : computed});
    });
    return result.value;
  };

  // Shuffle an array.
  _.shuffle = function(obj) {
    var rand;
    var index = 0;
    var shuffled = [];
    each(obj, function(value) {
      rand = _.random(index++);
      shuffled[index - 1] = shuffled[rand];
      shuffled[rand] = value;
    });
    return shuffled;
  };

  // An internal function to generate lookup iterators.
  var lookupIterator = function(value) {
    return _.isFunction(value) ? value : function(obj){ return obj[value]; };
  };

  // Sort the object's values by a criterion produced by an iterator.
  _.sortBy = function(obj, value, context) {
    var iterator = lookupIterator(value);
    return _.pluck(_.map(obj, function(value, index, list) {
      return {
        value : value,
        index : index,
        criteria : iterator.call(context, value, index, list)
      };
    }).sort(function(left, right) {
      var a = left.criteria;
      var b = right.criteria;
      if (a !== b) {
        if (a > b || a === void 0) return 1;
        if (a < b || b === void 0) return -1;
      }
      return left.index < right.index ? -1 : 1;
    }), 'value');
  };

  // An internal function used for aggregate "group by" operations.
  var group = function(obj, value, context, behavior) {
    var result = {};
    var iterator = lookupIterator(value || _.identity);
    each(obj, function(value, index) {
      var key = iterator.call(context, value, index, obj);
      behavior(result, key, value);
    });
    return result;
  };

  // Groups the object's values by a criterion. Pass either a string attribute
  // to group by, or a function that returns the criterion.
  _.groupBy = function(obj, value, context) {
    return group(obj, value, context, function(result, key, value) {
      (_.has(result, key) ? result[key] : (result[key] = [])).push(value);
    });
  };

  // Counts instances of an object that group by a certain criterion. Pass
  // either a string attribute to count by, or a function that returns the
  // criterion.
  _.countBy = function(obj, value, context) {
    return group(obj, value, context, function(result, key) {
      if (!_.has(result, key)) result[key] = 0;
      result[key]++;
    });
  };

  // Use a comparator function to figure out the smallest index at which
  // an object should be inserted so as to maintain order. Uses binary search.
  _.sortedIndex = function(array, obj, iterator, context) {
    iterator = iterator == null ? _.identity : lookupIterator(iterator);
    var value = iterator.call(context, obj);
    var low = 0, high = array.length;
    while (low < high) {
      var mid = (low + high) >>> 1;
      iterator.call(context, array[mid]) < value ? low = mid + 1 : high = mid;
    }
    return low;
  };

  // Safely convert anything iterable into a real, live array.
  _.toArray = function(obj) {
    if (!obj) return [];
    if (_.isArray(obj)) return slice.call(obj);
    if (obj.length === +obj.length) return _.map(obj, _.identity);
    return _.values(obj);
  };

  // Return the number of elements in an object.
  _.size = function(obj) {
    if (obj == null) return 0;
    return (obj.length === +obj.length) ? obj.length : _.keys(obj).length;
  };

  // Array Functions
  // ---------------

  // Get the first element of an array. Passing **n** will return the first N
  // values in the array. Aliased as `head` and `take`. The **guard** check
  // allows it to work with `_.map`.
  _.first = _.head = _.take = function(array, n, guard) {
    if (array == null) return void 0;
    return (n != null) && !guard ? slice.call(array, 0, n) : array[0];
  };

  // Returns everything but the last entry of the array. Especially useful on
  // the arguments object. Passing **n** will return all the values in
  // the array, excluding the last N. The **guard** check allows it to work with
  // `_.map`.
  _.initial = function(array, n, guard) {
    return slice.call(array, 0, array.length - ((n == null) || guard ? 1 : n));
  };

  // Get the last element of an array. Passing **n** will return the last N
  // values in the array. The **guard** check allows it to work with `_.map`.
  _.last = function(array, n, guard) {
    if (array == null) return void 0;
    if ((n != null) && !guard) {
      return slice.call(array, Math.max(array.length - n, 0));
    } else {
      return array[array.length - 1];
    }
  };

  // Returns everything but the first entry of the array. Aliased as `tail` and `drop`.
  // Especially useful on the arguments object. Passing an **n** will return
  // the rest N values in the array. The **guard**
  // check allows it to work with `_.map`.
  _.rest = _.tail = _.drop = function(array, n, guard) {
    return slice.call(array, (n == null) || guard ? 1 : n);
  };

  // Trim out all falsy values from an array.
  _.compact = function(array) {
    return _.filter(array, _.identity);
  };

  // Internal implementation of a recursive `flatten` function.
  var flatten = function(input, shallow, output) {
    each(input, function(value) {
      if (_.isArray(value)) {
        shallow ? push.apply(output, value) : flatten(value, shallow, output);
      } else {
        output.push(value);
      }
    });
    return output;
  };

  // Return a completely flattened version of an array.
  _.flatten = function(array, shallow) {
    return flatten(array, shallow, []);
  };

  // Return a version of the array that does not contain the specified value(s).
  _.without = function(array) {
    return _.difference(array, slice.call(arguments, 1));
  };

  // Produce a duplicate-free version of the array. If the array has already
  // been sorted, you have the option of using a faster algorithm.
  // Aliased as `unique`.
  _.uniq = _.unique = function(array, isSorted, iterator, context) {
    if (_.isFunction(isSorted)) {
      context = iterator;
      iterator = isSorted;
      isSorted = false;
    }
    var initial = iterator ? _.map(array, iterator, context) : array;
    var results = [];
    var seen = [];
    each(initial, function(value, index) {
      if (isSorted ? (!index || seen[seen.length - 1] !== value) : !_.contains(seen, value)) {
        seen.push(value);
        results.push(array[index]);
      }
    });
    return results;
  };

  // Produce an array that contains the union: each distinct element from all of
  // the passed-in arrays.
  _.union = function() {
    return _.uniq(concat.apply(ArrayProto, arguments));
  };

  // Produce an array that contains every item shared between all the
  // passed-in arrays.
  _.intersection = function(array) {
    var rest = slice.call(arguments, 1);
    return _.filter(_.uniq(array), function(item) {
      return _.every(rest, function(other) {
        return _.indexOf(other, item) >= 0;
      });
    });
  };

  // Take the difference between one array and a number of other arrays.
  // Only the elements present in just the first array will remain.
  _.difference = function(array) {
    var rest = concat.apply(ArrayProto, slice.call(arguments, 1));
    return _.filter(array, function(value){ return !_.contains(rest, value); });
  };

  // Zip together multiple lists into a single array -- elements that share
  // an index go together.
  _.zip = function() {
    var args = slice.call(arguments);
    var length = _.max(_.pluck(args, 'length'));
    var results = new Array(length);
    for (var i = 0; i < length; i++) {
      results[i] = _.pluck(args, "" + i);
    }
    return results;
  };

  // Converts lists into objects. Pass either a single array of `[key, value]`
  // pairs, or two parallel arrays of the same length -- one of keys, and one of
  // the corresponding values.
  _.object = function(list, values) {
    if (list == null) return {};
    var result = {};
    for (var i = 0, l = list.length; i < l; i++) {
      if (values) {
        result[list[i]] = values[i];
      } else {
        result[list[i][0]] = list[i][1];
      }
    }
    return result;
  };

  // If the browser doesn't supply us with indexOf (I'm looking at you, **MSIE**),
  // we need this function. Return the position of the first occurrence of an
  // item in an array, or -1 if the item is not included in the array.
  // Delegates to **ECMAScript 5**'s native `indexOf` if available.
  // If the array is large and already in sort order, pass `true`
  // for **isSorted** to use binary search.
  _.indexOf = function(array, item, isSorted) {
    if (array == null) return -1;
    var i = 0, l = array.length;
    if (isSorted) {
      if (typeof isSorted == 'number') {
        i = (isSorted < 0 ? Math.max(0, l + isSorted) : isSorted);
      } else {
        i = _.sortedIndex(array, item);
        return array[i] === item ? i : -1;
      }
    }
    if (nativeIndexOf && array.indexOf === nativeIndexOf) return array.indexOf(item, isSorted);
    for (; i < l; i++) if (array[i] === item) return i;
    return -1;
  };

  // Delegates to **ECMAScript 5**'s native `lastIndexOf` if available.
  _.lastIndexOf = function(array, item, from) {
    if (array == null) return -1;
    var hasIndex = from != null;
    if (nativeLastIndexOf && array.lastIndexOf === nativeLastIndexOf) {
      return hasIndex ? array.lastIndexOf(item, from) : array.lastIndexOf(item);
    }
    var i = (hasIndex ? from : array.length);
    while (i--) if (array[i] === item) return i;
    return -1;
  };

  // Generate an integer Array containing an arithmetic progression. A port of
  // the native Python `range()` function. See
  // [the Python documentation](http://docs.python.org/library/functions.html#range).
  _.range = function(start, stop, step) {
    if (arguments.length <= 1) {
      stop = start || 0;
      start = 0;
    }
    step = arguments[2] || 1;

    var len = Math.max(Math.ceil((stop - start) / step), 0);
    var idx = 0;
    var range = new Array(len);

    while(idx < len) {
      range[idx++] = start;
      start += step;
    }

    return range;
  };

  // Function (ahem) Functions
  // ------------------

  // Create a function bound to a given object (assigning `this`, and arguments,
  // optionally). Delegates to **ECMAScript 5**'s native `Function.bind` if
  // available.
  _.bind = function(func, context) {
    if (func.bind === nativeBind && nativeBind) return nativeBind.apply(func, slice.call(arguments, 1));
    var args = slice.call(arguments, 2);
    return function() {
      return func.apply(context, args.concat(slice.call(arguments)));
    };
  };

  // Partially apply a function by creating a version that has had some of its
  // arguments pre-filled, without changing its dynamic `this` context.
  _.partial = function(func) {
    var args = slice.call(arguments, 1);
    return function() {
      return func.apply(this, args.concat(slice.call(arguments)));
    };
  };

  // Bind all of an object's methods to that object. Useful for ensuring that
  // all callbacks defined on an object belong to it.
  _.bindAll = function(obj) {
    var funcs = slice.call(arguments, 1);
    if (funcs.length === 0) throw new Error("bindAll must be passed function names");
    each(funcs, function(f) { obj[f] = _.bind(obj[f], obj); });
    return obj;
  };

  // Memoize an expensive function by storing its results.
  _.memoize = function(func, hasher) {
    var memo = {};
    hasher || (hasher = _.identity);
    return function() {
      var key = hasher.apply(this, arguments);
      return _.has(memo, key) ? memo[key] : (memo[key] = func.apply(this, arguments));
    };
  };

  // Delays a function for the given number of milliseconds, and then calls
  // it with the arguments supplied.
  _.delay = function(func, wait) {
    var args = slice.call(arguments, 2);
    return setTimeout(function(){ return func.apply(null, args); }, wait);
  };

  // Defers a function, scheduling it to run after the current call stack has
  // cleared.
  _.defer = function(func) {
    return _.delay.apply(_, [func, 1].concat(slice.call(arguments, 1)));
  };

  // Returns a function, that, when invoked, will only be triggered at most once
  // during a given window of time.
  _.throttle = function(func, wait) {
    var context, args, timeout, result;
    var previous = 0;
    var later = function() {
      previous = new Date;
      timeout = null;
      result = func.apply(context, args);
    };
    return function() {
      var now = new Date;
      var remaining = wait - (now - previous);
      context = this;
      args = arguments;
      if (remaining <= 0) {
        clearTimeout(timeout);
        timeout = null;
        previous = now;
        result = func.apply(context, args);
      } else if (!timeout) {
        timeout = setTimeout(later, remaining);
      }
      return result;
    };
  };

  // Returns a function, that, as long as it continues to be invoked, will not
  // be triggered. The function will be called after it stops being called for
  // N milliseconds. If `immediate` is passed, trigger the function on the
  // leading edge, instead of the trailing.
  _.debounce = function(func, wait, immediate) {
    var timeout, result;
    return function() {
      var context = this, args = arguments;
      var later = function() {
        timeout = null;
        if (!immediate) result = func.apply(context, args);
      };
      var callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) result = func.apply(context, args);
      return result;
    };
  };

  // Returns a function that will be executed at most one time, no matter how
  // often you call it. Useful for lazy initialization.
  _.once = function(func) {
    var ran = false, memo;
    return function() {
      if (ran) return memo;
      ran = true;
      memo = func.apply(this, arguments);
      func = null;
      return memo;
    };
  };

  // Returns the first function passed as an argument to the second,
  // allowing you to adjust arguments, run code before and after, and
  // conditionally execute the original function.
  _.wrap = function(func, wrapper) {
    return function() {
      var args = [func];
      push.apply(args, arguments);
      return wrapper.apply(this, args);
    };
  };

  // Returns a function that is the composition of a list of functions, each
  // consuming the return value of the function that follows.
  _.compose = function() {
    var funcs = arguments;
    return function() {
      var args = arguments;
      for (var i = funcs.length - 1; i >= 0; i--) {
        args = [funcs[i].apply(this, args)];
      }
      return args[0];
    };
  };

  // Returns a function that will only be executed after being called N times.
  _.after = function(times, func) {
    if (times <= 0) return func();
    return function() {
      if (--times < 1) {
        return func.apply(this, arguments);
      }
    };
  };

  // Object Functions
  // ----------------

  // Retrieve the names of an object's properties.
  // Delegates to **ECMAScript 5**'s native `Object.keys`
  _.keys = nativeKeys || function(obj) {
    if (obj !== Object(obj)) throw new TypeError('Invalid object');
    var keys = [];
    for (var key in obj) if (_.has(obj, key)) keys[keys.length] = key;
    return keys;
  };

  // Retrieve the values of an object's properties.
  _.values = function(obj) {
    var values = [];
    for (var key in obj) if (_.has(obj, key)) values.push(obj[key]);
    return values;
  };

  // Convert an object into a list of `[key, value]` pairs.
  _.pairs = function(obj) {
    var pairs = [];
    for (var key in obj) if (_.has(obj, key)) pairs.push([key, obj[key]]);
    return pairs;
  };

  // Invert the keys and values of an object. The values must be serializable.
  _.invert = function(obj) {
    var result = {};
    for (var key in obj) if (_.has(obj, key)) result[obj[key]] = key;
    return result;
  };

  // Return a sorted list of the function names available on the object.
  // Aliased as `methods`
  _.functions = _.methods = function(obj) {
    var names = [];
    for (var key in obj) {
      if (_.isFunction(obj[key])) names.push(key);
    }
    return names.sort();
  };

  // Extend a given object with all the properties in passed-in object(s).
  _.extend = function(obj) {
    each(slice.call(arguments, 1), function(source) {
      if (source) {
        for (var prop in source) {
          obj[prop] = source[prop];
        }
      }
    });
    return obj;
  };

  // Return a copy of the object only containing the whitelisted properties.
  _.pick = function(obj) {
    var copy = {};
    var keys = concat.apply(ArrayProto, slice.call(arguments, 1));
    each(keys, function(key) {
      if (key in obj) copy[key] = obj[key];
    });
    return copy;
  };

   // Return a copy of the object without the blacklisted properties.
  _.omit = function(obj) {
    var copy = {};
    var keys = concat.apply(ArrayProto, slice.call(arguments, 1));
    for (var key in obj) {
      if (!_.contains(keys, key)) copy[key] = obj[key];
    }
    return copy;
  };

  // Fill in a given object with default properties.
  _.defaults = function(obj) {
    each(slice.call(arguments, 1), function(source) {
      if (source) {
        for (var prop in source) {
          if (obj[prop] == null) obj[prop] = source[prop];
        }
      }
    });
    return obj;
  };

  // Create a (shallow-cloned) duplicate of an object.
  _.clone = function(obj) {
    if (!_.isObject(obj)) return obj;
    return _.isArray(obj) ? obj.slice() : _.extend({}, obj);
  };

  // Invokes interceptor with the obj, and then returns obj.
  // The primary purpose of this method is to "tap into" a method chain, in
  // order to perform operations on intermediate results within the chain.
  _.tap = function(obj, interceptor) {
    interceptor(obj);
    return obj;
  };

  // Internal recursive comparison function for `isEqual`.
  var eq = function(a, b, aStack, bStack) {
    // Identical objects are equal. `0 === -0`, but they aren't identical.
    // See the Harmony `egal` proposal: http://wiki.ecmascript.org/doku.php?id=harmony:egal.
    if (a === b) return a !== 0 || 1 / a == 1 / b;
    // A strict comparison is necessary because `null == undefined`.
    if (a == null || b == null) return a === b;
    // Unwrap any wrapped objects.
    if (a instanceof _) a = a._wrapped;
    if (b instanceof _) b = b._wrapped;
    // Compare `[[Class]]` names.
    var className = toString.call(a);
    if (className != toString.call(b)) return false;
    switch (className) {
      // Strings, numbers, dates, and booleans are compared by value.
      case '[object String]':
        // Primitives and their corresponding object wrappers are equivalent; thus, `"5"` is
        // equivalent to `new String("5")`.
        return a == String(b);
      case '[object Number]':
        // `NaN`s are equivalent, but non-reflexive. An `egal` comparison is performed for
        // other numeric values.
        return a != +a ? b != +b : (a == 0 ? 1 / a == 1 / b : a == +b);
      case '[object Date]':
      case '[object Boolean]':
        // Coerce dates and booleans to numeric primitive values. Dates are compared by their
        // millisecond representations. Note that invalid dates with millisecond representations
        // of `NaN` are not equivalent.
        return +a == +b;
      // RegExps are compared by their source patterns and flags.
      case '[object RegExp]':
        return a.source == b.source &&
               a.global == b.global &&
               a.multiline == b.multiline &&
               a.ignoreCase == b.ignoreCase;
    }
    if (typeof a != 'object' || typeof b != 'object') return false;
    // Assume equality for cyclic structures. The algorithm for detecting cyclic
    // structures is adapted from ES 5.1 section 15.12.3, abstract operation `JO`.
    var length = aStack.length;
    while (length--) {
      // Linear search. Performance is inversely proportional to the number of
      // unique nested structures.
      if (aStack[length] == a) return bStack[length] == b;
    }
    // Add the first object to the stack of traversed objects.
    aStack.push(a);
    bStack.push(b);
    var size = 0, result = true;
    // Recursively compare objects and arrays.
    if (className == '[object Array]') {
      // Compare array lengths to determine if a deep comparison is necessary.
      size = a.length;
      result = size == b.length;
      if (result) {
        // Deep compare the contents, ignoring non-numeric properties.
        while (size--) {
          if (!(result = eq(a[size], b[size], aStack, bStack))) break;
        }
      }
    } else {
      // Objects with different constructors are not equivalent, but `Object`s
      // from different frames are.
      var aCtor = a.constructor, bCtor = b.constructor;
      if (aCtor !== bCtor && !(_.isFunction(aCtor) && (aCtor instanceof aCtor) &&
                               _.isFunction(bCtor) && (bCtor instanceof bCtor))) {
        return false;
      }
      // Deep compare objects.
      for (var key in a) {
        if (_.has(a, key)) {
          // Count the expected number of properties.
          size++;
          // Deep compare each member.
          if (!(result = _.has(b, key) && eq(a[key], b[key], aStack, bStack))) break;
        }
      }
      // Ensure that both objects contain the same number of properties.
      if (result) {
        for (key in b) {
          if (_.has(b, key) && !(size--)) break;
        }
        result = !size;
      }
    }
    // Remove the first object from the stack of traversed objects.
    aStack.pop();
    bStack.pop();
    return result;
  };

  // Perform a deep comparison to check if two objects are equal.
  _.isEqual = function(a, b) {
    return eq(a, b, [], []);
  };

  // Is a given array, string, or object empty?
  // An "empty" object has no enumerable own-properties.
  _.isEmpty = function(obj) {
    if (obj == null) return true;
    if (_.isArray(obj) || _.isString(obj)) return obj.length === 0;
    for (var key in obj) if (_.has(obj, key)) return false;
    return true;
  };

  // Is a given value a DOM element?
  _.isElement = function(obj) {
    return !!(obj && obj.nodeType === 1);
  };

  // Is a given value an array?
  // Delegates to ECMA5's native Array.isArray
  _.isArray = nativeIsArray || function(obj) {
    return toString.call(obj) == '[object Array]';
  };

  // Is a given variable an object?
  _.isObject = function(obj) {
    return obj === Object(obj);
  };

  // Add some isType methods: isArguments, isFunction, isString, isNumber, isDate, isRegExp.
  each(['Arguments', 'Function', 'String', 'Number', 'Date', 'RegExp'], function(name) {
    _['is' + name] = function(obj) {
      return toString.call(obj) == '[object ' + name + ']';
    };
  });

  // Define a fallback version of the method in browsers (ahem, IE), where
  // there isn't any inspectable "Arguments" type.
  if (!_.isArguments(arguments)) {
    _.isArguments = function(obj) {
      return !!(obj && _.has(obj, 'callee'));
    };
  }

  // Optimize `isFunction` if appropriate.
  if (typeof (/./) !== 'function') {
    _.isFunction = function(obj) {
      return typeof obj === 'function';
    };
  }

  // Is a given object a finite number?
  _.isFinite = function(obj) {
    return isFinite(obj) && !isNaN(parseFloat(obj));
  };

  // Is the given value `NaN`? (NaN is the only number which does not equal itself).
  _.isNaN = function(obj) {
    return _.isNumber(obj) && obj != +obj;
  };

  // Is a given value a boolean?
  _.isBoolean = function(obj) {
    return obj === true || obj === false || toString.call(obj) == '[object Boolean]';
  };

  // Is a given value equal to null?
  _.isNull = function(obj) {
    return obj === null;
  };

  // Is a given variable undefined?
  _.isUndefined = function(obj) {
    return obj === void 0;
  };

  // Shortcut function for checking if an object has a given property directly
  // on itself (in other words, not on a prototype).
  _.has = function(obj, key) {
    return hasOwnProperty.call(obj, key);
  };

  // Utility Functions
  // -----------------

  // Run Underscore.js in *noConflict* mode, returning the `_` variable to its
  // previous owner. Returns a reference to the Underscore object.
  _.noConflict = function() {
    root._ = previousUnderscore;
    return this;
  };

  // Keep the identity function around for default iterators.
  _.identity = function(value) {
    return value;
  };

  // Run a function **n** times.
  _.times = function(n, iterator, context) {
    var accum = Array(n);
    for (var i = 0; i < n; i++) accum[i] = iterator.call(context, i);
    return accum;
  };

  // Return a random integer between min and max (inclusive).
  _.random = function(min, max) {
    if (max == null) {
      max = min;
      min = 0;
    }
    return min + Math.floor(Math.random() * (max - min + 1));
  };

  // List of HTML entities for escaping.
  var entityMap = {
    escape: {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      '/': '&#x2F;'
    }
  };
  entityMap.unescape = _.invert(entityMap.escape);

  // Regexes containing the keys and values listed immediately above.
  var entityRegexes = {
    escape:   new RegExp('[' + _.keys(entityMap.escape).join('') + ']', 'g'),
    unescape: new RegExp('(' + _.keys(entityMap.unescape).join('|') + ')', 'g')
  };

  // Functions for escaping and unescaping strings to/from HTML interpolation.
  _.each(['escape', 'unescape'], function(method) {
    _[method] = function(string) {
      if (string == null) return '';
      return ('' + string).replace(entityRegexes[method], function(match) {
        return entityMap[method][match];
      });
    };
  });

  // If the value of the named property is a function then invoke it;
  // otherwise, return it.
  _.result = function(object, property) {
    if (object == null) return void 0;
    var value = object[property];
    return _.isFunction(value) ? value.call(object) : value;
  };

  // Add your own custom functions to the Underscore object.
  _.mixin = function(obj) {
    each(_.functions(obj), function(name){
      var func = _[name] = obj[name];
      _.prototype[name] = function() {
        var args = [this._wrapped];
        push.apply(args, arguments);
        return result.call(this, func.apply(_, args));
      };
    });
  };

  // Generate a unique integer id (unique within the entire client session).
  // Useful for temporary DOM ids.
  var idCounter = 0;
  _.uniqueId = function(prefix) {
    var id = ++idCounter + '';
    return prefix ? prefix + id : id;
  };

  // By default, Underscore uses ERB-style template delimiters, change the
  // following template settings to use alternative delimiters.
  _.templateSettings = {
    evaluate    : /<%([\s\S]+?)%>/g,
    interpolate : /<%=([\s\S]+?)%>/g,
    escape      : /<%-([\s\S]+?)%>/g
  };

  // When customizing `templateSettings`, if you don't want to define an
  // interpolation, evaluation or escaping regex, we need one that is
  // guaranteed not to match.
  var noMatch = /(.)^/;

  // Certain characters need to be escaped so that they can be put into a
  // string literal.
  var escapes = {
    "'":      "'",
    '\\':     '\\',
    '\r':     'r',
    '\n':     'n',
    '\t':     't',
    '\u2028': 'u2028',
    '\u2029': 'u2029'
  };

  var escaper = /\\|'|\r|\n|\t|\u2028|\u2029/g;

  // JavaScript micro-templating, similar to John Resig's implementation.
  // Underscore templating handles arbitrary delimiters, preserves whitespace,
  // and correctly escapes quotes within interpolated code.
  _.template = function(text, data, settings) {
    var render;
    settings = _.defaults({}, settings, _.templateSettings);

    // Combine delimiters into one regular expression via alternation.
    var matcher = new RegExp([
      (settings.escape || noMatch).source,
      (settings.interpolate || noMatch).source,
      (settings.evaluate || noMatch).source
    ].join('|') + '|$', 'g');

    // Compile the template source, escaping string literals appropriately.
    var index = 0;
    var source = "__p+='";
    text.replace(matcher, function(match, escape, interpolate, evaluate, offset) {
      source += text.slice(index, offset)
        .replace(escaper, function(match) { return '\\' + escapes[match]; });

      if (escape) {
        source += "'+\n((__t=(" + escape + "))==null?'':_.escape(__t))+\n'";
      }
      if (interpolate) {
        source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
      }
      if (evaluate) {
        source += "';\n" + evaluate + "\n__p+='";
      }
      index = offset + match.length;
      return match;
    });
    source += "';\n";

    // If a variable is not specified, place data values in local scope.
    if (!settings.variable) source = 'with(obj||{}){\n' + source + '}\n';

    source = "var __t,__p='',__j=Array.prototype.join," +
      "print=function(){__p+=__j.call(arguments,'');};\n" +
      source + "return __p;\n";

    try {
      render = new Function(settings.variable || 'obj', '_', source);
    } catch (e) {
      e.source = source;
      throw e;
    }

    if (data) return render(data, _);
    var template = function(data) {
      return render.call(this, data, _);
    };

    // Provide the compiled function source as a convenience for precompilation.
    template.source = 'function(' + (settings.variable || 'obj') + '){\n' + source + '}';

    return template;
  };

  // Add a "chain" function, which will delegate to the wrapper.
  _.chain = function(obj) {
    return _(obj).chain();
  };

  // OOP
  // ---------------
  // If Underscore is called as a function, it returns a wrapped object that
  // can be used OO-style. This wrapper holds altered versions of all the
  // underscore functions. Wrapped objects may be chained.

  // Helper function to continue chaining intermediate results.
  var result = function(obj) {
    return this._chain ? _(obj).chain() : obj;
  };

  // Add all of the Underscore functions to the wrapper object.
  _.mixin(_);

  // Add all mutator Array functions to the wrapper.
  each(['pop', 'push', 'reverse', 'shift', 'sort', 'splice', 'unshift'], function(name) {
    var method = ArrayProto[name];
    _.prototype[name] = function() {
      var obj = this._wrapped;
      method.apply(obj, arguments);
      if ((name == 'shift' || name == 'splice') && obj.length === 0) delete obj[0];
      return result.call(this, obj);
    };
  });

  // Add all accessor Array functions to the wrapper.
  each(['concat', 'join', 'slice'], function(name) {
    var method = ArrayProto[name];
    _.prototype[name] = function() {
      return result.call(this, method.apply(this._wrapped, arguments));
    };
  });

  _.extend(_.prototype, {

    // Start chaining a wrapped Underscore object.
    chain: function() {
      this._chain = true;
      return this;
    },

    // Extracts the result from a wrapped and chained object.
    value: function() {
      return this._wrapped;
    }

  });

}).call(this);
define("underscore", (function (global) {
    return function () {
        var ret, fn;
        return ret || global._;
    };
}(this)));

//     (c) 2012 Airbnb, Inc.
//
//     polyglot.js may be freely distributed under the terms of the BSD
//     license. For all licensing information, details, and documention:
//     http://airbnb.github.com/polyglot.js
//
//
// Polyglot.js is an I18n helper library written in JavaScript, made to
// work both in the browser and in Node. It provides a simple solution for
// interpolation and pluralization, based off of Airbnb's
// experience adding I18n functionality to its Backbone.js and Node apps.
//
// Polylglot is agnostic to your translation backend. It doesn't perform any
// translation; it simply gives you a way to manage translated phrases from
// your client- or server-side JavaScript application.
//
(function(e,t){typeof define=="function"&&define.amd?define('polyglot',[],function(){return t(e)}):typeof exports=="object"?module.exports=t(e):e.Polyglot=t(e)})(this,function(e){function t(e){e=e||{},this.phrases={},this.extend(e.phrases||{}),this.currentLocale=e.locale||"en",this.allowMissing=!!e.allowMissing,this.warn=e.warn||c}function s(e){var t,n,r,i={};for(t in e)if(e.hasOwnProperty(t)){n=e[t];for(r in n)i[n[r]]=t}return i}function o(e){var t=/^\s+|\s+$/g;return e.replace(t,"")}function u(e,t,r){var i,s,u;return r!=null&&e?(s=e.split(n),u=s[f(t,r)]||s[0],i=o(u)):i=e,i}function a(e){var t=s(i);return t[e]||t.en}function f(e,t){return r[a(e)](t)}function l(e,t){for(var n in t)n!=="_"&&t.hasOwnProperty(n)&&(e=e.replace(new RegExp("%\\{"+n+"\\}","g"),t[n]));return e}function c(t){e.console&&e.console.warn&&e.console.warn("WARNING: "+t)}function h(e){var t={};for(var n in e)t[n]=e[n];return t}t.VERSION="0.4.3",t.prototype.locale=function(e){return e&&(this.currentLocale=e),this.currentLocale},t.prototype.extend=function(e,t){var n;for(var r in e)e.hasOwnProperty(r)&&(n=e[r],t&&(r=t+"."+r),typeof n=="object"?this.extend(n,r):this.phrases[r]=n)},t.prototype.clear=function(){this.phrases={}},t.prototype.replace=function(e){this.clear(),this.extend(e)},t.prototype.t=function(e,t){var n,r;return t=t==null?{}:t,typeof t=="number"&&(t={smart_count:t}),typeof this.phrases[e]=="string"?n=this.phrases[e]:typeof t._=="string"?n=t._:this.allowMissing?n=e:(this.warn('Missing translation for key: "'+e+'"'),r=e),typeof n=="string"&&(t=h(t),r=u(n,this.currentLocale,t.smart_count),r=l(r,t)),r},t.prototype.has=function(e){return e in this.phrases};var n="||||",r={chinese:function(e){return 0},german:function(e){return e!==1?1:0},french:function(e){return e>1?1:0},russian:function(e){return e%10===1&&e%100!==11?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2},czech:function(e){return e===1?0:e>=2&&e<=4?1:2},polish:function(e){return e===1?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2},icelandic:function(e){return e%10!==1||e%100===11?1:0}},i={chinese:["fa","id","ja","ko","lo","ms","th","tr","zh"],german:["da","de","en","es","fi","el","he","hu","it","nl","no","pt","sv"],french:["fr","tl","pt-br"],russian:["hr","ru"],czech:["cs"],polish:["pl"],icelandic:["is"]};return t});
define('core/t',['underscore', 'polyglot'], function(_, Polyglot) {
  var options = window.directusData;
  var locale = options.locale || 'en';
  var phrases = options.phrases;
  var polyglot = new Polyglot({locale: locale, phrases: phrases});

  var __t = function(key, data) {
    return polyglot.has(key) ? polyglot.t(key, data) : key;
  };

  __t.polyglot = polyglot;

  return __t;
});

//@todo: Make vanilla-js (not a require module) and move to vendor folder
define('typetools',['moment', 'core/t'], function(moment, __t) {

  

  var typetools = {

    numberWithCommas: function(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },

    capitalize: function(string, seperator, keepDirectus) {
      var idIndex;

      if (!string) return '';

      if (seperator === undefined) {
        seperator = "_";
      }

      var directusIndex = string.indexOf("directus_");

      if (directusIndex === 0 && !keepDirectus) {
        string = string.substring(9);
      }

      idIndex = string.lastIndexOf("_id");

      if (string.length > 2 && string.length - idIndex === 3) {
        string = string.substring(0, idIndex);
      }

      var output = _.map(string.split(seperator), function(word) { return word.charAt(0).toUpperCase() + word.slice(1); }).join(' ');

      // Replace all custom capitalization here
      _.each(typetools.caseSpecial, function(correctCase) {
        output = output.replace(new RegExp("\\b"+correctCase+"\\b", "gi"), correctCase);
      });

      // Make all prepositions and conjunctions lowercase, except for the first word
      _.each(typetools.caseLower, function(correctCase) {
        output = output.replace(new RegExp(" "+correctCase+"\\b", "gi"), " "+correctCase);
      });

      return output;
    },

    caseSpecial: [
      'IDs',
      'SSN',
      'EIN',
      'NDA',
      'API',
      'CMS',
      'FAQ',
      'iPhone',
      'iPad',
      'iPod',
      'iOS',
      'iMac',
      'PDF',
      'PDFs',
      'URL',
      'IP',
      'UI',
      'FTP',
      'DB',
      'WYSIWYG',
      'CV',
      'ID',
      'pH',
      'PHP',
      'HTML',
      'JS',
      'CSS',
      'SKU',
      'DateTime',
      'ISO',
      'RNGR',
      'CC',
      'CCV'
    ],

    // Conjunctions and prepositions should be lowercase
    caseLower: [
      'a',
      'an',
      'the',
      'and',
      'of',
      'but',
      'or',
      'for',
      'nor',
      'with',
      'on',
      'at',
      'to',
      'from',
      'by'
    ],

    actionMap: {
      'ADD':    __t('action_added'),
      'DELETE': __t('action_deleted'),
      'UPDATE': __t('action_updated')
    },

    prepositionMap: {
      'ADD':    __t('preposition_to'),
      'DELETE': __t('preposition_from'),
      'UPDATE': __t('preposition_within')
    },

    bytesToSize: function(bytes, precision) {
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        var posttxt = 0;
        bytes = parseInt(bytes,10);
        if (bytes === 0) return 'n/a';
        while( bytes >= 1024 ) {
            posttxt++;
            bytes = bytes / 1024;
        }
        return bytes.toFixed(precision) + " " + sizes[posttxt];
      },

    seconds_convert: function (s) {
      var m = Math.floor(s/60); //Get remaining minutes
      s = s%60;
      s = (s < 10) ? '0' + s : s;
      return m+":"+s; //zero padding on minutes and seconds
    },

    contextualDate: function(value) {
      if (value === undefined) {
        return '';
      }
      //@todo: convert value to correct timezone
      value = (value.substr(-1).toLowerCase() === 'z') ? value : value + 'z';
      return moment(value).fromNow();
    },

    dateYYYYMMDD: function(date) {
        return date.toISOString().slice(0,10);
    },

    replaceAll: function(find, replace, str) {
      return str.replace(new RegExp(find, 'g'), replace);
    }

  };

  return typetools;
});

/*! jQuery v1.11.0 | (c) 2005, 2014 jQuery Foundation, Inc. | jquery.org/license */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=c.slice,e=c.concat,f=c.push,g=c.indexOf,h={},i=h.toString,j=h.hasOwnProperty,k="".trim,l={},m="1.11.0",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return d.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:d.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a,b){return n.each(this,a,b)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(e=arguments[h]))for(d in e)a=g[d],c=e[d],g!==c&&(j&&c&&(n.isPlainObject(c)||(b=n.isArray(c)))?(b?(b=!1,f=a&&n.isArray(a)?a:[]):f=a&&n.isPlainObject(a)?a:{},g[d]=n.extend(j,f,c)):void 0!==c&&(g[d]=c));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray||function(a){return"array"===n.type(a)},isWindow:function(a){return null!=a&&a==a.window},isNumeric:function(a){return a-parseFloat(a)>=0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==n.type(a)||a.nodeType||n.isWindow(a))return!1;try{if(a.constructor&&!j.call(a,"constructor")&&!j.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}if(l.ownLast)for(b in a)return j.call(a,b);for(b in a);return void 0===b||j.call(a,b)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?h[i.call(a)]||"object":typeof a},globalEval:function(b){b&&n.trim(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,c){var d,e=0,f=a.length,g=s(a);if(c){if(g){for(;f>e;e++)if(d=b.apply(a[e],c),d===!1)break}else for(e in a)if(d=b.apply(a[e],c),d===!1)break}else if(g){for(;f>e;e++)if(d=b.call(a[e],e,a[e]),d===!1)break}else for(e in a)if(d=b.call(a[e],e,a[e]),d===!1)break;return a},trim:k&&!k.call("\ufeff\xa0")?function(a){return null==a?"":k.call(a)}:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):f.call(c,a)),c},inArray:function(a,b,c){var d;if(b){if(g)return g.call(b,a,c);for(d=b.length,c=c?0>c?Math.max(0,d+c):c:0;d>c;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,b){var c=+b.length,d=0,e=a.length;while(c>d)a[e++]=b[d++];if(c!==c)while(void 0!==b[d])a[e++]=b[d++];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,f=0,g=a.length,h=s(a),i=[];if(h)for(;g>f;f++)d=b(a[f],f,c),null!=d&&i.push(d);else for(f in a)d=b(a[f],f,c),null!=d&&i.push(d);return e.apply([],i)},guid:1,proxy:function(a,b){var c,e,f;return"string"==typeof b&&(f=a[b],b=a,a=f),n.isFunction(a)?(c=d.call(arguments,2),e=function(){return a.apply(b||this,c.concat(d.call(arguments)))},e.guid=a.guid=a.guid||n.guid++,e):void 0},now:function(){return+new Date},support:l}),n.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){h["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s="sizzle"+-new Date,t=a.document,u=0,v=0,w=eb(),x=eb(),y=eb(),z=function(a,b){return a===b&&(j=!0),0},A="undefined",B=1<<31,C={}.hasOwnProperty,D=[],E=D.pop,F=D.push,G=D.push,H=D.slice,I=D.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},J="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",K="[\\x20\\t\\r\\n\\f]",L="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",M=L.replace("w","w#"),N="\\["+K+"*("+L+")"+K+"*(?:([*^$|!~]?=)"+K+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+M+")|)|)"+K+"*\\]",O=":("+L+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+N.replace(3,8)+")*)|.*)\\)|)",P=new RegExp("^"+K+"+|((?:^|[^\\\\])(?:\\\\.)*)"+K+"+$","g"),Q=new RegExp("^"+K+"*,"+K+"*"),R=new RegExp("^"+K+"*([>+~]|"+K+")"+K+"*"),S=new RegExp("="+K+"*([^\\]'\"]*?)"+K+"*\\]","g"),T=new RegExp(O),U=new RegExp("^"+M+"$"),V={ID:new RegExp("^#("+L+")"),CLASS:new RegExp("^\\.("+L+")"),TAG:new RegExp("^("+L.replace("w","w*")+")"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+K+"*(even|odd|(([+-]|)(\\d*)n|)"+K+"*(?:([+-]|)"+K+"*(\\d+)|))"+K+"*\\)|)","i"),bool:new RegExp("^(?:"+J+")$","i"),needsContext:new RegExp("^"+K+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+K+"*((?:-\\d)?\\d*)"+K+"*\\)|)(?=[^-]|$)","i")},W=/^(?:input|select|textarea|button)$/i,X=/^h\d$/i,Y=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,$=/[+~]/,_=/'|\\/g,ab=new RegExp("\\\\([\\da-f]{1,6}"+K+"?|("+K+")|.)","ig"),bb=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)};try{G.apply(D=H.call(t.childNodes),t.childNodes),D[t.childNodes.length].nodeType}catch(cb){G={apply:D.length?function(a,b){F.apply(a,H.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function db(a,b,d,e){var f,g,h,i,j,m,p,q,u,v;if((b?b.ownerDocument||b:t)!==l&&k(b),b=b||l,d=d||[],!a||"string"!=typeof a)return d;if(1!==(i=b.nodeType)&&9!==i)return[];if(n&&!e){if(f=Z.exec(a))if(h=f[1]){if(9===i){if(g=b.getElementById(h),!g||!g.parentNode)return d;if(g.id===h)return d.push(g),d}else if(b.ownerDocument&&(g=b.ownerDocument.getElementById(h))&&r(b,g)&&g.id===h)return d.push(g),d}else{if(f[2])return G.apply(d,b.getElementsByTagName(a)),d;if((h=f[3])&&c.getElementsByClassName&&b.getElementsByClassName)return G.apply(d,b.getElementsByClassName(h)),d}if(c.qsa&&(!o||!o.test(a))){if(q=p=s,u=b,v=9===i&&a,1===i&&"object"!==b.nodeName.toLowerCase()){m=ob(a),(p=b.getAttribute("id"))?q=p.replace(_,"\\$&"):b.setAttribute("id",q),q="[id='"+q+"'] ",j=m.length;while(j--)m[j]=q+pb(m[j]);u=$.test(a)&&mb(b.parentNode)||b,v=m.join(",")}if(v)try{return G.apply(d,u.querySelectorAll(v)),d}catch(w){}finally{p||b.removeAttribute("id")}}}return xb(a.replace(P,"$1"),b,d,e)}function eb(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function fb(a){return a[s]=!0,a}function gb(a){var b=l.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function hb(a,b){var c=a.split("|"),e=a.length;while(e--)d.attrHandle[c[e]]=b}function ib(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||B)-(~a.sourceIndex||B);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function jb(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function kb(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function lb(a){return fb(function(b){return b=+b,fb(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function mb(a){return a&&typeof a.getElementsByTagName!==A&&a}c=db.support={},f=db.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},k=db.setDocument=function(a){var b,e=a?a.ownerDocument||a:t,g=e.defaultView;return e!==l&&9===e.nodeType&&e.documentElement?(l=e,m=e.documentElement,n=!f(e),g&&g!==g.top&&(g.addEventListener?g.addEventListener("unload",function(){k()},!1):g.attachEvent&&g.attachEvent("onunload",function(){k()})),c.attributes=gb(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=gb(function(a){return a.appendChild(e.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Y.test(e.getElementsByClassName)&&gb(function(a){return a.innerHTML="<div class='a'></div><div class='a i'></div>",a.firstChild.className="i",2===a.getElementsByClassName("i").length}),c.getById=gb(function(a){return m.appendChild(a).id=s,!e.getElementsByName||!e.getElementsByName(s).length}),c.getById?(d.find.ID=function(a,b){if(typeof b.getElementById!==A&&n){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ab,bb);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ab,bb);return function(a){var c=typeof a.getAttributeNode!==A&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return typeof b.getElementsByTagName!==A?b.getElementsByTagName(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return typeof b.getElementsByClassName!==A&&n?b.getElementsByClassName(a):void 0},p=[],o=[],(c.qsa=Y.test(e.querySelectorAll))&&(gb(function(a){a.innerHTML="<select t=''><option selected=''></option></select>",a.querySelectorAll("[t^='']").length&&o.push("[*^$]="+K+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||o.push("\\["+K+"*(?:value|"+J+")"),a.querySelectorAll(":checked").length||o.push(":checked")}),gb(function(a){var b=e.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&o.push("name"+K+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||o.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),o.push(",.*:")})),(c.matchesSelector=Y.test(q=m.webkitMatchesSelector||m.mozMatchesSelector||m.oMatchesSelector||m.msMatchesSelector))&&gb(function(a){c.disconnectedMatch=q.call(a,"div"),q.call(a,"[s!='']:x"),p.push("!=",O)}),o=o.length&&new RegExp(o.join("|")),p=p.length&&new RegExp(p.join("|")),b=Y.test(m.compareDocumentPosition),r=b||Y.test(m.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},z=b?function(a,b){if(a===b)return j=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===e||a.ownerDocument===t&&r(t,a)?-1:b===e||b.ownerDocument===t&&r(t,b)?1:i?I.call(i,a)-I.call(i,b):0:4&d?-1:1)}:function(a,b){if(a===b)return j=!0,0;var c,d=0,f=a.parentNode,g=b.parentNode,h=[a],k=[b];if(!f||!g)return a===e?-1:b===e?1:f?-1:g?1:i?I.call(i,a)-I.call(i,b):0;if(f===g)return ib(a,b);c=a;while(c=c.parentNode)h.unshift(c);c=b;while(c=c.parentNode)k.unshift(c);while(h[d]===k[d])d++;return d?ib(h[d],k[d]):h[d]===t?-1:k[d]===t?1:0},e):l},db.matches=function(a,b){return db(a,null,null,b)},db.matchesSelector=function(a,b){if((a.ownerDocument||a)!==l&&k(a),b=b.replace(S,"='$1']"),!(!c.matchesSelector||!n||p&&p.test(b)||o&&o.test(b)))try{var d=q.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return db(b,l,null,[a]).length>0},db.contains=function(a,b){return(a.ownerDocument||a)!==l&&k(a),r(a,b)},db.attr=function(a,b){(a.ownerDocument||a)!==l&&k(a);var e=d.attrHandle[b.toLowerCase()],f=e&&C.call(d.attrHandle,b.toLowerCase())?e(a,b,!n):void 0;return void 0!==f?f:c.attributes||!n?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},db.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},db.uniqueSort=function(a){var b,d=[],e=0,f=0;if(j=!c.detectDuplicates,i=!c.sortStable&&a.slice(0),a.sort(z),j){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return i=null,a},e=db.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=db.selectors={cacheLength:50,createPseudo:fb,match:V,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ab,bb),a[3]=(a[4]||a[5]||"").replace(ab,bb),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||db.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&db.error(a[0]),a},PSEUDO:function(a){var b,c=!a[5]&&a[2];return V.CHILD.test(a[0])?null:(a[3]&&void 0!==a[4]?a[2]=a[4]:c&&T.test(c)&&(b=ob(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ab,bb).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=w[a+" "];return b||(b=new RegExp("(^|"+K+")"+a+"("+K+"|$)"))&&w(a,function(a){return b.test("string"==typeof a.className&&a.className||typeof a.getAttribute!==A&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=db.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),t=!i&&!h;if(q){if(f){while(p){l=b;while(l=l[p])if(h?l.nodeName.toLowerCase()===r:1===l.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&t){k=q[s]||(q[s]={}),j=k[a]||[],n=j[0]===u&&j[1],m=j[0]===u&&j[2],l=n&&q.childNodes[n];while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if(1===l.nodeType&&++m&&l===b){k[a]=[u,n,m];break}}else if(t&&(j=(b[s]||(b[s]={}))[a])&&j[0]===u)m=j[1];else while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if((h?l.nodeName.toLowerCase()===r:1===l.nodeType)&&++m&&(t&&((l[s]||(l[s]={}))[a]=[u,m]),l===b))break;return m-=e,m===d||m%d===0&&m/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||db.error("unsupported pseudo: "+a);return e[s]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?fb(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=I.call(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:fb(function(a){var b=[],c=[],d=g(a.replace(P,"$1"));return d[s]?fb(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),!c.pop()}}),has:fb(function(a){return function(b){return db(a,b).length>0}}),contains:fb(function(a){return function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:fb(function(a){return U.test(a||"")||db.error("unsupported lang: "+a),a=a.replace(ab,bb).toLowerCase(),function(b){var c;do if(c=n?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===m},focus:function(a){return a===l.activeElement&&(!l.hasFocus||l.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return X.test(a.nodeName)},input:function(a){return W.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:lb(function(){return[0]}),last:lb(function(a,b){return[b-1]}),eq:lb(function(a,b,c){return[0>c?c+b:c]}),even:lb(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:lb(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:lb(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:lb(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=jb(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=kb(b);function nb(){}nb.prototype=d.filters=d.pseudos,d.setFilters=new nb;function ob(a,b){var c,e,f,g,h,i,j,k=x[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=Q.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=R.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(P," ")}),h=h.slice(c.length));for(g in d.filter)!(e=V[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?db.error(a):x(a,i).slice(0)}function pb(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function qb(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=v++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j=[u,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(i=b[s]||(b[s]={}),(h=i[d])&&h[0]===u&&h[1]===f)return j[2]=h[2];if(i[d]=j,j[2]=a(b,c,g))return!0}}}function rb(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function sb(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function tb(a,b,c,d,e,f){return d&&!d[s]&&(d=tb(d)),e&&!e[s]&&(e=tb(e,f)),fb(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||wb(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:sb(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=sb(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?I.call(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=sb(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):G.apply(g,r)})}function ub(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],i=g||d.relative[" "],j=g?1:0,k=qb(function(a){return a===b},i,!0),l=qb(function(a){return I.call(b,a)>-1},i,!0),m=[function(a,c,d){return!g&&(d||c!==h)||((b=c).nodeType?k(a,c,d):l(a,c,d))}];f>j;j++)if(c=d.relative[a[j].type])m=[qb(rb(m),c)];else{if(c=d.filter[a[j].type].apply(null,a[j].matches),c[s]){for(e=++j;f>e;e++)if(d.relative[a[e].type])break;return tb(j>1&&rb(m),j>1&&pb(a.slice(0,j-1).concat({value:" "===a[j-2].type?"*":""})).replace(P,"$1"),c,e>j&&ub(a.slice(j,e)),f>e&&ub(a=a.slice(e)),f>e&&pb(a))}m.push(c)}return rb(m)}function vb(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,i,j,k){var m,n,o,p=0,q="0",r=f&&[],s=[],t=h,v=f||e&&d.find.TAG("*",k),w=u+=null==t?1:Math.random()||.1,x=v.length;for(k&&(h=g!==l&&g);q!==x&&null!=(m=v[q]);q++){if(e&&m){n=0;while(o=a[n++])if(o(m,g,i)){j.push(m);break}k&&(u=w)}c&&((m=!o&&m)&&p--,f&&r.push(m))}if(p+=q,c&&q!==p){n=0;while(o=b[n++])o(r,s,g,i);if(f){if(p>0)while(q--)r[q]||s[q]||(s[q]=E.call(j));s=sb(s)}G.apply(j,s),k&&!f&&s.length>0&&p+b.length>1&&db.uniqueSort(j)}return k&&(u=w,h=t),r};return c?fb(f):f}g=db.compile=function(a,b){var c,d=[],e=[],f=y[a+" "];if(!f){b||(b=ob(a)),c=b.length;while(c--)f=ub(b[c]),f[s]?d.push(f):e.push(f);f=y(a,vb(e,d))}return f};function wb(a,b,c){for(var d=0,e=b.length;e>d;d++)db(a,b[d],c);return c}function xb(a,b,e,f){var h,i,j,k,l,m=ob(a);if(!f&&1===m.length){if(i=m[0]=m[0].slice(0),i.length>2&&"ID"===(j=i[0]).type&&c.getById&&9===b.nodeType&&n&&d.relative[i[1].type]){if(b=(d.find.ID(j.matches[0].replace(ab,bb),b)||[])[0],!b)return e;a=a.slice(i.shift().value.length)}h=V.needsContext.test(a)?0:i.length;while(h--){if(j=i[h],d.relative[k=j.type])break;if((l=d.find[k])&&(f=l(j.matches[0].replace(ab,bb),$.test(i[0].type)&&mb(b.parentNode)||b))){if(i.splice(h,1),a=f.length&&pb(i),!a)return G.apply(e,f),e;break}}}return g(a,m)(f,b,!n,e,$.test(a)&&mb(b.parentNode)||b),e}return c.sortStable=s.split("").sort(z).join("")===s,c.detectDuplicates=!!j,k(),c.sortDetached=gb(function(a){return 1&a.compareDocumentPosition(l.createElement("div"))}),gb(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||hb("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&gb(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||hb("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),gb(function(a){return null==a.getAttribute("disabled")})||hb(J,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),db}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=n.expr.match.needsContext,v=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^.[^:#\[\.,]*$/;function x(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(w.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return n.inArray(a,b)>=0!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=[],d=this,e=d.length;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;e>b;b++)if(n.contains(d[b],this))return!0}));for(b=0;e>b;b++)n.find(a,d[b],c);return c=this.pushStack(e>1?n.unique(c):c),c.selector=this.selector?this.selector+" "+a:a,c},filter:function(a){return this.pushStack(x(this,a||[],!1))},not:function(a){return this.pushStack(x(this,a||[],!0))},is:function(a){return!!x(this,"string"==typeof a&&u.test(a)?n(a):a||[],!1).length}});var y,z=a.document,A=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,B=n.fn.init=function(a,b){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&a.length>=3?[null,a,null]:A.exec(a),!c||!c[1]&&b)return!b||b.jquery?(b||y).find(a):this.constructor(b).find(a);if(c[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(c[1],b&&b.nodeType?b.ownerDocument||b:z,!0)),v.test(c[1])&&n.isPlainObject(b))for(c in b)n.isFunction(this[c])?this[c](b[c]):this.attr(c,b[c]);return this}if(d=z.getElementById(c[2]),d&&d.parentNode){if(d.id!==c[2])return y.find(a);this.length=1,this[0]=d}return this.context=z,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?"undefined"!=typeof y.ready?y.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};B.prototype=n.fn,y=n(z);var C=/^(?:parents|prev(?:Until|All))/,D={children:!0,contents:!0,next:!0,prev:!0};n.extend({dir:function(a,b,c){var d=[],e=a[b];while(e&&9!==e.nodeType&&(void 0===c||1!==e.nodeType||!n(e).is(c)))1===e.nodeType&&d.push(e),e=e[b];return d},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}}),n.fn.extend({has:function(a){var b,c=n(a,this),d=c.length;return this.filter(function(){for(b=0;d>b;b++)if(n.contains(this,c[b]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=u.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.unique(f):f)},index:function(a){return a?"string"==typeof a?n.inArray(this[0],n(a)):n.inArray(a.jquery?a[0]:a,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.unique(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function E(a,b){do a=a[b];while(a&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return n.dir(a,"parentNode")},parentsUntil:function(a,b,c){return n.dir(a,"parentNode",c)},next:function(a){return E(a,"nextSibling")},prev:function(a){return E(a,"previousSibling")},nextAll:function(a){return n.dir(a,"nextSibling")},prevAll:function(a){return n.dir(a,"previousSibling")},nextUntil:function(a,b,c){return n.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return n.dir(a,"previousSibling",c)},siblings:function(a){return n.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return n.sibling(a.firstChild)},contents:function(a){return n.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(D[a]||(e=n.unique(e)),C.test(a)&&(e=e.reverse())),this.pushStack(e)}});var F=/\S+/g,G={};function H(a){var b=G[a]={};return n.each(a.match(F)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?G[a]||H(a):n.extend({},a);var b,c,d,e,f,g,h=[],i=!a.once&&[],j=function(l){for(c=a.memory&&l,d=!0,f=g||0,g=0,e=h.length,b=!0;h&&e>f;f++)if(h[f].apply(l[0],l[1])===!1&&a.stopOnFalse){c=!1;break}b=!1,h&&(i?i.length&&j(i.shift()):c?h=[]:k.disable())},k={add:function(){if(h){var d=h.length;!function f(b){n.each(b,function(b,c){var d=n.type(c);"function"===d?a.unique&&k.has(c)||h.push(c):c&&c.length&&"string"!==d&&f(c)})}(arguments),b?e=h.length:c&&(g=d,j(c))}return this},remove:function(){return h&&n.each(arguments,function(a,c){var d;while((d=n.inArray(c,h,d))>-1)h.splice(d,1),b&&(e>=d&&e--,f>=d&&f--)}),this},has:function(a){return a?n.inArray(a,h)>-1:!(!h||!h.length)},empty:function(){return h=[],e=0,this},disable:function(){return h=i=c=void 0,this},disabled:function(){return!h},lock:function(){return i=void 0,c||k.disable(),this},locked:function(){return!i},fireWith:function(a,c){return!h||d&&!i||(c=c||[],c=[a,c.slice?c.slice():c],b?i.push(c):j(c)),this},fire:function(){return k.fireWith(this,arguments),this},fired:function(){return!!d}};return k},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=d.call(arguments),e=c.length,f=1!==e||a&&n.isFunction(a.promise)?e:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(e){b[a]=this,c[a]=arguments.length>1?d.call(arguments):e,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(e>1)for(i=new Array(e),j=new Array(e),k=new Array(e);e>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().done(h(b,k,c)).fail(g.reject).progress(h(b,j,i)):--f;return f||g.resolveWith(k,c),g.promise()}});var I;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){if(a===!0?!--n.readyWait:!n.isReady){if(!z.body)return setTimeout(n.ready);n.isReady=!0,a!==!0&&--n.readyWait>0||(I.resolveWith(z,[n]),n.fn.trigger&&n(z).trigger("ready").off("ready"))}}});function J(){z.addEventListener?(z.removeEventListener("DOMContentLoaded",K,!1),a.removeEventListener("load",K,!1)):(z.detachEvent("onreadystatechange",K),a.detachEvent("onload",K))}function K(){(z.addEventListener||"load"===event.type||"complete"===z.readyState)&&(J(),n.ready())}n.ready.promise=function(b){if(!I)if(I=n.Deferred(),"complete"===z.readyState)setTimeout(n.ready);else if(z.addEventListener)z.addEventListener("DOMContentLoaded",K,!1),a.addEventListener("load",K,!1);else{z.attachEvent("onreadystatechange",K),a.attachEvent("onload",K);var c=!1;try{c=null==a.frameElement&&z.documentElement}catch(d){}c&&c.doScroll&&!function e(){if(!n.isReady){try{c.doScroll("left")}catch(a){return setTimeout(e,50)}J(),n.ready()}}()}return I.promise(b)};var L="undefined",M;for(M in n(l))break;l.ownLast="0"!==M,l.inlineBlockNeedsLayout=!1,n(function(){var a,b,c=z.getElementsByTagName("body")[0];c&&(a=z.createElement("div"),a.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",b=z.createElement("div"),c.appendChild(a).appendChild(b),typeof b.style.zoom!==L&&(b.style.cssText="border:0;margin:0;width:1px;padding:1px;display:inline;zoom:1",(l.inlineBlockNeedsLayout=3===b.offsetWidth)&&(c.style.zoom=1)),c.removeChild(a),a=b=null)}),function(){var a=z.createElement("div");if(null==l.deleteExpando){l.deleteExpando=!0;try{delete a.test}catch(b){l.deleteExpando=!1}}a=null}(),n.acceptData=function(a){var b=n.noData[(a.nodeName+" ").toLowerCase()],c=+a.nodeType||1;return 1!==c&&9!==c?!1:!b||b!==!0&&a.getAttribute("classid")===b};var N=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function P(a,b,c){if(void 0===c&&1===a.nodeType){var d="data-"+b.replace(O,"-$1").toLowerCase();if(c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?n.parseJSON(c):c}catch(e){}n.data(a,b,c)}else c=void 0}return c}function Q(a){var b;for(b in a)if(("data"!==b||!n.isEmptyObject(a[b]))&&"toJSON"!==b)return!1;return!0}function R(a,b,d,e){if(n.acceptData(a)){var f,g,h=n.expando,i=a.nodeType,j=i?n.cache:a,k=i?a[h]:a[h]&&h;if(k&&j[k]&&(e||j[k].data)||void 0!==d||"string"!=typeof b)return k||(k=i?a[h]=c.pop()||n.guid++:h),j[k]||(j[k]=i?{}:{toJSON:n.noop}),("object"==typeof b||"function"==typeof b)&&(e?j[k]=n.extend(j[k],b):j[k].data=n.extend(j[k].data,b)),g=j[k],e||(g.data||(g.data={}),g=g.data),void 0!==d&&(g[n.camelCase(b)]=d),"string"==typeof b?(f=g[b],null==f&&(f=g[n.camelCase(b)])):f=g,f
}}function S(a,b,c){if(n.acceptData(a)){var d,e,f=a.nodeType,g=f?n.cache:a,h=f?a[n.expando]:n.expando;if(g[h]){if(b&&(d=c?g[h]:g[h].data)){n.isArray(b)?b=b.concat(n.map(b,n.camelCase)):b in d?b=[b]:(b=n.camelCase(b),b=b in d?[b]:b.split(" ")),e=b.length;while(e--)delete d[b[e]];if(c?!Q(d):!n.isEmptyObject(d))return}(c||(delete g[h].data,Q(g[h])))&&(f?n.cleanData([a],!0):l.deleteExpando||g!=g.window?delete g[h]:g[h]=null)}}}n.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(a){return a=a.nodeType?n.cache[a[n.expando]]:a[n.expando],!!a&&!Q(a)},data:function(a,b,c){return R(a,b,c)},removeData:function(a,b){return S(a,b)},_data:function(a,b,c){return R(a,b,c,!0)},_removeData:function(a,b){return S(a,b,!0)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=n.data(f),1===f.nodeType&&!n._data(f,"parsedAttrs"))){c=g.length;while(c--)d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),P(f,d,e[d]));n._data(f,"parsedAttrs",!0)}return e}return"object"==typeof a?this.each(function(){n.data(this,a)}):arguments.length>1?this.each(function(){n.data(this,a,b)}):f?P(f,a,n.data(f,a)):void 0},removeData:function(a){return this.each(function(){n.removeData(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=n._data(a,b),c&&(!d||n.isArray(c)?d=n._data(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return n._data(a,c)||n._data(a,c,{empty:n.Callbacks("once memory").add(function(){n._removeData(a,b+"queue"),n._removeData(a,c)})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=n._data(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var T=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,U=["Top","Right","Bottom","Left"],V=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)},W=n.access=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)n.access(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},X=/^(?:checkbox|radio)$/i;!function(){var a=z.createDocumentFragment(),b=z.createElement("div"),c=z.createElement("input");if(b.setAttribute("className","t"),b.innerHTML="  <link/><table></table><a href='/a'>a</a>",l.leadingWhitespace=3===b.firstChild.nodeType,l.tbody=!b.getElementsByTagName("tbody").length,l.htmlSerialize=!!b.getElementsByTagName("link").length,l.html5Clone="<:nav></:nav>"!==z.createElement("nav").cloneNode(!0).outerHTML,c.type="checkbox",c.checked=!0,a.appendChild(c),l.appendChecked=c.checked,b.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue,a.appendChild(b),b.innerHTML="<input type='radio' checked='checked' name='t'/>",l.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,l.noCloneEvent=!0,b.attachEvent&&(b.attachEvent("onclick",function(){l.noCloneEvent=!1}),b.cloneNode(!0).click()),null==l.deleteExpando){l.deleteExpando=!0;try{delete b.test}catch(d){l.deleteExpando=!1}}a=b=c=null}(),function(){var b,c,d=z.createElement("div");for(b in{submit:!0,change:!0,focusin:!0})c="on"+b,(l[b+"Bubbles"]=c in a)||(d.setAttribute(c,"t"),l[b+"Bubbles"]=d.attributes[c].expando===!1);d=null}();var Y=/^(?:input|select|textarea)$/i,Z=/^key/,$=/^(?:mouse|contextmenu)|click/,_=/^(?:focusinfocus|focusoutblur)$/,ab=/^([^.]*)(?:\.(.+)|)$/;function bb(){return!0}function cb(){return!1}function db(){try{return z.activeElement}catch(a){}}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n._data(a);if(r){c.handler&&(i=c,c=i.handler,e=i.selector),c.guid||(c.guid=n.guid++),(g=r.events)||(g=r.events={}),(k=r.handle)||(k=r.handle=function(a){return typeof n===L||a&&n.event.triggered===a.type?void 0:n.event.dispatch.apply(k.elem,arguments)},k.elem=a),b=(b||"").match(F)||[""],h=b.length;while(h--)f=ab.exec(b[h])||[],o=q=f[1],p=(f[2]||"").split(".").sort(),o&&(j=n.event.special[o]||{},o=(e?j.delegateType:j.bindType)||o,j=n.event.special[o]||{},l=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},i),(m=g[o])||(m=g[o]=[],m.delegateCount=0,j.setup&&j.setup.call(a,d,p,k)!==!1||(a.addEventListener?a.addEventListener(o,k,!1):a.attachEvent&&a.attachEvent("on"+o,k))),j.add&&(j.add.call(a,l),l.handler.guid||(l.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,l):m.push(l),n.event.global[o]=!0);a=null}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n.hasData(a)&&n._data(a);if(r&&(k=r.events)){b=(b||"").match(F)||[""],j=b.length;while(j--)if(h=ab.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=k[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),i=f=m.length;while(f--)g=m[f],!e&&q!==g.origType||c&&c.guid!==g.guid||h&&!h.test(g.namespace)||d&&d!==g.selector&&("**"!==d||!g.selector)||(m.splice(f,1),g.selector&&m.delegateCount--,l.remove&&l.remove.call(a,g));i&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete k[o])}else for(o in k)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(k)&&(delete r.handle,n._removeData(a,"events"))}},trigger:function(b,c,d,e){var f,g,h,i,k,l,m,o=[d||z],p=j.call(b,"type")?b.type:b,q=j.call(b,"namespace")?b.namespace.split("."):[];if(h=l=d=d||z,3!==d.nodeType&&8!==d.nodeType&&!_.test(p+n.event.triggered)&&(p.indexOf(".")>=0&&(q=p.split("."),p=q.shift(),q.sort()),g=p.indexOf(":")<0&&"on"+p,b=b[n.expando]?b:new n.Event(p,"object"==typeof b&&b),b.isTrigger=e?2:3,b.namespace=q.join("."),b.namespace_re=b.namespace?new RegExp("(^|\\.)"+q.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=d),c=null==c?[b]:n.makeArray(c,[b]),k=n.event.special[p]||{},e||!k.trigger||k.trigger.apply(d,c)!==!1)){if(!e&&!k.noBubble&&!n.isWindow(d)){for(i=k.delegateType||p,_.test(i+p)||(h=h.parentNode);h;h=h.parentNode)o.push(h),l=h;l===(d.ownerDocument||z)&&o.push(l.defaultView||l.parentWindow||a)}m=0;while((h=o[m++])&&!b.isPropagationStopped())b.type=m>1?i:k.bindType||p,f=(n._data(h,"events")||{})[b.type]&&n._data(h,"handle"),f&&f.apply(h,c),f=g&&h[g],f&&f.apply&&n.acceptData(h)&&(b.result=f.apply(h,c),b.result===!1&&b.preventDefault());if(b.type=p,!e&&!b.isDefaultPrevented()&&(!k._default||k._default.apply(o.pop(),c)===!1)&&n.acceptData(d)&&g&&d[p]&&!n.isWindow(d)){l=d[g],l&&(d[g]=null),n.event.triggered=p;try{d[p]()}catch(r){}n.event.triggered=void 0,l&&(d[g]=l)}return b.result}},dispatch:function(a){a=n.event.fix(a);var b,c,e,f,g,h=[],i=d.call(arguments),j=(n._data(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,g=0;while((e=f.handlers[g++])&&!a.isImmediatePropagationStopped())(!a.namespace_re||a.namespace_re.test(e.namespace))&&(a.handleObj=e,a.data=e.data,c=((n.event.special[e.origType]||{}).handle||e.handler).apply(f.elem,i),void 0!==c&&(a.result=c)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!=this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(e=[],f=0;h>f;f++)d=b[f],c=d.selector+" ",void 0===e[c]&&(e[c]=d.needsContext?n(c,this).index(i)>=0:n.find(c,this,null,[i]).length),e[c]&&e.push(d);e.length&&g.push({elem:i,handlers:e})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},fix:function(a){if(a[n.expando])return a;var b,c,d,e=a.type,f=a,g=this.fixHooks[e];g||(this.fixHooks[e]=g=$.test(e)?this.mouseHooks:Z.test(e)?this.keyHooks:{}),d=g.props?this.props.concat(g.props):this.props,a=new n.Event(f),b=d.length;while(b--)c=d[b],a[c]=f[c];return a.target||(a.target=f.srcElement||z),3===a.target.nodeType&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,g.filter?g.filter(a,f):a},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,d,e,f=b.button,g=b.fromElement;return null==a.pageX&&null!=b.clientX&&(d=a.target.ownerDocument||z,e=d.documentElement,c=d.body,a.pageX=b.clientX+(e&&e.scrollLeft||c&&c.scrollLeft||0)-(e&&e.clientLeft||c&&c.clientLeft||0),a.pageY=b.clientY+(e&&e.scrollTop||c&&c.scrollTop||0)-(e&&e.clientTop||c&&c.clientTop||0)),!a.relatedTarget&&g&&(a.relatedTarget=g===a.target?b.toElement:g),a.which||void 0===f||(a.which=1&f?1:2&f?3:4&f?2:0),a}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==db()&&this.focus)try{return this.focus(),!1}catch(a){}},delegateType:"focusin"},blur:{trigger:function(){return this===db()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return n.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=n.extend(new n.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?n.event.trigger(e,null,b):n.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},n.removeEvent=z.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){var d="on"+b;a.detachEvent&&(typeof a[d]===L&&(a[d]=null),a.detachEvent(d,c))},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&(a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault())?bb:cb):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={isDefaultPrevented:cb,isPropagationStopped:cb,isImmediatePropagationStopped:cb,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=bb,a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=bb,a&&(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=bb,this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!n.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),l.submitBubbles||(n.event.special.submit={setup:function(){return n.nodeName(this,"form")?!1:void n.event.add(this,"click._submit keypress._submit",function(a){var b=a.target,c=n.nodeName(b,"input")||n.nodeName(b,"button")?b.form:void 0;c&&!n._data(c,"submitBubbles")&&(n.event.add(c,"submit._submit",function(a){a._submit_bubble=!0}),n._data(c,"submitBubbles",!0))})},postDispatch:function(a){a._submit_bubble&&(delete a._submit_bubble,this.parentNode&&!a.isTrigger&&n.event.simulate("submit",this.parentNode,a,!0))},teardown:function(){return n.nodeName(this,"form")?!1:void n.event.remove(this,"._submit")}}),l.changeBubbles||(n.event.special.change={setup:function(){return Y.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(n.event.add(this,"propertychange._change",function(a){"checked"===a.originalEvent.propertyName&&(this._just_changed=!0)}),n.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1),n.event.simulate("change",this,a,!0)})),!1):void n.event.add(this,"beforeactivate._change",function(a){var b=a.target;Y.test(b.nodeName)&&!n._data(b,"changeBubbles")&&(n.event.add(b,"change._change",function(a){!this.parentNode||a.isSimulated||a.isTrigger||n.event.simulate("change",this.parentNode,a,!0)}),n._data(b,"changeBubbles",!0))})},handle:function(a){var b=a.target;return this!==b||a.isSimulated||a.isTrigger||"radio"!==b.type&&"checkbox"!==b.type?a.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return n.event.remove(this,"._change"),!Y.test(this.nodeName)}}),l.focusinBubbles||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a),!0)};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=n._data(d,b);e||d.addEventListener(a,c,!0),n._data(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=n._data(d,b)-1;e?n._data(d,b,e):(d.removeEventListener(a,c,!0),n._removeData(d,b))}}}),n.fn.extend({on:function(a,b,c,d,e){var f,g;if("object"==typeof a){"string"!=typeof b&&(c=c||b,b=void 0);for(f in a)this.on(f,b,c,a[f],e);return this}if(null==c&&null==d?(d=b,c=b=void 0):null==d&&("string"==typeof b?(d=c,c=void 0):(d=c,c=b,b=void 0)),d===!1)d=cb;else if(!d)return this;return 1===e&&(g=d,d=function(a){return n().off(a),g.apply(this,arguments)},d.guid=g.guid||(g.guid=n.guid++)),this.each(function(){n.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=cb),this.each(function(){n.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}});function eb(a){var b=fb.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}var fb="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",gb=/ jQuery\d+="(?:null|\d+)"/g,hb=new RegExp("<(?:"+fb+")[\\s/>]","i"),ib=/^\s+/,jb=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,kb=/<([\w:]+)/,lb=/<tbody/i,mb=/<|&#?\w+;/,nb=/<(?:script|style|link)/i,ob=/checked\s*(?:[^=]|=\s*.checked.)/i,pb=/^$|\/(?:java|ecma)script/i,qb=/^true\/(.*)/,rb=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,sb={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:l.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},tb=eb(z),ub=tb.appendChild(z.createElement("div"));sb.optgroup=sb.option,sb.tbody=sb.tfoot=sb.colgroup=sb.caption=sb.thead,sb.th=sb.td;function vb(a,b){var c,d,e=0,f=typeof a.getElementsByTagName!==L?a.getElementsByTagName(b||"*"):typeof a.querySelectorAll!==L?a.querySelectorAll(b||"*"):void 0;if(!f)for(f=[],c=a.childNodes||a;null!=(d=c[e]);e++)!b||n.nodeName(d,b)?f.push(d):n.merge(f,vb(d,b));return void 0===b||b&&n.nodeName(a,b)?n.merge([a],f):f}function wb(a){X.test(a.type)&&(a.defaultChecked=a.checked)}function xb(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function yb(a){return a.type=(null!==n.find.attr(a,"type"))+"/"+a.type,a}function zb(a){var b=qb.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function Ab(a,b){for(var c,d=0;null!=(c=a[d]);d++)n._data(c,"globalEval",!b||n._data(b[d],"globalEval"))}function Bb(a,b){if(1===b.nodeType&&n.hasData(a)){var c,d,e,f=n._data(a),g=n._data(b,f),h=f.events;if(h){delete g.handle,g.events={};for(c in h)for(d=0,e=h[c].length;e>d;d++)n.event.add(b,c,h[c][d])}g.data&&(g.data=n.extend({},g.data))}}function Cb(a,b){var c,d,e;if(1===b.nodeType){if(c=b.nodeName.toLowerCase(),!l.noCloneEvent&&b[n.expando]){e=n._data(b);for(d in e.events)n.removeEvent(b,d,e.handle);b.removeAttribute(n.expando)}"script"===c&&b.text!==a.text?(yb(b).text=a.text,zb(b)):"object"===c?(b.parentNode&&(b.outerHTML=a.outerHTML),l.html5Clone&&a.innerHTML&&!n.trim(b.innerHTML)&&(b.innerHTML=a.innerHTML)):"input"===c&&X.test(a.type)?(b.defaultChecked=b.checked=a.checked,b.value!==a.value&&(b.value=a.value)):"option"===c?b.defaultSelected=b.selected=a.defaultSelected:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}}n.extend({clone:function(a,b,c){var d,e,f,g,h,i=n.contains(a.ownerDocument,a);if(l.html5Clone||n.isXMLDoc(a)||!hb.test("<"+a.nodeName+">")?f=a.cloneNode(!0):(ub.innerHTML=a.outerHTML,ub.removeChild(f=ub.firstChild)),!(l.noCloneEvent&&l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(d=vb(f),h=vb(a),g=0;null!=(e=h[g]);++g)d[g]&&Cb(e,d[g]);if(b)if(c)for(h=h||vb(a),d=d||vb(f),g=0;null!=(e=h[g]);g++)Bb(e,d[g]);else Bb(a,f);return d=vb(f,"script"),d.length>0&&Ab(d,!i&&vb(a,"script")),d=h=e=null,f},buildFragment:function(a,b,c,d){for(var e,f,g,h,i,j,k,m=a.length,o=eb(b),p=[],q=0;m>q;q++)if(f=a[q],f||0===f)if("object"===n.type(f))n.merge(p,f.nodeType?[f]:f);else if(mb.test(f)){h=h||o.appendChild(b.createElement("div")),i=(kb.exec(f)||["",""])[1].toLowerCase(),k=sb[i]||sb._default,h.innerHTML=k[1]+f.replace(jb,"<$1></$2>")+k[2],e=k[0];while(e--)h=h.lastChild;if(!l.leadingWhitespace&&ib.test(f)&&p.push(b.createTextNode(ib.exec(f)[0])),!l.tbody){f="table"!==i||lb.test(f)?"<table>"!==k[1]||lb.test(f)?0:h:h.firstChild,e=f&&f.childNodes.length;while(e--)n.nodeName(j=f.childNodes[e],"tbody")&&!j.childNodes.length&&f.removeChild(j)}n.merge(p,h.childNodes),h.textContent="";while(h.firstChild)h.removeChild(h.firstChild);h=o.lastChild}else p.push(b.createTextNode(f));h&&o.removeChild(h),l.appendChecked||n.grep(vb(p,"input"),wb),q=0;while(f=p[q++])if((!d||-1===n.inArray(f,d))&&(g=n.contains(f.ownerDocument,f),h=vb(o.appendChild(f),"script"),g&&Ab(h),c)){e=0;while(f=h[e++])pb.test(f.type||"")&&c.push(f)}return h=null,o},cleanData:function(a,b){for(var d,e,f,g,h=0,i=n.expando,j=n.cache,k=l.deleteExpando,m=n.event.special;null!=(d=a[h]);h++)if((b||n.acceptData(d))&&(f=d[i],g=f&&j[f])){if(g.events)for(e in g.events)m[e]?n.event.remove(d,e):n.removeEvent(d,e,g.handle);j[f]&&(delete j[f],k?delete d[i]:typeof d.removeAttribute!==L?d.removeAttribute(i):d[i]=null,c.push(f))}}}),n.fn.extend({text:function(a){return W(this,function(a){return void 0===a?n.text(this):this.empty().append((this[0]&&this[0].ownerDocument||z).createTextNode(a))},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=xb(this,a);b.appendChild(a)}})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=xb(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?n.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||n.cleanData(vb(c)),c.parentNode&&(b&&n.contains(c.ownerDocument,c)&&Ab(vb(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++){1===a.nodeType&&n.cleanData(vb(a,!1));while(a.firstChild)a.removeChild(a.firstChild);a.options&&n.nodeName(a,"select")&&(a.options.length=0)}return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return W(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a)return 1===b.nodeType?b.innerHTML.replace(gb,""):void 0;if(!("string"!=typeof a||nb.test(a)||!l.htmlSerialize&&hb.test(a)||!l.leadingWhitespace&&ib.test(a)||sb[(kb.exec(a)||["",""])[1].toLowerCase()])){a=a.replace(jb,"<$1></$2>");try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(vb(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(b){a=this.parentNode,n.cleanData(vb(this)),a&&a.replaceChild(b,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b){a=e.apply([],a);var c,d,f,g,h,i,j=0,k=this.length,m=this,o=k-1,p=a[0],q=n.isFunction(p);if(q||k>1&&"string"==typeof p&&!l.checkClone&&ob.test(p))return this.each(function(c){var d=m.eq(c);q&&(a[0]=p.call(this,c,d.html())),d.domManip(a,b)});if(k&&(i=n.buildFragment(a,this[0].ownerDocument,!1,this),c=i.firstChild,1===i.childNodes.length&&(i=c),c)){for(g=n.map(vb(i,"script"),yb),f=g.length;k>j;j++)d=i,j!==o&&(d=n.clone(d,!0,!0),f&&n.merge(g,vb(d,"script"))),b.call(this[j],d,j);if(f)for(h=g[g.length-1].ownerDocument,n.map(g,zb),j=0;f>j;j++)d=g[j],pb.test(d.type||"")&&!n._data(d,"globalEval")&&n.contains(h,d)&&(d.src?n._evalUrl&&n._evalUrl(d.src):n.globalEval((d.text||d.textContent||d.innerHTML||"").replace(rb,"")));i=c=null}return this}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=0,e=[],g=n(a),h=g.length-1;h>=d;d++)c=d===h?this:this.clone(!0),n(g[d])[b](c),f.apply(e,c.get());return this.pushStack(e)}});var Db,Eb={};function Fb(b,c){var d=n(c.createElement(b)).appendTo(c.body),e=a.getDefaultComputedStyle?a.getDefaultComputedStyle(d[0]).display:n.css(d[0],"display");return d.detach(),e}function Gb(a){var b=z,c=Eb[a];return c||(c=Fb(a,b),"none"!==c&&c||(Db=(Db||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=(Db[0].contentWindow||Db[0].contentDocument).document,b.write(),b.close(),c=Fb(a,b),Db.detach()),Eb[a]=c),c}!function(){var a,b,c=z.createElement("div"),d="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;padding:0;margin:0;border:0";c.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=c.getElementsByTagName("a")[0],a.style.cssText="float:left;opacity:.5",l.opacity=/^0.5/.test(a.style.opacity),l.cssFloat=!!a.style.cssFloat,c.style.backgroundClip="content-box",c.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===c.style.backgroundClip,a=c=null,l.shrinkWrapBlocks=function(){var a,c,e,f;if(null==b){if(a=z.getElementsByTagName("body")[0],!a)return;f="border:0;width:0;height:0;position:absolute;top:0;left:-9999px",c=z.createElement("div"),e=z.createElement("div"),a.appendChild(c).appendChild(e),b=!1,typeof e.style.zoom!==L&&(e.style.cssText=d+";width:1px;padding:1px;zoom:1",e.innerHTML="<div></div>",e.firstChild.style.width="5px",b=3!==e.offsetWidth),a.removeChild(c),a=c=e=null}return b}}();var Hb=/^margin/,Ib=new RegExp("^("+T+")(?!px)[a-z%]+$","i"),Jb,Kb,Lb=/^(top|right|bottom|left)$/;a.getComputedStyle?(Jb=function(a){return a.ownerDocument.defaultView.getComputedStyle(a,null)},Kb=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Jb(a),g=c?c.getPropertyValue(b)||c[b]:void 0,c&&(""!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),Ib.test(g)&&Hb.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0===g?g:g+""}):z.documentElement.currentStyle&&(Jb=function(a){return a.currentStyle},Kb=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Jb(a),g=c?c[b]:void 0,null==g&&h&&h[b]&&(g=h[b]),Ib.test(g)&&!Lb.test(b)&&(d=h.left,e=a.runtimeStyle,f=e&&e.left,f&&(e.left=a.currentStyle.left),h.left="fontSize"===b?"1em":g,g=h.pixelLeft+"px",h.left=d,f&&(e.left=f)),void 0===g?g:g+""||"auto"});function Mb(a,b){return{get:function(){var c=a();if(null!=c)return c?void delete this.get:(this.get=b).apply(this,arguments)}}}!function(){var b,c,d,e,f,g,h=z.createElement("div"),i="border:0;width:0;height:0;position:absolute;top:0;left:-9999px",j="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;padding:0;margin:0;border:0";h.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",b=h.getElementsByTagName("a")[0],b.style.cssText="float:left;opacity:.5",l.opacity=/^0.5/.test(b.style.opacity),l.cssFloat=!!b.style.cssFloat,h.style.backgroundClip="content-box",h.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===h.style.backgroundClip,b=h=null,n.extend(l,{reliableHiddenOffsets:function(){if(null!=c)return c;var a,b,d,e=z.createElement("div"),f=z.getElementsByTagName("body")[0];if(f)return e.setAttribute("className","t"),e.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=z.createElement("div"),a.style.cssText=i,f.appendChild(a).appendChild(e),e.innerHTML="<table><tr><td></td><td>t</td></tr></table>",b=e.getElementsByTagName("td"),b[0].style.cssText="padding:0;margin:0;border:0;display:none",d=0===b[0].offsetHeight,b[0].style.display="",b[1].style.display="none",c=d&&0===b[0].offsetHeight,f.removeChild(a),e=f=null,c},boxSizing:function(){return null==d&&k(),d},boxSizingReliable:function(){return null==e&&k(),e},pixelPosition:function(){return null==f&&k(),f},reliableMarginRight:function(){var b,c,d,e;if(null==g&&a.getComputedStyle){if(b=z.getElementsByTagName("body")[0],!b)return;c=z.createElement("div"),d=z.createElement("div"),c.style.cssText=i,b.appendChild(c).appendChild(d),e=d.appendChild(z.createElement("div")),e.style.cssText=d.style.cssText=j,e.style.marginRight=e.style.width="0",d.style.width="1px",g=!parseFloat((a.getComputedStyle(e,null)||{}).marginRight),b.removeChild(c)}return g}});function k(){var b,c,h=z.getElementsByTagName("body")[0];h&&(b=z.createElement("div"),c=z.createElement("div"),b.style.cssText=i,h.appendChild(b).appendChild(c),c.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:absolute;display:block;padding:1px;border:1px;width:4px;margin-top:1%;top:1%",n.swap(h,null!=h.style.zoom?{zoom:1}:{},function(){d=4===c.offsetWidth}),e=!0,f=!1,g=!0,a.getComputedStyle&&(f="1%"!==(a.getComputedStyle(c,null)||{}).top,e="4px"===(a.getComputedStyle(c,null)||{width:"4px"}).width),h.removeChild(b),c=h=null)}}(),n.swap=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};var Nb=/alpha\([^)]*\)/i,Ob=/opacity\s*=\s*([^)]*)/,Pb=/^(none|table(?!-c[ea]).+)/,Qb=new RegExp("^("+T+")(.*)$","i"),Rb=new RegExp("^([+-])=("+T+")","i"),Sb={position:"absolute",visibility:"hidden",display:"block"},Tb={letterSpacing:0,fontWeight:400},Ub=["Webkit","O","Moz","ms"];function Vb(a,b){if(b in a)return b;var c=b.charAt(0).toUpperCase()+b.slice(1),d=b,e=Ub.length;while(e--)if(b=Ub[e]+c,b in a)return b;return d}function Wb(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=n._data(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&V(d)&&(f[g]=n._data(d,"olddisplay",Gb(d.nodeName)))):f[g]||(e=V(d),(c&&"none"!==c||!e)&&n._data(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}function Xb(a,b,c){var d=Qb.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function Yb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+U[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+U[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+U[f]+"Width",!0,e))):(g+=n.css(a,"padding"+U[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+U[f]+"Width",!0,e)));return g}function Zb(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=Jb(a),g=l.boxSizing()&&"border-box"===n.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=Kb(a,b,f),(0>e||null==e)&&(e=a.style[b]),Ib.test(e))return e;d=g&&(l.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+Yb(a,b,c||(g?"border":"content"),d,f)+"px"}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Kb(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":l.cssFloat?"cssFloat":"styleFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;if(b=n.cssProps[h]||(n.cssProps[h]=Vb(i,h)),g=n.cssHooks[b]||n.cssHooks[h],void 0===c)return g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b];if(f=typeof c,"string"===f&&(e=Rb.exec(c))&&(c=(e[1]+1)*e[2]+parseFloat(n.css(a,b)),f="number"),null!=c&&c===c&&("number"!==f||n.cssNumber[h]||(c+="px"),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),!(g&&"set"in g&&void 0===(c=g.set(a,c,d)))))try{i[b]="",i[b]=c}catch(j){}}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=Vb(a.style,h)),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(f=g.get(a,!0,c)),void 0===f&&(f=Kb(a,b,d)),"normal"===f&&b in Tb&&(f=Tb[b]),""===c||c?(e=parseFloat(f),c===!0||n.isNumeric(e)?e||0:f):f}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?0===a.offsetWidth&&Pb.test(n.css(a,"display"))?n.swap(a,Sb,function(){return Zb(a,b,d)}):Zb(a,b,d):void 0},set:function(a,c,d){var e=d&&Jb(a);return Xb(a,c,d?Yb(a,b,d,l.boxSizing()&&"border-box"===n.css(a,"boxSizing",!1,e),e):0)}}}),l.opacity||(n.cssHooks.opacity={get:function(a,b){return Ob.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=n.isNumeric(b)?"alpha(opacity="+100*b+")":"",f=d&&d.filter||c.filter||"";c.zoom=1,(b>=1||""===b)&&""===n.trim(f.replace(Nb,""))&&c.removeAttribute&&(c.removeAttribute("filter"),""===b||d&&!d.filter)||(c.filter=Nb.test(f)?f.replace(Nb,e):f+" "+e)}}),n.cssHooks.marginRight=Mb(l.reliableMarginRight,function(a,b){return b?n.swap(a,{display:"inline-block"},Kb,[a,"marginRight"]):void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+U[d]+b]=f[d]||f[d-2]||f[0];return e}},Hb.test(a)||(n.cssHooks[a+b].set=Xb)}),n.fn.extend({css:function(a,b){return W(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=Jb(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)
},a,b,arguments.length>1)},show:function(){return Wb(this,!0)},hide:function(){return Wb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){V(this)?n(this).show():n(this).hide()})}});function $b(a,b,c,d,e){return new $b.prototype.init(a,b,c,d,e)}n.Tween=$b,$b.prototype={constructor:$b,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=$b.propHooks[this.prop];return a&&a.get?a.get(this):$b.propHooks._default.get(this)},run:function(a){var b,c=$b.propHooks[this.prop];return this.pos=b=this.options.duration?n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):$b.propHooks._default.set(this),this}},$b.prototype.init.prototype=$b.prototype,$b.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[n.cssProps[a.prop]]||n.cssHooks[a.prop])?n.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},$b.propHooks.scrollTop=$b.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},n.fx=$b.prototype.init,n.fx.step={};var _b,ac,bc=/^(?:toggle|show|hide)$/,cc=new RegExp("^(?:([+-])=|)("+T+")([a-z%]*)$","i"),dc=/queueHooks$/,ec=[jc],fc={"*":[function(a,b){var c=this.createTween(a,b),d=c.cur(),e=cc.exec(b),f=e&&e[3]||(n.cssNumber[a]?"":"px"),g=(n.cssNumber[a]||"px"!==f&&+d)&&cc.exec(n.css(c.elem,a)),h=1,i=20;if(g&&g[3]!==f){f=f||g[3],e=e||[],g=+d||1;do h=h||".5",g/=h,n.style(c.elem,a,g+f);while(h!==(h=c.cur()/d)&&1!==h&&--i)}return e&&(g=c.start=+g||+d||0,c.unit=f,c.end=e[1]?g+(e[1]+1)*e[2]:+e[2]),c}]};function gc(){return setTimeout(function(){_b=void 0}),_b=n.now()}function hc(a,b){var c,d={height:a},e=0;for(b=b?1:0;4>e;e+=2-b)c=U[e],d["margin"+c]=d["padding"+c]=a;return b&&(d.opacity=d.width=a),d}function ic(a,b,c){for(var d,e=(fc[b]||[]).concat(fc["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function jc(a,b,c){var d,e,f,g,h,i,j,k,m=this,o={},p=a.style,q=a.nodeType&&V(a),r=n._data(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,m.always(function(){m.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[p.overflow,p.overflowX,p.overflowY],j=n.css(a,"display"),k=Gb(a.nodeName),"none"===j&&(j=k),"inline"===j&&"none"===n.css(a,"float")&&(l.inlineBlockNeedsLayout&&"inline"!==k?p.zoom=1:p.display="inline-block")),c.overflow&&(p.overflow="hidden",l.shrinkWrapBlocks()||m.always(function(){p.overflow=c.overflow[0],p.overflowX=c.overflow[1],p.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],bc.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(q?"hide":"show")){if("show"!==e||!r||void 0===r[d])continue;q=!0}o[d]=r&&r[d]||n.style(a,d)}if(!n.isEmptyObject(o)){r?"hidden"in r&&(q=r.hidden):r=n._data(a,"fxshow",{}),f&&(r.hidden=!q),q?n(a).show():m.done(function(){n(a).hide()}),m.done(function(){var b;n._removeData(a,"fxshow");for(b in o)n.style(a,b,o[b])});for(d in o)g=ic(q?r[d]:0,d,m),d in r||(r[d]=g.start,q&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function kc(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function lc(a,b,c){var d,e,f=0,g=ec.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=_b||gc(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:_b||gc(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;for(kc(k,j.opts.specialEasing);g>f;f++)if(d=ec[f].call(j,a,k,j.opts))return d;return n.map(k,ic,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(lc,{tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],fc[c]=fc[c]||[],fc[c].unshift(b)},prefilter:function(a,b){b?ec.unshift(a):ec.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(V).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=lc(this,n.extend({},a),f);(e||n._data(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=n._data(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&dc.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=n._data(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(hc(b,!0),a,d,e)}}),n.each({slideDown:hc("show"),slideUp:hc("hide"),slideToggle:hc("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=n.timers,c=0;for(_b=n.now();c<b.length;c++)a=b[c],a()||b[c]!==a||b.splice(c--,1);b.length||n.fx.stop(),_b=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){ac||(ac=setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){clearInterval(ac),ac=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(a,b){return a=n.fx?n.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},function(){var a,b,c,d,e=z.createElement("div");e.setAttribute("className","t"),e.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=e.getElementsByTagName("a")[0],c=z.createElement("select"),d=c.appendChild(z.createElement("option")),b=e.getElementsByTagName("input")[0],a.style.cssText="top:1px",l.getSetAttribute="t"!==e.className,l.style=/top/.test(a.getAttribute("style")),l.hrefNormalized="/a"===a.getAttribute("href"),l.checkOn=!!b.value,l.optSelected=d.selected,l.enctype=!!z.createElement("form").enctype,c.disabled=!0,l.optDisabled=!d.disabled,b=z.createElement("input"),b.setAttribute("value",""),l.input=""===b.getAttribute("value"),b.value="t",b.setAttribute("type","radio"),l.radioValue="t"===b.value,a=b=c=d=e=null}();var mc=/\r/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(mc,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){var b=n.find.attr(a,"value");return null!=b?b:n.text(a)}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(l.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)if(d=e[g],n.inArray(n.valHooks.option.get(d),f)>=0)try{d.selected=c=!0}catch(h){d.scrollHeight}else d.selected=!1;return c||(a.selectedIndex=-1),e}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>=0:void 0}},l.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var nc,oc,pc=n.expr.attrHandle,qc=/^(?:checked|selected)$/i,rc=l.getSetAttribute,sc=l.input;n.fn.extend({attr:function(a,b){return W(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(a&&3!==f&&8!==f&&2!==f)return typeof a.getAttribute===L?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),d=n.attrHooks[b]||(n.expr.match.bool.test(b)?oc:nc)),void 0===c?d&&"get"in d&&null!==(e=d.get(a,b))?e:(e=n.find.attr(a,b),null==e?void 0:e):null!==c?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+""),c):void n.removeAttr(a,b))},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(F);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)?sc&&rc||!qc.test(c)?a[d]=!1:a[n.camelCase("default-"+c)]=a[d]=!1:n.attr(a,c,""),a.removeAttribute(rc?c:d)},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}}}),oc={set:function(a,b,c){return b===!1?n.removeAttr(a,c):sc&&rc||!qc.test(c)?a.setAttribute(!rc&&n.propFix[c]||c,c):a[n.camelCase("default-"+c)]=a[c]=!0,c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=pc[b]||n.find.attr;pc[b]=sc&&rc||!qc.test(b)?function(a,b,d){var e,f;return d||(f=pc[b],pc[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,pc[b]=f),e}:function(a,b,c){return c?void 0:a[n.camelCase("default-"+b)]?b.toLowerCase():null}}),sc&&rc||(n.attrHooks.value={set:function(a,b,c){return n.nodeName(a,"input")?void(a.defaultValue=b):nc&&nc.set(a,b,c)}}),rc||(nc={set:function(a,b,c){var d=a.getAttributeNode(c);return d||a.setAttributeNode(d=a.ownerDocument.createAttribute(c)),d.value=b+="","value"===c||b===a.getAttribute(c)?b:void 0}},pc.id=pc.name=pc.coords=function(a,b,c){var d;return c?void 0:(d=a.getAttributeNode(b))&&""!==d.value?d.value:null},n.valHooks.button={get:function(a,b){var c=a.getAttributeNode(b);return c&&c.specified?c.value:void 0},set:nc.set},n.attrHooks.contenteditable={set:function(a,b,c){nc.set(a,""===b?!1:b,c)}},n.each(["width","height"],function(a,b){n.attrHooks[b]={set:function(a,c){return""===c?(a.setAttribute(b,"auto"),c):void 0}}})),l.style||(n.attrHooks.style={get:function(a){return a.style.cssText||void 0},set:function(a,b){return a.style.cssText=b+""}});var tc=/^(?:input|select|textarea|button|object)$/i,uc=/^(?:a|area)$/i;n.fn.extend({prop:function(a,b){return W(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return a=n.propFix[a]||a,this.each(function(){try{this[a]=void 0,delete this[a]}catch(b){}})}}),n.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,b,c){var d,e,f,g=a.nodeType;if(a&&3!==g&&8!==g&&2!==g)return f=1!==g||!n.isXMLDoc(a),f&&(b=n.propFix[b]||b,e=n.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=n.find.attr(a,"tabindex");return b?parseInt(b,10):tc.test(a.nodeName)||uc.test(a.nodeName)&&a.href?0:-1}}}}),l.hrefNormalized||n.each(["href","src"],function(a,b){n.propHooks[b]={get:function(a){return a.getAttribute(b,4)}}}),l.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex),null}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this}),l.enctype||(n.propFix.enctype="encoding");var vc=/[\t\r\n\f]/g;n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h=0,i=this.length,j="string"==typeof a&&a;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,this.className))});if(j)for(b=(a||"").match(F)||[];i>h;h++)if(c=this[h],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(vc," "):" ")){f=0;while(e=b[f++])d.indexOf(" "+e+" ")<0&&(d+=e+" ");g=n.trim(d),c.className!==g&&(c.className=g)}return this},removeClass:function(a){var b,c,d,e,f,g,h=0,i=this.length,j=0===arguments.length||"string"==typeof a&&a;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,this.className))});if(j)for(b=(a||"").match(F)||[];i>h;h++)if(c=this[h],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(vc," "):"")){f=0;while(e=b[f++])while(d.indexOf(" "+e+" ")>=0)d=d.replace(" "+e+" "," ");g=a?n.trim(d):"",c.className!==g&&(c.className=g)}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):this.each(n.isFunction(a)?function(c){n(this).toggleClass(a.call(this,c,this.className,b),b)}:function(){if("string"===c){var b,d=0,e=n(this),f=a.match(F)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(c===L||"boolean"===c)&&(this.className&&n._data(this,"__className__",this.className),this.className=this.className||a===!1?"":n._data(this,"__className__")||"")})},hasClass:function(a){for(var b=" "+a+" ",c=0,d=this.length;d>c;c++)if(1===this[c].nodeType&&(" "+this[c].className+" ").replace(vc," ").indexOf(b)>=0)return!0;return!1}}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var wc=n.now(),xc=/\?/,yc=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;n.parseJSON=function(b){if(a.JSON&&a.JSON.parse)return a.JSON.parse(b+"");var c,d=null,e=n.trim(b+"");return e&&!n.trim(e.replace(yc,function(a,b,e,f){return c&&b&&(d=0),0===d?a:(c=e||b,d+=!f-!e,"")}))?Function("return "+e)():n.error("Invalid JSON: "+b)},n.parseXML=function(b){var c,d;if(!b||"string"!=typeof b)return null;try{a.DOMParser?(d=new DOMParser,c=d.parseFromString(b,"text/xml")):(c=new ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(b))}catch(e){c=void 0}return c&&c.documentElement&&!c.getElementsByTagName("parsererror").length||n.error("Invalid XML: "+b),c};var zc,Ac,Bc=/#.*$/,Cc=/([?&])_=[^&]*/,Dc=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Ec=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Fc=/^(?:GET|HEAD)$/,Gc=/^\/\//,Hc=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,Ic={},Jc={},Kc="*/".concat("*");try{Ac=location.href}catch(Lc){Ac=z.createElement("a"),Ac.href="",Ac=Ac.href}zc=Hc.exec(Ac.toLowerCase())||[];function Mc(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(F)||[];if(n.isFunction(c))while(d=f[e++])"+"===d.charAt(0)?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Nc(a,b,c,d){var e={},f=a===Jc;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function Oc(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(d in b)void 0!==b[d]&&((e[d]?a:c||(c={}))[d]=b[d]);return c&&n.extend(!0,a,c),a}function Pc(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===e&&(e=a.mimeType||b.getResponseHeader("Content-Type"));if(e)for(g in h)if(h[g]&&h[g].test(e)){i.unshift(g);break}if(i[0]in c)f=i[0];else{for(g in c){if(!i[0]||a.converters[g+" "+i[0]]){f=g;break}d||(d=g)}f=f||d}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function Qc(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Ac,type:"GET",isLocal:Ec.test(zc[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Kc,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Oc(Oc(a,n.ajaxSettings),b):Oc(n.ajaxSettings,a)},ajaxPrefilter:Mc(Ic),ajaxTransport:Mc(Jc),ajax:function(a,b){"object"==typeof a&&(b=a,a=void 0),b=b||{};var c,d,e,f,g,h,i,j,k=n.ajaxSetup({},b),l=k.context||k,m=k.context&&(l.nodeType||l.jquery)?n(l):n.event,o=n.Deferred(),p=n.Callbacks("once memory"),q=k.statusCode||{},r={},s={},t=0,u="canceled",v={readyState:0,getResponseHeader:function(a){var b;if(2===t){if(!j){j={};while(b=Dc.exec(f))j[b[1].toLowerCase()]=b[2]}b=j[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===t?f:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return t||(a=s[c]=s[c]||a,r[a]=b),this},overrideMimeType:function(a){return t||(k.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>t)for(b in a)q[b]=[q[b],a[b]];else v.always(a[v.status]);return this},abort:function(a){var b=a||u;return i&&i.abort(b),x(0,b),this}};if(o.promise(v).complete=p.add,v.success=v.done,v.error=v.fail,k.url=((a||k.url||Ac)+"").replace(Bc,"").replace(Gc,zc[1]+"//"),k.type=b.method||b.type||k.method||k.type,k.dataTypes=n.trim(k.dataType||"*").toLowerCase().match(F)||[""],null==k.crossDomain&&(c=Hc.exec(k.url.toLowerCase()),k.crossDomain=!(!c||c[1]===zc[1]&&c[2]===zc[2]&&(c[3]||("http:"===c[1]?"80":"443"))===(zc[3]||("http:"===zc[1]?"80":"443")))),k.data&&k.processData&&"string"!=typeof k.data&&(k.data=n.param(k.data,k.traditional)),Nc(Ic,k,b,v),2===t)return v;h=k.global,h&&0===n.active++&&n.event.trigger("ajaxStart"),k.type=k.type.toUpperCase(),k.hasContent=!Fc.test(k.type),e=k.url,k.hasContent||(k.data&&(e=k.url+=(xc.test(e)?"&":"?")+k.data,delete k.data),k.cache===!1&&(k.url=Cc.test(e)?e.replace(Cc,"$1_="+wc++):e+(xc.test(e)?"&":"?")+"_="+wc++)),k.ifModified&&(n.lastModified[e]&&v.setRequestHeader("If-Modified-Since",n.lastModified[e]),n.etag[e]&&v.setRequestHeader("If-None-Match",n.etag[e])),(k.data&&k.hasContent&&k.contentType!==!1||b.contentType)&&v.setRequestHeader("Content-Type",k.contentType),v.setRequestHeader("Accept",k.dataTypes[0]&&k.accepts[k.dataTypes[0]]?k.accepts[k.dataTypes[0]]+("*"!==k.dataTypes[0]?", "+Kc+"; q=0.01":""):k.accepts["*"]);for(d in k.headers)v.setRequestHeader(d,k.headers[d]);if(k.beforeSend&&(k.beforeSend.call(l,v,k)===!1||2===t))return v.abort();u="abort";for(d in{success:1,error:1,complete:1})v[d](k[d]);if(i=Nc(Jc,k,b,v)){v.readyState=1,h&&m.trigger("ajaxSend",[v,k]),k.async&&k.timeout>0&&(g=setTimeout(function(){v.abort("timeout")},k.timeout));try{t=1,i.send(r,x)}catch(w){if(!(2>t))throw w;x(-1,w)}}else x(-1,"No Transport");function x(a,b,c,d){var j,r,s,u,w,x=b;2!==t&&(t=2,g&&clearTimeout(g),i=void 0,f=d||"",v.readyState=a>0?4:0,j=a>=200&&300>a||304===a,c&&(u=Pc(k,v,c)),u=Qc(k,u,v,j),j?(k.ifModified&&(w=v.getResponseHeader("Last-Modified"),w&&(n.lastModified[e]=w),w=v.getResponseHeader("etag"),w&&(n.etag[e]=w)),204===a||"HEAD"===k.type?x="nocontent":304===a?x="notmodified":(x=u.state,r=u.data,s=u.error,j=!s)):(s=x,(a||!x)&&(x="error",0>a&&(a=0))),v.status=a,v.statusText=(b||x)+"",j?o.resolveWith(l,[r,x,v]):o.rejectWith(l,[v,x,s]),v.statusCode(q),q=void 0,h&&m.trigger(j?"ajaxSuccess":"ajaxError",[v,k,j?r:s]),p.fireWith(l,[v,x]),h&&(m.trigger("ajaxComplete",[v,k]),--n.active||n.event.trigger("ajaxStop")))}return v},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax({url:a,type:b,dataType:e,data:c,success:d})}}),n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){if(n.isFunction(a))return this.each(function(b){n(this).wrapAll(a.call(this,b))});if(this[0]){var b=n(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&1===a.firstChild.nodeType)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){return this.each(n.isFunction(a)?function(b){n(this).wrapInner(a.call(this,b))}:function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}}),n.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0||!l.reliableHiddenOffsets()&&"none"===(a.style&&a.style.display||n.css(a,"display"))},n.expr.filters.visible=function(a){return!n.expr.filters.hidden(a)};var Rc=/%20/g,Sc=/\[\]$/,Tc=/\r?\n/g,Uc=/^(?:submit|button|image|reset|file)$/i,Vc=/^(?:input|select|textarea|keygen)/i;function Wc(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||Sc.test(a)?d(a,e):Wc(a+"["+("object"==typeof e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)Wc(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)Wc(c,a[c],b,e);return d.join("&").replace(Rc,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&Vc.test(this.nodeName)&&!Uc.test(a)&&(this.checked||!X.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(Tc,"\r\n")}}):{name:b.name,value:c.replace(Tc,"\r\n")}}).get()}}),n.ajaxSettings.xhr=void 0!==a.ActiveXObject?function(){return!this.isLocal&&/^(get|post|head|put|delete|options)$/i.test(this.type)&&$c()||_c()}:$c;var Xc=0,Yc={},Zc=n.ajaxSettings.xhr();a.ActiveXObject&&n(a).on("unload",function(){for(var a in Yc)Yc[a](void 0,!0)}),l.cors=!!Zc&&"withCredentials"in Zc,Zc=l.ajax=!!Zc,Zc&&n.ajaxTransport(function(a){if(!a.crossDomain||l.cors){var b;return{send:function(c,d){var e,f=a.xhr(),g=++Xc;if(f.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-Requested-With"]||(c["X-Requested-With"]="XMLHttpRequest");for(e in c)void 0!==c[e]&&f.setRequestHeader(e,c[e]+"");f.send(a.hasContent&&a.data||null),b=function(c,e){var h,i,j;if(b&&(e||4===f.readyState))if(delete Yc[g],b=void 0,f.onreadystatechange=n.noop,e)4!==f.readyState&&f.abort();else{j={},h=f.status,"string"==typeof f.responseText&&(j.text=f.responseText);try{i=f.statusText}catch(k){i=""}h||!a.isLocal||a.crossDomain?1223===h&&(h=204):h=j.text?200:404}j&&d(h,i,j,f.getAllResponseHeaders())},a.async?4===f.readyState?setTimeout(b):f.onreadystatechange=Yc[g]=b:b()},abort:function(){b&&b(void 0,!0)}}}});function $c(){try{return new a.XMLHttpRequest}catch(b){}}function _c(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c=z.head||n("head")[0]||z.documentElement;return{send:function(d,e){b=z.createElement("script"),b.async=!0,a.scriptCharset&&(b.charset=a.scriptCharset),b.src=a.url,b.onload=b.onreadystatechange=function(a,c){(c||!b.readyState||/loaded|complete/.test(b.readyState))&&(b.onload=b.onreadystatechange=null,b.parentNode&&b.parentNode.removeChild(b),b=null,c||e(200,"success"))},c.insertBefore(b,c.firstChild)},abort:function(){b&&b.onload(void 0,!0)}}}});var ad=[],bd=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=ad.pop()||n.expando+"_"+wc++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(bd.test(b.url)?"url":"string"==typeof b.data&&!(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&bd.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(bd,"$1"+e):b.jsonp!==!1&&(b.url+=(xc.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,ad.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||z;var d=v.exec(a),e=!c&&[];return d?[b.createElement(d[1])]:(d=n.buildFragment([a],b,e),e&&e.length&&n(e).remove(),n.merge([],d.childNodes))};var cd=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&cd)return cd.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>=0&&(d=a.slice(h,a.length),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(f="POST"),g.length>0&&n.ajax({url:a,type:f,dataType:"html",data:b}).done(function(a){e=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).complete(c&&function(a,b){g.each(c,e||[a.responseText,b,a])}),this},n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};var dd=a.document.documentElement;function ed(a){return n.isWindow(a)?a:9===a.nodeType?a.defaultView||a.parentWindow:!1}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&n.inArray("auto",[f,i])>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,h)),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d={top:0,left:0},e=this[0],f=e&&e.ownerDocument;if(f)return b=f.documentElement,n.contains(b,e)?(typeof e.getBoundingClientRect!==L&&(d=e.getBoundingClientRect()),c=ed(f),{top:d.top+(c.pageYOffset||b.scrollTop)-(b.clientTop||0),left:d.left+(c.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}):d},position:function(){if(this[0]){var a,b,c={top:0,left:0},d=this[0];return"fixed"===n.css(d,"position")?b=d.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(c=a.offset()),c.top+=n.css(a[0],"borderTopWidth",!0),c.left+=n.css(a[0],"borderLeftWidth",!0)),{top:b.top-c.top-n.css(d,"marginTop",!0),left:b.left-c.left-n.css(d,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||dd;while(a&&!n.nodeName(a,"html")&&"static"===n.css(a,"position"))a=a.offsetParent;return a||dd})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c=/Y/.test(b);n.fn[a]=function(d){return W(this,function(a,d,e){var f=ed(a);return void 0===e?f?b in f?f[b]:f.document.documentElement[d]:a[d]:void(f?f.scrollTo(c?n(f).scrollLeft():e,c?e:n(f).scrollTop()):a[d]=e)},a,d,arguments.length,null)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=Mb(l.pixelPosition,function(a,c){return c?(c=Kb(a,b),Ib.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return W(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.size=function(){return this.length},n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var fd=a.jQuery,gd=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=gd),b&&a.jQuery===n&&(a.jQuery=fd),n},typeof b===L&&(a.jQuery=a.$=n),n});
//# sourceMappingURL=jquery.min.map;
//     Backbone.js 1.0.0

//     (c) 2010-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

(function(){

  // Initial Setup
  // -------------

  // Save a reference to the global object (`window` in the browser, `exports`
  // on the server).
  var root = this;

  // Save the previous value of the `Backbone` variable, so that it can be
  // restored later on, if `noConflict` is used.
  var previousBackbone = root.Backbone;

  // Create local references to array methods we'll want to use later.
  var array = [];
  var push = array.push;
  var slice = array.slice;
  var splice = array.splice;

  // The top-level namespace. All public Backbone classes and modules will
  // be attached to this. Exported for both the browser and the server.
  var Backbone;
  if (typeof exports !== 'undefined') {
    Backbone = exports;
  } else {
    Backbone = root.Backbone = {};
  }

  // Current version of the library. Keep in sync with `package.json`.
  Backbone.VERSION = '1.0.0';

  // Require Underscore, if we're on the server, and it's not already present.
  var _ = root._;
  if (!_ && (typeof require !== 'undefined')) _ = require('underscore');

  // For Backbone's purposes, jQuery, Zepto, Ender, or My Library (kidding) owns
  // the `$` variable.
  Backbone.$ = root.jQuery || root.Zepto || root.ender || root.$;

  // Runs Backbone.js in *noConflict* mode, returning the `Backbone` variable
  // to its previous owner. Returns a reference to this Backbone object.
  Backbone.noConflict = function() {
    root.Backbone = previousBackbone;
    return this;
  };

  // Turn on `emulateHTTP` to support legacy HTTP servers. Setting this option
  // will fake `"PUT"` and `"DELETE"` requests via the `_method` parameter and
  // set a `X-Http-Method-Override` header.
  Backbone.emulateHTTP = false;

  // Turn on `emulateJSON` to support legacy servers that can't deal with direct
  // `application/json` requests ... will encode the body as
  // `application/x-www-form-urlencoded` instead and will send the model in a
  // form param named `model`.
  Backbone.emulateJSON = false;

  // Backbone.Events
  // ---------------

  // A module that can be mixed in to *any object* in order to provide it with
  // custom events. You may bind with `on` or remove with `off` callback
  // functions to an event; `trigger`-ing an event fires all callbacks in
  // succession.
  //
  //     var object = {};
  //     _.extend(object, Backbone.Events);
  //     object.on('expand', function(){ alert('expanded'); });
  //     object.trigger('expand');
  //
  var Events = Backbone.Events = {

    // Bind an event to a `callback` function. Passing `"all"` will bind
    // the callback to all events fired.
    on: function(name, callback, context) {
      if (!eventsApi(this, 'on', name, [callback, context]) || !callback) return this;
      this._events || (this._events = {});
      var events = this._events[name] || (this._events[name] = []);
      events.push({callback: callback, context: context, ctx: context || this});
      return this;
    },

    // Bind an event to only be triggered a single time. After the first time
    // the callback is invoked, it will be removed.
    once: function(name, callback, context) {
      if (!eventsApi(this, 'once', name, [callback, context]) || !callback) return this;
      var self = this;
      var once = _.once(function() {
        self.off(name, once);
        callback.apply(this, arguments);
      });
      once._callback = callback;
      return this.on(name, once, context);
    },

    // Remove one or many callbacks. If `context` is null, removes all
    // callbacks with that function. If `callback` is null, removes all
    // callbacks for the event. If `name` is null, removes all bound
    // callbacks for all events.
    off: function(name, callback, context) {
      var retain, ev, events, names, i, l, j, k;
      if (!this._events || !eventsApi(this, 'off', name, [callback, context])) return this;
      if (!name && !callback && !context) {
        this._events = {};
        return this;
      }

      names = name ? [name] : _.keys(this._events);
      for (i = 0, l = names.length; i < l; i++) {
        name = names[i];
        if (events = this._events[name]) {
          this._events[name] = retain = [];
          if (callback || context) {
            for (j = 0, k = events.length; j < k; j++) {
              ev = events[j];
              if ((callback && callback !== ev.callback && callback !== ev.callback._callback) ||
                  (context && context !== ev.context)) {
                retain.push(ev);
              }
            }
          }
          if (!retain.length) delete this._events[name];
        }
      }

      return this;
    },

    // Trigger one or many events, firing all bound callbacks. Callbacks are
    // passed the same arguments as `trigger` is, apart from the event name
    // (unless you're listening on `"all"`, which will cause your callback to
    // receive the true name of the event as the first argument).
    trigger: function(name) {
      if (!this._events) return this;
      var args = slice.call(arguments, 1);
      if (!eventsApi(this, 'trigger', name, args)) return this;
      var events = this._events[name];
      var allEvents = this._events.all;
      if (events) triggerEvents(events, args);
      if (allEvents) triggerEvents(allEvents, arguments);
      return this;
    },

    // Tell this object to stop listening to either specific events ... or
    // to every object it's currently listening to.
    stopListening: function(obj, name, callback) {
      var listeners = this._listeners;
      if (!listeners) return this;
      var deleteListener = !name && !callback;
      if (typeof name === 'object') callback = this;
      if (obj) (listeners = {})[obj._listenerId] = obj;
      for (var id in listeners) {
        listeners[id].off(name, callback, this);
        if (deleteListener) delete this._listeners[id];
      }
      return this;
    }

  };

  // Regular expression used to split event strings.
  var eventSplitter = /\s+/;

  // Implement fancy features of the Events API such as multiple event
  // names `"change blur"` and jQuery-style event maps `{change: action}`
  // in terms of the existing API.
  var eventsApi = function(obj, action, name, rest) {
    if (!name) return true;

    // Handle event maps.
    if (typeof name === 'object') {
      for (var key in name) {
        obj[action].apply(obj, [key, name[key]].concat(rest));
      }
      return false;
    }

    // Handle space separated event names.
    if (eventSplitter.test(name)) {
      var names = name.split(eventSplitter);
      for (var i = 0, l = names.length; i < l; i++) {
        obj[action].apply(obj, [names[i]].concat(rest));
      }
      return false;
    }

    return true;
  };

  // A difficult-to-believe, but optimized internal dispatch function for
  // triggering events. Tries to keep the usual cases speedy (most internal
  // Backbone events have 3 arguments).
  var triggerEvents = function(events, args) {
    var ev, i = -1, l = events.length, a1 = args[0], a2 = args[1], a3 = args[2];
    switch (args.length) {
      case 0: while (++i < l) (ev = events[i]).callback.call(ev.ctx); return;
      case 1: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1); return;
      case 2: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2); return;
      case 3: while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2, a3); return;
      default: while (++i < l) (ev = events[i]).callback.apply(ev.ctx, args);
    }
  };

  var listenMethods = {listenTo: 'on', listenToOnce: 'once'};

  // Inversion-of-control versions of `on` and `once`. Tell *this* object to
  // listen to an event in another object ... keeping track of what it's
  // listening to.
  _.each(listenMethods, function(implementation, method) {
    Events[method] = function(obj, name, callback) {
      var listeners = this._listeners || (this._listeners = {});
      var id = obj._listenerId || (obj._listenerId = _.uniqueId('l'));
      listeners[id] = obj;
      if (typeof name === 'object') callback = this;
      obj[implementation](name, callback, this);
      return this;
    };
  });

  // Aliases for backwards compatibility.
  Events.bind   = Events.on;
  Events.unbind = Events.off;

  // Allow the `Backbone` object to serve as a global event bus, for folks who
  // want global "pubsub" in a convenient place.
  _.extend(Backbone, Events);

  // Backbone.Model
  // --------------

  // Backbone **Models** are the basic data object in the framework --
  // frequently representing a row in a table in a database on your server.
  // A discrete chunk of data and a bunch of useful, related methods for
  // performing computations and transformations on that data.

  // Create a new model with the specified attributes. A client id (`cid`)
  // is automatically generated and assigned for you.
  var Model = Backbone.Model = function(attributes, options) {
    var defaults;
    var attrs = attributes || {};
    options || (options = {});
    this.cid = _.uniqueId('c');
    this.attributes = {};
    _.extend(this, _.pick(options, modelOptions));
    if (options.parse) attrs = this.parse(attrs, options) || {};
    if (defaults = _.result(this, 'defaults')) {
      attrs = _.defaults({}, attrs, defaults);
    }
    this.set(attrs, options);
    this.changed = {};
    this.initialize.apply(this, arguments);
  };

  // A list of options to be attached directly to the model, if provided.
  var modelOptions = ['url', 'urlRoot', 'collection'];

  // Attach all inheritable methods to the Model prototype.
  _.extend(Model.prototype, Events, {

    // A hash of attributes whose current and previous value differ.
    changed: null,

    // The value returned during the last failed validation.
    validationError: null,

    // The default name for the JSON `id` attribute is `"id"`. MongoDB and
    // CouchDB users may want to set this to `"_id"`.
    idAttribute: 'id',

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // Return a copy of the model's `attributes` object.
    toJSON: function(options) {
      return _.clone(this.attributes);
    },

    // Proxy `Backbone.sync` by default -- but override this if you need
    // custom syncing semantics for *this* particular model.
    sync: function() {
      return Backbone.sync.apply(this, arguments);
    },

    // Get the value of an attribute.
    get: function(attr) {
      return this.attributes[attr];
    },

    // Get the HTML-escaped value of an attribute.
    escape: function(attr) {
      return _.escape(this.get(attr));
    },

    // Returns `true` if the attribute contains a value that is not null
    // or undefined.
    has: function(attr) {
      return this.get(attr) != null;
    },

    // Set a hash of model attributes on the object, firing `"change"`. This is
    // the core primitive operation of a model, updating the data and notifying
    // anyone who needs to know about the change in state. The heart of the beast.
    set: function(key, val, options) {
      var attr, attrs, unset, changes, silent, changing, prev, current;
      if (key == null) return this;

      // Handle both `"key", value` and `{key: value}` -style arguments.
      if (typeof key === 'object') {
        attrs = key;
        options = val;
      } else {
        (attrs = {})[key] = val;
      }

      options || (options = {});

      // Run validation.
      if (!this._validate(attrs, options)) return false;

      // Extract attributes and options.
      unset           = options.unset;
      silent          = options.silent;
      changes         = [];
      changing        = this._changing;
      this._changing  = true;

      if (!changing) {
        this._previousAttributes = _.clone(this.attributes);
        this.changed = {};
      }
      current = this.attributes, prev = this._previousAttributes;

      // Check for changes of `id`.
      if (this.idAttribute in attrs) this.id = attrs[this.idAttribute];

      // For each `set` attribute, update or delete the current value.
      for (attr in attrs) {
        val = attrs[attr];
        if (!_.isEqual(current[attr], val)) changes.push(attr);
        if (!_.isEqual(prev[attr], val)) {
          this.changed[attr] = val;
        } else {
          delete this.changed[attr];
        }
        unset ? delete current[attr] : current[attr] = val;
      }

      // Trigger all relevant attribute changes.
      if (!silent) {
        if (changes.length) this._pending = true;
        for (var i = 0, l = changes.length; i < l; i++) {
          this.trigger('change:' + changes[i], this, current[changes[i]], options);
        }
      }

      // You might be wondering why there's a `while` loop here. Changes can
      // be recursively nested within `"change"` events.
      if (changing) return this;
      if (!silent) {
        while (this._pending) {
          this._pending = false;
          this.trigger('change', this, options);
        }
      }
      this._pending = false;
      this._changing = false;
      return this;
    },

    // Remove an attribute from the model, firing `"change"`. `unset` is a noop
    // if the attribute doesn't exist.
    unset: function(attr, options) {
      return this.set(attr, void 0, _.extend({}, options, {unset: true}));
    },

    // Clear all attributes on the model, firing `"change"`.
    clear: function(options) {
      var attrs = {};
      for (var key in this.attributes) attrs[key] = void 0;
      return this.set(attrs, _.extend({}, options, {unset: true}));
    },

    // Determine if the model has changed since the last `"change"` event.
    // If you specify an attribute name, determine if that attribute has changed.
    hasChanged: function(attr) {
      if (attr == null) return !_.isEmpty(this.changed);
      return _.has(this.changed, attr);
    },

    // Return an object containing all the attributes that have changed, or
    // false if there are no changed attributes. Useful for determining what
    // parts of a view need to be updated and/or what attributes need to be
    // persisted to the server. Unset attributes will be set to undefined.
    // You can also pass an attributes object to diff against the model,
    // determining if there *would be* a change.
    changedAttributes: function(diff) {
      if (!diff) return this.hasChanged() ? _.clone(this.changed) : false;
      var val, changed = false;
      var old = this._changing ? this._previousAttributes : this.attributes;
      for (var attr in diff) {
        if (_.isEqual(old[attr], (val = diff[attr]))) continue;
        (changed || (changed = {}))[attr] = val;
      }
      return changed;
    },

    // Get the previous value of an attribute, recorded at the time the last
    // `"change"` event was fired.
    previous: function(attr) {
      if (attr == null || !this._previousAttributes) return null;
      return this._previousAttributes[attr];
    },

    // Get all of the attributes of the model at the time of the previous
    // `"change"` event.
    previousAttributes: function() {
      return _.clone(this._previousAttributes);
    },

    // Fetch the model from the server. If the server's representation of the
    // model differs from its current attributes, they will be overridden,
    // triggering a `"change"` event.
    fetch: function(options) {
      options = options ? _.clone(options) : {};
      if (options.parse === void 0) options.parse = true;
      var model = this;
      var success = options.success;
      options.success = function(resp) {
        if (!model.set(model.parse(resp, options), options)) return false;
        if (success) success(model, resp, options);
        model.trigger('sync', model, resp, options);
      };
      wrapError(this, options);
      return this.sync('read', this, options);
    },

    // Set a hash of model attributes, and sync the model to the server.
    // If the server returns an attributes hash that differs, the model's
    // state will be `set` again.
    save: function(key, val, options) {
      var attrs, method, xhr, attributes = this.attributes;

      // Handle both `"key", value` and `{key: value}` -style arguments.
      if (key == null || typeof key === 'object') {
        attrs = key;
        options = val;
      } else {
        (attrs = {})[key] = val;
      }

      // If we're not waiting and attributes exist, save acts as `set(attr).save(null, opts)`.
      if (attrs && (!options || !options.wait) && !this.set(attrs, options)) return false;

      options = _.extend({validate: true}, options);

      // Do not persist invalid models.
      if (!this._validate(attrs, options)) return false;

      // Set temporary attributes if `{wait: true}`.
      if (attrs && options.wait) {
        this.attributes = _.extend({}, attributes, attrs);
      }

      // After a successful server-side save, the client is (optionally)
      // updated with the server-side state.
      if (options.parse === void 0) options.parse = true;
      var model = this;
      var success = options.success;
      options.success = function(resp) {
        // Ensure attributes are restored during synchronous saves.
        model.attributes = attributes;
        var serverAttrs = model.parse(resp, options);
        if (options.wait) serverAttrs = _.extend(attrs || {}, serverAttrs);
        if (_.isObject(serverAttrs) && !model.set(serverAttrs, options)) {
          return false;
        }
        if (success) success(model, resp, options);
        model.trigger('sync', model, resp, options);
      };
      wrapError(this, options);

      method = this.isNew() ? 'create' : (options.patch ? 'patch' : 'update');
      if (method === 'patch') options.attrs = attrs;
      xhr = this.sync(method, this, options);

      // Restore attributes.
      if (attrs && options.wait) this.attributes = attributes;

      return xhr;
    },

    // Destroy this model on the server if it was already persisted.
    // Optimistically removes the model from its collection, if it has one.
    // If `wait: true` is passed, waits for the server to respond before removal.
    destroy: function(options) {
      options = options ? _.clone(options) : {};
      var model = this;
      var success = options.success;

      var destroy = function() {
        model.trigger('destroy', model, model.collection, options);
      };

      options.success = function(resp) {
        if (options.wait || model.isNew()) destroy();
        if (success) success(model, resp, options);
        if (!model.isNew()) model.trigger('sync', model, resp, options);
      };

      if (this.isNew()) {
        options.success();
        return false;
      }
      wrapError(this, options);

      var xhr = this.sync('delete', this, options);
      if (!options.wait) destroy();
      return xhr;
    },

    // Default URL for the model's representation on the server -- if you're
    // using Backbone's restful methods, override this to change the endpoint
    // that will be called.
    url: function() {
      var base = _.result(this, 'urlRoot') || _.result(this.collection, 'url') || urlError();
      if (this.isNew()) return base;
      return base + (base.charAt(base.length - 1) === '/' ? '' : '/') + encodeURIComponent(this.id);
    },

    // **parse** converts a response into the hash of attributes to be `set` on
    // the model. The default implementation is just to pass the response along.
    parse: function(resp, options) {
      return resp;
    },

    // Create a new model with identical attributes to this one.
    clone: function() {
      return new this.constructor(this.attributes);
    },

    // A model is new if it has never been saved to the server, and lacks an id.
    isNew: function() {
      return this.id == null;
    },

    // Check if the model is currently in a valid state.
    isValid: function(options) {
      return this._validate({}, _.extend(options || {}, { validate: true }));
    },

    // Run validation against the next complete set of model attributes,
    // returning `true` if all is well. Otherwise, fire an `"invalid"` event.
    _validate: function(attrs, options) {
      if (!options.validate || !this.validate) return true;
      attrs = _.extend({}, this.attributes, attrs);
      var error = this.validationError = this.validate(attrs, options) || null;
      if (!error) return true;
      this.trigger('invalid', this, error, _.extend(options || {}, {validationError: error}));
      return false;
    }

  });

  // Underscore methods that we want to implement on the Model.
  var modelMethods = ['keys', 'values', 'pairs', 'invert', 'pick', 'omit'];

  // Mix in each Underscore method as a proxy to `Model#attributes`.
  _.each(modelMethods, function(method) {
    Model.prototype[method] = function() {
      var args = slice.call(arguments);
      args.unshift(this.attributes);
      return _[method].apply(_, args);
    };
  });

  // Backbone.Collection
  // -------------------

  // If models tend to represent a single row of data, a Backbone Collection is
  // more analagous to a table full of data ... or a small slice or page of that
  // table, or a collection of rows that belong together for a particular reason
  // -- all of the messages in this particular folder, all of the documents
  // belonging to this particular author, and so on. Collections maintain
  // indexes of their models, both in order, and for lookup by `id`.

  // Create a new **Collection**, perhaps to contain a specific type of `model`.
  // If a `comparator` is specified, the Collection will maintain
  // its models in sort order, as they're added and removed.
  var Collection = Backbone.Collection = function(models, options) {
    options || (options = {});
    if (options.url) this.url = options.url;
    if (options.model) this.model = options.model;
    if (options.comparator !== void 0) this.comparator = options.comparator;
    this._reset();
    this.initialize.apply(this, arguments);
    if (models) this.reset(models, _.extend({silent: true}, options));
  };

  // Default options for `Collection#set`.
  var setOptions = {add: true, remove: true, merge: true};
  var addOptions = {add: true, merge: false, remove: false};

  // Define the Collection's inheritable methods.
  _.extend(Collection.prototype, Events, {

    // The default model for a collection is just a **Backbone.Model**.
    // This should be overridden in most cases.
    model: Model,

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // The JSON representation of a Collection is an array of the
    // models' attributes.
    toJSON: function(options) {
      return this.map(function(model){ return model.toJSON(options); });
    },

    // Proxy `Backbone.sync` by default.
    sync: function() {
      return Backbone.sync.apply(this, arguments);
    },

    // Add a model, or list of models to the set.
    add: function(models, options) {
      return this.set(models, _.defaults(options || {}, addOptions));
    },

    // Remove a model, or a list of models from the set.
    remove: function(models, options) {
      models = _.isArray(models) ? models.slice() : [models];
      options || (options = {});
      var i, l, index, model;
      for (i = 0, l = models.length; i < l; i++) {
        model = this.get(models[i]);
        if (!model) continue;
        delete this._byId[model.id];
        delete this._byId[model.cid];
        index = this.indexOf(model);
        this.models.splice(index, 1);
        this.length--;
        if (!options.silent) {
          options.index = index;
          model.trigger('remove', model, this, options);
        }
        this._removeReference(model);
      }
      return this;
    },

    // Update a collection by `set`-ing a new list of models, adding new ones,
    // removing models that are no longer present, and merging models that
    // already exist in the collection, as necessary. Similar to **Model#set**,
    // the core operation for updating the data contained by the collection.
    set: function(models, options) {
      options = _.defaults(options || {}, setOptions);
      if (options.parse) models = this.parse(models, options);
      if (!_.isArray(models)) models = models ? [models] : [];
      var i, l, model, attrs, existing, sort;
      var at = options.at;
      var sortable = this.comparator && (at == null) && options.sort !== false;
      var sortAttr = _.isString(this.comparator) ? this.comparator : null;
      var toAdd = [], toRemove = [], modelMap = {};

      // Turn bare objects into model references, and prevent invalid models
      // from being added.
      for (i = 0, l = models.length; i < l; i++) {
        if (!(model = this._prepareModel(models[i], options))) continue;

        // If a duplicate is found, prevent it from being added and
        // optionally merge it into the existing model.
        if (existing = this.get(model)) {
          if (options.remove) modelMap[existing.cid] = true;
          if (options.merge) {
            existing.set(model.attributes, options);
            if (sortable && !sort && existing.hasChanged(sortAttr)) sort = true;
          }

        // This is a new model, push it to the `toAdd` list.
        } else if (options.add) {
          toAdd.push(model);

          // Listen to added models' events, and index models for lookup by
          // `id` and by `cid`.
          model.on('all', this._onModelEvent, this);
          this._byId[model.cid] = model;
          if (model.id != null) this._byId[model.id] = model;
        }
      }

      // Remove nonexistent models if appropriate.
      if (options.remove) {
        for (i = 0, l = this.length; i < l; ++i) {
          if (!modelMap[(model = this.models[i]).cid]) toRemove.push(model);
        }
        if (toRemove.length) this.remove(toRemove, options);
      }

      // See if sorting is needed, update `length` and splice in new models.
      if (toAdd.length) {
        if (sortable) sort = true;
        this.length += toAdd.length;
        if (at != null) {
          splice.apply(this.models, [at, 0].concat(toAdd));
        } else {
          push.apply(this.models, toAdd);
        }
      }

      // Silently sort the collection if appropriate.
      if (sort) this.sort({silent: true});

      if (options.silent) return this;

      // Trigger `add` events.
      for (i = 0, l = toAdd.length; i < l; i++) {
        (model = toAdd[i]).trigger('add', model, this, options);
      }

      // Trigger `sort` if the collection was sorted.
      if (sort) this.trigger('sort', this, options);
      return this;
    },

    // When you have more items than you want to add or remove individually,
    // you can reset the entire set with a new list of models, without firing
    // any granular `add` or `remove` events. Fires `reset` when finished.
    // Useful for bulk operations and optimizations.
    reset: function(models, options) {
      options || (options = {});
      for (var i = 0, l = this.models.length; i < l; i++) {
        this._removeReference(this.models[i]);
      }
      options.previousModels = this.models;
      this._reset();
      this.add(models, _.extend({silent: true}, options));
      if (!options.silent) this.trigger('reset', this, options);
      return this;
    },

    // Add a model to the end of the collection.
    push: function(model, options) {
      model = this._prepareModel(model, options);
      this.add(model, _.extend({at: this.length}, options));
      return model;
    },

    // Remove a model from the end of the collection.
    pop: function(options) {
      var model = this.at(this.length - 1);
      this.remove(model, options);
      return model;
    },

    // Add a model to the beginning of the collection.
    unshift: function(model, options) {
      model = this._prepareModel(model, options);
      this.add(model, _.extend({at: 0}, options));
      return model;
    },

    // Remove a model from the beginning of the collection.
    shift: function(options) {
      var model = this.at(0);
      this.remove(model, options);
      return model;
    },

    // Slice out a sub-array of models from the collection.
    slice: function(begin, end) {
      return this.models.slice(begin, end);
    },

    // Get a model from the set by id.
    get: function(obj) {
      if (obj == null) return void 0;
      return this._byId[obj.id != null ? obj.id : obj.cid || obj];
    },

    // Get the model at the given index.
    at: function(index) {
      return this.models[index];
    },

    // Return models with matching attributes. Useful for simple cases of
    // `filter`.
    where: function(attrs, first) {
      if (_.isEmpty(attrs)) return first ? void 0 : [];
      return this[first ? 'find' : 'filter'](function(model) {
        for (var key in attrs) {
          if (attrs[key] !== model.get(key)) return false;
        }
        return true;
      });
    },

    // Return the first model with matching attributes. Useful for simple cases
    // of `find`.
    findWhere: function(attrs) {
      return this.where(attrs, true);
    },

    // Force the collection to re-sort itself. You don't need to call this under
    // normal circumstances, as the set will maintain sort order as each item
    // is added.
    sort: function(options) {
      if (!this.comparator) throw new Error('Cannot sort a set without a comparator');
      options || (options = {});

      // Run sort based on type of `comparator`.
      if (_.isString(this.comparator) || this.comparator.length === 1) {
        this.models = this.sortBy(this.comparator, this);
      } else {
        this.models.sort(_.bind(this.comparator, this));
      }

      if (!options.silent) this.trigger('sort', this, options);
      return this;
    },

    // Figure out the smallest index at which a model should be inserted so as
    // to maintain order.
    sortedIndex: function(model, value, context) {
      value || (value = this.comparator);
      var iterator = _.isFunction(value) ? value : function(model) {
        return model.get(value);
      };
      return _.sortedIndex(this.models, model, iterator, context);
    },

    // Pluck an attribute from each model in the collection.
    pluck: function(attr) {
      return _.invoke(this.models, 'get', attr);
    },

    // Fetch the default set of models for this collection, resetting the
    // collection when they arrive. If `reset: true` is passed, the response
    // data will be passed through the `reset` method instead of `set`.
    fetch: function(options) {
      options = options ? _.clone(options) : {};
      if (options.parse === void 0) options.parse = true;
      var success = options.success;
      var collection = this;
      options.success = function(resp) {
        var method = options.reset ? 'reset' : 'set';
        collection[method](resp, options);
        if (success) success(collection, resp, options);
        collection.trigger('sync', collection, resp, options);
      };
      wrapError(this, options);
      return this.sync('read', this, options);
    },

    // Create a new instance of a model in this collection. Add the model to the
    // collection immediately, unless `wait: true` is passed, in which case we
    // wait for the server to agree.
    create: function(model, options) {
      options = options ? _.clone(options) : {};
      if (!(model = this._prepareModel(model, options))) return false;
      if (!options.wait) this.add(model, options);
      var collection = this;
      var success = options.success;
      options.success = function(resp) {
        if (options.wait) collection.add(model, options);
        if (success) success(model, resp, options);
      };
      model.save(null, options);
      return model;
    },

    // **parse** converts a response into a list of models to be added to the
    // collection. The default implementation is just to pass it through.
    parse: function(resp, options) {
      return resp;
    },

    // Create a new collection with an identical list of models as this one.
    clone: function() {
      return new this.constructor(this.models);
    },

    // Private method to reset all internal state. Called when the collection
    // is first initialized or reset.
    _reset: function() {
      this.length = 0;
      this.models = [];
      this._byId  = {};
    },

    // Prepare a hash of attributes (or other model) to be added to this
    // collection.
    _prepareModel: function(attrs, options) {
      if (attrs instanceof Model) {
        if (!attrs.collection) attrs.collection = this;
        return attrs;
      }
      options || (options = {});
      options.collection = this;
      var model = new this.model(attrs, options);
      if (!model._validate(attrs, options)) {
        this.trigger('invalid', this, attrs, options);
        return false;
      }
      return model;
    },

    // Internal method to sever a model's ties to a collection.
    _removeReference: function(model) {
      if (this === model.collection) delete model.collection;
      model.off('all', this._onModelEvent, this);
    },

    // Internal method called every time a model in the set fires an event.
    // Sets need to update their indexes when models change ids. All other
    // events simply proxy through. "add" and "remove" events that originate
    // in other collections are ignored.
    _onModelEvent: function(event, model, collection, options) {
      if ((event === 'add' || event === 'remove') && collection !== this) return;
      if (event === 'destroy') this.remove(model, options);
      if (model && event === 'change:' + model.idAttribute) {
        delete this._byId[model.previous(model.idAttribute)];
        if (model.id != null) this._byId[model.id] = model;
      }
      this.trigger.apply(this, arguments);
    }

  });

  // Underscore methods that we want to implement on the Collection.
  // 90% of the core usefulness of Backbone Collections is actually implemented
  // right here:
  var methods = ['forEach', 'each', 'map', 'collect', 'reduce', 'foldl',
    'inject', 'reduceRight', 'foldr', 'find', 'detect', 'filter', 'select',
    'reject', 'every', 'all', 'some', 'any', 'include', 'contains', 'invoke',
    'max', 'min', 'toArray', 'size', 'first', 'head', 'take', 'initial', 'rest',
    'tail', 'drop', 'last', 'without', 'indexOf', 'shuffle', 'lastIndexOf',
    'isEmpty', 'chain'];

  // Mix in each Underscore method as a proxy to `Collection#models`.
  _.each(methods, function(method) {
    Collection.prototype[method] = function() {
      var args = slice.call(arguments);
      args.unshift(this.models);
      return _[method].apply(_, args);
    };
  });

  // Underscore methods that take a property name as an argument.
  var attributeMethods = ['groupBy', 'countBy', 'sortBy'];

  // Use attributes instead of properties.
  _.each(attributeMethods, function(method) {
    Collection.prototype[method] = function(value, context) {
      var iterator = _.isFunction(value) ? value : function(model) {
        return model.get(value);
      };
      return _[method](this.models, iterator, context);
    };
  });

  // Backbone.View
  // -------------

  // Backbone Views are almost more convention than they are actual code. A View
  // is simply a JavaScript object that represents a logical chunk of UI in the
  // DOM. This might be a single item, an entire list, a sidebar or panel, or
  // even the surrounding frame which wraps your whole app. Defining a chunk of
  // UI as a **View** allows you to define your DOM events declaratively, without
  // having to worry about render order ... and makes it easy for the view to
  // react to specific changes in the state of your models.

  // Creating a Backbone.View creates its initial element outside of the DOM,
  // if an existing element is not provided...
  var View = Backbone.View = function(options) {
    this.cid = _.uniqueId('view');
    this._configure(options || {});
    this._ensureElement();
    this.initialize.apply(this, arguments);
    this.delegateEvents();
  };

  // Cached regex to split keys for `delegate`.
  var delegateEventSplitter = /^(\S+)\s*(.*)$/;

  // List of view options to be merged as properties.
  var viewOptions = ['model', 'collection', 'el', 'id', 'attributes', 'className', 'tagName', 'events'];

  // Set up all inheritable **Backbone.View** properties and methods.
  _.extend(View.prototype, Events, {

    // The default `tagName` of a View's element is `"div"`.
    tagName: 'div',

    // jQuery delegate for element lookup, scoped to DOM elements within the
    // current view. This should be prefered to global lookups where possible.
    $: function(selector) {
      return this.$el.find(selector);
    },

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // **render** is the core function that your view should override, in order
    // to populate its element (`this.el`), with the appropriate HTML. The
    // convention is for **render** to always return `this`.
    render: function() {
      return this;
    },

    // Remove this view by taking the element out of the DOM, and removing any
    // applicable Backbone.Events listeners.
    remove: function() {
      this.$el.remove();
      this.stopListening();
      return this;
    },

    // Change the view's element (`this.el` property), including event
    // re-delegation.
    setElement: function(element, delegate) {
      if (this.$el) this.undelegateEvents();
      this.$el = element instanceof Backbone.$ ? element : Backbone.$(element);
      this.el = this.$el[0];
      if (delegate !== false) this.delegateEvents();
      return this;
    },

    // Set callbacks, where `this.events` is a hash of
    //
    // *{"event selector": "callback"}*
    //
    //     {
    //       'mousedown .title':  'edit',
    //       'click .button':     'save'
    //       'click .open':       function(e) { ... }
    //     }
    //
    // pairs. Callbacks will be bound to the view, with `this` set properly.
    // Uses event delegation for efficiency.
    // Omitting the selector binds the event to `this.el`.
    // This only works for delegate-able events: not `focus`, `blur`, and
    // not `change`, `submit`, and `reset` in Internet Explorer.
    delegateEvents: function(events) {
      if (!(events || (events = _.result(this, 'events')))) return this;
      this.undelegateEvents();
      for (var key in events) {
        var method = events[key];
        if (!_.isFunction(method)) method = this[events[key]];
        if (!method) continue;

        var match = key.match(delegateEventSplitter);
        var eventName = match[1], selector = match[2];
        method = _.bind(method, this);
        eventName += '.delegateEvents' + this.cid;
        if (selector === '') {
          this.$el.on(eventName, method);
        } else {
          this.$el.on(eventName, selector, method);
        }
      }
      return this;
    },

    // Clears all callbacks previously bound to the view with `delegateEvents`.
    // You usually don't need to use this, but may wish to if you have multiple
    // Backbone views attached to the same DOM element.
    undelegateEvents: function() {
      this.$el.off('.delegateEvents' + this.cid);
      return this;
    },

    // Performs the initial configuration of a View with a set of options.
    // Keys with special meaning *(e.g. model, collection, id, className)* are
    // attached directly to the view.  See `viewOptions` for an exhaustive
    // list.
    _configure: function(options) {
      if (this.options) options = _.extend({}, _.result(this, 'options'), options);
      _.extend(this, _.pick(options, viewOptions));
      this.options = options;
    },

    // Ensure that the View has a DOM element to render into.
    // If `this.el` is a string, pass it through `$()`, take the first
    // matching element, and re-assign it to `el`. Otherwise, create
    // an element from the `id`, `className` and `tagName` properties.
    _ensureElement: function() {
      if (!this.el) {
        var attrs = _.extend({}, _.result(this, 'attributes'));
        if (this.id) attrs.id = _.result(this, 'id');
        if (this.className) attrs['class'] = _.result(this, 'className');
        var $el = Backbone.$('<' + _.result(this, 'tagName') + '>').attr(attrs);
        this.setElement($el, false);
      } else {
        this.setElement(_.result(this, 'el'), false);
      }
    }

  });

  // Backbone.sync
  // -------------

  // Override this function to change the manner in which Backbone persists
  // models to the server. You will be passed the type of request, and the
  // model in question. By default, makes a RESTful Ajax request
  // to the model's `url()`. Some possible customizations could be:
  //
  // * Use `setTimeout` to batch rapid-fire updates into a single request.
  // * Send up the models as XML instead of JSON.
  // * Persist models via WebSockets instead of Ajax.
  //
  // Turn on `Backbone.emulateHTTP` in order to send `PUT` and `DELETE` requests
  // as `POST`, with a `_method` parameter containing the true HTTP method,
  // as well as all requests with the body as `application/x-www-form-urlencoded`
  // instead of `application/json` with the model in a param named `model`.
  // Useful when interfacing with server-side languages like **PHP** that make
  // it difficult to read the body of `PUT` requests.
  Backbone.sync = function(method, model, options) {
    var type = methodMap[method];

    // Default options, unless specified.
    _.defaults(options || (options = {}), {
      emulateHTTP: Backbone.emulateHTTP,
      emulateJSON: Backbone.emulateJSON
    });

    // Default JSON-request options.
    var params = {type: type, dataType: 'json'};

    // Ensure that we have a URL.
    if (!options.url) {
      params.url = _.result(model, 'url') || urlError();
    }

    // Ensure that we have the appropriate request data.
    if (options.data == null && model && (method === 'create' || method === 'update' || method === 'patch')) {
      params.contentType = 'application/json';
      params.data = JSON.stringify(options.attrs || model.toJSON(options));
    }

    // For older servers, emulate JSON by encoding the request into an HTML-form.
    if (options.emulateJSON) {
      params.contentType = 'application/x-www-form-urlencoded';
      params.data = params.data ? {model: params.data} : {};
    }

    // For older servers, emulate HTTP by mimicking the HTTP method with `_method`
    // And an `X-HTTP-Method-Override` header.
    if (options.emulateHTTP && (type === 'PUT' || type === 'DELETE' || type === 'PATCH')) {
      params.type = 'POST';
      if (options.emulateJSON) params.data._method = type;
      var beforeSend = options.beforeSend;
      options.beforeSend = function(xhr) {
        xhr.setRequestHeader('X-HTTP-Method-Override', type);
        if (beforeSend) return beforeSend.apply(this, arguments);
      };
    }

    // Don't process data on a non-GET request.
    if (params.type !== 'GET' && !options.emulateJSON) {
      params.processData = false;
    }

    // If we're sending a `PATCH` request, and we're in an old Internet Explorer
    // that still has ActiveX enabled by default, override jQuery to use that
    // for XHR instead. Remove this line when jQuery supports `PATCH` on IE8.
    if (params.type === 'PATCH' && window.ActiveXObject &&
          !(window.external && window.external.msActiveXFilteringEnabled)) {
      params.xhr = function() {
        return new ActiveXObject("Microsoft.XMLHTTP");
      };
    }

    // Make the request, allowing the user to override any Ajax options.
    var xhr = options.xhr = Backbone.ajax(_.extend(params, options));
    model.trigger('request', model, xhr, options);
    return xhr;
  };

  // Map from CRUD to HTTP for our default `Backbone.sync` implementation.
  var methodMap = {
    'create': 'POST',
    'update': 'PUT',
    'patch':  'PATCH',
    'delete': 'DELETE',
    'read':   'GET'
  };

  // Set the default implementation of `Backbone.ajax` to proxy through to `$`.
  // Override this if you'd like to use a different library.
  Backbone.ajax = function() {
    return Backbone.$.ajax.apply(Backbone.$, arguments);
  };

  // Backbone.Router
  // ---------------

  // Routers map faux-URLs to actions, and fire events when routes are
  // matched. Creating a new one sets its `routes` hash, if not set statically.
  var Router = Backbone.Router = function(options) {
    options || (options = {});
    if (options.routes) this.routes = options.routes;
    this._bindRoutes();
    this.initialize.apply(this, arguments);
  };

  // Cached regular expressions for matching named param parts and splatted
  // parts of route strings.
  var optionalParam = /\((.*?)\)/g;
  var namedParam    = /(\(\?)?:\w+/g;
  var splatParam    = /\*\w+/g;
  var escapeRegExp  = /[\-{}\[\]+?.,\\\^$|#\s]/g;

  // Set up all inheritable **Backbone.Router** properties and methods.
  _.extend(Router.prototype, Events, {

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // Manually bind a single named route to a callback. For example:
    //
    //     this.route('search/:query/p:num', 'search', function(query, num) {
    //       ...
    //     });
    //
    route: function(route, name, callback) {
      if (!_.isRegExp(route)) route = this._routeToRegExp(route);
      if (_.isFunction(name)) {
        callback = name;
        name = '';
      }
      if (!callback) callback = this[name];
      var router = this;
      Backbone.history.route(route, function(fragment) {
        var args = router._extractParameters(route, fragment);
        callback && callback.apply(router, args);
        router.trigger.apply(router, ['route:' + name].concat(args));
        router.trigger('route', name, args);
        Backbone.history.trigger('route', router, name, args);
      });
      return this;
    },

    // Simple proxy to `Backbone.history` to save a fragment into the history.
    navigate: function(fragment, options) {
      Backbone.history.navigate(fragment, options);
      return this;
    },

    // Bind all defined routes to `Backbone.history`. We have to reverse the
    // order of the routes here to support behavior where the most general
    // routes can be defined at the bottom of the route map.
    _bindRoutes: function() {
      if (!this.routes) return;
      this.routes = _.result(this, 'routes');
      var route, routes = _.keys(this.routes);
      while ((route = routes.pop()) != null) {
        this.route(route, this.routes[route]);
      }
    },

    // Convert a route string into a regular expression, suitable for matching
    // against the current location hash.
    _routeToRegExp: function(route) {
      route = route.replace(escapeRegExp, '\\$&')
                   .replace(optionalParam, '(?:$1)?')
                   .replace(namedParam, function(match, optional){
                     return optional ? match : '([^\/]+)';
                   })
                   .replace(splatParam, '(.*?)');
      return new RegExp('^' + route + '$');
    },

    // Given a route, and a URL fragment that it matches, return the array of
    // extracted decoded parameters. Empty or unmatched parameters will be
    // treated as `null` to normalize cross-browser behavior.
    _extractParameters: function(route, fragment) {
      var params = route.exec(fragment).slice(1);
      return _.map(params, function(param) {
        return param ? decodeURIComponent(param) : null;
      });
    }

  });

  // Backbone.History
  // ----------------

  // Handles cross-browser history management, based on either
  // [pushState](http://diveintohtml5.info/history.html) and real URLs, or
  // [onhashchange](https://developer.mozilla.org/en-US/docs/DOM/window.onhashchange)
  // and URL fragments. If the browser supports neither (old IE, natch),
  // falls back to polling.
  var History = Backbone.History = function() {
    this.handlers = [];
    _.bindAll(this, 'checkUrl');

    // Ensure that `History` can be used outside of the browser.
    if (typeof window !== 'undefined') {
      this.location = window.location;
      this.history = window.history;
    }
  };

  // Cached regex for stripping a leading hash/slash and trailing space.
  var routeStripper = /^[#\/]|\s+$/g;

  // Cached regex for stripping leading and trailing slashes.
  var rootStripper = /^\/+|\/+$/g;

  // Cached regex for detecting MSIE.
  var isExplorer = /msie [\w.]+/;

  // Cached regex for removing a trailing slash.
  var trailingSlash = /\/$/;

  // Has the history handling already been started?
  History.started = false;

  // Set up all inheritable **Backbone.History** properties and methods.
  _.extend(History.prototype, Events, {

    // The default interval to poll for hash changes, if necessary, is
    // twenty times a second.
    interval: 50,

    // Gets the true hash value. Cannot use location.hash directly due to bug
    // in Firefox where location.hash will always be decoded.
    getHash: function(window) {
      var match = (window || this).location.href.match(/#(.*)$/);
      return match ? match[1] : '';
    },

    // Get the cross-browser normalized URL fragment, either from the URL,
    // the hash, or the override.
    getFragment: function(fragment, forcePushState) {
      if (fragment == null) {
        if (this._hasPushState || !this._wantsHashChange || forcePushState) {
          fragment = this.location.pathname;
          var root = this.root.replace(trailingSlash, '');
          if (!fragment.indexOf(root)) fragment = fragment.substr(root.length);
        } else {
          fragment = this.getHash();
        }
      }
      return fragment.replace(routeStripper, '');
    },

    // Start the hash change handling, returning `true` if the current URL matches
    // an existing route, and `false` otherwise.
    start: function(options) {
      if (History.started) throw new Error("Backbone.history has already been started");
      History.started = true;

      // Figure out the initial configuration. Do we need an iframe?
      // Is pushState desired ... is it available?
      this.options          = _.extend({}, {root: '/'}, this.options, options);
      this.root             = this.options.root;
      this._wantsHashChange = this.options.hashChange !== false;
      this._wantsPushState  = !!this.options.pushState;
      this._hasPushState    = !!(this.options.pushState && this.history && this.history.pushState);
      var fragment          = this.getFragment();
      var docMode           = document.documentMode;
      var oldIE             = (isExplorer.exec(navigator.userAgent.toLowerCase()) && (!docMode || docMode <= 7));

      // Normalize root to always include a leading and trailing slash.
      this.root = ('/' + this.root + '/').replace(rootStripper, '/');

      if (oldIE && this._wantsHashChange) {
        this.iframe = Backbone.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo('body')[0].contentWindow;
        this.navigate(fragment);
      }

      // Depending on whether we're using pushState or hashes, and whether
      // 'onhashchange' is supported, determine how we check the URL state.
      if (this._hasPushState) {
        Backbone.$(window).on('popstate', this.checkUrl);
      } else if (this._wantsHashChange && ('onhashchange' in window) && !oldIE) {
        Backbone.$(window).on('hashchange', this.checkUrl);
      } else if (this._wantsHashChange) {
        this._checkUrlInterval = setInterval(this.checkUrl, this.interval);
      }

      // Determine if we need to change the base url, for a pushState link
      // opened by a non-pushState browser.
      this.fragment = fragment;
      var loc = this.location;
      var atRoot = loc.pathname.replace(/[^\/]$/, '$&/') === this.root;

      // If we've started off with a route from a `pushState`-enabled browser,
      // but we're currently in a browser that doesn't support it...
      if (this._wantsHashChange && this._wantsPushState && !this._hasPushState && !atRoot) {
        this.fragment = this.getFragment(null, true);
        this.location.replace(this.root + this.location.search + '#' + this.fragment);
        // Return immediately as browser will do redirect to new url
        return true;

      // Or if we've started out with a hash-based route, but we're currently
      // in a browser where it could be `pushState`-based instead...
      } else if (this._wantsPushState && this._hasPushState && atRoot && loc.hash) {
        this.fragment = this.getHash().replace(routeStripper, '');
        this.history.replaceState({}, document.title, this.root + this.fragment + loc.search);
      }

      if (!this.options.silent) return this.loadUrl();
    },

    // Disable Backbone.history, perhaps temporarily. Not useful in a real app,
    // but possibly useful for unit testing Routers.
    stop: function() {
      Backbone.$(window).off('popstate', this.checkUrl).off('hashchange', this.checkUrl);
      clearInterval(this._checkUrlInterval);
      History.started = false;
    },

    // Add a route to be tested when the fragment changes. Routes added later
    // may override previous routes.
    route: function(route, callback) {
      this.handlers.unshift({route: route, callback: callback});
    },

    // Checks the current URL to see if it has changed, and if it has,
    // calls `loadUrl`, normalizing across the hidden iframe.
    checkUrl: function(e) {
      var current = this.getFragment();
      if (current === this.fragment && this.iframe) {
        current = this.getFragment(this.getHash(this.iframe));
      }
      if (current === this.fragment) return false;
      if (this.iframe) this.navigate(current);
      this.loadUrl() || this.loadUrl(this.getHash());
    },

    // Attempt to load the current URL fragment. If a route succeeds with a
    // match, returns `true`. If no defined routes matches the fragment,
    // returns `false`.
    loadUrl: function(fragmentOverride) {
      var fragment = this.fragment = this.getFragment(fragmentOverride);
      var matched = _.any(this.handlers, function(handler) {
        if (handler.route.test(fragment)) {
          handler.callback(fragment);
          return true;
        }
      });
      return matched;
    },

    // Save a fragment into the hash history, or replace the URL state if the
    // 'replace' option is passed. You are responsible for properly URL-encoding
    // the fragment in advance.
    //
    // The options object can contain `trigger: true` if you wish to have the
    // route callback be fired (not usually desirable), or `replace: true`, if
    // you wish to modify the current URL without adding an entry to the history.
    navigate: function(fragment, options) {
      if (!History.started) return false;
      if (!options || options === true) options = {trigger: options};
      fragment = this.getFragment(fragment || '');
      if (this.fragment === fragment) return;
      this.fragment = fragment;
      var url = this.root + fragment;

      // If pushState is available, we use it to set the fragment as a real URL.
      if (this._hasPushState) {
        this.history[options.replace ? 'replaceState' : 'pushState']({}, document.title, url);

      // If hash changes haven't been explicitly disabled, update the hash
      // fragment to store history.
      } else if (this._wantsHashChange) {
        this._updateHash(this.location, fragment, options.replace);
        if (this.iframe && (fragment !== this.getFragment(this.getHash(this.iframe)))) {
          // Opening and closing the iframe tricks IE7 and earlier to push a
          // history entry on hash-tag change.  When replace is true, we don't
          // want this.
          if(!options.replace) this.iframe.document.open().close();
          this._updateHash(this.iframe.location, fragment, options.replace);
        }

      // If you've told us that you explicitly don't want fallback hashchange-
      // based history, then `navigate` becomes a page refresh.
      } else {
        return this.location.assign(url);
      }
      if (options.trigger) this.loadUrl(fragment);
    },

    // Update the hash location, either replacing the current entry, or adding
    // a new one to the browser history.
    _updateHash: function(location, fragment, replace) {
      if (replace) {
        var href = location.href.replace(/(javascript:|#).*$/, '');
        location.replace(href + '#' + fragment);
      } else {
        // Some browsers require that `hash` contains a leading #.
        location.hash = '#' + fragment;
      }
    }

  });

  // Create the default Backbone.history.
  Backbone.history = new History;

  // Helpers
  // -------

  // Helper function to correctly set up the prototype chain, for subclasses.
  // Similar to `goog.inherits`, but uses a hash of prototype properties and
  // class properties to be extended.
  var extend = function(protoProps, staticProps) {
    var parent = this;
    var child;

    // The constructor function for the new subclass is either defined by you
    // (the "constructor" property in your `extend` definition), or defaulted
    // by us to simply call the parent's constructor.
    if (protoProps && _.has(protoProps, 'constructor')) {
      child = protoProps.constructor;
    } else {
      child = function(){ return parent.apply(this, arguments); };
    }

    // Add static properties to the constructor function, if supplied.
    _.extend(child, parent, staticProps);

    // Set the prototype chain to inherit from `parent`, without calling
    // `parent`'s constructor function.
    var Surrogate = function(){ this.constructor = child; };
    Surrogate.prototype = parent.prototype;
    child.prototype = new Surrogate;

    // Add prototype properties (instance properties) to the subclass,
    // if supplied.
    if (protoProps) _.extend(child.prototype, protoProps);

    // Set a convenience property in case the parent's prototype is needed
    // later.
    child.__super__ = parent.prototype;

    return child;
  };

  // Set up inheritance for the model, collection, router, view and history.
  Model.extend = Collection.extend = Router.extend = View.extend = History.extend = extend;

  // Throw an error when a URL is needed, and none is supplied.
  var urlError = function() {
    throw new Error('A "url" property or function must be specified');
  };

  // Wrap an optional error callback with a fallback error event.
  var wrapError = function (model, options) {
    var error = options.error;
    options.error = function(resp) {
      if (error) error(model, resp, options);
      model.trigger('error', model, resp, options);
    };
  };

}).call(this);

define("backbone", ["underscore","jquery"], (function (global) {
    return function () {
        var ret, fn;
        return ret || global.Backbone;
    };
}(this)));

define('helpers/ui',[],function() {

  

  var UIHelper = {};

  UIHelper.supportsTime = function(type) {
    return _.contains(['DATETIME', 'TIME', 'TIMESTAMP'], type);
  };

  UIHelper.supportsDate = function(type) {
    return _.contains(['DATETIME', 'DATE', 'TIMESTAMP'], type);
  };

  UIHelper.supportsNumeric = function(type) {
    return _.contains([
      'BIGINT',
      'BIT',
      'DECIMAL',
      'DOUBLE',
      'FLOAT',
      'INTEGER',
      'INT',
      'MEDIUMINT',
      'NUMERIC',
      'SMALLINT',
      'TINYINT'
    ], type);
  };

  return UIHelper;
});

define('core/UIComponent',['backbone', 'handlebars', 'helpers/ui', 'core/t'], function(Backbone, Handlebars, UIHelper, __t) {
  var UIComponentsOptions = ['id'];
  var UIComponent = function(options) {
    _.extend(this, _.pick(UIComponentsOptions, options));

    if (this.isNumeric() && this.supportsNumber()) {
      this.variables = this.variables || [];
      this.variables.push({
        id: 'footer',
        type: 'Boolean',
        default_value: false,
        ui: 'checkbox',
        comment: __t('numeric_footer_comment')
      });
    }
  };

  UIComponent.extend = Backbone.Model.extend;
  _.extend(UIComponent.prototype, Backbone.Events, {
    // Unique UI name
    id: null,
    // Supported Data Types for this UI
    dataTypes: [],
    // UI Options that can be set in Column Settings Page
    variables: [],
    // UI global options. (Directus Settings)
    settings: [],
    // UI Input view (UIView instance)
    Input: null,
    // Returns String That should be used to represent this UI when being listed as part of a table
    // @param options : Object : Contains Options/Attributes for this UI (value, collection [TableCollection], model [EntriesModel], schema, settings)
    list: function(options) {
      return options.value;
    },
    // Value used to sort the UI
    sort: function(options) {
      return options.value;
    },
    // compile a handlebars content
    compileView: function(source, data) {
      var template = Handlebars.compile(source);
      data || (data = {});

      return template(data);
    },
    isNumeric: function() {
      return this.id === 'numeric';
    },
    supportsNumber: function() {
      return _.some(this.dataTypes, function(type) {
        return UIHelper.supportsNumeric(type);
      });
    }
  });

  return UIComponent;
});

/*!
 * backbone.layoutmanager.js v0.9.1
 * Copyright 2013, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(window, factory) {
  
  var Backbone = window.Backbone;

  // AMD. Register as an anonymous module.  Wrap in function so we have access
  // to root via `this`.
  if (typeof define === "function" && define.amd) {
    return define('plugins/backbone.layoutmanager',["backbone", "underscore", "jquery"], function() {
      return factory.apply(window, arguments);
    });
  }

  // Browser globals.
  Backbone.Layout = factory.call(window, Backbone, window._, Backbone.$);
}(typeof global === "object" ? global : this, function (Backbone, _, $) {


// Create a reference to the global object. In browsers, it will map to the
// `window` object; in Node, it will be `global`.
var window = this;

// Hoisted, referenced at the bottom of the source.  This caches a list of all
// LayoutManager options at definition time.
var keys;

// Maintain references to the two `Backbone.View` functions that are
// overwritten so that they can be proxied.
var _configure = Backbone.View.prototype._configure;

// Cache these methods for performance.
var aPush = Array.prototype.push;
var aConcat = Array.prototype.concat;
var aSplice = Array.prototype.splice;

// LayoutManager is a wrapper around a `Backbone.View`.
var LayoutManager = Backbone.View.extend({
  _render: function(manage, options) {
    // Keep the view consistent between callbacks and deferreds.
    var view = this;
    // Shorthand the manager.
    var manager = view.__manager__;
    // Cache these properties.
    var beforeRender = options.beforeRender;
    // Create a deferred instead of going off
    var def = options.deferred();

    // Ensure all nested Views are properly scrubbed if re-rendering.
    if (view.hasRendered) {
      view._removeViews();
    }

    // This continues the render flow after `beforeRender` has completed.
    manager.callback = function() {
      // Clean up asynchronous manager properties.
      delete manager.isAsync;
      delete manager.callback;

      // Always emit a beforeRender event.
      view.trigger("beforeRender", view);

      // Render!
      manage(view, options).render().then(function() {
        // Complete this deferred once resolved.
        def.resolve();
      });
    };

    // If a beforeRender function is defined, call it.
    if (beforeRender) {
      beforeRender.call(view, view);
    }

    if (!manager.isAsync) {
      manager.callback();
    }

    // Return this intermediary promise.
    return def.promise();
  },
      
  // This named function allows for significantly easier debugging.
  constructor: function Layout(options) {
    // Options may not always be passed to the constructor, this ensures it is
    // always an object.
    options = options || {};

    // Grant this View superpowers.
    LayoutManager.setupView(this, options);

    // Have Backbone set up the rest of this View.
    Backbone.View.call(this, options);
  },

  // This method is used within specific methods to indicate that they should
  // be treated as asynchronous.  This method should only be used within the
  // render chain, otherwise unexpected behavior may occur.
  async: function() {
    var manager = this.__manager__;

    // Set this View's action to be asynchronous.
    manager.isAsync = true;

    // Return the callback.
    return manager.callback;
  },

  promise: function() {
    return this.__manager__.renderDeferred.promise();
  },

  // Sometimes it's desirable to only render the child views under the parent.
  // This is typical for a layout that does not change.  This method will
  // iterate over the child Views and aggregate all child render promises and
  // return the parent View.  The internal `promise()` method will return the
  // aggregate promise that resolves once all children have completed their
  // render.
  renderViews: function() {
    var root = this;
    var manager = root.__manager__;
    var options = root.getAllOptions();
    var newDeferred = options.deferred();

    // Collect all promises from rendering the child views and wait till they
    // all complete.
    var promises = root.getViews().map(function(view) {
      return view.render().__manager__.renderDeferred;
    }).value();

    // Simulate a parent render to remain consistent.
    manager.renderDeferred = newDeferred.promise();

    // Once all child views have completed rendering, resolve parent deferred
    // with the correct context.
    options.when(promises).then(function() {
      newDeferred.resolveWith(root, [root]);
    });

    // Allow this method to be chained.
    return root;
  },

  // Shorthand to `setView` function with the `insert` flag set.
  insertView: function(selector, view) {
    // If the `view` argument exists, then a selector was passed in.  This code
    // path will forward the selector on to `setView`.
    if (view) {
      return this.setView(selector, view, true);
    }

    // If no `view` argument is defined, then assume the first argument is the
    // View, somewhat now confusingly named `selector`.
    return this.setView(selector, true);
  },

  // Iterate over an object and ensure every value is wrapped in an array to
  // ensure they will be inserted, then pass that object to `setViews`.
  insertViews: function(views) {
    // If an array of views was passed it should be inserted into the
    // root view. Much like calling insertView without a selector.
    if (_.isArray(views)) {
      return this.setViews({ "": views });
    }

    _.each(views, function(view, selector) {
      views[selector] = _.isArray(view) ? view : [view];
    });

    return this.setViews(views);
  },

  // Returns the View that matches the `getViews` filter function.
  getView: function(fn) {
    // If `getView` is invoked with undefined as the first argument, then the
    // second argument will be used instead.  This is to allow
    // `getViews(undefined, fn)` to work as `getViews(fn)`.  Useful for when
    // you are allowing an optional selector.
    if (fn == null) {
      fn = arguments[1];
    }

    return this.getViews(fn).first().value();
  },

  // Provide a filter function to get a flattened array of all the subviews.
  // If the filter function is omitted it will return all subviews.  If a
  // String is passed instead, it will return the Views for that selector.
  getViews: function(fn) {
    var views;

    // If the filter argument is a String, then return a chained Version of the
    // elements. The value at the specified filter may be undefined, a single
    // view, or an array of views; in all cases, chain on a flat array.
    if (typeof fn === "string") {
      fn = this.sections[fn] || fn;
      views = this.views[fn] || [];

      // If Views is undefined you are concatenating an `undefined` to an array
      // resulting in a value being returned.  Defaulting to an array prevents
      // this.
      //return _.chain([].concat(views || []));
      return _.chain([].concat(views));
    }

    // Generate an array of all top level (no deeply nested) Views flattened.
    views = _.chain(this.views).map(function(view) {
      return _.isArray(view) ? view : [view];
    }, this).flatten();

    // If the argument passed is an Object, then pass it to `_.where`.
    if (typeof fn === "object") {
      return views.where(fn);
    }

    // If a filter function is provided, run it on all Views and return a
    // wrapped chain. Otherwise, simply return a wrapped chain of all Views.
    return typeof fn === "function" ? views.filter(fn) : views;
  },

  // Use this to remove Views, internally uses `getViews` so you can pass the
  // same argument here as you would to that method.
  removeView: function(fn) {
    // Allow an optional selector or function to find the right model and
    // remove nested Views based off the results of the selector or filter.
    return this.getViews(fn).each(function(nestedView) {
      nestedView.remove();
    });
  },

  // This takes in a partial name and view instance and assigns them to
  // the internal collection of views.  If a view is not a LayoutManager
  // instance, then mix in the LayoutManager prototype.  This ensures
  // all Views can be used successfully.
  //
  // Must definitely wrap any render method passed in or defaults to a
  // typical render function `return layout(this).render()`.
  setView: function(name, view, insert) {
    var manager, options, selector;
    // Parent view, the one you are setting a View on.
    var root = this;

    // If no name was passed, use an empty string and shift all arguments.
    if (typeof name !== "string") {
      insert = view;
      view = name;
      name = "";
    }

    // Shorthand the `__manager__` property.
    manager = view.__manager__;

    // If the View has not been properly set up, throw an Error message
    // indicating that the View needs `manage: true` set.
    if (!manager) {
      throw new Error("The argument associated with selector '" + name +
        "' is defined and a View.  Set `manage` property to true for " +
        "Backbone.View instances.");
    }

    // Assign options.
    options = view.getAllOptions();

    // Add reference to the parentView.
    manager.parent = root;

    // Add reference to the placement selector used.
    selector = manager.selector = root.sections[name] || name;

    // Call the `setup` method, since we now have a relationship created.
    _.result(view, "setup");

    // Code path is less complex for Views that are not being inserted.  Simply
    // remove existing Views and bail out with the assignment.
    if (!insert) {
      // If the View we are adding has already been rendered, simply inject it
      // into the parent.
      if (view.hasRendered) {
        // Apply the partial.
        options.partial(root.$el, view.$el, root.__manager__, manager);
      }

      // Ensure remove is called when swapping View's.
      root.removeView(name);

      // Assign to main views object and return for chainability.
      return root.views[selector] = view;
    }

    // Ensure this.views[selector] is an array and push this View to
    // the end.
    root.views[selector] = aConcat.call([], root.views[name] || [], view);

    // Put the parent view into `insert` mode.
    root.__manager__.insert = true;

    return view;
  },

  // Allows the setting of multiple views instead of a single view.
  setViews: function(views) {
    // Iterate over all the views and use the View's view method to assign.
    _.each(views, function(view, name) {
      // If the view is an array put all views into insert mode.
      if (_.isArray(view)) {
        return _.each(view, function(view) {
          this.insertView(name, view);
        }, this);
      }

      // Assign each view using the view function.
      this.setView(name, view);
    }, this);

    // Allow for chaining
    return this;
  },

  // By default this should find all nested views and render them into
  // the this.el and call done once all of them have successfully been
  // resolved.
  //
  // This function returns a promise that can be chained to determine
  // once all subviews and main view have been rendered into the view.el.
  render: function() {
    var root = this;
    var options = root.getAllOptions();
    var manager = root.__manager__;
    var parent = manager.parent;
    var rentManager = parent && parent.__manager__;
    var def = options.deferred();

    // Triggered once the render has succeeded.
    function resolve() {
      var next;

      // Insert all subViews into the parent at once.
      _.each(root.views, function(views, selector) {
        // Fragments aren't used on arrays of subviews.
        if (_.isArray(views)) {
          options.htmlBatch(root, views, selector);
        }
      });

      // If there is a parent and we weren't attached to it via the previous
      // method (single view), attach.
      if (parent && !manager.insertedViaFragment) {
        if (!options.contains(parent.el, root.el)) {
          // Apply the partial using parent's html() method.
          parent.getAllOptions().partial(parent.$el, root.$el, rentManager,
            manager);
        }
      }

      // Ensure events are always correctly bound after rendering.
      root.delegateEvents();

      // Set this View as successfully rendered.
      root.hasRendered = true;

      // Only process the queue if it exists.
      if (next = manager.queue.shift()) {
        // Ensure that the next render is only called after all other
        // `done` handlers have completed.  This will prevent `render`
        // callbacks from firing out of order.
        next();
      } else {
        // Once the queue is depleted, remove it, the render process has
        // completed.
        delete manager.queue;
      }

      // Reusable function for triggering the afterRender callback and event
      // and setting the hasRendered flag.
      function completeRender() {
        var console = window.console;
        var afterRender = options.afterRender;

        if (afterRender) {
          afterRender.call(root, root);
        }

        // Always emit an afterRender event.
        root.trigger("afterRender", root);

        // If there are multiple top level elements and `el: false` is used,
        // display a warning message and a stack trace.
        if (manager.noel && root.$el.length > 1) {
          // Do not display a warning while testing or if warning suppression
          // is enabled.
          if (_.isFunction(console.warn) && !options.suppressWarnings) {
            console.warn("`el: false` with multiple top level elements is " +
              "not supported.");

            // Provide a stack trace if available to aid with debugging.
            if (_.isFunction(console.trace)) {
              console.trace();
            }
          }
        }
      }

      // If the parent is currently rendering, wait until it has completed
      // until calling the nested View's `afterRender`.
      if (rentManager && rentManager.queue) {
        // Wait until the parent View has finished rendering, which could be
        // asynchronous, and trigger afterRender on this View once it has
        // compeleted.
        parent.once("afterRender", completeRender);
      } else {
        // This View and its parent have both rendered.
        completeRender();
      }

      return def.resolveWith(root, [root]);
    }

    // Actually facilitate a render.
    function actuallyRender() {
      var options = root.getAllOptions();

      // The `_viewRender` method is broken out to abstract away from having
      // too much code in `actuallyRender`.
      root._render(LayoutManager._viewRender, options).done(function() {
        // If there are no children to worry about, complete the render
        // instantly.
        if (!_.keys(root.views).length) {
          return resolve();
        }

        // Create a list of promises to wait on until rendering is done.
        // Since this method will run on all children as well, its sufficient
        // for a full hierarchical.
        var promises = _.map(root.views, function(view) {
          var insert = _.isArray(view);

          // If items are being inserted, they will be in a non-zero length
          // Array.
          if (insert && view.length) {
            // Mark each subview's manager so they don't attempt to attach by
            // themselves.  Return a single promise representing the entire
            // render.
            return options.when(_.map(view, function(subView) {
              subView.__manager__.insertedViaFragment = true;
              return subView.render().__manager__.renderDeferred;
            }));
          }

          // Only return the fetch deferred, resolve the main deferred after
          // the element has been attached to it's parent.
          return !insert ? view.render().__manager__.renderDeferred : view;
        });

        // Once all nested Views have been rendered, resolve this View's
        // deferred.
        options.when(promises).done(resolve);
      });
    }

    // Another render is currently happening if there is an existing queue, so
    // push a closure to render later into the queue.
    if (manager.queue) {
      aPush.call(manager.queue, actuallyRender);
    } else {
      manager.queue = [];

      // This the first `render`, preceeding the `queue` so render
      // immediately.
      actuallyRender(root, def);
    }

    // Put the deferred inside of the `__manager__` object, since we don't want
    // end users accessing this directly anymore in favor of the `afterRender`
    // event.  So instead of doing `render().then(...` do
    // `render().once("afterRender", ...`.
    root.__manager__.renderDeferred = def;

    // Return the actual View for chainability purposes.
    return root;
  },

  // Ensure the cleanup function is called whenever remove is called.
  remove: function() {
    // Force remove itself from its parent.
    LayoutManager._removeView(this, true);

    // Call the original remove function.
    return this._remove.apply(this, arguments);
  },

  // Merge instance and global options.
  getAllOptions: function() {
    // Instance overrides take precedence, fallback to prototype options.
    return _.extend({}, this, LayoutManager.prototype.options, this.options);
  }
},
{
  // Clearable cache.
  _cache: {},

  // Creates a deferred and returns a function to call when finished.
  // This gets passed to all _render methods.  The `root` value here is passed
  // from the `manage(this).render()` line in the `_render` function
  _viewRender: function(root, options) {
    var url, contents, def, renderedEl;
    var manager = root.__manager__;

    // This function is responsible for pairing the rendered template into
    // the DOM element.
    function applyTemplate(rendered) {
      // Actually put the rendered contents into the element.
      if (_.isString(rendered)) {
        // If no container is specified, we must replace the content.
        if (manager.noel) {
          // Trim off the whitespace, since the contents are passed into `$()`.
          rendered = $.trim(rendered);

          // Hold a reference to created element as replaceWith doesn't return
          // new el.
          renderedEl = $(rendered);

          // Remove extra root elements.
          root.$el.slice(1).remove();

          // Swap out the View on the first top level element to avoid
          // duplication.
          root.$el.replaceWith(renderedEl);

          // Don't delegate events here - we'll do that in resolve()
          root.setElement(renderedEl, false);
        } else {
          options.html(root.$el, rendered);
        }
      }

      // Resolve only after fetch and render have succeeded.
      def.resolveWith(root, [root]);
    }

    // Once the template is successfully fetched, use its contents to proceed.
    // Context argument is first, since it is bound for partial application
    // reasons.
    function done(context, contents) {
      // Store the rendered template someplace so it can be re-assignable.
      var rendered;

      // Trigger this once the render method has completed.
      manager.callback = function(rendered) {
        // Clean up asynchronous manager properties.
        delete manager.isAsync;
        delete manager.callback;

        applyTemplate(rendered);
      };

      // Ensure the cache is up-to-date.
      LayoutManager.cache(url, contents);

      // Render the View into the el property.
      if (contents) {
        rendered = options.renderTemplate.call(root, contents, context);
      }

      // If the function was synchronous, continue execution.
      if (!manager.isAsync) {
        applyTemplate(rendered);
      }
    }

    return {
      // This `render` function is what gets called inside of the View render,
      // when `manage(this).render` is called.  Returns a promise that can be
      // used to know when the element has been rendered into its parent.
      render: function() {
        var context = root.serialize || options.serialize;
        var template = root.template || options.template;

        // Create a deferred specifically for fetching.
        def = options.deferred();

        // If data is a function, immediately call it.
        if (_.isFunction(context)) {
          context = context.call(root);
        }

        // Set the internal callback to trigger once the asynchronous or
        // synchronous behavior has completed.
        manager.callback = function(contents) {
          // Clean up asynchronous manager properties.
          delete manager.isAsync;
          delete manager.callback;

          done(context, contents);
        };

        // Set the url to the prefix + the view's template property.
        if (typeof template === "string") {
          url = options.prefix + template;
        }

        // Check if contents are already cached and if they are, simply process
        // the template with the correct data.
        if (contents = LayoutManager.cache(url)) {
          done(context, contents, url);

          return def;
        }

        // Fetch layout and template contents.
        if (typeof template === "string") {
          contents = options.fetchTemplate.call(root, options.prefix +
            template);
        // If the template is already a function, simply call it.
        } else if (typeof template === "function") {
          contents = template;
        // If its not a string and not undefined, pass the value to `fetch`.
        } else if (template != null) {
          contents = options.fetchTemplate.call(root, template);
        }

        // If the function was synchronous, continue execution.
        if (!manager.isAsync) {
          done(context, contents);
        }

        return def;
      }
    };
  },

  // Remove all nested Views.
  _removeViews: function(root, force) {
    // Shift arguments around.
    if (typeof root === "boolean") {
      force = root;
      root = this;
    }

    // Allow removeView to be called on instances.
    root = root || this;

    // Iterate over all of the nested View's and remove.
    root.getViews().each(function(view) {
      // Force doesn't care about if a View has rendered or not.
      if (view.hasRendered || force) {
        LayoutManager._removeView(view, force);
      }
    });
  },

  // Remove a single nested View.
  _removeView: function(view, force) {
    var parentViews;
    // Shorthand the managers for easier access.
    var manager = view.__manager__;
    var rentManager = manager.parent && manager.parent.__manager__;
    // Test for keep.
    var keep = typeof view.keep === "boolean" ? view.keep : view.options.keep;

    // In insert mode, remove views that do not have `keep` attribute set,
    // unless the force flag is set.
    if ((!keep && rentManager && rentManager.insert === true) || force) {
      // Clean out the events.
      LayoutManager.cleanViews(view);

      // Since we are removing this view, force subviews to remove
      view._removeViews(true);

      // Remove the View completely.
      view.$el.remove();

      // Bail out early if no parent exists.
      if (!manager.parent) { return; }

      // Assign (if they exist) the sibling Views to a property.
      parentViews = manager.parent.views[manager.selector];

      // If this is an array of items remove items that are not marked to
      // keep.
      if (_.isArray(parentViews)) {
        // Remove duplicate Views.
        return _.each(_.clone(parentViews), function(view, i) {
          // If the managers match, splice off this View.
          if (view && view.__manager__ === manager) {
            aSplice.call(parentViews, i, 1);
          }
        });
      }

      // Otherwise delete the parent selector.
      delete manager.parent.views[manager.selector];
    }
  },

  // Cache templates into LayoutManager._cache.
  cache: function(path, contents) {
    // If template path is found in the cache, return the contents.
    if (path in this._cache && contents == null) {
      return this._cache[path];
    // Ensure path and contents aren't undefined.
    } else if (path != null && contents != null) {
      return this._cache[path] = contents;
    }

    // If the template is not in the cache, return undefined.
  },

  // Accept either a single view or an array of views to clean of all DOM
  // events internal model and collection references and all Backbone.Events.
  cleanViews: function(views) {
    // Clear out all existing views.
    _.each(aConcat.call([], views), function(view) {
      var cleanup;

      // Remove all custom events attached to this View.
      view.unbind();

      // Automatically unbind `model`.
      if (view.model instanceof Backbone.Model) {
        view.model.off(null, null, view);
      }

      // Automatically unbind `collection`.
      if (view.collection instanceof Backbone.Collection) {
        view.collection.off(null, null, view);
      }

      // Automatically unbind events bound to this View.
      view.stopListening();

      // If a custom cleanup method was provided on the view, call it after
      // the initial cleanup is done
      cleanup = view.getAllOptions().cleanup;
      if (_.isFunction(cleanup)) {
        cleanup.call(view);
      }
    });
  },

  // This static method allows for global configuration of LayoutManager.
  configure: function(options) {
    _.extend(LayoutManager.prototype.options, options);

    // Allow LayoutManager to manage Backbone.View.prototype.
    if (options.manage) {
      Backbone.View.prototype.manage = true;
    }

    // Disable the element globally.
    if (options.el === false) {
      Backbone.View.prototype.el = false;
    }

    // Allow global configuration of `suppressWarnings`.
    if (options.suppressWarnings === true) {
      Backbone.View.prototype.suppressWarnings = true;
    }
  },

  // Configure a View to work with the LayoutManager plugin.
  setupView: function(views, options) {
    // Set up all Views passed.
    _.each(aConcat.call([], views), function(view) {
      // If the View has already been setup, no need to do it again.
      if (view.__manager__) {
        return;
      }

      var views, declaredViews, viewOptions;
      var proto = LayoutManager.prototype;
      var viewOverrides = _.pick(view, keys);

      // Ensure necessary properties are set.
      _.defaults(view, {
        // Ensure a view always has a views object.
        views: {},

        // Ensure a view always has a sections object.
        sections: {},

        // Internal state object used to store whether or not a View has been
        // taken over by layout manager and if it has been rendered into the
        // DOM.
        __manager__: {},

        // Add the ability to remove all Views.
        _removeViews: LayoutManager._removeViews,

        // Add the ability to remove itself.
        _removeView: LayoutManager._removeView

      // Mix in all LayoutManager prototype properties as well.
      }, LayoutManager.prototype);

      // Extend the options with the prototype and passed options.
      options = view.options = _.defaults(options || {}, view.options,
        proto.options);

      // Ensure view events are properly copied over.
      viewOptions = _.pick(options, aConcat.call(["events", "sections"],
        _.values(options.events)));

      // Merge the View options into the View.
      _.extend(view, viewOptions);

      // Pick out the specific properties that can be dynamically added at
      // runtime and ensure they are available on the view object.
      _.extend(options, viewOverrides);

      // By default the original Remove function is the Backbone.View one.
      view._remove = Backbone.View.prototype.remove;

      // Ensure the render is always set correctly.
      view.render = LayoutManager.prototype.render;

      // If the user provided their own remove override, use that instead of
      // the default.
      if (view.remove !== proto.remove) {
        view._remove = view.remove;
        view.remove = proto.remove;
      }

      // Normalize views to exist on either instance or options, default to
      // options.
      views = options.views || view.views;

      // Set the internal views, only if selectors have been provided.
      if (_.keys(views).length) {
        // Keep original object declared containing Views.
        declaredViews = views;

        // Reset the property to avoid duplication or overwritting.
        view.views = {};

        // Set the declared Views.
        view.setViews(declaredViews);
      }

      // If a template is passed use that instead.
      if (view.options.template) {
        view.options.template = options.template;
      // Ensure the template is mapped over.
      } else if (view.template) {
        options.template = view.template;
      }
    });
  }
});

// Tack on the version.
LayoutManager.VERSION = "0.9.1";

Backbone.Layout = LayoutManager;

// Override _configure to provide extra functionality that is necessary in
// order for the render function reference to be bound during initialize.
Backbone.View.prototype._configure = function(options) {
  var noel, retVal;

  // Remove the container element provided by Backbone.
  if ("el" in options ? options.el === false : this.el === false) {
    noel = true;
  }

  // Run the original _configure.
  retVal = _configure.apply(this, arguments);

  // If manage is set, do it!
  if (options.manage || this.manage) {
    // Set up this View.
    LayoutManager.setupView(this);
  }

  // Assign the `noel` property once we're sure the View we're working with is
  // managed by LayoutManager.
  if (this.__manager__) {
    this.__manager__.noel = noel;
    this.__manager__.suppressWarnings = options.suppressWarnings;
  }

  // Act like nothing happened.
  return retVal;
};

// Default configuration options; designed to be overriden.
LayoutManager.prototype.options = {
  // Prefix template/layout paths.
  prefix: "",

  // Can be used to supply a different deferred implementation.
  deferred: function() {
    return $.Deferred();
  },

  // Fetch is passed a path and is expected to return template contents as a
  // function or string.
  fetchTemplate: function(path) {
    return _.template($(path).html());
  },

  // By default, render using underscore's templating.
  renderTemplate: function(template, context) {
    return template(context);
  },

  // This is the most common way you will want to partially apply a view into
  // a layout.
  partial: function($root, $el, rentManager, manager) {
    var $filtered;

    // If selector is specified, attempt to find it.
    if (manager.selector) {
      if (rentManager.noel) {
        $filtered = $root.filter(manager.selector);
        $root = $filtered.length ? $filtered : $root.find(manager.selector);
      } else {
        $root = $root.find(manager.selector);
      }
    }

    // Use the insert method if the parent's `insert` argument is true.
    if (rentManager.insert) {
      this.insert($root, $el);
    } else {
      this.html($root, $el);
    }
  },

  // Override this with a custom HTML method, passed a root element and content
  // (a jQuery collection or a string) to replace the innerHTML with.
  html: function($root, content) {
    $root.html(content);
  },

  // Used for inserting subViews in a single batch.  This gives a small
  // performance boost as we write to a disconnected fragment instead of to the
  // DOM directly. Smarter browsers like Chrome will batch writes internally
  // and layout as seldom as possible, but even in that case this provides a
  // decent boost.  jQuery will use a DocumentFragment for the batch update,
  // but Cheerio in Node will not.
  htmlBatch: function(rootView, subViews, selector) {
    // Shorthand the parent manager object.
    var rentManager = rootView.__manager__;
    // Create a simplified manager object that tells partial() where
    // place the elements.
    var manager = { selector: selector };

    // Get the elements to be inserted into the root view.
    var els = _.reduce(subViews, function(memo, sub) {
      // Check if keep is present - do boolean check in case the user
      // has created a `keep` function.
      var keep = typeof sub.keep === "boolean" ? sub.keep : sub.options.keep;
      // If a subView is present, don't push it.  This can only happen if
      // `keep: true`.  We do the keep check for speed as $.contains is not
      // cheap.
      var exists = keep && $.contains(rootView.el, sub.el);

      // If there is an element and it doesn't already exist in our structure
      // attach it.
      if (sub.el && !exists) {
        memo.push(sub.el);
      }

      return memo;
    }, []);

    // Use partial to apply the elements. Wrap els in jQ obj for cheerio.
    return this.partial(rootView.$el, $(els), rentManager, manager);
  },

  // Very similar to HTML except this one will appendChild by default.
  insert: function($root, $el) {
    $root.append($el);
  },

  // Return a deferred for when all promises resolve/reject.
  when: function(promises) {
    return $.when.apply(null, promises);
  },

  // A method to determine if a View contains another.
  contains: function(parent, child) {
    return $.contains(parent, child);
  }
};

// Maintain a list of the keys at define time.
keys = _.keys(LayoutManager.prototype.options);

// Assign `LayoutManager` object for AMD loaders.
return LayoutManager;

}));
define('core/UIView',['require','exports','module','backbone','handlebars','plugins/backbone.layoutmanager'],function(require, exports, module) {

  

  var Backbone = require('backbone');
  var Handlebars = require('handlebars');

  require('plugins/backbone.layoutmanager');

  module.exports = Backbone.Layout.extend({
    // base template route
    prefix: 'app/core/uis/',
    // Handlebars template source
    templateSource: null,
    templateCompileOptions: {},
    // Base Tag that the template resides within
    tagName: 'div',
    // Attributes applied to the base tag
    attributes: {
      class: 'field'
    },
    name: null,
    columnSchema: null,
    model: null,
    settings: null,

    isRequired: function() {
      return this.columnSchema.get('required') === true;
    },

   /**
    * Default constructor
    * @param options
    * @param options.model      The model *
    * @param options.name       The attribute of the model *
    * @param options.structure  The Column Collection for the table
    * @param options.schema     The Column Model for the attribute
    * @param options.value      The value of the attribtue
    * @param options.collection The collection that the model belong to
    * @param options.canWrite   Should the UI be writable?
    * @param options.settings   UI Settings
    */
    constructor: function UIView(options) {
      var structure = options.model.getStructure() || options.model.structure || options.structure;
      this.name = options.name;
      this.columnSchema = structure.get(this.name);
      this.settings = this.columnSchema.options;
      this.isRelational = (this.columnSchema.relationship !== undefined);
      this.templateCompileOptions = this.templateCompileOptions || {};
      if (this.templateSource) {
        this.template = Handlebars.compile(this.templateSource, this.templateCompileOptions);
      }

      // Default LayoutManager constructor
      UIView.__super__.constructor.call(this, options);
    }
  });
});

//  Text Input Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('placeholder_text') [any key from this UI options]
// options.name       String            Field name
/*jshint multistr: true */

define('core/uis/textinput',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  // Template Used for this UI
  var template = '<div class="char-count-container {{size}}"> \
                    <input type="text" placeholder="{{placeholder}}" value="{{value}}" name="{{name}}" id="{{name}}" maxLength="{{maxLength}}" class="{{size}}" {{#if readonly}}readonly{{/if}}/> \
                  {{#if length}}<span class="char-count hide">{{characters}}</span>{{/if}}</div>';

  var Input = UIView.extend({
    templateSource: template,

    // Event Declarations
    events: {
      // Show character counter when input gains focus
      'focus input': function() { this.$el.find('.char-count').removeClass('hide'); },
      // Update character counter when input changes
      'input input': 'updateMaxLength',
      // Validate keypress against validation_string
      'keypress input': 'validateString',
      // Hide character counter when input loses focus
      'blur input': function() { this.$el.find('.char-count').addClass('hide'); }
    },

    // Update the character counter with the remaining characters available
    updateMaxLength: function(e) {
      if (this.maxCharLength) {
        var charsLeft = this.maxCharLength - e.target.value.length;
        this.$el.find('.char-count').html(charsLeft);
      }
    },

    // Called before template is rendered, serialize returns an object that gets used as data for template string
    serialize: function() {
      var length = this.maxCharLength;
      var value = this.options.value || '';

      // Fill in default value if this column has a default value.
      if ( !value && this.options.model.isNew() && this.options.schema.has('default_value')) {
          value = this.options.schema.get('default_value');
      }

      return {
        size: this.options.settings.get('size'),
        value: value,
        name: this.options.name,
        maxLength: length,
        characters: length - value.toString().length,
        comment: this.options.schema.get('comment'),
        readonly: ((this.options.settings && this.options.settings.get('readonly') === true) || !this.options.canWrite),
        placeholder: (this.options.settings) ? this.options.settings.get('placeholder_text') : ''
      };
    },
    // Validate String  Checks the passed in value against validation_string
    // @param e : keypress event object
    validateString: function(e) {
      var validationMessage = this.options.settings.get('validation_message') || app.DEFAULT_VALIDATION_MESSAGE;
      var chars;
      switch(this.options.settings.get('validation_type')) {
        case ('bl') :
          chars = this.options.settings.get('validation_string').split("");
          return $.inArray(String.fromCharCode(e.which), chars) === -1;
        case ('wl') :
          chars = this.options.settings.get('validation_string').split("");
          return $.inArray(String.fromCharCode(e.which), chars) !== -1;
      }

      return true;
    },

    initialize: function() {
      this.maxCharLength = this.options.schema.get('char_length');
    }
  });

  var Component = UIComponent.extend({
    id: 'textinput',
    dataTypes: ['VARCHAR', 'CHAR', 'DATE', 'TIME', 'ENUM'],
    variables: [
      // Disables editing of the field while still letting users see the value (true = readonly)
      {id: 'readonly', type: 'Boolean', default_value: false, ui: 'checkbox'},
      // Adjusts the max width of the input (Small, Medium, Large)
      {id: 'size', type: 'String', default_value: 'large', ui: 'select', options: {options: {'large':__t('size_large'),'medium':__t('size_medium'),'small':__t('size_small')} }},
      // Grayed out default placeholder text in the input when it's empty
      {id: 'placeholder_text', type: 'String', default_value: '', ui: 'textinput', char_length:200},
      // Chooses the type of validation used on this field
      // * Character Blacklist: Choose the specific characters **not** allowed in the input
      // * Character Whitelist: Choose the specific characters allowed in the input
      // * RegEx: Create a regular expression to validate the value. Useful for emails, phone number formatting, or almost anything
      {id: 'validation_type', type: 'String', ui: 'select', options: {options: {'bl':__t('character_blacklist'),'wl':__t('character_whitelist'),'rgx':__t('regex')} }, default_value:'rgx'},
      // Holds the CSV list of Whitelist/Blacklist characters or the RegEx value (based on the above option)
      {id: 'validation_string', type: 'String', default_value: '', ui: 'textinput', char_length:200, comment: __t('textinput_validation_string_comment')},
      // A message that is shown to the user if the validation fails
      {id: 'validation_message', type: 'String', default_value: '', ui: 'textinput', char_length:200}
    ],
    Input: Input,
    validate: function(value, options) {
      var validationMessage = options.settings.get('validation_message') || app.DEFAULT_VALIDATION_MESSAGE;

      if (_.isEmpty(value)) {
        if (options.schema.get('required') === true) {
          return validationMessage;
        }

        return;
      }

      switch(options.settings.get('validation_type')) {
        case ('wl') :
          var Regex = new RegExp("^["+options.settings.get('validation_string')+"]+$");
          if(!value.match(Regex)) {
            return validationMessage;
          }
          break;
        case ('bl') :
          var chars = options.settings.get('validation_string').split("");
          if(chars.length > 0 && value.match(chars.join("|"))) {
            return validationMessage;
          }
          break;
        case ('rgx'):
          var regex = new RegExp(options.settings.get('validation_string'));
          if (!regex.test(value)) {
            return validationMessage;
          }
          break;
      }
    },
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

//  Date core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('length') [any key from this UI options]
// options.name       String            Field name


define('core/uis/directus_columns',['app', 'core/UIComponent', 'core/UIView'], function(app, UIComponent, UIView) {

  

  var template =  '{{#columns}}<label><input type="checkbox" name="{{../name}}" value="{{columnName}}" {{#if selected}}checked{{/if}}>{{title}}</label>{{/columns}}';

  var Input = UIView.extend({
    templateSource: template,

    events: {},

    serialize: function() {
      return {
        name: this.options.name,
        note: this.options.schema.get('comment'),
        columns: this.columns
      };
    },

    initialize: function(options) {
      var table = options.model.getTable();
      var tableName = table.id;
      var columns = app.schemaManager.getColumns[tableName].pluck('column_name');
      var selected = this.options.value ? this.options.value.split(',') : [];

      this.columns = _.map(columns, function(value) {
        var item = {
          columnName: value,
          title: app.capitalize(value)
        };

        if (_.contains(selected, value)) item.selected = true;

        return item;
      });
    }
  });

  var Component = UIComponent.extend({
    id: 'directus_columns',
    dataTypes: ['VARCHAR'],
    Input: Input,
  });

  return Component;

});

//  Color core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('length') [any key from this UI options]
// options.name       String            Field name

/*jshint multistr: true */

define('core/uis/instructions',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template =  '<style type="text/css"> \
                  .instructions-ui-content { \
                    line-height: 20px; \
                    max-width: 675px; \
                  } \
                  .instructions-ui-content h1 { \
                    margin: 10px 0 10px 0; \
                  } \
                  </style> \
                  <div class="instructions-ui-content">{{{instructions}}}</div>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      // 'change .color-box': function(e) {
      //   var color_str = e.target.value;
      //   this.$el.find('input.color-text').val(color_str);
      //   this.$el.find('span.invalid').html("");
      //   this.$el.find('input.color-text').removeClass("invalid");
      // }
    },

    afterRender: function() {
      //
    },

    serialize: function() {
      var value = this.options.value || '';

      return {
        value: value,
        name: this.options.name,
        comment: this.options.schema.get('comment'),
        instructions: this.options.settings.get('instructions') || __t('instructions_please_have_your_admin_setup_this_field')
      };
    },

    initialize: function() {
      //
    }
  });

  var Component = UIComponent.extend({
    id: 'instructions',
    dataTypes: ['VARCHAR', 'TEXT'],
    variables: [
      {id: 'instructions', type: 'String', default_value: '', ui: 'wysiwyg', options: {'h1':true,'ul':true,'ol':true }}
    ],
    Input: Input,
    list: function(options) {
      var instructions = options.settings.get('instructions') || '...';
      var regex = /(<([^>]+)>)/ig;

      return instructions.replace(regex, "");
    }
  });

  return Component;
});

//  Directus Utils
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('utils',[],function() {

  

  var Utils = {};

  Utils.encodeQueryParams = function (data) {
    var params = [];
    for (var k in data) {
      params.push(encodeURIComponent(k) + '=' + encodeURIComponent(data[k]));
    }
    return params.join('&');
  };

  // Source: https://github.com/petkaantonov/bluebird/wiki/Optimization-killers#3-managing-arguments
  Utils.argumentsToArray = function(argObject) {
    var args = new Array(argObject.length);

    for (var i = 0; i < args.length; i++) {
      args[i] = argObject[i];
    }

    return args;
  };

  /**
   * Convert string url into an Location (Anchor) Element.
   *
   * @param {string} url
   * @return {Element} location
   */
  Utils.convertURLToLocation = function(url) {
    var location = document.createElement('a');
    location.href = url;

    return location;
  };

  /**
   * Get Location (Anchor) Element or convert url to one.
   *
   * @param {string/location} url
   * @return {Element} new url
   */
  Utils.getLocation = function(url) {
    return url.href ? url : this.convertURLToLocation(url);
  };

  /**
   * Get array of params in a url
   *
   * @param {string}/{location} url
   * @return {Array} new url
   */
  Utils.getParams = function(url) {
    var location = this.getLocation(url);
    var querystring = location.search;

    var params = [];
    if (querystring && querystring.indexOf('?') === 0) {
      params = querystring.substr(1).split('&');
    }

    return params;
  };

  /**
   * Add a param to an url query string
   *
   * @param {string}/{location} url
   * @param {string} key - Param key
   * @param {string} value - New param value
   * @param {boolean} [encodeKey=true] - Whether to encode the param key.
   * @param {boolean} [encodeValue=true] - Whether to encode the param value.
   * @return {string} new url
   */
  Utils.addParam = function(url, key, value, encodeKey, encodeValue) {
    var location = this.getLocation(url);
    var params = this.getParams(url);
    var keyExistsAtIndex = -1;
    var paramFound = null;

    encodeKey = typeof encodeKey === 'undefined' ? true : !!encodeKey;
    encodeValue = typeof encodeValue  === 'undefined' ? true : !!encodeValue;

    if (params) {
      for (var index in params) {
        var param = params[index];
        var result = param.indexOf('=') ? param.split('=') : param;

        if (result[0] === key || result[0] === encodeURIComponent(key)) {
          keyExistsAtIndex = index;
          paramFound = result;
        }
      }
    }

    key = encodeKey ? encodeURIComponent(key) : key;
    value = encodeValue ? encodeURIComponent(value) : value;

    if (keyExistsAtIndex >= 0) {
      params[keyExistsAtIndex] = paramFound[0]+'='+value;
    } else {
      params.push(key+'='+value);
    }

    location.search = '?'+params.join('&');

    return location.href;
  };

  Utils.convertToBoolean = function(value) {
    return value == null ? false : value != false;
  };

  Utils.isEmpty = function(value) {
    return value == null || value === '';
  };

  Utils.clearElement = function(element) {
    element.wrap('<form>').closest('form').get(0).reset();
    element.unwrap();
  };

  return Utils;
});

//  Checkbox core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/checkbox/checkbox',['app', 'underscore', 'utils', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, _, Utils, UIComponent, UIView, __t) {
  

  var Input = UIView.extend({
    template: 'checkbox/input',

    events: {
      'change input[type=checkbox]': function(e) {
        var val = (this.$el.find('input[type=checkbox]:checked').val() === undefined) ? 0 : 1;
        this.$el.find('input[type=hidden]').val(val);
      }
    },

    isRequired: function() {
      var settings = this.options.settings;

      return settings.get('mandatory') === true;
    },

    serialize: function() {
      var value = this.options.value;

      // Get default value if there is one...
      if (value === undefined && this.options.schema.has('default_value')) {
        value = this.options.schema.get('default_value');
      }

      if (!_.isBoolean(value)) {
        value = Utils.convertToBoolean(value);
      }

      return {
        name: this.options.name,
        // Hotfix: We can't tell on the server if this option is a string or an actual number
        // TODO: Add a new field into `directus_ui` that state the type of the value
        selected: (value === true),
        comment: this.options.schema.get('comment'),
        readonly: !this.options.canWrite
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'checkbox',
    dataTypes: ['TINYINT'],
    variables: [
      {id: 'mandatory', type: 'Boolean', default_value: false, ui: 'checkbox', comment: 'if this field should always be checked by the user.'}
    ],
    Input: Input,
    validate: function(value, options) {
      // If a checkbox is mandatory, it MUST be checked to save
      // similar to "agree to terms" functionality
      if (options.view.isRequired() && value === 0) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      var listTemplateSource = '<input type="checkbox" {{#if selected}}checked="true"{{/if}} disabled>';

      return this.compileView(listTemplateSource, {selected: parseInt(options.value, 10) === 1});
    }
  });

  return Component;
});

//  Color core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('length') [any key from this UI options]
// options.name       String            Field name
/*jshint multistr: true */


define('core/uis/color',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template =  '<style type="text/css"> \
                  .position-offset { \
                    position: relative; \
                  } \
                  input.color-box { \
                    margin-left: 10px; \
                    width: 42px; \
                    height: 44px; \
                    padding: 10px; \
                    display: inline-block; \
                    left: 0; \
                    position: absolute; \
                  } \
                  input.color-text.invalid { \
                    border-color: #EB2A49; \
                  } \
                  input.color-text.invalid:focus { \
                    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(235,42,73,.3); \
                    -moz-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(235,42,73,.3); \
                    box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(235,42,73,.3); \
                  } \
                  span.invalid { \
                    color: #EB2A49; \
                    margin-left: 10px; \
                  } \
                  </style> \
                  <input type="text" class="color-text small" value="{{value}}" maxlength="7" placeholder="#bbbbbb"><span class="position-offset"><input type="color" class="color-box" value="{{value}}" name="{{name}}" id="{{name}}" placeholder="{{t "example_abbr"}}. #bbbbbb"></span> <span class="invalid"></span>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'change .color-text': function(e) {
        var color_str = e.target.value;
        if(color_str.match(/^#[a-f0-9]{6}$/i) !== null){
          this.$el.find('input.color-box').val(color_str);
          this.$el.find('span.invalid').html("");
          this.$el.find('input.color-text').removeClass("invalid");
        } else {
          this.$el.find('span.invalid').html(__t('color_invalid_color')+" <i>"+__t('example_abbr')+". #bbbbbb</i>");
          this.$el.find('input.color-text').addClass("invalid");
        }
      },
      'change .color-box': function(e) {
        var color_str = e.target.value;
        this.$el.find('input.color-text').val(color_str);
        this.$el.find('span.invalid').html("");
        this.$el.find('input.color-text').removeClass("invalid");
      }
    },

    afterRender: function() {
      //
    },

    serialize: function() {
      var value = this.options.value || '';

      return {
        value: value,
        name: this.options.name,
        comment: this.options.schema.get('comment')
      };
    },

    initialize: function() {
      //
    }
  });

  var Component = UIComponent.extend({
    id: 'color',
    dataTypes: ['VARCHAR'],
    variables: [
      // Disables editing of the field while still letting users see the value
      {id: 'readonly', type: 'Boolean', default_value: false, ui: 'checkbox'},
      // Shows a color box representation on the Item Listing page
      {id: 'show_color_on_list', type: 'Boolean', default_value: false, ui: 'checkbox'}
    ],
    Input: Input,
    validate: function(value, options) {
      // This doesn't work since the input type="color" has a default color which is black: #000000
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      return (options.settings.get('show_color_on_list') === true) ? '<div style="background-color:'+options.value+'; height:20px; width:40px; border:1px solid #ffffff;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;">&nbsp;</div>' : options.value;
    }
  });

  return Component;
});

//  Select Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/select',['app', 'underscore', 'core/UIComponent', 'core/UIView', 'core/t', 'utils'],function(app, _, UIComponent, UIView, __t, Utils) {

  

  var template = '<div class="select-container" style="margin-top: 4px;margin-bottom: 6px;"> \
                    <select name="{{name}}" {{#if readonly}}disabled{{/if}}>{{#if allow_null}}<option value="">{{placeholder_text}}</option>{{/if}}{{#options}}<option value="{{key}}" {{#if selected}}selected{{/if}}>{{value}}</option>{{/options}}</select> \
                    <i class="material-icons select-arrow">arrow_drop_down</i> \
                  </div>';

  var SHOW_SELECT_OPTIONS = {
    text: __t('select_ui_show_options_text'),
    value: __t('select_ui_show_options_value')
  };

  var parseOptions = function (options) {
    if (_.isString(options)) {
      try {
        options = $.parseJSON(options);
      } catch (e) {
        options = {};
        console.error(e);
      }
    }

    return options;
  };

  var Input = UIView.extend({
    templateSource: template,

    serialize: function() {
      var selectedValue = this.options.value;
      var options = this.options.settings.get('options');

      // if selectedValue is null
      // we use the schema default value
      // it should not be undefined.
      if (selectedValue === null) {
        selectedValue = this.options.schema.get('default_value');
      }

      options = parseOptions(options);

      options = _.map(options, function(value, key) {
        var item = {};

        item.value = value;
        item.key = key;
        item.selected = (item.key == selectedValue);

        return item;
      });

      return {
        options: options,
        name: this.options.name,
        comment: this.options.schema.get('comment'),
        readonly: !this.options.canWrite,
        allow_null: this.options.settings.get('allow_null') === true,
        placeholder_text: (this.options.settings.get('placeholder_text')) ?  this.options.settings.get('placeholder_text') : __t('select_from_below')
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'select',
    dataTypes: ['VARCHAR', 'INT'],
    variables: [
      {id: 'options', default_value: '', ui: 'textarea', options:{'rows': 25, 'placeholder_text': "{\n    \"value1\":\"Option One\",\n    \"value2\":\"Option Two\",\n    \"value3\":\"Option Three\"\n}"}, comment: __t('select_options_comment')},
      {id: 'allow_null', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'show', type: 'String', default_value: 'value', ui: 'select', options: {options: SHOW_SELECT_OPTIONS}},
      {id: 'placeholder_text', type: 'String', default_value: '', ui: 'textinput', char_length: 255, required: false, comment: __t('select_placeholder_text')}
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && Utils.isEmpty(value)) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      var value = _.isString(options.value) ? options.value.replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : options.value;

      if (options.settings.get('show') === 'text') {
        options = parseOptions(options.settings.get('options'));

        value = options[value];
      }

      return value;
    }
  });

  return Component;
});

define('core/uis/countries/interface',['app', 'underscore', 'core/uis/select'], function (app, _, SelectInterface) {

  // set (forced) the countries list as select options
  function setOptions(options) {

    options.settings.set('options', app.countries);

    return options;
  }

  var originalInput = SelectInterface.prototype.Input;

  var Input = originalInput.extend({
    initialize: function () {
      originalInput.prototype.initialize.apply(this, arguments);

      this.options = setOptions(this.options);
    }
  });

  return SelectInterface.extend({
    id: 'countries',

    dataTypes: ['CHAR', 'VARCHAR'],

    variables: _.filter(SelectInterface.prototype.variables, function (variable) {
      return variable.id !== 'options';
    }),

    Input: Input,

    list: function (options) {
      options = setOptions(options);

      return SelectInterface.prototype.list.apply(this, [options]);
    }
  });
});

//  Numeric core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/numeric',[
  'app',
  'underscore',
  'core/UIComponent',
  'core/UIView',
  'core/t'
], function(app, _, UIComponent, UIView, __t) {

  

  var template = '<input type="text" value="{{value}}" placeholder="{{placeholder}}" name="{{name}}" id="{{name}}" class="{{size}}" {{#if readonly}}readonly{{/if}}/>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'keyup input': 'checkChars',
      'blur input': 'checkChars'
    },

    checkChars: function() {
      var numeric = this.$el.find('input');
      var value = numeric.val();
      value = value.replace(/[^0-9-.]/ig, ""); // @TODO: regex needs to reflect datatype (no "." for INT, etc)
      numeric.val(value);
    },

    serialize: function() {
      var value = '';
      if(!isNaN(this.options.value)) {
        value = this.options.value;
      }

      // Fill in default value
      if (
        this.options.value === undefined &&
        this.options.schema.has('default_value')) {
          value = this.options.schema.get('default_value');
      }

      return {
        value: value,
        name: this.options.name,
        size: this.options.settings.get('size'),
        placeholder: (this.options.settings) ? this.options.settings.get('placeholder_text') : '',
        comment: this.options.schema.get('comment'),
        readonly: !this.options.canWrite
      };
    },

    initialize: function() {
      // this.hasDecimals = (['float', 'decimal', 'numeric'].indexOf(this.options.schema.get('type')) > -1);
    }
  });

  var Component = UIComponent.extend({
    id: 'numeric',
    dataTypes: [
      'TINYINT',
      'SMALLINT',
      'MEDIUMINT',
      'INT',
      'NUMERIC',
      'FLOAT',
      'YEAR',
      'VARCHAR',
      'CHAR',
      'DOUBLE',
      'BIGINT'
    ],
    variables: [
      {id: 'size', type: 'String', default_value: 'large', ui: 'select', options: {options: {'large':__t('size_large'),'medium':__t('size_medium'),'small':__t('size_small')} }},
      {id: 'placeholder_text', type: 'String', default_value: '', ui: 'textinput', char_length:200},
      {id: 'allow_null', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'localized', type: 'Boolean', default_value: true, ui: 'checkbox', comment: __t('numeric_localized_comment')}
    ],
    Input: Input,
    validate: function(value, options) {
      // _.isEmpty (in the installed version) does not support INTs properly
      if (options.schema.isRequired() && value != 0 && !value) {
        return __t('this_field_is_required');
      }
    },
    list: function (options) {
      var value = options.value;

      if (_.isNumber(value)) {
        value = Number(value);

        if (options.settings.get('localized')) {
          value = value.toLocaleString();
        }
      } else {
        value = '<span class="silver">--</span>';
      }

      return value;
    }
  });

  return Component;
});

//  Slider core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('length') [any key from this UI options]
// options.name       String            Field name
/*jshint multistr: true */


define('core/uis/slider',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template =  '<style type="text/css"> \
                  span.slider-value { \
                    margin-left: 10px; \
                  } \
                  input.slider { \
                    display: inline-block; \
                    vertical-align: middle; \
                  } \
                  </style> \
                  <input type="range" class="slider" value="{{value}}" name="{{name}}" id="{{name}}" min="{{min}}" max="{{max}}" step="{{step}}"> <span class="slider-value">{{value}}</span>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'change .slider': function(e) {
        var value = e.target.value;
        this.$el.find('span.slider-value').html(value);
      }
    },

    afterRender: function() {
      //
    },

    serialize: function() {
      if (this.options.model.isNew() && this.options.schema.has('default_value')) {
        this.options.value = this.options.schema.get('default_value');
      }

      return {
        value: this.options.value || '0',
        name: this.options.name,
        min: this.options.settings.get('minimum'),
        max: this.options.settings.get('maximum'),
        step: this.options.settings.get('step'),
        comment: this.options.schema.get('comment')
      };
    },

    initialize: function() {
      //
    }
  });

  var Component = UIComponent.extend({
    id: 'slider',
    dataTypes: ['INT'],
    variables: [
      {id: 'minimum', type: 'Number', default_value: 0, ui: 'numeric'},
      {id: 'maximum', type: 'Number', default_value: 100, ui: 'numeric'},
      {id: 'step', type: 'Number', default_value: 1, ui: 'numeric', comment: __t('slider_step_comment')}
    ],
    Input: Input,
    validate: function(value, options) {
      // Not needed since HTML5 slider defaults to "0"
      if (options.schema.isRequired() && !value) {
        return __t('this_field_is_required');
      }
    }
  });

  return Component;
});

define('helpers/file',['jquery'], function ($) {

  

  var FileHelper = {};

  FileHelper.isImage = function(image, fn) {
    if (this.isFileObject(image)) {
      var imageType = /image.*/;
      if (image.type.match(imageType)) {
        fn(true, image);
      } else {
        fn(false, image);
      }
    } else {
      var img = new Image();
      img.onload = function() {
        fn(true, image);
      }

      img.onerror = function() {
        fn(false, image);
      }

      img.src = image;
    }
  };

  FileHelper.isFileObject = function(file) {
    return typeof File !== 'undefined' ? file instanceof File : false;
  };

  FileHelper.getDataFromInput = function(inputFile, fn) {
    var imageDetails = {
      width: 0,
      height: 0
    };
    var self = this;

    this.isImage(inputFile, function(isImage) {
      var reader = new FileReader();
      reader.onload = function() {
        if (isImage) {
          self.getImageDetails(reader.result, function(imageDetails) {
            fn(reader.result,  imageDetails, inputFile);
          });
        } else {
          fn(reader.result, imageDetails, inputFile);
        }
      }

      reader.readAsDataURL(inputFile);
    });
  };

  FileHelper.getDataFromURL = function(url, fn) {
    var self = this;
    this.isImage(url, function(isImage) {
      self.getImageDetails(url, function(imageDetails) {
        imageDetails.name = imageDetails.title = url.substring(url.lastIndexOf('/')+1);
        fn(url, imageDetails);
      });
    });
  };

  FileHelper.getImageDetails = function(image, fn) {
    var img = new Image();
    var self = this;

    img.onerror = function() {
      fn(null, image);
    };

    img.onload = function() {
      var details = {
        width: this.width,
        height: this.height
      };

      var canvas = document.createElement('canvas');
      canvas.width = this.width;
      canvas.height = this.height;
      var ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, this.width, this.height);

      var dataurl = canvas.toDataURL('image/jpg');
      details.data = dataurl;
      details.size = self.getSizeFromData(dataurl);

      fn(details, image);
    };

    img.src = image;
  };

  // this method try to fit a image
  // into a box [width]x[height]
  // no fancy resizing
  FileHelper.resizeFromData = function(image, thumbnailWidth, thumbnailHeight, fn) {
    var img = new Image();

    img.onload = function() {
      var MAX_WIDTH = thumbnailWidth;
      var MAX_HEIGHT = thumbnailHeight;
      var width = this.width;
      var height = this.height;
      var x = 0;
      var y = 0;

      if (width > height) {
        if (width > MAX_WIDTH) {
          width *= MAX_HEIGHT / height;
          height = MAX_HEIGHT;
          x = -(width/2 - MAX_WIDTH/2);
        }
      } else if (width < height) {
        if (height > MAX_HEIGHT) {
          height *= MAX_WIDTH / width;
          width = MAX_WIDTH;
          y = -(height/2 - MAX_HEIGHT/2);
        }
      } else {
        width = MAX_WIDTH;
        height = MAX_HEIGHT;
      }

      var canvas = document.createElement('canvas');
      canvas.width = MAX_WIDTH;
      canvas.height = MAX_HEIGHT;
      var ctx = canvas.getContext('2d');
      ctx.drawImage(img, x, y, width, height);

      var dataurl = canvas.toDataURL('image/jpg');
      fn(dataurl);
    }

    img.onerror = function() {
      fn(null);
    }

    img.src = image;
  };

  // Source: https://en.wikipedia.org/wiki/Base64#MIME
  // The size of the decoded data can be approximated with this formula:
  FileHelper.getSizeFromData = function(data) {
    return (data.length - 814) / 1.37;
  };

  FileHelper.humanBytesInfo = function(size, precision) {
    precision = precision || 2;
    var i = 0;
    var humanSize;
    var unit;

    while ((size/1024) > 0.9) {
      size /= 1024;
      i++;
    }

    humanSize = Math.round(size);
    unit = getUnit(i);

    return {
      size: humanSize.toFixed(precision),
      unit: unit
    }
  };

  function getUnit(index) {
    return ['B','KB','MB','GB','TB','PB','EB','ZB','YB'][index];
  }

  FileHelper.onImageError = function (elements, fn) {
    $(elements).one('error', function (event) {
      fn.apply(event.target, [event, event.target]);
    });
  };

  FileHelper.hideOnImageError = function (elements) {
    this.onImageError(elements, function () {
      $(this).hide();
    });
  };

  return FileHelper;
});

/*!
 @package noty - jQuery Notification Plugin
 @version version: 2.3.0
 @contributors https://github.com/needim/noty/graphs/contributors

 @documentation Examples and Documentation - http://needim.github.com/noty/

 @license Licensed under the MIT licenses: http://www.opensource.org/licenses/mit-license.php
 */

    if(typeof Object.create !== 'function') {
        Object.create = function(o) {
            function F() {
            }

            F.prototype = o;
            return new F();
        };
    }

    var NotyObject = {

        init: function(options) {

            // Mix in the passed in options with the default options
            this.options = $.extend({}, $.noty.defaults, options);

            this.options.layout = (this.options.custom) ? $.noty.layouts['inline'] : $.noty.layouts[this.options.layout];

            if($.noty.themes[this.options.theme])
                this.options.theme = $.noty.themes[this.options.theme];
            else
                options.themeClassName = this.options.theme;

            delete options.layout;
            delete options.theme;

            this.options = $.extend({}, this.options, this.options.layout.options);
            this.options.id = 'noty_' + (new Date().getTime() * Math.floor(Math.random() * 1000000));

            this.options = $.extend({}, this.options, options);

            // Build the noty dom initial structure
            this._build();

            // return this so we can chain/use the bridge with less code.
            return this;
        }, // end init

        _build: function() {

            // Generating noty bar
            var $bar = $('<div class="noty_bar noty_type_' + this.options.type + '"></div>').attr('id', this.options.id);
            $bar.append(this.options.template).find('.noty_text').html(this.options.text);

            this.$bar = (this.options.layout.parent.object !== null) ? $(this.options.layout.parent.object).css(this.options.layout.parent.css).append($bar) : $bar;

            if(this.options.themeClassName)
                this.$bar.addClass(this.options.themeClassName).addClass('noty_container_type_' + this.options.type);

            // Set buttons if available
            if(this.options.buttons) {

                // If we have button disable closeWith & timeout options
                this.options.closeWith = [];
                this.options.timeout = false;

                var $buttons = $('<div/>').addClass('noty_buttons');

                (this.options.layout.parent.object !== null) ? this.$bar.find('.noty_bar').append($buttons) : this.$bar.append($buttons);

                var self = this;

                $.each(this.options.buttons, function(i, button) {
                    var $button = $('<button/>').addClass((button.addClass) ? button.addClass : 'gray').html(button.text).attr('id', button.id ? button.id : 'button-' + i)
                        .appendTo(self.$bar.find('.noty_buttons'))
                        .on('click', function() {
                            if($.isFunction(button.onClick)) {
                                button.onClick.call($button, self);
                            }
                        });
                });
            }

            // For easy access
            this.$message = this.$bar.find('.noty_message');
            this.$closeButton = this.$bar.find('.noty_close');
            this.$buttons = this.$bar.find('.noty_buttons');

            $.noty.store[this.options.id] = this; // store noty for api

        }, // end _build

        show: function() {

            var self = this;

            (self.options.custom) ? self.options.custom.find(self.options.layout.container.selector).append(self.$bar) : $(self.options.layout.container.selector).append(self.$bar);

            if(self.options.theme && self.options.theme.style)
                self.options.theme.style.apply(self);

            ($.type(self.options.layout.css) === 'function') ? this.options.layout.css.apply(self.$bar) : self.$bar.css(this.options.layout.css || {});

            self.$bar.addClass(self.options.layout.addClass);

            self.options.layout.container.style.apply($(self.options.layout.container.selector));

            self.showing = true;

            if(self.options.theme && self.options.theme.style)
                self.options.theme.callback.onShow.apply(this);

            if($.inArray('click', self.options.closeWith) > -1)
                self.$bar.css('cursor', 'pointer').one('click', function(evt) {
                    self.stopPropagation(evt);
                    if(self.options.callback.onCloseClick) {
                        self.options.callback.onCloseClick.apply(self);
                    }
                    self.close();
                });

            if($.inArray('hover', self.options.closeWith) > -1)
                self.$bar.one('mouseenter', function() {
                    self.close();
                });

            if($.inArray('button', self.options.closeWith) > -1)
                self.$closeButton.one('click', function(evt) {
                    self.stopPropagation(evt);
                    self.close();
                });

            if($.inArray('button', self.options.closeWith) == -1)
                self.$closeButton.remove();

            if(self.options.callback.onShow)
                self.options.callback.onShow.apply(self);

            if (typeof self.options.animation.open == 'string') {
                self.$bar.css('height', self.$bar.innerHeight());
                self.$bar.show().addClass(self.options.animation.open).one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
                    if(self.options.callback.afterShow) self.options.callback.afterShow.apply(self);
                    self.showing = false;
                    self.shown = true;
                });

            } else {
                self.$bar.animate(
                    self.options.animation.open,
                    self.options.animation.speed,
                    self.options.animation.easing,
                    function() {
                        if(self.options.callback.afterShow) self.options.callback.afterShow.apply(self);
                        self.showing = false;
                        self.shown = true;
                    });
            }

            // If noty is have a timeout option
            if(self.options.timeout)
                self.$bar.delay(self.options.timeout).promise().done(function() {
                    self.close();
                });

            return this;

        }, // end show

        close: function() {

            if(this.closed) return;
            if(this.$bar && this.$bar.hasClass('i-am-closing-now')) return;

            var self = this;

            if(this.showing) {
                self.$bar.queue(
                    function() {
                        self.close.apply(self);
                    }
                );
                return;
            }

            this.$bar.dequeue();

            if(!this.shown && !this.showing) { // If we are still waiting in the queue just delete from queue
                var queue = [];
                $.each($.noty.queue, function(i, n) {
                    if(n.options.id != self.options.id) {
                        queue.push(n);
                    }
                });
                $.noty.queue = queue;
                return;
            }

            self.$bar.addClass('i-am-closing-now');

            if(self.options.callback.onClose) {
                self.options.callback.onClose.apply(self);
            }

            if (typeof self.options.animation.close == 'string') {
                self.$bar.addClass(self.options.animation.close).one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
                    if(self.options.callback.afterClose) self.options.callback.afterClose.apply(self);
                    self.closeCleanUp();
                });
            } else {
                self.$bar.clearQueue().stop().animate(
                    self.options.animation.close,
                    self.options.animation.speed,
                    self.options.animation.easing,
                    function() {
                        if(self.options.callback.afterClose) self.options.callback.afterClose.apply(self);
                    })
                    .promise().done(function() {
                        self.closeCleanUp();
                    });
            }

        }, // end close

        closeCleanUp: function() {

            var self = this;

            // Modal Cleaning
            if(self.options.modal) {
                $.notyRenderer.setModalCount(-1);
                if($.notyRenderer.getModalCount() == 0) $('.noty_modal').fadeOut('fast', function() {
                    $(this).remove();
                });
            }

            // Layout Cleaning
            $.notyRenderer.setLayoutCountFor(self, -1);
            if($.notyRenderer.getLayoutCountFor(self) == 0) $(self.options.layout.container.selector).remove();

            // Make sure self.$bar has not been removed before attempting to remove it
            if(typeof self.$bar !== 'undefined' && self.$bar !== null) {

                if (typeof self.options.animation.close == 'string') {
                    self.$bar.css('transition', 'all 100ms ease').css('border', 0).css('margin', 0).height(0);
                    self.$bar.one('transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd', function() {
                        self.$bar.remove();
                        self.$bar = null;
                        self.closed = true;

                        if(self.options.theme.callback && self.options.theme.callback.onClose) {
                            self.options.theme.callback.onClose.apply(self);
                        }
                    });
                } else {
                    self.$bar.remove();
                    self.$bar = null;
                    self.closed = true;
                }
            }

            delete $.noty.store[self.options.id]; // deleting noty from store

            if(self.options.theme.callback && self.options.theme.callback.onClose) {
                self.options.theme.callback.onClose.apply(self);
            }

            if(!self.options.dismissQueue) {
                // Queue render
                $.noty.ontap = true;

                $.notyRenderer.render();
            }

            if(self.options.maxVisible > 0 && self.options.dismissQueue) {
                $.notyRenderer.render();
            }

        }, // end close clean up

        setText: function(text) {
            if(!this.closed) {
                this.options.text = text;
                this.$bar.find('.noty_text').html(text);
            }
            return this;
        },

        setType: function(type) {
            if(!this.closed) {
                this.options.type = type;
                this.options.theme.style.apply(this);
                this.options.theme.callback.onShow.apply(this);
            }
            return this;
        },

        setTimeout: function(time) {
            if(!this.closed) {
                var self = this;
                this.options.timeout = time;
                self.$bar.delay(self.options.timeout).promise().done(function() {
                    self.close();
                });
            }
            return this;
        },

        stopPropagation: function(evt) {
            evt = evt || window.event;
            if(typeof evt.stopPropagation !== "undefined") {
                evt.stopPropagation();
            }
            else {
                evt.cancelBubble = true;
            }
        },

        closed : false,
        showing: false,
        shown  : false

    }; // end NotyObject

    $.notyRenderer = {};

    $.notyRenderer.init = function(options) {

        // Renderer creates a new noty
        var notification = Object.create(NotyObject).init(options);

        if(notification.options.killer)
            $.noty.closeAll();

        (notification.options.force) ? $.noty.queue.unshift(notification) : $.noty.queue.push(notification);

        $.notyRenderer.render();

        return ($.noty.returns == 'object') ? notification : notification.options.id;
    };

    $.notyRenderer.render = function() {

        var instance = $.noty.queue[0];

        if($.type(instance) === 'object') {
            if(instance.options.dismissQueue) {
                if(instance.options.maxVisible > 0) {
                    if($(instance.options.layout.container.selector + ' li').length < instance.options.maxVisible) {
                        $.notyRenderer.show($.noty.queue.shift());
                    }
                    else {

                    }
                }
                else {
                    $.notyRenderer.show($.noty.queue.shift());
                }
            }
            else {
                if($.noty.ontap) {
                    $.notyRenderer.show($.noty.queue.shift());
                    $.noty.ontap = false;
                }
            }
        }
        else {
            $.noty.ontap = true; // Queue is over
        }

    };

    $.notyRenderer.show = function(notification) {

        if(notification.options.modal) {
            $.notyRenderer.createModalFor(notification);
            $.notyRenderer.setModalCount(+1);
        }

        // Where is the container?
        if(notification.options.custom) {
            if(notification.options.custom.find(notification.options.layout.container.selector).length == 0) {
                notification.options.custom.append($(notification.options.layout.container.object).addClass('i-am-new'));
            }
            else {
                notification.options.custom.find(notification.options.layout.container.selector).removeClass('i-am-new');
            }
        }
        else {
            if($(notification.options.layout.container.selector).length == 0) {
                $('body').append($(notification.options.layout.container.object).addClass('i-am-new'));
            }
            else {
                $(notification.options.layout.container.selector).removeClass('i-am-new');
            }
        }

        $.notyRenderer.setLayoutCountFor(notification, +1);

        notification.show();
    };

    $.notyRenderer.createModalFor = function(notification) {
        if($('.noty_modal').length == 0) {
            var modal = $('<div/>').addClass('noty_modal').addClass(notification.options.theme).data('noty_modal_count', 0);

            if(notification.options.theme.modal && notification.options.theme.modal.css)
                modal.css(notification.options.theme.modal.css);

            modal.prependTo($('body')).fadeIn('fast');

            if($.inArray('backdrop', notification.options.closeWith) > -1)
                modal.on('click', function(e) {
                    $.noty.closeAll();
                });
        }
    };

    $.notyRenderer.getLayoutCountFor = function(notification) {
        return $(notification.options.layout.container.selector).data('noty_layout_count') || 0;
    };

    $.notyRenderer.setLayoutCountFor = function(notification, arg) {
        return $(notification.options.layout.container.selector).data('noty_layout_count', $.notyRenderer.getLayoutCountFor(notification) + arg);
    };

    $.notyRenderer.getModalCount = function() {
        return $('.noty_modal').data('noty_modal_count') || 0;
    };

    $.notyRenderer.setModalCount = function(arg) {
        return $('.noty_modal').data('noty_modal_count', $.notyRenderer.getModalCount() + arg);
    };

    // This is for custom container
    $.fn.noty = function(options) {
        options.custom = $(this);
        return $.notyRenderer.init(options);
    };

    $.noty = {};
    $.noty.queue = [];
    $.noty.ontap = true;
    $.noty.layouts = {};
    $.noty.themes = {};
    $.noty.returns = 'object';
    $.noty.store = {};

    $.noty.get = function(id) {
        return $.noty.store.hasOwnProperty(id) ? $.noty.store[id] : false;
    };

    $.noty.close = function(id) {
        return $.noty.get(id) ? $.noty.get(id).close() : false;
    };

    $.noty.setText = function(id, text) {
        return $.noty.get(id) ? $.noty.get(id).setText(text) : false;
    };

    $.noty.setType = function(id, type) {
        return $.noty.get(id) ? $.noty.get(id).setType(type) : false;
    };

    $.noty.clearQueue = function() {
        $.noty.queue = [];
    };

    $.noty.closeAll = function() {
        $.noty.clearQueue();
        $.each($.noty.store, function(id, noty) {
            noty.close();
        });
    };

    var windowAlert = window.alert;

    $.noty.consumeAlert = function(options) {
        window.alert = function(text) {
            if(options)
                options.text = text;
            else
                options = {text: text};

            $.notyRenderer.init(options);
        };
    };

    $.noty.stopConsumeAlert = function() {
        window.alert = windowAlert;
    };

    $.noty.defaults = {
        layout      : 'bottomRight',
        theme       : 'directus',
        type        : 'alert',
        text        : '',
        dismissQueue: true,
        template    : '<div class="noty_message"><span class="noty_text"></span><div class="noty_close"></div></div>',
        animation   : {
            open  : {height: 'toggle'},
            close : {height: 'toggle'},
            easing: 'swing',
            speed : 500
        },
        timeout     : false,
        force       : false,
        modal       : false,
        maxVisible  : 5,
        killer      : false,
        closeWith   : ['click'],
        callback    : {
            onShow      : function() {
            },
            afterShow   : function() {
            },
            onClose     : function() {
            },
            afterClose  : function() {
            },
            onCloseClick: function() {
            }
        },
        buttons     : false
    };

    $(window).on('resize', function() {
        $.each($.noty.layouts, function(index, layout) {
            layout.container.style.apply($(layout.container.selector));
        });
    });

    // Helpers
    window.noty = function noty(options) {
        return jQuery.notyRenderer.init(options);
    };
$.noty.layouts.bottom = {
    name     : 'bottom',
    options  : {},
    container: {
        object  : '<ul id="noty_bottom_layout_container" />',
        selector: 'ul#noty_bottom_layout_container',
        style   : function() {
            $(this).css({
                bottom       : 0,
                left         : '5%',
                position     : 'fixed',
                width        : '90%',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 9999999
            });
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none'
    },
    addClass : ''
};

$.noty.layouts.bottomCenter = {
    name     : 'bottomCenter',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_bottomCenter_layout_container" />',
        selector: 'ul#noty_bottomCenter_layout_container',
        style   : function() {
            $(this).css({
                bottom       : 20,
                left         : 0,
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            $(this).css({
                left: ($(window).width() - $(this).outerWidth(false)) / 2 + 'px'
            });
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        width  : '310px'
    },
    addClass : ''
};


$.noty.layouts.bottomLeft = {
    name     : 'bottomLeft',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_bottomLeft_layout_container" />',
        selector: 'ul#noty_bottomLeft_layout_container',
        style   : function() {
            $(this).css({
                bottom       : 20,
                left         : 20,
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            if(window.innerWidth < 600) {
                $(this).css({
                    left: 5
                });
            }
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        width  : '310px'
    },
    addClass : ''
};
$.noty.layouts.bottomRight = {
    name     : 'bottomRight',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_bottomRight_layout_container" />',
        selector: 'ul#noty_bottomRight_layout_container',
        style   : function() {

            $(this).css({
                bottom       : 20,
                right        : 20,
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            if(window.innerWidth < 600) {
                $(this).css({
                    right: 5
                });
            }
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        border: 'none',
        width  : '310px'
    },
    addClass : 'noty_box'
};
$.noty.layouts.center = {
    name     : 'center',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_center_layout_container" />',
        selector: 'ul#noty_center_layout_container',
        style   : function() {
            $(this).css({
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            // getting hidden height
            var dupe = $(this).clone().css({visibility: "hidden", display: "block", position: "absolute", top: 0, left: 0}).attr('id', 'dupe');
            $("body").append(dupe);
            dupe.find('.i-am-closing-now').remove();
            dupe.find('li').css('display', 'block');
            var actual_height = dupe.height();
            dupe.remove();

            if($(this).hasClass('i-am-new')) {
                $(this).css({
                    left: ($(window).width() - $(this).outerWidth(false)) / 2 + 'px',
                    top : ($(window).height() - actual_height) / 2 + 'px'
                });
            }
            else {
                $(this).animate({
                    left: ($(window).width() - $(this).outerWidth(false)) / 2 + 'px',
                    top : ($(window).height() - actual_height) / 2 + 'px'
                }, 500);
            }

        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        width  : '310px'
    },
    addClass : ''
};
$.noty.layouts.centerLeft = {
    name     : 'centerLeft',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_centerLeft_layout_container" />',
        selector: 'ul#noty_centerLeft_layout_container',
        style   : function() {
            $(this).css({
                left         : 20,
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            // getting hidden height
            var dupe = $(this).clone().css({visibility: "hidden", display: "block", position: "absolute", top: 0, left: 0}).attr('id', 'dupe');
            $("body").append(dupe);
            dupe.find('.i-am-closing-now').remove();
            dupe.find('li').css('display', 'block');
            var actual_height = dupe.height();
            dupe.remove();

            if($(this).hasClass('i-am-new')) {
                $(this).css({
                    top: ($(window).height() - actual_height) / 2 + 'px'
                });
            }
            else {
                $(this).animate({
                    top: ($(window).height() - actual_height) / 2 + 'px'
                }, 500);
            }

            if(window.innerWidth < 600) {
                $(this).css({
                    left: 5
                });
            }

        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        width  : '310px'
    },
    addClass : ''
};

$.noty.layouts.centerRight = {
    name     : 'centerRight',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_centerRight_layout_container" />',
        selector: 'ul#noty_centerRight_layout_container',
        style   : function() {
            $(this).css({
                right        : 20,
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            // getting hidden height
            var dupe = $(this).clone().css({visibility: "hidden", display: "block", position: "absolute", top: 0, left: 0}).attr('id', 'dupe');
            $("body").append(dupe);
            dupe.find('.i-am-closing-now').remove();
            dupe.find('li').css('display', 'block');
            var actual_height = dupe.height();
            dupe.remove();

            if($(this).hasClass('i-am-new')) {
                $(this).css({
                    top: ($(window).height() - actual_height) / 2 + 'px'
                });
            }
            else {
                $(this).animate({
                    top: ($(window).height() - actual_height) / 2 + 'px'
                }, 500);
            }

            if(window.innerWidth < 600) {
                $(this).css({
                    right: 5
                });
            }

        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        width  : '310px'
    },
    addClass : ''
};
$.noty.layouts.inline = {
    name     : 'inline',
    options  : {},
    container: {
        object  : '<ul class="noty_inline_layout_container" />',
        selector: 'ul.noty_inline_layout_container',
        style   : function() {
            $(this).css({
                width        : '100%',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 9999999
            });
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none'
    },
    addClass : ''
};
$.noty.layouts.top = {
    name     : 'top',
    options  : {},
    container: {
        object  : '<ul id="noty_top_layout_container" />',
        selector: 'ul#noty_top_layout_container',
        style   : function() {
            $(this).css({
                top          : 0,
                left         : '5%',
                position     : 'fixed',
                width        : '90%',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 9999999
            });
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none'
    },
    addClass : ''
};
$.noty.layouts.topCenter = {
    name     : 'topCenter',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_topCenter_layout_container" />',
        selector: 'ul#noty_topCenter_layout_container',
        style   : function() {
            $(this).css({
                top          : 20,
                left         : 0,
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            $(this).css({
                left: ($(window).width() - $(this).outerWidth(false)) / 2 + 'px'
            });
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        width  : '310px'
    },
    addClass : ''
};

$.noty.layouts.topLeft = {
    name     : 'topLeft',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_topLeft_layout_container" />',
        selector: 'ul#noty_topLeft_layout_container',
        style   : function() {
            $(this).css({
                top          : 20,
                left         : 20,
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            if(window.innerWidth < 600) {
                $(this).css({
                    left: 5
                });
            }
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        width  : '310px'
    },
    addClass : ''
};
$.noty.layouts.topRight = {
    name     : 'topRight',
    options  : { // overrides options

    },
    container: {
        object  : '<ul id="noty_topRight_layout_container" />',
        selector: 'ul#noty_topRight_layout_container',
        style   : function() {
            $(this).css({
                top          : 20,
                right        : 20,
                position     : 'fixed',
                width        : '310px',
                height       : 'auto',
                margin       : 0,
                padding      : 0,
                listStyleType: 'none',
                zIndex       : 10000000
            });

            if(window.innerWidth < 600) {
                $(this).css({
                    right: 5
                });
            }
        }
    },
    parent   : {
        object  : '<li />',
        selector: 'li',
        css     : {}
    },
    css      : {
        display: 'none',
        width  : '310px'
    },
    addClass : ''
};
$.noty.themes.bootstrapTheme = {
    name: 'bootstrapTheme',
    modal: {
        css: {
            position: 'fixed',
            width: '100%',
            height: '100%',
            backgroundColor: '#000',
            zIndex: 10000,
            opacity: 0.6,
            display: 'none',
            left: 0,
            top: 0
        }
    },
    style: function() {

        var containerSelector = this.options.layout.container.selector;
        $(containerSelector).addClass('list-group');

        this.$closeButton.append('<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>');
        this.$closeButton.addClass('close');

        this.$bar.addClass( "list-group-item" ).css('padding', '0px');

        switch (this.options.type) {
            case 'alert': case 'notification':
                this.$bar.addClass( "list-group-item-info" );
                break;
            case 'warning':
                this.$bar.addClass( "list-group-item-warning" );
                break;
            case 'error':
                this.$bar.addClass( "list-group-item-danger" );
                break;
            case 'information':
                this.$bar.addClass("list-group-item-info");
                break;
            case 'success':
                this.$bar.addClass( "list-group-item-success" );
                break;
        }

        this.$message.css({
            fontSize: '13px',
            lineHeight: '16px',
            textAlign: 'center',
            padding: '8px 10px 9px',
            width: 'auto',
            position: 'relative'
        });
    },
    callback: {
        onShow: function() {  },
        onClose: function() {  }
    }
};


$.noty.themes.defaultTheme = {
    name    : 'defaultTheme',
    helpers : {
        borderFix: function() {
            if(this.options.dismissQueue) {
                var selector = this.options.layout.container.selector + ' ' + this.options.layout.parent.selector;
                switch(this.options.layout.name) {
                    case 'top':
                        $(selector).css({borderRadius: '0px 0px 0px 0px'});
                        $(selector).last().css({borderRadius: '0px 0px 5px 5px'});
                        break;
                    case 'topCenter':
                    case 'topLeft':
                    case 'topRight':
                    case 'bottomCenter':
                    case 'bottomLeft':
                    case 'bottomRight':
                    case 'center':
                    case 'centerLeft':
                    case 'centerRight':
                    case 'inline':
                        $(selector).css({borderRadius: '0px 0px 0px 0px'});
                        $(selector).first().css({'border-top-left-radius': '5px', 'border-top-right-radius': '5px'});
                        $(selector).last().css({'border-bottom-left-radius': '5px', 'border-bottom-right-radius': '5px'});
                        break;
                    case 'bottom':
                        $(selector).css({borderRadius: '0px 0px 0px 0px'});
                        $(selector).first().css({borderRadius: '5px 5px 0px 0px'});
                        break;
                    default:
                        break;
                }
            }
        }
    },
    modal   : {
        css: {
            position       : 'fixed',
            width          : '100%',
            height         : '100%',
            backgroundColor: '#000',
            zIndex         : 10000,
            opacity        : 0.6,
            display        : 'none',
            left           : 0,
            top            : 0
        }
    },
    style   : function() {

        this.$bar.css({
            overflow  : 'hidden',
            background: "url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAoCAQAAAClM0ndAAAAhklEQVR4AdXO0QrCMBBE0bttkk38/w8WRERpdyjzVOc+HxhIHqJGMQcFFkpYRQotLLSw0IJ5aBdovruMYDA/kT8plF9ZKLFQcgF18hDj1SbQOMlCA4kao0iiXmah7qBWPdxpohsgVZyj7e5I9KcID+EhiDI5gxBYKLBQYKHAQoGFAoEks/YEGHYKB7hFxf0AAAAASUVORK5CYII=') repeat-x scroll left top #fff"
        });

        this.$message.css({
            fontSize  : '13px',
            lineHeight: '16px',
            textAlign : 'center',
            padding   : '8px 10px 9px',
            width     : 'auto',
            position  : 'relative'
        });

        this.$closeButton.css({
            position  : 'absolute',
            top       : 4, right: 4,
            width     : 10, height: 10,
            background: "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAQAAAAnOwc2AAAAxUlEQVR4AR3MPUoDURSA0e++uSkkOxC3IAOWNtaCIDaChfgXBMEZbQRByxCwk+BasgQRZLSYoLgDQbARxry8nyumPcVRKDfd0Aa8AsgDv1zp6pYd5jWOwhvebRTbzNNEw5BSsIpsj/kurQBnmk7sIFcCF5yyZPDRG6trQhujXYosaFoc+2f1MJ89uc76IND6F9BvlXUdpb6xwD2+4q3me3bysiHvtLYrUJto7PD/ve7LNHxSg/woN2kSz4txasBdhyiz3ugPGetTjm3XRokAAAAASUVORK5CYII=)",
            display   : 'none',
            cursor    : 'pointer'
        });

        this.$buttons.css({
            padding        : 5,
            textAlign      : 'right',
            borderTop      : '1px solid #ccc',
            backgroundColor: '#fff'
        });

        this.$buttons.find('button').css({
            marginLeft: 5
        });

        this.$buttons.find('button:first').css({
            marginLeft: 0
        });

        this.$bar.on({
            mouseenter: function() {
                $(this).find('.noty_close').stop().fadeTo('normal', 1);
            },
            mouseleave: function() {
                $(this).find('.noty_close').stop().fadeTo('normal', 0);
            }
        });

        switch(this.options.layout.name) {
            case 'top':
                this.$bar.css({
                    borderRadius: '0px 0px 5px 5px',
                    borderBottom: '2px solid #eee',
                    borderLeft  : '2px solid #eee',
                    borderRight : '2px solid #eee',
                    boxShadow   : "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                break;
            case 'topCenter':
            case 'center':
            case 'bottomCenter':
            case 'inline':
                this.$bar.css({
                    borderRadius: '5px',
                    border      : '1px solid #eee',
                    boxShadow   : "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                this.$message.css({fontSize: '13px', textAlign: 'center'});
                break;
            case 'topLeft':
            case 'topRight':
            case 'bottomLeft':
            case 'bottomRight':
            case 'centerLeft':
            case 'centerRight':
                this.$bar.css({
                    borderRadius: '5px',
                    border      : '1px solid #eee',
                    boxShadow   : "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                this.$message.css({fontSize: '13px', textAlign: 'left'});
                break;
            case 'bottom':
                this.$bar.css({
                    borderRadius: '5px 5px 0px 0px',
                    borderTop   : '2px solid #eee',
                    borderLeft  : '2px solid #eee',
                    borderRight : '2px solid #eee',
                    boxShadow   : "0 -2px 4px rgba(0, 0, 0, 0.1)"
                });
                break;
            default:
                this.$bar.css({
                    border   : '2px solid #eee',
                    boxShadow: "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                break;
        }

        switch(this.options.type) {
            case 'alert':
            case 'notification':
                this.$bar.css({backgroundColor: '#FFF', borderColor: '#CCC', color: '#444'});
                break;
            case 'warning':
                this.$bar.css({backgroundColor: '#FFEAA8', borderColor: '#FFC237', color: '#826200'});
                this.$buttons.css({borderTop: '1px solid #FFC237'});
                break;
            case 'error':
                this.$bar.css({backgroundColor: 'red', borderColor: 'darkred', color: '#FFF'});
                this.$message.css({fontWeight: 'bold'});
                this.$buttons.css({borderTop: '1px solid darkred'});
                break;
            case 'information':
                this.$bar.css({backgroundColor: '#57B7E2', borderColor: '#0B90C4', color: '#FFF'});
                this.$buttons.css({borderTop: '1px solid #0B90C4'});
                break;
            case 'success':
                this.$bar.css({backgroundColor: 'lightgreen', borderColor: '#50C24E', color: 'darkgreen'});
                this.$buttons.css({borderTop: '1px solid #50C24E'});
                break;
            default:
                this.$bar.css({backgroundColor: '#FFF', borderColor: '#CCC', color: '#444'});
                break;
        }
    },
    callback: {
        onShow : function() {
            $.noty.themes.defaultTheme.helpers.borderFix.apply(this);
        },
        onClose: function() {
            $.noty.themes.defaultTheme.helpers.borderFix.apply(this);
        }
    }
};

$.noty.themes.relax = {
    name    : 'relax',
    helpers : {},
    modal   : {
        css: {
            position       : 'fixed',
            width          : '100%',
            height         : '100%',
            backgroundColor: '#000',
            zIndex         : 10000,
            opacity        : 0.6,
            display        : 'none',
            left           : 0,
            top            : 0
        }
    },
    style   : function() {

        this.$bar.css({
            overflow    : 'hidden',
            margin      : '4px 0',
            borderRadius: '2px'
        });

        this.$message.css({
            fontSize  : '14px',
            lineHeight: '16px',
            textAlign : 'center',
            padding   : '10px',
            width     : 'auto',
            position  : 'relative'
        });

        this.$closeButton.css({
            position  : 'absolute',
            top       : 4, right: 4,
            width     : 10, height: 10,
            background: "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAQAAAAnOwc2AAAAxUlEQVR4AR3MPUoDURSA0e++uSkkOxC3IAOWNtaCIDaChfgXBMEZbQRByxCwk+BasgQRZLSYoLgDQbARxry8nyumPcVRKDfd0Aa8AsgDv1zp6pYd5jWOwhvebRTbzNNEw5BSsIpsj/kurQBnmk7sIFcCF5yyZPDRG6trQhujXYosaFoc+2f1MJ89uc76IND6F9BvlXUdpb6xwD2+4q3me3bysiHvtLYrUJto7PD/ve7LNHxSg/woN2kSz4txasBdhyiz3ugPGetTjm3XRokAAAAASUVORK5CYII=)",
            display   : 'none',
            cursor    : 'pointer'
        });

        this.$buttons.css({
            padding        : 5,
            textAlign      : 'right',
            borderTop      : '1px solid #ccc',
            backgroundColor: '#fff'
        });

        this.$buttons.find('button').css({
            marginLeft: 5
        });

        this.$buttons.find('button:first').css({
            marginLeft: 0
        });

        this.$bar.on({
            mouseenter: function() {
                $(this).find('.noty_close').stop().fadeTo('normal', 1);
            },
            mouseleave: function() {
                $(this).find('.noty_close').stop().fadeTo('normal', 0);
            }
        });

        switch(this.options.layout.name) {
            case 'top':
                this.$bar.css({
                    borderBottom: '2px solid #eee',
                    borderLeft  : '2px solid #eee',
                    borderRight : '2px solid #eee',
                    borderTop   : '2px solid #eee',
                    boxShadow   : "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                break;
            case 'topCenter':
            case 'center':
            case 'bottomCenter':
            case 'inline':
                this.$bar.css({
                    border   : '1px solid #eee',
                    boxShadow: "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                this.$message.css({fontSize: '13px', textAlign: 'center'});
                break;
            case 'topLeft':
            case 'topRight':
            case 'bottomLeft':
            case 'bottomRight':
            case 'centerLeft':
            case 'centerRight':
                this.$bar.css({
                    border   : '1px solid #eee',
                    boxShadow: "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                this.$message.css({fontSize: '13px', textAlign: 'left'});
                break;
            case 'bottom':
                this.$bar.css({
                    borderTop   : '2px solid #eee',
                    borderLeft  : '2px solid #eee',
                    borderRight : '2px solid #eee',
                    borderBottom: '2px solid #eee',
                    boxShadow   : "0 -2px 4px rgba(0, 0, 0, 0.1)"
                });
                break;
            default:
                this.$bar.css({
                    border   : '2px solid #eee',
                    boxShadow: "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                break;
        }

        switch(this.options.type) {
            case 'alert':
            case 'notification':
                this.$bar.css({backgroundColor: '#FFF', borderColor: '#dedede', color: '#444'});
                break;
            case 'warning':
                this.$bar.css({backgroundColor: '#FFEAA8', borderColor: '#FFC237', color: '#826200'});
                this.$buttons.css({borderTop: '1px solid #FFC237'});
                break;
            case 'error':
                this.$bar.css({backgroundColor: '#FF8181', borderColor: '#e25353', color: '#FFF'});
                this.$message.css({fontWeight: 'bold'});
                this.$buttons.css({borderTop: '1px solid darkred'});
                break;
            case 'information':
                this.$bar.css({backgroundColor: '#78C5E7', borderColor: '#3badd6', color: '#FFF'});
                this.$buttons.css({borderTop: '1px solid #0B90C4'});
                break;
            case 'success':
                this.$bar.css({backgroundColor: '#BCF5BC', borderColor: '#7cdd77', color: 'darkgreen'});
                this.$buttons.css({borderTop: '1px solid #50C24E'});
                break;
            default:
                this.$bar.css({backgroundColor: '#FFF', borderColor: '#CCC', color: '#444'});
                break;
        }
    },
    callback: {
        onShow : function() {

        },
        onClose: function() {

        }
    }
};

define("noty", ["jquery"], function(){});

//   @extraLightGrey: #f4f4f4; // Extra Light Gray – previously #fbfbfb
//   @lightGrey: #ececec; // Light Grey
//   @mediumGrey: #bbbbbb; // Medium Grey
//   @darkGrey: #999999; // Dark Grey
//   @extraDarkGrey: #333333; // Extra Dark Grey

//   @fieldColor: lighten(@lightGrey, 2%);

//   @tableRowHover: #fffddd;

//   // Actions
//   @addColor: #7ac943;
//   @editColor: #3fa9f5;
//   @deleteColor: #c1272d;
//   @messageColor: #a63c96;
//   @attachColor: #ff7bac;
//   @loginColor: #5b5b5b;
//   @errorColor: #fbb03b;
//   @systemColor: #fdcd30;

//   @openFont: 'Open Sans', sans-serif;
$.noty.themes.directus = {
    name    : 'directus',
    helpers : {},
    modal   : {
        css: {
            position       : 'fixed',
            width          : '100%',
            height         : '100%',
            backgroundColor: '#000',
            zIndex         : 10000,
            opacity        : 0.6,
            display        : 'none',
            left           : 0,
            top            : 0
        }
    },
    style   : function() {

        this.$bar.css({
            overflow    : 'hidden',
            margin      : '4px 0',
            borderRadius: '4px',
            width       : '60%',
            border      : '0px solid #fff'
        });

        this.$message.css({
            fontSize  : '14px',
            lineHeight: '16px',
            textAlign : 'center',
            padding   : '20px',
            width     : 'auto',
            position  : 'relative',
            borderRadius: '4px 4px 4px 4px'
        });

        this.$closeButton.css({
            position  : 'absolute',
            top       : 4, right: 4,
            width     : 10, height: 10,
            background: "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAQAAAAnOwc2AAAAxUlEQVR4AR3MPUoDURSA0e++uSkkOxC3IAOWNtaCIDaChfgXBMEZbQRByxCwk+BasgQRZLSYoLgDQbARxry8nyumPcVRKDfd0Aa8AsgDv1zp6pYd5jWOwhvebRTbzNNEw5BSsIpsj/kurQBnmk7sIFcCF5yyZPDRG6trQhujXYosaFoc+2f1MJ89uc76IND6F9BvlXUdpb6xwD2+4q3me3bysiHvtLYrUJto7PD/ve7LNHxSg/woN2kSz4txasBdhyiz3ugPGetTjm3XRokAAAAASUVORK5CYII=)",
            display   : 'none',
            cursor    : 'pointer'
        });

        this.$buttons.css({
            padding        : 4,
            textAlign      : 'right',
            //borderTop      : '1px solid #ccc',
            backgroundColor: '#fff'
        });

        this.$buttons.find('button').css({
            marginLeft: 5
        });

        this.$buttons.find('button:first').css({
            marginLeft: 0
        });

        this.$bar.on({
            mouseenter: function() {
                $(this).find('.noty_close').stop().fadeTo('normal', 1);
            },
            mouseleave: function() {
                $(this).find('.noty_close').stop().fadeTo('normal', 0);
            }
        });

        switch(this.options.layout.name) {
            case 'top':
                this.$bar.css({
                    borderBottom: '2px solid #eee',
                    borderLeft  : '2px solid #eee',
                    borderRight : '2px solid #eee',
                    borderTop   : '2px solid #eee',
                    boxShadow   : "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                break;
            case 'topCenter':
            case 'center':
            case 'bottomCenter':
            case 'inline':
                this.$bar.css({
                    border   : '1px solid #eee',
                    boxShadow: "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                this.$message.css({fontSize: '13px', textAlign: 'center'});
                break;
            case 'topLeft':
            case 'topRight':
            case 'bottomLeft':
            case 'bottomRight':
            case 'centerLeft':
            case 'centerRight':
                this.$bar.css({
                    border   : '1px solid #eee',
                    boxShadow: "0 2px 4px rgba(0, 0, 0, 0.1)"
                });
                this.$message.css({fontSize: '13px', textAlign: 'left'});
                break;
            case 'bottom':
                this.$bar.css({
                    borderTop   : '2px solid #eee',
                    borderLeft  : '2px solid #eee',
                    borderRight : '2px solid #eee',
                    borderBottom: '2px solid #eee',
                    boxShadow   : "0 -2px 4px rgba(0, 0, 0, 0.1)"
                });
                break;
            default:
                this.$bar.css({
                    border   : 'none',
                    boxShadow: "0 2px 4px rgba(0, 0, 0, 0.1)",
                    borderRadius: '4px'
                });
                break;
        }

        switch(this.options.type) {
            case 'alert':
            case 'notification':
                this.$bar.css({backgroundColor: '#333333', color: '#FFF'});
                break;
            case 'warning':
                this.$bar.css({backgroundColor: '#fbb03b', color: '#FFF'});
                //this.$buttons.css({borderTop: '1px solid #FFC237'});
                break;
            case 'error':
                this.$bar.css({backgroundColor: '#c1272d', color: '#FFF'});
                //this.$message.css({fontWeight: 'bold'});
                //this.$buttons.css({borderTop: '1px solid darkred'});
                break;
            case 'information':
                this.$bar.css({backgroundColor: '#78C5E7', color: '#FFF'});
                //this.$buttons.css({borderTop: '1px solid #0B90C4'});
                break;
            case 'success':
                this.$bar.css({backgroundColor: '#7ac943', color: '#FFF'});
                //this.$buttons.css({borderTop: '1px solid #50C24E'});
                break;
            default:
                this.$bar.css({backgroundColor: '#FFF', color: '#444'});
                break;
        }
    },
    callback: {
        onShow : function() {

        },
        onClose: function() {

        }
    }
};

define("noty_theme", ["jquery","noty"], function(){});

define('core/notification',['app', 'backbone', 'utils', 'noty', 'noty_theme'], function(app, Backbone, Utils) {
  

  var defaultOptions = {
    theme: 'directus',
    timeout: 30000
  };

  function createNotification(title, details, type, options) {
    // if options is a number
    // it means is the delay time (in milliseconds)
    // until the notification close
    if (!isNaN(parseInt(options)) && isFinite(options)) {
      options = {
        timeout: options
      };
    }

    options = _.extend(defaultOptions, options || (options = {}));

    if (typeof type === 'string') {
      options.type = type.toLowerCase();
    }

    var titleText = '';
    if (title) {
      titleText += '<b>'+title+'</b><br>';
    }

    options.text = titleText+details;

    return noty(options);
  }

  function addTypeArgument(args, type) {
    args = Utils.argumentsToArray(args);

    if (args.length === 1) {
      args.unshift(type);
    }

    args.splice(2, 0, type);

    return args;
  }

  //@TODO: Wrap Noty into a Notification Object
  function showNotification(options) {
    var args = Utils.argumentsToArray(arguments);
    return createNotification.apply(this, args);
  }

  function showError(options) {
    var args = addTypeArgument(arguments, 'Error');
    return createNotification.apply(this, args);
  }

  function showInfo(options) {
    var args = addTypeArgument(arguments, 'Information');
    return createNotification.apply(this, args);
  }

  function showWarning(options) {
    var args = addTypeArgument(arguments, 'Warning');
    return createNotification.apply(this, args);
  }

  function showSuccess(options) {
    var args = addTypeArgument(arguments, 'Success');
    return createNotification.apply(this, args);
  }

  return {
    show: showNotification,
    alert: showNotification,
    error: showError,
    info: showInfo,
    warning: showWarning,
    success: showSuccess
  };
});

define('helpers/model',['require','exports','module','backbone'],function(require, exports) {

  

  var Backbone = require('backbone');

  var addPrimaryColumnToModel = function(model) {
    if (model.collection && model.collection.junctionStructure) {
      model = model.collection.junctionStructure;
    }

    if (model.table && model.table.has('primary_column') && model.table.get('primary_column') !== 'id') {
      model.idAttribute = model.table.get('primary_column');
      model.id = model.get(model.idAttribute);
      model.collection._byId[model.id] = model;
    }
  }

  return {
    setIdAttribute: function(model) {
      if (!model) {
        return;
      }

      if (model instanceof Backbone.Collection) {
        model.each(addPrimaryColumnToModel);
      } else {
        addPrimaryColumnToModel(model);
      }
    }
  }
});

define('core/table/table.headview',[
  'app',
  'backbone',
  'core/t',
  'core/notification'
],

function(app, Backbone, __t, Notification) {

  

  var TableHeadView = Backbone.Layout.extend({

    template: 'tables/table-head',

    tagName: 'thead',

    events: {

      'click th.check > input': function(e) {
        $('td.check > input').prop('checked', $('#check-all:checked').prop('checked') !== undefined).trigger('changed');
        this.collection.trigger('select');
      },

      'click th:not(.check, .visible-columns-cell)': function(e) {
        var column = $(e.target).closest('th').attr('data-id'); // .closet() accounts for event return children (icon) elements instead
        var order = this.collection.getOrder();
        var order_sort = 'ASC';
        var isDefaultSorting = (order.sort === column && order.sort_order !== order_sort);

        var structure = this.collection.junctionStructure || this.collection.structure;
        var defaultSortColumn = structure.where({column_name: 'sort'}).length ? 'sort' : 'id';

        if(column === 'sort' || isDefaultSorting) {
          this.collection.setOrder(defaultSortColumn, order_sort);
          return;
        }

        if(column !== order.sort) {
          this.collection.setOrder(column, order_sort);
        } else {
          if(order.sort_order === order_sort) {
            order_sort = 'DESC';
          }
          this.collection.setOrder(column, order_sort);
        }
      },

      'click #set-visible-columns': function() {
        if(this.visibleColumnsView) {
          this.visibleColumnsView = null;
          this.removeView('#visible_columns_entry');
          this.$el.closest('thead').removeClass('force-hover');
          return;
        } else {
          this.$el.closest('thead').addClass('force-hover');
        }

        var structure = this.options.collection.structure;
        var preferences = this.collection.preferences;
        var collection = this.collection;
        var visibleColumns = preferences.get('columns_visible').split(',');
        var data = {};
        var view, modal;
        var totalSelected = 0;

        data.columns = structure.chain()
          .filter(function(model) {
            return !model.get('system') && !model.get('hidden_list') && !model.get('hidden_input');
          })
          .map(function(model) {
            var isVisible = _.contains(visibleColumns, model.id);
            var isForeign = _.contains(['MANYTOMANY', 'ONETOMANY'],
                                       model.getRelationshipType());

            if (isVisible) {
              totalSelected++;
            }

            return {
              name: model.id,
              visible: isVisible,
              disabled: isForeign,
              isForeign: isForeign
            };
          }, this)
          .value();

        if (totalSelected >= this.maxColumns) {
          data.columns = _.map(data.columns, function(column) {
            if (!column.visible) {
              column.disabled = true;
            }
            return column;
          });
        }

        data.maxColumns = this.maxColumns;

        var View = Backbone.Layout.extend({

          events: {
            'click input': function() {
              var checkedInputs = this.$el.find('input:checked'),
                  maxColumns = this.options.data.maxColumns;

              if (checkedInputs.length >= maxColumns) {
                this.disableNonSelected();
              } else {
                this.enableNonSelected();
              }
            },
            'click #saveVisibleColumnsBtn': function() {
              this.save();
            },
            'click #cancelVisibleColumnsBtn': function() {
              this.cancelSelection();
            }
          },

          disableNonSelected: function() {
            this.$el.find('input:not(:checked)').each(function(i, el) {
              $(el).prop('disabled', true);
            });
          },

          enableNonSelected: function() {
            this.$el.find('input:disabled').each(function(i, el) {
              var $el = $(el);
              if (!$el.attr('data-foreign')) {
                $el.prop('disabled', false);
              }
            });
          },

          template: 'tables/table-set-columns',

          serialize: function() {
            return this.options.data;
          }

        });

        this.visibleColumnsView = new View({data: data});

        var that = this;

        this.visibleColumnsView.cancelSelection = function() {
          that.visibleColumnsView = null;
          this.remove();
          that.$el.closest('thead').removeClass('force-hover');
        };

        this.visibleColumnsView.save = function() {
          var data = this.$el.find('form').serializeObject();
          var string = _.isArray(data.columns_visible) ? data.columns_visible.join(',') : data.columns_visible;
          var that2 = this;

          preferences.save({'columns_visible': string},{
            success: function() {
              collection.trigger('visibility');
              that2.cancelSelection();
            }
          });

          that.collection.filters.columns_visible = data.columns_visible;
          that.collection.fetch();
        };

        this.render();
      },
      'click .sortableHeader': function(e) {
        this.parentView.toggleSortable();
      },
      'click th:not(.sortableHeader)': function(e) {
        if(this.parentView.sortableWidget && this.parentView.sortableWidget.options.sort)
        {
          this.$el.closest('table').addClass('disable-sorting');
          this.parentView.sortableWidget.options.sort = false;
          Notification.info(__t('table_sort_disabled'), '<i>'+__t('table_sort_disabled_message')+'</i>', {timeout: 3000});
        }
      }
    },

    beforeRender: function() {
      if(this.visibleColumnsView) {
        this.setView('#visible_columns_entry', this.visibleColumnsView);
      }
    },

    serialize: function() {
      var order = this.collection.getOrder();
      var blacklist = this.options.blacklist;

      // get whitelisted columns first
      var columns = _.filter(this.collection.getColumns(), function(column) {
        return ! _.contains(blacklist, column);
      });

      columns = _.map(columns, function(column) {
        return {name: column, orderBy: column === order.sort, desc: order.sort_order === 'DESC'};
      });

      return {selectable: this.options.selectable, sortable: this.options.sort, columns: columns, deleteColumn: this.options.deleteColumn, hideColumnPreferences: this.options.hideColumnPreferences};
    },

    initialize: function(options) {
      this.parentView = options.parentView;

      this.maxColumns = this.options.maxColumns || 8;
      var that = this;
      if(this.collection.preferences) {
        this.collection.filters.columns_visible = [];
        this.collection.preferences.get('columns_visible').split(',').forEach(function(column) {
          //Only add columns that actually exist
          if(that.collection.structure.get(column) !== undefined) {
            that.collection.filters.columns_visible.push(column);
          }
        });
      }

      this.collection.on('sort', this.render, this);
    }

  });

  return TableHeadView;

});

/**!
 * Sortable
 * @author  RubaXa   <trash@rubaxa.org>
 * @license MIT
 */


(function (factory) {
  

  if (typeof define === "function" && define.amd) {
    define('sortable',factory);
  }
  else if (typeof module != "undefined" && typeof module.exports != "undefined") {
    module.exports = factory();
  }
  else if (typeof Package !== "undefined") {
    Sortable = factory();  // export for Meteor.js
  }
  else {
    /* jshint sub:true */
    window["Sortable"] = factory();
  }
})(function () {
  

  var dragEl,
    ghostEl,
    cloneEl,
    rootEl,
    nextEl,

    lastEl,
    lastCSS,

    activeGroup,

    tapEvt,
    touchEvt,

    expando = 'Sortable' + (new Date).getTime(),

    win = window,
    document = win.document,
    parseInt = win.parseInt,
    supportIEdnd = !!document.createElement('div').dragDrop,

    _silent = false,

    _dispatchEvent = function (rootEl, name, targetEl, fromEl) {
      var evt = document.createEvent('Event');

      evt.initEvent(name, true, true);
      evt.item = targetEl || rootEl;
      evt.from = fromEl || rootEl;

      rootEl.dispatchEvent(evt);
    },

    _customEvents = 'onAdd onUpdate onRemove onStart onEnd onFilter onSort'.split(' '),

    noop = function () {},
    slice = [].slice,

    touchDragOverListeners = []
  ;



  /**
   * @class  Sortable
   * @param  {HTMLElement}  el
   * @param  {Object}       [options]
   */
  function Sortable(el, options) {
    this.el = el; // root element
    this.options = options = (options || {});


    // Default options
    var defaults = {
      group: Math.random(),
      sort: true,
      store: null,
      handle: null,
      draggable: el.children[0] && el.children[0].nodeName || (/[uo]l/i.test(el.nodeName) ? 'li' : '*'),
      ghostClass: 'sortable-ghost',
      ignore: 'a, img',
      filter: null,
      animation: 0,
      setData: function (dataTransfer, dragEl) {
        dataTransfer.setData('Text', dragEl.textContent);
      }
    };


    // Set default options
    for (var name in defaults) {
      !(name in options) && (options[name] = defaults[name]);
    }


    if (!options.group.name) {
      options.group = { name: options.group };
    }


    ['pull', 'put'].forEach(function (key) {
      if (!(key in options.group)) {
        options.group[key] = true;
      }
    });


    // Define events
    _customEvents.forEach(function (name) {
      options[name] = _bind(this, options[name] || noop);
      _on(el, name.substr(2).toLowerCase(), options[name]);
    }, this);


    // Export group name
    el[expando] = options.group.name;


    // Bind all private methods
    for (var fn in this) {
      if (fn.charAt(0) === '_') {
        this[fn] = _bind(this, this[fn]);
      }
    }


    // Bind events
    _on(el, 'mousedown', this._onTapStart);
    _on(el, 'touchstart', this._onTapStart);
    supportIEdnd && _on(el, 'selectstart', this._onTapStart);

    _on(el, 'dragover', this._onDragOver);
    _on(el, 'dragenter', this._onDragOver);

    touchDragOverListeners.push(this._onDragOver);

    // Restore sorting
    options.store && this.sort(options.store.get(this));
  }


  Sortable.prototype = /** @lends Sortable.prototype */ {
    constructor: Sortable,


    _applyEffects: function () {
      _toggleClass(dragEl, this.options.ghostClass, true);
    },


    _onTapStart: function (/**Event|TouchEvent*/evt) {
      var touch = evt.touches && evt.touches[0],
        target = (touch || evt).target,
        options =  this.options,
        el = this.el,
        filter = options.filter;


      if (evt.type === 'mousedown' && evt.button !== 0) {
        return; // only left button
      }

      // Check filter
      if (typeof filter === 'function') {
        if (filter.call(this, target, this)) {
          _dispatchEvent(el, 'filter', target);
          return; // cancel dnd
        }
      }
      else if (filter) {
        filter = filter.split(',').filter(function (criteria) {
          return _closest(target, criteria.trim(), el);
        });

        if (filter.length) {
          _dispatchEvent(el, 'filter', target);
          return; // cancel dnd
        }
      }

      if (options.handle) {
        target = _closest(target, options.handle, el);
      }

      target = _closest(target, options.draggable, el);

      // IE 9 Support
      if (target && evt.type == 'selectstart') {
        if (target.tagName != 'A' && target.tagName != 'IMG') {
          target.dragDrop();
        }
      }

      if (target && !dragEl && (target.parentNode === el)) {
        tapEvt = evt;

        rootEl = this.el;
        dragEl = target;
        nextEl = dragEl.nextSibling;
        activeGroup = this.options.group;

        dragEl.draggable = true;

        // Disable "draggable"
        options.ignore.split(',').forEach(function (criteria) {
          _find(target, criteria.trim(), _disableDraggable);
        });

        if (touch) {
          // Touch device support
          tapEvt = {
            target: target,
            clientX: touch.clientX,
            clientY: touch.clientY
          };

          this._onDragStart(tapEvt, true);
          evt.preventDefault();
        }

        _on(document, 'mouseup', this._onDrop);
        _on(document, 'touchend', this._onDrop);
        _on(document, 'touchcancel', this._onDrop);

        _on(this.el, 'dragstart', this._onDragStart);
        _on(this.el, 'dragend', this._onDrop);
        _on(document, 'dragover', _globalDragOver);


        try {
          if (document.selection) {
            document.selection.empty();
          } else {
            window.getSelection().removeAllRanges();
          }
        } catch (err) {
        }


        _dispatchEvent(dragEl, 'start');


        if (activeGroup.pull == 'clone') {
          cloneEl = dragEl.cloneNode(true);
          _css(cloneEl, 'display', 'none');
          rootEl.insertBefore(cloneEl, dragEl);
        }
      }
    },

    _emulateDragOver: function () {
      if (touchEvt) {
        _css(ghostEl, 'display', 'none');

        var target = document.elementFromPoint(touchEvt.clientX, touchEvt.clientY),
          parent = target,
          groupName = this.options.group.name,
          i = touchDragOverListeners.length;

        if (parent) {
          do {
            if (parent[expando] === groupName) {
              while (i--) {
                touchDragOverListeners[i]({
                  clientX: touchEvt.clientX,
                  clientY: touchEvt.clientY,
                  target: target,
                  rootEl: parent
                });
              }

              break;
            }

            target = parent; // store last element
          }
          /* jshint boss:true */
          while (parent = parent.parentNode);
        }

        _css(ghostEl, 'display', '');
      }
    },


    _onTouchMove: function (/**TouchEvent*/evt) {
      if (tapEvt) {
        var touch = evt.touches[0],
          dx = touch.clientX - tapEvt.clientX,
          dy = touch.clientY - tapEvt.clientY,
          translate3d = 'translate3d(' + dx + 'px,' + dy + 'px,0)';

        touchEvt = touch;

        _css(ghostEl, 'webkitTransform', translate3d);
        _css(ghostEl, 'mozTransform', translate3d);
        _css(ghostEl, 'msTransform', translate3d);
        _css(ghostEl, 'transform', translate3d);

        evt.preventDefault();
      }
    },


    _onDragStart: function (/**Event*/evt, /**boolean*/isTouch) {
      var dataTransfer = evt.dataTransfer,
        options = this.options;

      this.isDragging = true;
      this._offUpEvents();

      if (isTouch) {
        var rect = dragEl.getBoundingClientRect(),
          css = _css(dragEl),
          ghostRect;

        ghostEl = dragEl.cloneNode(true);

        _css(ghostEl, 'top', rect.top - parseInt(css.marginTop, 10));
        _css(ghostEl, 'left', rect.left - parseInt(css.marginLeft, 10));
        _css(ghostEl, 'width', rect.width);
        _css(ghostEl, 'height', rect.height);
        _css(ghostEl, 'opacity', '0.8');
        _css(ghostEl, 'position', 'fixed');
        _css(ghostEl, 'zIndex', '100000');

        rootEl.appendChild(ghostEl);

        // Fixing dimensions.
        ghostRect = ghostEl.getBoundingClientRect();
        _css(ghostEl, 'width', rect.width * 2 - ghostRect.width);
        _css(ghostEl, 'height', rect.height * 2 - ghostRect.height);

        // Bind touch events
        _on(document, 'touchmove', this._onTouchMove);
        _on(document, 'touchend', this._onDrop);
        _on(document, 'touchcancel', this._onDrop);

        this._loopId = setInterval(this._emulateDragOver, 150);
      }
      else {
        dataTransfer.effectAllowed = 'move';
        options.setData && options.setData.call(this, dataTransfer, dragEl);

        _on(document, 'drop', this._onDrop);
      }

      setTimeout(this._applyEffects);
    },


    _onDragOver: function (/**Event*/evt) {
      var el = this.el,
        target,
        dragRect,
        revert,
        options = this.options,
        group = options.group,
        groupPut = group.put,
        isOwner = (activeGroup === group),
        canSort = options.sort;

        if(!isOwner) {
          return;
        }

      if (!_silent &&
        (isOwner
          ? canSort || (revert = !rootEl.contains(dragEl))
          : activeGroup.pull && groupPut && (
            (activeGroup.name === group.name) || // by Name
            (groupPut.indexOf && ~groupPut.indexOf(activeGroup.name)) // by Array
          )
        ) &&
        (evt.rootEl === void 0 || evt.rootEl === this.el)
      ) {
        target = _closest(evt.target, options.draggable, el);
        dragRect = dragEl.getBoundingClientRect();

        if (cloneEl && (cloneEl.state !== isOwner)) {
          _css(cloneEl, 'display', isOwner ? 'none' : '');
          !isOwner && cloneEl.state && rootEl.insertBefore(cloneEl, dragEl);
          cloneEl.state = isOwner;
        }

        if (revert) {
          if (cloneEl || nextEl) {
            rootEl.insertBefore(dragEl, cloneEl || nextEl);
          }
          else if (!canSort) {
            rootEl.appendChild(dragEl);
          }

          return;
        }

        if ((el.children.length === 0) || (el.children[0] === ghostEl) ||
          (el === evt.target) && (target = _ghostInBottom(el, evt))
        ) {
          if (target) {
            if (target.animated) {
              return;
            }
            targetRect = target.getBoundingClientRect();
          }

          el.appendChild(dragEl);
          this._animate(dragRect, dragEl);
          target && this._animate(targetRect, target);
        }
        else if (target && !target.animated && target !== dragEl && (target.parentNode[expando] !== void 0)) {
          if (lastEl !== target) {
            lastEl = target;
            lastCSS = _css(target);
          }


          var targetRect = target.getBoundingClientRect(),
            width = targetRect.right - targetRect.left,
            height = targetRect.bottom - targetRect.top,
            floating = /left|right|inline/.test(lastCSS.cssFloat + lastCSS.display),
            isWide = (target.offsetWidth > dragEl.offsetWidth),
            isLong = (target.offsetHeight > dragEl.offsetHeight),
            halfway = (floating ? (evt.clientX - targetRect.left) / width : (evt.clientY - targetRect.top) / height) > 0.5,
            nextSibling = target.nextElementSibling,
            after
          ;

          _silent = true;
          setTimeout(_unsilent, 30);

          if (floating) {
            after = (target.previousElementSibling === dragEl) && !isWide || halfway && isWide;
          } else {
            after = (nextSibling !== dragEl) && !isLong || halfway && isLong;
          }

          if (after && !nextSibling) {
            el.appendChild(dragEl);
          } else {
            target.parentNode.insertBefore(dragEl, after ? nextSibling : target);
          }

          this._animate(dragRect, dragEl);
          this._animate(targetRect, target);
        }
      }
    },

    _animate: function (prevRect, target) {
      var ms = this.options.animation;

      if (ms) {
        var currentRect = target.getBoundingClientRect();

        _css(target, 'transition', 'none');
        _css(target, 'transform', 'translate3d('
          + (prevRect.left - currentRect.left) + 'px,'
          + (prevRect.top - currentRect.top) + 'px,0)'
        );

        target.offsetWidth; // repaint

        _css(target, 'transition', 'all ' + ms + 'ms');
        _css(target, 'transform', 'translate3d(0,0,0)');

        clearTimeout(target.animated);
        target.animated = setTimeout(function () {
          _css(target, 'transition', '');
          target.animated = false;
        }, ms);
      }
    },

    _offUpEvents: function () {
      _off(document, 'mouseup', this._onDrop);
      _off(document, 'touchmove', this._onTouchMove);
      _off(document, 'touchend', this._onDrop);
      _off(document, 'touchcancel', this._onDrop);
    },

    _onDrop: function (/**Event*/evt) {
      clearInterval(this._loopId);

      // Unbind events
      _off(document, 'drop', this._onDrop);
      _off(document, 'dragover', _globalDragOver);

      _off(this.el, 'dragend', this._onDrop);
      _off(this.el, 'dragstart', this._onDragStart);
      _off(this.el, 'selectstart', this._onTapStart);

      this._offUpEvents();

      if (evt) {
        evt.preventDefault();
        evt.stopPropagation();

        ghostEl && ghostEl.parentNode.removeChild(ghostEl);

        if (dragEl) {
          _disableDraggable(dragEl);
          _toggleClass(dragEl, this.options.ghostClass, false);

          if (!rootEl.contains(dragEl)) {
            _dispatchEvent(dragEl, 'sort');
            _dispatchEvent(rootEl, 'sort');

            // Add event
            _dispatchEvent(dragEl, 'add', dragEl, rootEl);

            // Remove event
            _dispatchEvent(rootEl, 'remove', dragEl);
          }
          else if (dragEl.nextSibling !== nextEl) {
            // Update event
            _dispatchEvent(dragEl, 'update');
            _dispatchEvent(dragEl, 'sort');

            cloneEl && cloneEl.parentNode.removeChild(cloneEl);
          }

          _dispatchEvent(rootEl, 'end');
        }

        // Set NULL
        rootEl =
        dragEl =
        ghostEl =
        nextEl =
        cloneEl =

        tapEvt =
        touchEvt =

        lastEl =
        lastCSS =

        activeGroup = null;

        // Save sorting
        this.options.store && this.options.store.set(this);
      }
    },


    /**
     * Serializes the item into an array of string.
     * @returns {String[]}
     */
    toArray: function () {
      var order = [],
        el,
        children = this.el.children,
        i = 0,
        n = children.length;

      for (; i < n; i++) {
        el = children[i];
        if (_closest(el, this.options.draggable, this.el)) {
          order.push(el.getAttribute('data-id') || _generateId(el));
        }
      }

      return order;
    },


    /**
     * Sorts the elements according to the array.
     * @param  {String[]}  order  order of the items
     */
    sort: function (order) {
      var items = {}, rootEl = this.el;

      this.toArray().forEach(function (id, i) {
        var el = rootEl.children[i];

        if (_closest(el, this.options.draggable, rootEl)) {
          items[id] = el;
        }
      }, this);


      order.forEach(function (id) {
        if (items[id]) {
          rootEl.removeChild(items[id]);
          rootEl.appendChild(items[id]);
        }
      });
    },


    /**
     * For each element in the set, get the first element that matches the selector by testing the element itself and traversing up through its ancestors in the DOM tree.
     * @param   {HTMLElement}  el
     * @param   {String}       [selector]  default: `options.draggable`
     * @returns {HTMLElement|null}
     */
    closest: function (el, selector) {
      return _closest(el, selector || this.options.draggable, this.el);
    },


    /**
     * Set/get option
     * @param   {string} name
     * @param   {*}      [value]
     * @returns {*}
     */
    option: function (name, value) {
      var options = this.options;

      if (value === void 0) {
        return options[name];
      } else {
        options[name] = value;
      }
    },


    /**
     * Destroy
     */
    destroy: function () {
      var el = this.el, options = this.options;

      _customEvents.forEach(function (name) {
        _off(el, name.substr(2).toLowerCase(), options[name]);
      });

      _off(el, 'mousedown', this._onTapStart);
      _off(el, 'touchstart', this._onTapStart);
      _off(el, 'selectstart', this._onTapStart);

      _off(el, 'dragover', this._onDragOver);
      _off(el, 'dragenter', this._onDragOver);

      //remove draggable attributes
      Array.prototype.forEach.call(el.querySelectorAll('[draggable]'), function (el) {
        el.removeAttribute('draggable');
      });

      touchDragOverListeners.splice(touchDragOverListeners.indexOf(this._onDragOver), 1);

      this._onDrop();

      this.el = null;
    }
  };


  function _bind(ctx, fn) {
    var args = slice.call(arguments, 2);
    return  fn.bind ? fn.bind.apply(fn, [ctx].concat(args)) : function () {
      return fn.apply(ctx, args.concat(slice.call(arguments)));
    };
  }


  function _closest(el, selector, ctx) {
    if (selector === '*') {
      return el;
    }
    else if (el) {
      ctx = ctx || document;
      selector = selector.split('.');

      var tag = selector.shift().toUpperCase(),
        re = new RegExp('\\s(' + selector.join('|') + ')\\s', 'g');

      do {
        if (
          (tag === '' || el.nodeName == tag) &&
          (!selector.length || ((' ' + el.className + ' ').match(re) || []).length == selector.length)
        ) {
          return el;
        }
      }
      while (el !== ctx && (el = el.parentNode));
    }

    return null;
  }


  function _globalDragOver(evt) {
    evt.dataTransfer.dropEffect = 'move';
    evt.preventDefault();
  }


  function _on(el, event, fn) {
    el.addEventListener(event, fn, false);
  }


  function _off(el, event, fn) {
    el.removeEventListener(event, fn, false);
  }


  function _toggleClass(el, name, state) {
    if (el) {
      if (el.classList) {
        el.classList[state ? 'add' : 'remove'](name);
      }
      else {
        var className = (' ' + el.className + ' ').replace(/\s+/g, ' ').replace(' ' + name + ' ', '');
        el.className = className + (state ? ' ' + name : '');
      }
    }
  }


  function _css(el, prop, val) {
    var style = el && el.style;

    if (style) {
      if (val === void 0) {
        if (document.defaultView && document.defaultView.getComputedStyle) {
          val = document.defaultView.getComputedStyle(el, '');
        }
        else if (el.currentStyle) {
          val = el.currentStyle;
        }

        return prop === void 0 ? val : val[prop];
      }
      else {
        if (!(prop in style)) {
          prop = '-webkit-' + prop;
        }

        style[prop] = val + (typeof val === 'string' ? '' : 'px');
      }
    }
  }


  function _find(ctx, tagName, iterator) {
    if (ctx) {
      var list = ctx.getElementsByTagName(tagName), i = 0, n = list.length;

      if (iterator) {
        for (; i < n; i++) {
          iterator(list[i], i);
        }
      }

      return list;
    }

    return [];
  }


  function _disableDraggable(el) {
    el.draggable = false;
  }


  function _unsilent() {
    _silent = false;
  }


  /** @returns {HTMLElement|false} */
  function _ghostInBottom(el, evt) {
    var lastEl = el.lastElementChild, rect = lastEl.getBoundingClientRect();
    return (evt.clientY - (rect.top + rect.height) > 5) && lastEl; // min delta
  }


  /**
   * Generate id
   * @param   {HTMLElement} el
   * @returns {String}
   * @private
   */
  function _generateId(el) {
    var str = el.tagName + el.className + el.src + el.href + el.textContent,
      i = str.length,
      sum = 0;

    while (i--) {
      sum += str.charCodeAt(i);
    }

    return sum.toString(36);
  }


  // Export utils
  Sortable.utils = {
    on: _on,
    off: _off,
    css: _css,
    find: _find,
    bind: _bind,
    closest: _closest,
    toggleClass: _toggleClass,
    dispatchEvent: _dispatchEvent
  };


  Sortable.version = '0.7.1';


  /**
   * Create sortable instance
   * @param {HTMLElement}  el
   * @param {Object}      [options]
   */
  Sortable.create = function (el, options) {
    return new Sortable(el, options);
  };

  // Export
  return Sortable;
});
define('core/table/table.bodyview',[
  'app',
  'backbone',
  'sortable',
  'core/notification'
],

function(app, Backbone, Sortable, Notification) {

  

  var TableBodyView = Backbone.Layout.extend({

    tagName: 'tbody',

    template: 'tables/table-body',

    events: {
      'change td.check > input': 'select',
      'click td.check > input': function() {
        this.collection.trigger('select');
      },
      'click .sort': function(e) {
        e.cancelBubble = true;
        e.stopPropagation();
        e.preventDefault();
        return false;
      },
      'mousedown .sort': function(e) {
        if($(e.target).closest('.disable-sorting').length > 0){
          Notification.info('Sorting Disabled', '<i>Click the reordering icon to enable</i>', {timeout: 4000});
        }
      }
    },

    select: function(e) {
      var $target = $(e.target);

      if ($target.attr('checked') !== undefined) {
        $target.closest('tr').addClass('selected');
      } else {
        $target.closest('tr').removeClass('selected');
      }
    },

    serialize: function() {
      var rowIdentifiers, statusState, models, rows;
      var statusColumns = this.collection.getFilter('status') || '1,2';
      var highlightIds = this.options.highlight || [];

      rowIdentifiers = this.options.rowIdentifiers;

      //Filter active/inactive/deleted items
      statusState = _.map(statusColumns,Number);
      models = this.collection.filter(function(model) {
        if (model.has(app.statusMapping.status_name)) {
          return (_.indexOf(statusState, Number(model.get(app.statusMapping.status_name))) > -1);
        } else {
          return true;
        }
      });


      //Evaluate filter object
      var expressions = this.options.filters.expressions;
      var booleanOperator = this.options.filters.booleanOperator || 'AND';

      if (expressions !== undefined) {
        models = _.filter(models, function(model) {
          var tests = [];
          var result = false;

          // Evaluate each filter
          _.each(expressions, function(expression) {
            var columnValue = model.get(expression.column, {flatten: true});
            tests.push(app.evaluateExpression(columnValue, expression.operator, expression.value));
          });

          switch (booleanOperator) {
            case '||': return _.contains(tests, true);
            case '&&': return _.every(tests,_.identity);
          }

        });
      }

      rows = _.map(models, function(model) {
        var classes = _.map(rowIdentifiers, function(columnName) { return 'row-'+columnName+'-'+model.get(columnName); });
        var highlight = _.contains(highlightIds,model.id);

        return {model: model, classes: classes, highlight: highlight};
      });

      var tableData = {
        columns: this.collection.getColumns(),
        rows: rows,
        sortable: this.options.sort,
        selectable: this.options.selectable,
        deleteColumn: this.options.deleteColumn
      };

      var blacklist = this.options.blacklist;

      tableData.columns = _.difference(tableData.columns, blacklist);

      return tableData;
    },

    drop: function() {
      var collection = this.collection;
      this.$('tr').each(function(i) {
        // Use data-id instead of data-cid
        // As collection models will be synced from the server its cid will be generated again
        // But the dom element will be still pointing to the older cid
        collection.get($(this).attr('data-id')).set({sort: i},{silent: true});
      });

      if (this.options.saveAfterDrop) {
        // collection.save({columns:['id','sort']});
        var self = this;
        collection.save(null, {wait: true, patch: true, success: function() {
          self.collection.setOrder('sort', 'ASC', {silent: false});
        }});
      } else {
        this.collection.setOrder('sort','ASC',{silent: true});
      }
    },

    initialize: function(options) {
      this.options.filters = this.options.filters || {};
      this.sort = this.options.structure.get('sort') || options.sort;
      this.collection.on('sort', this.render, this);
      if (this.sort) {
        var container = this.$el[0];
        var that = this;
        options.parentView.sortableWidget = new Sortable(container, {
          animation: 150, // ms, animation speed moving items when sorting, `0` — without animation
          handle: ".sort", // Restricts sort start click/touch to the specified element
          draggable: "tr", // Specifies which items inside the element should be sortable
          ghostClass: "sortable-ghost",
          sort: false,
          onStart: function (evt) {
            //var dragItem = jQuery(evt.item);
            var tbody = jQuery(container);
            tbody.addClass('remove-hover-state');
            tbody.removeClass('disable-transform');
          },
          onEnd: function (evt) {
            //var dragItem = jQuery(evt.item);
            var tbody = jQuery(container);
            tbody.removeClass('remove-hover-state');
            tbody.addClass('disable-transform');
          },
          onUpdate: function (evt){
            // app.router.openModal({type: 'confirm', text: 'Are you sure you want to reorder these items?', callback: function() {
            //   that.drop();
            // }});
            that.drop();
          }
        });

        if (options.parentView.sortable) {
          options.parentView.enableSortable();
        }
      }
    }
  });

  return TableBodyView;

});

define('core/table/table.footerview',[
  'app',
  'backbone',
  'helpers/ui'
],

function(app, Backbone, UIHelper) {

  

  var TableFooterView = Backbone.Layout.extend({
    tagName: 'tfoot',
    template: 'tables/table-foot',

    functions: {},

    events: {
      'change select': function(e) {
        var $target = $(e.target);
        var operation = $target.find(":selected").val().toLowerCase();
        var column = $(e.target).attr('data-id');
        var set = this.collection.pluck(column);
        var value = this.calculate(set, operation);
        $target.next('p').html(value);
      },
      'mouseover .footer-function': function(e) {
        $(e.target).closest('.footer-function').find('ul').removeClass('hide');
      },
      'mouseout .footer-function': function(e) {
        $(e.target).closest('.footer-function').find('ul').addClass('hide');
      },
      'click .footer-function li': function(e) {
        this.functions[$(e.target).closest('.footer-function').attr('data-column')] = $(e.target).text();
        this.render();
      }
    },

    calculate: function(set, operation) {
      var sum = _.reduce(set, function(memo, num){
        return Number(memo) + Number(num);
      }, 0);
      switch(operation) {
        case 'MIN':
          return String(_.min(set)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        case 'MAX':
          return String(_.max(set)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        case 'AVG':
          return String(Math.round(100 * sum / set.length) / 100).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        case 'SUM':
          return String(sum).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
    },

    serialize: function() {
      // get whitelisted columns first
      var blacklist = this.options.blacklist || [];
      var columns = _.filter(this.collection.getColumns(), function(column) {
        return ! _.contains(blacklist, column);
      });

      var hasANumericColumn = false;
      columns = _.map(columns, function(column) {
        var columnInfo = this.collection.structure.get(column);
        var showFooter = columnInfo.options.get('footer') === true;
        var isANumericColumn = UIHelper.supportsNumeric(columnInfo.get('type'));

        if (isANumericColumn) {
          hasANumericColumn = true;
        }

        var col = {
          title: column,
          showFooter: isANumericColumn && showFooter,
          selectedFunction: this.functions.hasOwnProperty(column) ? this.functions[column] : 'SUM'
        };

        col.otherFunctions = _.without(['MIN', 'MAX', 'AVG', 'SUM'], col.selectedFunction);

        if (col.showFooter) {
          col.value = this.calculate(this.collection.pluck(column), col.selectedFunction);
        }

        return col;
      }, this);

      return {
        columns: columns,
        selectable: this.options.selectable,
        sortable: this.options.sort,
        hasANumericColumn: hasANumericColumn
      };
    },

    initialize: function(options) {
      if (this.collection.preferences) {
        this.collection.preferences.on('change:columns_visible', this.render, this);
      }
    }
  });

  return TableFooterView;

});

(function($) {
  $.fn.flashRow = function() {
    var transitionEvents = [
      'webkitTransitionEnd',
      'otransitionend',
      'oTransitionEnd',
      'msTransitionEnd',
      'transitionend'
    ];
    var self = this;
    var classRemoved = false;
    var t = setTimeout(function() {
      clearTimeout(t);
      if(!classRemoved) {
        self.removeClass('highlight');
      }
    }, 1000);

    this.one(transitionEvents.join(','), function(e) {
      self.removeClass('highlight');
      classRemoved = true;
    });

    this.addClass('highlight');
  };
})(window.jQuery);
define("plugins/jquery.flashrow", function(){});

define('core/table/table.view',[
  "app",
  'underscore',
  "backbone",
  'core/notification',
  'core/t',
  'helpers/model',
  "core/table/table.headview",
  "core/table/table.bodyview",
  "core/table/table.footerview",
  "plugins/jquery.flashrow"
],

function(app, _, Backbone, Notification, __t, ModelHelper, TableHead, TableBody, TableFooter) {

  

  var TableView = Backbone.Layout.extend({

    tagname: 'div',
    attributes: {'class':'directus-table-container'},
    template: 'tables/table',

    TableBody: TableBody,

    serialize: function() {
      return {
        columns: this.options.columns,
        id: this.collection.table.id,
        selectable: this.options.selectable,
        sortable: this.options.sortable,
        disabledSorting: !this.sortable,
        showEmptyMessage: (this.collection.length === 0 && !this.options.hideEmptyMessage)
      };
    },

    events: {
      'click tbody td:not(.check):not(.status):not(.sort)' : function(e) {
        var id = $(e.target).closest('tr').attr('data-id');
        if (this.options.navigate) {
          this.collection.off();
          this.navigate(id);
        }
      }
    },

    navigate: function(id) {
      var route = Backbone.history.fragment.split('/');
      route.push(id);
      app.router.go(route);
    },

    selection: function() {
      var selection = [];
      $('td.check > input:checked').each(function() { selection.push(parseInt(this.value,10)); });
      return selection;
    },

    beforeRender: function() {
      var options;
      this.startRenderTime = new Date().getTime();

      if (this.tableHead) {
        options = this.options;
        options.parentView = this;
        this.insertView('table', new TableHead(options));
      }

      if (this.collection.length > 0) {
        options = _.pick(this.options, 'collection', 'selectable', 'filters', 'preferences', 'structure', 'sort', 'deleteColumn', 'rowIdentifiers', 'saveAfterDrop', 'blacklist', 'highlight', 'columns');
        options.parentView = this;
        this.insertView('table', new this.TableBody(options));
      }

      if (this.collection.length > 0 && this.options.footer !== false) {
        this.insertView('table', new TableFooter(this.options));
      }
    },

    flashItemID: undefined,
    bodyScrollTop: undefined,
    flashItem: function(entryID, bodyScrollTop) {
      this.flashItemID = entryID;
      this.bodyScrollTop = parseInt(bodyScrollTop, 10) || 0;
    },

    afterRender: function() {
      var now = new Date().getTime();
      //console.log('rendered table ' + this.collection.table.id + ' in '+ (now-this.startRenderTime)+' ms');

      if (this.bodyScrollTop) {
        document.body.scrollTop = this.bodyScrollTop;
      }

      this.bodyScrollTop = undefined;
      app.on('load', function() {
        if(this.flashItemID) {
          this.$el.find('tr[data-id="' + this.flashItemID + '"]').flashRow();
        }
        this.flashItemID = undefined;
      }, this);
    },

    initializeDrop: function() {
      //Cache a reference to the this.$el
      var $el = this.$el;
      var collection = this.collection;
      var saveAfterDrop = this.saveAfterDrop;

      // This timer prevent's the overlay to flicker when dragleave leaves for
      // a child item that triggers dragenter again.
      var timer;

      // If collection supports dnd
      // Since dragenter sux, this is how we do...
      $el.on('dragover', function(e) {
        clearInterval(timer);
        e.stopPropagation();
        e.preventDefault();
        $el.addClass('dragover');
      });

      $el.on('dragleave', function(e) {
          clearInterval(timer);
          timer = setInterval(function(){
            $el.removeClass('dragover');
            console.log('leave');
            clearInterval(timer);
          },50);
      });

      // Since data transfer is not supported by jquery...
      // XHR2, FormData
      this.el.ondrop = _.bind(function(e) {
        e.stopPropagation();
        e.preventDefault();

        app.sendFiles(e.dataTransfer.files, function(data) {
          _.each(data, function(item) {
            item.user = app.users.getCurrentUser().id;
            item[app.statusMapping.status_name] = app.statusMapping.active_num;

            if (saveAfterDrop) {
              //@todo: update collection status count
              collection.create(item);
            } else {
              console.log('ADD');
              collection.add(item, {nest: true, parse: true});
            }
          });
        });
        $el.removeClass('dragover');
      }, this);
    },

    getTableColumns: function() {
      var structure = this.collection.structure,
          blacklist = this.options.blacklist || [],
          columns;

      columns = _.filter(this.collection.getColumns(), function(col) {
        var columnModel = structure.get(col),
            hiddenInput = (columnModel && columnModel.get('hidden_input') !== true);

        return !_.contains(blacklist, col) && hiddenInput;
      });

      return columns;
    },

    toggleSortable: function() {
      if (this.sortableWidget.options.sort) {
        this.disableSortable();
        Notification.info(__t('table_sort_disabled'), '<i>'+__t('table_sort_disabled_message')+'</i>', {timeout: 3000});
      } else {
        // hotfix: do not enable sort when there multiple pages
        if (this.collection.getTotalCount() > this.collection.rowsPerPage) {
          Notification.warning(__t('table_sort_disabled'), '<i>'+__t('table_sort_multiple_pages_message')+'</i>', {timeout: 6000});
          return;
        }

        this.enableSortable();
        Notification.info(__t('table_sort_enabled'), '<i>'+__t('table_sort_enabled_message')+'</i>', {timeout: 3000});
      }
    },

    enableSortable: function() {
      this.$el.find('table').removeClass('disable-sorting');
      this.sortable = this.sortableWidget.options.sort = true;
    },

    disableSortable: function() {
      this.$el.find('table').addClass('disable-sorting');
      this.sortable = this.sortableWidget.options.sort = false;
    },

    initialize: function(options) {
      var collection = this.collection;

      this.listenTo(collection, 'sync', function(model, resp, options) {
        options = options || {};
        if (options.silent) return;
        ModelHelper.setIdAttribute(model);
        this.render();
      });

      this.listenTo(collection, 'visibility', function() {
        this.options.columns = this.getTableColumns();
        this.render();
      });

      this.listenTo(app.router.v.main, 'flashItem', this.flashItem);

      this.options.preferences = this.options.preferences || this.collection.preferences;
      this.options.structure = this.options.structure || this.collection.structure;
      this.options.table = this.options.table || this.collection.table;
      this.options.columns = this.getTableColumns();

      if (this.options.tableHead !== false) {
        this.tableHead = true;
      }

      if(collection.length > 0) {
        this.tableHead = true;
      }

      if (this.options.sort === undefined) {
        this.options.sort = collection.hasColumn('sort') && collection.hasPermission && collection.hasPermission('bigedit') && !collection.isWriteBlacklisted('sort');
      }

      if (this.options.selectable === undefined) {
        this.options.selectable = true;
      }

      // ==================================================================================
      // Drag and drop sort
      // ----------------------------------------------------------------------------------
      // Let remember the sortable value of the table
      // After the view is rendered this value gets set to false again
      // Not being able to sort again until it's pressed.
      // Or not letting the entries to be sort if the entries are bigger than perPage limit
      // ==================================================================================
      if (this.sortable === undefined) {
        this.sortable = false;
      }

      this.saveAfterDrop = this.options.saveAfterDrop = (options.saveAfterDrop !== undefined) ?  options.saveAfterDrop : true;

      if (this.options.droppable || collection.droppable) {
        this.initializeDrop();
      }
    },

    constructor: function (options) {
      // Add events from child
      if (this.events) {
        this.events = _.defaults(this.events, TableView.prototype.events);
      }
      Backbone.Layout.__super__.constructor.call(this, options);
    }
  });

  return TableView;

});

//  header..js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com


define('core/baseHeaderView',[
  'app',
  'backbone'
],

function(app, Backbone) {

  

  return Backbone.Layout.extend({

    template: 'header/header',

    tagName: 'div',

    lastHeaderHeight: 0,

    attributes: {
      class: 'main-container'
    },

    serialize: function() {
      var data = this.options.headerOptions;

      if(this.options.headerOptions.route.breadcrumbs && this.options.headerOptions.route.breadcrumbs.length > 1) {
        data.route.lastBreadcrumbAnchor = this.options.headerOptions.route.breadcrumbs[this.options.headerOptions.route.breadcrumbs.length-1].anchor;
      }

      return data;
    },
    beforeRender: function() {
      var options = this.options.headerOptions;

      var that = this;
      if(options.leftToolbar) {
        options.leftToolbar.forEach(function(widget) {
          that.insertView('#tools-left-insert', widget);
        });
      }

      if(options.rightToolbar) {
        options.rightToolbar.forEach(function(widget) {
          that.insertView('#tools-right-insert', widget);
        });
      }

      if(options.leftSecondaryToolbar) {
        options.leftSecondaryToolbar.forEach(function(widget) {
          that.insertView('#tools-secondary-left-insert', widget);
        });
      }

      if(options.rightSecondaryToolbar) {
        options.rightSecondaryToolbar.forEach(function(widget) {
          that.insertView('#tools-secondary-right-insert', widget);
        });
      }
    },
    afterRender: function() {
      //$(window).bind('resize.app', _.bind(this.setMarginToHeaderHeight, this));

      var secondaryToolbarWidgetCount = this.$el.find('#tools-secondary-left-insert').children().length + this.$el.find('#tools-secondary-right-insert').children().length;
      if(secondaryToolbarWidgetCount > 0) {
        this.$el.parent().parent().addClass('has-toolbar');
      }

      //this.setMarginToHeaderHeight();
    },

    cleanup: function() {
      $(window).unbind("resize.app");
    },

    setMarginToHeaderHeight: function() {
      var $mainBody = $('#content .content-body'),
          startScrollTop = $mainBody.scrollTop(),
          newHeaderHeight = $('.header1').outerHeight(),
          headerHeightDifference = newHeaderHeight - this.lastHeaderHeight;

      if(newHeaderHeight > 0){
        $mainBody.css('margin-top', newHeaderHeight + 'px').scrollTop(startScrollTop + headerHeightDifference);
        this.lastHeaderHeight = newHeaderHeight;
      }
    }
  });
});
define('core/BasePageView',[
  "app",
  "backbone",
  "core/baseHeaderView"
],
function(app, Backbone, BaseHeaderView) {

  return Backbone.Layout.extend({

    template: 'basePage',

    chooseView: function(viewSet, viewName) {
      return _.isUndefined(viewName) ? viewSet : viewSet[viewName];
    },

    leftToolbar: function() {
      return [];
    },

    rightToolbar: function() {
      return [];
    },

    leftSecondaryToolbar: function() {
      return [];
    },

    rightSecondaryToolbar: function() {
      return [];
    },

    headerOptions: {

    },

    initToolbar: function() {
      this.headerOptions.leftToolbar = this.leftToolbar();
      this.headerOptions.rightToolbar = this.rightToolbar();
      this.headerOptions.leftSecondaryToolbar = this.leftSecondaryToolbar();
      this.headerOptions.rightSecondaryToolbar = this.rightSecondaryToolbar();

      this.headerView = new BaseHeaderView({headerOptions: this.headerOptions});
      this.setView('#fixedHeader', this.headerView);
    },

    reRender: function() {
      this.initToolbar();
      this.headerView.render();
    },

    beforeRender: function() {
      this.initToolbar();
    },
    fetchHolding: [],
    //Only fetch if we are not waiting on any widgets to get preference data
    tryFetch: function() {
      if(this.fetchHolding.length === 0) {
        var options = this.collection.options ? this.collection.options : {};
        this.collection.fetch(options);
      }
    },

    addHolding: function(cid) {
      this.fetchHolding.push(cid);
    },

    //Remove a cid from holding and try fetch
    removeHolding: function(cid) {
      this.fetchHolding.splice(this.fetchHolding.indexOf(cid), 1);
      this.tryFetch();
    }

  });
});
define('core/ListViewManager',['require','exports','module','core/table/table.view','jquery'],function(require, exports, module) {

  

  var TableView = require('core/table/table.view');
  var jQuery = require('jquery');

  /**
   * @private
   * Holds all UI's that are registered
   */
  var views = {};

  // Attach all methods to the UIManager prototype.
  module.exports = {

    register: function(listViews) {
      _.each(listViews, function(view) {
        views[view.id] = view.View;
      },this);
    },

    // Loads an array of paths to UI's and registers them.
    // Returns a jQuery Deferred's Promise object
    load: function(paths) {
      var self = this;
      var dfd = new jQuery.Deferred();

      require(paths, function() {
        self.register(_.values(arguments));
        dfd.resolve();
      });

      return dfd;
    },

    getInstance: function(options) {
      var viewId = options.collection.table.get('list_view');
      var View;

      if (viewId != null && views.hasOwnProperty(viewId)) {
        View = views[viewId];
      } else {
        View = TableView;
      }

      return new View(options);
    }

  };

});

define('core/widgets/PaginatorWidget',[
  "app",
  "backbone",
  'handlebars'
],

function(app, Backbone, Handlebars) {

  

  return Backbone.Layout.extend({

    template: Handlebars.compile('{{#unless hidePages}}<div class="btn-group"> \
  <a class="btn btn-round {{#unless pagePrev}}disabled{{/unless}} pag-prev"><span class="icon icon-triangle-left"></span></a> \
  <a class="btn btn-round {{#unless pageNext}}disabled{{/unless}} pag-next"><span class="icon icon-triangle-right"></span></a> \
</div>{{/unless}}'),

    events: {
      'click a.pag-next:not(.disabled)': function() {
        var page = this.collection.getFilter('currentPage') + 1;
        this.collection.filters.currentPage = page;
        this.collection.fetch();
      },

      'click a.pag-prev:not(.disabled)': function() {
        var page = this.collection.getFilter('currentPage') - 1;
        this.collection.filters.currentPage = page;
        this.collection.fetch();
      }
    },

    serialize: function() {
      return this.options.widgetOptions;
    },

    updatePaginator: function() {
      this.options.totalCount = this.collection.getTotalCount();
      this.options.widgetOptions.pageNext = (this.collection.getFilter('currentPage') + 1 < (this.options.totalCount / this.collection.getFilter('perPage') ) );
      this.options.widgetOptions.pagePrev = (this.collection.getFilter('currentPage') !== 0);


      if(this.collection.length !== this.collection.getFilter('perPage')) {
        this.options.widgetOptions.pageNext = false;
      }

      if(!this.options.widgetOptions.pageNext && !this.options.widgetOptions.pagePrev) {
        this.options.widgetOptions.hidePages = true;
      } else {
        this.options.widgetOptions.hidePages = false;
      }

      this.render();
    },

    initialize: function() {
      this.options.widgetOptions = {};
      this.updatePaginator();
      this.collection.on('sync', this.updatePaginator, this);
    }

  });

});

define('core/widgets/PaginationCountWidget',[
  'app',
  'backbone',
  'handlebars'
],
function(app, Backbone, Handlebars) {

  

  return Backbone.Layout.extend({

    template: Handlebars.compile('{{#if lBound}}{{number lBound}}–{{number uBound}} of {{number totalCount}}{{else}}{{t "widget_pagination_count_no_items_found"}}{{/if}}'),

    tagName: 'div',

    attributes: {
      class: 'tool vertical-center pagination-number'
    },

    serialize: function() {
      return this.options.widgetOptions;
    },

    updateCount: function() {
      var data = {};
      data.totalCount = this.collection.getTotalCount();
      data.lBound = Math.min(this.collection.getFilter('currentPage') * this.collection.getFilter('perPage') + 1, data.totalCount);
      data.uBound = Math.min(data.totalCount, data.lBound + this.collection.getFilter('perPage') - 1);

      if(this.collection.length < (data.uBound - data.lBound) + 1) {
        if(this.collection.length < this.collection.getFilter('perPage')) {
          data.totalCount = this.collection.length;
        } else {
          data.totalCount = "Many";
        }
        data.lBound = Math.min(this.collection.getFilter('currentPage') * this.collection.getFilter('perPage') + 1, data.totalCount);
        data.uBound = Math.min(data.totalCount, data.lBound + this.collection.getFilter('perPage') - 1);
      }
      if(this.collection.length >= this.collection.getFilter('perPage') && this.collection.filters.adv_search && this.collection.filters.adv_search.length > 0) {
        data.totalCount = "Many";
      }

      this.options.widgetOptions = data;
      this.render();
    },

    initialize: function() {
      this.options.widgetOptions = {};
      this.updateCount();
      this.collection.on('sync', this.updateCount, this);
    }
  });
});

define('core/widgets/ButtonWidget',[
  'app',
  'backbone',
  'handlebars'
],
function(app, Backbone, Handlebars) {

  

  return Backbone.Layout.extend({
    template: Handlebars.compile(' \
      <button type="button" id="{{buttonId}}" class="tool-item btn btn-header {{buttonClass}}"> \
        <i class="material-icons">{{iconClass}}</i> {{buttonText}} \
      </button>'
    ),

    tagName: 'li',
    attributes: {
      'class': 'tool input-and-button'
    },

    serialize: function() {
      return this.options.widgetOptions;
    },

    afterRender: function() {
      if(this.options.widgetOptions && this.options.widgetOptions.active) {
        $(this.el).addClass('active');
      }
    }
  });
});

define('core/widgets/SearchWidget',[
  'app',
  'backbone',
  'handlebars'
],
function(app, Backbone, Handlebars) {

  

  return Backbone.Layout.extend({
    template: Handlebars.compile(' \
      <button type="button" class="tool-item large-circle"> \
        <span class="icon icon-search"></span> \
      </button> \
      <input type="text" value="keyword">'
    ),

    tagName: 'li',
    attributes: {
      'class': 'tool input-and-button'
    },

    serialize: function() {
      return this.options.widgetOptions;
    },

    afterRender: function() {
      if(this.options.widgetOptions && this.options.widgetOptions.active) {
        $(this.el).addClass('active');
      }
    }
  });
});

define('core/widgets/SaveWidget',[
  'app',
  'backbone'
],
function(app, Backbone) {

  

  return Backbone.Layout.extend({
    template: 'core/widgets/save-widget',

    tagName: 'li',
    attributes: {
      'class': 'input-and-button'
    },
    serialize: function() {
      return this.options.widgetOptions;
    },
    setSaved: function(isSaved) {
      this.options.widgetOptions.isUpToDate = isSaved;
      this.render();
    },
    initialize: function(options) {
      if(!options.widgetOptions) {
        this.options.widgetOptions = {isUpToDate: true};
      }
    }
  });
});

define('core/PreferenceModel',['require','exports','module','backbone'],function(require, exports, module) {

  

  var Backbone                = require("backbone");

  var PreferenceModel = module.exports = Backbone.Model.extend({
      fetch: function(options) {
        this.trigger('fetch', this);
        var args = {
          data: $.param(options)
        };
        this.constructor.__super__.fetch.call(this, args);
      }
  });

});
define('core/widgets/VisibilityWidget',[
  'app',
  'underscore',
  'backbone',
  'handlebars',
  'core/PreferenceModel'
],
function(app, _, Backbone, Handlebars, PreferenceModel) {

  

  return Backbone.Layout.extend({
    // add bookmark button was moved to sidebar
    // if false is a way to keep it there unavailable just in case
    template: Handlebars.compile('\
    {{#if hasActiveColumn}} \
    <div class="simple-select dark-grey-color simple-gray left" title="Choose which items are displayed"> \
      <span class="icon icon-triangle-down"></span> \
      <select id="visibilitySelect" name="status" class="change-visibility"> \
        <optgroup label="{{t "status"}}"> \
          <option data-status value="{{allKeys}}">{{t "widget_visibility_all_items"}}</option> \
          {{#mapping}} \
            <option data-status value="{{id}}" {{#if isSelected}} selected {{/if}}>{{capitalize name}} {{t "status_items"}}</option> \
          {{/mapping}} \
        </optgroup> \
      </select> \
      <select id="template" style="display:none;width:auto;"><option id="templateOption"></option></select> \
    </div> \
    {{/if}}'),

    tagName: 'div',
    attributes: {
      'class': 'tool'
    },

    events: {
      'change #visibilitySelect': function(e) {
        var $target = $(e.target).find(":selected");
        if($target.attr('data-status') !== undefined && $target.attr('data-status') !== false) {
          var value = $(e.target).val();
          var name = {currentPage: 0};
          name['status'] = value;
          this.collection.setFilter(name);

          this.listenToOnce(this.collection.preferences, 'sync', function() {
            if (this.basePage) {
              this.basePage.removeHolding(this.cid);
            }

            if (this.defaultId) {
              this.collection.preferences.set({title:null, id: this.defaultId});
            }
          });
        }
      }
    },

    serialize: function() {
      var data = {hasActiveColumn: this.options.hasActiveColumn, mapping: []};
      var mapping = app.statusMapping.mapping;
      var statusSelected = this.collection.getFilter('status');

      var keys = [];
      _.each(mapping, function(value, key) {
        // Convert status id to number
        key = Number(key);

        // Do not show option for deleted status
        if (key !== app.statusMapping.deleted_num) {
          data.mapping.push({
            id: key,
            name: mapping[key].name,
            sort: mapping[key].sort,
            isSelected: statusSelected === key
          });
          keys.push(key);
        }
      });

      data.mapping.sort(function(a, b) {
        if (a.sort < b.sort) {
          return -1;
        }

        if (a.sort > b.sort) {
          return 1;
        }

        return 0;
      });

      data.allKeys = keys.join(',');

      return data;
    },

    afterRender: function() {
      if (this.options.hasActiveColumn) {
        $('#visibilitySelect').val(this.collection.preferences.get('status'));
      }

      // Adjust dropdown width dynamically
      // var sel = this.$el.find('#visibilitySelect');
      // this.$el.find('#templateOption').text( sel.find(":selected").text() );
      // sel.width( this.$el.find('#template').width() * 1.03 + 10 ); // +10 is for arrow on right
    },
    initialize: function() {
      var activeTable = this.collection.table.id;

      this.basePage = this.options.basePage;

      this.collection.on('sync', this.render, this);

      if (this.collection.table.columns.get(app.statusMapping.status_name)) {
        this.options.hasActiveColumn = true;
      }

      var options = {};
      if (app.router.loadedPreference) {
        options = {newTitle: app.router.loadedPreference};
      }

      this.listenToOnce(this.collection.preferences, 'sync', function() {
        if (this.basePage) {
          this.basePage.removeHolding(this.cid);
        }

        if (this.defaultId) {
          this.collection.preferences.set({title:null, id: this.defaultId});
        }
      });

      this.defaultId = this.collection.preferences.get('id');
      this.collection.preferences.fetch(options);
      if (this.basePage) {
        this.basePage.addHolding(this.cid);
      }
    }
  });
});

define('core/widgets/FilterWidget',[
  'app',
  'backbone',
  'handlebars'
],
function(app, Backbone, Handlebars) {

  

  return Backbone.Layout.extend({

    template: 'core/widgets/filter-widget',

    tagName: 'div',

    attributes: {
      class: 'tool'
    },

    filterUIMappings: {
      default: '<div class="filter-background"><input type="text" value="{{value}}" placeholder="{{t "widget_filter_value_placeholder"}}" name="keywords" maxlength="100" class="filter_ui"></div>',
      date: '<div class="filter-background"><input type="date" value="{{value}}" class="date filter_ui" name="keywords" id="advKeywords"></div>',
      checkbox: '<div class="filter-background"><input type="checkbox" {{#if value}}checked{{/if}} class="filter_ui" name="keywords" id="advKeywords"></div>'
    },

    events: {
      'click .removeFilterClass':function(e) {
        var index = $(e.target).parent().index();
        var title = $(e.target).parent().find('.filterColumnName').attr('data-filter-id');

        var value = this.options.filters[index].filterData.value;
        this.options.filters.splice(index, 1);

        this.updateFilters();
        if(value) {
          this.collection.fetch();
        }
        this.saveFilterString();
        this.render();
      },
      'change .adv-search-col-id': function(e) {
        var selectedVal = $(e.target).val();
        if(selectedVal !== "") {
          this.addNewFilter(selectedVal);
        }
      },
      'change .filter_ui': function(e) {
        this.processFilterChange(e);
      }
    },

    processFilterChange: function(e) {
      var type = 'like';
      if($(e.target).prop('tagName') === 'SELECT') {
        type = '=';
      }
      var data = {
        id: this.mysql_real_escape_string($(e.target).closest('li').find('.filterColumnName').attr('data-filter-id')),
        type: type,
        value: this.mysql_real_escape_string($(e.target).val())
      };

      if($(e.target).is(':checkbox')) {
        if($(e.target).prop('checked')) {
          data.value = 1;
        } else {
          data.value = 0;
        }
      }
      this.selfChanged = true;
      this.options.filters[$(e.target).closest('li').index()].filterData = data;
      this.updateFilters();
      this.collection.fetch();
      this.saveFilterString();
    },

    getFilterDataType: function(selectedColumn) {
      if(!selectedColumn || !this.collection.structure.get(selectedColumn)) {
        return;
      }

      var columnModel = this.collection.structure.get(selectedColumn);
      var columnModelType = columnModel.get('type');
      var newInput;

      switch(columnModelType) {
        case 'DATE':
        case 'DATETIME':
        case 'TIMESTAMP':
          newInput = this.filterUIMappings.date;
          break;
        case 'TINYINT':
          newInput = this.filterUIMappings.checkbox;
          break;
        default:
          newInput = this.filterUIMappings.default;
          break;
      }
      return newInput;
    },

    addNewFilter: function(selectedColumn) {
      var $filters = $('.advanced-search-fields-row');
      var that = this;
      var data = {};

      data.columnName = selectedColumn;

      if(this.collection.structure.get(selectedColumn).get('ui') === "many_to_one" || that.collection.structure.get(selectedColumn).get('ui') === "many_to_many" || that.collection.structure.get(selectedColumn).get('ui') === "one_to_many") {
        var columnModel = this.collection.structure.get(selectedColumn);

        if(columnModel.options.has('filter_type') && columnModel.options.get('filter_type') === "dropdown") {
          //Get Related Column Collection
          data.columnModel = columnModel;
          data.relatedCollection = app.getEntries(columnModel.relationship.get('related_table'));

          var name = {};
          name[app.statusMapping.status_name] = app.statusMapping.active_num;
          data.relatedCollection.fetch({includeFilters: false, data: name});
          this.listenTo(data.relatedCollection, 'sync', this.render);
        } else {
          data.filter_ui = this.getFilterDataType(selectedColumn);
        }
      } else if(this.collection.structure.get(selectedColumn).get('type') === "ENUM") {
        var columnModel = this.collection.structure.get(selectedColumn);
        var vals = columnModel.get('column_type').substring(5, columnModel.get('column_type').length-1);
        vals = vals.replace(/\'/g, "").split(',');
        data.dropdownValues = vals;
      } else if(that.collection.structure.get(selectedColumn).get('ui') === "multi_select") {
        var columnModel = that.collection.structure.get(selectedColumn);
        var keys = [];
        for(var k in JSON.parse(columnModel.options.get('options'))) keys.push(k);
        data.dropdownValues = keys;
      } else {
        data.filter_ui = this.getFilterDataType(selectedColumn);
      }
      data.filter_type = this.collection.structure.get(selectedColumn).get('type');
      data.filterData = {id: selectedColumn, type: 'like', value:''};
      this.options.filters.push(data);
      this.render();
    },

    serialize: function() {
      var data = {};
      data.filters = this.options.filters;
      data.tableColumns = this.collection.structure.pluck('id');
      if(this.collection.table.get('filter_column_blacklist')) {
        data.tableColumns = _.difference(data.tableColumns, this.collection.table.get('filter_column_blacklist').split(','));
      }
      data.tableColumns.sort(function(a, b) {
        if(a < b) return -1;
        if(a > b) return 1;
        return 0;
      });
      var that = this;
      var i=0;
      _.each(this.options.filters, function(item) {
        if(item.relatedCollection) {
          data.filters[i].relatedEntries = [];
          if(item.columnModel.options.has('filter_column')) {
            var visibleColumn = item.columnModel.options.get('filter_column');
          } else {
            var visibleColumn = item.columnModel.options.get('visible_column');
          }
          var displayTemplate = Handlebars.compile(item.columnModel.options.get('visible_column_template'));
          item.relatedCollection.each(function(model) {
            data.filters[i].relatedEntries.push({visible_column:model.get('id'), visible_column_template: displayTemplate(model.attributes)});
          });

          data.filters[i].relatedEntries = _.sortBy(data.filters[i].relatedEntries, 'visible_column_template');
        } else if(item.dropdownValues) {
          data.filters[i].relatedEntries = [];
          _.each(item.dropdownValues, function(model) {
            data.filters[i].relatedEntries.push({visible_column:model, visible_column_template: model});
          });
        } else {
          var template = Handlebars.compile(that.getFilterDataType(data.filters[i].columnName));
          if(item.filterData) {
            //Used for Checkboxes since they return 0 string
            if(item.filterData.value === "0") {
              item.filterData = 0;
            }
            data.filters[i].filter_ui = template({value: item.filterData.value});
          } else {
            data.filters[i].filter_ui = template({});
          }
        }

        i++;
      });

      return data;
    },

    afterRender: function() {
      $('.filter-ui').last().find('input').focus();
      var that = this;
      _.each(this.options.filters, function(item) {
        var columnModel = that.collection.structure.get(item.columnName);

        var table = columnModel.collection.table.id;
        var columns = columnModel.id;
        var visibleTemplate = '<div>{{'+columnModel.id+'}}</div>';

        if(columnModel.relationship) {
          table = columnModel.relationship.get('related_table');
          columns = columnModel.options.get('visible_columns');

          visibleTemplate = '<div>'+columnModel.options.get('visible_column_template')+'</div>';
        }

        if(item.relatedCollection || item.dropdownValues) {
          if(item.filterData) {
            that.$el.find('span[data-filter-id=' + item.columnName + ']').parent().find('.filter_ui').val(item.filterData.value);
          }
        }

        if(['DATETIME', 'DATE', 'TIMESTAMP'].indexOf(item.filter_type) !== -1) {
          return;
        }

        if(!columns) {
          return;
        }

        var bloodHoundOptions = {
          datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
          queryTokenizer: Bloodhound.tokenizers.whitespace,
          remote: app.API_URL + 'tables/' + table + '/typeahead/?columns=' + columns + '&q=%QUERY'
        };

        var fetchItems = new Bloodhound(bloodHoundOptions);
        fetchItems.initialize();

        var typeaheadSelector = that.$(".filter-form[data-filter-id-master=" + columnModel.id + "] > .filter-ui > input");

        typeaheadSelector.typeahead({
          minLength: 1,
          items: 5,
          valueKey: columns,
          template: Handlebars.compile(visibleTemplate)
        },
        {
          name: 'related-items',
          displayKey: 'value',
          source: fetchItems.ttAdapter()
        });

        typeaheadSelector.on('typeahead:selected', function(e, datum) {
          that.processFilterChange(e);
        });
      });

    /*  if(this.savedValue) {
        this.$el.find('.adv-search-col-id').val(this.savedValue);
      }

      this.setFilterRow();
      //this.updateFilterDataType(this.$el.find('.adv-search-col-id').val());*/
    },

    mysql_real_escape_string: function(str) {
      if(!str) {return "";}
      return str.replace(/[\0\x08\x09\x1a\n\r"'\\\%]/g, function (char) {
          switch (char) {
              case "\0":
                  return "\\0";
              case "\x08":
                  return "\\b";
              case "\x09":
                  return "\\t";
              case "\x1a":
                  return "\\z";
              case "\n":
                  return "\\n";
              case "\r":
                  return "\\r";
              case "\"":
              case "'":
              case "\\":
              case "%":
                  return "\\"+char; // prepends a backslash to backslash, percent,
                                    // and double/single quotes
          }
      });
    },

    updateFilters: function(bInit) {
      var filters = this.options.filters.map(function(item) {
        return item.filterData;
      });

      this.collection.setFilter('adv_search', filters);
      if(!bInit) {
        this.collection.setFilter('currentPage', 0);
      }

      if(app.router.loadedPreference) {
        if(this.basePage) {
          this.basePage.removeHolding(this.cid);
        }
      }
      //this.render();
    },

    saveFilterString: function() {
      var string = [];

      var filters = this.options.filters.map(function(item) {
        return item.filterData;
      });

      filters.forEach(function(search) {
        if(search) {
          string.push(search.id.replace(':','\\:') + ":" + search.type.replace(':','\\:') + ":" + String(search.value).replace(':','\\:').replace(',','\\,'));
        }
      });

      string = encodeURIComponent(string.join());
      this.collection.preferences.save({search_string: string});
    },

    setFilterRow: function(){
      var $advSearchFieldRow = $(".advanced-search-fields-row");
      var $advSearchFields = $(".advanced-search-fields");
          $advSearchFields.on("click", ".remove-adv-row", function(e){
            $(this).parent().remove();
          });
      this.getFilterRow = $advSearchFieldRow;
    },

    getFilterRow: "adv search fields row object",

    updateFiltersFromPreference: function() {
      this.options.filters = [];
      var search = this.collection.preferences.get('search_string');

      if(search !== null && search !== undefined) {
        search = decodeURIComponent(search).replace('\\,', '%21').split(",");
        var that = this;
        search.forEach(function(filter) {
          filter = filter.replace('\\:', '%20');
          filter = filter.split(':');

          if(filter.length === 3) {
            var data = {};
            var selectedColumn = filter[0].replace('%20',':');

            data.columnName = selectedColumn;
            if(!that.collection.structure.get(selectedColumn)) {
              return;
            }
            if(that.collection.structure.get(selectedColumn).get('ui') === "many_to_one" || that.collection.structure.get(selectedColumn).get('ui') === "many_to_many" || that.collection.structure.get(selectedColumn).get('ui') === "one_to_many") {
              var columnModel = that.collection.structure.get(selectedColumn);
              if(columnModel.options.has('filter_type') && columnModel.options.get('filter_type') === "dropdown") {
                //Get Related Column Collection
                data.columnModel = columnModel;
                data.relatedCollection = app.getEntries(columnModel.relationship.get('related_table'));

                var name = {};
                name[app.statusMapping.status_name] = app.statusMapping.active_num;
                data.relatedCollection.fetch({includeFilters: false, data: name});
                that.listenTo(data.relatedCollection, 'sync', that.render);
              } else{
                data.filter_ui = that.getFilterDataType(selectedColumn);
              }
            } else if(that.collection.structure.get(selectedColumn).get('type') === "ENUM") {
              var columnModel = that.collection.structure.get(selectedColumn);
              var vals = columnModel.get('column_type').substring(5, columnModel.get('column_type').length-1);
              vals = vals.replace(/\'/g, "").split(',');
              data.dropdownValues = vals;
            } else if(that.collection.structure.get(selectedColumn).get('ui') === "many_to_many") {
              data.filter_ui = that.getFilterDataType(selectedColumn);
            }else if(that.collection.structure.get(selectedColumn).get('ui') === "multi_select") {
              var columnModel = that.collection.structure.get(selectedColumn);
              var keys = [];
              for(var k in JSON.parse(columnModel.options.get('options'))) keys.push(k);
              data.dropdownValues = keys;
            }
            data.filter_type = that.collection.structure.get(selectedColumn).get('type');

            data.filterData = {id: selectedColumn, type: filter[1].replace('%20',':'), value: filter[2].replace('%20',':').replace('%21',',')};

            that.options.filters.push(data);
          }
        });
      }
      this.updateFilters(true);
      //this.collection.fetch();
      this.render();
    },

    initialize: function() {
      this.options.filters = [];
      this.listenTo(this.collection.preferences, 'change sync', function() {
        this.updateFiltersFromPreference();
      });
      this.basePage = this.options.basePage;
      if(app.router.loadedPreference) {
        if(this.basePage) {
          this.basePage.addHolding(this.cid);
        }
      } else {
        this.updateFiltersFromPreference();
      }
    }
  });
});

define('core/widgets/SelectionActionWidget',[
  'app',
  'backbone',
  'handlebars'
],
function(app, Backbone, Handlebars) {

  

  return Backbone.Layout.extend({
    template: Handlebars.compile(' \
      <ul class="tools left big-space"> \
        {{#mapping}} \
          <li class="tool rounded-button action actionBtn card-shadow" data-value="{{id}}" style="color:{{color}}">{{name}}</li> \
        {{/mapping}} \
        {{#if batchEdit}} \
        <li class="tool-separator">&nbsp;</li> \
        <li class="tool div-left rounded-button action card-shadow" id="batchEditBtn">Batch Edit</li> \
        {{/if}} \
      </ul> \
    '),

    tagName: 'li',
    attributes: {
      'class': 'input-and-button'
    },

    events: {
      'click .actionBtn': function(e) {
        var value = $(e.target).closest('li').attr('data-value');
        if(value === 0) {
          var that = this;
          app.router.openModal({type: 'confirm', text: 'Are you sure? This item will be removed from the system!', callback: function() {
            that.doAction(e);
          }});
        } else {
          this.doAction(e);
        }
      },
      'click #batchEditBtn': function(e) {
        var $checked = $('.select-row:checked');
        var ids = $checked.map(function() {
          return this.value;
        }).toArray().join();

        var route = Backbone.history.fragment.split('/');
        route.push(ids);
        app.router.go(route);
      }
    },

    doAction: function(e) {
      var value = $(e.target).closest('li').attr('data-value');
      var collection = this.collection;
      var status = collection.getFilter('status');
      var $checked = $('.select-row:checked');
      var models = [];
      var actionCollection = collection.clone();

      actionCollection.reset();
      $checked.each(function() {
        var model = collection.get(this.value);
        var attributes = {};

        if (model.has(app.statusMapping.status_name)) {
          attributes[app.statusMapping.status_name] = parseInt(value);
          model.set(attributes);
        }

        actionCollection.add(model);
        models.push(model);
      });

      var success = function() {
        collection.trigger('visibility');
        collection.trigger('select');
      };

      var options = {patch: true, validate: false, wait: true, success: success};
      if (actionCollection.size() === 1) {
        app.changeItemStatus(actionCollection.first(), value, options);
      } else {
        app.changeCollectionStatus(actionCollection, value, options);
      }
    },

    serialize: function() {
      var data = this.options.widgetOptions;
      var canDelete = this.collection.hasPermission('delete') || this.collection.hasPermission('bigdelete');
      var hasStatusColumn = this.collection.table.columns.get(app.statusMapping.status_name);

      var mapping = app.statusMapping.mapping;
      data.mapping = [];
      for (var key in mapping) {
        // if there's not permission to delete, we skip delete
        if (!canDelete && key === app.statusMapping.deleted_num) {
          continue;
        }

        // if there's not status column we skip everything but delete
        if (!hasStatusColumn && key !== app.statusMapping.deleted_num) {
          continue;
        }

        var entry = mapping[key];
        entry.id = key;
        data.mapping.push(entry);
      }

      data.mapping.sort(function(a, b) {
        if(a.sort < b.sort) {
          return -1;
        }
        if(a.sort > b.sort) {
          return 1;
        }
        return 0;
      });

      return this.options.widgetOptions;
    },
    beforeRender: function() {
      this.stopListening(this.collection, 'select');
      this.listenTo(this.collection, 'select', function() {
        var batchEdit = $('.select-row:checked').length > 1;
        if(this.options.widgetOptions.batchEdit !== batchEdit) {
          this.options.widgetOptions.batchEdit = batchEdit;
          this.render();
        }
      }, this);
    },
    initialize: function() {
      if(!this.options.widgetOptions) {
        this.options.widgetOptions = {};
      }
    }
  });
});

define('core/widgets/SelectedCountWidget',[
  'app',
  'backbone',
  'handlebars'
],
function(app, Backbone, Handlebars) {

  

  return Backbone.Layout.extend({

    template: Handlebars.compile('{{#if count}}{{number count}} Selected{{/if}}'),

    tagName: 'div',

    attributes: {
      class: 'tool vertical-center pagination-number'
    },

    serialize: function() {
      return this.options.widgetOptions;
    },

    updateCount: function() {
      this.options.widgetOptions.count = $('.select-row:checked').length;
      this.render();
    },

    initialize: function() {
      this.options.widgetOptions = {};
      this.updateCount();
      this.collection.on('select', this.updateCount, this);
    }
  });
});

define('core/widgets/widgets',[
  'core/widgets/PaginatorWidget',
  'core/widgets/PaginationCountWidget',
  'core/widgets/ButtonWidget',
  'core/widgets/SearchWidget',
  'core/widgets/SaveWidget',
  'core/widgets/VisibilityWidget',
  'core/widgets/FilterWidget',
  'core/widgets/SelectionActionWidget',
  'core/widgets/SelectedCountWidget'
],

function(PaginatorWidget, PaginationCountWidget, ButtonWidget, SearchWidget, SaveWidget, VisibilityWidget, FilterWidget, SelectionActionWidget, SelectedCountWidget) {

  return {
    PaginatorWidget: PaginatorWidget,
    PaginationCountWidget: PaginationCountWidget,
    ButtonWidget: ButtonWidget,
    SearchWidget: SearchWidget,
    SaveWidget: SaveWidget,
    VisibilityWidget: VisibilityWidget,
    FilterWidget: FilterWidget,
    SelectionActionWidget: SelectionActionWidget,
    SelectedCountWidget: SelectedCountWidget
  };

});
define('core/overlays/ListSelect',[
    'app',
    'backbone',
    'core/BasePageView',
    'core/ListViewManager',
    'core/widgets/widgets'
], function(app, Backbone, BasePageView, ListViewManager, Widgets) {

    return BasePageView.extend({

        headerOptions: {
            route: {
                title: 'Table View',
                isOverlay: true
            }
        },

        leftToolbar: function() {
            return [
                new Widgets.ButtonWidget({
                    widgetOptions: {
                        buttonId: "addBtn",
                        iconClass: "check",
                        buttonClass: "",
                        buttonText: "Choose"
                    }
                })
            ];
        },

        rightToolbar: function() {
            return [
                new Widgets.PaginatorWidget({
                    collection: this.collection
                })
            ];
        },

        leftSecondaryToolbar: function() {
            return [
                new Widgets.VisibilityWidget({
                    collection: this.collection,
                    basePage: this
                }),
                new Widgets.FilterWidget({
                    collection: this.collection,
                    basePage: this
                })
            ];
        },

        rightSecondaryToolbar: function() {
            return [
                new Widgets.PaginationCountWidget({
                    collection: this.collection
                })
            ];
        },


        events: {
            'click #removeOverlay': function() {
                app.router.removeOverlayPage(this);
            },
            'click #addBtn': function() {
                this.save();
            }
        },

        save: function() {
            console.log("Save");
        },

        afterRender: function() {
            this.setView('#page-content', this.table);
        },

        itemClicked: function(e) {
            var $target = $(e.target);
            var $checkbox = $target.closest('tr').find('td.check > input');

            if ($checkbox.prop('checked')) {
                $checkbox.prop('checked', false);
            } else {
                $checkbox.prop('checked', true);
            }
        },

        initialize: function(options) {

            //Default to true
            if (options.selectable === undefined) {
                options.selectable = true;
            }

            this.table = ListViewManager.getInstance({
                collection: this.collection,
                selectable: options.selectable
            });

            var that = this;

            this.table.events = {
                'click tbody td': function(e) {
                    that.itemClicked(e);
                }
            };

            this.headerOptions.route.title = this.collection.table.id;
        }
    });

});

define('core/overlays/VisibleColumnSelect',[
  'app',
  'backbone',
  'core/BasePageView',
  'core/ListViewManager',
  'core/widgets/widgets'
],

function(app, Backbone, BasePageView, ListViewManager, Widgets) {

  return BasePageView.extend({

    headerOptions: {
      route: {
        title: 'Table View',
        isOverlay: true
      },
    },

    leftToolbar: function() {
      return  [
        new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "add", buttonClass: "", buttonText: "Add"}})
      ];
    },

    events: {
      'click #removeOverlay': function() {
        app.router.removeOverlayPage(this);
      },
      'click #addBtn': function() {
        this.save();
      }
    },

    save: function() {
      console.log("Save");
    },

    afterRender: function() {
      this.setView('#page-content', this.table);
      this.table.render();
    },

    initialize: function(options) {
      this.table = options.contentView;

      this.headerOptions.route.title = this.collection.table.id + " Visible Columns";
    }

  });

});

define('core/overlays/overlays',[
        'core/overlays/ListSelect',
        'core/overlays/VisibleColumnSelect'
    ],

    function(ListSelect, VisibleColumnSelect) {

        return {
            ListSelect: ListSelect,
            VisibleColumnSelect: VisibleColumnSelect
        };

    });
//  Single Files core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('length') [any key from this UI options]
// options.name       String            Field name
/*jshint multistr: true */


define('core/uis/single_file',[
    'app',
    'underscore',
    'backbone',
    'core/t',
    'utils',
    'helpers/file',
    'core/UIComponent',
    'core/UIView',
    'core/table/table.view',
    'core/overlays/overlays'
  ],
  function(app, _, Backbone, __t, Utils, FileHelper, UIComponent, UIView, TableView, Overlays) {

  

  var template =  '<style type="text/css"> \
                  .ui-file-container:after { \
                    clear: both; \
                    content: ""; \
                    display: block; \
                    width: 100%; \
                  } \
                  div.single-image-thumbnail { \
                    float: left; \
                    max-height: 200px; \
                    background-color: #ffffff; \
                    color: #ededed; \
                    text-align: center; \
                    cursor: pointer; \
                    height: 160px; \
                  } \
                  div.single-image-thumbnail.empty { \
                    width: 156px; \
                    height: 156px; \
                    background-color: #ffffff; \
                    border: 2px dashed #bbbbbb; \
                    font-size: 12px; \
                    font-weight: 600; \
                    line-height: 14px; \
                    color: #bbbbbb; \
                  } \
                  div.single-image-thumbnail.empty span { \
                    margin-top: 28px; \
                    text-align: center; \
                    display: inline-block; \
                    line-height: 18px; \
                    padding: 0 30px 0 30px; \
                  } \
                  div.single-image-thumbnail.empty span i.material-icons { \
                    display: block; \
                    font-size: 60px; \
                    width: auto; \
                    margin-bottom: 5px; \
                  } \
                  div.single-image-thumbnail.empty.dragover, \
                  div.single-image-thumbnail.empty:hover { \
                    background-color: #BBBBBB; \
                    color: #ffffff; \
                    cursor: pointer; \
                  } \
                  div.single-image-thumbnail img { \
                    max-width: 160px; \
                    display: block; \
                  } \
                  div.ui-img-details.single_file { \
                    height: 120px; \
                    width: 220px; \
                    float: left; \
                    position: relative; \
                    line-height: 18px; \
                    padding:20px; \
                    background-color: #ececec; \
                  } \
                  div.ui-img-details.single_file .btn { \
                    position: absolute; \
                    bottom: 20px; \
                    left: 20px; \
                  } \
                  div.ui-img-details a.title { \
                    font-size: 16px; \
                    height: 20px; \
                    overflow: hidden; \
                    display: block; \
                    text-overflow: ellipsis; \
                    white-space: nowrap; \
                  } \
                  div.ui-img-details div { \
                    display: inline; \
                  } \
                  div.ui-img-details i { \
                    font-weight: 400; \
                    font-style: italic; \
                    color: #ccc; \
                    margin-top: 5px; \
                    display: block; \
                  } \
                  button.btn-right { \
                    margin-top: 8px; \
                    margin-right: 10px; \
                  } \
                  .choose-method-btn { \
                    display:block; \
                    clear: both; \
                    padding-top: 5px; \
                    cursor: pointer; \
                  } \
                  .single-image-actions { \
                    margin: 20px 0 0 0; \
                    display: block; \
                    font-size: 12px; \
                  } \
                  .single-image-actions span:hover { \
                    color: #333333; \
                    cursor: pointer; \
                  } \
                  </style> \
                  <div class="ui-file-container"> \
                    {{#if url}} \
                    <div class="single-image-thumbnail has-file"> \
                      {{#if html}}\
                        {{{html}}}\
                      {{else}} \
                        <div class="default-info js-image"><a href="#" class="title"><img src="{{thumbUrl}}"></div></div></a> \
                      {{/if}} \
                    </div> \
                    <div class="ui-img-details single_file"> \
                      <a href="#" class="title" title="{{fileModel.title}}">{{fileModel.title}}</a> \
                      <!--Uploaded by {{userName fileModel.user}} {{contextualDate fileModel.date_uploaded}}<br> --> \
                      <i>{{#if isImage}}{{fileModel.width}} &times; {{fileModel.height}} –{{/if}} {{fileModel.size}} - {{fileModel.type}}</i><br> \
                      <button class="btn btn-primary" data-action="remove-single-file" type="button">{{t "remove_file"}}</button> \
                    </div> \
                    {{else}} \
                    <div class="choose-method single-image-thumbnail empty ui-thumbnail-dropzone"><span><i class="material-icons">collections</i>{{t "directus_files_drop_or_choose_file"}}</span></div> \
                    <input id="urlInput" type="text" class="hide choose-method medium" /><button class="hide choose-method btn btn-small btn-primary margin-left-small" id="retriveUrlBtn" type="button">Retrieve</button> \
                    {{/if}} \
                    <input style="display:none" id="fileAddInput" type="file" class="large" /> \
                  </div> \
                  <div class="single-image-actions"> \
                    <button class="btn btn-primary btn-small margin-right-small" data-action="computer" type="button">{{t "file_upload"}}</button> \
                    <button class="btn btn-primary btn-small margin-right-small" data-action="url" type="button">{{t "url_import"}}</button> \
                    <button class="btn btn-primary btn-small" data-action="choose" type="button">{{t "directus_files"}}</button> \
                  </div>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'click button[data-action="remove-single-file"]': 'removeFile',
      'click button[data-action="choose"]': 'choose',
      'click .ui-img-details .title': 'edit',
      'click .choose-method-btn': function() {
        this.$el.find('.choose-method').toggleClass('hide');

        if(this.$el.find('#urlInput').is(':visible')) {
          this.$el.find('#urlInput').focus();
        }
      },
      'click #retriveUrlBtn': function(e) {
        var url = this.$el.find('#urlInput').val();
        var model = this.fileModel;
        model.setLink(url, this.options.settings.get('allowed_filetypes'));
      },
      'change input[type=file]': function(event) {
        var target = $(event.target);
        var file = target[0].files[0];
        var model = this.fileModel;
        var allowed = model.setFile(file, this.options.settings.get('allowed_filetypes'));
        if (allowed === false) {
          Utils.clearElement(target);
        }
      },
      'click button[data-action="computer"], .ui-thumbnail-dropzone, .single-image-thumbnail img': function(e) {
        this.$el.find('#fileAddInput').click();
      },
      'click button[data-action="url"]': function(e) {
        var that = this;
        app.router.openModal({type: 'prompt', text: __t('enter_the_url_to_a_file'), callback: function(url) {
          that.getLinkData(url);
        }});
      },
    },

    getLinkData: function(url) {
      if(!url) {
        return;
      }

      var model = this.fileModel;
      model.setLink(url, this.options.settings.get('allowed_filetypes'));
    },

    removeFile: function(e) {
      this.fileModel.clear();
      this.fileModel.set({id: null});
    },

    choose: function() {
      var collection = app.files;
      var model;
      var fileModel = this.fileModel;
      var view = new Overlays.ListSelect({collection: collection, selectable: true});
      app.router.overlayPage(view);

      collection.fetch();

      //please proxy this instead
      var self = this;

      view.itemClicked = function(e) {
        var id = $(e.target).closest('tr').attr('data-id');
        model = collection.get(id);

        if (model.isAllowed(self.options.settings.get('allowed_filetypes'))) {
          fileModel.clear({silent: true});
          fileModel.set(_.clone(model.attributes));
        }

        app.router.removeOverlayPage(this);
      };
    },

    edit: function() {
      var EditView = require("modules/tables/views/EditView");
      var model = this.fileModel;
      var view = new EditView({model: model});
      view.headerOptions.route.isOverlay = true;
      view.headerOptions.route.breadcrumbs = [];
      view.headerOptions.basicSave = true;

      view.events = {
        'click .saved-success': function() {
          this.save();
        },
        'click #removeOverlay': function() {
          app.router.removeOverlayPage(this);
        }
      };

      app.router.overlayPage(view);

      view.save = function() {
        model.set(model.diff(view.editView.data()));
        app.router.removeOverlayPage(this);
      };

      // Fetch first time to get the nested tables
      if (!model.isNew()) {
        model.fetch();
      }
    },

    afterRender: function() {
      var timer;
      var $dropzone = this.$el.find('.single-image-thumbnail');
      var model = this.fileModel;

      $dropzone.on('dragover', function(e) {
        clearInterval(timer);
        e.stopPropagation();
        e.preventDefault();
        $dropzone.addClass('dragover');
      });

      $dropzone.on('dragleave', function(e) {
        clearInterval(timer);
        timer = setInterval(function(){
          $dropzone.removeClass('dragover');
          clearInterval(timer);
        },50);
      });

      // Since data transfer is not supported by jquery...
      // XHR2, FormData
      $dropzone[0].ondrop = _.bind(function(e) {
        e.stopPropagation();
        e.preventDefault();

        if (e.dataTransfer.files.length > 1) {
          alert(__t('one_file_only_please'));
          return;
        }

        var file = e.dataTransfer.files[0];
        model.setFile(file, this.options.settings.get('allowed_filetypes'));
        $dropzone.removeClass('dragover');
      }, this);

      // Show fallback image if file missing
      FileHelper.onImageError(this.$('.js-image img'), function (event, element) {
        $(element).attr('src', app.PATH + 'assets/img/document.png');
      });
    },

    serialize: function() {
      var url, link;
      if (this.fileModel.has('name')) {
        if (this.fileModel.isNew()) {
          link = '#';
          url = this.fileModel.get('thumbnailData') || this.fileModel.get('url');
        } else {
          link = this.fileModel.makeFileUrl();
          url = this.fileModel.makeFileUrl(true) || link;
        }
      }

      var data = this.fileModel.toJSON();
      var type = this.fileModel.has('type') ? this.fileModel.get('type').substring(0, this.fileModel.get('type').indexOf('/')) : '';
      var isImage = _.contains(['image', 'embed'], type);
      var thumbUrl = isImage ? url : app.PATH + 'assets/img/document.png';

      if(data.type) {
        if(data.type === 'embed/youtube') {
          data.size = app.seconds_convert(data.size);
        } else if(data.type === 'embed/vimeo') {
          data.size = app.seconds_convert(data.size);
        } else {
          data.size = app.bytesToSize(data.size, 0);
        }
      } else {
        data.size = app.bytesToSize(data.size, 0);
      }
      var html = this.fileModel.get('html');
      if (html) {
        html = $(html).css({width: 280, height: 160}).prop('outerHTML');
      }

      data = {
        isImage: isImage,
        name: this.options.name,
        url: url,
        html: html,
        thumbUrl: thumbUrl,
        comment: this.options.schema.get('comment'),
        allowed_filetypes: this.options.settings.get('allowed_filetypes'),
        fileModel: data,
        link: link
      };

      return data;
    },

    initialize: function() {
      this.userId = app.users.getCurrentUser().id;
      this.fileModel = this.options.value;
      this.fileModel.on('change', this.render, this);
      //this.collection = app.getEntries('directus_files');
      //this.collection.fetch();
      if(this.collection) {
        this.listenTo(this.collection, 'reset', this.render);
      }
    }
  });

  var Component = UIComponent.extend({
    id: 'single_file',
    dataTypes: ['INT'],
    variables: [
      {id: 'allowed_filetypes', type: 'String', default_value:'', ui: 'textinput', char_length:200}
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value.attributes)) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      var model = options.value;
      //@TODO: Have this not be hardcoded
      if(!model.get('type') && model.get(options.schema.id) instanceof Backbone.Model) {
        model = model.get(options.schema.id);
      }
      var orientation = (parseInt(model.get('width'),10) > parseInt(model.get('height'),10)) ? 'landscape' : 'portrait';
      var type = (model.get('type')) ? model.get('type').substring(0, model.get('type').indexOf('/')) : '';
      var subtype = (model.get('type')) ? model.get('type').split('/').pop() : '';

      var isImage = _.contains(['image', 'embed'], type) || _.contains(['pdf'], subtype);
      var thumbUrl = isImage ? model.makeFileUrl(true) : app.PATH + 'assets/img/document.png';

      return '<div class="media-thumb"><img src="' + thumbUrl + '" class="img ' + orientation + '"></div>';
    }
  });

  return Component;
});

//  Slug Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/slug',[
  'app',
  'underscore',
  'core/UIComponent',
  'core/UIView',
  'core/t'
], function(app, _, UIComponent, UIView, __t) {

  

  var template = '<input type="text" value="{{value}}" name="{{name}}" id="{{name}}" maxLength="{{maxLength}}" class="{{size}}" {{#if readonly}}readonly{{/if}}/>'+
                 '<span class="char-count hide">{{characters}}</span>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'change input': function() {
        this.$el.find('.char-count').show();
      }
    },

    bindEvents: function () {
      var mirroredField = this.getMirroredFieldName();

      if (this.canUpdateSlug()) {
        $('.fields #' + mirroredField).on('keyup', _.bind(this.onKeyUp, this));
      }
    },

    unbindEvents: function () {
      var mirroredField = this.getMirroredFieldName();

      $('.fields #' + mirroredField).off('keyup', _.bind(this.onKeyUp, this));
    },

    onKeyUp: function (event) {
      var slug = $(event.currentTarget).val();

      this.updateSlug(slug);
    },

    getSlugInput: function () {
      if (!this.$slugField) {
        this.$slugField = this.$el.find('input');
      }

      return this.$slugField;
    },

    getMirroredFieldName: function () {
      var settings = this.options.settings;

      return settings.get('mirrored_field');
    },

    canUpdateSlug: function () {
      var settings = this.options.settings;
      var mirroredField = this.getMirroredFieldName();

      if (!mirroredField) {
        return false;
      }

      return !(settings.get('only_on_creation') === true && !this.model.isNew());
    },

    updateSlug: function (slug) {
      var $slugInput = this.getSlugInput();

      slug = slug.replace(/^\s+|\s+$/g, ''); // trim
      slug = slug.toLowerCase();

      // TODO: Create a helper to remove tilde, accents, etc.
      // Remove accents, swap ñ for n, etc
      var from = "ãàáäâẽèéëêìíïîõòóöôùúüûñç·/_,:;";
      var to   = "aaaaaeeeeeiiiiooooouuuunc------";
      for (var i=0, l=from.length ; i<l ; i++) {
        slug = slug.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
      }

      slug = slug.replace(/[^a-z0-9 \-]/g, '') // remove invalid chars
        .replace(/\s+/g, '-') // collapse whitespace and replace by -
        .replace(/-+/g, '-'); // collapse dashes

      $slugInput.val(slug);
    },

    afterRender: function () {
      var $slugInput = this.$('input');
      var value = this.options.value;
      var mirroredField = this.getMirroredFieldName();
      var model = this.options.model;

      if (this.options.settings.get('readonly') === true) {
        $slugInput.prop('readonly', true);
      }

      if (this.canUpdateSlug()) {
        this.updateSlug(value || model.get(mirroredField) || '');
        this.bindEvents();
      }
    },

    cleanup: function () {
      this.unbindEvents();
    },

    serialize: function() {
      var length = this.options.schema.get('char_length');
      var value = this.options.value || '';

      return {
        size: this.options.settings.get('size'),
        value: value,
        name: this.options.name,
        maxLength: length,
        comment: this.options.schema.get('comment'),
        readonly: this.options.settings.get('readonly') === true
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'slug',
    dataTypes: ['VARCHAR'],
    variables: [
      // Disables editing of the field while still letting users see the value
      {id: 'readonly', type: 'Boolean', default_value: true, ui: 'checkbox'},
      // Adjusts the max width of the input (Small, Medium, Large)
      {id: 'size', type: 'String', default_value:'large', ui: 'select', options: {options: {'large':__t('size_large'),'medium':__t('size_medium'),'small':__t('size_small')} }},
      // Enter the column name of the field the slug will pull it's value from
      {id: 'mirrored_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      // Whether to update slug only on creation
      {id: 'only_on_creation', type: 'Boolean', default_value: false, ui: 'checkbox', comment: __t('slug_only_on_creation_comment')}
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return 'This field is required';
      }
    },
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

//  Textarea Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/textarea',['app', 'core/UIComponent', 'core/UIView', 'core/t'],function(app, UIComponent, UIView, __t) {

  

  var template = '<textarea rows="{{rows}}" name="{{name}}" id="{{name}}" placeholder="{{placeholder_text}}" {{#if readonly}}readonly{{/if}}>{{value}}</textarea>';

  var Input = UIView.extend({
    templateSource: template,

    serialize: function() {
      return {
        value: this.options.value,
        name: this.options.name,
        rows: this.options.settings.get('rows'),
        placeholder_text: this.options.settings.get('placeholder_text'),
        comment: this.options.schema.get('comment'),
        readonly: !this.options.canWrite
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'textarea',
    dataTypes: ['TEXT', 'VARCHAR'],
    variables: [
      // The number of text rows available for the input before scrolling
      {id: 'rows', type: 'Number', default_value: 12, ui: 'numeric', char_length: 3},
      {id: 'placeholder_text', default_value:'', type: 'String', ui: 'textinput', char_length:200},
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        // TODO: fix this line, it is too repetitive
        // over all the UIs
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      return _.isString(options.value) ? options.value.replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '<span class="silver">--</span>';
    }
  });

  return Component;
});

//  Directus User List View component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/directus_user',['app', 'core/UIComponent', 'core/UIView'], function(app, UIComponent, UIView) {

  

  var Input = UIView.extend({
    initialize: function(options) {
      var user = app.users.get(options.value);
      if(user) {
        var avatar = user.getAvatar();
        this.$el.append('<img src="' + avatar + '" class="avatar"><span class="avatar-name">' + user.get('first_name') + ' ' + user.get('last_name') + '</span>');
      }
    }
  });

  var Component = UIComponent.extend({
    id: 'directus_user',
    system: true,
    sortBy: ['first_name','last_name'],
    Input: Input,
    list: function(options) {
      var html;

      switch(options.settings.get('format')) {
        case 'full':
          html = '{{userFull user}}';
          break;
        default:
          html = '{{userShort user}}';
          break;
      }

      return this.compileView(html, {user: parseInt(options.value,10)});
    }
  });

  return Component;
});

//  Directus User List View component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/directus_activity',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var Component = UIComponent.extend({
    id: 'directus_activity',
    system: true,
    Input: UIView,
    list: function(options) {
      var model = options.model;
      var action = model.get('action');
      var table = model.get('table_name');
      var type = model.get('type');
      var returnStr;

      var identifier = model.get('identifier');
      if(null === identifier)
        identifier = __t('directus_activity_entry_')+" #" + model.get('row_id');

      switch (type) {
        case 'FILES':
          returnStr = '<a href="#" data-action="files" data-id="'+model.get('row_id')+'">' + identifier + '</a> '+__t('directus_activity_action', {action: app.actionMap[action], preposition: app.prepositionMap[action]})+' <a href="#files">'+__t('files')+'</a>';
          break;
        case 'SETTINGS':
          returnStr = __t('directus_activity_this_settings_has_been_updated');
          break;
        case 'UI':
          returnStr = __t('directus_activity_a_ui_has_been_updated');
          break;
        default:
          var targetObjectPath;
          if (table === 'directus_users') {
            targetObjectPath = 'users/' + model.get('row_id');
          } else {
            targetObjectPath = '#tables/' + table + '/' + model.get('row_id');
          }
          returnStr =
            '<a href="' + targetObjectPath + '">' + identifier + ' </a>'+
            __t('directus_activity_action', {action: app.actionMap[action], preposition: app.prepositionMap[action]})+
            ' <a href="#tables/' + table + '">' + app.capitalize(table) + '</a>';
          break;
      }

      return returnStr;
    }
  });

  return Component;
});

/*jshint multistr: true */

define('core/uis/datetime/date',['app', 'core/UIComponent', 'core/UIView', 'moment', 'helpers/ui', 'core/t'], function(app, UIComponent, UIView, moment, UIHelper, __t) {

  

  function removeTimeFromFormat(format) {
    return format.replace(/(A|a|H|h|m|s|S|z|Z|x|X)/g, '');
  }

  var Input = UIView.extend({
    template: 'datetime/input',

    events: {
      'blur  input.date':   'updateValue',
      'blur  input.time':   'updateValue',
      'change  input.date': 'updateValue',
      'change  input.time': 'updateValue',
      'click .now':         'makeNow'
    },

    supportsTime: function(type) {
      type = type || this.columnSchema.get('type');

      return UIHelper.supportsTime(type);
    },

    makeNow: function() {
      this.value = moment();
      this.render();
    },

    getDate: function() {
      return {
        value: this.$('input[type=date]').val(),
        format: 'YYYY-MM-DD'
      }
    },

    updateValue: function() {
      var date = this.getDate();
      var val = date.value;
      var format = date.format;

      if (moment(val).isValid()) {
        this.$('#'+this.name).val(moment(val).format(format));
      } else {
        this.$('#'+this.name).val('');
      }
    },

    serialize: function() {
      var settings = this.options.settings;
      if (settings.get('auto-populate_when_hidden_and_null') === true && !this.value.isValid()) {
        this.value = moment();
      }

      var date = this.value;
      var dateValue = date.format('YYYY-MM-DD');

      return {
        hasValue: this.value.isValid(),
        useDate: true,
        useTime: false,
        dateValue: dateValue,
        value: dateValue,
        name: this.name,
        readonly: this.options.canWrite === false || (settings && settings.has('readonly')) ? settings.get('readonly') === true : false
      };
    },

    initialize: function() {
      var value = this.model.get(this.name);
      if(undefined === value) {
        this.value = moment('0000-00-00');
      } else {
        this.value = moment(value);
      }
    }
  });

  var Component = UIComponent.extend({
    id: 'date',
    dataTypes: ['DATE'],
    variables: [
      {id: 'readonly', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'format', type: 'String', ui: 'textinput', char_length: 255, default_value: 'YYYY-MM-DD', comment: '<a href="http://momentjs.com/docs/#/displaying/format/" target="_blank">Formatting Rules</a>', options: {placeholder_text: 'eg: YYYY-MM-DD HH:mm:ss'}},
      {id: 'contextual_date_in_listview', type: 'Boolean', ui: 'checkbox', comment: 'Eg: 3 days ago'},
      {id: 'auto-populate_when_hidden_and_null', type: 'Boolean', ui: 'checkbox', default_value: true}
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return __t('this_field_is_required');
      }

      var date = moment(value);
      if (!value || date.isValid()) {
        return;
      }

      return 'Not a valid date';
    },
    list: function(options) {
      var value = options.value;
      var format = this.getFormat(options);

      if (options.settings.get('contextual_date_in_listview') === true) {
        var momentDate = moment(options.value);
        value = '-';
        if (momentDate.isValid()) {
          value = momentDate.fromNow();
        }
      } else if (format) {
        value = moment(value).format(format);
      }

      return value;
    },
    getFormat: function(options) {
      var format = options.settings.get('format');

      return removeTimeFromFormat(format);
    },
    sort: function(options) {
      return options.value;
    }
  });

  return Component;
});

//  DateTime core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('length') [any key from this UI options]
// options.name       String            Field name
/*jshint multistr: true */


define('core/uis/datetime/datetime',['app', 'underscore', 'core/uis/datetime/date', 'moment'], function(app, _, UIDate, moment) {

  

  // The HTML5 date tag accepts RFC3339
  // YYYY-MM-DD
  // ---
  // The HTML5 time tag acceps RFC3339:
  // 17:39:57
  var dateFormat = 'YYYY-MM-DD';
  var timeFormat = 'HH:mm:ss';

  var ParentInput = UIDate.prototype.Input;
  var Input = ParentInput.extend({
    getDate: function() {
      var date = Input.__super__.getDate.apply(this, arguments);

      date.value += ' ' + this.$('input[type=time]').val();
      date.timeFormat = this.getTimeFormat();
      date.dateFormat = date.format;
      date.format += ' ' + date.timeFormat;

      return date;
    },
    getDateFormat: function() {
      return dateFormat;
    },
    getTimeFormat: function() {
      var includeSeconds = this.options.settings.get('include_seconds') === true;

      return includeSeconds ? timeFormat : timeFormat.replace(':ss', '');
    },
    serialize: function() {
      var data = ParentInput.prototype.serialize.apply(this, arguments);
      var date = this.value;
      var format = dateFormat + ' ' + timeFormat;
      var settings = this.options.settings;

      return _.extend(data, {
        hasValue: this.value.isValid(),
        useDate: true,
        useTime: true,
        timeValue: date.format(this.getTimeFormat()),
        dateValue: date.format(this.getDateFormat()),
        value: date.format(format),
        name: this.name,
        readonly: this.options.canWrite === false || (settings && settings.has('readonly')) ? settings.get('readonly') === true : false
      });
    },
  });

  var variables = UIDate.prototype.variables.slice();
  // @TODO: add time step setting
  variables.push({id: 'include_seconds', type: 'Boolean', default_value: true, ui: 'checkbox'});

  var Component = UIDate.extend({
    id: 'datetime',
    dataTypes: ['DATETIME', 'TIMESTAMP'],
    variables: variables,
    Input: Input,
    getFormat: function(options) {
      return options.settings.get('format');
    }
  });

  return Component;
});

//  Time core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('length') [any key from this UI options]
// options.name       String            Field name
/*jshint multistr: true */


define('core/uis/datetime/time',['app', 'moment', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, moment, UIComponent, UIView, __t) {

  

  function getTimeData(value, options) {
    if (!value) {
      return;
    }

    var date = new Date();
    var timeParts = value.split(':');

    date.setHours(parseInt(timeParts[0],10));
    date.setMinutes(parseInt(timeParts[1],10) || 0 );
    date.setSeconds(parseInt(timeParts[2],10) || 0 );

    var hours = (date.getHours() < 10 ? '0' : '') + date.getHours();
    var minutes = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
    var seconds = (date.getSeconds() < 10 ? '0' : '') + date.getSeconds();

    return {
      hours: hours,
      minutes: minutes,
      seconds: seconds,
      meridiem: (hours >= 12)? 'pm' : 'am'
    };
  }

  var Input = UIView.extend({
    template: 'datetime/input',

    events: {
      'blur  input.time':   'updateValue',
      'change  input.time': 'updateValue',
      'click .now': 'makeNow'
    },

    makeNow: function(e) {
      var timeFormat = 'HH:mm';
      if (this.options.settings.get('include_seconds') == 1) {
        timeFormat += ':ss';
      }

      this.value = moment().format(timeFormat);
      this.render();
    },

    getTime: function() {

      var format = 'HH:mm';

      if (this.options.settings.get('include_seconds') == 1) {
        format += ':ss';
      }

      return {
        value: this.$('input[type=time]').val(),
        format: format
      }
    },

    updateValue: function() {
      var time = this.getTime();
      var val = time.value;
      var format = time.format;

      if (moment(val, format).isValid()) {
        this.$('#'+this.name).val(val);
      } else {
        this.$('#'+this.name).val('');
      }
    },

    serialize: function() {
      var date = getTimeData(this.value, this.options);
      var settings = this.options.settings;
      var timeValue;

      if (date) {
        timeValue = [date.hours, date.minutes];
        if (this.options.settings.get('include_seconds') == 1) {
          timeValue.push(date.seconds);
        }

        timeValue = timeValue.join(':');
      }

      return {
        name: this.options.name,
        comment: this.options.schema.get('comment'),
        useDate: false,
        useTime: true,
        hasValue: true,
        timeValue: timeValue,
        value: timeValue,
        readonly: !this.options.canWrite || (settings && settings.has('readonly')) ? settings.get('readonly')!=0 : false
      };
    },

    initialize: function() {
      this.value = this.options.value;
    }
  });

  var Component = UIComponent.extend({
    id: 'time',
    dataTypes: ['TIME'],
    variables: [
      // @TODO: add time step setting
      {id: 'readonly', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'include_seconds', type: 'Boolean', default_value: false, ui: 'checkbox'}
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      var data = getTimeData(options);
      if (!data) {
        return '-';
      }

      var hours = data.hours;
      var minutes = data.minutes;
      var seconds = data.seconds;
      var meridiem = data.meridiem;
      var settings = options.settings;
      var includeSeconds = settings.get('include_seconds') === true;

      return hours + ':' + minutes + (includeSeconds ? ':' + seconds : '') + ' ' + meridiem;
    }
  });

  return Component;
});

//  Directus User Activity List View component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/directus_user_activity',['app', 'core/UIComponent', 'core/UIView', 'moment', 'core/t'], function(app, UIComponent, UIView, moment, __t) {

  

  var Component = UIComponent.extend({
    id: 'directus_user_activity',
    system: true,
    sortBy: 'last_login',
    Input: UIView,
    list: function(options) {
      if(options.model.get('last_access') !== null){
        var page_summary = '';
        var last_page = $.parseJSON(options.model.get('last_page')) || {};
        if(undefined === last_page.param) {
          page_summary += __t('directus_user_activity_route_action', {
            route: app.capitalize(last_page.route)
          });
        } else {
          switch(last_page.route) {
            case "entries":
              page_summary += __t('directus_user_activity_table_entries_action', {
                param: app.capitalize(last_page.param)
              });
              break;
            case "entry":
              var detailType = __t('action_edit');
              if("new" === last_page.path.substr(-3))
                detailType = __t('action_create');
              page_summary += __t('directus_user_activity_table_entry_action', {
                param: app.capitalize(last_page.param),
                action: detailType
              });
              break;
            case "user":
              page_summary += __t('directus_user_activity_user_edit_form');
              break;
          }
        }
        var activity_time = options.model.get('last_access');
        return '<a href="#'+last_page.path+'" title="'+activity_time+'">'+page_summary+' '+moment(activity_time).fromNow()+'</a>';
      } else {
        return '<a href="#">'+__t("directus_user_activity_never_logged_in")+'</a>';
      }
    }
  });

  return Component;
});

//  Directus User List View component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/directus_user_avatar',['app', 'core/UIComponent', 'core/UIView'], function(app, UIComponent, UIView) {

  

  var Input = UIView.extend({
    tagName: 'fieldset',
    initialize: function(options) {
      var user = app.users.get(options.value);
      if(user) {
        var avatar = user.getAvatar();
        this.$el.append('<img src="'+avatar+'" class="avatar" />');
      }
    }
  });

  var Component = UIComponent.extend({
    id: 'directus_user_avatar',
    system: true,
    sortBy: ['email'],
    Input: Input,
    list: function(options) {
      var html = '{{userAvatar user}}';

      return this.compileView(html, {user: parseInt(options.model.id,10)});
    }
  });

  return Component;
});

//  Directus User List View component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/directus_file_size',['app', 'core/UIComponent', 'core/UIView'], function(app, UIComponent, UIView) {

  

	var Component = UIComponent.extend({
    id: 'directus_file_size',
    system: true,
    Input: UIView,
    list: function(options) {
      return app.bytesToSize(options.value);
    }
  });

  return Component;
});

//  Blob core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/blob',['app', 'core/UIComponent', 'core/UIView'], function(app, UIComponent, UIView) {

  

  var Input = UIView.extend({
    initialize: function() {
      var image = document.createElement('img');
      image.src = 'data:image/png;base64,'+this.options.value;
      this.$el.append('<label>'+app.capitalize(this.options.name)+'</label>');
      this.$el.append(image);
    }
  });

  var Component = UIComponent.extend({
    id: 'blob',
    dataTypes: ['BLOB','MEDIUMBLOB'],
    Input: Input,
    list: function(options) {
      return 'BLOB';
    }
  });

  return Component;
});

//  Alias core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/alias',['app', 'core/UIComponent', 'core/UIView'], function(app, UIComponent, UIView) {

  

  var Component = UIComponent.extend({
    id: 'alias',
    dataTypes: ['ALIAS', 'ONETOMANY', 'MANYTOMANY'],
    Input: UIView,
  });

  return Component;
});

//  Password Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/salt',['app', 'core/UIComponent', 'core/UIView'], function(app, UIComponent, UIView) {

  

  var template = '<input type="text" value="{{value}}" name="{{name}}" id="{{name}}" maxLength="{{maxLength}}" class="medium" readonly/> \
                 <span class="label char-count hide">{{characters}}</span>';

  var Input = UIView.extend({
    templateSource: template,

    events: {},

    initialize: function(options) {
      this.options = options;
      this.value = this.options.value;

      if(_.isEmpty(this.options.value)) {
        this.value = this.uniqid();
        this.model.set(options.name, this.value);
      }
    },

    serialize: function() {
      return {
        value: this.value,
        name: this.options.name,
        comment: this.options.schema.get('comment')
      };
    },

    // credit: http://phpjs.org/functions/uniqid/
    uniqid: function (prefix, more_entropy) {
      // +   original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
      // +    revised by: Kankrelune (http://www.webfaktory.info/)
      // %        note 1: Uses an internal counter (in php_js global) to avoid collision
      // *     example 1: uniqid();
      // *     returns 1: 'a30285b160c14'
      // *     example 2: uniqid('foo');
      // *     returns 2: 'fooa30285b1cd361'
      // *     example 3: uniqid('bar', true);
      // *     returns 3: 'bara20285b23dfd1.31879087'
      if (typeof prefix === 'undefined') {
        prefix = "";
      }

      var retId;
      var formatSeed = function (seed, reqWidth) {
        seed = parseInt(seed, 10).toString(16); // to hex str
        if (reqWidth < seed.length) { // so long we split
          return seed.slice(seed.length - reqWidth);
        }

        if (reqWidth > seed.length) { // so short we pad
          return [1 + (reqWidth - seed.length)].join('0') + seed;
        }

        return seed;
      };

      // BEGIN REDUNDANT
      if (!this.php_js) {
        this.php_js = {};
      }

      // END REDUNDANT
      if (!this.php_js.uniqidSeed) { // init seed with big random int
        this.php_js.uniqidSeed = Math.floor(Math.random() * 0x75bcd15);
      }

      this.php_js.uniqidSeed++;

      retId = prefix; // start with prefix, add current milliseconds hex string
      retId += formatSeed(parseInt(new Date().getTime() / 1000, 10), 8);
      retId += formatSeed(this.php_js.uniqidSeed, 5); // add seed hex string
      if (more_entropy) {
        // for more entropy we add a float lower to 10
        retId += (Math.random() * 10).toFixed(8).toString();
      }

      return retId;
    }
  });

  var Component = UIComponent.extend({
    id: 'salt',
    dataTypes: ['VARCHAR'],
    skipSerializationIfNull: true,
    Input: Input,
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

//  Tags core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/tags',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template = '<input type="hidden" value="{{value}}" name="{{name}}" id="{{name}}"> \
                 <input type="text" class="medium" id="tag-input" style="margin-right:10px;" placeholder="{{t "tags_placeholder"}}"><button class="btn btn-primary margin-left" type="button">{{t "add"}}</button> \
                 <div style="width:84%;">{{#tags}}<span class="tag">{{this}}</span>{{/tags}}</div>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'keydown #tag-input': function(e) {
        // 188 = comma, 13 = enter
        if (e.keyCode === 188 || e.keyCode === 13) {
          e.preventDefault();
          this.insertTag();
        }
      },
      'click span': function(e) {
        var index = this.$el.find('.tag').index($(e.target));
        this.tags.splice(index,1);
        this.render();
      },
      'click button': 'insertTag'
    },

    insertTag: function() {
      var $input = this.$el.find('#tag-input');
      var data = $input.val();
      var force_lowercase = this.options.settings.get('force_lowercase') === true;
      if(force_lowercase){
        data = data.toLowerCase();
      }
      var tempTags = data.split(",");
      for (var i = tempTags.length - 1; i >= 0; i--) {
        var thisTag = tempTags[i].trim();
        if (this.tags.indexOf(thisTag) === -1) {
          this.tags.push(thisTag);
        }
      }
      this.render().$el.find('#tag-input').focus();
    },

    serialize: function() {
      //Filter out empty tags
      this.tags = _.filter(this.tags, function(tag) { return(tag !== ''); });

      return {
        value: this.tags.join(','),
        name: this.options.name,
        tags: this.tags,
        comment: this.options.schema.get('comment')
      };
    },

    initialize: function() {
      this.tags = this.options.value ? this.options.value.split(',') : [];
    }
  });

  var Component = UIComponent.extend({
    id: 'tags',
    dataTypes: ['TEXT','VARCHAR','CHAR'],
    variables: [
      // When on, all entered tags are converted to lowercase
      {id: 'force_lowercase', type: 'Boolean', default_value: true, ui: 'checkbox'}
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      var tags = options.model.attributes.tags ? options.model.attributes.tags.split(',') : [];

      if(tags.length){
        for (var i = 0; i < tags.length; i++) {
          tags[i] = '<span class="tag-static">' + tags[i] + '</span>';
        }

        return tags.join(' ');
      } else {
        return options.model.attributes.tags;
      }
    }
  });

  return Component;
});

//  Many To One core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/many_to_one',['app', 'backbone', 'handlebars', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, Backbone, Handlebars, UIComponent, UIView, __t) {

  

  var template = '<div class="select-container"> \
                    <select name="{{name}}" {{#unless canEdit}}disabled{{/unless}}> \
                    {{#if allowNull}}<option value="">{{placeholder_text}}</option>{{/if}} \
                    {{#data}}<option value="{{id}}" {{#if selected}}selected{{/if}}>{{{name}}}</option>{{/data}} \
                  </select> \
                  <i class="material-icons select-arrow">arrow_drop_down</i> \
                  </div>';

  var Input = UIView.extend({
    events: {
      'change select': function(e) {
        var model = this.model.get(this.name);
        var selectedId = parseInt($(e.target).find(':selected').val(),10);
        model.clear();
        model.set({id: selectedId});
      }
    },

    templateSource: template,

    serialize: function() {
      var optionTemplate = Handlebars.compile(this.options.settings.get('visible_column_template'));

      if(this.options.settings.get("readonly") === true) {
        this.canEdit = false;
      }

      var data = this.collection.map(function(model) {
        var data = model.toJSON();

        var name = optionTemplate(data);
        return {
          id: model.id,
          name: name,
          selected: this.options.value !== undefined && (model.id === this.options.value.id)
        };
      }, this);

      // default data while syncing (to avoid flickr when data is loaded)
      if (this.options.value !== undefined && this.options.value.id && !data.length) {
        data = [{
          id: this.options.value.id,
          name: this.options.value,
          selected: true
        }];
      }

      data = _.sortBy(data, 'name');

      return {
        canEdit: this.canEdit,
        name: this.options.name,
        data: data,
        handleBarString: this.options.settings.get('value_template'),
        comment: this.options.schema.get('comment'),
        use_radio_buttons: this.options.settings.get('use_radio_buttons') === true,
        allowNull: this.options.settings.get('allow_null') === true,
        placeholder_text: (this.options.settings.get('placeholder_text')) ?  this.options.settings.get('placeholder_text') : __t('select_from_below')
      };
    },

    initialize: function(options) {
      var relatedTable;
      // @todo display warning on UI & gracefully fail if the next value is undefined
      if(this.columnSchema.relationship) {
        relatedTable = this.columnSchema.relationship.get('related_table');
      } else {
        console.error(__t('column_misconfigured_in_directus_columns', {
          column: this.name
        }));
      }
      var value = this.model.get(this.name);
      this.canEdit = this.model.canEdit(this.name);
      this.collection = value.collection.getNewInstance({omit: ['preferences']});

      var active = 1;
      if(this.options.settings.get('visible_status_ids')) {
        active = this.options.settings.get('visible_status_ids');
      }
      var data = {'columns_visible[]': []};
      data[app.statusMapping.status_name] = active;

      var columns_visible =[];
      if(this.options.settings.get('visible_column')) {
        columns_visible = this.options.settings.get('visible_column').split(',');
      }

      columns_visible.forEach(function(column) {
        data['columns_visible[]'].push(column);
      });

      // FILTER HERE!
      this.collection.fetch({includeFilters: false, data: data});
      //this.collection.on('reset', this.render, this);
      this.collection.on('sync', this.render, this);
    }
  });

  var Component = UIComponent.extend({
    id: 'many_to_one',
    dataTypes: ['INT'],
    variables: [
      {id: 'readonly', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'visible_column', type: 'String', default_value: '', ui: 'textinput', char_length: 64, required: true, comment: __t('m2o_visible_column_comment')},
      {id: 'visible_column_template', type: 'String', default_value:'', ui: 'textinput', char_length: 64, required: true, comment: __t('m2o_visible_column_template_comment')},
      {id: 'visible_status_ids', type: 'String', ui: 'textinput', char_length: 64, required: true, default_value: '1', comment: __t('m2o_visible_status_ids_comment')},
      {id: 'placeholder_text', type: 'String', default_value: '', ui: 'textinput', char_length: 255, required: false, comment: __t('m2o_placeholder_text_comment')},
      {id: 'allow_null', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'filter_type', type: 'String', default_value: 'dropdown', required: true, ui: 'select', options: {options: {'dropdown':__t('dropdown'),'textinput':__t('text_input')} }},
      {id: 'filter_column', type: 'String', default_value: '', ui: 'textinput', char_length: 255, comment: __t('m2o_filter_column_comment')}
    ],
    Input: Input,
    forceUIValidation: true,
    list: function(options) {
      if (options.value === undefined) return '';

      if(options.settings.get('visible_column_template') !== undefined) {
        var displayTemplate = Handlebars.compile(options.settings.get('visible_column_template'));
        if (options.value instanceof Backbone.Model) {
          return displayTemplate(options.value.attributes);
        } else if(options.value instanceof Object) {
          return displayTemplate(options.value);
        }
      }

      if (options.value instanceof Backbone.Model) {
        return options.value.get(options.settings.get('visible_column'));
      }  else if(options.value instanceof Object) {
        return options.value[options.settings.get('visible_column')];
      }

      return options.value;
    }
  });

  return Component;
});

//  Text Input Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/radiobuttons',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template = '<style type="text/css"> \
                  label.radiobuttons { \
                    display:inline-block; \
                    margin-right: 20px; \
                    padding: 0 0 4px 0; \
                    font-weight: 500; \
                    font-size: 14px; \
                    cursor: pointer; \
                  } \
                  </style> \
                  <div style="margin-top: 14px;margin-bottom: 10px;"> \
                  {{#options}} \
                    <label class="radiobuttons" for="radio-{{value}}"><input style="margin-top:-3px;" type="radio" name="{{../name}}" value="{{value}}" id="radio-{{value}}" {{#if selected}}checked{{/if}}>{{value}}</label> \
                  {{/options}} \
                  </div>';

  var Input = UIView.extend({
    templateSource: template,

    serialize: function() {
      var options = [];

      if(this.options.settings.get('options')) {
        options = _.map(this.options.settings.get('options').split(','), function(item) {
          return {
            value: item,
            selected: (item === this.options.value)
          };
        }, this);
      }

      return {
        name: this.options.name,
        options: options,
        comment: this.options.schema.get('comment')
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'radiobuttons',
    dataTypes: ['VARCHAR'],
    variables: [
      {id: 'options', type: 'String', default_value: '', ui: 'textinput', char_length: 100, comment: __t('radiobuttons_options_comment')}
    ],
    Input: Input,
    // @TODO: Not working – not even being called
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return __t('this_field_is_required');
      }
    }
  });

  return Component;
});

//  Relational core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/one_to_many',['app', 'core/UIComponent', 'core/UIView', 'core/table/table.view', 'core/overlays/overlays', 'core/t'], function(app, UIComponent, UIView, TableView, Overlays, __t) {

  

  var template = '<div class="related-table"></div> \
                  <div class="btn-row">\
                  {{#if showAddButton}}\
                    <button class="btn btn-primary" data-action="add" type="button">{{tVarCapitalize "add_new_x_item" table=tableTitle}}</button>\
                  {{/if}}\
                  {{#if showChooseButton}}\
                    <button class="btn btn-primary" data-action="insert" type="button">{{t "choose_existing"}}</button>\
                  {{/if}}\
                  </div>';

  var Input = UIView.extend({
    templateSource: template,
    events: {
      'click div.related-table > div td:not(.delete)': 'editRow',
      'click button[data-action=add]': 'addRow',
      'click button[data-action=insert]': 'insertRow',
      'click td.delete': 'deleteRow'
    },

    editRow: function(e) {
      if (!this.canEdit) {
        return;
      }

      var cid = $(e.target).closest('tr').attr('data-cid');
      var model = this.relatedCollection.get(cid, true);
      this.editModel(model);
    },

    deleteRow: function(e) {
      var cid = $(e.target).closest('tr').attr('data-cid');
      var model = this.relatedCollection.get(cid);
      var relatedColumnName = this.columnSchema.relationship.get('junction_key_right');

      if (model.isNew()) return this.relatedCollection.remove(model);

      var attributes = {};
      attributes[app.statusMapping.status_name] = app.statusMapping.deleted_num;
      attributes[relatedColumnName] = null;
      model.set(attributes);
    },

    addRow: function() {
      var collection = this.relatedCollection;
      this.addModel(new collection.model({}, {collection: collection, parse: true, structure: collection.structure, table: collection.table, privileges: collection.privileges}));
    },

    editModel: function(model) {
      var EditView = require("modules/tables/views/EditView");
      var columnName = this.columnSchema.relationship.get('junction_key_right');
      var view = new EditView({
        model: model,
        hiddenFields: [columnName],
        skipFetch: (model.isNew() || model.unsavedAttributes())
      });

      view.headerOptions.route.isOverlay = true;
      view.headerOptions.route.breadcrumbs = [];
      view.headerOptions.basicSave = true;

      view.events = {
        'click .saved-success': function() {
          this.save();
        },
        'click #removeOverlay': function() {
          app.router.removeOverlayPage(this);
        }
      };

      app.router.overlayPage(view);

      view.save = function() {
        model.set(model.diff(view.editView.data()));
        app.router.removeOverlayPage(this);
      };
    },

    addModel: function(model) {
      var EditView = require("modules/tables/views/EditView");
      var collection = this.relatedCollection;
      var columnName = this.columnSchema.relationship.get('junction_key_right');
      var id = this.model.id;
      var view = new EditView({
        model: model,
        collectionAdd: true,
        hiddenFields: [columnName],
        parentField: {
          name: columnName,
          value: id
        },
        skipFetch: true
      });

      view.headerOptions.route.isOverlay = true;
      view.headerOptions.route.breadcrumbs = [];
      view.headerOptions.basicSave = true;

      view.events = {
        'click .saved-success': function() {
          this.save();
        },
        'click #removeOverlay': function() {
          app.router.removeOverlayPage(this);
        }
      };

      app.router.overlayPage(view);

      view.save = function() {
        var data = view.editView.data();
        data[columnName] = id;
        model.set(data);

        if (model.isValid()) {
          app.router.removeOverlayPage(this);
          collection.add(model, {nest: true});
        }
      };
    },

    insertRow: function() {
      var me = this;
      var columnName = this.columnSchema.relationship.get('junction_key_right');
      var collection = app.getEntries(this.relatedCollection.table.id);
      var view = new Overlays.ListSelect({collection: collection});

      app.router.overlayPage(view);
      view.save = function() {
        _.each(view.table.selection(), function(id) {
          var data = collection.get(id).toJSON();
          if (me.columnSchema.options.get('only_unassigned') === true) {
            var orphan = false;

            collection.each(function(model) {
              if (model.get(columnName) == null) {
                orphan = true;
              }
            });

            if (orphan) {
              return false;
            }
          }

          data[columnName] = me.model.get('id');
          me.relatedCollection.add(data, {nest: true});
        }, this);

        app.router.removeOverlayPage(this);
      };

      collection.fetch();
    },

    serialize: function() {
      return {
        title: this.name,
        tableTitle: this.relatedCollection.table.get('table_name'),
        canEdit: this.canEdit,
        showChooseButton: this.showChooseButton, //&& this.canEdit,
        showAddButton: this.showAddButton && this.canEdit
      };
    },

    afterRender: function() {
      this.setView('.related-table', this.nestedTableView).render();
    },

    initialize: function (options) {
      // Make sure that the relationship type is correct
      if (!this.columnSchema.relationship ||
           'ONETOMANY' !== this.columnSchema.relationship.get('type')) {
        throw __t('m2m_the_column_need_to_have_m2m_relationship', {
          column: this.columnSchema.id,
          type: 'ONETOMANY',
          ui: Component.id
        });
      }

      this.canEdit = !(options.inModal || false);

      var relatedCollection = this.model.get(this.name);
      var joinColumn = this.columnSchema.relationship.get('junction_key_right');
      var ids = relatedCollection.pluck('id');
      // NOTE: This will a collection method in the next version
      var hasUnsavedModels = _.some(relatedCollection.models, function(model) {
        return model.unsavedAttributes();
      });

      if (!hasUnsavedModels && ids.length > 0) {
        //Make sure column we are joining on is respected
        var filters = relatedCollection.filters;
        if (filters.columns_visible.length === 0) {
          filters.columns_visible = relatedCollection.structure.at(0).get('id');
        }

        //Pass this filter to select only where column = val
        filters.related_table_filter = {column: joinColumn, val: this.model.id};

        if(this.columnSchema.options.get('result_limit') !== undefined) {
          filters.perPage = this.columnSchema.options.get('result_limit');
        }

        relatedCollection.fetch({includeFilters: false, data: filters, success: function(collection) {
          _.each(collection.models, function(model) {
            return model.startTracking();
          });
        }});
      }

      this.showRemoveButton = this.columnSchema.options.get('remove_button') === true;
      this.showAddButton = this.columnSchema.options.get('add_button') === true;
      this.showChooseButton = this.columnSchema.options.get('choose_button') === true;

      this.nestedTableView = new TableView({
        collection: relatedCollection,
        selectable: false,
        sortable: false,
        footer: false,
        saveAfterDrop: true,
        deleteColumn: this.canEdit && this.showRemoveButton,
        hideColumnPreferences: true,
        hideEmptyMessage: true,
        tableHead: false,
        filters: {
          booleanOperator: '&&',
          expressions: [
            //@todo, make sure that this can also nest
            {column: joinColumn, operator: '===', value: this.model.id}
          ]
        }
      });

      if (relatedCollection.structure.get('sort')) {
        relatedCollection.setOrder('sort','ASC',{silent: true});
      }

      this.listenTo(relatedCollection, 'add change', function() {
        //Check if any rendered objects in collection to show or hide header
        if(this.relatedCollection.filter(function(d){return d.get(app.statusMapping.status_name) !== app.statusMapping.deleted_num;}).length > 0) {
          this.nestedTableView.tableHead = true;
        } else {
          this.nestedTableView.tableHead = false;
        }
        this.nestedTableView.render();
      }, this);

      this.listenTo(relatedCollection, 'remove', function() {
        this.nestedTableView.render();
      }, this);

      this.relatedCollection = relatedCollection;
    }
  });

  var Component = UIComponent.extend({
    id: 'one_to_many',
    dataTypes: ['ONETOMANY'],
    variables: [
      {id: 'visible_columns', type: 'String', ui: 'textinput', char_length: 255, required: true},
      {id: 'result_limit', type: 'Number', ui: 'numeric', char_length: 10, default_value: 100, comment: __t('o2m_result_limit_comment')},
      {id: 'add_button', type: 'Boolean', ui: 'checkbox'},
      {id: 'choose_button', type: 'Boolean', ui: 'checkbox', default_value: true},
      {id: 'remove_button', type: 'Boolean', ui: 'checkbox'},
      {id: 'only_unassigned', type: 'Boolean', ui: 'checkbox', default_value: false}
    ],
    Input: Input,
    validate: function(collection, options) {
      if (options.schema.isRequired() && collection.length === 0) {
        return __t('this_field_is_required');
      }
    },
    list: function() {
      return 'x';
    }
  });

  return Component;
});

//  Relational core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/many_to_many',['app', 'core/UIComponent', 'core/uis/one_to_many', 'core/table/table.view', 'core/overlays/overlays', 'core/t'], function(app, UIComponent, Onetomany, TableView, Overlays, __t) {

  

  var Input = Onetomany.prototype.Input.extend({

    events: {
      'click div.related-table > div td:not(.delete)': 'editRow',
      'click button[data-action=add]': 'addRow',
      'click button[data-action=insert]': 'insertRow',
      'click td.delete': 'deleteRow'
    },

    templateSource:
      '<div class="related-table"></div>' +
      '<div class="btn-row">{{#if showAddButton}}<button class="btn btn-primary margin-right-small" data-action="add" type="button">{{t "add_new"}}</button>{{/if}}' +
      '{{#if showChooseButton}}<button class="btn btn-primary" data-action="insert" type="button">{{t "choose_existing"}}</button>{{/if}}</div>',

    addRow: function() {
      this.addModel(new this.relatedCollection.nestedCollection.model({}, {collection: this.relatedCollection.nestedCollection, parse: true}));
    },

    deleteRow: function(e) {
      var cid = $(e.target).closest('tr').attr('data-cid');
      var model = this.relatedCollection.get(cid);

      if (model.isNew()) return this.relatedCollection.remove(model);
      var name = {};
      name[app.statusMapping.status_name] = app.statusMapping.deleted_num;
      model.set(name);
    },

    addModel: function(model) {
      var EditView = require("modules/tables/views/EditView");
      var collection = this.relatedCollection;
      var view = new EditView({model: model, inModal: true});
      view.headerOptions.route.isOverlay = true;
      view.headerOptions.route.breadcrumbs = [];
      view.headerOptions.basicSave = true;

      view.events = {
        'click .saved-success': function() {
          this.save();
        },
        'click #removeOverlay': function() {
          app.router.removeOverlayPage(this);
        }
      };


      app.router.overlayPage(view);

      view.save = function() {
        model.set(view.editView.data());
        collection.add(model,{nest: true});
        app.router.removeOverlayPage(this);
      };
    },

    insertRow: function() {
      var highLightIds = this.relatedCollection.map(function(model) {
        return model.get('data').id;
        //pluck('id');
      });
      var collection = app.getEntries(this.relatedCollection.table.id);
      var view = new Overlays.ListSelect({collection: collection});
      app.router.overlayPage(view);

      //please proxy this instead
      var me = this;

      view.save = function() {
        _.each(view.table.selection(), function(id) {
          var data = collection.get(id).toJSON();
          // prevent duplicate
          if (me.columnSchema.options.get('no_duplicates') === true) {
            var duplicated = false;
            me.relatedCollection.each(function(model) {
              if (model.get('data').id === id) {
                duplicated = true;
              }
            });
            if (duplicated) {
              return false;
            }
          }
          me.relatedCollection.add(data, {parse: true, silent: true, nest: true});
        }, this);
        me.relatedCollection.trigger('add');
        app.router.removeOverlayPage(this);
      };

      collection.fetch();
    },

    initialize: function(options) {
      if (!this.columnSchema.relationship ||
           'MANYTOMANY' !== this.columnSchema.relationship.get('type')) {
        throw __t('m2m_the_column_need_to_have_m2m_relationship', {
          column: this.columnSchema.id,
          type: 'MANYTOMANY',
          ui: Component.id
        });
      }

      this.canEdit = !(options.inModal || false);
      this.showRemoveButton = this.columnSchema.options.get('remove_button') === true;
      this.showChooseButton = this.columnSchema.options.get('choose_button') === true;
      this.showAddButton = this.columnSchema.options.get('add_button') === true;

      var relatedCollection = this.model.get(this.name);
      var relatedSchema = relatedCollection.structure;
      var junctionStructure = relatedCollection.junctionStructure;

      var ids = [];

      //Remove inactive items from collection
      for(var i=0; i<relatedCollection.size(); i++) {
        var model = relatedCollection.at(i);
        if(model.get('data').get(app.statusMapping.status_name) !== app.statusMapping.deleted_num) {
          ids.push(model.get('data').id);
        } else {
          relatedCollection.remove(model, {silent: true});
          i--;
        }
      }

      if(ids.length > 0) {
        relatedCollection.nestedCollection.setFilter({ids: ids.slice(0,relatedCollection.nestedCollection.filters.perPage).join(',')});
        relatedCollection.nestedCollection.fetch();
      }

      var blacklist = [];
      var that = this;
      relatedCollection.getColumns().forEach(function(column) {
        if(that.columnSchema.options.get('visible_columns').split(',').indexOf(column) === -1) {
          blacklist.push(column);
        }
      });

      this.nestedTableView = new TableView({
        collection: relatedCollection,
        toolbar: false,
        selectable: false,
        sortable: true,
        footer: false,
        tableHead: false,
        saveAfterDrop: false,
        deleteColumn: this.showRemoveButton,
        hideEmptyMessage: true,
        hideColumnPreferences: true,
        sort: junctionStructure.get('sort') !== undefined,
        blacklist: blacklist
      });

      if(junctionStructure.get('sort') !== undefined) {
        relatedCollection.setOrder('sort','ASC');
      }

      this.relatedCollection = relatedCollection;
      this.listenTo(relatedCollection, 'change add remove', function() {
        //Check if any rendered objects in collection to show or hide header
        if(this.relatedCollection.filter(function(d){return d.get(app.statusMapping.status_name) !== app.statusMapping.deleted_num;}).length > 0) {
          this.nestedTableView.tableHead = true;
        } else {
          this.nestedTableView.tableHead = false;
        }
        this.nestedTableView.render();
      }, this);

      this.listenTo(relatedCollection.nestedCollection, 'sync', function() {
        this.nestedTableView.render();
      }, this);

      if(ids.length > 0) {
        this.listenTo(relatedCollection.nestedCollection, 'sort', function() {
          //this.relatedCollection.nestedCollection.fetch({includeFilters: false, data: {adv_where: 'id IN (' + ids.join(',') + ')'}, reset:true});
        });
      }
    }
  });

  var Component = UIComponent.extend({
    id: 'many_to_many',
    dataTypes: ['MANYTOMANY'],
    variables: [
      {id: 'visible_columns', type: 'String', default_value: '', ui: 'textinput', char_length: 255, required: true},
      {id: 'add_button', type: 'Boolean', default_value: true, ui: 'checkbox'},
      {id: 'choose_button', type: 'Boolean', default_value: true, ui: 'checkbox'},
      {id: 'remove_button', type: 'Boolean', default_value: true, ui: 'checkbox'},
      {id: 'filter_type', type: 'String', default_value:'', ui: 'select', options: {options: {'dropdown':__t('dropdown'),'textinput':__t('text_input')} }},
      {id: 'filter_column', type: 'String', default_value:'', ui: 'textinput', char_length: 255, comment: __t('m2m_filter_column_comment')},
      {id: 'visible_column_template', type: 'String', default_value:'', ui: 'textinput', char_length: 255, comment: __t('m2m_visible_column_template_comment')},
      {id: 'min_entries', type: 'Number', default_value: 0, ui: 'numeric', char_length: 11, comment: __t('m2m_min_entries_comment')},
      {id: 'no_duplicates', type: 'Boolean', default_value: false, ui: 'checkbox', comment: __t('m2m_no_duplicates_comment')}
    ],
    Input: Input,
    validate: function(value, options) {
      var minEntries = parseInt(options.settings.get('min_entries'));

      if(value.length < minEntries) {
        return __t('this_field_requires_at_least_x_entries', {
          count: minEntries
        });
      }

      // @TODO: Does not currently consider newly deleted items
      if (options.schema.isRequired() && value.length === 0) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      return 'x';
    }
  });

  return Component;
});

//  Text Input Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/wysiwyg',['app', 'handlebars', 'core/UIComponent', 'core/UIView', 'core/overlays/overlays'], function(app, Handlebars, UIComponent, UIView, Overlays) {

  

   Handlebars.registerHelper('newlineToBr', function(text){
       return new Handlebars.SafeString(text.string.replace(/\n/g, '<br/>'));
   });

  var template = '<style type="text/css"> \
                  div.ui-thumbnail { \
                    float: left; \
                    margin-top: 8px; \
                    max-height: 200px; \
                    padding: 10px; \
                    background-color: #ffffff; \
                    border: 1px solid #ededed; \
                    -webkit-border-radius:3px; \
                    -moz-border-radius:3px; \
                    border-radius:3px; \
                    color: #ededed; \
                    text-align: center; \
                    cursor: pointer; \
                  } \
                  div.ui-thumbnail.empty { \
                    width: 300px; \
                    height: 100px; \
                    background-color: #ffffff; \
                    border: 2px dashed #ededed; \
                    padding: 9px; \
                    font-size: 16px; \
                    font-weight: 600; \
                    line-height: 100px; \
                  } \
                  div.ui-thumbnail.empty.dragover, \
                  div.ui-thumbnail.empty:hover { \
                    background-color: #fefefe; \
                    border: 2px dashed #cccccc; \
                    cursor: pointer; \
                  } \
                  div.ui-thumbnail img { \
                    max-height: 200px; \
                  } \
                  .wysiwyg-ui iframe { \
                    padding: 0; \
                  } \
                  </style> \
                  <div class="wysiwyg-ui"> \
                    <div id="wysihtml5-toolbar-{{name}}" class="btn-toolbar" style="display: none;"> \
                    <div class="btn-group btn-white btn-group-attached btn-group-action wysiwyg-toolbar active"> \
                      {{#if bold}}<button data-wysihtml5-command="bold" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "bold"}}"><i class="material-icons">format_bold</i></button>{{/if}} \
                      {{#if italic}}<button data-wysihtml5-command="italic" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "italic"}}"><i class="material-icons">format_italic</i></button>{{/if}} \
                      {{#if underline}}<button data-wysihtml5-command="underline" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "underline"}}"><i class="material-icons">format_underlined</i></button>{{/if}} \
                      {{#if strikethrough}}<button data-wysihtml5-command="strikethrough" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "strikethrough"}}"><i class="material-icons">strikethrough_s</i></button>{{/if}} \
                      {{#if h1}}<button data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h1" type="button" class="btn btn-small btn-silver" data-tag="H1" rel="tooltip" data-placement="bottom" title="H1">H1</button>{{/if}} \
                      {{#if h2}}<button data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h2" type="button" class="btn btn-small btn-silver" data-tag="H2" rel="tooltip" data-placement="bottom" title="H2">H2</button>{{/if}} \
                      {{#if h3}}<button data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h3" type="button" class="btn btn-small btn-silver" data-tag="H3" rel="tooltip" data-placement="bottom" title="H3">H3</button>{{/if}} \
                      {{#if h4}}<button data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h4" type="button" class="btn btn-small btn-silver" data-tag="H4" rel="tooltip" data-placement="bottom" title="H4">H4</button>{{/if}} \
                      {{#if h5}}<button data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h5" type="button" class="btn btn-small btn-silver" data-tag="H5" rel="tooltip" data-placement="bottom" title="H5">H5</button>{{/if}} \
                      {{#if h6}}<button data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="h6" type="button" class="btn btn-small btn-silver" data-tag="H6" rel="tooltip" data-placement="bottom" title="H6">H6</button>{{/if}} \
                      {{#if blockquote}}<button data-wysihtml5-command="formatBlock" data-wysihtml5-command-value="blockquote" type="button" class="btn btn-small btn-silver" data-tag="Quote" rel="tooltip" data-placement="bottom" title="{{t "quote"}}"><i class="material-icons">format_quote</i></button>{{/if}} \
                      {{#if ul}}<button data-wysihtml5-command="insertUnorderedList" type="button" class="btn btn-small btn-silver" data-tag="UL" rel="tooltip" data-placement="bottom" title="{{t "bullet_list"}}"><i class="material-icons">format_list_bulleted</i></button>{{/if}} \
                      {{#if ol}}<button data-wysihtml5-command="insertOrderedList" type="button" class="btn btn-small btn-silver" data-tag="OL" rel="tooltip" data-placement="bottom" title="{{t "number_list"}}"><i class="material-icons">format_list_numbered</i></button>{{/if}} \
                      {{#if rule}}<button data-wysihtml5-command="insertHTML" data-wysihtml5-command-value="<hr>" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "insert_rule"}}"><i class="material-icons">remove</i></button>{{/if}} \
                      {{#if createlink}} \
                      <button data-wysihtml5-command="createLink" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "create_link"}}"><i class="material-icons">insert_link</i></button> \
                      <div data-wysihtml5-dialog="createLink" style="display: none;z-index:108" class="directus-alert-modal"> \
                        <div class="directus-alert-modal-message">{{t "please_insert_a_link"}}</div> \
                        <input type="text" data-wysihtml5-dialog-field="href" value="http://"> \
                        <div class="directus-alert-modal-buttons"> \
                          <button data-wysihtml5-dialog-action="cancel" type="button">{{t "cancel"}}</button> \
                          <button data-wysihtml5-dialog-action="save" type="button" class="primary">{{t "ok"}}</button> \
                        </div> \
                      </div> \
                      {{/if}} \
                      {{#if insertimage}} \
                        <button data-wysihtml5-command="insertImage" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "insert_image"}}"><i class="material-icons">insert_photo</i></button> \
                        <div data-wysihtml5-dialog="insertImage" style="display: none;z-index:108" class="directus-alert-modal"> \
                          <div><button id="existingFileButton" type="button" class="btn" style="float:none;margin-bottom:10px;background-color: #F4F4F4;font-weight:600;width:100%;border: none;">{{t "choose_existing_file"}}</button></div> \
                          <div style="position:relative;margin-bottom:10px;width:100%;background-color:#F4F4F4;text-align:center;font-weight:600;padding-top:10px;padding-bottom:10px;">{{t "choose_from_computer"}}<input id="fileAddInput" type="file" class="large" style="position:absolute;top:0;left:0;cursor:pointer;opacity:0.0;width:100%;height:100%;z-index:9;" /></div> \
                          <div><input type="text" data-wysihtml5-dialog-field="src" id="insertImageInput" value="http://" style="font-weight:600;"></div> \
                          <div class="directus-alert-modal-buttons"> \
                            <button data-wysihtml5-dialog-action="cancel" type="button">{{t "cancel"}}</button> \
                            <button data-wysihtml5-dialog-action="save" id="insertImageButton" type="button" class="primary">{{t "ok"}}</button> \
                          </div> \
                        </div> \
                      {{/if}} \
                      {{#if embedVideo}} \
                        <button data-wysihtml5-command="embedVideo" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "embed_video"}}"><i class="material-icons">movie</i></button> \
                        <div data-wysihtml5-dialog="embedVideo" style="display: none;z-index:108" class="directus-alert-modal"> \
                          <div><button id="existingLinkButton" type="button" class="btn" style="float:none;margin-bottom:10px;background-color: #F4F4F4;font-weight:600;width:100%;border: none;">{{t "choose_existing_link"}}</button></div> \
                          <div><input type="text" class="videoEmbedWidth" id="embedWidthInput" value="{{embed_width}}" style="font-weight:600;"></div><br/> \
                          <div><input type="text" class="videoEmbedHeight" id="embedHeightInput" value="{{embed_height}}" style="font-weight:600;"></div><br/> \
                          <div><input type="text" class="videoEmbedInput" data-type="youtube" id="insertYoutubeEmbedInput" placeholder="{{t "youtube_video_id"}}" style="font-weight:600;"></div><br/> \
                          <div><input type="text" class="videoEmbedInput" data-type="vimeo" id="insertVimeoEmbedInput" placeholder="{{t "vimeo_video_id"}}" style="font-weight:600;"></div> \
                          <div><input type="hidden"  data-wysihtml5-dialog-field="src" id="insertEmbedInput"></div> \
                          <div><input type="hidden"  data-wysihtml5-dialog-field="data-type" id="insertEmbedInputType"></div> \
                          <div class="directus-alert-modal-buttons"> \
                            <button data-wysihtml5-dialog-action="cancel" type="button">{{t "cancel"}}</button> \
                            <button data-wysihtml5-dialog-action="save" id="insertEmbedButton" type="button" class="primary">{{t "ok"}}</button> \
                          </div> \
                        </div> \
                      {{/if}} \
                      {{#if html}} \
                        <button data-wysihtml5-action="change_view" type="button" class="btn btn-small btn-silver" data-tag="bold" rel="tooltip" data-placement="bottom" title="{{t "toggle_html"}}"><i class="material-icons">code</i></button> \
                      {{/if}} \
                    </div> \
                  </div> \
                  <div style="display:none;z-index:998;position:absolute;width:100%;height:100%;top:-5px;left:-5px;" id="iframe_blocker"></div> \
                  <textarea id="wysihtml5-textarea-{{name}}" class="wysihtml5-style" style="height:{{height}}px" placeholder="{{t "placeholder_enter_your_text"}}" value="{{markupValue}}"></textarea> \
                  <input type="hidden" name="{{name}}" class="hidden_input" value="{{{markupValue}}}">\
                </div>';
  var Input = UIView.extend({
    templateSource: template,

    events: {
      'input textarea' : 'textChanged',
      'change input[type=file]': function(e) {
        var file = $(e.target)[0].files[0];
        var self = this;
        var model = new app.files.model({}, {collection: app.files});
        app.sendFiles(file, function(data) {
          _.each(data, function(item) {
            item[app.statusMapping.status_name] = app.statusMapping.active_num;
            item.id = undefined;
            item.user = self.userId;

            model.save(item, {success: function(e) {
              var url = model.makeFileUrl(false);
              var title = model.attributes.title;
              self.$el.find('#insertImageInput').val(url);
              self.$el.find('input[type=file]').val("");
              self.editor.composer.commands.exec("insertImage", { src: url, alt: title, title: title});
              $('.directus-alert-modal').addClass('hide'); //  manually close modal
            }});
          });
        });
      },
      'click #existingFileButton': function(e) {
        var collection = app.files;
        var model;
        var fileModel = new app.files.model({}, {collection: collection});
        collection.fetch();
        var view = new Overlays.ListSelect({collection: collection, selectable: false});
        app.router.overlayPage(view);
        var self = this;

        view.itemClicked = function(e) {
          var id = $(e.target).closest('tr').attr('data-id');
          model = collection.get(id);
          app.router.removeOverlayPage(this);
          var url = model.makeFileUrl(false);
          var title = model.attributes.title;
          self.editor.composer.commands.exec("insertImage", { src: url, alt: title, title: title});
          $('.directus-alert-modal').addClass('hide'); //  manually close modal
        };
      },
      'click #existingLinkButton': function(e) {
        var collection = app.files;
        var model;
        var fileModel = new app.files.model({}, {collection: collection});
        collection.setFilter('adv_search', [{id:'type',type:'like',value:'embed/'}]);
        collection.fetch();
        var view = new Overlays.ListSelect({collection: collection, selectable: false});
        app.router.overlayPage(view);
        var self = this;

        view.itemClicked = function(e) {
          var id = $(e.target).closest('tr').attr('data-id');
          model = collection.get(id);
          app.router.removeOverlayPage(this);
          if(model.get('type') === "embed/youtube" || model.get('type') === "embed/vimeo" ) {
            var url = model.get('url');

            if(model.get('type') === "embed/vimeo") {
              self.$el.find('#insertEmbedInputType').val('vimeo');
            } else {
              self.$el.find('#insertEmbedInputType').val('youtube');
            }

            self.$el.find('#insertEmbedInput').val(url);
            self.$el.find('#insertEmbedButton').click();
          }
        };
      },
      'change .videoEmbedInput': function(e) {
        var target = $(e.target);

        if(target.val()) {
          this.$el.find('#insertEmbedInput').val(target.val());
          this.$el.find('#insertEmbedInputType').val(target.attr('data-type'));
        }
      }
    },

    textChanged: function(view) {
      if(view.editor){
        try {
          view.$('.hidden_input').val(view.editor.getValue());
        } catch (err){
          console.error(err.message);
        }
      }
    },

    serialize: function() {
      var length = this.options.schema.get('char_length');
      var value = this.options.value || '';

      return {
        height: this.options.settings.get('height'),
        bold: (this.options.settings.get('bold') === true),
        italic: (this.options.settings.get('italic') === true),
        underline: (this.options.settings.get('underline') === true),
        strikethrough: (this.options.settings.get('strikethrough') === true),
        rule: (this.options.settings.get('rule') === true),
        h1: (this.options.settings.get('h1') === true),
        h2: (this.options.settings.get('h2') === true),
        h3: (this.options.settings.get('h3') === true),
        h4: (this.options.settings.get('h4') === true),
        h5: (this.options.settings.get('h5') === true),
        h6: (this.options.settings.get('h6') === true),
        blockquote: (this.options.settings.get('blockquote') === true),
        ul: (this.options.settings.get('ul') === true),
        ol: (this.options.settings.get('ol') === true),
        orderedList: (this.options.settings.get('orderedList') === true),
        createlink: (this.options.settings.get('createlink') === true),
        insertimage: (this.options.settings.get('insertimage') === true),
        embedVideo: (this.options.settings.get('embedVideo') === true),
        embed_width: this.options.settings.get('embed_width'),
        embed_height: this.options.settings.get('embed_height'),
        html: (this.options.settings.get('html') === true),
        markupValue: String(value).replace(/"/g, '&quot;'),
        value: new Handlebars.SafeString(value),
        name: this.options.name,
        maxLength: length,
        characters: length - value.length
      };
    },

    initialize: function() {
      this.userId = app.users.getCurrentUser().id;
    },

    afterRender: function() {
      var that = this;
      $.ajax({
        url: window.location.origin + window.directusData.path +"assets/js/libs/wysihtml5.js",
        dataType: "script",
        success: function() {
          that.initEditor();
        }
      });
    },

    initEditor: function() {
      var that = this;
      var isReadOnly = this.options.settings.get('readonly') === true;
      this.editor = new wysihtml5.Editor("wysihtml5-textarea-" + this.options.name, { // id of textarea element
        toolbar:      !isReadOnly ? "wysihtml5-toolbar-" + this.options.name : null, // id of toolbar element
        stylesheets: app.PATH + "assets/css/wysiwyg.css",
        parserRules:  wysihtml5ParserRules // defined in parser rules set
      });
      var value = this.options.value || '';
      this.editor.setValue(String(value).replace(/"/g, '&quot;'));
      this.editor.on('change', function() {
        that.textChanged(that);
      });
      this.editor.on('load', function() {
        if (that.options.settings.get('readonly') === true) {
          that.editor.disable();
        }
      });

      var timer;
      var $dropzone = this.$el;
      var self = this;
      var model = new app.files.model({}, {collection: app.files});
      $dropzone.on('dragover', function(e) {
        self.$el.find('#iframe_blocker').show();
        clearInterval(timer);
        e.stopPropagation();
        e.preventDefault();
        $dropzone.addClass('dragover');
      });

      $dropzone.on('dragleave', function(e) {
        clearInterval(timer);
        timer = setInterval(function(){
          self.$el.find('#iframe_blocker').hide();
          $dropzone.removeClass('dragover');
          clearInterval(timer);
        },50);
      });


      $dropzone[0].ondrop = _.bind(function(e) {
        e.stopPropagation();
        e.preventDefault();
        self.$el.find('#iframe_blocker').hide();
        if (e.dataTransfer.files.length > 1) {
          alert('One file only please');
          return;
        }
        this.editor.focus();
        app.sendFiles(e.dataTransfer.files, function(data) {
          _.each(data, function(item) {
            item[app.statusMapping.status_name] = app.statusMapping.status_num;
            item.id = undefined;
            item.user = self.userId;

            model.save(item, {success: function(e) {
              var url = model.makeFileUrl(false);
              try {
                self.editor.composer.commands.exec("insertImage", { src: url, alt: model.get('title'), title: model.get('title')});
              } catch(ex) {}

            }});
          });
        });
        $dropzone.removeClass('dragover');
      }, this);

      this.$el.find('.wysihtml5-sandbox').contents().find('body').on('dragover', function(e) {
        self.$el.find('#iframe_blocker').show();
      });

      wysihtml5.commands.embedVideo = {
        exec: function(composer, command, value) {
          var doc   = composer.doc,
                      image;

          var width = that.$el.find('#embedWidthInput').val();
          var height = that.$el.find('#embedHeightInput').val();

          image = doc.createElement("iframe");
          image.setAttribute('width', width);
          image.setAttribute('height', height);
          image.setAttribute('frameborder', '0');
          image.setAttribute('allowfullscreen', '1');

          var type = "youtube";
          if(value['data-type']) {
            type = value['data-type'];
          }

          for (var i in value) {
            if(i === "src") {
              if(type === 'youtube') {
                value[i] = "//youtube.com/embed/" + value[i];
              } else {
                value[i] = "//player.vimeo.com/video/" + value[i] + "?title=0&amp;byline=0&amp;portrait=0&amp;color=c9ff23";
              }
            }
            if(i === "data-type") {
              continue;
            }
            image.setAttribute(i === "className" ? "class" : i, value[i]);
          }

          composer.selection.insertNode(image);
          composer.selection.setAfter(image);

          that.textChanged(that);
        },
      };

      wysihtml5.commands.createLink.triggerEvent = function() {
        that.textChanged(that);
      };

      this.editor.on('aftercommand:composer', function() {
        that.textChanged(that);
      });
    }
  });

  var Component = UIComponent.extend({
    id: 'wysiwyg',
    dataTypes: ['VARCHAR', 'TEXT'],
    variables: [
      // Disables editing of the field while still letting users see the value
      {id: 'readonly', type: 'Boolean', default_value: false, ui: 'checkbox'},
      // The input's height in pixels before scrolling. Default: 500px
      {id: 'height', type: 'Number', default_value: 500, ui: 'numeric'},
      {id: 'bold', type: 'Boolean', default_value: true, ui: 'checkbox'},
      {id: 'italic', type: 'Boolean', default_value: true, ui: 'checkbox'},
      {id: 'underline', type: 'Boolean', default_value: true, ui: 'checkbox'},
      {id: 'strikethrough', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'rule', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'createlink', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'insertimage', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'embedVideo', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'embed_width', type: 'Number', default_value: 300, ui: 'numeric'},
      {id: 'embed_height', type: 'Number', default_value: 200, ui: 'numeric'},
      {id: 'html', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'orderedList', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'h1', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'h2', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'h3', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'h4', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'h5', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'h6', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'blockquote', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'ul', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'ol', type: 'Boolean', default_value: false, ui: 'checkbox'}
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return 'This field is required';
      }
    },
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/(<([^>]+)>)/ig, '').substr(0,100) : '';
    }
  });

  return Component;
});




var wysihtml5ParserRules = {
    /**
     * CSS Class white-list
     * Following CSS classes won't be removed when parsed by the wysihtml5 HTML parser
     */
    "classes": {
        "wysiwyg-clear-both": 1,
        "wysiwyg-clear-left": 1,
        "wysiwyg-clear-right": 1,
        "wysiwyg-color-aqua": 1,
        "wysiwyg-color-black": 1,
        "wysiwyg-color-blue": 1,
        "wysiwyg-color-fuchsia": 1,
        "wysiwyg-color-gray": 1,
        "wysiwyg-color-green": 1,
        "wysiwyg-color-lime": 1,
        "wysiwyg-color-maroon": 1,
        "wysiwyg-color-navy": 1,
        "wysiwyg-color-olive": 1,
        "wysiwyg-color-purple": 1,
        "wysiwyg-color-red": 1,
        "wysiwyg-color-silver": 1,
        "wysiwyg-color-teal": 1,
        "wysiwyg-color-white": 1,
        "wysiwyg-color-yellow": 1,
        "wysiwyg-float-left": 1,
        "wysiwyg-float-right": 1,
        "wysiwyg-font-size-large": 1,
        "wysiwyg-font-size-larger": 1,
        "wysiwyg-font-size-medium": 1,
        "wysiwyg-font-size-small": 1,
        "wysiwyg-font-size-smaller": 1,
        "wysiwyg-font-size-x-large": 1,
        "wysiwyg-font-size-x-small": 1,
        "wysiwyg-font-size-xx-large": 1,
        "wysiwyg-font-size-xx-small": 1,
        "wysiwyg-text-align-center": 1,
        "wysiwyg-text-align-justify": 1,
        "wysiwyg-text-align-left": 1,
        "wysiwyg-text-align-right": 1
    },
    "tags": {
        "tr": {
            "add_class": {
                "align": "align_text"
            }
        },
        "strike": 1,
        // "strike": {
        //     "remove": 1
        // },
        "form": {
            "rename_tag": "div"
        },
        "rt": {
            "rename_tag": "span"
        },
        "code": {},
        "acronym": {
            "rename_tag": "span"
        },
        "br": {
            "add_class": {
                "clear": "clear_br"
            }
        },
        "details": {
            "rename_tag": "div"
        },
        "h4": {
            "add_class": {
                "align": "align_text"
            }
        },
        "em": {},
        "title": {
            "remove": 1
        },
        "multicol": {
            "rename_tag": "div"
        },
        "figure": {
            "rename_tag": "div"
        },
        "xmp": {
            "rename_tag": "span"
        },
        "small": {
            "rename_tag": "span",
            "set_class": "wysiwyg-font-size-smaller"
        },
        "area": {
            "remove": 1
        },
        "time": {
            "rename_tag": "span"
        },
        "dir": {
            "rename_tag": "ul"
        },
        "bdi": {
            "rename_tag": "span"
        },
        "command": {
            "remove": 1
        },
        "ul": {},
        "progress": {
            "rename_tag": "span"
        },
        "dfn": {
            "rename_tag": "span"
        },
        "figcaption": {
            "rename_tag": "div"
        },
        "a": {
            "check_attributes": {
                "href": "url" // if you compiled master manually then change this from 'url' to 'href'
            },
            "set_attributes": {
                "rel": "nofollow",
                "target": "_blank"
            }
        },
        "img": {
            "check_attributes": {
                "width": "numbers",
                "alt": "alt",
                "src": "url", // if you compiled master manually then change this from 'url' to 'src'
                "height": "numbers"
            },
            "add_class": {
                "align": "align_img"
            }
        },
         "iframe": {
            "check_attributes": {
                "width": "numbers",
                "src": "url",
                "height": "numbers",
                "frameborder": "numbers"
            },
            "set_attributes": {
              "frameborder": "0",
              "allowfullscreen": ""
            }
        },
        "rb": {
            "rename_tag": "span"
        },
        "footer": {
            "rename_tag": "div"
        },
        "noframes": {
            "remove": 1
        },
        "abbr": {
            "rename_tag": "span"
        },
        "u": 1,
        "bgsound": {
            "remove": 1
        },
        "sup": {
            "rename_tag": "span"
        },
        "address": {
            "rename_tag": "div"
        },
        "basefont": {
            "remove": 1
        },
        "nav": {
            "rename_tag": "div"
        },
        "h1": {
            "add_class": {
                "align": "align_text"
            }
        },
        "head": {
            "remove": 1
        },
        "tbody": {
            "add_class": {
                "align": "align_text"
            }
        },
        "dd": {
            "rename_tag": "div"
        },
        "s": 1,
        // "s": {
        //     "rename_tag": "span"
        // },
        "li": {},
        "td": {
            "check_attributes": {
                "rowspan": "numbers",
                "colspan": "numbers"
            },
            "add_class": {
                "align": "align_text"
            }
        },
        "object": {
            "remove": 1
        },
        "div": {
            "add_class": {
                "align": "align_text"
            }
        },
        "option": {
            "rename_tag": "span"
        },
        "select": {
            "rename_tag": "span"
        },
        "i": {},
        "track": {
            "remove": 1
        },
        "wbr": {
            "remove": 1
        },
        "fieldset": {
            "rename_tag": "div"
        },
        "big": {
            "rename_tag": "span",
            "set_class": "wysiwyg-font-size-larger"
        },
        "button": {
            "rename_tag": "span"
        },
        "noscript": {
            "remove": 1
        },
        "svg": {
            "remove": 1
        },
        "input": {
            "remove": 1
        },
        "table": {},
        "keygen": {
            "remove": 1
        },
        "h5": {
            "add_class": {
                "align": "align_text"
            }
        },
        "meta": {
            "remove": 1
        },
        "map": {
            "rename_tag": "div"
        },
        "isindex": {
            "remove": 1
        },
        "mark": {
            "rename_tag": "span"
        },
        "caption": {
            "add_class": {
                "align": "align_text"
            }
        },
        "tfoot": {
            "add_class": {
                "align": "align_text"
            }
        },
        "base": {
            "remove": 1
        },
        "video": {
            "remove": 1
        },
        "strong": {},
        "canvas": {
            "remove": 1
        },
        "output": {
            "rename_tag": "span"
        },
        "marquee": {
            "rename_tag": "span"
        },
        "b": {},
        "q": {
            "check_attributes": {
                "cite": "url"
            }
        },
        "applet": {
            "remove": 1
        },
        "span": {},
        "rp": {
            "rename_tag": "span"
        },
        "spacer": {
            "remove": 1
        },
        "source": {
            "remove": 1
        },
        "aside": {
            "rename_tag": "div"
        },
        "frame": {
            "remove": 1
        },
        "section": {
            "rename_tag": "div"
        },
        "body": {
            "rename_tag": "div"
        },
        "ol": {},
        "nobr": {
            "rename_tag": "span"
        },
        "html": {
            "rename_tag": "div"
        },
        "summary": {
            "rename_tag": "span"
        },
        "var": {
            "rename_tag": "span"
        },
        "del": {
            "remove": 1
        },
        "blockquote": {
            "check_attributes": {
                "cite": "url"
            }
        },
        "style": {
            "remove": 1
        },
        "device": {
            "remove": 1
        },
        "meter": {
            "rename_tag": "span"
        },
        "h3": {
            "add_class": {
                "align": "align_text"
            }
        },
        "textarea": {
            "rename_tag": "span"
        },
        "embed": {
            "remove": 1
        },
        "hgroup": {
            "rename_tag": "div"
        },
        "font": {
            "rename_tag": "span",
            "add_class": {
                "size": "size_font"
            }
        },
        "tt": {
            "rename_tag": "span"
        },
        "noembed": {
            "remove": 1
        },
        "thead": {
            "add_class": {
                "align": "align_text"
            }
        },
        "blink": {
            "rename_tag": "span"
        },
        "plaintext": {
            "rename_tag": "span"
        },
        "xml": {
            "remove": 1
        },
        "h6": {
            "add_class": {
                "align": "align_text"
            }
        },
        "param": {
            "remove": 1
        },
        "th": {
            "check_attributes": {
                "rowspan": "numbers",
                "colspan": "numbers"
            },
            "add_class": {
                "align": "align_text"
            }
        },
        "legend": {
            "rename_tag": "span"
        },
        "hr": {},
        "label": {
            "rename_tag": "span"
        },
        "dl": {
            "rename_tag": "div"
        },
        "kbd": {
            "rename_tag": "span"
        },
        "listing": {
            "rename_tag": "div"
        },
        "dt": {
            "rename_tag": "span"
        },
        "nextid": {
            "remove": 1
        },
        "pre": {},
        "center": {
            "rename_tag": "div",
            "set_class": "wysiwyg-text-align-center"
        },
        "audio": {
            "remove": 1
        },
        "datalist": {
            "rename_tag": "span"
        },
        "samp": {
            "rename_tag": "span"
        },
        "col": {
            "remove": 1
        },
        "article": {
            "rename_tag": "div"
        },
        "cite": {},
        "link": {
            "remove": 1
        },
        "script": {
            "remove": 1
        },
        "bdo": {
            "rename_tag": "span"
        },
        "menu": {
            "rename_tag": "ul"
        },
        "colgroup": {
            "remove": 1
        },
        "ruby": {
            "rename_tag": "span"
        },
        "h2": {
            "add_class": {
                "align": "align_text"
            }
        },
        "ins": {
            "rename_tag": "span"
        },
        "p": {
            "add_class": {
                "align": "align_text"
            }
        },
        "sub": {
            "rename_tag": "span"
        },
        "comment": {
            "remove": 1
        },
        "frameset": {
            "remove": 1
        },
        "optgroup": {
            "rename_tag": "span"
        },
        "header": {
            "rename_tag": "div"
        }
    }
};

//  Text Input Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/directus_messages_recipients',['app', 'handlebars', 'core/UIComponent', 'core/UIView'], function(app, Handlebars, UIComponent, UIView) {

  

  var template = '<input type="text" id="directus_messages_recipients-input" placeholder="{{t "directus_messages_recipients_placeholder"}}">\
                 <div style="width:100%;max-width:700px;" id="directus_messages_recipients-recipients">{{#tags}}<span class="label tag recipient-tag">{{this}}</span>{{/tags}}</div>\
                 <input type="hidden" name="{{name}}" id="directus_messages_recipients-form">';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'click .message-recipient': function(e) {
        var targetId = $(e.target).closest('.message-recipient').data('id');
        delete this.recipients[targetId];

        if(this.deletedDatums[targetId]) {
          this.datums.push(this.deletedDatums[targetId]);
          delete this.deletedDatums[targetId];
        }

        this.renderTags();
      }
    },

    recipients: {},

    serialize: function() {
      return {
        value: this.options.value,
        name: this.options.name,
        comment: this.options.schema.get('comment'),
        tags: []
      };
    },

    renderTags: function() {
      var $el = this.$el.find('#directus_messages_recipients-recipients');
      var elArray = [];

      this.$('#directus_messages_recipients-input').val("");

      _.each(this.recipients, function(item) {
        var fontWeight = item.type === 1 ? 'font-weight:bold;' : '';
        elArray.push('<div class="message-recipient" data-id="'+item.id+'" style="' + fontWeight + '"><img src="' + item.avatar + '"><div class="recipient-name">' + item.name + '</div></div>');
      });

      this.$el.find('#directus_messages_recipients-form').val(_.keys(this.recipients));
      $el.html(elArray.join(''));
    },

    afterRender: function() {
      var DIRECTUS_USERS = 0;
      var DIRECTUS_GROUPS = 1;
      var me = this;

      var users = app.users.filter(function(item) {
        if(item.get('id') === app.authenticatedUserId.id) {
          return false;
        }
        return true;
      });

      users = users.map(function(item) {
        return {
          id: item.id,
          uid: DIRECTUS_USERS + '_' + item.id,
          name: item.get('first_name') + ' ' + item.get('last_name'),
          avatar: item.getAvatar(),
          type: DIRECTUS_USERS
        };
      });

      var groups = app.groups.map(function(item) {
        return {
          id: item.id,
          uid: DIRECTUS_GROUPS + '_' + item.id,
          name: item.get('name'),
          avatar: app.PATH + 'assets/img/directus-group-avatar-100x100.jpg',
          type: DIRECTUS_GROUPS
        };
      });

      var usersAndGroups = users.concat(groups);
      var keywordsMap = {};
      var keywords = [];
      var datums = [];
      this.deletedDatums = [];

      _.each(usersAndGroups, function(item) {
        var uid = item.uid;

        datums.push({
          id: uid,
          name: item.name,
          avatar: item.avatar,
          tokens: item.name.split(" ")
        });

        keywordsMap[uid] = item;
        keywords.push(uid+': '+item.name);
       });

      this.datums = datums;

      var engine = new Bloodhound({
        name: 'recipients',
        local: datums,
        datumTokenizer: function(d) {
          return Bloodhound.tokenizers.whitespace(d.name);
        },
        queryTokenizer: Bloodhound.tokenizers.whitespace
      });

      this.searchEngine = engine;
      engine.initialize();

      this.$("#directus_messages_recipients-input").typeahead({
        limit: 5,
        template: Handlebars.compile('<div><img src="{{avatar}}" class="avatar"><span class="recipient-name">{{name}}</span></div>')
      }, {
        displayKey: 'name',
        source: engine.ttAdapter()
      });

      this.$('#directus_messages_recipients-input').on('typeahead:selected', function (object, datum) {
        me.recipients[datum.id] = datum;
        me.datums = _.filter(me.datums, function(item) {
          if(item === datum) {
            me.deletedDatums[item.id] = item;
            return false;
          }
          return true;
        });
        me.searchEngine.clear();
        me.searchEngine.add(me.datums);
        me.renderTags();
      });
    },

    initialize: function() {
      this.recipients = {};
    }
  });

  var Component = UIComponent.extend({
    id: 'directus_messages_recipients',
    Input: Input,
    list: function(options) {
      return ''
    }
  });

  return Component;
});

//  Password Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/password',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template = '<input type="password" value="{{value}}" name="{{name}}" class="medium password-primary" style="display:block;margin-bottom:10px;" placeholder="{{t "password_placeholder"}}" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"/> \
                 <input type="password" id="password_fake" class="hidden" autocomplete="off" style="display: none;"> \
                 <span class="password-text"></span> \
                 {{#if require_confirmation}} \
                 <input type="password" value="{{value}}" class="medium password-confirm" style="display:block;margin-bottom:10px;" placeholder="{{t "password_confirm_placeholder"}}" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"/> \
                 {{/if}} \
                 <div style="display:block;"> \
                 <button class="btn btn-primary margin-left password-generate" style="margin-right:10px;" type="button">{{t "generate_new"}}</button> \
                 <button class="btn btn-primary margin-left password-toggle" style="display:none;" type="button">{{t "reveal_password"}}</button> \
                 <span class="placard encrypted hide add-color margin-left-small bold">{{t "password_encrypted"}}</span> \
                 </div> \
                 ';

  var Input = UIView.extend({
    templateSource: template,

    /**
     * Events vary depending on the presence or absence of the confirm password field.
     */
    events: function() {
      var $password = this.$el.find('input.password-primary'),
          $confirm = this.$el.find('input.password-confirm'),
          changeTargetClass = $confirm.length ? 'password-confirm' : 'password-primary';

      var eventsHash = {
        'keydown input.password-primary': function(e) {
          if($confirm.length) {
            if(this.$el.data('wasAPIHashed') || this.$el.data('isAPIHashed')) {
              $confirm.val("");
              $confirm.removeAttr('disabled');
              this.$el.data('wasAPIHashed', false);
              this.$el.data('isAPIHashed', false);
            }
          }
        },

        'click .password-generate' : function(e) {
          var length = 10,
              charset = "abcdefghijklnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
              pass = "";
          for (var i = 0, n = charset.length; i < length; ++i) {
            pass += charset.charAt(Math.floor(Math.random() * n));
          }
          this.currentPlainPassword = pass;
          this.$el.find('.password-toggle').show();
          this.$el.data('isAPIHashed', false);
          this.$el.data('wasAPIHashed', false);
          this.$el.find('.encrypted').addClass('hide');
          this.$el.find('input.password-primary').val(pass);
          this.$el.find('input.password-confirm').val(pass);
          if($confirm.length) {
            $confirm.removeAttr('disabled');
          }

          var $onChangeInput = this.$el.find('input.' + changeTargetClass);
          var that = this;
          $onChangeInput.one('blur', function(e) {
            $onChangeInput.trigger('change');
            that.hidePass();
          });
          this.showPass();
          $onChangeInput.trigger('focus');

          e.preventDefault();
          return false;
        },

        'click .password-toggle' : function(e) {
          if($(e.target).html() === __t('mask_password')){
            this.hidePass(e);
          } else {
            this.showPass(e);
            e.preventDefault();
            return false;
          }
        },

        'blur input.password-primary' : function(e) {
          if(!_.isEmpty($.trim($(e.target).val()))) {
            this.currentPlainPassword = $(e.target).val();
            this.$el.find('.password-toggle').show();
            this.$el.data('wasAPIHashed', this.$el.data('isAPIHashed'));
            this.$el.data('isAPIHashed', false);
            this.$el.find('input[type=password]').data('oldVal', undefined);
            return;
          }
          var that = this;
          this.$el.find('input[type=password]').each(function(e) {
            var val = $(this).val();
            if(_.isEmpty(val) && $(this).data('oldVal')) {
              $(this).val($(this).data('oldVal'));
              that.$el.data('isAPIHashed', true);
              that.$el.data('wasAPIHashed', false);
              that.$el.find('.encrypted').removeClass('hide');
              if($confirm.length) {
                $confirm.attr('disabled','disabled');
              }
            }
          });
        },
      };

      eventsHash['change input.' + changeTargetClass] = function(e) {
        var primaryPass = $password.val();
        if(!primaryPass) {
          return;
        }

        var clearFields = _.bind(function() {
          this.$el.data('isAPIHashed', false);
          this.$el.find('.encrypted').addClass('hide');
          $password.val('');
          this.currentPlainPassword = '';
          this.$el.find('.password-toggle').hide();
          if($confirm.length) {
            $confirm.val('');
            $confirm.removeAttr('disabled');
          }
        }, this);

        if($confirm.length) {
          if(primaryPass !== $confirm.val()) {
            alert(__t('password_do_not_match'));
            return false;
          }
        }

        var hashParams = {password:primaryPass};
        var saltField = this.options.settings.get('salt_field');
        var $saltInput = this.$el.closest('form').find('input[name='+saltField+']');
        if($saltInput.length) {
          hashParams.salt = $.trim($saltInput.val());
          if(_.isEmpty(hashParams.salt)) {
            alert(__t('password_salt_is_not_defined'));
            return false;
          }
        }

        var hashSuccess = _.bind(function(data, textStatus, jqXHR) {
          if(!_.isEmpty(data) && !_.isEmpty(data.password)) {
            $password.val(data.password);
            if($confirm.length) {
              $confirm.val(data.password);
              $confirm.attr('disabled','disabled');
            }
            this.$el.find('.encrypted').removeClass('hide');
            this.$el.data('isAPIHashed', true);
            return;
          }
          // @todo alert user that the hashing failed
          clearFields();
        }, this);

        $.ajax({
          type: "POST",
          url: app.API_URL + 'hash/',
          data: hashParams,
          success: hashSuccess,
          dataType: 'json',
          error: function(data, textStatus, jqXHR) {
            // @todo alert user that the hashing failed
            clearFields();
          }
        });
      };

      return eventsHash;
    },

    initialize: function() {
      this.$el.data('isAPIHashed', false);
      this.$el.data('wasAPIHashed', true);
    },

    serialize: function() {
      return {
        name: this.options.name,
        value: this.options.value,
        comment: this.options.schema.get('comment'),
        require_confirmation: (this.options.settings.get('require_confirmation') === true)
      };
    },

    showPass: function() {
      if (!this.currentPlainPassword) {
        return;
      }

      this.$el.find('input.password-primary').get(0).type = 'text';
      this.$el.find('input.password-confirm').get(0).type = 'text';
      this.$el.find('input.password-primary').get(0).value = this.currentPlainPassword;
      this.$el.find('input.password-confirm').get(0).value = this.currentPlainPassword;
      this.$el.find('.password-toggle').html(__t('mask_password'));
    },

    hidePass: function() {
      this.$el.find('input.password-primary').get(0).type = 'password';
      this.$el.find('input.password-confirm').get(0).type = 'password';
      this.$el.find('.password-toggle').html(__t('reveal_password'));
    }
  });

  var Component = UIComponent.extend({
    id: 'password',
    dataTypes: ['VARCHAR'],
    skipSerializationIfNull: true,
    isAPIHashed: false,
    // Plain password before being saved.
    currentPlainPassword: '',
    variables: [
      // Toggles the second input ("Confirm Password"). On by default.
      {id: 'require_confirmation', default_value: true, type: 'Boolean', ui: 'checkbox'},
      // The name of the column to be used as a salt in the password hash
      {id: 'salt_field', type: 'String', default_value: 'salt', ui: 'textinput'}
    ],
    Input: Input,
    validate: function (value, options) {
      var $el = $('input[name="' + options.schema.id + '"]').parent();
      var data = $el.data();
      var password = $el.find('input.password-primary').val(),
        confirm = $el.find('input.password-confirm').val();

      if (options.model.isMine() && !password && options.schema.get('required')) {
        return __t('you_must_specify_a_password');
      }

      if(password) {
        if(password !== confirm) {
          return __t('password_must_match');
        }
        if(!$el.data().isAPIHashed && !$el.data().wasAPIHashed) {
          return __t('you_must_hash_your_password');
        }
      }
    },
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

//  Random Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/random',['app', 'core/UIComponent', 'core/UIView', 'core/notification', 'core/t'], function(app, UIComponent, UIView, Notification, __t) {

  

  var template = '<input type="text" value="{{value}}" name="{{name}}" class="medium password-primary" style="display:block;margin-bottom:10px;" placeholder="{{ placeholder }}" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" {{#if readonly}}readonly{{/if}}/> \
                  <div> \
                  <button class="btn btn-primary margin-left string-generate" style="margin-right:10px;" type="button">{{t "generate_new"}}</button> \
                  <span class="placard generated hide add-color margin-left-small bold">{{t "generated"}}</span> \
                  </div>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'click .string-generate': function(e) {
        var length = this.options.settings.get('string_length')

        this.generateString(length);
      }
    },

    generateString: function(length) {
      length = (length || 16);
      var randomSuccess = _.bind(function(data, textStatus, jqXHR) {
        if(!_.isEmpty(data) && !_.isEmpty(data.random)) {
          this.$el.find('input.password-primary').val(data.random);
          this.$el.find('.generated').removeClass('hide');
        } else {
          Notification.error('Random', __t('error_generating_a_random_string'));
        }
      }, this);

      // TODO: Generate random string locally
      $.ajax({
        type: "POST",
        url: app.API_URL + 'random/',
        data: {length: length},
        success: randomSuccess,
        dataType: 'json',
        error: function(data, textStatus, jqXHR) {
          Notification.error('Random', __t('error_generating_a_random_string'));
        }
      });
    },

    initialize: function() {
      if (!this.options.value && this.options.settings.get('auto_generate') === true) {
        this.generateString();
      }
    },

    serialize: function() {
      return {
        name: this.options.name,
        value: this.options.value,
        readonly: this.options.settings.get('allow_any_value') !== true,
        comment: this.options.schema.get('comment'),
        placeholder: this.options.settings.get('placeholder_text')
      };
    },
  });

  var Component = UIComponent.extend({
    id: 'random',
    dataTypes: ['VARCHAR'],
    variables: [
      {id: 'string_length', type: 'Number', default_value: 16, ui: 'numeric', char_length: 200},
      // Allow the user to input their own value
      {id: 'allow_any_value', type: 'Boolean', default_value: true, ui: 'checkbox'},
      {id: 'auto_generate',  type: 'Boolean', default_value: false, ui: 'checkbox'},
      // Initial Placeholder text for the UI
      {id: 'placeholder_text', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
    ],
    Input: Input,
    validate: function(value, options) {
      var $el = $('input[name="' + options.schema.id + '"]').parent();
      var data = $el.data();
      var randomString = $el.find('input.password-primary').val();

      if(!randomString && options.schema.get('required')) {
        return 'This field is required ['+options.schema.id+'].';
      }
    },
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

//  Many To One core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/many_to_one_typeahead',['app', 'backbone', 'handlebars', 'core/UIComponent', 'core/UIView', 'utils', 'core/t'], function(app, Backbone, Handlebars, UIComponent, UIView, Utils, __t) {

  

  var template = '<input type="text" value="" class="for_display_only {{size}}{{#if disabled}} disabled{{/if}}" placeholder="{{t "m2o_typeahead_placeholder"}}" {{#if readonly}}readonly{{/if}}/> \
                  {{#if disabled}}<div class="disabled-input"></div><em>There is not visible columns selected</em></div>{{/if}}\
                  {{#if hasSelectedItem}}\
                  <div class="selected-item"> \
                    <span id="selectedValue">{{selectedValue}}</span>\
                    <i class="material-icons clear" title="{{t "m2o_typeahead_clear"}}">clear</i> \
                  </div> \
                  {{/if}}\
                  <style> \
                    .disabled-input {\
                      padding: 5px 0;\
                    }\
                    .for_display_only.disabled {\
                      border-color: #F75D59\
                    } \
                    #selectedValue { \
                      border-radius: 4px; \
                      padding: 8px 10px; \
                      background-color: rgba(76,166,222, 0.2); \
                      cursor: pointer; \
                      line-height: 36px; \
                    } \
                    .selected-item { \
                      margin-top: 10px; \
                      color: #4ca6de; \
                      font-weight: 500; \
                    } \
                    .selected-item:hover { \
                    } \
                    .selected-item .clear { \
                      margin-left: 5px; \
                      vertical-align: middle; \
                      color: #666666; \
                      margin-top: -2px; \
                      cursor: pointer; \
                    } \
                    .selected-item .clear:hover { \
                      color: #c1272d; \
                    } \
                    .tt-hint {padding:14px;} \
                    #edit_field_{{name}} .twitter-typeahead {\
                      width:100%;\
                    }\
                    #edit_field_{{name}} .tt-dropdown-menu { \
                      padding: 3px 0; \
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); \
                      -webkit-border-radius: 2px; \
                      -moz-border-radius: 2px; \
                      border-radius: 2px; \
                      background-color: #fff; \
                  } \
                  #edit_field_{{name}} .tt-suggestions { \
                    margin-right: 0 !important; \
                  } \
                  \
                  #edit_field_{{name}} .tt-suggestion { \
                    display: block; \
                    padding: 0px 20px; \
                    clear: both; \
                    font-weight: normal; \
                    white-space: nowrap; \
                    font-size: 12px; \
                    margin-right: 0 !important; \
                } \
                \
                #edit_field_{{name}} .tt-is-under-cursor { \
                    color: white; \
                    background-color: black; \
                }\
                </style>';

  // @TODO: this should be a great feature on Models
  function get_multiple_attr(model, attributes) {
    if (attributes && attributes.length > 0) {
      var columns = attributes.split(',');
      var values = [];
      _.each(columns, function (column) {
        values.push(model.get(column));
      });

      return values.join(' ');
    }
  }

  var Input = UIView.extend({
    events: {
      'click .clear': function() {
        this.model.get(this.name).clear();
        this.render();
      }
    },

    templateSource: template,

    serialize: function() {
      var relatedModel = this.model.get(this.name);

      return {
        name: this.options.name,
        size: this.columnSchema.options.get('size'),
        readonly: false,
        disabled: this.visibleColumn ? false : true,
        selectedItem: relatedModel,
        hasSelectedItem: !relatedModel.isNew(),
        comment: this.options.schema.get('comment'),
        selectedValue: this.getSelectedValue(),
      };
    },

    afterRender: function () {
      var template = this.columnSchema.options.get('template');
      var self = this;
      var url = app.API_URL + 'tables/' + this.collection.table.id + '/typeahead/';
      var params = {};

      if(this.visibleColumn) {
        params['columns'] = this.visibleColumn;
      }

      var status = 1;
      if(this.options.settings.get('visible_status_ids')) {
        status = this.options.settings.get('visible_status_ids');
      }
      params[app.statusMapping.status_name] = status;

      var urlParams = Utils.encodeQueryParams(params);
      if(urlParams) {
        url += '?' + urlParams;
      }

      var fetchItems = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
          url: url,
          ttl: 0
        },
        remote: Utils.addParam(url, 'q', '%QUERY', true, false),
        dupDetector: function(remoteMatch, localMatch) {
          return remoteMatch.value === localMatch.value;
        }
      });

      if (this.visibleColumn) {
        fetchItems.initialize();
        // fetchItems.clearPrefetchCache();
        // engine.clearRemoteCache();
        this.$(".for_display_only").typeahead({
          minLength: 1,
          items: 5,
        }, {
          source: fetchItems.ttAdapter()
        });
      }

      this.$('.for_display_only').on('typeahead:selected', function(e, datum) {
        var model = self.model.get(self.name);
        var selectedId = parseInt(datum.id,10);

        model.clear();
        model.set({id: selectedId});
        model.fetch({success:  function() {
          self.updateSelectedValue();
          self.render();
          // clear after fetch
          model.clear();
          model.set({id: selectedId});
        }});
      });
    },

    getSelectedValue: function() {
      var relatedModel = this.model.get(this.name);
      var templateSource = this.columnSchema.options.get('template');
      var selectedValue = this.visibleColumn ? get_multiple_attr(relatedModel, this.visibleColumn) : '';

      if (templateSource && !relatedModel.isNew()) {
        var template = Handlebars.compile(templateSource);
        selectedValue = template(relatedModel.toJSON());
      }

      return selectedValue;
    },

    updateSelectedValue: function() {
      this.$el.find('#selectedValue').html(this.getSelectedValue());
    },

    initialize: function(options) {
      this.visibleColumn = this.columnSchema.options.get('visible_column').split(',').map(function(column) {
        return column.trim();
      }).join(',');
      this.includeInactives = this.columnSchema.options.get('include_inactive');
      var value = this.model.get(this.name);
      this.collection = value.collection.getNewInstance({omit: ['preferences']});
    }
  });

  var Component = UIComponent.extend({
    id: 'many_to_one_typeahead',
    dataTypes: ['INT'],
    variables: [
      {id: 'visible_column', type: 'String', default_value: '', ui: 'textinput', comment: __t('m2o_typeahead_visible_column_comment'), char_length: 64, required: true},
      {id: 'size', type: 'String', default_value: 'large', ui: 'select', options: {options: {'large':__t('size_large'),'medium':__t('size_medium'),'small':__t('size_small')} }, comment: __t('m2o_typeahead_size_comment')},
      {id: 'template', type: 'String', default_value: '', ui: 'textinput', comment: __t('m2o_typeahead_template_comment')},
      {id: 'visible_status_ids', type: 'String', ui: 'textinput', char_length: 64, required: true, default_value: 1, comment: __t('m2o_visible_status_ids_comment')}
    ],
    Input: Input,
    list: function(options) {
      if (options.value === undefined || options.value.isNew()) {
        return '';
      }

      if (options.value instanceof Backbone.Model) {
        if (options.settings.get('template')) {
          return this.compileView(options.settings.get('template'), options.value.toJSON());
        } else {
          return get_multiple_attr(options.value, options.settings.get('visible_column'));
        }
      }

      return options.value;
    }
  });

  return Component;
});

//  Textarea Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/enum',['app', 'core/UIComponent', 'core/UIView', 'core/t'],function(app, UIComponent, UIView, __t) {

  

  var template = '<div class="select-container"> \
                    <select name="{{name}}" {{#if readonly}}disabled{{/if}}><option value="">{{t "select_from_below"}}</option>{{#options}}<option value="{{value}}" {{#if selected}}selected{{/if}}>{{value}}</option>{{/options}}</select> \
                    <i class="material-icons select-arrow">arrow_drop_down</i> \
                  </div>';

  var Input = UIView.extend({
    templateSource: template,

    serialize: function() {
      var selectedValue = this.options.value;

      var enumText = this.options.schema.attributes.column_type;
      enumText = enumText.substr(5,enumText.length-6); //Remove enum() from string
      enumText = enumText.replace(/'/g, '');
      var enumArray = enumText.split(",");

      enumArray = _.map(enumArray, function(value) {
        var item = {};
        item.value = value;
        item.selected = (item.value === selectedValue);
        return item;
      });

      return {
        value: this.options.value,
        name: this.options.name,
        comment: this.options.schema.get('comment'),
        readonly: !this.options.canWrite,
        options: enumArray
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'enum',
    dataTypes: ['ENUM','SET'],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      return _.isString(options.value) ? options.value.replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '<span class="silver">--</span>';
    }
  });

  return Component;
});

//  Text Input Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/multi_select',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template = '{{#if cb_list}} \
                    {{#options}} \
                            <input style="margin-top:1px;display: inline-block;" id="multi_select_{{name}}_{{key}}" name="{{key}}" type="checkbox" {{#if selected}}checked{{/if}}/>\
                            <label for="multi_select_{{name}}_{{key}}">{{value}}</label> \
                    {{/options}} \
                  {{else}} \
                    <select multiple> \
                        {{#options}} \
                            <option value="{{key}}" {{#if selected}}selected{{/if}}>{{value}}</option> \
                        {{/options}}</select> \
                  {{/if}} \
                  <input type="hidden" name="{{name}}">';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'click select': function(e) {
        this.updateValue(true);
      },
      'change input[type=checkbox]': function(e) {
        this.updateValue(false);
      }
    },

    updateValue: function(select) {
      var values, out, i;
      if(select) {
        values = this.$el.find('select').val();
        out = "";
        if(values) {
          for (i=0; i<values.length; i++) {
            out += values[i] + this.options.settings.get('delimiter');
          }
        }
      } else {
        values = this.$el.find('input[type=checkbox]:checked');
        out = "";
        for (i=0; i<values.length; i++) {
          out += $(values[i]).attr('name') + this.options.settings.get('delimiter');
        }
      }

      out = out.substr(0, out.length - 1);
      this.$el.find('input').val(out);
    },

    afterRender: function() {
      if(this.options.value) {
        this.updateValue((this.options.settings.get('type') !== "cb_list"));
      }
    },

    serialize: function() {
      var value = this.options.value || '';
      var values = value.split(this.options.settings.get('delimiter'));
      var options = this.options.settings.get('options');
      var cb_list = this.options.settings.get('type') === "cb_list";

      if (_.isString(options)) {
        options = $.parseJSON(options);
      }

      options = _.map(options, function(value, key) {
        var item = {};
        item.value = value;
        item.key = key;
        item.selected = ($.inArray(item.key, values) !== -1);
        return item;
      });

      return {
        name: this.options.name,
        comment: this.options.schema.get('comment'),
        options: options,
        cb_list: cb_list
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'multi_select',
    dataTypes: ['VARCHAR', 'TEXT'],
    variables: [
      {id: 'type', type: 'String', default_value: 'select_list', ui: 'select', options: {options: {'select_list':__t('select_list'),'cb_list':__t('checkbox_list')} }},
      {id: 'delimiter', type: 'String', default_value: ',', ui: 'textinput', char_length:1, required: true  },
      {id: 'options', type: 'String', default_value: '', ui: 'textarea', options:{'rows': 25}  }
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return __t('this_field_is_required');
      }
    },
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

//  System core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/system',['app', 'underscore', 'core/UIComponent', 'core/UIView'], function(app, _, UIComponent, UIView) {

  


  //Temporarily disable styling since breaks this ui when in overlay
  /*var template = '<div class="custom-check"> \
    <input value="1" id="check1" name="status" type="radio" {{#if active}}checked{{/if}}> \
    <label for="check1"><span></span>Active</label> \
    <input value="2" id="check2" name="status" type="radio" {{#if inactive}}checked{{/if}}> \
    <label for="check2"><span></span>Inactive</label> \
    <input value="0" id="check3" name="status" type="radio" {{#if deleted}}checked{{/if}}> \
    <label for="check3"><span></span>Deleted</label> \
  <input type="hidden" name="{{name}}" value="{{#if value}}{{value}}{{/if}}">';*/

  var template = '<div class="status-group" style="padding: 12px 0;"> \
                  {{#mapping}} \
                    <label style="font-size:14px;margin-right:40px;display:inline-block;color:{{color}}" class="bold"><input style="display:inline-block;width:auto;margin-right:10px;" type="radio" {{#if ../readonly}}disabled{{/if}} name="{{../name}}" value="{{id}}" {{#if active}}checked{{/if}}>{{name}}</label> \
                  {{/mapping}} \
                  </div>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'change input[type=radio]': function(e) {
        this.$el.find('input[type=hidden]').val($(e.target).val());
      }
    },

    serialize: function() {
      var data = {};

      var mapping = app.statusMapping.mapping;
      var value = Number(this.options.value);

      data.mapping = [];

      _.each(mapping, function(status, key) {
        // Convert status id into number
        key = Number(key);

        // If new model, skip delete option
        if (this.model.isNew() && key === app.statusMapping.deleted_num) {
          return false;
        }

        var entry = status;
        entry.id = key;
        entry.active = key === value;

        data.mapping.push(entry);
      }, this);

      data.mapping.sort(function(a, b) {
        if(a.sort < b.sort) {
          return -1;
        }
        if(a.sort > b.sort) {
          return 1;
        }
        return 0;
      });

      data.name = this.options.name;
      data.readonly = !this.options.canWrite;

      return data;
    }
  });

  var Component = UIComponent.extend({
    id: 'system',
    dataTypes: ['TINYINT'],
    Input: Input,
    list: function(options) {
      return (options.value) ? '<input type="checkbox" checked="true" disabled>' : '<input type="checkbox" disabled>';
    }
  });

  return Component;
});

//  Directus User List View component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/user',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var Input = UIView.extend({
    initialize: function(options) {
      // If editing a new item, use the current user
      if (options.model.isNew()) {
        // @TODO: do we really need this object?
        // Change to: app.users.getCurrentUser() (which is the authenticated user)
        options.value = app.authenticatedUserId.id;
      }

      var user = app.users.get(options.value);

      if(user) {
        var avatar = user.getAvatar();
        //Added input with the value of the current user so that the field will save correctly.
        this.$el.append('<img src="' + avatar + '" class="big-avatar"><span class="big-avatar-name">' + user.get('first_name') + ' ' + user.get('last_name') + '</span><input type="hidden" placeholder="" value="'+user.get('id')+'" name="'+options.name+'" id="'+options.name+'" readonly maxlength="11">');
      } else {
        this.$el.append('<span class="avatar-name medium-grey-color">'+__t('no_user')+'</span>');
      }
    }
  });

  var Component = UIComponent.extend({
    id: 'user',
    dataTypes: ['INT'],
    variables: [],
    Input: Input,
    list: function(options) {
      var avatar, output, user = app.users.get(options.value);

      if(user) {
        avatar = user.getAvatar();
        output = '<img src="' + avatar + '" class="avatar"><span class="avatar-name">' + user.get('first_name') + ' ' + user.get('last_name') + '</span>';
      } else {
        output = '<span class="avatar-name medium-grey-color">'+__t('no_user')+'</span>';
      }

      return output;
    }
  });

  return Component;
});

//  Files Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/directus_file',['app', 'helpers/file', 'core/UIComponent', 'core/UIView'], function(app, FileHelper, UIComponent, UIView) {

  

  var template = '<style type="text/css"> \
                  div.ui-thumbnail { \
                    float: left; \
                    margin-top: 8px; \
                    max-height: 200px; \
                    padding: 10px; \
                    background-color: #ffffff; \
                    border: 1px solid #dddddd; \
                    color: #aaaaaa; \
                    text-align: center; \
                    cursor: pointer; \
                    margin-bottom: 10px; \
                    border-radius: 4px; \
                  } \
                  div.ui-thumbnail.empty { \
                    max-width: 276px; \
                    width: 100%; \
                    height: 140px; \
                    background-color: #ffffff; \
                    border: 2px dashed #dddddd; \
                    padding: 9px; \
                    font-size: 16px; \
                    font-weight: 500; \
                    line-height: 144px; \
                  } \
                  div.ui-thumbnail.empty.dragover, \
                  div.ui-thumbnail.empty:hover { \
                    background-color: #fefefe; \
                    border: 2px dashed #aaaaaa; \
                    cursor: pointer; \
                  } \
                  div.ui-thumbnail img { \
                    max-height: 200px; \
                  } \
                  div.ui-img-details { \
                    float: left; \
                    position: relative; \
                    width: 100%; \
                    margin-top: 0; \
                    margin-left: 0; \
                    line-height: 18px; \
                  } \
                  div.ui-img-details a.title { \
                    font-size: 18px; \
                  } \
                  div.ui-img-details div { \
                    display: inline; \
                  } \
                  div.ui-img-details i { \
                    font-weight: 400; \
                    font-style: italic; \
                    color: #ccc; \
                  } \
                  button.btn-right { \
                    margin-top: 8px; \
                    margin-right: 10px; \
                  } \
                  .url-import { \
                    width: 100%; \
                    margin-top: 10px; \
                    margin-bottom: 4px; \
                    display: inline-block; \
                  } \
                  .swap-method-btn { \
                    display:block; \
                    clear: both; \
                    padding-top: 5px; \
                    cursor: pointer; \
                  } \
                  </style> \
                  {{#if url}} \
                  <div class="ui-thumbnail has-file"> \
                    {{#if html}} \
                      {{{html}}} \
                    {{else}} \
                      {{#if thumbUrl}} \
                        <div class="default-info js-image"><a target="_BLANK" href="{{url}}"><div class="type">{{uppercase type}}</div><img src="{{thumbUrl}}"></a></div> \
                      {{else}} \
                        <div class="default-info"><a target="_BLANK" href="{{url}}">{{type}}</a></div> \
                      {{/if}} \
                    {{/if}} \
                  </div> \
                  <div class="ui-img-details"> \
                    <button class="btn btn-primary btn-small ui-text-hover" data-action="swap" type="button">{{t "directus_files_swap_file"}}</button> \
                  </div> \
                  {{/if}} \
                  <div class="swap-container" {{#if url}}style="display:none"{{/if}}> \
                    <div id="fileDropArea" class="swap-method ui-thumbnail empty ui-thumbnail-dropzone">{{t "directus_files_drop_or_choose_file"}}</div> \
                    <input id="fileAddInput" type="file" class="large hide" /> \
                    <div class="secondary-info url-import">{{t "directus_files_paste_youtube_vimeo_url"}}:</div> \
                    <input id="urlInput" type="text" class="swap-method medium" placeholder="{{t "example_abbr"}} https://www.youtube.com/watch?v=dQw4w9WgXcQ" /><button class="swap-method btn btn-primary margin-left-small" id="retriveUrlBtn" type="button">{{t "directus_files_retrieve"}}</button> \
                  </div>';

  var Input = UIView.extend({
    templateSource: template,

    serialize: function() {
      var data = {},
        userId,
        model = this.model,
        authenticatedUser = app.users.getCurrentUser();

      data = model.toJSON();

      if (!model.has('id')) {
        userId = authenticatedUser.id;
        data.isNew = true;
      } else {
        userId = model.get('user');
      }

      var user = app.users.get(userId);

      data.link = undefined;
      data.thumbUrl = undefined;

      var storageAdapter = model.get('storage_adapter');

      if(storageAdapter !== null &&
        storageAdapter !== undefined &&
        storageAdapter !== '') {
        data.url = model.makeFileUrl(false);
        data.thumbUrl = model.makeFileUrl(true);
      } else if (model.isNew()) {
        data.url = model.get('url') || model.get('data');
        data.thumbUrl = model.get('thumbnailData') || model.get('url') || model.get('data');
      }

      data.name = model.get('name');
      data.orientation = (parseInt(model.get('width'),10) > parseInt(model.get('height'),10)) ? 'landscape' : 'portrait';

      if(model.has('type')) {
        var type = model.get('type').substring(0, model.get('type').indexOf('/'));
        var subtype = model.get('type').split('/').pop();

        //If we shouldnt show thumbnail, set thumbUrl to null
        if(type !== 'image' && type !== 'embed' && subtype !== 'pdf') {
          data.thumbUrl = null;
          data.type = subtype.toUpperCase();
        }

        if (model.get('html')) {
          data.html = $(model.get('html')).css({width: 300, height: 200}).prop('outerHTML');
        }
      }

      return data;
    },

    events: {
      'click a[data-action=toggle-form]': function() {
        //$('.upload-form').toggleClass('hide');
      },
      'click li[data-action=swap]': function() {
        //this.$el.find('#swap-file').toggleClass('hide');
      },
      'click .swap-method-btn': function() {
        this.$el.find('.swap-method').toggleClass('hide');

        if(this.$el.find('#urlInput').is(':visible')) {
          this.$el.find('#urlInput').focus();
        }
      },
      'click #retriveUrlBtn': function(e) {
        var url = this.$el.find('#urlInput').val();
        var model = this.model;

        app.sendLink(url, function(data) {
          var item = data[0];

          item[app.statusMapping.status_name] = app.statusMapping.active_num;
          // Unset the model ID so that a new file record is created
          // (and the old file record isn't replaced w/ this data)
          item.id = undefined;
          item.user = self.userId;

          model.setData(item);
        });
      },
      'change input[type=file]': function(e) {
        var file = $(e.target)[0].files[0];
        var model = this.model;

        model.setFile(file);
      },
      'click .ui-thumbnail-dropzone': function(e) {
        this.$el.find('#fileAddInput').click();
      },
      'click button[data-action="swap"]': function(e) {
        this.$el.find('.swap-container').toggle();
        this.$el.find('.ui-thumbnail.has-file').toggle();
        var swapText = this.$el.find('.ui-text-hover').html();
        var newSwapText = (swapText === 'Swap file')? 'Cancel' : 'Swap file';
        this.$el.find('.ui-text-hover').html(newSwapText);
      }
    },

    initialize: function() {
      var FilesModel = require('modules/files/FilesModel');
      if(!(this.model instanceof FilesModel)) {
        this.model = new FilesModel(this.model.attributes, {collection: this.collection});
      }
      this.listenTo(this.model, 'change', this.render);
    },

    afterRender: function() {
      var timer;
      var $dropzone = this.$el.find('.ui-thumbnail');
      var model = this.model;

      $dropzone.on('dragover', function(e) {
        clearInterval(timer);
        e.stopPropagation();
        e.preventDefault();
        $dropzone.addClass('dragover');
      });

      $dropzone.on('dragleave', function(e) {
        clearInterval(timer);
        timer = setInterval(function(){
          $dropzone.removeClass('dragover');
          clearInterval(timer);
        },50);
      });

      // Since data transfer is not supported by jquery...
      // XHR2, FormData
      $dropzone[0].ondrop = function(e) {
        e.stopPropagation();
        e.preventDefault();

        if (e.dataTransfer.files.length > 1) {
          alert('One file only please');
          return;
        }

        var file = e.dataTransfer.files[0];

        model.setFile(file);

        $dropzone.removeClass('dragover');
      };

      // Show fallback image if file missing
      FileHelper.hideOnImageError(this.$('.js-image img'));
    },
  });

  var Component = UIComponent.extend({
    id: 'directus_file',
    system: true,
    Input: Input,
    list: function(options) {
      var model = options.model;

      //Force model To be a Files Model
      var FileModel = require('modules/files/FilesModel');
      if(!(model instanceof FileModel)) {
        model = new FileModel(model.attributes, {collection: model.collection});
      }

      var orientation = (parseInt(model.get('width'),10) > parseInt(model.get('height'),10)) ? 'landscape' : 'portrait';
      var url = model.makeFileUrl(true);
      var isImage = _.contains(['image/jpeg','image/png', 'embed/youtube', 'embed/vimeo'], model.get('type'));
      var thumbUrl = isImage ? url : app.PATH + 'assets/img/document.png';

      return '<div class="media-thumb"><img src="' + thumbUrl + '" class="img ' + orientation + '"></div>';
    }
  });

  return Component;
});

//  Files Title Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/directus_file_title',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template = '{{#unless readonly}}<div class="char-count-container"><input type="text" value="{{value}}" name="{{name}}" id="{{name}}" class="{{size}}" {{#if readonly}}readonly{{/if}}/> \
                  <span class="char-count hide">{{characters}}</span></div>{{else}}<span>{{value}}</span>{{/unless}}';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'focus input': function() { this.$el.find('.char-count').removeClass('hide'); },
      'input input': 'updateMaxLength',
      'blur input': function() { this.$el.find('.char-count').addClass('hide'); }
    },

    updateMaxLength: function(e) {
      var length = this.options.schema.get('char_length') - e.target.value.length;
      this.$el.find('.char-count').html(length);
    },

    serialize: function() {
      var length = this.options.schema.get('char_length');
      var value = this.options.value || '';
      var readonly = false;

      return {
        size: this.options.settings.get('size'),
        value: value,
        name: this.options.name,
        maxLength: length,
        characters: length - value.toString().length,
        comment: this.options.schema.get('comment'),
        readonly: readonly
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'directus_file_title',
    system: true,
    variables: [
      {id: 'size', type: 'String', default_value: 'large', ui: 'select', options: {options: {'large':__t('size_large'),'medium':__t('size_medium'),'small':__t('size_small')} }}
    ],
    Input: Input,
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

//  Maps Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

// Attribute          Type              Contains                                Example
// -------------------------------------------------------------------------------------------------------------------------------------
// options.schema     Backbone.Model    Structure/Schema for this table row     options.schema.get('type') [column_name, comment, type]
// options.model      Backbone.Model    Data/Model for this table row           options.model.get('id') [any column in current table row]
// options.value      String            Value for this field
// options.settings   Backbone.Model    Saved values for current UI options     options.settings.get('length') [any key from this UI options]
// options.name       String            Field name
/*jshint multistr: true */


define('core/uis/map',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var template =  '<style>#pac-input { \
        background-color: #fff; \
        padding: 0 11px 0 13px; \
        width: 400px; \
        font-family: Roboto; \
        font-size: 15px; \
        font-weight: 300; \
        text-overflow: ellipsis; \
      } .controls { \
        margin-top: 16px; \
        border: 1px solid transparent; \
        border-radius: 2px 0 0 2px; \
        box-sizing: border-box; \
        -moz-box-sizing: border-box; \
        height: 32px; \
        outline: none; \
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); \
      } #pac-input:focus { \
        border-color: #4d90fe; \
        margin-left: -1px; \
        padding-left: 14px;  /* Regular padding-left + 1. */ \
        width: 401px; \
      } \
      </style> \
      <input id="pac-input" class="controls" type="text" placeholder="Search Box"><div style="height: 400px" id="map-canvas"/> \
  <input type="text" value="{{value}}" name="{{name}}" id="{{name}}" class="medium" readonly/>';

  //If ALIAS, only fills in fields set in options, if varchar, sets to {lat},{lng}
  var Input = UIView.extend({
    templateSource: template,
    events: {
    },

    //Called Once Map Script is loaded. Initializes the Map Element.
    initializeMap: function() {
      var that = this;
      var google = window.google;
      var center = new google.maps.LatLng(40.77, -73.98);

      //If we have a value (Representing lat and long), set center to that value
      if(this.options.value) {
        var array = this.options.value.split(',');
        if(array) {
          var lng = array.pop();
          var lat = array.pop();
          if(!isNaN(lat) && !isNaN(lng)) {
            center = new google.maps.LatLng(lat, lng);
          }
        }
      }

      var mapOptions = {
        center: center,
        zoom: 12
      };
      var map = new google.maps.Map(this.$el.find("#map-canvas").get(0), mapOptions);

      if (navigator.geolocation && !this.options.value) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          map.setCenter(initialLocation);
        });
      }

      var input = (document.getElementById('pac-input'));
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
      var searchBox = new google.maps.places.SearchBox((input));

      // Listen for the event fired when the user selects an item from the
      // pick list. Retrieve the matching places for that item.
      google.maps.event.addListener(searchBox, 'places_changed', function() {
        var places = searchBox.getPlaces();

        var bounds = new google.maps.LatLngBounds();
        for (var i = 0; i < places.length; i++) {
          bounds.extend(places[i].geometry.location);
        }

        map.fitBounds(bounds);
      });

      // Bias the SearchBox results towards places that are within the bounds of the
      // current map's viewport.
      google.maps.event.addListener(map, 'bounds_changed', function() {
        var bounds = map.getBounds();
        searchBox.setBounds(bounds);
      });

      //Add A marker to value location if there is a value
      if(this.options.value) {
        var arr = this.options.value.split(',');
        if(arr) {
          var lng2 = arr.pop();
          var lat2 = arr.pop();
          this.marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat2, lng2),
            map:map
          });
        }
      }

      //On click, update value with click location
      google.maps.event.addListener(map, 'click', function(e) {
        if(that.marker) {
          that.marker.setPosition(e.latLng);
        } else {
          that.marker = new google.maps.Marker({
            position: e.latLng,
            map:map
          });
        }
        var latlngVal = e.latLng.lat() + "," + e.latLng.lng();
        that.$el.find('input').val(latlngVal);

        var apiKey = that.getApiKey();
        //Query Geocode api to get street info about specified latlong
        $.get('https://maps.googleapis.com/maps/api/geocode/json', {latlng: latlngVal, key: apiKey, result_type:"street_address"}, function(data) {
          if(data.results && data.results.length > 0) {
            data = data.results[0].address_components;
            var address = {};
            data.forEach(function(part) {
              switch(part.types[0]) {
                case 'street_number':
                  address.street_number = part.long_name;
                  break;
                case 'route':
                  address.street = part.long_name;
                  break;
                case 'locality':
                  address.city = part.long_name;
                  break;
                case 'postal_code':
                  address.postal_code = part.long_name;
                  break;
                case 'administrative_area_level_1':
                  address.state = part.long_name;
                  address.stateCode = part.short_name;
                  break;
                case 'country':
                  address.country = part.long_name;
                  address.countryCode = part.short_name;
                  break;
              }
            });

            //Update the value for the specified fields on the editpage form
            for(var key in address) {
              var field = that.options.settings.get(key + '_field') || false;
              if(field) {
                var $fieldInput = that.$el.closest('form').find('input[name='+field+']');
                if($fieldInput.length) {
                  $fieldInput.val(address[key]);
                }
              }
            }
          }
        });
      });
    },

    getApiKey: function() {
      return this.options.settings.get('apiKey') || app.settings.get('global').get('google_api_key');
    },

    serialize: function() {
      var value = this.options.value || '';

      var data = {
        value: value,
        name: this.options.name
      };

      if(this.options.schema.get('type') === "ALIAS") {
        data.name = '';
      }

      return data;
    },

    afterRender: function() {
      this.$el.find('#map-canvas').css('height', this.options.settings.get('mapHeight'));
    },

    //Called when UI is first created
    initialize: function() {
      var that = this;
      //Include the Google JSAPI for using Maps
      require(['https://www.google.com/jsapi'], function() {
        //Load Maps API using provided key, and call initializeMap() when API is loaded
        google.load('maps', '3', { other_params: 'sensor=false&libraries=places&key=' + that.getApiKey(), callback: function() {that.initializeMap();}});
      });
    }
  });

  var Component = UIComponent.extend({
    id: 'map',
    dataTypes: ['VARCHAR', 'ALIAS'],
    variables: [
      //Google API Key (Provided by Google)
      {id: 'apiKey', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      //column names to fill with respective item
      {id: 'street_number_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      {id: 'street_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      {id: 'city_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      {id: 'postal_code_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      {id: 'state_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      {id: 'stateCode_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      {id: 'country_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      {id: 'countryCode_field', type: 'String', default_value: '', ui: 'textinput', char_length: 200},
      //Height of Map Element in Pixels
      {id: 'mapHeight', type: 'Number', default_value: 400, ui: 'numeric', char_length: 4, comment: __t('map_mapHeight_comment')},
      {id: 'showLatLng', type: 'Boolean', default_value: false, ui: 'checkbox', comment: __t('map_showLatLng_comment')}
    ],
    settings: [{
      'collection': 'global',
      id: 'google_api_key',
      ui: 'textinput',
      char_length:200,
      comment: __t('maps_ui_global_settings_google_api_key')
    }],
    Input: Input,
    list: function(options) {
      return (options.value) ? options.value.toString().replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

/**
 * marked - a markdown parser
 * Copyright (c) 2011-2014, Christopher Jeffrey. (MIT Licensed)
 * https://github.com/chjj/marked
 */
(function(){var block={newline:/^\n+/,code:/^( {4}[^\n]+\n*)+/,fences:noop,hr:/^( *[-*_]){3,} *(?:\n+|$)/,heading:/^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)/,nptable:noop,lheading:/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/,blockquote:/^( *>[^\n]+(\n(?!def)[^\n]+)*\n*)+/,list:/^( *)(bull) [\s\S]+?(?:hr|def|\n{2,}(?! )(?!\1bull )\n*|\s*$)/,html:/^ *(?:comment *(?:\n|\s*$)|closed *(?:\n{2,}|\s*$)|closing *(?:\n{2,}|\s*$))/,def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +["(]([^\n]+)[")])? *(?:\n+|$)/,table:noop,paragraph:/^((?:[^\n]+\n?(?!hr|heading|lheading|blockquote|tag|def))+)\n*/,text:/^[^\n]+/};block.bullet=/(?:[*+-]|\d+\.)/;block.item=/^( *)(bull) [^\n]*(?:\n(?!\1bull )[^\n]*)*/;block.item=replace(block.item,"gm")(/bull/g,block.bullet)();block.list=replace(block.list)(/bull/g,block.bullet)("hr","\\n+(?=\\1?(?:[-*_] *){3,}(?:\\n+|$))")("def","\\n+(?="+block.def.source+")")();block.blockquote=replace(block.blockquote)("def",block.def)();block._tag="(?!(?:"+"a|em|strong|small|s|cite|q|dfn|abbr|data|time|code"+"|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo"+"|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|[^\\w\\s@]*@)\\b";block.html=replace(block.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,block._tag)();block.paragraph=replace(block.paragraph)("hr",block.hr)("heading",block.heading)("lheading",block.lheading)("blockquote",block.blockquote)("tag","<"+block._tag)("def",block.def)();block.normal=merge({},block);block.gfm=merge({},block.normal,{fences:/^ *(`{3,}|~{3,})[ \.]*(\S+)? *\n([\s\S]*?)\s*\1 *(?:\n+|$)/,paragraph:/^/,heading:/^ *(#{1,6}) +([^\n]+?) *#* *(?:\n+|$)/});block.gfm.paragraph=replace(block.paragraph)("(?!","(?!"+block.gfm.fences.source.replace("\\1","\\2")+"|"+block.list.source.replace("\\1","\\3")+"|")();block.tables=merge({},block.gfm,{nptable:/^ *(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)\n*/,table:/^ *\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)\n*/});function Lexer(options){this.tokens=[];this.tokens.links={};this.options=options||marked.defaults;this.rules=block.normal;if(this.options.gfm){if(this.options.tables){this.rules=block.tables}else{this.rules=block.gfm}}}Lexer.rules=block;Lexer.lex=function(src,options){var lexer=new Lexer(options);return lexer.lex(src)};Lexer.prototype.lex=function(src){src=src.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n");return this.token(src,true)};Lexer.prototype.token=function(src,top,bq){var src=src.replace(/^ +$/gm,""),next,loose,cap,bull,b,item,space,i,l;while(src){if(cap=this.rules.newline.exec(src)){src=src.substring(cap[0].length);if(cap[0].length>1){this.tokens.push({type:"space"})}}if(cap=this.rules.code.exec(src)){src=src.substring(cap[0].length);cap=cap[0].replace(/^ {4}/gm,"");this.tokens.push({type:"code",text:!this.options.pedantic?cap.replace(/\n+$/,""):cap});continue}if(cap=this.rules.fences.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"code",lang:cap[2],text:cap[3]||""});continue}if(cap=this.rules.heading.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"heading",depth:cap[1].length,text:cap[2]});continue}if(top&&(cap=this.rules.nptable.exec(src))){src=src.substring(cap[0].length);item={type:"table",header:cap[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:cap[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:cap[3].replace(/\n$/,"").split("\n")};for(i=0;i<item.align.length;i++){if(/^ *-+: *$/.test(item.align[i])){item.align[i]="right"}else if(/^ *:-+: *$/.test(item.align[i])){item.align[i]="center"}else if(/^ *:-+ *$/.test(item.align[i])){item.align[i]="left"}else{item.align[i]=null}}for(i=0;i<item.cells.length;i++){item.cells[i]=item.cells[i].split(/ *\| */)}this.tokens.push(item);continue}if(cap=this.rules.lheading.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"heading",depth:cap[2]==="="?1:2,text:cap[1]});continue}if(cap=this.rules.hr.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"hr"});continue}if(cap=this.rules.blockquote.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"blockquote_start"});cap=cap[0].replace(/^ *> ?/gm,"");this.token(cap,top,true);this.tokens.push({type:"blockquote_end"});continue}if(cap=this.rules.list.exec(src)){src=src.substring(cap[0].length);bull=cap[2];this.tokens.push({type:"list_start",ordered:bull.length>1});cap=cap[0].match(this.rules.item);next=false;l=cap.length;i=0;for(;i<l;i++){item=cap[i];space=item.length;item=item.replace(/^ *([*+-]|\d+\.) +/,"");if(~item.indexOf("\n ")){space-=item.length;item=!this.options.pedantic?item.replace(new RegExp("^ {1,"+space+"}","gm"),""):item.replace(/^ {1,4}/gm,"")}if(this.options.smartLists&&i!==l-1){b=block.bullet.exec(cap[i+1])[0];if(bull!==b&&!(bull.length>1&&b.length>1)){src=cap.slice(i+1).join("\n")+src;i=l-1}}loose=next||/\n\n(?!\s*$)/.test(item);if(i!==l-1){next=item.charAt(item.length-1)==="\n";if(!loose)loose=next}this.tokens.push({type:loose?"loose_item_start":"list_item_start"});this.token(item,false,bq);this.tokens.push({type:"list_item_end"})}this.tokens.push({type:"list_end"});continue}if(cap=this.rules.html.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:!this.options.sanitizer&&(cap[1]==="pre"||cap[1]==="script"||cap[1]==="style"),text:cap[0]});continue}if(!bq&&top&&(cap=this.rules.def.exec(src))){src=src.substring(cap[0].length);this.tokens.links[cap[1].toLowerCase()]={href:cap[2],title:cap[3]};continue}if(top&&(cap=this.rules.table.exec(src))){src=src.substring(cap[0].length);item={type:"table",header:cap[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:cap[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:cap[3].replace(/(?: *\| *)?\n$/,"").split("\n")};for(i=0;i<item.align.length;i++){if(/^ *-+: *$/.test(item.align[i])){item.align[i]="right"}else if(/^ *:-+: *$/.test(item.align[i])){item.align[i]="center"}else if(/^ *:-+ *$/.test(item.align[i])){item.align[i]="left"}else{item.align[i]=null}}for(i=0;i<item.cells.length;i++){item.cells[i]=item.cells[i].replace(/^ *\| *| *\| *$/g,"").split(/ *\| */)}this.tokens.push(item);continue}if(top&&(cap=this.rules.paragraph.exec(src))){src=src.substring(cap[0].length);this.tokens.push({type:"paragraph",text:cap[1].charAt(cap[1].length-1)==="\n"?cap[1].slice(0,-1):cap[1]});continue}if(cap=this.rules.text.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"text",text:cap[0]});continue}if(src){throw new Error("Infinite loop on byte: "+src.charCodeAt(0))}}return this.tokens};var inline={escape:/^\\([\\`*{}\[\]()#+\-.!_>])/,autolink:/^<([^ >]+(@|:\/)[^ >]+)>/,url:noop,tag:/^<!--[\s\S]*?-->|^<\/?\w+(?:"[^"]*"|'[^']*'|[^'">])*?>/,link:/^!?\[(inside)\]\(href\)/,reflink:/^!?\[(inside)\]\s*\[([^\]]*)\]/,nolink:/^!?\[((?:\[[^\]]*\]|[^\[\]])*)\]/,strong:/^__([\s\S]+?)__(?!_)|^\*\*([\s\S]+?)\*\*(?!\*)/,em:/^\b_((?:[^_]|__)+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,code:/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,br:/^ {2,}\n(?!\s*$)/,del:noop,text:/^[\s\S]+?(?=[\\<!\[_*`]| {2,}\n|$)/};inline._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/;inline._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/;inline.link=replace(inline.link)("inside",inline._inside)("href",inline._href)();inline.reflink=replace(inline.reflink)("inside",inline._inside)();inline.normal=merge({},inline);inline.pedantic=merge({},inline.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/});inline.gfm=merge({},inline.normal,{escape:replace(inline.escape)("])","~|])")(),url:/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:replace(inline.text)("]|","~]|")("|","|https?://|")()});inline.breaks=merge({},inline.gfm,{br:replace(inline.br)("{2,}","*")(),text:replace(inline.gfm.text)("{2,}","*")()});function InlineLexer(links,options){this.options=options||marked.defaults;this.links=links;this.rules=inline.normal;this.renderer=this.options.renderer||new Renderer;this.renderer.options=this.options;if(!this.links){throw new Error("Tokens array requires a `links` property.")}if(this.options.gfm){if(this.options.breaks){this.rules=inline.breaks}else{this.rules=inline.gfm}}else if(this.options.pedantic){this.rules=inline.pedantic}}InlineLexer.rules=inline;InlineLexer.output=function(src,links,options){var inline=new InlineLexer(links,options);return inline.output(src)};InlineLexer.prototype.output=function(src){var out="",link,text,href,cap;while(src){if(cap=this.rules.escape.exec(src)){src=src.substring(cap[0].length);out+=cap[1];continue}if(cap=this.rules.autolink.exec(src)){src=src.substring(cap[0].length);if(cap[2]==="@"){text=cap[1].charAt(6)===":"?this.mangle(cap[1].substring(7)):this.mangle(cap[1]);href=this.mangle("mailto:")+text}else{text=escape(cap[1]);href=text}out+=this.renderer.link(href,null,text);continue}if(!this.inLink&&(cap=this.rules.url.exec(src))){src=src.substring(cap[0].length);text=escape(cap[1]);href=text;out+=this.renderer.link(href,null,text);continue}if(cap=this.rules.tag.exec(src)){if(!this.inLink&&/^<a /i.test(cap[0])){this.inLink=true}else if(this.inLink&&/^<\/a>/i.test(cap[0])){this.inLink=false}src=src.substring(cap[0].length);out+=this.options.sanitize?this.options.sanitizer?this.options.sanitizer(cap[0]):escape(cap[0]):cap[0];continue}if(cap=this.rules.link.exec(src)){src=src.substring(cap[0].length);this.inLink=true;out+=this.outputLink(cap,{href:cap[2],title:cap[3]});this.inLink=false;continue}if((cap=this.rules.reflink.exec(src))||(cap=this.rules.nolink.exec(src))){src=src.substring(cap[0].length);link=(cap[2]||cap[1]).replace(/\s+/g," ");link=this.links[link.toLowerCase()];if(!link||!link.href){out+=cap[0].charAt(0);src=cap[0].substring(1)+src;continue}this.inLink=true;out+=this.outputLink(cap,link);this.inLink=false;continue}if(cap=this.rules.strong.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.strong(this.output(cap[2]||cap[1]));continue}if(cap=this.rules.em.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.em(this.output(cap[2]||cap[1]));continue}if(cap=this.rules.code.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.codespan(escape(cap[2],true));continue}if(cap=this.rules.br.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.br();continue}if(cap=this.rules.del.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.del(this.output(cap[1]));continue}if(cap=this.rules.text.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.text(escape(this.smartypants(cap[0])));continue}if(src){throw new Error("Infinite loop on byte: "+src.charCodeAt(0))}}return out};InlineLexer.prototype.outputLink=function(cap,link){var href=escape(link.href),title=link.title?escape(link.title):null;return cap[0].charAt(0)!=="!"?this.renderer.link(href,title,this.output(cap[1])):this.renderer.image(href,title,escape(cap[1]))};InlineLexer.prototype.smartypants=function(text){if(!this.options.smartypants)return text;return text.replace(/---/g,"—").replace(/--/g,"–").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…")};InlineLexer.prototype.mangle=function(text){if(!this.options.mangle)return text;var out="",l=text.length,i=0,ch;for(;i<l;i++){ch=text.charCodeAt(i);if(Math.random()>.5){ch="x"+ch.toString(16)}out+="&#"+ch+";"}return out};function Renderer(options){this.options=options||{}}Renderer.prototype.code=function(code,lang,escaped){if(this.options.highlight){var out=this.options.highlight(code,lang);if(out!=null&&out!==code){escaped=true;code=out}}if(!lang){return"<pre><code>"+(escaped?code:escape(code,true))+"\n</code></pre>"}return'<pre><code class="'+this.options.langPrefix+escape(lang,true)+'">'+(escaped?code:escape(code,true))+"\n</code></pre>\n"};Renderer.prototype.blockquote=function(quote){return"<blockquote>\n"+quote+"</blockquote>\n"};Renderer.prototype.html=function(html){return html};Renderer.prototype.heading=function(text,level,raw){return"<h"+level+' id="'+this.options.headerPrefix+raw.toLowerCase().replace(/[^\w]+/g,"-")+'">'+text+"</h"+level+">\n"};Renderer.prototype.hr=function(){return this.options.xhtml?"<hr/>\n":"<hr>\n"};Renderer.prototype.list=function(body,ordered){var type=ordered?"ol":"ul";return"<"+type+">\n"+body+"</"+type+">\n"};Renderer.prototype.listitem=function(text){return"<li>"+text+"</li>\n"};Renderer.prototype.paragraph=function(text){return"<p>"+text+"</p>\n"};Renderer.prototype.table=function(header,body){return"<table>\n"+"<thead>\n"+header+"</thead>\n"+"<tbody>\n"+body+"</tbody>\n"+"</table>\n"};Renderer.prototype.tablerow=function(content){return"<tr>\n"+content+"</tr>\n"};Renderer.prototype.tablecell=function(content,flags){var type=flags.header?"th":"td";var tag=flags.align?"<"+type+' style="text-align:'+flags.align+'">':"<"+type+">";return tag+content+"</"+type+">\n"};Renderer.prototype.strong=function(text){return"<strong>"+text+"</strong>"};Renderer.prototype.em=function(text){return"<em>"+text+"</em>"};Renderer.prototype.codespan=function(text){return"<code>"+text+"</code>"};Renderer.prototype.br=function(){return this.options.xhtml?"<br/>":"<br>"};Renderer.prototype.del=function(text){return"<del>"+text+"</del>"};Renderer.prototype.link=function(href,title,text){if(this.options.sanitize){try{var prot=decodeURIComponent(unescape(href)).replace(/[^\w:]/g,"").toLowerCase()}catch(e){return""}if(prot.indexOf("javascript:")===0||prot.indexOf("vbscript:")===0){return""}}var out='<a href="'+href+'"';if(title){out+=' title="'+title+'"'}out+=">"+text+"</a>";return out};Renderer.prototype.image=function(href,title,text){var out='<img src="'+href+'" alt="'+text+'"';if(title){out+=' title="'+title+'"'}out+=this.options.xhtml?"/>":">";return out};Renderer.prototype.text=function(text){return text};function Parser(options){this.tokens=[];this.token=null;this.options=options||marked.defaults;this.options.renderer=this.options.renderer||new Renderer;this.renderer=this.options.renderer;this.renderer.options=this.options}Parser.parse=function(src,options,renderer){var parser=new Parser(options,renderer);return parser.parse(src)};Parser.prototype.parse=function(src){this.inline=new InlineLexer(src.links,this.options,this.renderer);this.tokens=src.reverse();var out="";while(this.next()){out+=this.tok()}return out};Parser.prototype.next=function(){return this.token=this.tokens.pop()};Parser.prototype.peek=function(){return this.tokens[this.tokens.length-1]||0};Parser.prototype.parseText=function(){var body=this.token.text;while(this.peek().type==="text"){body+="\n"+this.next().text}return this.inline.output(body)};Parser.prototype.tok=function(){switch(this.token.type){case"space":{return""}case"hr":{return this.renderer.hr()}case"heading":{return this.renderer.heading(this.inline.output(this.token.text),this.token.depth,this.token.text)}case"code":{return this.renderer.code(this.token.text,this.token.lang,this.token.escaped)}case"table":{var header="",body="",i,row,cell,flags,j;cell="";for(i=0;i<this.token.header.length;i++){flags={header:true,align:this.token.align[i]};cell+=this.renderer.tablecell(this.inline.output(this.token.header[i]),{header:true,align:this.token.align[i]})}header+=this.renderer.tablerow(cell);for(i=0;i<this.token.cells.length;i++){row=this.token.cells[i];cell="";for(j=0;j<row.length;j++){cell+=this.renderer.tablecell(this.inline.output(row[j]),{header:false,align:this.token.align[j]})}body+=this.renderer.tablerow(cell)}return this.renderer.table(header,body)}case"blockquote_start":{var body="";while(this.next().type!=="blockquote_end"){body+=this.tok()}return this.renderer.blockquote(body)}case"list_start":{var body="",ordered=this.token.ordered;while(this.next().type!=="list_end"){body+=this.tok()}return this.renderer.list(body,ordered)}case"list_item_start":{var body="";while(this.next().type!=="list_item_end"){body+=this.token.type==="text"?this.parseText():this.tok()}return this.renderer.listitem(body)}case"loose_item_start":{var body="";while(this.next().type!=="list_item_end"){body+=this.tok()}return this.renderer.listitem(body)}case"html":{var html=!this.token.pre&&!this.options.pedantic?this.inline.output(this.token.text):this.token.text;return this.renderer.html(html)}case"paragraph":{return this.renderer.paragraph(this.inline.output(this.token.text))}case"text":{return this.renderer.paragraph(this.parseText())}}};function escape(html,encode){return html.replace(!encode?/&(?!#?\w+;)/g:/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function unescape(html){return html.replace(/&([#\w]+);/g,function(_,n){n=n.toLowerCase();if(n==="colon")return":";if(n.charAt(0)==="#"){return n.charAt(1)==="x"?String.fromCharCode(parseInt(n.substring(2),16)):String.fromCharCode(+n.substring(1))}return""})}function replace(regex,opt){regex=regex.source;opt=opt||"";return function self(name,val){if(!name)return new RegExp(regex,opt);val=val.source||val;val=val.replace(/(^|[^\[])\^/g,"$1");regex=regex.replace(name,val);return self}}function noop(){}noop.exec=noop;function merge(obj){var i=1,target,key;for(;i<arguments.length;i++){target=arguments[i];for(key in target){if(Object.prototype.hasOwnProperty.call(target,key)){obj[key]=target[key]}}}return obj}function marked(src,opt,callback){if(callback||typeof opt==="function"){if(!callback){callback=opt;opt=null}opt=merge({},marked.defaults,opt||{});var highlight=opt.highlight,tokens,pending,i=0;try{tokens=Lexer.lex(src,opt)}catch(e){return callback(e)}pending=tokens.length;var done=function(err){if(err){opt.highlight=highlight;return callback(err)}var out;try{out=Parser.parse(tokens,opt)}catch(e){err=e}opt.highlight=highlight;return err?callback(err):callback(null,out)};if(!highlight||highlight.length<3){return done()}delete opt.highlight;if(!pending)return done();for(;i<tokens.length;i++){(function(token){if(token.type!=="code"){return--pending||done()}return highlight(token.text,token.lang,function(err,code){if(err)return done(err);if(code==null||code===token.text){return--pending||done()}token.text=code;token.escaped=true;--pending||done()})})(tokens[i])}return}try{if(opt)opt=merge({},marked.defaults,opt);return Parser.parse(Lexer.lex(src,opt),opt)}catch(e){e.message+="\nPlease report this to https://github.com/chjj/marked.";if((opt||marked.defaults).silent){return"<p>An error occured:</p><pre>"+escape(e.message+"",true)+"</pre>"}throw e}}marked.options=marked.setOptions=function(opt){merge(marked.defaults,opt);return marked};marked.defaults={gfm:true,tables:true,breaks:false,pedantic:false,sanitize:false,sanitizer:null,mangle:true,smartLists:false,silent:false,highlight:null,langPrefix:"lang-",smartypants:false,headerPrefix:"",renderer:new Renderer,xhtml:false};marked.Parser=Parser;marked.parser=Parser.parse;marked.Renderer=Renderer;marked.Lexer=Lexer;marked.lexer=Lexer.lex;marked.InlineLexer=InlineLexer;marked.inlineLexer=InlineLexer.output;marked.parse=marked;if(typeof module!=="undefined"&&typeof exports==="object"){module.exports=marked}else if(typeof define==="function"&&define.amd){define('marked',[],function(){return marked})}else{this.marked=marked}}).call(function(){return this||(typeof window!=="undefined"?window:global)}());
//  Markdown UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/markdown',['app', 'core/UIComponent', 'core/UIView', 'marked'],function(app, UIComponent, UIView, marked) {

  

  var template = '<style type="text/css"> \
                  textarea.md-editor { \
                    margin-top:1em; \
                  }\
                  .md-editor-preview { \
                    padding: 1em;\
                    display: none; \
                  }\
                  </style> \
                  <div> \
                    <button class="btn btn-small active" type="button" data-action="md-edit">Editor</button> \
                    <button class="btn btn-small" type="button" data-action="md-preview">Preview</button> \
                  </div> \
                  <textarea rows="{{rows}}" class="md-editor" name="{{name}}" id="{{name}}" {{#if readonly}}readonly{{/if}}>{{rawValue}}</textarea> \
                  <div class="md-editor-preview">{{value}}</div>';

  var Input = UIView.extend({
    events: {
      'keyup': 'renderMarkdown',
      'change textarea.md-editor': 'renderMarkdown',
      'click button[data-action="md-preview"]': function (e) {
        this.$('.md-editor').hide();
        this.$('.md-editor-preview').show();
        this.$('.btn').removeClass('active');
        e.currentTarget.className += ' active';
      },
      'click button[data-action="md-edit"]': function (e) {
        this.$('.md-editor-preview').hide();
        this.$('.md-editor').show();
        this.$('.btn').removeClass('active');
        e.currentTarget.className += ' active';
      }
    },

    renderMarkdown: function() {
      var value = this.$('.md-editor').val();
      if (value) {
        this.$('.md-editor-preview').html(marked(value));
      }
    },

    templateSource: template,
    templateCompileOptions: { noEscape: true },

    initialize: function() {
      marked.setOptions({
        gfm: this.options.settings.get('github_flavored_markdown'),
        tables: this.options.settings.get('tables'),
        breaks: this.options.settings.get('breaks'),
        sanitize: this.options.settings.get('sanitize')
      });
    },

    serialize: function() {
      return {
        rawValue: this.options.value,
        value: (this.options.value) ? marked(this.options.value):'',
        name: this.options.name,
        rows: this.options.settings.get('rows'),
        comment: this.options.schema.get('comment'),
        readonly: !this.options.canWrite
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'markdown',
    dataTypes: ['TEXT', 'VARCHAR'],
    variables: [
      {id: 'rows', type: 'Number', default_value: 14, ui: 'numeric', char_length: 3},
      {id: 'github_flavored_markdown', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'tables', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'breaks', type: 'Boolean', default_value: false, ui: 'checkbox'},
      {id: 'sanitize', type: 'Boolean', default_value: false, ui: 'checkbox'}
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && _.isEmpty(value)) {
        return 'This field is required';
      }
    },
    list: function(options) {
      var raw_val = marked(options.value);

      return _.isString(raw_val) ? raw_val.replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '<span class="silver">--</span>';
    }
  });

  return Component;
});

//  Relational core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
/*jshint multistr: true */

define('core/uis/multiple_files',[
    'app',
    'underscore',
    'backbone',
    'handlebars',
    'sortable',
    'core/UIComponent',
    'core/UIView',
    'core/overlays/overlays',
    'core/t',
  ],
  function(app, _, Backbone, Handlebars, Sortable, UIComponent, UIView, Overlays, __t) {

  

  var template = '<style type="text/css"> \
        .ui-file-container:after { \
          clear: both; \
          content: ""; \
          display: block; \
          width: 100%; \
        } \
        .media-slideshow-item { \
          cursor: {{#if sortable}}move{{else}}pointer{{/if}}; \
          width: 160px; \
          float: left; \
          height: 160px; \
          position: relative; \
        } \
        .media-slideshow-item img { \
          width: 100%; \
          height: 100%; \
        } \
        .remove-hover-state .show-circle:hover .white-circle { \
          opacity: 0.0; \
        } \
        .multiple-image-actions { \
          margin: 10px 0 0 0; \
          display: block; \
          font-size: 12px; \
        } \
        .multiple-image-actions span:hover { \
          color: #333333; \
          cursor: pointer; \
        } \
        div.single-image-thumbnail.empty { \
          float: left; \
          background-color: #ffffff; \
          color: #ededed; \
          text-align: center; \
          cursor: pointer; \
          width: 156px; \
          height: 156px; \
          background-color: #ffffff; \
          border: 2px dashed #bbbbbb; \
          font-size: 12px; \
          font-weight: 600; \
          line-height: 14px; \
          color: #bbbbbb; \
        } \
        div.single-image-thumbnail.empty span { \
          margin-top: 28px; \
          text-align: center; \
          display: inline-block; \
          line-height: 18px; \
          padding: 0 30px 0 30px; \
        } \
        div.single-image-thumbnail.empty span i.material-icons { \
          display: block; \
          font-size: 60px; \
          width: auto; \
          margin-bottom: 5px; \
        } \
        div.single-image-thumbnail.empty.dragover, \
        div.single-image-thumbnail.empty:hover { \
          background-color: #BBBBBB; \
          color: #ffffff; \
          cursor: pointer; \
        } \
      </style> \
      <div class="ui-file-container">{{#rows}}<span class="media-slideshow-item show-circle margin-right-small margin-bottom-small"><img data-file-cid="{{cid}}" data-file-id="{{id}}" src={{url}}>{{#if ../showRemoveButton}}<div class="remove-slideshow-item large-circle white-circle"><span class="icon icon-cross"></span></div>{{/if}}</span>{{/rows}}<div class="swap-method single-image-thumbnail empty ui-thumbnail-dropzone" data-action=add><span><i class="material-icons">collections</i>{{t "directus_files_drop_or_choose_file"}}</span></div></div> \
      <!-- <div class="related-table"></div> --> \
      <div class="multiple-image-actions"> \
        {{#if showAddButton}}<button class="btn btn-primary btn-small margin-right-small" data-action="add" type="button">{{t "file_upload"}}</button>{{/if}} \
        {{#if showChooseButton}}<button class="btn btn-primary btn-small" data-action="choose" type="button">{{t "directus_files"}}</button>{{/if}} \
      </div>';

  var Input = UIView.extend({
    templateSource: template,

    events: {
      'click [data-action=add]': 'addItem',
      'click [data-action=choose]': 'chooseItem',
      'click .remove-slideshow-item': 'removeItem',
      'click .media-slideshow-item > img': function(e) {
        if (!this.canEdit) {
          return;
        }
        var cid = $(e.target).attr('data-file-cid');
        var model = this.relatedCollection.get(cid, true);
        this.editModel(model);
      }
    },

    addItem: function() {
      if (this.showAddButton && this.canEdit) {
        this.addModel(new this.relatedCollection.nestedCollection.model({}, {
          collection: this.relatedCollection.nestedCollection,
          parse: true
        }));
      }
    },

    removeItem: function(e) {
      var target_cid = $(e.target).closest('.media-slideshow-item').find('img').attr('data-file-cid');
      var model = this.relatedCollection.get(target_cid);

      if (model.isNew()) return this.relatedCollection.remove(model);

      var name = {};
      name[app.statusMapping.status_name] = app.statusMapping.deleted_num;
      model.set(name);
    },

    addModel: function(model) {
      var EditView = require("modules/tables/views/EditView");
      var collection = this.relatedCollection;
      var view = new EditView({model: model, inModal: true});
      view.headerOptions.route.isOverlay = true;
      view.headerOptions.route.breadcrumbs = [];
      view.headerOptions.basicSave = true;

      view.events = {
        'click .saved-success': function() {
          this.save();
        },
        'click #removeOverlay': function() {
          app.router.removeOverlayPage(this);
        }
      };

      app.router.overlayPage(view);

      view.save = function() {
        model.set(view.editView.data());
        collection.add(model,{nest: true});
        app.router.removeOverlayPage(this);
      };
    },

    chooseItem: function() {
      var collection = app.files;
      var view = new Overlays.ListSelect({collection: collection});
      var me = this;

      app.router.overlayPage(view);

      view.save = function() {
        _.each(view.table.selection(), function(id) {
          var data = _.clone(collection.get(id).attributes);
          me.relatedCollection.add(data, {parse: true, silent: true, nest: true});
        }, this);
        me.relatedCollection.trigger('add');
        app.router.removeOverlayPage(this);
      };

      collection.fetch();
    },

    editModel: function(model) {
      var EditView = require("modules/tables/views/EditView");
      var columnName = this.columnSchema.relationship.get('junction_key_right');
      var view = new EditView({
        model: model,
        hiddenFields: [columnName],
        skipFetch: (model.isNew() || model.unsavedAttributes())
      });

      view.headerOptions.route.isOverlay = true;
      view.headerOptions.route.breadcrumbs = [];
      view.headerOptions.basicSave = true;

      view.events = {
        'click .saved-success': function() {
          this.save();
        },
        'click #removeOverlay': function() {
          app.router.removeOverlayPage(this);
        }
      };

      app.router.overlayPage(view);

      view.save = function() {
        model.set(model.diff(view.editView.data()));
        app.router.removeOverlayPage(this);
      };

      // Fetch first time to get the nested tables
      // Only fetch if it's not a new entry
      if(!model.isNew() && !model.unsavedAttributes()) {
        model.fetch();
      }
    },

    drop: function() {
      var relatedCollection = this.model.get(this.name);

      this.$('.media-slideshow-item img').each(function(i) {
        relatedCollection.get($(this).attr('data-file-cid')).set({sort: i},{silent: true});
      });

      // There is no "saveAfterDrop" now, but we could use this for instant saving
      // if (this.options.saveAfterDrop) {
      //   relatedCollection.save({columns:['id','sort']});
      // }

      relatedCollection.setOrder('sort','ASC',{silent: true});
    },

    serialize: function() {
      var models = this.relatedCollection.models;
      var rows = [];
      var that = this;
      _.each(models, function(model) {
        if(model.get(app.statusMapping.status_name) !== app.statusMapping.deleted_num) {
          var cid = model.cid;
          var url;

          model = new app.files.model(model.get('data').attributes, {collection: that.relatedCollection});
          if (model.isNew()) {
            url = model.get('thumbnailData') || model.get('url');
          } else {
            url = model.makeFileUrl(true)
          }

          rows.push({id: model.id, url: url, cid:cid});
        }
      });

      var relatedCollection = this.model.get(this.name);
      var junctionStructure = relatedCollection.junctionStructure;
      var sortable = (junctionStructure.get('sort') !== undefined);

      return {
        rows: rows,
        canEdit: this.canEdit,
        showChooseButton: this.showChooseButton && this.canEdit,
        showAddButton: this.showAddButton && this.canEdit,
        showRemoveButton: this.showRemoveButton && this.canEdit,
        sortable: sortable
      };
    },

    afterRender: function() {
      var $dropzone = this.$el;
      var model = this.fileModel;
      var self = this;
      var relatedCollection = this.model.get(this.name);
      var relatedSchema = relatedCollection.structure;
      var junctionStructure = relatedCollection.junctionStructure;

      // Since data transfer is not supported by jquery...
      // XHR2, FormData
      $dropzone[0].ondrop = function(e) {
        e.stopPropagation();
        e.preventDefault();

        if(self.sort && self.sort.isDragging) {
          self.sort.isDragging = false;
          return;
        }
        var FilesModel = require('modules/files/FilesModel');
        _.each(e.dataTransfer.files, function(file) {
          // force a fileModel object
          var fileModel = new FilesModel({}, {collection:{}});
          fileModel.setFile(file, null, function(item) {
            item[app.statusMapping.status_name] = app.statusMapping.active_num;
            // Unset the model ID so that a new file record is created
            // (and the old file record isn't replaced w/ this data)
            item.id = undefined;
            item.user = self.userId;
            var model = new self.relatedCollection.nestedCollection.model(item, {collection: self.relatedCollection.nestedCollection, parse: true});
            model = new Backbone.Model({data: model}, {collection:self.relatedCollection});
            self.relatedCollection.add(model);
          });
        });
      };

      if(junctionStructure.get('sort') !== undefined) {
        // Drag and drop reordering
        var container = this.$el.find('.ui-file-container')[0];
        var that = this;
        this.sort = new Sortable(container, {
          animation: 150, // ms, animation speed moving items when sorting, `0` — without animation
          draggable: ".media-slideshow-item", // Specifies which items inside the element should be sortable
          ghostClass: "sortable-file-ghost",
          onStart: function (evt) {
            //var dragItem = jQuery(evt.item);
            var jContainer = jQuery(container);
            jContainer.addClass('remove-hover-state');
          },
          onEnd: function (evt) {
            //var dragItem = jQuery(evt.item);
            var jContainer = jQuery(container);
            jContainer.removeClass('remove-hover-state');
          },
          onUpdate: function (evt){
            that.drop();
          }
        });
      }

    },

    initialize: function(options) {
      if (!this.columnSchema.relationship ||
           'MANYTOMANY' !== this.columnSchema.relationship.get('type')) {
        throw __t('m2m_the_column_need_to_have_m2m_relationship', {
          column: this.columnSchema.id,
          type: 'MANYTOMANY',
          ui: Component.id
        });
      }

      var relatedCollection = this.model.get(this.name);
      var relatedSchema = relatedCollection.structure;
      var junctionStructure = relatedCollection.junctionStructure;
      var sortable = false;

      relatedCollection.each(function(model) {
        return model.startTracking();
      });

      if(junctionStructure.get('sort') !== undefined) {
        sortable = true;
        relatedCollection.setOrder('sort','ASC');
      }

      this.canEdit = !(options.inModal || false);
      this.showRemoveButton = this.columnSchema.options.get('remove_button') === true;
      this.showChooseButton = this.columnSchema.options.get('choose_button') === true;
      this.showAddButton = this.columnSchema.options.get('add_button') === true;
      this.sortable = sortable;

      this.relatedCollection = relatedCollection;
      this.listenTo(relatedCollection, 'change add remove', function() {
        this.render();
      }, this);

      this.listenTo(relatedCollection.nestedCollection, 'sync', function() {
      }, this);
    }
  });

  var Component = UIComponent.extend({
    id: 'multiple_files',
    dataTypes: ['MANYTOMANY'],
    variables: [
      // Toggles an "Add" button for adding new files directly into the UI
      {id: 'add_button', type: 'Boolean', default_value: true, ui: 'checkbox'},
      // Toggles a "Choose" button that opens a modal with all existing Directus files to choose from
      {id: 'choose_button', type: 'Boolean', default_value: true, ui: 'checkbox'},
      // Toggles "Remove" buttons for each file that let's you delete the file
      {id: 'remove_button', type: 'Boolean', default_value: true, ui: 'checkbox'},
    ],
    Input: Input,
    validate: function(value, options) {
      if (options.schema.isRequired() && value.length === 0) {
        return __t('this_field_is_required');
      }
    },
    list: function() {
      return 'x';
    }
  });

  return Component;
});

//  Translation core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('core/uis/translation',['app', 'core/UIComponent', 'core/UIView', 'core/t'], function(app, UIComponent, UIView, __t) {

  

  var Component = UIComponent.extend({
    id: 'translation',
    dataTypes: ['ONETOMANY'],
    variables: [
      {id: 'languages_table', type: 'String', default_value: '', ui: 'textinput', char_length: 255, comment: __t('translation_languages_table_comment')},
      {id: 'languages_name_column', type: 'String', default_value: '', ui: 'textinput', char_length: 255, comment: __t('translation_languages_name_column_comment')},
      {id: 'languages_code_column', type: 'String', default_value: '', ui: 'textinput', char_length: 255, comment: __t('translation_languages_code_column_comment')},
      {id: 'default_language_id', type: 'Number', ui: 'numeric', comment: __t('translation_default_language_id_comment')},
      {id: 'left_column_name', type: 'String', default_value: '', ui: 'textinput', char_length: 255, comment: __t('translation_left_column_name_comment')},
    ],
    Input: UIView
  });

  return Component;
});

//  Select Core UI component
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

/*
{
  "2up": {
  "name": "2-Up Images",
  "thumb_url": "http://example.com/image.gif",
  "column_blacklist": [
     "bb_title",
     "bb_url"
  ]
  },
  "3up": {
  "name": "3-Up Images",
  "thumb_url": "http://example.com/image.gif",
  "column_blacklist": [
    "hero_client"
  ]
  }
}
*/

define('core/uis/template_chooser',['app', 'core/UIComponent', 'core/UIView', 'core/t'],function(app, UIComponent, UIView, __t) {

  

  var template = '<div class="select-container"> \
                    <select name="{{name}}" {{#if readonly}}disabled{{/if}}> \
                      {{#if allow_null}}<option value="">{{placeholder_text}}</option>{{/if}}{{#options}} \
                      <option value="{{key}}" data-column-blacklist="{{column_blacklist}}" {{#if selected}}selected{{/if}}>{{value}}</option>{{/options}} \
                    </select> \
                    <i class="material-icons select-arrow">arrow_drop_down</i> \
                  </div>';

  var Input = UIView.extend({
    templateSource: template,

    // Event Declarations
    events: {
      'input select': 'updateVisibleColumns'
    },

    // Update visible fields/inputs
    updateVisibleColumns: function(e) {
      var columnBlacklist = this.$el.find('select option:selected').data('columnBlacklist').split(",");

      $('.batchcontainer').show(); // Needs to be scoped/limited to this overlay
      for (var i = 0; i < columnBlacklist.length; i++) {
        $("#edit_field_" + columnBlacklist[i]).parent().parent().parent().hide();
      }
    },

    serialize: function() {
      var selectedValue = this.options.value;
      var options = this.options.settings.get('options');

      if (_.isString(options)) {
        try {
          options = $.parseJSON(options);
        } catch (err) {
          console.error(__t('your_template_chooser_has_a_malformed_json'));
        }
      }

      options = _.map(options, function(value, key) {
        var item = {};
        item.value = value.name;
        item.thumb_url = value.thumb_url;
        item.column_blacklist = value.column_blacklist;
        item.key = key;
        item.selected = (item.key === selectedValue);
        return item;
      });

      return {
        options: options,
        name: this.options.name,
        comment: this.options.schema.get('comment'),
        readonly: !this.options.canWrite,
        allow_null: this.options.settings.get('allow_null'),
        placeholder_text: (this.options.settings.get('placeholder_text')) ?  this.options.settings.get('placeholder_text') : __t('select_from_below')
      };
    }
  });

  var Component = UIComponent.extend({
    id: 'template_chooser',
    dataTypes: ['VARCHAR', 'INT', 'TINYINT'],
    variables: [
      {id: 'options', type: 'String', default_value: '', ui: 'textarea', options:{'rows': 25}  },
      {id: 'allow_null', type: 'Boolean', default_value: false, ui: 'checkbox'}
    ],
    Input: Input,
    list: function(options) {
      return _.isString(options.value) ? options.value.replace(/<(?:.|\n)*?>/gm, '').substr(0,100) : '';
    }
  });

  return Component;
});

define('core/UIManager',['require','exports','module','core/uis/textinput','core/uis/directus_columns','core/uis/instructions','core/uis/checkbox/checkbox','core/uis/color','core/uis/countries/interface','core/uis/numeric','core/uis/slider','core/uis/single_file','core/uis/slug','core/uis/textarea','core/uis/directus_user','core/uis/directus_activity','core/uis/datetime/datetime','core/uis/datetime/date','core/uis/datetime/time','core/uis/directus_user_activity','core/uis/directus_user_avatar','core/uis/directus_file_size','core/uis/blob','core/uis/alias','core/uis/salt','core/uis/select','core/uis/tags','core/uis/many_to_one','core/uis/radiobuttons','core/uis/many_to_many','core/uis/one_to_many','core/uis/wysiwyg','core/uis/directus_messages_recipients','core/uis/password','core/uis/random','core/uis/many_to_one_typeahead','core/uis/enum','core/uis/multi_select','core/uis/system','core/uis/user','core/uis/directus_file','core/uis/directus_file_title','core/uis/map','core/uis/markdown','core/uis/multiple_files','core/uis/translation','core/uis/template_chooser','jquery','app'],function(require, exports, module) {

  

  // Register Core UI's
  var defaultUis = ([
    require('core/uis/textinput'),
    require('core/uis/directus_columns'),
    require('core/uis/instructions'),
    require('core/uis/checkbox/checkbox'),
    require('core/uis/color'),
    require('core/uis/countries/interface'),
    require('core/uis/numeric'),
    require('core/uis/slider'),
    require('core/uis/single_file'),
    require('core/uis/slug'),
    require('core/uis/textarea'),
    require('core/uis/directus_user'),
    require('core/uis/directus_activity'),
    require('core/uis/datetime/datetime'),
    require('core/uis/datetime/date'),
    require('core/uis/datetime/time'),
    require('core/uis/directus_user_activity'),
    require('core/uis/directus_user_avatar'),
    require('core/uis/directus_file_size'),
    require('core/uis/blob'),
    require('core/uis/alias'),
    require('core/uis/salt'),
    require('core/uis/select'),
    require('core/uis/tags'),
    require('core/uis/many_to_one'),
    require('core/uis/radiobuttons'),
    require('core/uis/many_to_many'),
    require('core/uis/one_to_many'),
    require('core/uis/wysiwyg'),
    require('core/uis/directus_messages_recipients'),
    require('core/uis/password'),
    require('core/uis/random'),
    require('core/uis/many_to_one_typeahead'),
    require('core/uis/enum'),
    require('core/uis/multi_select'),
    require('core/uis/system'),
    require('core/uis/user'),
    require('core/uis/directus_file'),
    require('core/uis/directus_file_title'),
    require('core/uis/map'),
    require('core/uis/markdown'),
    require('core/uis/multiple_files'),
    require('core/uis/translation'),
    require('core/uis/template_chooser')
  ]);

  var jQuery = require('jquery');
  /**
   * @private
   * Holds all UI's that are registered
   */
  var uis = {};

  var app = require('app');

  /**
   * @private
   * Holds all Sytem fields and mapped UI
   */
  var system_fields = {
  };

  var castType = function(type, value) {
    if (typeof value === 'undefined') {
      return value;
    }
    switch(type) {
      // '0', 0 and false should be false
      case 'Boolean': return false != value;
      case 'Number': return Number(value);
      case 'String': return String(value);
      default: return value;
    }
  };

  // Attach all methods to the UIManager prototype.
  module.exports = {

    validSections: ['list', 'value', 'sort'],

    setup: function() {
      //Register default UI's
      this.register(defaultUis);
      system_fields[app.statusMapping.status_name] = {'ui':'system'};
    },

    // Get reference to external UI file
    _getUI: function(uiId) {
      var ui = uis[uiId];

      if (ui === undefined) {
        console.warn('There is no registered UI with id "' + uiId + '"');
      }

      return ui;
    },

    _getAllUIs: function() {
      return uis;
    },

    // Returns a reference to a UI based on a
    // model/attribute/schema combination
    _getModelUI: function(model, attr, schema) {
      if (schema === undefined) {
        var structure = model.getStructure();
        schema = structure.get(attr);
      }
      if(schema === undefined) {
        throw "Cannot Find Schema for: '" + attr + "' Check Your Preferences!";
      }
      var uiId = schema.get('ui');

      if(system_fields[attr] !== undefined) {
        uiId = system_fields[attr].ui;
      }

      var UI = this._getUI(uiId);
      this.parseDefaultValue(UI, model, schema.options);

      return UI;
    },

    // Registers (@todo: one or) many UI's
    register: function(uiArray) {
      if (!_.isArray(uiArray)) {
        uiArray = [uiArray];
      }

      _.each(uiArray, function(ui) {
        try {
          var uiInstance = new ui();
          uis[uiInstance.id] = uiInstance;
        } catch (ex) {
          console.warn(ex.message);
        }
      },this);
    },

    // Get all the settings specified in the UI
    // Do not confused this with UI variables
    // UI Variables is used for each single UI
    // UI Settings is used to add new Settings to Directus
    getDirectusSettings: function() {
      var allUISettings = [];

      _.each(uis, function(ui) {
        if (ui.settings) {
          var settings = _.isArray(ui.settings) ? ui.settings : [ui.settings];
          _.each(settings, function(setting) {
            allUISettings.push(setting);
          });
        }
      });

      return allUISettings;
    },

    // Loads an array of paths to UI's and registers them.
    // Returns a jQuery Deferred's Promise object
    load: function(paths) {
      var self = this;
      var dfd = new jQuery.Deferred();

      require(paths, function() {
        self.register(_.values(arguments));
        dfd.resolve();
      });

      return dfd;
    },

    // Returns `true` if a UI with the provided ID exists
    hasUI: function(uiId) {
      return uis.hasOwnProperty(uiId);
    },

    // Returns all properties and settings of a UI with the provided ID
    getSettings: function(uiId) {
      var ui = this._getUI(uiId);

      var variablesDeepClone = JSON.parse(JSON.stringify(ui.variables || []));
      var sortbyDeepClone = JSON.parse(JSON.stringify(ui.sortBy || []));

      return {
        id: ui.id,
        skipSerializationIfNull: ui.skipSerializationIfNull || false,
        variables: variablesDeepClone,
        dataTypes: ui.dataTypes || [],
        system: ui.system || false,
        sortBy: sortbyDeepClone
      };
    },

    // Returns all properties and settings for all registered UI's
    getAllSettings: function(options) {
      options = options || {};


      var array = _.map(uis, function(ui) {
        return this.getSettings(ui.id);
      }, this);

      // Maps the settings to a key-value datastructure where
      // the key is the id of the UI.
      if (options.returnObject) {
        var obj = {};

        _.each(array, function(item) {
          obj[item.id] = item;
        });

       return obj;
      }

      return array;
    },

    hasList: function(model, attr) {
      return this.getList(model, attr, true);
    },

    hasValue: function(model, attr) {
      return this.getValue(model, attr, true);
    },

    hasSortValue: function(model, attr) {
      return this.getSortValue(model, attr) || this.getValue(model, attr);
    },

    getUIByModel: function(model, attr, defaultValue) {
      // @TODO: we need to make this getStructure available to our base model
      var structure;
      if (typeof model.getStructure === 'function') {
        structure = model.getStructure();
      } else {
        structure = this.structure || undefined;
      }
      var UI;
      if (structure !== undefined) {
        var schema = structure.get(attr);
        UI = schema ? this._getModelUI(model, attr, schema) : undefined;
      }

      if (typeof UI === 'undefined') {
        return false;
      }

      return {
        UI: UI,
        schema: schema
      };
    },

    // Finds the UI for the model/attribute and
    // returns a string containing the table view
    getUIValue: function(section, model, attr, noDefault) {
      var section = _.contains(this.validSections, section) ? section : 'list';
      var defaultValue = '<span class="secondary-info">--</span>';
      // Return true or false whether there's value or not (UI)
      // Instead of returning the default HTML
      // https://github.com/RNGR/Directus/issues/452
      var returnDefaultValue = true === noDefault ? true : false;

      var UIObject = this.getUIByModel(model, attr);
      // If there is no UI, return just text
      if (UIObject === false) {
        var attribute = model.get(attr);
        if (!attribute || attribute === "") {
          if (!defaultValue) {
            return false;
          }
          attribute = defaultValue;
        }
        return attribute;
      }

      var UIOptions = {
        model: model,
        collection: model.collection,
        settings: UIObject.schema.options,
        schema: UIObject.schema,
        value: model.get(attr),
        tagName: 'td'
      };

      // Section is the name of a method that represents an value.
      // list: represents the value that will be shown on a list.
      var section = UIObject.UI[section] !== null ? section : 'list';
      this.triggerBeforeValue(section, UIObject.UI, UIOptions);
      var value = UIObject.UI[section](UIOptions);
      this.triggerAfterValue(section, UIObject.UI, UIOptions);

      if ((!value || value === "") && returnDefaultValue) {
        value = defaultValue;
      }

      return value;
    },

    getSortValue: function(model, attr, noDefault) {
      return this.getUIValue('sort', model, attr, noDefault);
    },

    getValue: function(model, attr, defaultValue) {
      return this.getUIValue('value', model, attr, noDefault);
    },

    getList: function(model, attr, noDefault) {
      return this.getUIValue('list', model, attr, noDefault);
    },

    parseDefaultValue: function(UI, model, settings) {
      if (!_.isArray(UI.variables) || UI.variables.length <= 0) {
        return;
      }

      if (!settings.defaultAttributes) settings.defaultAttributes = {};
      if (!settings.attributeTypes) settings.attributeTypes = {};

      _.each(UI.variables, function(variable) {
        if (typeof variable.default_value !== 'undefined') {
          settings.defaultAttributes[variable.id] = variable.default_value;
        }
        settings.attributeTypes[variable.id] = variable.type;
      });

      settings.get = function(attr) {
        var attribute = this.attributes[attr];
        if (this.defaultAttributes && attribute === undefined) {
          var defaultAttribute = this.defaultAttributes[attr];
          // Falsy values are accepted as default values
          // excepted undefined (#1256)
          if (defaultAttribute !== undefined) {
            attribute = defaultAttribute;
          }
        }

        return castType(this.attributeTypes[attr], attribute);
      };
    },

    // Finds the UI for the provided model/attribute and
    // returns a backbone view instance containing the input view
    getInputInstance: function(model, attr, options) {
      options.model = model;
      options.name = attr;
      options.structure = options.structure || options.model.getStructure();
      options.schema = options.structure.get(options.name);
      options.value = options.model.get(options.name);
      options.collection = options.collection || options.model.collection;
      options.canWrite = typeof options.model.canEdit === 'function' ? options.model.canEdit(attr) : true;
      options.settings = options.schema.options;


      var UI = this._getModelUI(model, attr, options.schema);
      if (UI.Input === undefined) {
        throw new Error('The UI with id "' + UI.id + '" has no input view');
      }

      this.triggerBeforeCreateInput(UI, options);
      var view = new UI.Input(options);
      this.triggerAfterCreateInput(UI, options);

      return view;
    },

    // Finds the UI for the provided model/attribute and
    // and returns the result of the UI validation
    validate: function(model, attr, value) {
      var collection = model.collection;
      var structure = model.getStructure();
      var schema = structure.get(attr);
      var UI = this._getModelUI(model, attr, schema);

      if (UI.validate) {
        return UI.validate(value, {
          view: model.getInput ? model.getInput(attr) : undefined,
          model: model,
          collection: collection,
          settings: schema.options,
          schema: schema,
          tagName: 'td'
        });
      }
    },
    triggerEvent: function(eventName, UI, options) {
      var events = this.constructEventNames(eventName, UI, options);
      var args = Array.prototype.slice.call(arguments, 2);
      var appEvents = events.map(function(name) {
        return 'UI:'+name;
      });

      var UIArgs = [events.join(' '), UI].concat(args);
      var AppArgs = [appEvents.join(' '), UI].concat(args);

      UI.trigger.apply(UI, UIArgs);
      app.trigger.apply(app, AppArgs);
    },

    constructEventNames: function(eventName, UI, options) {
      var structure = options.structure || options.collection.structure;
      var appendNames = [
        '',
        ':'+UI.id
      ];

      if (structure.table && structure.table.id) {
        appendNames = appendNames.concat([
          ':'+structure.table.id+':'+UI.id,
          ':'+structure.table.id+':'+options.schema.id,
          ':'+structure.table.id+':'+options.schema.id+':'+UI.id
        ]);
      }

      return appendNames.map(function(name) {
        return eventName+name;
      });
    },

    triggerBeforeCreateInput: function(UI, options) {
      return this.triggerEvent('beforeCreateInput', UI, options);
    },

    triggerAfterCreateInput: function(UI, options) {
      return this.triggerEvent('afterCreateInput', UI, options);
    },

    triggerBeforeValue: function(section, UI, options) {
      this.triggerEvent('beforeValue', UI, options);
      this.triggerEvent('beforeValue:'+section, UI, options);
    },

    triggerAfterValue: function(section, UI, options) {
      this.triggerEvent('afterValue', UI, options);
      this.triggerEvent('afterValue:'+section, UI, options);
    },
  };

});

require([
  "app",
  "handlebars",
  "core/UIManager",
  'core/t',
  'moment'
], function(app, Handlebars, UIManager, __t, moment) {

  

  Handlebars.registerHelper('imagesPath', function() {
    return app.PATH + 'assets/img/';
  });

  Handlebars.registerHelper('t', function(key, options) {
    return __t(key, options.hash);
  });

  Handlebars.registerHelper('tCoreField', function(key, options) {
    if (options.hash.table) {
      var tableKey = options.hash.table+'_'+key;
      if (__t.polyglot.has(tableKey)) {
        key = tableKey;
      }
    }

    return app.capitalize(__t(key, options.hash));
  });

  Handlebars.registerHelper('tVarCapitalize', function(key, options) {
    for (var index in options.hash) {
      if (!options.hash.hasOwnProperty(index)) {
        continue;
      }

      options.hash[index] = app.capitalize(options.hash[index]);
    }

    return __t(key, options.hash);
  });

  //Raw handlebars data, helpful with data types
  Handlebars.registerHelper('raw', function(data) {
    return data && new Handlebars.SafeString(data);
  });

  Handlebars.registerHelper('number', function(number) {
    return number === undefined ? '' : number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  });

  Handlebars.registerHelper('resource', function(name) {
    return app.RESOURCES_URL + name;
  });

  Handlebars.registerHelper('capitalize', function(string) {
    return app.capitalize(string);
  });

  Handlebars.registerHelper('nl2br', function(string) {
    return (string + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + '<br>' + '$2');
  });

  Handlebars.registerHelper('uppercase', function(string) {
    return string.toUpperCase();
  });

  Handlebars.registerHelper('bytesToSize', function(bytes) {
    return app.bytesToSize(bytes, 0);
  });

  Handlebars.registerHelper('contextualDate', function(date) {
    if(date === undefined || date === null) {
      //throw new Error('The date is not in a correct date format');
      return '-';
    }
    //date = (date.substr(-1).toLowerCase() === 'z') ? date : date + 'z';
    return new Handlebars.SafeString('<div class="contextual-date" title="'+ new Date(date) +'">' + moment(date).fromNow() + '</div>');
  });

  Handlebars.registerHelper('formatDate', function(date, format) {
    return moment(date).format(format);
  });

  Handlebars.registerHelper('avatarSmall', function(userId) {
    var user = app.users.get(userId);
    return '<img src="' + user.getAvatar() + '" style="margin-right:7px;" class="avatar">' + user.get('first_name');
  });

  Handlebars.registerHelper('activeMap', function(model) {
    //@todo: how do we want to handle this stuff
    switch (model.get(app.statusMapping.status_name)) {
      case 0:
        return 'deleted';
      case 1:
        return 'active';
      case 2:
        return 'inactive';
    }
  });

  // Should be combined with userShort below with param: "show_avatar" [true,false]
  Handlebars.registerHelper('userName', function(userId) {
    if (_.isNaN(userId)) return;
    var user = app.users.get(userId);
    var firstName = user.get('first_name').toLowerCase();
    var lastNameFirstCharacter = user.get('last_name').toLowerCase().charAt(0);
    var nickName = firstName;
    var hit = app.users.find(function(model) {
      return model.get('first_name').toLowerCase() === firstName && model.id !== userId;
    });
    if (hit !== undefined) {
      nickName = firstName + ' ' + lastNameFirstCharacter + '.';
      hit = app.users.find(function(model) { return model.get('first_name').toLowerCase() === firstName && model.get('last_name').toLowerCase().charAt(0) === lastNameFirstCharacter && model.id !== userId; });
      if (hit !== undefined) {
        nickName = firstName + ' ' + user.get('last_name');
      }
    }
    return new Handlebars.SafeString(app.capitalize(nickName," "));
  });

  Handlebars.registerHelper('userShort', function(userId) {
    if (_.isNaN(userId)) return;
    var user = app.users.get(userId);
    var firstName = user.get('first_name').toLowerCase();
    var lastNameFirstCharacter = user.get('last_name').toLowerCase().charAt(0);
    var nickName = firstName;
    var hit = app.users.find(function(model) {
      return model.get('first_name').toLowerCase() === firstName && model.id !== userId;
    });
    if (hit !== undefined) {
      nickName = firstName + ' ' + lastNameFirstCharacter + '.';
      hit = app.users.find(function(model) { return model.get('first_name').toLowerCase() === firstName && model.get('last_name').toLowerCase().charAt(0) === lastNameFirstCharacter && model.id !== userId; });
      if (hit !== undefined) {
        nickName = firstName + ' ' + user.get('last_name');
      }
    }
    return new Handlebars.SafeString('<img src="'+user.getAvatar()+'" class="avatar"/>' + app.capitalize(nickName," "));
  });

  Handlebars.registerHelper('userAvatar', function(userId) {
    var user = app.users.get(userId);
    var avatar = user.getAvatar();

    return new Handlebars.SafeString('<img src="'+avatar+'" class="avatar" title="'+user.get('first_name')+' '+user.get('last_name')+'"/>');
  });

  Handlebars.registerHelper('userFull', function(userId) {
    var user = app.users.get(userId);
    return new Handlebars.SafeString('<img src="'+user.getAvatar()+'"  class="avatar"/><span class="avatar-name">'+user.get('first_name')+' '+user.get('last_name')+'</span>');
  });

  Handlebars.registerHelper('userFirstAndLastName', function(userId) {
    var user = app.users.get(userId);
    return new Handlebars.SafeString(user.get('first_name')+' '+user.get('last_name'));
  });

  Handlebars.registerHelper('directusTable', function(data) {

    if (data === undefined || !data.length) return;

    var headers = _.keys(data[0]);

    var headersTH = _.map(headers, function(header) { return '<th>' + app.capitalize(header, '_') + '</th>'; });

    var tHead = '<thead><tr>' + headersTH.join('') + '</tr></thead>';

    var tableRows = _.map(data, function(row) {
      //wrap values in td
      var values = _.values(row);
      var tds = _.map(values, function(value) { return '<td>' + value + '</td>'; });
      return '<tr>' + tds.join('') + '</tr>';
    });

    var tBody = '<tbody>' + tableRows.join('') + '</tbody>';

    var table = '<table class="table table-striped directus-table">' + tHead + tBody + '</table>';

    return new Handlebars.SafeString(table);
  });

  Handlebars.registerHelper('directusTable', function(data) {

    if (data === undefined || !data.length) return;

    var headers = _.keys(data[0]);

    var headersTH = _.map(headers, function(header) { return '<th>' + app.capitalize(header, '_') + '</th>'; });

    var tHead = '<thead><tr>' + headersTH.join('') + '</tr></thead>';

    var tableRows = _.map(data, function(row) {
      //wrap values in td
      var values = _.values(row);
      var tds = _.map(values, function(value) { return '<td>' + value + '</td>'; });
      return '<tr>' + tds.join('') + '</tr>';
    });

    var tBody = '<tbody>' + tableRows.join('') + '</tbody>';

    var table = '<table class="table table-striped directus-table">' + tHead + tBody + '</table>';

    return new Handlebars.SafeString(table);
  });

  Handlebars.registerHelper('directusSelect', function(data) {
    if (data === undefined) return;

    var name = data.name;
    data = data.options;

    var options = _.map(data, function(item) {
      var selected = item.selected ? 'selected' : '';
      return '<option value="' + item.name + '" ' + selected + '>' + item.title + '</option>';
    });

    var select = '<select id="' + name + '">' + options.join('') + '</select>';

    return new Handlebars.SafeString(select);
  });

  //Handlebars UI helper!
  Handlebars.registerHelper("ui", function(model, attr, options) {
    if (model.isNested) model = model.get('data');
    var html = UIManager.getList(model, attr) || '';
    return new Handlebars.SafeString(html);
  });

});

define("helpers", function(){});

//
// backbone.trackit - 0.1.0
// The MIT License
// Copyright (c) 2013 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com> 
//
!function(){var a=[],b=function(b){_.isEmpty(b._unsavedChanges)?a=_.filter(a,function(a){return b.cid!=a.cid}):_.findWhere(a,{cid:b.cid})||a.push(b)},c=function(b){var c,d=_.rest(arguments),e=function(a,b){return _.isBoolean(b)?b:(_.isString(b)?a[b]:b).apply(a,d)};return _.each(a,function(a){!c&&e(a,a._unsavedConfig[b])&&(c=a._unsavedConfig.prompt)}),c};Backbone.History.prototype.navigate=_.wrap(Backbone.History.prototype.navigate,function(a,b,d){var e=c("unloadRouterPrompt",b,d);e?confirm(e+" \n\nAre you sure you want to leave this page?")&&a.call(this,b,d):a.call(this,b,d)}),window.onbeforeunload=function(a){return c("unloadWindowPrompt",a)},_.extend(Backbone.Model.prototype,{unsaved:{},_trackingChanges:!1,_originalAttrs:{},_unsavedChanges:{},startTracking:function(){return this._unsavedConfig=_.extend({},{prompt:"You have unsaved changes!",unloadRouterPrompt:!1,unloadWindowPrompt:!1},this.unsaved||{}),this._trackingChanges=!0,this._resetTracking(),this._triggerUnsavedChanges(),this},stopTracking:function(){return this._trackingChanges=!1,this._originalAttrs={},this._unsavedChanges={},this._triggerUnsavedChanges(),this},restartTracking:function(){return this._resetTracking(),this._triggerUnsavedChanges(),this},resetAttributes:function(){return this._trackingChanges?(this.attributes=this._originalAttrs,this._resetTracking(),this._triggerUnsavedChanges(),this):void 0},unsavedAttributes:function(a){if(!a)return _.isEmpty(this._unsavedChanges)?!1:_.clone(this._unsavedChanges);var b,c=!1,d=this._unsavedChanges;for(var e in a)_.isEqual(d[e],b=a[e])||((c||(c={}))[e]=b);return c},_resetTracking:function(){this._originalAttrs=_.clone(this.attributes),this._unsavedChanges={}},_triggerUnsavedChanges:function(){this.trigger("unsavedChanges",!_.isEmpty(this._unsavedChanges),_.clone(this._unsavedChanges)),this.unsaved&&b(this)}}),Backbone.Model.prototype.set=_.wrap(Backbone.Model.prototype.set,function(a,b,c,d){var e,f;return null==b?this:("object"==typeof b?(e=b,d=c):(e={})[b]=c,d||(d={}),f=a.call(this,e,d),this._trackingChanges&&!d.silent&&(_.each(e,_.bind(function(a,b){_.isEqual(this._originalAttrs[b],a)?delete this._unsavedChanges[b]:this._unsavedChanges[b]=a},this)),this._triggerUnsavedChanges()),f)}),Backbone.sync=_.wrap(Backbone.sync,function(a,b,c,d){return d||(d={}),"update"==b&&(d.success=_.wrap(d.success,_.bind(function(a,b,d,e){var f;return a&&(f=a.call(this,b,d,e)),c._trackingChanges&&(c._resetTracking(),c._triggerUnsavedChanges()),f},this))),a(b,c,d)})}();
define("plugins/backbone.trackit", function(){});

/* ============================================================
 * bootstrap-dropdown.js v2.2.2
 * http://twitter.github.com/bootstrap/javascript.html#dropdowns
 * ============================================================
 * Copyright 2012 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ============================================================ */


!function ($) {

   // jshint ;_;


 /* DROPDOWN CLASS DEFINITION
  * ========================= */

  var toggle = '[data-toggle=dropdown]'
    , Dropdown = function (element) {
        var $el = $(element).on('click.dropdown.data-api', this.toggle)
        $('html').on('click.dropdown.data-api', function () {
          $el.parent().removeClass('open')
        })
      }

  Dropdown.prototype = {

    constructor: Dropdown

  , toggle: function (e) {
      var $this = $(this)
        , $parent
        , isActive

      if ($this.is('.disabled, :disabled')) return

      $parent = getParent($this)

      isActive = $parent.hasClass('open')

      clearMenus()

      if (!isActive) {
        $parent.toggleClass('open')
      }

      $this.focus()

      return false
    }

  , keydown: function (e) {
      var $this
        , $items
        , $active
        , $parent
        , isActive
        , index

      if (!/(38|40|27)/.test(e.keyCode)) return

      $this = $(this)

      e.preventDefault()
      e.stopPropagation()

      if ($this.is('.disabled, :disabled')) return

      $parent = getParent($this)

      isActive = $parent.hasClass('open')

      if (!isActive || (isActive && e.keyCode == 27)) return $this.click()

      $items = $('[role=menu] li:not(.divider):visible a', $parent)

      if (!$items.length) return

      index = $items.index($items.filter(':focus'))

      if (e.keyCode == 38 && index > 0) index--                                        // up
      if (e.keyCode == 40 && index < $items.length - 1) index++                        // down
      if (!~index) index = 0

      $items
        .eq(index)
        .focus()
    }

  }

  function clearMenus() {
    $(toggle).each(function () {
      getParent($(this)).removeClass('open')
    })
  }

  function getParent($this) {
    var selector = $this.attr('data-target')
      , $parent

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') //strip for ie7
    }

    $parent = $(selector)
    $parent.length || ($parent = $this.parent())

    return $parent
  }


  /* DROPDOWN PLUGIN DEFINITION
   * ========================== */

  var old = $.fn.dropdown

  $.fn.dropdown = function (option) {
    return this.each(function () {
      var $this = $(this)
        , data = $this.data('dropdown')
      if (!data) $this.data('dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  $.fn.dropdown.Constructor = Dropdown


 /* DROPDOWN NO CONFLICT
  * ==================== */

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  /* APPLY TO STANDARD DROPDOWN ELEMENTS
   * =================================== */

  $(document)
    .on('click.dropdown.data-api touchstart.dropdown.data-api', clearMenus)
    .on('click.dropdown touchstart.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('touchstart.dropdown.data-api', '.dropdown-menu', function (e) { e.stopPropagation() })
    .on('click.dropdown.data-api touchstart.dropdown.data-api'  , toggle, Dropdown.prototype.toggle)
    .on('keydown.dropdown.data-api touchstart.dropdown.data-api', toggle + ', [role=menu]' , Dropdown.prototype.keydown)

}(window.jQuery);
define("plugins/bootstrap-dropdown", function(){});

/*!
 * typeahead.js 0.10.2
 * https://github.com/twitter/typeahead.js
 * Copyright 2013-2014 Twitter, Inc. and other contributors; Licensed MIT
 */

!function(a){var b={isMsie:function(){return/(msie|trident)/i.test(navigator.userAgent)?navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2]:!1},isBlankString:function(a){return!a||/^\s*$/.test(a)},escapeRegExChars:function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},isString:function(a){return"string"==typeof a},isNumber:function(a){return"number"==typeof a},isArray:a.isArray,isFunction:a.isFunction,isObject:a.isPlainObject,isUndefined:function(a){return"undefined"==typeof a},bind:a.proxy,each:function(b,c){function d(a,b){return c(b,a)}a.each(b,d)},map:a.map,filter:a.grep,every:function(b,c){var d=!0;return b?(a.each(b,function(a,e){return(d=c.call(null,e,a,b))?void 0:!1}),!!d):d},some:function(b,c){var d=!1;return b?(a.each(b,function(a,e){return(d=c.call(null,e,a,b))?!1:void 0}),!!d):d},mixin:a.extend,getUniqueId:function(){var a=0;return function(){return a++}}(),templatify:function(b){function c(){return String(b)}return a.isFunction(b)?b:c},defer:function(a){setTimeout(a,0)},debounce:function(a,b,c){var d,e;return function(){var f,g,h=this,i=arguments;return f=function(){d=null,c||(e=a.apply(h,i))},g=c&&!d,clearTimeout(d),d=setTimeout(f,b),g&&(e=a.apply(h,i)),e}},throttle:function(a,b){var c,d,e,f,g,h;return g=0,h=function(){g=new Date,e=null,f=a.apply(c,d)},function(){var i=new Date,j=b-(i-g);return c=this,d=arguments,0>=j?(clearTimeout(e),e=null,g=i,f=a.apply(c,d)):e||(e=setTimeout(h,j)),f}},noop:function(){}},c="0.10.2",d=function(){function a(a){return a.split(/\s+/)}function b(a){return a.split(/\W+/)}function c(a){return function(b){return function(c){return a(c[b])}}}return{nonword:b,whitespace:a,obj:{nonword:c(b),whitespace:c(a)}}}(),e=function(){function a(a){this.maxSize=a||100,this.size=0,this.hash={},this.list=new c}function c(){this.head=this.tail=null}function d(a,b){this.key=a,this.val=b,this.prev=this.next=null}return b.mixin(a.prototype,{set:function(a,b){var c,e=this.list.tail;this.size>=this.maxSize&&(this.list.remove(e),delete this.hash[e.key]),(c=this.hash[a])?(c.val=b,this.list.moveToFront(c)):(c=new d(a,b),this.list.add(c),this.hash[a]=c,this.size++)},get:function(a){var b=this.hash[a];return b?(this.list.moveToFront(b),b.val):void 0}}),b.mixin(c.prototype,{add:function(a){this.head&&(a.next=this.head,this.head.prev=a),this.head=a,this.tail=this.tail||a},remove:function(a){a.prev?a.prev.next=a.next:this.head=a.next,a.next?a.next.prev=a.prev:this.tail=a.prev},moveToFront:function(a){this.remove(a),this.add(a)}}),a}(),f=function(){function a(a){this.prefix=["__",a,"__"].join(""),this.ttlKey="__ttl__",this.keyMatcher=new RegExp("^"+this.prefix)}function c(){return(new Date).getTime()}function d(a){return JSON.stringify(b.isUndefined(a)?null:a)}function e(a){return JSON.parse(a)}var f,g;try{f=window.localStorage,f.setItem("~~~","!"),f.removeItem("~~~")}catch(h){f=null}return g=f&&window.JSON?{_prefix:function(a){return this.prefix+a},_ttlKey:function(a){return this._prefix(a)+this.ttlKey},get:function(a){return this.isExpired(a)&&this.remove(a),e(f.getItem(this._prefix(a)))},set:function(a,e,g){return b.isNumber(g)?f.setItem(this._ttlKey(a),d(c()+g)):f.removeItem(this._ttlKey(a)),f.setItem(this._prefix(a),d(e))},remove:function(a){return f.removeItem(this._ttlKey(a)),f.removeItem(this._prefix(a)),this},clear:function(){var a,b,c=[],d=f.length;for(a=0;d>a;a++)(b=f.key(a)).match(this.keyMatcher)&&c.push(b.replace(this.keyMatcher,""));for(a=c.length;a--;)this.remove(c[a]);return this},isExpired:function(a){var d=e(f.getItem(this._ttlKey(a)));return b.isNumber(d)&&c()>d?!0:!1}}:{get:b.noop,set:b.noop,remove:b.noop,clear:b.noop,isExpired:b.noop},b.mixin(a.prototype,g),a}(),g=function(){function c(b){b=b||{},this._send=b.transport?d(b.transport):a.ajax,this._get=b.rateLimiter?b.rateLimiter(this._get):this._get}function d(c){return function(d,e){function f(a){b.defer(function(){h.resolve(a)})}function g(a){b.defer(function(){h.reject(a)})}var h=a.Deferred();return c(d,e,f,g),h}}var f=0,g={},h=6,i=new e(10);return c.setMaxPendingRequests=function(a){h=a},c.resetCache=function(){i=new e(10)},b.mixin(c.prototype,{_get:function(a,b,c){function d(b){c&&c(null,b),i.set(a,b)}function e(){c&&c(!0)}function j(){f--,delete g[a],l.onDeckRequestArgs&&(l._get.apply(l,l.onDeckRequestArgs),l.onDeckRequestArgs=null)}var k,l=this;(k=g[a])?k.done(d).fail(e):h>f?(f++,g[a]=this._send(a,b).done(d).fail(e).always(j)):this.onDeckRequestArgs=[].slice.call(arguments,0)},get:function(a,c,d){var e;return b.isFunction(c)&&(d=c,c={}),(e=i.get(a))?b.defer(function(){d&&d(null,e)}):this._get(a,c,d),!!e}}),c}(),h=function(){function c(b){b=b||{},b.datumTokenizer&&b.queryTokenizer||a.error("datumTokenizer and queryTokenizer are both required"),this.datumTokenizer=b.datumTokenizer,this.queryTokenizer=b.queryTokenizer,this.reset()}function d(a){return a=b.filter(a,function(a){return!!a}),a=b.map(a,function(a){return a.toLowerCase()})}function e(){return{ids:[],children:{}}}function f(a){for(var b={},c=[],d=0;d<a.length;d++)b[a[d]]||(b[a[d]]=!0,c.push(a[d]));return c}function g(a,b){function c(a,b){return a-b}var d=0,e=0,f=[];for(a=a.sort(c),b=b.sort(c);d<a.length&&e<b.length;)a[d]<b[e]?d++:a[d]>b[e]?e++:(f.push(a[d]),d++,e++);return f}return b.mixin(c.prototype,{bootstrap:function(a){this.datums=a.datums,this.trie=a.trie},add:function(a){var c=this;a=b.isArray(a)?a:[a],b.each(a,function(a){var f,g;f=c.datums.push(a)-1,g=d(c.datumTokenizer(a)),b.each(g,function(a){var b,d,g;for(b=c.trie,d=a.split("");g=d.shift();)b=b.children[g]||(b.children[g]=e()),b.ids.push(f)})})},get:function(a){var c,e,h=this;return c=d(this.queryTokenizer(a)),b.each(c,function(a){var b,c,d,f;if(e&&0===e.length)return!1;for(b=h.trie,c=a.split("");b&&(d=c.shift());)b=b.children[d];return b&&0===c.length?(f=b.ids.slice(0),void(e=e?g(e,f):f)):(e=[],!1)}),e?b.map(f(e),function(a){return h.datums[a]}):[]},reset:function(){this.datums=[],this.trie=e()},serialize:function(){return{datums:this.datums,trie:this.trie}}}),c}(),i=function(){function d(a){return a.local||null}function e(d){var e,f;return f={url:null,thumbprint:"",ttl:864e5,filter:null,ajax:{}},(e=d.prefetch||null)&&(e=b.isString(e)?{url:e}:e,e=b.mixin(f,e),e.thumbprint=c+e.thumbprint,e.ajax.type=e.ajax.type||"GET",e.ajax.dataType=e.ajax.dataType||"json",!e.url&&a.error("prefetch requires url to be set")),e}function f(c){function d(a){return function(c){return b.debounce(c,a)}}function e(a){return function(c){return b.throttle(c,a)}}var f,g;return g={url:null,wildcard:"%QUERY",replace:null,rateLimitBy:"debounce",rateLimitWait:300,send:null,filter:null,ajax:{}},(f=c.remote||null)&&(f=b.isString(f)?{url:f}:f,f=b.mixin(g,f),f.rateLimiter=/^throttle$/i.test(f.rateLimitBy)?e(f.rateLimitWait):d(f.rateLimitWait),f.ajax.type=f.ajax.type||"GET",f.ajax.dataType=f.ajax.dataType||"json",delete f.rateLimitBy,delete f.rateLimitWait,!f.url&&a.error("remote requires url to be set")),f}return{local:d,prefetch:e,remote:f}}();!function(c){function e(b){b&&(b.local||b.prefetch||b.remote)||a.error("one of local, prefetch, or remote is required"),this.limit=b.limit||5,this.sorter=j(b.sorter),this.dupDetector=b.dupDetector||k,this.local=i.local(b),this.prefetch=i.prefetch(b),this.remote=i.remote(b),this.cacheKey=this.prefetch?this.prefetch.cacheKey||this.prefetch.url:null,this.index=new h({datumTokenizer:b.datumTokenizer,queryTokenizer:b.queryTokenizer}),this.storage=this.cacheKey?new f(this.cacheKey):null}function j(a){function c(b){return b.sort(a)}function d(a){return a}return b.isFunction(a)?c:d}function k(){return!1}var l,m;return l=c.Bloodhound,m={data:"data",protocol:"protocol",thumbprint:"thumbprint"},c.Bloodhound=e,e.noConflict=function(){return c.Bloodhound=l,e},e.tokenizers=d,b.mixin(e.prototype,{_loadPrefetch:function(b){function c(a){f.clear(),f.add(b.filter?b.filter(a):a),f._saveToStorage(f.index.serialize(),b.thumbprint,b.ttl)}var d,e,f=this;return(d=this._readFromStorage(b.thumbprint))?(this.index.bootstrap(d),e=a.Deferred().resolve()):e=a.ajax(b.url,b.ajax).done(c),e},_getFromRemote:function(a,b){function c(a,c){b(a?[]:f.remote.filter?f.remote.filter(c):c)}var d,e,f=this;return a=a||"",e=encodeURIComponent(a),d=this.remote.replace?this.remote.replace(this.remote.url,a):this.remote.url.replace(this.remote.wildcard,e),this.transport.get(d,this.remote.ajax,c)},_saveToStorage:function(a,b,c){this.storage&&(this.storage.set(m.data,a,c),this.storage.set(m.protocol,location.protocol,c),this.storage.set(m.thumbprint,b,c))},_readFromStorage:function(a){var b,c={};return this.storage&&(c.data=this.storage.get(m.data),c.protocol=this.storage.get(m.protocol),c.thumbprint=this.storage.get(m.thumbprint)),b=c.thumbprint!==a||c.protocol!==location.protocol,c.data&&!b?c.data:null},_initialize:function(){function c(){e.add(b.isFunction(f)?f():f)}var d,e=this,f=this.local;return d=this.prefetch?this._loadPrefetch(this.prefetch):a.Deferred().resolve(),f&&d.done(c),this.transport=this.remote?new g(this.remote):null,this.initPromise=d.promise()},initialize:function(a){return!this.initPromise||a?this._initialize():this.initPromise},add:function(a){this.index.add(a)},get:function(a,c){function d(a){var d=f.slice(0);b.each(a,function(a){var c;return c=b.some(d,function(b){return e.dupDetector(a,b)}),!c&&d.push(a),d.length<e.limit}),c&&c(e.sorter(d))}var e=this,f=[],g=!1;f=this.index.get(a),f=this.sorter(f).slice(0,this.limit),f.length<this.limit&&this.transport&&(g=this._getFromRemote(a,d)),g||(f.length>0||!this.transport)&&c&&c(f)},clear:function(){this.index.reset()},clearPrefetchCache:function(){this.storage&&this.storage.clear()},clearRemoteCache:function(){this.transport&&g.resetCache()},ttAdapter:function(){return b.bind(this.get,this)}}),e}(this);var j={wrapper:'<span class="twitter-typeahead"></span>',dropdown:'<span class="tt-dropdown-menu"></span>',dataset:'<div class="tt-dataset-%CLASS%"></div>',suggestions:'<span class="tt-suggestions"></span>',suggestion:'<div class="tt-suggestion"></div>'},k={wrapper:{position:"relative",display:"inline-block"},hint:{position:"absolute",top:"0",left:"0",borderColor:"transparent",boxShadow:"none"},input:{position:"relative",verticalAlign:"top",backgroundColor:"transparent"},inputWithNoHint:{position:"relative",verticalAlign:"top"},dropdown:{position:"absolute",top:"100%",left:"0",zIndex:"100",display:"none"},suggestions:{display:"block"},suggestion:{whiteSpace:"nowrap",cursor:"pointer"},suggestionChild:{whiteSpace:"normal"},ltr:{left:"0",right:"auto"},rtl:{left:"auto",right:" 0"}};b.isMsie()&&b.mixin(k.input,{backgroundImage:"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"}),b.isMsie()&&b.isMsie()<=7&&b.mixin(k.input,{marginTop:"-1px"});var l=function(){function c(b){b&&b.el||a.error("EventBus initialized without el"),this.$el=a(b.el)}var d="typeahead:";return b.mixin(c.prototype,{trigger:function(a){var b=[].slice.call(arguments,1);this.$el.trigger(d+a,b)}}),c}(),m=function(){function a(a,b,c,d){var e;if(!c)return this;for(b=b.split(i),c=d?h(c,d):c,this._callbacks=this._callbacks||{};e=b.shift();)this._callbacks[e]=this._callbacks[e]||{sync:[],async:[]},this._callbacks[e][a].push(c);return this}function b(b,c,d){return a.call(this,"async",b,c,d)}function c(b,c,d){return a.call(this,"sync",b,c,d)}function d(a){var b;if(!this._callbacks)return this;for(a=a.split(i);b=a.shift();)delete this._callbacks[b];return this}function e(a){var b,c,d,e,g;if(!this._callbacks)return this;for(a=a.split(i),d=[].slice.call(arguments,1);(b=a.shift())&&(c=this._callbacks[b]);)e=f(c.sync,this,[b].concat(d)),g=f(c.async,this,[b].concat(d)),e()&&j(g);return this}function f(a,b,c){function d(){for(var d,e=0;!d&&e<a.length;e+=1)d=a[e].apply(b,c)===!1;return!d}return d}function g(){var a;return a=window.setImmediate?function(a){setImmediate(function(){a()})}:function(a){setTimeout(function(){a()},0)}}function h(a,b){return a.bind?a.bind(b):function(){a.apply(b,[].slice.call(arguments,0))}}var i=/\s+/,j=g();return{onSync:c,onAsync:b,off:d,trigger:e}}(),n=function(a){function c(a,c,d){for(var e,f=[],g=0;g<a.length;g++)f.push(b.escapeRegExChars(a[g]));return e=d?"\\b("+f.join("|")+")\\b":"("+f.join("|")+")",c?new RegExp(e):new RegExp(e,"i")}var d={node:null,pattern:null,tagName:"strong",className:null,wordsOnly:!1,caseSensitive:!1};return function(e){function f(b){var c,d;return(c=h.exec(b.data))&&(wrapperNode=a.createElement(e.tagName),e.className&&(wrapperNode.className=e.className),d=b.splitText(c.index),d.splitText(c[0].length),wrapperNode.appendChild(d.cloneNode(!0)),b.parentNode.replaceChild(wrapperNode,d)),!!c}function g(a,b){for(var c,d=3,e=0;e<a.childNodes.length;e++)c=a.childNodes[e],c.nodeType===d?e+=b(c)?1:0:g(c,b)}var h;e=b.mixin({},d,e),e.node&&e.pattern&&(e.pattern=b.isArray(e.pattern)?e.pattern:[e.pattern],h=c(e.pattern,e.caseSensitive,e.wordsOnly),g(e.node,f))}}(window.document),o=function(){function c(c){var e,f,h,i,j=this;c=c||{},c.input||a.error("input is missing"),e=b.bind(this._onBlur,this),f=b.bind(this._onFocus,this),h=b.bind(this._onKeydown,this),i=b.bind(this._onInput,this),this.$hint=a(c.hint),this.$input=a(c.input).on("blur.tt",e).on("focus.tt",f).on("keydown.tt",h),0===this.$hint.length&&(this.setHint=this.getHint=this.clearHint=this.clearHintIfInvalid=b.noop),b.isMsie()?this.$input.on("keydown.tt keypress.tt cut.tt paste.tt",function(a){g[a.which||a.keyCode]||b.defer(b.bind(j._onInput,j,a))}):this.$input.on("input.tt",i),this.query=this.$input.val(),this.$overflowHelper=d(this.$input)}function d(b){return a('<pre aria-hidden="true"></pre>').css({position:"absolute",visibility:"hidden",whiteSpace:"pre",fontFamily:b.css("font-family"),fontSize:b.css("font-size"),fontStyle:b.css("font-style"),fontVariant:b.css("font-variant"),fontWeight:b.css("font-weight"),wordSpacing:b.css("word-spacing"),letterSpacing:b.css("letter-spacing"),textIndent:b.css("text-indent"),textRendering:b.css("text-rendering"),textTransform:b.css("text-transform")}).insertAfter(b)}function e(a,b){return c.normalizeQuery(a)===c.normalizeQuery(b)}function f(a){return a.altKey||a.ctrlKey||a.metaKey||a.shiftKey}var g;return g={9:"tab",27:"esc",37:"left",39:"right",13:"enter",38:"up",40:"down"},c.normalizeQuery=function(a){return(a||"").replace(/^\s*/g,"").replace(/\s{2,}/g," ")},b.mixin(c.prototype,m,{_onBlur:function(){this.resetInputValue(),this.trigger("blurred")},_onFocus:function(){this.trigger("focused")},_onKeydown:function(a){var b=g[a.which||a.keyCode];this._managePreventDefault(b,a),b&&this._shouldTrigger(b,a)&&this.trigger(b+"Keyed",a)},_onInput:function(){this._checkInputValue()},_managePreventDefault:function(a,b){var c,d,e;switch(a){case"tab":d=this.getHint(),e=this.getInputValue(),c=d&&d!==e&&!f(b);break;case"up":case"down":c=!f(b);break;default:c=!1}c&&b.preventDefault()},_shouldTrigger:function(a,b){var c;switch(a){case"tab":c=!f(b);break;default:c=!0}return c},_checkInputValue:function(){var a,b,c;a=this.getInputValue(),b=e(a,this.query),c=b?this.query.length!==a.length:!1,b?c&&this.trigger("whitespaceChanged",this.query):this.trigger("queryChanged",this.query=a)},focus:function(){this.$input.focus()},blur:function(){this.$input.blur()},getQuery:function(){return this.query},setQuery:function(a){this.query=a},getInputValue:function(){return this.$input.val()},setInputValue:function(a,b){this.$input.val(a),b?this.clearHint():this._checkInputValue()},resetInputValue:function(){this.setInputValue(this.query,!0)},getHint:function(){return this.$hint.val()},setHint:function(a){this.$hint.val(a)},clearHint:function(){this.setHint("")},clearHintIfInvalid:function(){var a,b,c,d;a=this.getInputValue(),b=this.getHint(),c=a!==b&&0===b.indexOf(a),d=""!==a&&c&&!this.hasOverflow(),!d&&this.clearHint()},getLanguageDirection:function(){return(this.$input.css("direction")||"ltr").toLowerCase()},hasOverflow:function(){var a=this.$input.width()-2;return this.$overflowHelper.text(this.getInputValue()),this.$overflowHelper.width()>=a},isCursorAtEnd:function(){var a,c,d;return a=this.$input.val().length,c=this.$input[0].selectionStart,b.isNumber(c)?c===a:document.selection?(d=document.selection.createRange(),d.moveStart("character",-a),a===d.text.length):!0},destroy:function(){this.$hint.off(".tt"),this.$input.off(".tt"),this.$hint=this.$input=this.$overflowHelper=null}}),c}(),p=function(){function c(c){c=c||{},c.templates=c.templates||{},c.source||a.error("missing source"),c.name&&!f(c.name)&&a.error("invalid dataset name: "+c.name),this.query=null,this.highlight=!!c.highlight,this.name=c.name||b.getUniqueId(),this.source=c.source,this.displayFn=d(c.display||c.displayKey),this.templates=e(c.templates,this.displayFn),this.$el=a(j.dataset.replace("%CLASS%",this.name))}function d(a){function c(b){return b[a]}return a=a||"value",b.isFunction(a)?a:c}function e(a,c){function d(a){return"<p>"+c(a)+"</p>"}return{empty:a.empty&&b.templatify(a.empty),header:a.header&&b.templatify(a.header),footer:a.footer&&b.templatify(a.footer),suggestion:a.suggestion||d}}function f(a){return/^[_a-zA-Z0-9-]+$/.test(a)}var g="ttDataset",h="ttValue",i="ttDatum";return c.extractDatasetName=function(b){return a(b).data(g)},c.extractValue=function(b){return a(b).data(h)},c.extractDatum=function(b){return a(b).data(i)},b.mixin(c.prototype,m,{_render:function(c,d){function e(){return p.templates.empty({query:c,isEmpty:!0})}function f(){function e(b){var c;return c=a(j.suggestion).append(p.templates.suggestion(b)).data(g,p.name).data(h,p.displayFn(b)).data(i,b),c.children().each(function(){a(this).css(k.suggestionChild)}),c}var f,l;return f=a(j.suggestions).css(k.suggestions),l=b.map(d,e),f.append.apply(f,l),p.highlight&&n({node:f[0],pattern:c}),f}function l(){return p.templates.header({query:c,isEmpty:!o})}function m(){return p.templates.footer({query:c,isEmpty:!o})}if(this.$el){var o,p=this;this.$el.empty(),o=d&&d.length,!o&&this.templates.empty?this.$el.html(e()).prepend(p.templates.header?l():null).append(p.templates.footer?m():null):o&&this.$el.html(f()).prepend(p.templates.header?l():null).append(p.templates.footer?m():null),this.trigger("rendered")}},getRoot:function(){return this.$el},update:function(a){function b(b){c.canceled||a!==c.query||c._render(a,b)}var c=this;this.query=a,this.canceled=!1,this.source(a,b)},cancel:function(){this.canceled=!0},clear:function(){this.cancel(),this.$el.empty(),this.trigger("rendered")},isEmpty:function(){return this.$el.is(":empty")},destroy:function(){this.$el=null}}),c}(),q=function(){function c(c){var e,f,g,h=this;c=c||{},c.menu||a.error("menu is required"),this.isOpen=!1,this.isEmpty=!0,this.datasets=b.map(c.datasets,d),e=b.bind(this._onSuggestionClick,this),f=b.bind(this._onSuggestionMouseEnter,this),g=b.bind(this._onSuggestionMouseLeave,this),this.$menu=a(c.menu).on("click.tt",".tt-suggestion",e).on("mouseenter.tt",".tt-suggestion",f).on("mouseleave.tt",".tt-suggestion",g),b.each(this.datasets,function(a){h.$menu.append(a.getRoot()),a.onSync("rendered",h._onRendered,h)})}function d(a){return new p(a)}return b.mixin(c.prototype,m,{_onSuggestionClick:function(b){this.trigger("suggestionClicked",a(b.currentTarget))},_onSuggestionMouseEnter:function(b){this._removeCursor(),this._setCursor(a(b.currentTarget),!0)},_onSuggestionMouseLeave:function(){this._removeCursor()},_onRendered:function(){function a(a){return a.isEmpty()}this.isEmpty=b.every(this.datasets,a),this.isEmpty?this._hide():this.isOpen&&this._show(),this.trigger("datasetRendered")},_hide:function(){this.$menu.hide()},_show:function(){this.$menu.css("display","block")},_getSuggestions:function(){return this.$menu.find(".tt-suggestion")},_getCursor:function(){return this.$menu.find(".tt-cursor").first()},_setCursor:function(a,b){a.first().addClass("tt-cursor"),!b&&this.trigger("cursorMoved")},_removeCursor:function(){this._getCursor().removeClass("tt-cursor")},_moveCursor:function(a){var b,c,d,e;if(this.isOpen){if(c=this._getCursor(),b=this._getSuggestions(),this._removeCursor(),d=b.index(c)+a,d=(d+1)%(b.length+1)-1,-1===d)return void this.trigger("cursorRemoved");-1>d&&(d=b.length-1),this._setCursor(e=b.eq(d)),this._ensureVisible(e)}},_ensureVisible:function(a){var b,c,d,e;b=a.position().top,c=b+a.outerHeight(!0),d=this.$menu.scrollTop(),e=this.$menu.height()+parseInt(this.$menu.css("paddingTop"),10)+parseInt(this.$menu.css("paddingBottom"),10),0>b?this.$menu.scrollTop(d+b):c>e&&this.$menu.scrollTop(d+(c-e))},close:function(){this.isOpen&&(this.isOpen=!1,this._removeCursor(),this._hide(),this.trigger("closed"))},open:function(){this.isOpen||(this.isOpen=!0,!this.isEmpty&&this._show(),this.trigger("opened"))},setLanguageDirection:function(a){this.$menu.css("ltr"===a?k.ltr:k.rtl)},moveCursorUp:function(){this._moveCursor(-1)},moveCursorDown:function(){this._moveCursor(1)},getDatumForSuggestion:function(a){var b=null;return a.length&&(b={raw:p.extractDatum(a),value:p.extractValue(a),datasetName:p.extractDatasetName(a)}),b},getDatumForCursor:function(){return this.getDatumForSuggestion(this._getCursor().first())},getDatumForTopSuggestion:function(){return this.getDatumForSuggestion(this._getSuggestions().first())},update:function(a){function c(b){b.update(a)}b.each(this.datasets,c)},empty:function(){function a(a){a.clear()}b.each(this.datasets,a),this.isEmpty=!0},isVisible:function(){return this.isOpen&&!this.isEmpty},destroy:function(){function a(a){a.destroy()}this.$menu.off(".tt"),this.$menu=null,b.each(this.datasets,a)}}),c}(),r=function(){function c(c){var e,f,g;c=c||{},c.input||a.error("missing input"),this.isActivated=!1,this.autoselect=!!c.autoselect,this.minLength=b.isNumber(c.minLength)?c.minLength:1,this.$node=d(c.input,c.withHint),e=this.$node.find(".tt-dropdown-menu"),f=this.$node.find(".tt-input"),g=this.$node.find(".tt-hint"),f.on("blur.tt",function(a){var c,d,g;c=document.activeElement,d=e.is(c),g=e.has(c).length>0,b.isMsie()&&(d||g)&&(a.preventDefault(),a.stopImmediatePropagation(),b.defer(function(){f.focus()}))}),e.on("mousedown.tt",function(a){a.preventDefault()}),this.eventBus=c.eventBus||new l({el:f}),this.dropdown=new q({menu:e,datasets:c.datasets}).onSync("suggestionClicked",this._onSuggestionClicked,this).onSync("cursorMoved",this._onCursorMoved,this).onSync("cursorRemoved",this._onCursorRemoved,this).onSync("opened",this._onOpened,this).onSync("closed",this._onClosed,this).onAsync("datasetRendered",this._onDatasetRendered,this),this.input=new o({input:f,hint:g}).onSync("focused",this._onFocused,this).onSync("blurred",this._onBlurred,this).onSync("enterKeyed",this._onEnterKeyed,this).onSync("tabKeyed",this._onTabKeyed,this).onSync("escKeyed",this._onEscKeyed,this).onSync("upKeyed",this._onUpKeyed,this).onSync("downKeyed",this._onDownKeyed,this).onSync("leftKeyed",this._onLeftKeyed,this).onSync("rightKeyed",this._onRightKeyed,this).onSync("queryChanged",this._onQueryChanged,this).onSync("whitespaceChanged",this._onWhitespaceChanged,this),this._setLanguageDirection()}function d(b,c){var d,f,h,i;d=a(b),f=a(j.wrapper).css(k.wrapper),h=a(j.dropdown).css(k.dropdown),i=d.clone().css(k.hint).css(e(d)),i.val("").removeData().addClass("tt-hint").removeAttr("id name placeholder").prop("disabled",!0).attr({autocomplete:"off",spellcheck:"false"}),d.data(g,{dir:d.attr("dir"),autocomplete:d.attr("autocomplete"),spellcheck:d.attr("spellcheck"),style:d.attr("style")}),d.addClass("tt-input").attr({autocomplete:"off",spellcheck:!1}).css(c?k.input:k.inputWithNoHint);try{!d.attr("dir")&&d.attr("dir","auto")}catch(l){}return d.wrap(f).parent().prepend(c?i:null).append(h)}function e(a){return{backgroundAttachment:a.css("background-attachment"),backgroundClip:a.css("background-clip"),backgroundColor:a.css("background-color"),backgroundImage:a.css("background-image"),backgroundOrigin:a.css("background-origin"),backgroundPosition:a.css("background-position"),backgroundRepeat:a.css("background-repeat"),backgroundSize:a.css("background-size")}}function f(a){var c=a.find(".tt-input");b.each(c.data(g),function(a,d){b.isUndefined(a)?c.removeAttr(d):c.attr(d,a)}),c.detach().removeData(g).removeClass("tt-input").insertAfter(a),a.remove()}var g="ttAttrs";return b.mixin(c.prototype,{_onSuggestionClicked:function(a,b){var c;(c=this.dropdown.getDatumForSuggestion(b))&&this._select(c)},_onCursorMoved:function(){var a=this.dropdown.getDatumForCursor();this.input.setInputValue(a.value,!0),this.eventBus.trigger("cursorchanged",a.raw,a.datasetName)},_onCursorRemoved:function(){this.input.resetInputValue(),this._updateHint()},_onDatasetRendered:function(){this._updateHint()},_onOpened:function(){this._updateHint(),this.eventBus.trigger("opened")},_onClosed:function(){this.input.clearHint(),this.eventBus.trigger("closed")},_onFocused:function(){this.isActivated=!0,this.dropdown.open()},_onBlurred:function(){this.isActivated=!1,this.dropdown.empty(),this.dropdown.close()},_onEnterKeyed:function(a,b){var c,d;c=this.dropdown.getDatumForCursor(),d=this.dropdown.getDatumForTopSuggestion(),c?(this._select(c),b.preventDefault()):this.autoselect&&d&&(this._select(d),b.preventDefault())},_onTabKeyed:function(a,b){var c;(c=this.dropdown.getDatumForCursor())?(this._select(c),b.preventDefault()):this._autocomplete(!0)},_onEscKeyed:function(){this.dropdown.close(),this.input.resetInputValue()},_onUpKeyed:function(){var a=this.input.getQuery();this.dropdown.isEmpty&&a.length>=this.minLength?this.dropdown.update(a):this.dropdown.moveCursorUp(),this.dropdown.open()},_onDownKeyed:function(){var a=this.input.getQuery();this.dropdown.isEmpty&&a.length>=this.minLength?this.dropdown.update(a):this.dropdown.moveCursorDown(),this.dropdown.open()},_onLeftKeyed:function(){"rtl"===this.dir&&this._autocomplete()},_onRightKeyed:function(){"ltr"===this.dir&&this._autocomplete()},_onQueryChanged:function(a,b){this.input.clearHintIfInvalid(),b.length>=this.minLength?this.dropdown.update(b):this.dropdown.empty(),this.dropdown.open(),this._setLanguageDirection()},_onWhitespaceChanged:function(){this._updateHint(),this.dropdown.open()},_setLanguageDirection:function(){var a;this.dir!==(a=this.input.getLanguageDirection())&&(this.dir=a,this.$node.css("direction",a),this.dropdown.setLanguageDirection(a))},_updateHint:function(){var a,c,d,e,f,g;a=this.dropdown.getDatumForTopSuggestion(),a&&this.dropdown.isVisible()&&!this.input.hasOverflow()?(c=this.input.getInputValue(),d=o.normalizeQuery(c),e=b.escapeRegExChars(d),f=new RegExp("^(?:"+e+")(.+$)","i"),g=f.exec(a.value),g?this.input.setHint(c+g[1]):this.input.clearHint()):this.input.clearHint()},_autocomplete:function(a){var b,c,d,e;b=this.input.getHint(),c=this.input.getQuery(),d=a||this.input.isCursorAtEnd(),b&&c!==b&&d&&(e=this.dropdown.getDatumForTopSuggestion(),e&&this.input.setInputValue(e.value),this.eventBus.trigger("autocompleted",e.raw,e.datasetName))},_select:function(a){this.input.setQuery(a.value),this.input.setInputValue(a.value,!0),this._setLanguageDirection(),this.eventBus.trigger("selected",a.raw,a.datasetName),this.dropdown.close(),b.defer(b.bind(this.dropdown.empty,this.dropdown))},open:function(){this.dropdown.open()},close:function(){this.dropdown.close()},setVal:function(a){this.isActivated?this.input.setInputValue(a):(this.input.setQuery(a),this.input.setInputValue(a,!0)),this._setLanguageDirection()},getVal:function(){return this.input.getQuery()},destroy:function(){this.input.destroy(),this.dropdown.destroy(),f(this.$node),this.$node=null}}),c}();!function(){var c,d,e;c=a.fn.typeahead,d="ttTypeahead",e={initialize:function(c,e){function f(){var f,g,h=a(this);b.each(e,function(a){a.highlight=!!c.highlight}),g=new r({input:h,eventBus:f=new l({el:h}),withHint:b.isUndefined(c.hint)?!0:!!c.hint,minLength:c.minLength,autoselect:c.autoselect,datasets:e}),h.data(d,g)}return e=b.isArray(e)?e:[].slice.call(arguments,1),c=c||{},this.each(f)},open:function(){function b(){var b,c=a(this);(b=c.data(d))&&b.open()}return this.each(b)},close:function(){function b(){var b,c=a(this);(b=c.data(d))&&b.close()}return this.each(b)},val:function(b){function c(){var c,e=a(this);(c=e.data(d))&&c.setVal(b)}function e(a){var b,c;return(b=a.data(d))&&(c=b.getVal()),c}return arguments.length?this.each(c):e(this.first())},destroy:function(){function b(){var b,c=a(this);(b=c.data(d))&&(b.destroy(),c.removeData(d))}return this.each(b)}},a.fn.typeahead=function(a){return e[a]?e[a].apply(this,[].slice.call(arguments,1)):e.initialize.apply(this,arguments)},a.fn.typeahead.noConflict=function(){return a.fn.typeahead=c,this}}()}(window.jQuery);
define("plugins/typeahead", function(){});

define('app',['require','exports','module','handlebars','typetools','helpers','plugins/backbone.layoutmanager','plugins/backbone.trackit','plugins/bootstrap-dropdown','plugins/typeahead'],function(require, exports, module) {

  

  // Load dependent Modules
  var Handlebars     = require('handlebars'),
      typetools      = require("typetools");

  // Globally load Handlebars helpers
  require('helpers');

  // Load layout manager so it can be configured
  require('plugins/backbone.layoutmanager');

  // Load Backbone Model Track it plugin
  // Track Model changes
  require('plugins/backbone.trackit');

  // Globally load Bootstrap plugins
  require('plugins/bootstrap-dropdown');
  require('plugins/typeahead');

  var app = {

    progressView: undefined,

    alertViews: [],

    lockScreen: function() {
      this.noScroll = true;
    },

    unlockScreen: function() {
      this.noScroll = false;
    },

    //bInactive true if logged out because inactive
    logOut: function(bInactive) {
      //if binactive pass url parameter
      if(bInactive) {
        window.location.href = app.API_URL + "auth/logout/inactive";
      } else {
        window.location.href = app.API_URL + "auth/logout";
      }
    },

    //  @TODO: remove this
    //logErrorToServer: function(type, message, details) {
    //  var user = app.users.getCurrentUser(), email = 'n/a';
    //
    //  if (user) {
    //    email = user.get('email');
    //  }
    //
    //  var data = {
    //    type: type,
    //    message: message,
    //    details: details,
    //    page: location.href,
    //    user_email: email
    //  };
    //
    //  $.post(app.API_URL + 'exception', JSON.stringify(data))
    //    .done(function(response) {
    //      console.log(response.response);
    //    })
    //    .error(function(obj) {
    //      console.log('FAILED TO LOG ERROR'+obj.responseText);
    //    });
    //},

    // http://stackoverflow.com/a/1830844
    isNumber: function(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    },

    evaluateExpression: function(a, operator, b) {
      switch (operator) {
        case '==':
          return (a == b);
        case '===':
          return (a === b);
      }
    },

    getCurrentGroup: function() {
      var user = app.users.getCurrentUser();
      return user.get('group');
    },

    getBookmarks: function() {
      return app.bookmarks;
    },

    deepClone: function(data) {
      return JSON.parse(JSON.stringify(data));
    },

    affix: function() {
      var sidebarOffset = $('#sidebar').offset();
      var navbarHeight = $('.navbar').height();
      var stickyHeight = parseInt(sidebarOffset.top,10) - parseInt(navbarHeight,10) - 20;
      var stuck = false;
      $(window).scroll(function(e){
        var scrollTop = $(window).scrollTop();
        if(!stuck && scrollTop >= stickyHeight){
          //console.log("stuck");
          stuck = true;
          $("#sidebar").addClass('affix-sidebar');
        } else if(stuck && scrollTop < stickyHeight){
          //console.log("unstuck");
          stuck = false;
          $("#sidebar").removeClass('affix-sidebar');
        }
      });
    }

  };

  app.sendFiles = function(files, callback, progressCallback) {
    var formData = new FormData();

    var success = function(responseData) {
      callback.apply(this, [responseData]);
    };

    if (files instanceof File) files = [files];
    _.each(files, function(file, i) {
      formData.append('file'+i, file);
    });

    //app.trigger('progress', 'Uploading');

    $.ajax({
      url: app.API_URL + 'upload',
      type: 'POST',
      data: formData,
      cache: false,
      contentType: false,
      processData: false,
      success: success,
      error: function() {
        app.trigger('alert','upload failed', arguments);
        callback.apply(this, []);
      },
      xhr: function() {  // custom xhr
        var myXhr = $.ajaxSettings.xhr();
        if(myXhr.upload && progressCallback){ // check if upload property exists
          myXhr.upload.addEventListener('progress',progressCallback, false); // for handling the progress of the upload
        }
        return myXhr;
      },
    });
  };

  app.sendLink = function(link, callback) {
    var success = function(responseData) {
      callback.apply(this, [responseData]);
    };

    $.ajax({
      url: app.API_URL + 'upload/link',
      type: 'POST',
      data: {
        'link': link
      },
      success: success,
      error: function(err1, err2, err3) {
        app.trigger('alert','upload failed', arguments);
        //console.log('ERRRRRROOOORRR!!', err1, err2, err3);
      }
    });
  };

  // TODO: Move to a Directus backbone model
  // change status or delete item
  app.changeItemStatus = function(model, value, options) {
    var hasStatusColumn = model.has(app.statusMapping.status_name);
    var goingToDelete = value == app.statusMapping.deleted_num;

    if (goingToDelete && !hasStatusColumn) {
      // https://github.com/RNGR/Directus/issues/960
      // Pass {wait: true} if you'd like to wait for the server to respond
      // before removing the model from the collection.
      model.destroy(options);
    } else {
      var attributes = {};
      attributes[app.statusMapping.status_name] = value;
      model.save(attributes, options);
    }
  };

  app.changeCollectionStatus = function(collection, value, options) {
    var model = collection.at(0);
    var hasStatusColumn = model.has(app.statusMapping.status_name);
    var goingToDelete = value == app.statusMapping.deleted_num;

    if (goingToDelete && !hasStatusColumn) {
      collection.destroyAll(options);
    } else {
      collection.saveAll(options);
    }
  };

  // check if string has this format "D, d M Y H:i:s"
  app.isStringADate = function(date) {
    return (typeof date === "string") ? !!date.match(/^([a-zA-Z]{3})\, ([0-9]{2}) ([a-zA-Z]{3}) ([0-9]{4}) ([0-9]{2}):([0-9]{2}):([0-9]{2})$/) : false;
  };

  // Agnus Croll:
  // http://javascriptweblog.wordpress.com/2011/08/08/fixing-the-javascript-typeof-operator/
  Object.toType = function(obj) {
    return ({}).toString.call(obj).match(/\s([a-z|A-Z]+)/)[1].toLowerCase();
  };


  //Give forms the ability to serialize to objects
  $.fn.serializeObject = function() {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });

    return o;
  };

  // Localize or create a new JavaScript Template object.
  var JST = window.JST = window.JST || {};

  // Configure LayoutManager with Backbone Boilerplate defaults.
  Backbone.Layout.configure({
    // Allow LayoutManager to augment Backbone.View.prototype.
    manage: true,

    prefix: "app/templates/",


    fetchTemplate: function(path) {
      // Concatenate the file extension.

      // If template is not a path but instead Handlebars.Compile
      if (typeof path === 'function') {
        return path;
      }

      path = path + ".html";

      // If cached, use the compiled template.
      if (JST[path]) {
        return JST[path];
      }

      // Put fetch into `async-mode`.
      var done = this.async();

      // Seek out the template asynchronously.
      // ASYNC is causing render-order trouble, use sync now since it will be compiled anyway

      //$.get(app.root + path, function(contents) {
      //  done(JST[path] = Handlebars.compile(contents));
      //});

      $.ajax({
        url: app.root + path,
        global: false,
        async: false,
        success: function(contents) {
          done(JST[path] = Handlebars.compile(contents));
        }
      });

    }
  });

  window.app = app;

  // Mix Backbone.Events, modules, typetools, and layout management into the app object.
  app = _.extend(app, {
    // Create a custom object with a nested Views object.
    module: function(additionalProps) {
      return _.extend({ Views: {} }, additionalProps);
    },

    // Helper for using layouts.
    useLayout: function(options) {
      // Create a new Layout with options.
      var layout = new Backbone.Layout(_.extend({
        el: "body"
      }, options));

      // Cache the refererence.
      this.layout = layout;
      return this.layout;
    }

  }, Backbone.Events, typetools);

  module.exports = app;

});

//  tabs.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com


define('core/tabs',[
  "app",
  "backbone",
  'core/t'
],

function(app, Backbone, __t) {

  

  var Tabs = {};

  Tabs.Collection = Backbone.Collection.extend({
    setActive: function(route) {

      var model = this.get(route);
      //deactive all tabs
      _.each(this.where({'active':true}),function(model) {
        model.unset('active',{silent: true});
      });

      if (!model) { return; }
      model.set({'active':true});
    }
  });

  Tabs.View = Backbone.Layout.extend({
    template: "tabs",

    tagName: "div",

    serialize: function() {
      var currentUser = app.users.getCurrentUser();
      var currentUserAvatar = currentUser.getAvatar();
      var currentUserId = app.users.getCurrentUser().get("id");
      var showSettings = app.users.getCurrentUser().get('group').id === 1;

      return {avatar: currentUserAvatar, currentUserId: currentUserId, showSettings: showSettings};
    },

    events: {
     'click a[href$="#logout"]': function(e) {
        e.preventDefault();
        app.router.openModal({type: 'confirm', text: __t('are_you_sure_you_want_to_sign_out'), callback: function() {
          window.location.href = app.API_URL + "auth/logout";
        }});
        return false;
      }
    },

    afterRender: function() {
      //If we are  showing notification, make sure to show it
      if(app.activityInProgress) {
        $('a[href$="#activity"] span').removeClass('icon-bell').addClass('icon-cycle');
      }
    },

    initialize: function() {
      this.collection.on('change', this.render, this);
    }

  });

  return Tabs;
});

define('schema/UIModel',['require','exports','module','app','underscore','backbone','core/UIManager'],function(require, exports, module) {

  

  var app = require('app');
  var _ = require('underscore');
  var Backbone = require('backbone');
  var UIManager = require('core/UIManager');

  module.exports = Backbone.Model.extend({

    inputs: {},

    addInput: function(attr, input) {
      this.inputs[attr] = input;
    },

    getInput: function(attr) {
      return this.inputs[attr];
    },

    url: function() {
      var column = this.parent;
      var columnSchema = this.parent.collection;

      return this.parent.collection.url + '/' + this.parent.id + '/' + this.id;
    },

    // When the time is right, this part need serious reconsideration
    getStructure: function() {
      return this.structure;
    },

    getTable: function() {
      return this.parent.getTable();
    },

    //@todo: This is code repetition. Almost identical to entries.model. Create a mixin?
    validate: function(attributes, options) {
      var errors = [];
      var structure = this.getStructure();

      // When this model is created the structure may not be defined.
      if (!structure) {
        return;
      }

      var isNothing = function(value) {
        return value === undefined || value === null || value === '' || (!app.isNumber(value) && !_.isDate(value) && _.isEmpty(value));
      };

      // only validates attributes that are part of the schema
      attributes = _.pick(attributes, structure.pluck('id'));
      _.each(attributes, function(value, key, list) {
        var column = structure.get(key);

        // Don't validate hidden fields
        // @todo should this be adjusted since these fields are now posting in some cases?
        if (column.get('hidden_input')) {
          return;
        }

        // Don't validate ID
        if (key === 'id') {
          return;
        }

        var nullDisallowed = column.get('is_nullable') === 'NO';
        var ui = UIManager._getUI(column.get('ui'));
        var forceUIValidation = ui.forceUIValidation === true;
        var isNull = isNothing(value);
        var uiSettings = UIManager.getSettings(column.get('ui'));
        var skipSerializationIfNull = uiSettings.skipSerializationIfNull;
        var mess = (!forceUIValidation && !skipSerializationIfNull && nullDisallowed && isNull) ?
          'The field cannot be empty'
          : UIManager.validate(this, key, value);

        if (mess !== undefined) {
          errors.push({attr: key, message: mess});
        }
      }, this);

      if (errors.length > 0) return errors;
    },

    initialize: function() {
      this.on('invalid', function(model, errors) {
        var details = _.map(errors, function(err) { return '<b>'+app.capitalize(err.attr)+':</b> '+err.message; }).join('</li><li>');
        var error_id = (this.id)? this.id : 'New';
        details = app.capitalize(this.parent.get('column_name')) + ' (' + error_id + ')' + '<hr><ul><li>' + details + '</li></ul>';
        app.trigger('alert:error', 'There seems to be a problem...', details);
      });
    },
  });
});

define('schema/RelationshipModel',['require','exports','module','backbone'],function(require, exports, module) {

  

  var Backbone = require('backbone');

  module.exports = Backbone.Model.extend({});

});
define('schema/ColumnModel',['require','exports','module','app','./UIModel','./RelationshipModel'],function(require, exports, module) {

  

  var app = require('app'),
      UIModel = require('./UIModel'),
      RelationshipModel = require('./RelationshipModel');

  module.exports = Backbone.Model.extend({

      parse: function(result) {
        var ui = result.ui;
        var tableName = '';

        if (_.isEmpty(ui)) {
          throw new Error("Column '"+ result.id + "' in table '" + tableName + "' does not have a UI");
        }

        // if the url was set explicit with an string
        // let's add the column name.
        if (!_.isFunction(this.url)) {
          this.url += '/'+result.column_name;
        }

        // Can this be done elsewhere so we can break the app dependency?
        /*if (!app.uiManager.hasUI(ui)) {
          throw new Error("The UI '" + ui + "', set for the column '" + result.id + "' in the table '" + tableName + "' does not exist!");
        }*/

        // make sure that the structure is the right kind for the UI
        // @todo: move this to options instead so it doesn't need to change
        //this.structure = app.uiSettings[ui].schema;

        // this.structure = new ColumnsCollection(uiStructure, {parse: true});
        // initialize UI
        var options = result.options || {};
        options.id = result.ui;
        this.options = new UIModel(options);
        this.options.parent = this;

        if (result.relationship) {
          this.relationship = new RelationshipModel(result.relationship);
          this.relationship.parent = this;
        }

        result.header = result.header === true || result.header === "true" || result.header === 1;
        // UI Settings input should not be require by default
        // if required and is_nullable is not set
        // should fallback to required = false, is_nullable = YES
        result.required = result.required === true;
        result.is_nullable = result.is_nullable ? result.is_nullable : 'YES';

        return _.omit(result, 'options', 'relationship');
      },

      getOptions: function() {
        return this.options.get(this.attributes.ui);
      },

      getRelated: function() {
        return this.relationship.get('related_table');
      },

      getTable: function() {
        return this.collection.table;
      },

      getRelationshipType: function() {
        if (!this.hasRelated()) return;
        return this.relationship.get('type');
      },

      hasRelated: function() {
        return this.relationship !== undefined;
      },

      isNullable: function() {
        return this.get('is_nullable') === 'YES';
      },

      isRequired: function() {
        return this.get('required') || !this.isNullable();
      },

      toJSON: function(options) {
        if (options && options.columns) {
          return _.pick(this.attributes, options.columns);
        }
        return _.clone(this.attributes);
      }
  });

});

define('schema/ColumnsCollection',['require','exports','module','backbone','./ColumnModel'],function(require, exports, module) {

  

  var Backbone = require('backbone'),
      ColumnModel = require('./ColumnModel');

  module.exports = Backbone.Collection.extend({

    model: ColumnModel,

    comparator: function(row) {
      return row.get('sort');
    },

    getRelationalColumns: function() {
      return this.filter(function(column) {
        return column.hasRelated();
      });
    },

    getColumnsByType: function(type) {
      type = type.toLowerCase();
      return this.filter(function(column) {
        return column.get('type').toLowerCase() === type;
      });
    },

    save: function(attributes, options) {
      options = options || {};
      var collection = this;
      var success = options.success;

      options.success = function(model, resp, xhr) {
        collection.reset(model);
        if (success !== undefined) {
          success();
        }
      };

      return Backbone.sync('update', this, options);
    },

    initialize: function() {
    }

  });

});
define('schema/TableModel',['require','exports','module','backbone','./ColumnsCollection','./../core/PreferenceModel'],function(require, exports, module) {

  

  var Backbone = require('backbone'),
      ColumnsCollection = require('./ColumnsCollection'),
      PreferenceModel = require('./../core/PreferenceModel');

  module.exports =  Backbone.Model.extend({

    parse: function(data) {
      if (this.columns === undefined) {
        this.columns = new ColumnsCollection(data.columns, {parse: true, url: this.url + '/columns'});
      } else {
        this.columns.reset(data.columns, {parse: true});
      }

      if(data.preferences !== undefined) {
        if (this.preferences === undefined) {
          var preference = data.preferences;
          this.preferences = new PreferenceModel(data.preferences, {url: app.API_URL + 'tables/' + preference.table_name + '/preferences'})
        } else {
          this.preferences.set(data.preferences);
        }
      }

      this.columns.table = this;

      return _.omit(data, ['columns', 'preferences']);
    },

    toJSON: function(options) {
      var attrs = _.clone(this.attributes);
      attrs.columns = this.columns.toJSON();
      return attrs;
    }

  });

});
define('core/collection',[
  "app",
  "backbone"
],

function(app, Backbone) {

  

  var Collection = Backbone.Collection.extend({

    initialize: function(models, options) {
      this.filters = options.filters || {};
    },

    getColumns: function() {
      var cols = (this.length) ? _.keys(this.at(0).toJSON()) : [];
      var result = this.filters.hasOwnProperty('columns_visible') ? _.intersection(cols, this.filters.columns_visible) : cols;
      return result;
    },

    getRows: function() {
      var cols = this.getColumns();
      var models = this.filterMulti({hidden: false});
      return _.map(models, function(model) { return _.pick(model.toJSON(), cols); });
    },

    getTotalCount: function() {
      var totalCount;
      // Let's have the collection length
      // to replace the table total when we add items
      // because we are not updating this value
      // we are just fetching it once
      // @TODO: update this value on collection change
      var collectionCount = this.length;

      // There is no active column. Use total
      if (!this.table.columns.get(app.statusMapping.status_name)) {
        return Math.max(this.table.get('total'), collectionCount);
      }

      var visibleStates = (this.getFilter('status') || '').split(',');
      totalCount = 0;

      var that = this;
      visibleStates.forEach(function(state) {
        if(state in app.statusMapping.mapping && that.table.has(app.statusMapping.mapping[state].name)) {
          totalCount += that.table.get(app.statusMapping.mapping[state].name);
        }
      });

      return Math.max(totalCount, collectionCount);
    },

    getModels: function() {
      return this.models;
    },

    getFilters: function() {
      return this.filters;
    },

    getFilter: function(key) {
      return this.filters && this.filters[key];
    },

    setFilter: function(key, value) {
      var attrs;
      if (key === null || typeof key === 'object') {
        attrs = key;
      } else {
        (attrs = {})[key] = value;
      }
      _.each(attrs, function(value, key) {
        this.filters[key] = value;
      }, this);
    },

    // Proxies underscore's sortBy to reverse order

    sortBy: function() {
      var models = _.sortBy(this.models, this.comparator, this);

      return models;
    },

    comparatorValue: function(a, b) {
      var cmp;

      if (typeof a === "string" && typeof b === "string") {
        cmp = a.localeCompare(b);
      } else {
        cmp = ( a > b ) ? 1 : -1;
      }

      if (this.getFilter('sort_order')==='DESC') cmp*=-1;

      return cmp;
    },

    comparator: function(rowA, rowB) {
      var UIManager = require('core/UIManager');
      var column = rowA.idAttribute || 'id';
      var valueA, valueB;

      if (this.getFilter('sort')) {
        column = this.getFilter('sort')
      } else if (this.hasColumn && this.hasColumn('sort')) {
        column = 'sort';
      } else if (this.junctionStructure && this.junctionStructure.get('sort')) {
          column = 'sort';
      }

      // @todo find a better way to check is a entriesjunctioncollection
      if(rowA.collection.nestedCollection && ['sort', rowA.idAttribute || 'id'].indexOf(column) < 0) {
        rowA = rowA.get('data');
        rowB = rowB.get('data');
      }

      // Sort relational columns in listview https://github.com/RNGR/Directus/issues/452
      valueA = UIManager.getSortValue(rowA, column) || '';
      valueB = UIManager.getSortValue(rowB, column) || '';

      var options, ui, type, schema;

      //There is no value
      if (!rowA.has(column)) {
        if (this.structure && this.structure.get(column) !== undefined) {
          schema = this.structure.get(column);
          ui = schema.get('ui');

          options = UIManager.getSettings(ui);
          if (options.length > 0) {

            //Merge the column values, eg first_name, last_name
            if (_.isArray(options.sortBy)) {
              valueA = _.map(options.sortBy, function(value) {
                return rowA.get(value);
              }).join('');
              valueB = _.map(options.sortBy, function(value) {
                return rowB.get(value);
              }).join('');
            } else {
              valueA = rowA.get(options.sortBy);
              valueB = rowB.get(options.sortBy);
            }
          }
        } else {
          valueA = rowA.id;
          valueB = rowB.id;
        }
      }

      return this.comparatorValue(valueA, valueB);
    },

    setOrder: function(column, sortOrder, options) {
      //useless without filters...
      if (!this.filters) return;

      if (column === undefined) {
        this.setFilter({sort:'id', sort_order: 'ASC'});
      } else {
        this.setFilter({sort: column, sort_order: sortOrder});
      }


      if (this.filters.perPage <= this.table.get('total')) {
        this.fetch();
      } else {
        this.sort(options);
      }
    },

    getOrder: function() {
      var order = {};
      order.sort = this.getFilter('sort');
      order.sort_order = this.getFilter('sort_order');
      return order;
    },

   filterMulti: function(filters) {
      return this.filter(function(model) {
        // Every filter has to pass the test!
        return _.every(filters, function(value, key) { return (model.has(key) && model.get(key) === value); });
      });
    },

    save: function(options) {
      options = options || {};
      var collection = this;
      var success = options.success;

      options.success = function(model, resp, xhr) {
        collection.reset(model ,{parse: true});
        if (success !== undefined) {
          success();
        }
      };

      // would be awesome if this is always how it werkz...
      options.url = this.url + '?' + $.param(this.getFilters());

      return Backbone.sync('update', this, options);
    },

    fetch: function(options) {
      options = options || {};
      options.data = options.data || {};

      if (options.includeFilters === undefined) {
        options.includeFilters = true;
      }

      if (options.includeFilters) {
        var filters = this.getFilters();
        if(filters && filters.columns_visible && !(filters.columns_visible.indexOf(filters.sort) !== -1) && this.structure.get(filters.sort)) {
          // when there's only one visible column
          // it's an string so we need to convert it to an array
          if(typeof filters.columns_visible === 'string') {
            filters.columns_visible = filters.columns_visible.split();
          }
          filters.columns_visible.push(filters.sort);
        }
        _.extend(options.data, filters);
      }
      this.trigger('fetch', this);
      return Backbone.Collection.prototype.fetch.call(this, options);
    }

  });

  return Collection;
});

define('schema/fixed/activity',['require','exports','module'],function(require, exports, module) {

  

  module.exports = {

    "id":"directus_activity",
    "table_name":"directus_activity",
    "hidden":true,
    "single":false,
    "count":0,
    "active":0,
    "url": "api/1/activity",
    "title": "Activity",

    "columns": [
      {
        "id":"activity",
        "column_name":"activity",
        "sort":0,
        "type":"ALIAS",
        "is_nullable":"NO",
        "ui":"directus_activity",
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false
      },
      {
        "id":"id",
        "column_name":"id",
        "type":"INT",
        "is_nullable":"NO",
        "comment":"",
        "sort":1,
        "system":true,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "ui":"numeric",
        "hidden":true
      },
      {
        "id":"identifier",
        "column_name":"identifier",
        "type":"VARCHAR",
        "char_length":"100",
        "is_nullable":"YES",
        "comment":"",
        "sort":2,
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "ui":"textinput"
      },
      {
        "id":"action",
        "column_name":"action",
        "type":"VARCHAR",
        "char_length":"100",
        "is_nullable":"NO",
        "default_value":"",
        "comment":"",
        "sort":3,
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "ui":"textinput"
      },
      {
        "id":"table_name",
        "column_name":"table_name",
        "type":"VARCHAR",
        "char_length":"100",
        "is_nullable":"NO",
        "default_value":"",
        "comment":"",
        "sort":4,
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "ui":"textinput"
      },
      {
        "id":"row_id",
        "column_name":"row_id",
        "type":"INT",
        "is_nullable":"NO",
        "comment":"",
        "sort":5,
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "ui":"numeric"
      },
      {
        "id":"user",
        "column_name":"user",
        "type":"INT",
        "is_nullable":"NO",
        "default_value":"0",
        "comment":"",
        "sort":6,
        "ui":"directus_user",
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "options": {
            "format": "short"
        }
      },
      {
        "id":"data",
        "column_name":"data",
        "type":"TEXT",
        "char_length":"65535",
        "is_nullable":"YES",
        "comment":"",
        "sort":7,
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "ui":"textarea"
      },
      {
        "id":"parent_id",
        "column_name":"parent_id",
        "type":"INT",
        "is_nullable":"YES",
        "comment":"",
        "sort":8,
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "ui":"numeric"
      },
      {
        "id":"datetime",
        "column_name":"datetime",
        "type":"DATETIME",
        "is_nullable":"YES",
        "comment":"",
        "sort":9,
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "required":false,
        "ui":"datetime",
        "options": {
            "id": "datetime",
            "contextual_date_in_listview": "1"
        }
      }
    ]
  };

});

define('schema/fixed/groups',['require','exports','module'],function(require, exports, module) {

  

  module.exports = {

    "id":"directus_groups",
    "table_name":"directus_groups",
    "hidden":true,
    "single":false,
    "url": "api/1/groups",

    "columns": [
      {
        "id":"id",
        "column_name":"id",
        "ui":"numeric",
        "type":"INT",
        "system":true,
        "hidden_list":true,
        "hidden_input":true
      },
      {
        "id":"name",
        "column_name":"name",
        "ui":"numeric",
        "type":"VARCHAR",
        "system":true,
        "hidden_list":true,
        "hidden_input":true
      },
      {
        "id":"description",
        "column_name":"description",
        "ui":"textinput",
        "type":"VARCHAR",
        "system":false,
        "hidden_list":true,
        "hidden_input":true
      }
    ]
  };
});
define('schema/fixed/files',['require','exports','module','app'],function(require, exports, module) {

  

  var app = require('app');
  module.exports = {
    getFiles: function() {
      var statusName = app.statusMapping.status_name;
      return {
        "id":"directus_files",
        "table_name":"directus_files",
        "hidden":true,
        "single":false,
        "count":0,
        "url": "api/1/files",
        "title":"Files",

        "columns": [
          {
            "id":"item",
            "column_name":"item",
            "type":"ALIAS",
            "is_nullable":"NO",
            "comment":"",
            "sort":-1,
            "ui":"directus_file",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false
          },
          {
            "id":"id",
            "column_name":"id",
            "type":"INT",
            "is_nullable":"NO",
            "comment":"",
            "sort":1,
            "system":true,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "ui":"numeric",
            "hidden":true
          },
          {
            "id": statusName,
            "column_name":statusName,
            "type":"TINYINT",
            "is_nullable":"YES",
            "default_value":"1",
            "comment":"",
            "sort":2,
            "system":true,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "ui":"checkbox",
            "hidden":true
          },
          {
            "id":"name",
            "column_name":"name",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "comment":"",
            "sort":3,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"title",
            "column_name":"title",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":4,
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "ui":"directus_file_title"
          },
          {
            "id":"location",
            "column_name":"location",
            "type":"VARCHAR",
            "char_length":"200",
            "is_nullable":"YES",
            "comment":"",
            "sort":5,
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"type",
            "column_name":"type",
            "type":"VARCHAR",
            "char_length":"50",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":6,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"charset",
            "column_name":"charset",
            "type":"VARCHAR",
            "char_length":"50",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":7,
            "system":true,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"caption",
            "column_name":"caption",
            "type":"TEXT",
            "char_length":"65535",
            "is_nullable":"YES",
            "comment":"",
            "sort":8,
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "ui":"textarea",
            "options":{
              "id":"textarea",
              "rows":"4"
            }
          },
          {
            "id":"tags",
            "column_name":"tags",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":9,
            "ui":"tags",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false
          },
          {
            "id":"width",
            "column_name":"width",
            "type":"INT",
            "is_nullable":"YES",
            "default_value":"0",
            "comment":"",
            "sort":10,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"numeric"
          },
          {
            "id":"height",
            "column_name":"height",
            "type":"INT",
            "is_nullable":"YES",
            "default_value":"0",
            "comment":"",
            "sort":11,
            "ui":"numeric",
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false
          },
          {
            "id":"size",
            "column_name":"size",
            "type":"INT",
            "is_nullable":"YES",
            "default_value":"0",
            "comment":"",
            "sort":12,
            "ui":"directus_file_size",
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false
          },
          {
            "id":"embed_id",
            "column_name":"embed_id",
            "type":"VARCHAR",
            "char_length":"200",
            "is_nullable":"YES",
            "comment":"",
            "sort":13,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"user",
            "column_name":"user",
            "type":"INT",
            "is_nullable":"YES",
            "comment":"",
            "sort":14,
            "ui":"directus_user",
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "options":{
              "id":"directus_user",
              "format":"short"
            }
          },
          {
            "id":"storage_adapter",
            "column_name":"storage_adapter",
            "type":"INT",
            "is_nullable":"YES",
            "comment":"",
            "sort":14,
            "ui":"numeric",
            "system":true,
            "hidden_list":true,
            "hidden_input":true,
            "required":false
          },
          {
            "id":"date_uploaded",
            "column_name":"date_uploaded",
            "type":"DATETIME",
            "is_nullable":"YES",
            "comment":"",
            "sort":15,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"datetime",
            "options": {
              "id": "datetime",
              "contextual_date_in_listview": "1"
            }
          }
        ]
      }
    }
  };

});

define('schema/fixed/messages',['require','exports','module'],function(require, exports, module) {

  

  module.exports = {
    "id":"directus_messages",
    "table_name":"directus_messages",
    "hidden":true,
    "single":false,
    "url": "api/1/groups",

    "columns": [
      {
        "id":"id",
        "column_name":"id",
        "ui":"numeric",
        "type":"INT",
        "system":true,
        "hidden_list":true,
        "hidden_input":true
      },
      {
        "id":"from",
        "column_name":"from",
        "ui":"directus_user",
        "type":"INT",
        "system":false,
        "hidden_list":false,
        "hidden_input":false,
        "options":{
          "id":"directus_user",
          "format":"short"
        }
      },
      {
        "id":"recipients",
        "column_name":"recipients",
        "ui":"directus_messages_recipients",
        "is_nullable":"NO",
        "type":"VARCHAR",
        "system":false,
        "char_length":1000,
        "hidden_list":false,
        "hidden_input":false
      },
      {
        "id":"subject",
        "column_name":"subject",
        "ui":"textinput",
        "type":"VARCHAR",
        "required":true,
        "system":false,
        "char_length":100,
        "hidden_list":false,
        "hidden_input":false
      },
      {
        "id": "message",
        "column_name": "message",
        "ui": "textarea",
        "type": "VARCHAR",
        "system": false,
        "hidden_list": false,
        "hidden_input" :false,
        "options": {
          "id": "textarea",
          "rows": 15
        }
      },
      {
        "id":"datetime",
        "column_name":"datetime",
        "type":"DATETIME",
        "is_nullable":"YES",
        "ui":"datetime",
        "system":false,
        "hidden_list":false,
        "hidden_input":true,
        "required":false,
        "is_writable":true,
        "options":[

        ]
      },
      {
        "id":"date_updated",
        "column_name":"date_updated",
        "type":"DATETIME",
        "is_nullable":"YES",
        "ui":"datetime",
        "system":false,
        "hidden_list":false,
        "hidden_input":true,
        "required":false,
        "is_writable":true,
        "options":[

        ]
      },
      {
        "id":"responses",
        "column_name":"responses",
        "type":"ONETOMANY",
        "is_nullable":"NO",
        "comment":"",
        "sort":38,
        "ui":"one_to_many",
        "system":false,
        "hidden_list":true,
        "hidden_input":true,
        "related_table":"directus_messages",
        "junction_key_right":"response_to",
        "required":false,
        "is_writable":true,
        "options":{
          "id":"one_to_many",
          "visible_columns":"subject"
        },
        "relationship": {
          "type": "ONETOMANY",
          "related_table": "directus_messages",
          "junction_key_right": "response_to"
        }
      },
      {
        "id":"response_to",
        "column_name":"response_to",
        "ui":"numeric",
        "type":"INT",
        "system":true,
        "hidden_list":true,
        "hidden_input":true
      }
    ]
  };

});

define('schema/fixed/users',['require','exports','module','app'],function(require, exports, module) {

  

  var app = require('app');

  function parseSelectOptions(list, callback) {
    if (!list) {
      return null;
    }

    var result = {};
    for (var key in list) {
      if (list.hasOwnProperty(key)) {
        callback(key, list, list[key], result);
      }
    }

    return JSON.stringify(result);
  }

  module.exports = {
    getUsers: function(locales, timezones) {
      var statusName = app.statusMapping.status_name;
      var defaultTimezone = app.timezone;
      var defaultLocale = app.locale;

      return {
        "id":"directus_users",
        "table_name":"directus_users",
        "title":"Users",
        "hidden":true,
        "single":false,
        "footer": 1,
        "count":0,
        "user_create_column": "id",
        "user_update_column": "id",
        statusName:0,
        "url": "api/1/tables/directus_users/",
        "columns": [
          {
            "id":"id",
            "column_name":"id",
            "type":"TINYINT",
            "is_nullable":"NO",
            "comment":"",
            "sort":0,
            "system":true,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"checkbox",
            "hidden":true
          },
          {
            "id":statusName,
            "column_name":statusName,
            "type":"TINYINT",
            "is_nullable":"NO",
            "default_value":"1",
            "comment":"",
            "sort":1,
            "system":true,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "ui":"checkbox",
            "hidden":true
          },
          {
            "column_name":"avatar_file_id",
            "sort":2,
            "type":"INT",
            "is_nullable":"YES",
            "comment":"",
            "ui":"single_file",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "column_type":"int(11)",
            "column_key":"",
            "is_writable":true,
            "id":"avatar_file_id",
            "options":{
              "id":"single_file",
              "allowed_filetypes":"image\/*"
            },
            "relationship":{
              "type":"MANYTOONE",
              "related_table":"directus_files",
              "junction_key_right":"avatar_file_id"
            }
          },
          {
            "id":"avatar",
            "column_name":"avatar",
            "type":"VARCHAR",
            "is_nullable":"YES",
            "comment":"",
            "sort":2,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"directus_user_avatar"
          },
          {
            "id":"name",
            "column_name":"first_name",
            "type":"ALIAS",
            "sort":3,
            "is_nullable":"NO",
            "ui":"directus_user",
            "system":false,
            "hidden_list":true,
            "hidden_input":true,
            "required":false,
            "options": {
              "format": "full"
            }
          },
          {
            "id":"first_name",
            "column_name":"first_name",
            "type":"VARCHAR",
            "char_length":"50",
            "is_nullable":"NO",
            "default_value":"",
            "comment":"",
            "sort":3,
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":true,
            "ui":"textinput",
            "options": {
              "size": "medium"
            }
          },
          {
            "id":"last_name",
            "column_name":"last_name",
            "type":"VARCHAR",
            "char_length":"50",
            "is_nullable":"NO",
            "default_value":"",
            "comment":"",
            "sort":5,
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":true,
            "ui":"textinput",
            "options": {
              "size": "medium"
            }
          },
          {
            "id":"email",
            "column_name":"email",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"NO",
            "default_value":"",
            "comment":"",
            "sort":6,
            "ui":"textinput",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":true,
            "options": {
              "size": "medium"
            }
          },
          {
            "id":"position",
            "column_name":"position",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":30,
            "ui":"textinput",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "size": "medium"
            }
          },
          {
            "id":"phone",
            "column_name":"phone",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":31,
            "ui":"textinput",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "size": "medium"
            }
          },
          {
            "id":"location",
            "column_name":"location",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":32,
            "ui":"textinput",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "size": "medium"
            }
          },
          {
            "id":"address",
            "column_name":"address",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":33,
            "ui":"textinput",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "size": "medium"
            }
          },
          {
            "id":"city",
            "column_name":"city",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":34,
            "ui":"textinput",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "size": "medium"
            }
          },
          {
            "id":"state",
            "column_name":"state",
            "type":"VARCHAR",
            "char_length":"2",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":35,
            "ui":"textinput",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "size": "small"
            }
          },
          {
            "id":"zip",
            "column_name":"zip",
            "type":"VARCHAR",
            "char_length":"10",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":36,
            "ui":"textinput",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "size": "small"
            }
          },
          {
            "id":"email_messages",
            "column_name":"email_messages",
            "type":"TINYINT",
            "is_nullable":"YES",
            "default_value":"1",
            "comment":"CMS messages will also be sent to email address above",
            "sort":6,
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "ui":"checkbox"
          },
          {
            "id":"password",
            "column_name":"password",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"NO",
            "default_value":"",
            "comment":"Passwords are encrypted, if forgotten they must be reset",
            "sort":10,
            "system":true,
            "hidden_list":true,
            "hidden_input":false,
            "required":true,
            "ui":"password",
            "options": {
              "salt_field":"salt"
            }
          },
          {
            "id":"salt",
            "column_name":"salt",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"NO",
            "default_value":"",
            "comment":"",
            "sort":11,
            "system":true,
            "hidden_list":true,
            "hidden_input":true,
            "required":true,
            "ui":"salt"
          },
          {
            "id":"token",
            "column_name":"token",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"NO",
            "default_value":"",
            "comment":"This is your user's API authentication token. Keep it safe!",
            "sort":12,
            "system":true,
            "hidden_list":false,
            "hidden_input":false,
            "required":true,
            "ui":"random",
            "options": {
              "auto_generate": 1,
              "allow_any_value": 1
            }
          },
          {
            "id":"access_token",
            "column_name":"access_token",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":13,
            "system":true,
            "hidden_list":true,
            "hidden_input":true,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"reset_token",
            "column_name":"reset_token",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":14,
            "system":true,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"reset_expiration",
            "column_name":"reset_expiration",
            "type":"DATETIME",
            "is_nullable":"YES",
            "comment":"",
            "sort":15,
            "system":true,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"datetime"
          },
          {
            "id":"last_access",
            "column_name":"last_access",
            "type":"DATETIME",
            "is_nullable":"YES",
            "default_value":"0000-00-00 00:00:00",
            "comment":"",
            "sort":20,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"datetime"
          },
          {
            "id":"last_login",
            "column_name":"last_login",
            "type":"DATETIME",
            "is_nullable":"YES",
            "default_value":"0000-00-00 00:00:00",
            "comment":"",
            "sort":21,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"datetime"
          },
          {
            "id":"last_page",
            "column_name":"last_page",
            "type":"VARCHAR",
            "char_length":"255",
            "is_nullable":"NO",
            "default_value":"",
            "comment":"",
            "sort":22,
            "system":false,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"ip",
            "column_name":"ip",
            "type":"VARCHAR",
            "char_length":"50",
            "is_nullable":"YES",
            "default_value":"",
            "comment":"",
            "sort":23,
            "system":true,
            "hidden_list":false,
            "hidden_input":true,
            "required":false,
            "ui":"textinput"
          },
          {
            "id":"group",
            "column_name":"group",
            "type":"INT",
            "is_nullable":"NO",
            "comment":"Determines this user's access",
            "sort":8,
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":true,
            "is_writable": true,
            "column_type": "int(11)",
            "column_key": "",
            "ui":"many_to_one",
            "options": {
              "id": "many_to_one",
              "related_table": "directus_groups",
              "visible_column": "name",
              "allow_null": 0,
              "visible_column_template": "{{name}}"
            },
            "relationship":{
              "type":"MANYTOONE",
              "related_table":"directus_groups",
              "junction_key_right":"group_id"
            }
          },
          {
            "id":"language",
            "column_name":"language",
            "type":"VARCHAR",
            "char_length":"8",
            "is_nullable":"YES",
            "default_value": defaultLocale,
            "comment":"",
            "sort":37,
            "ui":"select",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "allow_null": false,
              "options": parseSelectOptions(locales, function(key, list, locale, result) {
                result[locale.code] = locale.name;
              })
            }
          },
          {
            "id":"timezone",
            "column_name":"timezone",
            "type":"VARCHAR",
            "char_length":"32",
            "is_nullable":"YES",
            "default_value": defaultTimezone,
            "comment":"",
            "sort":38,
            "ui":"select",
            "system":false,
            "hidden_list":false,
            "hidden_input":false,
            "required":false,
            "options": {
              "allow_null": false,
              "options": parseSelectOptions(timezones, function(key, list, name, result) {
                result[key] = name;
              })
            }
          }
        ]
      };
    }
  };

});

define('schema/fixed/settings.global',['require','exports','module','core/t'],function(require, exports, module) {

  

  var settingsGlobalSchema = module.exports;
  var __t = require('core/t');

  settingsGlobalSchema.structure = [
      {id: 'project_name', ui: 'textinput', char_length: 50, options: {placeholder_text: __t('global_settings_project_name_placeholder')}, comment: __t('global_settings_project_name_comment')},
      {id: 'project_url', ui: 'textinput', char_length: 255, options: {placeholder_text: "http://"}, comment: __t('global_settings_project_url_comment')},
      {id: 'cms_thumbnail_url', ui: 'textinput', char_length: 255, options: {placeholder_text: "http://"}, comment: __t('global_settings_cms_thumbnail_url_comment')},
      {id: 'cms_user_auto_sign_out', ui: 'numeric', char_length: 4, options: {size: 'small'}, comment: __t('global_settings_cms_user_auto_sign_out_comment')},
      {id: 'rows_per_page', ui: 'numeric', char_length: 4, options: {size: 'small'}, comment: __t('global_settings_rows_per_page_comment')}
  ];

  return settingsGlobalSchema;
});

define('schema/fixed/settings.files',['require','exports','module','core/t'],function(require, exports, module) {

  

  var SettingsFilesSchema = module.exports;
  var __t = require('core/t');

  SettingsFilesSchema.structure = [
    {id: 'file_naming', ui: 'select', char_length: 255, options: {allow_null: false, options: '{ \
        "file_name":"'+__t('settings_files_file_naming_file_name')+'", \
        "file_id":"'+__t('settings_files_file_naming_file_id')+'", \
        "file_hash":"'+__t('settings_files_file_naming_file_hash')+'" \
      }'}, comment: __t('settings_files_file_naming_comment')
    },
    {id: 'thumbnail_quality', ui: 'numeric', char_length: 255, options: {size: 'small', placeholder_text: "eg: 90"}, comment: __t('settings_files_thumbnail_quality_comment')},
    {id: 'thumbnail_crop_enabled', ui: 'checkbox', comment: __t('settings_files_thumbnail_crop_enabled')},
    {id: 'youtube_api_key', ui: 'textinput', char_length: 255, comment: __t('settings_files_youtube_api_key_comment')+'<br><a target="_blank" href="https://developers.google.com/youtube/v3/getting-started">'+__t('settings_files_youtube_api_key_get_key')+'</a>'}
  ];

  return SettingsFilesSchema;
});

define('schema/SchemaManager',['require','exports','module','app','./ColumnModel','./ColumnsCollection','./TableModel','backbone','./UIModel','core/collection','core/PreferenceModel','./fixed/activity','./fixed/groups','./fixed/files','./fixed/messages','./fixed/users','./fixed/settings.global','./fixed/settings.files'],function(require, exports, module) {

  

  var app = require('app');

  // Structures
  var ColumnModel        = require('./ColumnModel'),
      ColumnsCollection  = require('./ColumnsCollection'),
      TableModel         = require('./TableModel'),
      Backbone           = require('backbone'),
      UIModel            = require('./UIModel'),
      DirectusCollection = require('core/collection'),
      PreferenceModel    = require('core/PreferenceModel');

  // Static Schemas
  var directusSchemas = {
    'directus_activity'  : require('./fixed/activity'),
    'directus_groups'    : require('./fixed/groups'),
    'directus_files'     : require('./fixed/files'),
    'directus_messages'  : require('./fixed/messages'),
    'directus_users'     : require('./fixed/users')
  };

  /**
   * @private
   * Static Settings Schemas
   */
  var settingsSchemas = {
    'global': require('./fixed/settings.global'),
    'files': require('./fixed/settings.files')
  };

  /**
   * @private
   * Collection of MySQL Tables
   */
  var TableCollection = DirectusCollection.extend({
    model: TableModel,

    countVisible: function() {
      // Visible models only
      var models = this.filter(function(model) { return !model.get('hidden'); });

      return models.length;
    }
  });

  /**
   * @private
   * Holds schemas of all tables in the database
   */
  var tableSchemas = {
    tables: new TableCollection([], {
      filters: {
        columns: ['table_name','comment','status','date_modified','single'],
        conditions: {hidden: false}
      }
    })
  };

  /**
   * @private
   * Holds schemas of all columns in the database
   */
  var columnSchemas = {
    tables: {},
    settings: {},
    ui: {}
  };

  /**
   * @private
   * Holds preferences
   */
  var preferences = {};

  /**
   * @private
   * Holds privileges
   */
  var privileges = {};

  module.exports = {

    setup: function(options) {
      this.apiURL = options.apiURL;


      var defaultTables = [
        { schema: directusSchemas.directus_activity },
        { schema: directusSchemas.directus_groups },
        { schema: directusSchemas.directus_files.getFiles() },
        { schema: directusSchemas.directus_messages },
        { schema: directusSchemas.directus_users.getUsers(app.locales, app.timezones) }
      ];

      this.register('tables', defaultTables);

      this.registerSettingsSchemas([
        {id: 'global', schema: settingsSchemas.global},
        {id: 'files', schema: settingsSchemas.files}
      ]);

    },

    register: function(namespace, tables) {
      _.each(tables, function(options) {
        var tableName = options.schema.id;

        if (tableSchemas[namespace].get(tableName)) {
          console.warn('Warning: ' + tableName + ' already exists in the schema manager, the schema will be ignored');
          return;
        }

        // Set table schema
        options.schema.url = this.apiURL + 'tables/' + encodeURIComponent(tableName);

        var model = new TableModel(options.schema, {parse: true, url: this.apiURL + 'tables/' + encodeURIComponent(tableName)});
        //model.url = this.apiURL + 'tables/' + tableName;
        //model.columns.url = this.apiURL + 'tables/' + tableName + '/columns';

        columnSchemas[namespace][tableName] = model.columns;
        tableSchemas[namespace].add(model);

      }, this);
    },

    registerColumns: function(namespace, tableName, columns) {
      columnSchemas[namespace][tableName] = columns;
    },

    // Registers the UI variables as schemas so they can be
    // used as forms in the table settings
    registerUISchemas: function(data) {
      var namespace = 'ui';
      _.each(data, function(ui) {
        columnSchemas[namespace][ui.id] = new ColumnsCollection(ui.variables, {parse: true});
      }, this);
    },

    // Registers static schemas for the global and files settings
    registerSettingsSchemas: function(data) {
      var namespace = 'settings';
      _.each(data, function(settings) {
        columnSchemas[namespace][settings.id] = new ColumnsCollection(settings.schema.structure, {parse: true});
        // TODO: columns must have its table information
        columnSchemas[namespace][settings.id].table = {
          id: 'directus_settings'
        };
      }, this);
    },

    addTable: function(tableName, callback) {
      var model = new Backbone.Model();
      model.url = app.API_URL + 'privileges/1';
      // @todo: set default values in the server side
      model.set({
        group_id: 1,
        allow_add:1,
        allow_edit:2,
        allow_delete:2,
        allow_alter:1,
        allow_view:2,
        table_name: tableName,
        nav_listed: 1,
        addTable: true
      });

      var self = this;
      model.save({}, {success: function(permission) {
        self.registerPrivileges([permission.toJSON()]);
        app.schemaManager.getOrFetchTable(tableName, function(table) {
          callback(table);
        });
      }});
    },

    addSetting: function(collection, data) {
      var settingsCollection = columnSchemas['settings'][collection];
      settingsCollection.add(new ColumnModel(data, {parse: true}));
    },

    addSettings: function(settings) {
      _.each(settings, function(setting) {
        if (!setting.collection) {
          console.warn('Settings must have a collection name.');
          return;
        }

        this.addSetting(setting.collection, _.omit(setting, 'collection'));
      }, this);
    },

    // Registers user preferences for tables (sort, visible columns etc)
    registerPreferences: function(data) {
      _.each(data, function(preference) {
        var add = "";
        if(preference.title !== null)
        {
          add = ":" + preference.title;
        }
        preferences[preference.table_name + add] = new PreferenceModel(preference, {url: this.apiURL + 'tables/' + encodeURIComponent(preference.table_name) + '/preferences'});
      }, this);
    },

    // Registers user priviliges
    registerPrivileges: function(data) {
      _.each(data, function(privilege) {
        privileges[privilege.table_name] = new Backbone.Model(privilege, {parse:true});
      }, this);
    },

    getColumns: function(namespace, tableName) {
      return columnSchemas[namespace][tableName];
    },

    getTable: function(tableName) {
      return tableSchemas.tables.get(tableName);
    },

    getOrFetchTable: function(tableName, callback) {
      var tableModel = this.getTable(tableName);
      var tablePreferences = this.getPreferences(tableName);
      var tablePrivileges = this.getPrivileges(tableName);

      if (tableModel && tablePreferences && tablePrivileges) {
        return callback(tableModel);
      }

      tableModel = new TableModel({
        id: tableName,
        table_name: tableName
      }, {
        parse: true,
        url: app.API_URL + 'tables/' + tableName
      });

      var self = this;
      tableModel.fetch({
        success: function(model) {
          self.register('tables', [{schema: tableModel.toJSON()}]);
          self.registerPreferences([tableModel.preferences.toJSON()]);
          callback(model);
        }
      });
    },

    getTables: function() {
      return tableSchemas.tables;
    },

    getPrivileges: function(tableName) {
      return privileges[tableName];
    },

    getPreferences: function(tableName) {
      return preferences[tableName];
    },

    updatePrivileges: function(tableName, attributes) {
      var tablePrivileges = this.getPrivileges(tableName);
      if(tablePrivileges) {
        tablePrivileges.set(attributes);
      }
    },

    countTables: function() {
      return tableSchemas.tables.countVisible();
    },

    getFullSchema: function(tableName) {
      if (!tableSchemas.tables.get(tableName)) {
        throw "Table `"+ tableName +"` does not exist";
      }
      return {
        table: tableSchemas.tables.get(tableName),
        structure: columnSchemas.tables[tableName],
        preferences: preferences[tableName],
        privileges: privileges[tableName]
      };
    },

    unregisterFullSchema: function(tableName) {
        tableSchemas.tables.remove(tableName);
        delete columnSchemas.tables[tableName];
        delete preferences[tableName];
        delete privileges[tableName];
    },

    getEntriesInstance: function(tableName) {

    }

  };

});

define('core/entries/EntriesJunctionCollection',['require','exports','module','app','backbone','helpers/model','core/collection','core/EntriesManager','core/entries/EntriesModel','core/entries/EntriesCollection'],function(require, exports, module) {

  

  var app               = require('app'),
      Backbone          = require('backbone'),
      ModelHelper       = require('helpers/model'),
      Collection        = require('core/collection'),
      EntriesManager    = require('core/EntriesManager');

  //@todo: Try merging this with entries.collection.js
  var NestedCollection = module.exports = Collection.extend({

    isNested: true,

    model: Backbone.Model.extend({

      isNested: true,

      parse: function(result) {
        var EntriesModel = require('core/entries/EntriesModel');
        result.data = new EntriesModel(result.data, {collection: this.collection.nestedCollection});
        this.collection.nestedCollection.add(result.data);
        return result;
      },

      //DRY this up please and move it to BB's protoype
      toJSON: function(options) {
        var attributes = _.clone(this.attributes);
        attributes.data = this.get('data').toJSON(options);
        if (_.isEmpty(attributes.data)) {
          attributes.data.id = this.get('data').id;
        }
        return attributes;
      }
    }),

    trash: [],

    create: function() {
      return this.nestedCollection.create(arguments);
    },

    remove: function(model, options) {
      if (!model.isNew()) {
        this.trash.push(model);
      }
      this.constructor.__super__.remove.apply(this, arguments);
    },

    //If getNested is set to true, the this will point to the nested element
    get: function(id, getNested) {
      var model = NestedCollection.__super__.get.call(this, id);
      if (getNested) model = model.get('data');
      return model;
    },

    add: function(models, options) {
      if (options && options.nest) {
        if (!_.isArray(models)) { models = [models]; }
        models = _.map(models, function(model) {
          var obj = {};
          obj.data = model;
          return obj;
        });
      }
      return NestedCollection.__super__.add.apply(this, [models, options]);
    },

    getModels: function() {
      return this.filter(function(model) {
        return !(model.has(app.statusMapping.status_name) && model.get(app.statusMapping.status_name) === app.statusMapping.deleted_num);
      });
    },

    getColumns: function() {
      return this.nestedCollection.getColumns();
    },

    parse: function(response) {
      return (response.rows === undefined) ? response : response.rows;
    },

    reset: function(models, options) {
      var models = Collection.__super__.reset.call(this, models, options);
      models.each(ModelHelper.setIdAttribute);
      return models;
    },

    hasColumn: function(columnName) {
      return this.structure.get(columnName) !== undefined;
    },

    initialize: function(models, options) {
      var EntriesCollection = require('core/entries/EntriesCollection');

      this.structure = options.structure;
      this.table = options.table;
      this.preferences = options.preferences;

      this.filters = options.filters;
      this.junctionStructure = options.junctionStructure;

      if (this.table.id === 'directus_files') {
        this.droppable = true;
        options.url = app.API_URL + 'files';
        this.nestedCollection = new EntriesManager.FilesCollection({}, options);
      } else {
        this.nestedCollection = new EntriesCollection({}, options);
      }


      this.nestedCollection.on('change', function() {
        this.trigger('change');
      }, this);
    },

    constructor: function EntriesJunctionCollection(data, options) {
      NestedCollection.__super__.constructor.call(this, data, options);
    }

  });

  //return NestedCollection;
});
define('core/entries/EntriesModel',['require','exports','module','app','underscore','backbone','helpers/model','core/entries/EntriesJunctionCollection','core/UIManager','schema/SchemaManager','core/entries/EntriesCollection','core/EntriesManager'],function(require, exports, module) {

  

  var app                     = require('app'),
      _                       = require('underscore'),
      Backbone                = require('backbone'),
      ModelHelper             = require('helpers/model'),
      EntriesJunctionCollection = require('core/entries/EntriesJunctionCollection'),
      UIManager               = require('core/UIManager'),
      SchemaManager           = require('schema/SchemaManager');

  var nestedTypes = ['many_to_one', 'single_file'];

  var EntriesModel = module.exports = Backbone.Model.extend({

    inputs: {},

    addInput: function(attr, input) {
      this.inputs[attr] = input;
    },

    getInput: function(attr) {
      return this.inputs[attr];
    },

    parse: function(result) {

      this._lastFetchedResult = result;

      result = this.parseRelational(result);
      //result = this.parseDate(result);

      return result;
    },

    // The flatten option flattens many-one relationships so the id is returned
    // instead of the object
    get: function(attr, options) {
      var uiType, value;
      options = options || {};

      value = Backbone.Model.prototype.get.call(this, attr);

      if (options.flatten) {
        uiType = this.getStructure().get(attr).get('ui');
        var relationshipType = this.getStructure().get(attr).getRelationshipType();
        if ('MANYTOONE' === relationshipType && _.isObject(value) ) {
          value = value.get('id');
        }
      }

      return value;
    },

    // @todo: Why is this one called so many times?
    // @note: Use HTML5 form validation when possible
    validate: function(attributes, options) {
      var errors = [];
      var structure = this.getStructure();
      var isNothing = function(value) {
        return value === undefined || value === null || value === '' || (!app.isNumber(value) && !_.isDate(value) && _.isEmpty(value));
      };

      //only validates attributes that are part of the schema
      attributes = _.pick(attributes, structure.pluck('column_name'));

      _.each(attributes, function(value, key, list) {
        //Column
        var column = structure.get(key);

        // Don't validate hidden fields
        // @todo should this be adjusted since these fields are now posting in some cases?
        if (column.get('hidden_input')) {
          return;
        }

        // Don't validate ID
        if (key === 'id') {
          return;
        }

        var nullDisallowed = column.get('is_nullable') === 'NO';
        var ui = UIManager._getUI(column.get('ui'));
        var forceUIValidation = ui.forceUIValidation === true;
        var isNull = isNothing(value);

        var uiSettings = UIManager.getSettings(column.get('ui'));

        var skipSerializationIfNull = uiSettings.skipSerializationIfNull;

        var mess = (!forceUIValidation && !skipSerializationIfNull && nullDisallowed && isNull) ?
          'The field cannot be empty'
          : UIManager.validate(this, key, value);

        if (mess !== undefined) {
          errors.push({attr: key, message: mess});
        }
      }, this);

      if (errors.length > 0) return errors;
    },

    rollBack: function() {
      var data = this.parse(this._lastFetchedResult);
      return this.set(data);
    },

    parseDate: function(attributes) {
      if(!attributes) {
        return;
      }
      _.each(this.getStructure().getColumnsByType('datetime'), function(column) {
        if (attributes[column.id] !== null) {
          attributes[column.id] = new Date(attributes[column.id]);
        }
      });
      return attributes;
    },

    //@todo: this whole shebang should be cached in the collection
    parseRelational: function(attributes) {
      var structure = this.getStructure();
      var relationalColumns = structure.getRelationalColumns();
      var EntriesCollection = require("core/entries/EntriesCollection");

      var EntriesManager = require("core/EntriesManager");

      _.each(relationalColumns, function(column) {
        var id = column.id;
        var tableRelated = column.getRelated();
        var relationshipType = column.getRelationshipType();
        //var value = attributes[id];
        var hasData = attributes[id] !== undefined;
        var ui = structure.get(column).options;

        switch (relationshipType) {
          case 'MANYTOMANY':
          case 'ONETOMANY':
            var columns = [];
            if (ui.get('visible_columns')) {
              // Clean whitespaces
              columns = ui.get('visible_columns').split(',').map(function(column) {
                return column.trim();
              });
            }
            var value = attributes[id] || [];
            var options = {
              table: SchemaManager.getTable(tableRelated),
              structure: SchemaManager.getColumns('tables', tableRelated),
              parse:true,
              filters: {columns_visible: columns},
              privileges: SchemaManager.getPrivileges(tableRelated)
              //preferences: app.preferences[column.get('related_table')],
            };


            // make sure that the table exists
            // @todo move this to column schema?
            if (options.table === undefined) {
              throw "Directus Error! The related table '" + tableRelated + "' does not exist! Check your UI settings for the field '" + id + "' in the table '" + this.collection.table.id + "'";
            }

            // make sure that the visible columns exists
            // todo move this to ??
            var diff = _.difference(columns, options.structure.pluck('column_name'));
            if (diff.length > 0) {
              throw "Directus Error! The column(s) '" + diff.join(',') + "' does not exist in related table '" + options.table.id + "'. Check your UI settings";
            }

            if (relationshipType === 'ONETOMANY') {
              // Provide model to prevent loading issues
              options.model = EntriesModel;
              attributes[id] = new EntriesCollection(value, options);
              break;
            }

            if (relationshipType === 'MANYTOMANY') {
              options.junctionStructure = SchemaManager.getColumns('tables', column.relationship.get('junction_table'));
              attributes[id] = new EntriesJunctionCollection(value, options);
            }

            break;

          case 'MANYTOONE':
            var data = {};

            if (attributes[id] !== undefined && attributes[id] !== null) {
              data = _.isObject(attributes[id]) ? attributes[id] : {id: attributes[id]};
            }

            var collectionRelated = EntriesManager.getInstance(tableRelated);
            var ModelRelated = collectionRelated.model;

            attributes[id] = new ModelRelated(data, {collection: collectionRelated});

            break;
        }

        attributes[id].parent = this;

      }, this);

      return attributes;
    },

    //@todo: This is maybe a hack. Can we make the patch better?
    diff: function(key, val, options) {
      var attrs, changedAttrs = {};
      if (typeof key === 'object') {
        attrs = key;
        options = val;
      } else {
        (attrs = {})[key] = val;
      }

      _.each(attrs, function(val, key) {
        if (this.get(key) !== val) changedAttrs[key] = val;
      },this);

      //Always pass id
      changedAttrs[this.idAttribute] = this.id;

      return changedAttrs;
    },

    sync: function(method, model, options) {

      var isModel,
          isCollection,
          self = this,
          attributes = this.attributes;

      if (method === 'patch' && options.includeRelationships) {

        var relationalColumns = this.getStructure().getRelationalColumns();
        //var relationalAttributes = _.pick(this.attributes, relationalKeys);

        _.each(relationalColumns, function(column) {
            var key = column.id;
            var value = attributes[key];

            // omit if the user has not permission to edit the field
            if (!self.canEdit(key)) return;

            // Some one-manys are not nested objects and will not need any special treatment
            if (!_.isObject(value)) return;

            // Check if it is a one-many and if it should be deleted!
            if ('MANYTOONE' === column.getRelationshipType() && _.isEmpty(value.attributes)) {
              options.attrs[key] = null;
              return;
            }

            // Add foreign data to patch. Only add changed attributes
            value = value.toJSON({changed: true});

            if (!_.isEmpty(value)) {
              options.attrs[key] = value;
            }

        }, this);
      }

      if (options.ignoreWriteFieldBlacklisted) {
        options.attrs = _.omit(options.attrs, this.getWriteFieldBlacklist());
      }

      return Backbone.sync.apply(this, [method, model, options]);
    },

    // returns true or false
    isMine: function() {
      var myId = parseInt(app.users.getCurrentUser().id,10),
          magicOwnerColumn = (this.collection !== null) ? this.collection.table.get('user_create_column') : null,
          magicOwnerId = this.get(magicOwnerColumn);

      //If magecownerid is model, grab the id instead
      if(magicOwnerId instanceof Backbone.Model) {
        magicOwnerId = magicOwnerId.get('id');
      }

      return myId === magicOwnerId;
    },

    // bigedit trumps write black list
    // bigedit = edit others
    // edit = edit your own
    canEdit: function(attribute) {
      //@TODO: Actually Fix this Issue
      if(!this.collection) {
        return false;
      }
      var iAmTheOwner         = this.isMine(),
          privileges          = this.collection.privileges,
          bigeditPermission   = this.collection.hasPermission('bigedit'),
          editPermission      = this.collection.hasPermission('edit'),
          columnIsBlacklisted = !_.isEmpty(attribute) && this.collection.isWriteBlacklisted(attribute),
          isNew               = !this.has('id');

      return (isNew && !columnIsBlacklisted) || (!iAmTheOwner && bigeditPermission && !columnIsBlacklisted) || (iAmTheOwner && editPermission && !columnIsBlacklisted);
    },

    getWriteFieldBlacklist: function() {
      return this.collection.getWriteFieldBlacklist();
    },

    getReadFieldBlacklist: function() {
      return this.collection.getWriteFieldBlacklist();
    },

    isWriteBlacklisted: function(attribute) {
      return this.collection.isWriteBlacklisted(attribute);
    },

    isReadBlacklisted: function(attribute) {
      return this.collection.isReadBlacklisted(attribute);
    },

    canDelete: function() {
      var iAmTheOwner = this.isMine(),
          canDelete = this.collection.hasPermission('delete'),
          canBigdelete = this.collection.hasPermission('bigdelete');

      return (!iAmTheOwner && canBigdelete) || (iAmTheOwner && canDelete);
    },

    toJSON: function(options, noNest) {
      var attributes = _.clone(this.attributes),
          isModel,
          isCollection;

      options = options || {};

      if (options.changed && !this.isNew()) {
        attributes = this.unsavedAttributes() || this.changed;
        // always include id
        if (this.id) {
          attributes.id = this.id;
        }
      }

      // expand relations
      _.each(this.attributes, function(value, key) {
        isModel = (value instanceof Backbone.Model);
        isCollection = (value instanceof Backbone.Collection);

        if (isModel || isCollection) {
          value = value.toJSON(options);

          //@todo keep an eye on why this wasn't serialized before
          //if (_.isEmpty(value)) return;

          attributes[key] = value;
        }

      });

      // Pick selected columns, useful for collection "save"
      if (options && options.columns) {
        attributes = _.pick(attributes, options.columns);
      }

      return attributes;
    },

    getStructure: function() {
      return this.structure;
    },

    getNewInstance: function(options) {
      options = options || {};

      return new EntriesModel({}, _.extend({
        structure: this.structure,
        table: this.table,
        privileges: this.privileges
      }, options));

    },

    getTable: function() {
      return this.table;
    },

    initialize: function(data, options) {
      this.on('invalid', function(model, errors) {
        var details = _.map(errors, function(err) { return '<b>'+app.capitalize(err.attr)+':</b> '+err.message; }).join('</li><li>');
        var error_id = (this.id)? this.id : 'New';
        details = app.capitalize(this.getTable().id) + ' (' + error_id + ')' + '<hr><ul><li>' + details + '</li></ul>';
        app.trigger('alert:error', 'There seems to be a problem...', details);
      });

      this.listenTo(this, 'sync', ModelHelper.setIdAttribute);
    },

    clone: function() {
      return new this.constructor(this.attributes, {
        collection: this.collection,
        table: this.table
      });
    },

    // we need to do this because initialize is called AFTER parse.
    constructor: function EntriesModel(data, options) {
      // inherit structure and table from collection if it exists
      //@todo: it needs a fallback or throw an exception
      // when options (collection) is not defined.
      options || (options = {});
      this.structure = options.collection ? options.collection.structure : options.structure;
      this.table = options.collection ? options.collection.table : options.table;
      this.privileges = options.collection ? options.collection.privileges : options.privileges;

      EntriesModel.__super__.constructor.call(this, data, options);
    }

  });

});

define('core/entries/EntriesCollection',['require','exports','module','backbone','helpers/model','core/collection','core/entries/EntriesModel'],function(require, exports, module) {

  

  var Backbone = require("backbone"),
      ModelHelper = require('helpers/model'),
      Collection = require("core/collection"),
      EntriesModel = require("core/entries/EntriesModel");

  var EntriesCollection = module.exports = Collection.extend({

    model: EntriesModel,

    rowsPerPage: 100,

    toJSON: function(options) {
      options = options || {};
      var result = EntriesCollection.__super__.toJSON.apply(this, [options]);
      if (options.changed) {
        result = _.filter(result, function(obj) { return !_.isEmpty(obj); });
      }
      return options.insideRows === true ? {rows: result} : result;
    },

    getColumns: function() {
      var filters = this.getFilters();
      var columns = [];
      var structure = this.structure;

      if (filters.columns_visible === undefined) {
        columns = structure.pluck('id');
      } else {
        columns = filters.columns_visible;
        // @todo: ensure that this always be an array everywhere.
        if (typeof columns === 'string') {
          columns = columns.split();
        }
      }

      columns = columns.filter(function(column) {
        return structure.get(column) && !structure.get(column).get('hidden_list');
      });

      if (this.preferences) {
        columns = _.intersection(columns, this.preferences.get('columns_visible').split(','));
      }

      return columns;
    },

    getFilter: function(key) {
      return (this.preferences && this.preferences.has(key)) ? this.preferences.get(key) : this.filters[key];
    },

    getFilters: function() {
      var preferences = this.preferences ? this.preferences.toJSON() : {};
      var filters = _.clone(this.filters);

      //Temporary fix to turn columns_visible into an array. @todo: Move this to the preferences object
      if (preferences.hasOwnProperty('columns_visible')) {
        preferences.columns_visible = preferences.columns_visible.split(',');
      }

      var result = _.extend(filters, _.pick(preferences, 'columns_visible', 'sort', 'sort_order', 'status'));

      // preferences normally trump filters, this is an edge case
      // @todo fix the data structure to make this logic less wierd
      if (this.filters.hasOwnProperty('columns_visible')) {
        result.columns_visible = this.filters.columns_visible;
      }

      return result;
    },

    updateActiveCount: function(diff) {
      if(!this.table.has('active')) {
        return;
      }

      switch (this.getFilter('status')) {
        case '1':
          this.table.set({'active': this.table.get('active') - diff});
          break;
        case '2':
          this.table.set({'inactive': this.table.get('inactive') - diff});
          break;
        case '0':
          this.table.set({'trash': this.table.get('trash') - diff});
          break;
      }
    },

    saveAll: function(options) {
      return this.save(this.models, options);
    },

    save: function(models, options) {
      options = options || {};
      var originalURL = this.url;
      var collection = this;
      var method = options.patch ? 'patch' : 'update';
      var success = options.success;

      // if there's not models set
      // get all the collection models
      if (!models) {
        models = collection.models;
      }

      if (method === 'patch') {
        options.attrs = {rows: models.map(function(model) {
          return model.toJSON({changed: true});
        })};
      } else {
        // @note: to support the API expecting a all rows inside rows property.
        options.insideRows = true;
      }

      var sync = function () {
        collection.trigger('sync');
      };

      options.success = function(resp) {
        if (options.wait) {
          sync();
        }

        if (success) {
          success(collection, resp, options);
        }
      };

      this.url += '/bulk';
      var xhr = this.sync(method, this, options);
      this.url = originalURL;
      // @removed we need to wait on success
      // to trigger sync
      // -----------------------------------
      // This was removed due to a issue with sorting
      // On listing page.
      // It will save the sort correctly
      // But it will render with old values
      // but will stay as reference if something happen soon
      // and reveal the reason why it was here.
      // this.trigger('sync');
      // waiting should do the trick :)

      if (!options.wait) {
        sync();
      }

      return xhr;
    },

    destroy: function(models, options) {
      options || (options = {});
      var collection = this;
      var originalURL = this.url;
      var success = options.success;

      if (!models) {
        models = collection.models;
      }

      options.data = JSON.stringify({rows: models});

      var destroy = function() {
        _.each(models, function(model) {
          if (!(model instanceof Backbone.Model)) {
            model = collection.get(model);
          }

          model.trigger('destroy', model, model.collection, options);
        });

        collection.trigger('destroy sync');
      };

      options.success = function(resp) {
        if (options.wait) {
          destroy();
        }

        if (success) {
          success(collection, resp, options);
        }
      };

      this.url += '/bulk';
      this.sync('delete', this, options);
      this.url = originalURL;

      if (!options.wait) {
        destroy();
      }
    },

    destroyAll: function(options) {
      this.destroy(this.toJSON(), options);
    },

    clone: function() {
      var options = {
        table: this.table,
        structure: this.structure,
        privileges: this.privileges,
        rowsPerPage: this.rowsPerPage
      };

      return new this.constructor(this.models, _.extend(options, {
        model: this.model,
        comparator: this.comparator
      }));
    },

    setFilter: function(key, value, options) {
      var attrs, preferencesHasChanged = false;
      if (key === null || typeof key === 'object') {
        attrs = key;
      } else {
        (attrs = {})[key] = value;
      }
      _.each(attrs, function(value, key) {
        if (this.preferences && this.preferences.has(key)) {
          preferencesHasChanged = true;
          this.preferences.set(key, value, {silent: true});
        } else {
          this.filters[key] = value;
        }
      },this);

      if (preferencesHasChanged) this.preferences.save();
    },

    hasColumn: function(columnName) {
      return this.structure.get(columnName) !== undefined;
    },

    hasPermission: function(permissionType) {
      var permissionLevel = 1;
      var permissionName = permissionType;
      if (permissionType.indexOf('big') === 0) {
        permissionLevel = 2;
        permissionName = permissionType.substr(3);
      }

      if (this.privileges && this.privileges.has('allow_' + permissionName) && permissionLevel <= this.privileges.get('allow_' + permissionName)) {
        return true;
      }

      return false;
    },

    getFieldBlacklist: function(permission) {
      var fieldBlacklist = [];
      if (this.privileges) {
        fieldBlacklist = this.privileges.get(permission + '_field_blacklist') || '';
        fieldBlacklist = fieldBlacklist.split(',');
      }

      return fieldBlacklist;
    },

    can: function(permission) {
      var privileges = this.privileges;
      if (permission.indexOf('allow_') !== 0) {
        permission = 'allow_' + permission;
      }

      return (privileges && this.privileges.get(permission) > 0);
    },

    canView: function() {
      return this.can('view');
    },

    canEdit: function() {
      return this.can('edit');
    },

    canAdd: function() {
      return this.can('add')
    },

    canDelete: function() {
      return this.can('delete');
    },

    getWriteFieldBlacklist: function() {
      return this.getFieldBlacklist('write');
    },

    getReadFieldBlacklist: function() {
      return this.getFieldBlacklist('read');
    },

    isWriteBlacklisted: function(attribute) {
      return _.contains(this.getWriteFieldBlacklist(), attribute);
    },

    isReadBlacklisted: function(attribute) {
      return _.contains(this.getReadFieldBlacklist(), attribute);
    },

    initialize: function(models, options) {
      this.structure = options.structure;
      this.privileges = options.privileges;
      this.table = options.table;

      this.listenTo(this, 'sync', ModelHelper.setIdAttribute);

      if (options.rowsPerPage) this.rowsPerPage = options.rowsPerPage;
      if (options.filters) this.filters = options.filters;

      this.url = options.url || this.table.get('url') + '/rows';

      this.active = this.table.get('active');

      this.filters = _.extend({
        currentPage: 0,
        perPage: this.rowsPerPage,
        sort: 'id',
        sort_order: 'ASC'
      }, this.filters);

      // do we got a sort column?
      // let sort it by that instead please
      if(this.structure.get('sort')) {
        this.filters['sort'] = 'sort';
      }

      this.filters['status'] = '1,2';

      if (options.preferences) {
        this.preferences = options.preferences;
        this.preferences.on('change', function() { this.trigger('change'); }, this);
      }
    },

    getNewInstance: function(options) {
      options = options || {};

      var entriesOptions = {
        structure: this.structure,
        table: this.table,
        privileges: this.privileges,
        url: this.url,
        filters: this.filters,
        preferences: this.preferences
      };

      if (options.omit) {
        entriesOptions = _.omit(entriesOptions, options.omit);
      }

      return new EntriesCollection([], entriesOptions);
    },

    parseHeaders: function(response) {
      if (response.total !== undefined) {
        this.table.set('total', response.total, {silent: true});
      }
      var that = this;
      app.statusMapping.mapping.forEach(function(status) {
        if(response[status.name]) {
          that.table.set(status.name, response[status.name], {silent: true});
        }
      });
    },

    parse: function(response) {
      if (_.isEmpty(response)) return;

      // Parse table headers
      this.parseHeaders(response);

      return response.rows;
    },

    constructor: function EntriesCollection(data, options) {
      EntriesCollection.__super__.constructor.call(this, data, options);
    }

  });

});

define('modules/users/UsersModel',[
  'app',
  'backbone',
  'core/entries/EntriesModel',
  'moment'
],

function(app, Backbone, EntriesModel, moment) {

  return EntriesModel.extend({

    getAvatar: function() {
      var currentUserAvatar = this.get('avatar');
      if (this.get('avatar_file_id') && this.get('avatar_file_id').has('name')) {
        currentUserAvatar = this.get('avatar_file_id').makeFileUrl(true);
      } else if(!currentUserAvatar) {
        currentUserAvatar = this.getDefaultAvatar();
      } else {
        currentUserAvatar = currentUserAvatar.replace('?s=100','?s=200');
      }

      return currentUserAvatar;
    },

    getDefaultAvatar: function() {
      return app.PATH + 'assets/img/missing-directus-avatar.png';
    },

    updateLastRoute: function(route, history) {
      var currentPath = history.fragment;
      var queryString = history.location.search || '';
      var lastPage = JSON.stringify({
        'path': currentPath + encodeURIComponent(queryString),
        'route': route
      });

      this.save({'last_page': lastPage, 'last_access': moment().format('YYYY-MM-DD HH:mm')}, {
        patch: true,
        global: false,
        silent: true,
        wait: true,
        validate: false,
        url: this.url() + "?skip_activity_log=1"
      });
    }

  });

});

define('modules/users/UsersCollection',[
  'app',
  'backbone',
  'core/entries/EntriesCollection',
  'core/t',
  'modules/users/UsersModel'
],

function(app, Backbone, EntriesCollection, __t, UsersModel) {

  return EntriesCollection.extend({

    model: UsersModel,

    getCurrentUser: function() {
      var authenticatedUser = app.authenticatedUserId;
      return this.get(authenticatedUser.id);
    },

    get: function(id) {
      var user = EntriesCollection.__super__.get.call(this, id);
      if (!_.isObject(id) && !user) {
        user = new UsersModel({
          id: id,
          first_name: __t('a_missing_or_removed_user'),
          last_name: ''
        });
      }

      return user;
    },

    initialize: function() {
      EntriesCollection.prototype.initialize.apply(this, arguments);
    }

  });

});

define('modules/files/FilesModel',[
  'app',
  'underscore',
  'backbone',
  'core/entries/EntriesModel',
  'core/notification',
  'core/t',
  'utils',
  'helpers/file'
],

function(app, _, Backbone, EntriesModel, Notification, __t, Utils, File) {
  var FilesModel = EntriesModel.extend({

    initialize: function() {
      EntriesModel.prototype.initialize.apply(this, arguments);
    },

    makeFileUrl: function(thumbnail) {
      var url;

      if (thumbnail) {
        url = this.get('thumbnail_url');
      } else {
        url = this.get('url');
      }

      return url;
    },

    toJSON: function() {
      var atts = FilesModel.__super__.toJSON.call(this);
      if (!atts) {
        atts = _.clone(this.attributes);
      }

      // TODO: avoid omitting url and html at some point
      // rewrite this so we omit these values when we really want it to be omitted.
      return _.omit(atts, 'thumbnailData', 'url', 'file_url', 'file_thumb_url', 'old_thumbnail_url', 'thumbnail_url', 'html');
    },

    formatTitle: function(name) {
      if (name.indexOf('.') >= 0) {
        var extension = name.split('.').pop();
        name = name.slice(0, name.indexOf('.' + extension));
      }

      name = name.replace(/[_-]/g, ' ');

      return name;
    },

    setFile: function(file, allowedTypes, fn) {
      if (!this.isFileAllowed(file, allowedTypes)) {
        return false;
      }

      if (app.settings.isMaxFileSizeExceeded(file)) {
        Notification.error(__t('max_file_size_exceeded_x_x', {
          size: app.settings.getMaxFileSize(),
          unit: app.settings.getMaxFileSizeUnit()
        }));

        return false;
      }

      var model = this;
      File.getDataFromInput(file, function(fileData, details, file) {
        File.isImage(fileData, function(isImage) {
          var modelData = {
            id: undefined,
            name: file.name,
            title: model.formatTitle(file.name),
            size: file.size,
            type: file.type,
            charset: 'binary',
            data: fileData
          };

          if (isImage) {
            File.resizeFromData(fileData, 200, 200, function(thumbnailData) {
              model.set(_.extend(modelData, {
                thumbnailData: thumbnailData,
                width: details.width,
                height: details.height
              }));
              if (_.isFunction(fn)) {
                fn(_.clone(model.attributes));
              }
              model.trigger('sync');
            });
          } else {
            model.set(_.extend(modelData, {
              url: fileData
            }));
            if (_.isFunction(fn)) {
              fn(_.clone(model.toJSON()));
            }
            model.trigger('sync');
          }
        });
      });
    },

    // setData will try to get thumbnail from a base64
    // this is used by retrieve links
    setData: function(item, allowedTypes) {
      var model = this;

      if (!this.isFileAllowed(item, allowedTypes)) {
        return false;
      }

      File.resizeFromData(item.data, 200, 200, function(thumbnailData) {
        item.thumbnailData = thumbnailData;
        model.set(item);
        model.trigger('sync');
      });
    },

    setLink: function(url, allowedTypes) {
      var model = this;
      app.sendLink(url, function(data) {
        var item = data[0];
        item[app.statusMapping.status_name] = app.statusMapping.active_num;
        // Unset the model ID so that a new file record is created
        // (and the old file record isn't replaced w/ this data)
        item.id = undefined;
        item.user = model.userId;

        model.setData(item, allowedTypes);
      });
    },

    isFileAllowed: function(file, allowedTypes) {
      var allowed = this.isTypeAllowed(file.type, allowedTypes);

      if (!allowed && this.hasExtension(file.name)) {
        allowed = this.isExtensionAllowed(file.name, allowedTypes);
      }

      // this should not be here
      // but, we will let it slide for now.
      if (!allowed) {
        app.router.openModal({type: 'alert', text: 'This type of file is not allowed'});
      }

      return allowed;
    },

    isAllowed: function(allowedTypes) {
      return this.isFileAllowed(this.toJSON(), allowedTypes);
    },

    isTypeAllowed: function(fileType, allowedTypes) {
      // if there's not fileType but allowedMimeTypes provided
      // by default the file is not allowed
      var allowed = (!fileType && allowedTypes) ? false : true;

      if (fileType && allowedTypes) {
        var self = this;
        allowed = allowedTypes.split(',').some(function (allowedType) {
          return self.isMimeType(fileType, allowedType) || self.isType(fileType, allowedType);
        });
      }

      return allowed;
    },

    isMimeType: function(mimeType, allowedMimeType) {
      mimeType = mimeType || this.type;
      if (!_.isString(mimeType)) {
        return false;
      }

      if (allowedMimeType.endsWith('/*')) {
        return allowedMimeType.split('/')[0] === mimeType.split('/')[0];
      }

      return allowedMimeType === mimeType;
    },

    hasExtension: function(name) {
      return (_.isString(name) && name.indexOf('.') >= 0);
    },

    getExtension: function(name) {
      return this.hasExtension(name) ? name.split('.').pop() : null;
    },

    isExtensionAllowed: function(name, allowedTypes) {
      return this.hasExtension(name) ? this.isType(this.getExtension(name), allowedTypes) : false;
    },

    getSubType: function(type) {
      if (type.indexOf('/') >= 0) {
        type  = type.split('/').pop();
      }

      return type;
    },

    isType: function(type, allowedType) {
      if (!_.isString(allowedType)) {
        return false;
      }

      allowedType = this.getSubType(allowedType);
      type = this.getSubType(type);

      return _.isString(type) && type.toLowerCase() === allowedType.toLowerCase();
    },

    constructor: function FilesModel(data, options) {
      FilesModel.__super__.constructor.call(this, data, options);
    }

  });

  return FilesModel;

});

define('modules/files/FilesCollection',[
  "app",
  "backbone",
  "core/entries/EntriesCollection",
  "modules/files/FilesModel"
],

function(app, Backbone, EntriesCollection, FilesModel) {

  return EntriesCollection.extend({

    model: FilesModel,

    initialize: function() {
      EntriesCollection.prototype.initialize.apply(this, arguments);
    }

  });

});
define('core/EntriesManager',['require','exports','module','./../schema/SchemaManager','./entries/EntriesCollection','modules/users/UsersCollection','modules/files/FilesCollection'],function(require, exports, module) {

  

  var SchemaManager      = require('./../schema/SchemaManager'),
      EntriesCollection  = require('./entries/EntriesCollection'),
      UsersCollection    = require('modules/users/UsersCollection'),
      FilesCollection    = require('modules/files/FilesCollection');

  // Contains collections that should be persistent
  var usersInstance;
  var filesInstance;
  var groupsInstance;
  var activityInstance;
  var messagesInstance;

  var apiURL = '',
      rowsPerPage = 100;

  function getNewCoreInstance(tableName) {
    switch (tableName) {
      case 'directus_users':
        return new UsersCollection([], _.extend({
          rowsPerPage: 3000,
          url: apiURL + 'tables/directus_users/rows',
          filters: {columns_visible: ['avatar', 'first_name', 'last_name', 'group', 'email', 'position', 'location', 'phone', 'last_access'], active:1}
        }, SchemaManager.getFullSchema('directus_users')));

      case 'directus_files':
        return new FilesCollection([], _.extend({
          rowsPerPage: rowsPerPage,
          url: apiURL + 'files',
          filters: {columns_visible: ['name','title','size', 'type', 'url', 'user','date_uploaded', 'storage_adapter', 'width', 'height']}
        }, SchemaManager.getFullSchema('directus_files')));

      case 'directus_groups':
        return new EntriesCollection([], _.extend({
          rowsPerPage: rowsPerPage,
          url: apiURL + 'groups/'
        }, SchemaManager.getFullSchema('directus_groups')));

      case 'directus_activity':
        return new EntriesCollection([], _.extend({
          rowsPerPage: rowsPerPage,
          url: apiURL + 'activity/',
          filters: {columns_visible: ['activity','datetime','user'], sort_order: 'DESC'}
        }, SchemaManager.getFullSchema('directus_activity')));
    }
  }

  function setup(options) {
    apiURL = options.apiURL;
    rowsPerPage = options.rowsPerPage;

    // Setup Directus Users
    usersInstance = getNewCoreInstance('directus_users');
    filesInstance = getNewCoreInstance('directus_files');
    activityInstance = getNewCoreInstance('directus_activity');
    groupsInstance = getNewCoreInstance('directus_groups');
  }

  function getInstance(tableName, options) {
    options = (options || {});
    var newCoreInstance = options.getNewInstance === true;

    switch (tableName) {
      case 'directus_users':
        return newCoreInstance ? getNewCoreInstance(tableName) : usersInstance;

      case 'directus_files':
        return newCoreInstance ? getNewCoreInstance(tableName) : filesInstance;

      case 'directus_groups':
        return newCoreInstance ? getNewCoreInstance(tableName) : groupsInstance;

      case 'directus_activity':
        return newCoreInstance ? getNewCoreInstance(tableName) : activityInstance;
    }

    options = options || {};

    var defaultOptions = _.extend(SchemaManager.getFullSchema(tableName), options);

    if (defaultOptions.privileges === undefined) {
      throw "You lack privileges for `"+ tableName +"`";
    }

    var entries = new EntriesCollection([], _.extend({
      rowsPerPage: rowsPerPage
    }, defaultOptions));

    return entries;

  }

  // @TODO: A better separation of this two methods
  function getNewInstance(tableName, options) {
    options = (options || {});
    options.getNewInstance = true;
    return getInstance(tableName, options);
  }

  module.exports.getInstance = getInstance;
  module.exports.getNewInstance = getNewInstance;
  module.exports.setup = setup;

  module.exports.FilesCollection = FilesCollection;

});

//  bookmarks.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com


define('core/bookmarks',[
  "app",
  "backbone",
  "core/EntriesManager",
  'core/t',
  'core/notification',
],

function(app, Backbone, EntriesManager, __t, Notification) {

  

  var Bookmarks = {};

  Bookmarks.Collection = Backbone.Collection.extend({
    constructor: function(models, options) {
      this.url = app.API_URL + 'bookmarks/';

      this.isCustomBookmarks = options.isCustomBookmarks || false;
      if (!this.isCustomBookmarks) {
        options.comparator = this._comparator;
      }

      Backbone.Collection.prototype.constructor.apply(this, [models, options]);
    },

    _comparator: function(a, b) {
      if (a.get('title') < b.get('title')) {
        return -1;
      }

      if (a.get('title') > b.get('title')) {
        return 1;
      }

      return 0;
    },

    setActive: function(route) {
      var activeModel;
      var routeURL = route;
      var found = false;

      _.each(this.models, function(model) {
        model.unset('active_bookmark', {silent: true});
        if (routeURL == model.get('url') && !found) {
          activeModel = model;
          found = true;
        }
      });

      if (activeModel) {
        activeModel.set({'active_bookmark': true});
      }
    },

    addTable: function(tableModel) {
      this.add(new Backbone.Model({
        icon_class: '',
        title: app.capitalize(tableModel.get('table_name')),
        url: 'tables/' + tableModel.get('table_name'),
        section: 'table'
      }));
    },

    addNewBookmark: function(data) {
      data.user = data.user.toString();
      if(this.findWhere(data) === undefined) {
        this.create(data);
      }
    },

    removeBookmark: function(data) {
      if (data.user) {
        data.user = data.user.toString();
      }

      var model = this.findWhere(data);

      if(model !== undefined) {
        model.destroy();
        this.remove(model);
      }
    },

    isBookmarked: function(title) {
      if(this.findWhere({'title':title}) !== undefined) {
        return true;
      }
      return false;
    }
  });

  Bookmarks.View = Backbone.Layout.extend({
    template: "bookmarks-list",

    tagName: "ul",

    attributes: {
      class:"row"
    },

    events: {
      'click #saveSnapshotBtn': 'saveSnapshot',
      'click .remove-snapshot': function(e) {
        e.stopPropagation();
        e.preventDefault();

        var bookmarkId = $(e.target).parents('.sidebar-subitem').data('id');
        var bookmark = this.collection.get(bookmarkId);
        if (bookmark) {
          var title = bookmark.get('title');
          app.router.openModal({type: 'confirm', text: __t('delete_the_bookmark_x', {title: title}), callback: function() {
            bookmark.destroy();
          }});
        }

        return false;
      }
    },

    saveSnapshot: function() {
      var that = this;
      app.router.openModal({type: 'prompt', text: __t('what_would_you_like_to_name_this_bookmark'), callback: function(name ) {
        if(name === null || name === "") {
          Notification.error(__t('please_fill_in_a_valid_name'));
          return;
        }

        var currentCollection = app.router.currentCollection;
        if (typeof currentCollection !== 'undefined') {
          //Save id so it can be reset after render
          var defaultId = currentCollection.preferences.get('id');
          that.listenToOnce(currentCollection.preferences, 'sync', function() {
            if(defaultId) {
              currentCollection.preferences.set({title:null, id: defaultId});
            }
          });

          var schema = app.schemaManager.getFullSchema( currentCollection.table.id );
          var preferences = schema.preferences;
          preferences.unset('id');
          // Unset Id so that it creates new Preference
          preferences.set({title: name});
          preferences.save();
        }

        that.pinSnapshot(name);
      }});
    },

    pinSnapshot: function(title) {
      var data = {
        title: title,
        url: Backbone.history.fragment + "/pref/" + encodeURIComponent(title),
        icon_class: 'icon-search',
        user: app.users.getCurrentUser().get("id"),
        section: 'search'
      };
      if(!app.getBookmarks().isBookmarked(data.title)) {
        app.getBookmarks().addNewBookmark(data);
      }
    },

    serialize: function() {
      var bookmarks = {table:[],search:[],extension:[],other:[]};
      var isCustomBookmarks = this.isCustomBookmarks;

      this.collection.each(function(model) {
        var bookmark = model.toJSON();
        var currentUserGroup = app.users.getCurrentUser().get('group');
        // force | remove from activity from navigation
        if (bookmark.title === 'Activity') return false;

        // skip system nav to an user
        // if the user's group aren't allow to
        // see it on the navigation panel
        var skipSystemNav = false;
        // @todo: bookmark.title to id or url.
        switch (bookmark.title) {
          case 'Activity':
            skipSystemNav = currentUserGroup.get('show_activity') === 0 ? true : false;
            break;
          case 'Files':
            skipSystemNav = currentUserGroup.get('show_files') === 0 ? true : false;
            break;
          case 'Users':
            skipSystemNav = currentUserGroup.get('show_users') === 0 ? true : false;
            break;
          case 'Messages':
            skipSystemNav = currentUserGroup.get('show_messages') === 0 ? true : false;
            break;
        }

        if (skipSystemNav) {
          return false;
        }

        if(bookmarks[bookmark.section]) {
          bookmarks[bookmark.section].push(bookmark);
        } else if(isCustomBookmarks) {
          if(!bookmarks[bookmark.section]) {
            bookmarks[bookmark.section] = [];
            bookmarks[bookmark.section].isCustomBookmark = true;
          }
          bookmarks[bookmark.section].push(bookmark);
        }
      });

      if (_.isArray(bookmarks.other)) {
        _.each(bookmarks.other, function(bookmark) {
          bookmark.title = __t(bookmark.title.toLowerCase());
        });
      }

      var data = {bookmarks: bookmarks, isCustomBookmarks: this.isCustomBookmarks};

      if(Backbone.history.fragment === "tables") {
        data.tablesActive = true;
      }

      return data;
    },

    initialize: function() {

      this.isCustomBookmarks = this.collection.isCustomBookmarks || false;

      var that = this;
      //For some reason need to do this and that....
      this.collection.on('add', function() {
        that.collection.setActive(Backbone.history.fragment);
        that.collection.sort();
        that.render();
      });

      this.collection.on('remove', function() {
        that.render();
      });

      var messageModel = this.collection.where({url: 'messages'});
      if(messageModel) {
        messageModel = messageModel[0];
        if(messageModel) {
          messageModel.set({unread: app.messages.unread > 0}, {silent: true});
        }
      }

      app.messages.on('sync change add', function() {
        var messageModel = this.collection.where({url: 'messages'});
        if(!messageModel) {
          return;
        }

        messageModel = messageModel[0];
        var unread = app.messages.where({read: '0'});

        if(unread.length>0 && messageModel.get('unread') === false) {
          messageModel.set({unread: true}, {silent: true});
          this.render();
        } else if(unread.length===0 && messageModel.get('unread') === true) {
          messageModel.set({unread: false}, {silent: true});
          this.render();
        }
      }, this);

      // @todo: make this global application events cleaner
      var self = this;
      app.on('tables:preferences', function(widget, collection) {
        if (app.router.loadedPreference) {
          app.router.loadedPreference = undefined;
          self.setActive('tables/' + collection.table.id);
        }
      });

      app.on('tables:change:attributes:hidden', function(model, attribute) {
        if (model.get(attribute) === true) {
          self.removeBookmark(model);
        } else {
          self.addBookmark(model);
        }
      });

      app.on('tables:change:permissions', function(table, permission) {
        if (permission.get('allow_view') > 0) {
          self.addBookmark(table);
        } else {
          self.removeBookmark(table);
        }
      })
    },

    addBookmark: function(model) {
      var title = app.capitalize(model.get('table_name'));
      if (!this.collection.isBookmarked(title)) {
        this.collection.addTable(model);
      }
    },

    removeBookmark: function(model) {
      // @TODO: bookmark must have an Identification attribute.
      this.collection.removeBookmark({
        section: 'table',
        title: app.capitalize(model.get('table_name'))
      });
    },

    setActive: function(route) {
      this.collection.setActive(route);
      this.render();
    }

  });

  return Bookmarks;
});

define('core/ExtensionManager',['require','exports','module','underscore','jquery'],function(require, exports, module) {

  

  var _        = require('underscore'),
      jQuery   = require('jquery');

  // Private
  var extensions = {};

  module.exports = {

    register: function(ext) {
      _.each(ext, function(extension) {
        extension.path = 'ext/' + encodeURIComponent(extension.id);
        extensions[extension.id] = extension;
      },this);
    },

    load: function(paths) {
      var self = this;
      var dfd = new jQuery.Deferred();

      require(paths, function() {
        self.register(_.values(arguments));
        dfd.resolve();
      });

      return dfd;
    },

    getInstance: function(id) {
      return new extensions[id].Router('ext/' + id);
    },

    getIds: function() {
      return _.keys(extensions);
    },

    getInfo: function(id) {
      return extensions[id];
    }

  };

});

define('core/edit',['require','exports','module','app','handlebars','./UIManager'],function(require, exports, module) {

  

  var app = require('app');
  var Handlebars = require('handlebars');
  var UIManager = require('./UIManager');

  var UIContainer = Backbone.Layout.extend({

    tagName: 'li',

    attributes: {
      'class': 'batchcontainer'
    },

    template: 'uicontainer',

    events: {
      'click [name="batchedit"]': function() {
        this.$('.fieldset-smoke').toggle();
      }
    },

    serialize: function() {
      // editing UIs settings does not have a specified table assigned to it.
      var tableInfo = this.model.collection.table;
      var tableName;
      if (tableInfo) {
        tableName = tableInfo.id
      }

      return {
        id: this.model.id,
        comment: this.model.get('comment'),
        batchEdit: this.options.batchEdit,
        required: this.model.get('required'),
        // Let assume for now that all tables that start with directus_ are core tables
        // TODO: we should store all our core tables names
        isCoreTable: tableName ? tableName.indexOf('directus_') === 0 : false,
        table: tableName
      };
    },

    afterRender: function() {
      var obj = this.view || this.model;
      if (obj.isRequired()) {
        this.$el.addClass('required');
      }
    },

    initialize: function(options) {
      this.view = options.view;
    }
  });

  var EditView = module.exports = Backbone.Layout.extend({

    tagName: "form",

    hiddenFields: [
      'id',
      'sort'
    ],

    template: Handlebars.compile("<ul class='fields'></ul>"),

    beforeRender: function() {
      var views = {};

      this.structure.each(function(column) {

        // Skip ID
        // if('id' === column.id) {
        if (column.get('key') === 'PRI') {
          return;
        }

        if (this.model.isReadBlacklisted && this.model.isReadBlacklisted(column.id)) {
          return false;
        }

        //Skip magic owner column if we dont have bigedit
        if (this.model.table && this.model.table.get('user_create_column') === column.id && !this.model.collection.hasPermission('bigedit')) {
          return;
        }

        if (app.statusMapping.status_name === column.id) {
          var collection = this.model.collection;
          var canAdd = this.model.isNew() && collection.canAdd();
          var canEdit = !this.model.isNew() && collection.canEdit();
          if (!canAdd && !canEdit) {
            return;
          }

          if (this.options.collectionAdd) {
            this.model.set(app.statusMapping.status_name, app.statusMapping.active_num);
          }

          if(this.model.isNew()) {
            var tableStatusColumn = this.model.structure.get(app.statusMapping.status_name);
            if(tableStatusColumn && tableStatusColumn.get('default_value')) {
              this.model.set(app.statusMapping.status_name, tableStatusColumn.get('default_value'));
            } else {
              this.model.set(app.statusMapping.status_name, app.statusMapping.active_num);
            }
          }

          //Set this to be first field in edit table by modifiying groupings.
          if(this.model.table && this.model.table.get('column_groupings')) {
            var columnGrouping = this.model.table.get('column_groupings');
            this.model.table.set({'column_groupings': app.statusMapping.status_name + '^' + columnGrouping});
          }
        }

        var view = UIManager.getInputInstance(this.model, column.id, {structure: this.structure, inModal: this.inModal});
        if (this.model.addInput) {
          this.model.addInput(column.id, view);
        }

        // Display:none; hidden fields
        var isHidden = _.contains(this.hiddenFields, column.id);
        if (isHidden) {
          view.$el.css({'display':'none'});
        }

        if (view.isRequired()) {
          view.$el.addClass('required');
          column.set('required', true);
        }

        if (!isHidden) {
          var uiContainer = new UIContainer({
            model: column,
            batchEdit: this.options.batchIds !== undefined,
            view: view
          });
          uiContainer.insertView('.trow', view);
          views[column.id] = uiContainer;
        } else {
          this.insertView('.fields',view);
        }
      }, this);

      var that = this;
      if(this.model.table && this.model.table.get('column_groupings')) {
        // Does this honor user field permissions? Should switch to JSON with Settings interface
        // Format:
        // Section 1:title,key_image^Section 2:address,date_published
        var grouping = this.model.table.get('column_groupings');
        var i = 1;
        grouping.split('^').forEach(function(group) {
          var title = "";
          if(group.indexOf(':') !== -1) {
            title = group.substring(0, group.indexOf(':'));
            group = group.substring(group.indexOf(':') + 1);
          }
          var compileString = '<div class="section-header"><span class="big-label-text">' + title + '</span></div><div class="table-shadow"></div>';
          that.insertView('.fields', new Backbone.Layout({attributes: {class:'gutter-bottom-big table-shadow', id:'grouping_' + i}, template: Handlebars.compile(compileString)}));
          group.split(',').forEach(function(subgroup) {
            if(views[subgroup] !== undefined) {
              that.insertView('#grouping_' + i + ' div.table-shadow', views[subgroup]);
            }
          });
          i++;
        });
      } else {
        if(views[app.statusMapping.status_name]) {
          this.insertView('.fields', new Backbone.Layout({attributes: {class:'gutter-bottom-big table-shadow', id:'grouping_0'}}));
          this.insertView('#grouping_0', views[app.statusMapping.status_name]);
          delete views[app.statusMapping.status_name];
        }

        this.insertView('.fields', new Backbone.Layout({attributes: {class:'gutter-bottom-big table-shadow', id:'grouping_1'}}));
        for(var key in views) {
          that.insertView('#grouping_1', views[key]);
        }
      }
    },

    constructor: function (options) {
      Backbone.Layout.__super__.constructor.call(this, options);
      this.$el.addClass('two-column-form');
    },

    // Focus on first input
    afterRender: function() {
      var $first = this.$el.find(':input:first:visible');
      $first.focus();
      $first.val($first.val());

      // If this is a nested collection (to-Many) "Add" modal, preset & hide the parent foreign key.
      if(this.options.collectionAdd && !_.isEmpty(this.options.parentField)) {
        this.model.set(this.options.parentField.name, this.options.parentField.value);
        var $select = this.$el.find('[name=' + this.options.parentField.name + ']');
        $select.closest('fieldset').hide();
      }

    },

    data: function() {
      var data = this.$el.serializeObject();
      var whiteListedData = _.pick(data, this.visibleFields);
      if(this.model.getWriteFieldBlacklist) {
        whiteListedData = _.omit(whiteListedData, this.model.getWriteFieldBlacklist());
      }
      // check if any of the listed data has multiple values, then serialize it to string
      _.each(whiteListedData, function(value, key, obj) {
        if (_.isArray(value)) {
          obj[key] = value.join(',');
        }
      });

      return whiteListedData;
    },

    initialize: function(options) {

      var structureHiddenFields,
          optionsHiddenFields = options.hiddenFields || [];

      this.inModal = options.inModal || false;
      this.structure = options.structure || this.model.getStructure();

      if (this.structure === undefined) {
        throw new Error('The edit view will not work without a valid model schema');
      }

      // Hide fields defined as hidden in the schema
      structureHiddenFields = this.structure.chain()
        .filter(function(column) { return column.get('hidden_input'); })
        .pluck('id')
        .value();

      this.hiddenFields = _.union(optionsHiddenFields, structureHiddenFields, this.hiddenFields);
      this.visibleFields = _.difference(this.structure.pluck('id'), this.hiddenFields);


      // @todo rewrite this!
      this.model.on('invalid', function(model, errors) {
        //Get rid of all errors
        this.$el.find('.error-color').remove();
        this.$el.find('.error').removeClass('error');
        _.each(errors, function(item) {
          var $fieldset = $('#edit_field_' + item.attr);
          $fieldset.addClass('error');
          if ($fieldset.find('.error-color').length < 1) {
            $fieldset.append('<span class="error-color validation-error">'+item.message+'</span>');
          }
        });
      }, this);

      this.model.once('sync', function(e) {
        this.model.changed = {};
        this.render();
      }, this);
    }
  });

});

define('core/modal',[
  "app",
  "backbone"
],

function(app, Backbone) {

  


  var Modal = {};

  Modal.Prompt = Backbone.Layout.extend({

    template: 'modal',

    attributes: {
      'id': 'modal',
      'class': 'modal'
    },

    serialize: function() {
      var message = (this.options.text) ? this.options.text : '';
      var data = {message: message};

      switch(this.options.type) {
        case 'prompt':
          data.isPrompt = true;
          data.showInput = true;
          break;
        case 'yesnocancel':
          data.isYesNoCancelConfirm = true;
          break;
        case 'yesno':
          data.isYesNoConfirm = true;
          break;
        case 'alert':
          data.isAlert = true;
          break;
        default:
          data.isPrompt = true;
          break;
      }

      return data;
    },

    events: {
      'click #cancel': function() {
        this.close();
      },
      'click #save': function() {
        this.save();
      },
      'click #noBtn': function() {
        this.close();
        this.options.callback('no');
      },
      'click #yesBtn': function() {
        this.close();
        this.options.callback('yes');
      },
      'click #okBtn': function() {
        this.close();
      }
    },

    onKeydown: function(e) {
      var key = e.keyCode || e.which;
      //enter
      if (key === 13) {
        this.save();
      }
      // esc
      if (key === 27) {
        this.close();
      }
    },

    close: function() {
      $(document).off('keydown.modal');
      this.remove();
    },

    save: function() {
      var val ='';
      if(this.$el.find('input')) {
        val = this.$el.find('input').val();
      }

      if (_.isFunction(this.options.callback)) {
        this.options.callback(val);
      }

      this.close();
    },

    afterRender: function(view) {
      this.$el.find('input[type="text"]').focus();
    },

    initialize: function (options) {
      this.options = options;
      $(document).on('keydown.modal', _.bind(this.onKeydown, this));
    }
  });

  return Modal;
});

define('core/tableSimple',[
  "app",
  "backbone"
],

function(app, Backbone) {

  

  var TableSimple = Backbone.Layout.extend({

    events: {
      'click td' : function(e) {
        var id = $(e.target).closest('tr').attr('data-id');
        var route = Backbone.history.fragment.split('/');
        route.push(id);
        app.router.go(route);
      }
    },

    flashItem: function(entryID, bodyScrollTop) {
      document.body.scrollTop = parseInt(bodyScrollTop, 10) || 0;
      if(entryID) {
        this.$el.find('tr[data-id="' + entryID + '"]').flashRow();
      }
    },

    serialize: function() {
      var rows = this.collection.getRows();

      var bookmarks = app.getBookmarks();

      // Check permissions
      // @todo: filter this on the backend and get rid of this
      rows = _.filter(rows, function(row) {
        var privileges = app.schemaManager.getPrivileges(row.table_name);

        if (typeof privileges === 'undefined' || privileges === null) {
          return false;
        }

        // only return tables with view permissions and not hidden
        return privileges.get('allow_view') > 0  && privileges.get('nav_listed') > 0;
      });
      return {rows: rows, columns: this.collection.getColumns()};
    },

    initialize: function() {
      this.listenTo(app.router.v.main, 'flashItem', this.flashItem);
    }

  });

  return TableSimple;

});
define('core/directus',[
  "app",
  "core/entries/EntriesCollection",
  "core/entries/EntriesModel",
  "core/entries/EntriesJunctionCollection",
  "core/collection",
  "core/edit",
  "core/table/table.view",
  "core/modal",
  "core/tableSimple"
],

function(app, EntriesCollection, EntriesModel, EntriesNestedCollection, Collection, Edit, Table, Modal, TableSimple) {

  

  var Directus = {};

  //Directus.Files = Entries.FilesCollection;
  Directus.Collection = Collection;
  Directus.EntriesCollection = EntriesCollection;
  Directus.EditView = Edit;
  Directus.Table = Table;
  Directus.Modal = Modal;
  Directus.TableSimple = TableSimple;
  Directus.Model = EntriesModel;
  //Directus.FilesCollection = Structure.FilesCollection;

  Directus.SubRoute = Backbone.Router.extend({
    constructor: function(prefix) {
      var routes = {};

      // Prefix is optional, set to empty string if not passed
      prefix = prefix || "";

      // Allow for optionally omitting trailing /.  Since base routes do not
      // trigger with a trailing / this is actually kind of important =)
      if (prefix[prefix.length-1] === "/") {
        prefix = prefix.slice(0, prefix.length-1);
      }

      // Every route needs to be prefixed
      _.each(this.routes, function(callback, path) {
        if (path) {
          routes[prefix + path] = callback;
          return routes[prefix + path];
        }

        // If the path is "" just set to prefix, this is to comply
        // with how Backbone expects base paths to look gallery vs gallery/
        routes[prefix] = callback;
      });

      // Must override with prefixed routes
      this.routes = routes;

      // Required to have Backbone set up routes
      Backbone.Router.prototype.constructor.call(this);
    }
  });

  return Directus;
});

define('modules/activity/chart',[
  'app',
  'backbone',
  'core/directus',
  'moment'
],

function(app, Backbone, Directus, moment) {

  

  var Chart = Backbone.Layout.extend({

    tagName: 'div',

    template: 'modules/activity/activity-chart',

    attributes: {'class':'activity-module'},

    numberWithCommas: function(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },

    afterRender: function() {
      //////////////////////////////////////////////////////////////////////////////

      var animationTime = 1000;
      var me = this;
      var heightTotal = 0;
      var totals = {
        'days': 30,
        'all': 0,
        'files': 0,
        'system': 0,
        'deleted': 0,
        'edited': 0,
        'added': 0
      };

      $("td[data-sum]").each(function(index){
        if($(this).data('sum') > heightTotal){
          heightTotal = $(this).data('sum');
        }
      });

      $('.chart-key').text(heightTotal);

      $(".bar").each(function(index){
        var barTotal = $(this).attr("data-total");
        var barType = $(this).attr("data-type");
        var percentage = (150 / heightTotal);
        var heightPercentage = Math.floor(percentage * barTotal);
        $(this).animate({ height: heightPercentage}, animationTime, "swing");

        totals[barType] += parseInt(barTotal, 10);

      });

      // Get total activity (could/should be total active items)
      totals.all = totals.files + totals.system + totals.deleted + totals.edited + totals.added;

      //////////////////////////////////////////////////////////////////////////////

      $(".activity-total h2").each(function(index){

        var el = $(this);
        var type = el.attr("data-type");
        var total = totals[type];

        // Animate the element's value
        $({someValue: 0}).animate({someValue: total}, {
          duration: animationTime,
          easing:'swing',
          step: function() {
            el.text( me.numberWithCommas(Math.ceil(this.someValue)) );
          },
          complete: function() {
            el.text( me.numberWithCommas(this.someValue) );
          }
        });
      });
    },

    serialize: function() {
      var data = this.collection.map(function(model) {
        var data = {
          "table": model.get('table_name'),
          'time': moment(model.get('datetime')).fromNow(),
          "timestamp": model.get('datetime')
        };

        switch(model.get('action')) {
          case 'LOGIN':
            data.category = "system";
            break;
          case 'UPDATE':
            data.category = "edit";
            break;
          case 'ADD':
            data.category = "add";
            break;
          case 'DELETE':
            data.category = "delete";
            break;
          case 'REPLY':
            data.category = "message";
            break;
        }

        if(data.table === "directus_files") {
          data.category = "file";
        }
        if(data.table === "directus_ui") {
          data.category = "system";
        }
        if(data.table === "directus_messages") {
          data.category = "message";
        }

        return data;
      });

      //Filter out data that is set to hidden
      data = _.filter(data, function(item) {
        return !item.hidden;
      });

      // Order the data by timestamp
      data = _.sortBy(data, function(item) {
        return moment(item.timestamp);
      });

      var groupedData = [];

      data.forEach(function(group) {
        var date = moment(group.timestamp).format('YYYY-MM-DD');
        if(!groupedData[date]) {
          //If Today Have it say Today
          if(date === moment().format('YYYY-MM-DD')) {
            groupedData[date] = {title: "Today", data: []};
          } else {
            groupedData[date] = {title: moment(group.timestamp).format('M-D'), data: []};
          }
        }
        groupedData[date].data.push(group);
      });

      var thirtyDays = [];
      for (var i = 0; i < 30; i++) {
        var dateTest = moment(new Date(new Date().setDate(new Date().getDate()-i))).format('YYYY-MM-DD');

        if(groupedData[dateTest]){
          thirtyDays[dateTest] = groupedData[dateTest];
        } else {
          if(dateTest === moment().format('YYYY-MM-DD')) {
            thirtyDays[dateTest] = {title: "Today", data: []};
          } else {
            thirtyDays[dateTest] = {title: moment(new Date(new Date().setDate(new Date().getDate()-i))).format('M-D'), data: []};
          }
        }
      }

      data = [];

      for(var group in thirtyDays) {
        thirtyDays[group].logins = 0;
        thirtyDays[group].edits = 0;
        thirtyDays[group].adds = 0;
        thirtyDays[group].deletes = 0;
        thirtyDays[group].messages = 0;
        thirtyDays[group].files = 0;
        thirtyDays[group].system = 0;
        thirtyDays[group].total = 0;
        for(var groupData in thirtyDays[group].data) {
          if(thirtyDays[group].data[groupData].category === "login"){ thirtyDays[group].logins += 1; }
          if(thirtyDays[group].data[groupData].category === "edit"){ thirtyDays[group].edits += 1; }
          if(thirtyDays[group].data[groupData].category === "add"){ thirtyDays[group].adds += 1; }
          if(thirtyDays[group].data[groupData].category === "delete"){ thirtyDays[group].deletes += 1; }
          if(thirtyDays[group].data[groupData].category === "message"){ thirtyDays[group].messages += 1; }
          if(thirtyDays[group].data[groupData].category === "file"){ thirtyDays[group].files += 1; }
          if(thirtyDays[group].data[groupData].category === "system"){ thirtyDays[group].system += 1; }
          thirtyDays[group].total += 1;
        }
        data.push(thirtyDays[group]);
      }

      // When outputting to markup we need "today" last, so reverse the array
      data.reverse();

      return {activities: data};
    },

    initialize: function() {
      this.collection.on('sync', this.render, this);
    }

  });

  return Chart;
});

define('modules/files/views/EditFilesView',[
  'app',
  'backbone',
  'core/t',
  'core/directus',
  'core/BasePageView',
  'core/widgets/widgets'
],

function(app, Backbone, __t, Directus, BasePageView, Widgets) {

  return BasePageView.extend({
    events: {
      'click .saved-success > .tool-item, .saved-success > span > .simple-select': 'saveCheck',
      'change #saveSelect': 'saveCheck'
    },

    deleteItem: function(e) {
      var success = function() {
        var route = Backbone.history.fragment.split('/');
        route.pop();
        app.router.go(route);
      };

      var value = app.statusMapping.deleted_num;
      var options = {success: success, patch: true, wait: true, validate: false};
      try {
        app.changeItemStatus(this.model, value, options);
      } catch(e) {
        setTimeout(function() {
          app.router.openModal({type: 'alert', text: e.message});
        }, 0);
      }
    },

    saveCheck: function(e) {
      var data = this.editView.data();
      if(data[app.statusMapping.status_name] && data[app.statusMapping.status_name] === app.statusMapping.deleted_num) {
        var that = this;
        app.router.openModal({type: 'confirm', text: 'Are you sure? This item will be removed from the system!', callback: function() {
          that.save(e);
        }});
      } else {
        this.save(e);
      }
    },

    save: function(e) {
      var action = 'save-form-leave';
      if(e.target.options !== undefined) {
        action = $(e.target.options[e.target.selectedIndex]).val();
      }
      var data = this.editView.data();
      var model = this.model;
      var isNew = this.model.isNew();
      var collection = this.model.collection;
      var success;

      if (action === 'save-form-stay') {
        success = function(model, response, options) {
          var route = Backbone.history.fragment.split('/');
          route.pop();
          route.push(model.get('id'));
          app.router.go(route);
        };
      } else {
        success = function(model, response, options) {
          var route = Backbone.history.fragment.split('/');
          route.pop();
          if (action === 'save-form-add') {
            // Trick the router to refresh this page when we are dealing with new items
            if (isNew) app.router.navigate("#", {trigger: false, replace: true});
            route.push('new');
          }
          app.router.go(route);
        };
      }

      if (action === 'save-form-copy') {
        console.log('cloning...');
        var clone = model.toJSON();
        delete clone.id;
        model = new collection.model(clone, {collection: collection, parse: true});
        collection.add(model);
        console.log(model);
      }

      // patch only the changed values
      model.save(model.diff(data), {
        success: success,
        wait: true,
        patch: true,
        includeRelationships: true
      });
    },

    afterRender: function() {
      this.setView('#page-content', this.editView);

      //Fetch Model if Exists
      if (this.model.has('id')) {
        this.model.fetch({
          dontTrackChanges: true,
          error: function(model, XMLHttpRequest) {
            //If Cant Find Model Then Open New Entry Page
            if(404 === XMLHttpRequest.status) {
              var route = Backbone.history.fragment.split('/');
              route.pop();
              route.push('new');
              app.router.go(route);
            }
          }
        });
      } else {
        this.editView.render();
      }
    },

    leftToolbar: function() {
      this.saveWidget = new Widgets.SaveWidget();
      this.saveWidget.setSaved(false);
      return [
        this.saveWidget
      ];
    },

    headerOptions: {
      route: {
        title: __t('edit_file'),
        breadcrumbs: [{ title: __t('files'), anchor: '#files'}],
        isOverlay: false
      },
      basicSave: false,
    },


    initialize: function(options) {
      this.editView = new Directus.EditView({model: this.model, ui: this.options.ui});
      this.headerOptions.route.title = this.model.get('id') ? __t('editing_file') : __t('uploading_new_file');
      this.collection = app.files;
    }
  });
});

define('modules/files/views/FilesCardView',[
  'app',
  'backbone',
  'core/widgets/widgets',
  'helpers/file',
  'moment'
], function(app, Backbone, Widgets, FileHelper, moment) {

  var FilesCardView = Backbone.Layout.extend({

    tagName: 'ul',

    attributes: {
      class: "cards row"
    },

    events: {
      'click li': function(e) {
        var id = $(e.target).closest('li').attr('data-id');

        var user = app.users.getCurrentUser();
        var userGroup = user.get('group');

        app.router.go('#files', id);
      }
    },

    template: 'modules/files/filescardview',

    serialize: function() {
      var rows = this.collection.map(function(model) {
        var statusValue = model.get(app.statusMapping.status_name);
        var title = model.get('title') || '';
        var data = {
          "id": model.get('id'),
          "inactive": (statusValue !== app.statusMapping.active_num),
          "cid": model.cid,
          'title': title,
          'title_short': (title.length > 35)? title.substr(0,32) + "..." : title,
          'date_uploaded': moment(model.get('date_uploaded')).fromNow(),
          'size': model.get('size'),
          'type': (model.has('type')) ? model.get('type').split('/').pop() : '',
          'dimensions': model.get('width') + "×" + model.get('height')
        };

        var type = model.get('type').substring(0, model.get('type').indexOf('/'));
        var subtype = model.get('type').split('/').pop();

        // While loading
        if (!data.id) {
          data.thumbnail = '<div class="default-loading"><span class="icon icon-three-dots"></span></div>';
        } else if ((type == 'image' || type === 'embed' || subtype === 'pdf') && model.makeFileUrl(true)) {
          data.thumbnail = '<div class="default-info js-image"><div class="type">' +data.type.toUpperCase()+'</div><img src="'+model.makeFileUrl(true)+'"></div>';
        } else {
          data.thumbnail = '<div class="default-info">' +data.type.toUpperCase()+'</div>';
        }

        if(!model.get('width') || !model.get('height')){
          data.dimensions = "";
        }

        if(type === "embed") {
          data.size = app.seconds_convert(data.size);
          data.dimensions = "";
          data.embed = true;
        } else {
          data.size = app.bytesToSize(data.size, 0);
          data.embed = false;
        }

        return data;
      });
      return {rows: rows};
    },

    afterRender: function() {
      // Show fallback image if file missing
      FileHelper.hideOnImageError(this.$('.js-image img'));
    },

    initialize: function(options) {
      this.collection.setOrder('date_uploaded', 'DESC');
      this.collection.on('sort', this.render, this);
      this.collection.on('sync', this.render, this);
    }

  });

  return FilesCardView;

});

define('modules/files/views/FilesTableView',[
  'app',
  'backbone',
  'core/modal',
  'core/edit',
  'core/t',
  'core/notification',
  'core/BasePageView',
  'core/table/table.view',
  'core/widgets/widgets',
  'modules/files/views/EditFilesView',
  'modules/files/views/FilesCardView'
],

function(app, Backbone, DirectusModal, DirectusEdit, __t, Notification, BasePageView, DirectusTable, Widgets, EditFilesView, FilesCardView) {

  return BasePageView.extend({
    headerOptions: {
      route: {
        title: __t('files')
      }
    },
    leftToolbar: function() {
      return [
        new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "add", buttonClass: "", buttonText: __t('new_file')}})
      ];
    },
    rightToolbar: function() {
      return [
        new Widgets.PaginatorWidget({collection: this.collection})
        //new Widgets.SearchWidget(),
        //new Widgets.ButtonWidget({widgetOptions: {active: this.viewList, buttonId: "listBtn", iconClass: "icon-list"}}),
        //new Widgets.ButtonWidget({widgetOptions: {active: !this.viewList, buttonId: "gridBtn", iconClass: "icon-layout"}})
      ];
    },

    leftSecondaryToolbar: function() {
      if(!this.widgets.filterWidget) {
        this.widgets.filterWidget = new Widgets.FilterWidget({collection: this.collection, basePage: this});
      }

      if(!this.widgets.visibilityWidget) {
        this.widgets.visibilityWidget = new Widgets.VisibilityWidget({collection: this.collection, basePage: this});
      }

      return [this.widgets.visibilityWidget, this.widgets.filterWidget];
    },

    rightSecondaryToolbar: function() {
      return [
        new Widgets.PaginationCountWidget({collection: this.collection})
      ];
    },

    events: {
      'click #addBtn': function() {
        app.router.go('#files','new');
      },
      'click #gridBtn': function() {
        if(this.viewList) {
          this.viewList = false;
          $('#listBtn').parent().removeClass('active');
          $('#gridBtn').parent().addClass('active');
          this.table = new FilesCardView({collection:this.collection});
          this.render();
        }
      },
      'click #listBtn': function() {
        if(!this.viewList) {
          this.viewList = true;
          $('#listBtn').parent().addClass('active');
          $('#gridBtn').parent().removeClass('active');
          this.table = new DirectusTable({collection:this.collection, selectable: true, droppable: true, deleteOnly: true, hideColumnPreferences: true, blacklist: ['storage_adapter']});
          this.render();
        }
      }
    },
    afterRender: function() {
      this.setView('#page-content', this.table);
      this.collection.fetch();
      if (window.File && window.FileList && window.FileReader) {
        //this.initFileDrop();
      }

      var that = this;

      this.dragoverListener = function(e) {
        that.$el.find('.external-drop-indicator').show();;
      }

      window.addEventListener('dragover', this.dragoverListener, false);

      this.dragleaveListener = function() {
        that.$el.find('.external-drop-indicator').hide();;
      }

      window.addEventListener('dragleave', this.dragleaveListener, false);

      this.dropListener = function(e) {
        that.$el.find('.external-drop-indicator').fadeOut(500);
        console.log('drop');
        that.processDroppedImages(e)
      };

      window.addEventListener('drop', this.dropListener, false);
    },
    remove: function() {
      window.removeEventListener('drop', this.dropListener, false);
      window.removeEventListener('dragleave', this.dragleaveListener, false);
      window.removeEventListener('dragover', this.dragoverListener, false);

      $(document).off('ajaxStart.directus');
      $(document).on('ajaxStart.directus', function() {
        app.trigger('progress');
      });
    },
    processDroppedImages: function(e) {
      if(!this.uploadFiles) {
        this.uploadFiles = [];
      }

      var that = this;
      _.each(e.dataTransfer.files, function(file) {
      var name = app.statusMapping.status_name;
        var name = {title: file.name, size: file.size, type: file.type};
        name[app.statusMapping.status_name] = app.statusMapping.active_num;
        // All files should be sort by date
        // Setting a temporary date will make this uploading file first on the list.
        name['date_uploaded'] = (new Date).toISOString();
        var  model = new that.collection.model(name, {collection: that.collection, parse: true});
        that.collection.add(model);
        that.uploadFiles.push({model: model, fileInfo: file});
      });
      this.collection.trigger('sync');
      if(! this.uploadInProgress) {
        this.uploadInProgress = true;
        this.uploadNextImage();
      }
    },
    uploadNextImage: function() {
      if (this.uploadFiles.length <= 0) {
        this.uploadInProgress = false;

        return;
      }

      var that = this;
      var fileInfo = this.uploadFiles.shift();
      if (app.settings.isMaxFileSizeExceeded(fileInfo.fileInfo)) {
        this.uploadInProgress = false;
        Notification.error(__t('max_file_size_exceeded_x_x', {
          size: app.settings.getMaxFileSize(),
          unit: app.settings.getMaxFileSizeUnit()
        }));

        this.collection.remove(fileInfo.model);
        this.collection.trigger('sync');

        that.uploadNextImage();

        return false;
      }


      $(document).off('ajaxStart.directus');

      app.sendFiles([fileInfo.fileInfo], function(data) {
        if (data && typeof(data[0]) === 'object') {
          var attributes = data[0];
          attributes['type'] = fileInfo.fileInfo.type;
          fileInfo.model.save(attributes, {
            success: function() {
              that.collection.sort();
              $(document).on('ajaxStart.directus', function() {
                app.trigger('progress');
              });
            },
            error: function() {
              $(document).on('ajaxStart.directus', function() {
                app.trigger('progress');
              });

              that.collection.remove(fileInfo.model);
              that.collection.trigger('sync');
            },
            wait: true,
            patch: true,
            includeRelationships: true
          });
          that.collection.trigger('sync');
          that.uploadNextImage();
        } else {
          $(document).on('ajaxStart.directus', function() {
            app.trigger('progress');
          });
          that.collection.remove(fileInfo.model);
          that.collection.trigger('sync');
          that.uploadNextImage();
        }
      }, function(e) {
        $('li[data-cid=' + fileInfo.model.cid + ']').find('.files-card-progress').show();
        $('li[data-cid=' + fileInfo.model.cid + ']').find('.default-loading > .icon').removeClass('icon-three-dots');
        $('li[data-cid=' + fileInfo.model.cid + ']').find('.default-loading > .icon').addClass('icon-upload-cloud');
        $('li[data-cid=' + fileInfo.model.cid + ']').find('.files-card-progress').width(((e.loaded / e.total) * 100) + "%");
      });
    },
    initialize: function() {
      this.viewList = false;
      this.table = new FilesCardView({collection:this.collection});
      this.widgets = [];
    }
  });

});

define('modules/files/files',[
  'app',
  'modules/files/views/EditFilesView',
  'modules/files/views/FilesTableView'
],

function(app, EditFilesView, FilesTableView) {

  

  var files = app.module();

  files.Views.Edit = EditFilesView;
  files.Views.List = FilesTableView;

  return files;
});
define('modules/activity/activity',[
  'app',
  'backbone',
  'handlebars',
  'core/directus',
  'modules/activity/chart',
  "modules/files/files",
  'core/BasePageView',
  'moment'
],

function(app, Backbone, Handlebars, Directus, Chart, Files, BasePageView, moment) {

  

  var Dashboard = app.module();

  var ListView = Backbone.Layout.extend({

    tagName: "ul",

    attributes: {
      class: "group-list"
    },

    template: "modules/activity/activity-list",

    events: {
      'click tr': function(e) {
        var id = $(e.target).closest('tr').attr('data-id');
        app.router.go('#messages', id);
      }
    },

    serialize: function() {
      var tables = app.schemaManager.getTables();

      var data = this.collection.map(function(model) {
        var data = {
          "table": model.get('table_name'),
          'time': moment(model.get('datetime')).fromNow(),
          "timestamp": model.get('datetime'),
          "user_avatar": model.get('user')
        };

        switch(model.get('action')) {
          case 'LOGIN':
            data.action_login = true;
            break;
          case 'UPDATE':
            data.action_edit = true;
            break;
          case 'ADD':
            data.action_add = true;
            break;
          case 'DELETE':
            data.action_delete = true;
            break;
          case 'REPLY':
            data.action_add = true;
            break;
        }

        if(data.action_login) {
          data.table = "login";
          data.user = model.get('user');
        }

        if(model.get('row_id') > 0) {
          data.link = "tables/" + data.table + "/" + model.get('row_id');
        }

        //If table is files set to clip
        if(data.table === "directus_files") {
          data.is_file = true;
          data.title = JSON.parse(model.get('data'))['name'];
        }

        //If table is files set to clip
        if(data.table === "directus_ui") {
          data.is_system = true;
          data.title = model.get('identifier').substring(0, model.get('identifier').indexOf(','));
        }

        //If table is Messages set to message
        if(data.table === "directus_messages") {
          if(JSON.parse(model.get('data')).response_to) {
            data.is_reply = true;
            data.link = "messages/" + JSON.parse(model.get('data')).response_to;
          } else {
            if(model.get('type') === "MESSAGE") {
              if(!app.messages.get(model.get('row_id'))) {
                data.hidden = true;
              } else {
                data.link = "messages/" + model.get('row_id');
              }
            } else {
              data.is_comment = true;
              data.link = false;
              if(JSON.parse(model.get('data')).comment_metadata) {
                var metadata = JSON.parse(model.get('data')).comment_metadata.split(':');
                if(metadata) {
                  var itemId = metadata.pop();
                  var table = metadata.pop();

                  data.link = "tables/" + table + "/" + itemId;
                  data.title = table;
                }
              }
            }
          }

          data.is_message = true;
          if(!data.title) {
            data.title = model.get('identifier');
          }
          if(model.get('action') === "ADD") {
            data.isNew = true;
          }
        }

        if(tables.get(model.get('table_name'))) {
          var primary_column = tables.get(model.get('table_name')).get('primary_column');
          if(primary_column) {
            var modelData = JSON.parse(model.get('data'));

            var template = Handlebars.compile(primary_column);
            data.title = template(modelData);
          }
        }
        return data;
      });

      //Filter out data that is set to hidden
      data = _.filter(data, function(item) {
        return !item.hidden;
      });

      // Order the data by timestamp
      data = _.sortBy(data, function(item) {
        return -moment(item.timestamp);
      });

      var groupedData = [];

      data.forEach(function(group) {
        var date = moment(group.timestamp).format('MMMM-D-YYYY');
        if(!groupedData[date]) {
          //If Today Have it say Today
          if(date === moment().format('MMMM-D-YYYY')) {
            groupedData[date] = {title: "Today", data: []};
          } else {
            groupedData[date] = {title: moment(group.timestamp).format('MMMM D, YYYY'), data: []};
          }
        }
        groupedData[date].data.push(group);
      });
      data = [];

      for(var group in groupedData) {
        data.push(groupedData[group]);
      }

      return {activities: data};
    },

    initialize: function() {
      this.collection.setFilter({adv_search:''});
      this.collection.on('sync', this.render, this);
    }

  });

  Dashboard.Views.List = BasePageView.extend({

    headerOptions: {
      route: {
        title: 'Activity'
      }
    },

    events: {
      'click a[data-action=file]': function(e) {
        var id = parseInt($(e.target).attr('data-id'),10);
        var model = new app.files.model({id: id}, {collection: app.files});
        var modal = new Files.Views.Edit({model: model, stretch: true});
        app.router.v.messages.insertView(modal).render();
        app.router.navigate('#files/'+model.id);
        modal.on('close', function() {
          app.router.navigate('#activity');
        });
      }
    },

    serialize: function() {
      return {title: 'Activity'};
    },

    afterRender: function() {
      this.insertView('#page-content', this.chart);
      this.insertView('#page-content', this.table);
      this.collection.fetch();
    },

    initialize: function() {
      this.chart = new Chart({collection: this.collection});
      this.table = new ListView({collection: this.collection});
    }

  });

  return Dashboard;
});

define('modules/tables/views/BatchEditView',[
  'app',
  'backbone',
  'core/directus',
  'core/BasePageView',
  'core/widgets/widgets'
],

function(app, Backbone, Directus, BasePageView, Widgets) {

  return BasePageView.extend({

    headerOptions: {
      route: {
        title: 'Batch Edit'
      },
      leftToolbar: true,
      rightToolbar: true
    },

    leftToolbar: function() {
      this.saveWidget = new Widgets.SaveWidget({widgetOptions: {basicSave: true}});
      this.saveWidget.setSaved(false);
      return [
        this.saveWidget
      ];
    },

    events: {
      'click .saved-success': 'saveConfirm'
    },

    saveConfirm: function() {
      var that = this,
          itemCount = this.batchIds.length;

      app.router.openModal({type: 'confirm', text: 'This will affect ' + itemCount + ' records. Continue?', callback: function() {
        that.save();
      }});
    },

    save: function() {
      var model = this.model,
          itemCount = this.batchIds.length,
          failRequestCount = 0,
          successRequestCount = 0;

      // Serialize the entire form
      var data = this.editView.data();

      // Get an attribute whitelist based on the checkboxes
      var attrWhitelist = $("input[name='batchedit']:checked").map(function() {
        return $(this).data('attr');
      }).toArray();

      // Set data to model inorder to include relationships etc
      model.set(this.model.diff(data));

      // Changed attributes based on whitelist
      var changedAttributes = _.pick(model.toJSON(), attrWhitelist);

      var checkIfDone = function() {
        var totalRequest = successRequestCount + failRequestCount;
        if (totalRequest === itemCount) {
          var route = Backbone.history.fragment.split('/');
          route.pop();
          alert(successRequestCount + " items have been updated. " + failRequestCount + " items failed to update");
          app.router.go(route);
        }
      };

      var success = function() {
        successRequestCount++;
        checkIfDone();
      };

      var error = function() {
        failRequestCount++;
        checkIfDone();
      };

      // Save all batch id's
      _.each(this.batchIds, function(id) {
        var modelToUpdate = model.getNewInstance({collection: model.collection});
        modelToUpdate.set(_.extend(
          {id: id},
          changedAttributes
        ), {parse: true});

        modelToUpdate.save({}, {
          success: success,
          error: error,
          wait: true,
          //patch: true,
          includeRelationships: true,
          validate: false
        });
      });
    },

    afterRender: function() {
      this.setView('#page-content', this.editView);
      this.editView.render();
    },

    initialize: function(options) {
      this.batchIds = options.batchIds;
      this.editView = new Directus.EditView({model: this.model, batchIds: options.batchIds});
      this.headerOptions.route = {title: "Batch Edit (" + this.batchIds.length + ")", breadcrumbs:[{ title: 'Tables', anchor: '#tables'}, {title: this.model.collection.table.id, anchor: "#tables/" + this.model.collection.table.id}]};
    }

  });

});
define('modules/tables/views/HistoryView',[
  'app',
  'backbone',
  'core/t',
  'core/directus',
  'moment'
],

function(app, Backbone, __t, Directus, moment) {

  return Backbone.Layout.extend({
    tagName: "ul",

    attributes: {
      class: "group-list"
    },

    template: "modules/activity/activity-history",

    events: {
      'click #messages-response-button': function(e) {
        if(this.$el.find('#commentTextarea').val() === "") {
          return;
        }

        var model = new app.messages.model({from: app.authenticatedUserId.id}, {collection: this.comments, parse: true});
        var subject = '[' + app.settings.get('global').get('project_name') + '] ' + app.capitalize(this.model.collection.table.id) + ': "' + this.model.get(this.model.table.get('primary_column')) + '"';

        var date = moment().format("YYYY-MM-DD HH:mm:ss");
        model.set({datetime: date, subject: subject, message:this.$el.find('#commentTextarea').val(), comment_metadata: this.model.collection.table.id + ":" + this.model.get('id')});
        model.unset("responses");
        model.url = app.API_URL + "comments/";

        this.listenToOnce(model, 'sync', function(e) {
          this.comments.add(model);
          this.render();
        });
        this.$el.find('#messages-response-button').prop('disabled', true);
        model.save();
      },
      'input #commentTextarea': function(e) {
        var caretPos = $(e.target)[0].selectionStart;
        var text = $(e.target).val();
        var sub = text.substring(0, caretPos);
        var activeChunk = sub.substring(sub.lastIndexOf(" ") + 1);

        // Enable submit button when content exists
        if(text.length > 0){
          $('#messages-response-button').removeClass('disabled');
        } else {
          $('#messages-response-button').addClass('disabled');
        }

        if(activeChunk.substring(0,1) === "@") {
          var search = activeChunk.substring(1);

          if(search) {
            this.displaySearch(search);
          } else {
            $('#tagInsert').empty();
          }
        } else {
          $('#tagInsert').empty();
        }
      },
      'click .history-follow': function(e) {
        console.log(app.users.getCurrentUser());
        /*var data = {};
        data[attr] = !tableModel.get(attr);
        tableModel.save(data);
        if(element.hasClass('add-color')) {
          element.addClass('delete-color');
          element.removeClass('add-color');
          element.removeClass('on');
        } else {
          element.addClass('add-color');
          element.removeClass('delete-color');
          element.addClass('on');
        }*/
      },
      'click .view-entire-history': function(e) {
        $('.history-container li.hide').removeClass('hide');
        $('.view-entire-history').remove();
        //$(e.target).remove();
      },
      'click .tagInsertItem': function(e) {
        var target = $(e.target);

        var caretPos = $('#commentTextarea')[0].selectionStart;
        var text = $('#commentTextarea').val();
        var sub = text.substring(0, caretPos);
        var start = sub.lastIndexOf(" ") + 1;
        var startString = sub.substring(start);

        if(startString.substring(0,1) === "@") {
          var endText = text.substring(caretPos, text.length);
          var end = caretPos;
          if(!endText || endText.indexOf(" ") === -1) {
            end = text.length;
          } else {
            end = endText.indexOf(" ") + start +startString.length;
          }

          text = text.substring(0, start) + "@[" + target.data('id') + " " + target.data('name') + "] " + text.substring(end, text.length);
          $('#commentTextarea').val(text);
          $('#tagInsert').empty();
        }
      }
    },
    displaySearch: function(query) {
      $('#tagInsert').empty();
      this.searchEngine.get(query, function(res) {
        res.forEach(function(item) {
          $('#tagInsert').append('<div class="tagInsertItem mention-choice" data-id="' + item.id + '" data-name="' + item.name + '"><img src="' + item.avatar + '"/>'  + item.name + '</div>');
        });
      });
    },
    initialize: function(options) {
      //Get Activity
      this.model = options.model;
      this.activity = app.activity;
      this.comments = new Directus.EntriesCollection({}, {table: app.messages.table, structure: app.messages.structure});

      if(!this.model.isNew()) {
        this.activity.setFilter({adv_search: 'table_name = "' + this.model.collection.table.id + '" AND row_id = ' + this.model.get(this.model.idAttribute)});
        this.activity.fetch();
        this.comments.setFilter({adv_where: 'comment_metadata = "' + this.model.collection.table.id + ":" + this.model.get(this.model.idAttribute) + '"'});
        this.comments.fetch();
      }

      var otherFetched = false;

      this.listenTo(this.activity, 'sync', function() {
        if(otherFetched) {
          this.render();
        }
        otherFetched = true;
      });

      this.listenTo(this.comments, 'sync', function() {
        if(otherFetched) {
          this.render();
        }
        otherFetched = true;
      });

      var DIRECTUS_USERS = 0;
      var DIRECTUS_GROUPS = 1;

      var users = app.users.filter(function(item) {
        if(item.get('id') === app.authenticatedUserId.id) {
          return false;
        }
        return true;
      });

      users = users.map(function(item) {
        return {
          id: item.id,
          uid: DIRECTUS_USERS + '_' + item.id,
          name: item.get('first_name') + ' ' + item.get('last_name'),
          avatar: item.getAvatar(),
          type: DIRECTUS_USERS
        };
      });

      var groups = app.groups.map(function(item) {
        return {
          id: item.id,
          uid: DIRECTUS_GROUPS + '_' + item.id,
          name: item.get('name'),
          avatar: app.PATH + 'assets/img/directus-group-avatar-100x100.jpg',
          type: DIRECTUS_GROUPS
        };
      });

      var usersAndGroups = users.concat(groups);
      var datums = [];
      this.deletedDatums = [];

      _.each(usersAndGroups, function(item) {
        var uid = item.uid;

        datums.push({
          id: uid,
          name: item.name,
          avatar: item.avatar,
          tokens: item.name.split(" ")
        });
       });

      var engine = new Bloodhound({
        name: 'users',
        local: datums,
        datumTokenizer: function(d) {
          return Bloodhound.tokenizers.whitespace(d.name);
        },
        queryTokenizer: Bloodhound.tokenizers.whitespace
      });

      this.searchEngine = engine;
      engine.initialize();
    },
    serialize: function() {
      var data = this.activity.map(function(model) {
        var data = {
          "table": model.get('table_name'),
          'time': moment(model.get('datetime')).fromNow(),
          "timestamp": model.get('datetime'),
          "user_avatar": model.get('user')
        };

        switch(model.get('action')) {
          case 'DELETE':
            data.icon = "delete";
            data.color = "delete";
            data.action_text = __t('deleted_this_item');
            break;
          case 'UPDATE':
            data.icon = "edit";
            data.color = "edit";
            data.action_text = __t('edited_this_item');
            break;
          case 'ADD':
            data.add = true;
            data.icon = "check";
            data.color = "add";
            data.action_text = __t('created_this_item');
            break;
        }
        return data;
      });

      var comments = this.comments.map(function(model) {
        var data = {
          "table": "Comment",
          "timestamp": model.get('datetime'),
          "time": moment(model.get('datetime')).fromNow(),
          "user_avatar": model.get('from')
        };

        data.isComment = true;
        data.title = model.get("message");

        return data;
      });

      data = data.concat(comments);
      // Order the data by timestamp
      data = _.sortBy(data, function(item) {
        return -moment(item.timestamp);
      });
      for (var key in data) {
        if (data.hasOwnProperty(key)) {
          data[key].hidden = (key >= 5)? 'hide' : 'preview';

          var title = data[key].title;
          var offset = 0;
          while(true) {
            if(title) {
              var atPos = title.indexOf('@[');
              if(atPos !== -1) {
                var spacePos = title.substring(atPos).indexOf(' ');
                if(spacePos !== -1) {
                  var substring = title.substring(atPos + 2, spacePos + atPos);
                  var contains = /^[0-9]|_+$/.test(substring);
                  if(contains) {
                    var bracketPos2 = title.indexOf(']');
                    if(bracketPos2 !== -1) {
                      var name = title.substring(spacePos + 1 + atPos, bracketPos2);
                      var newTitle = data[key].title;
                      data[key].title = newTitle.substring(0, atPos + offset) + "<span class=\"mention-tag\">" + name + "</span>";
                      var newOffset = data[key].title.length;
                      data[key].title += newTitle.substring(bracketPos2 + offset + 1);
                      title = newTitle.substring(bracketPos2 + offset + 1);
                      offset = newOffset;
                      continue;
                    }
                  }
                }
              }
            }
            break;
          }

        }
      }

      var preview = (data.length > 5)? true : false;
      var additionalCount = data.length - 5;

      return {activities: data, preview: preview, additionalCount: additionalCount, current_user: app.authenticatedUserId};
    }
  });
});

define('modules/tables/views/TranslationView',[
  'app',
  'backbone',
  'handlebars',
  'core/directus',
  "core/EntriesManager"
],

function(app, Backbone, Handlebars, Directus, EntriesManager) {

  return Backbone.Layout.extend({
    template: 'modules/tables/translation',
    events: {
      'change #activeLanguageSelect': function(e) {
        var that = this;
        var originalVal = $(e.target).val();
        $(e.target).val(this.activeLanguageId);

        var diff = this.translateModel.diff(this.editView.data());
        delete diff.id;
        if(!$.isEmptyObject(diff)) {
          app.router.openModal({type: 'yesnocancel', text: 'Would you like to save this translation?', callback: function(response) {
            if(response === 'yes') {
              that.saveTranslation();
            }
            that.initializeTranslateView(originalVal);
          }});
        } else {
          this.initializeTranslateView(originalVal);
        }
      }
    },
    saveTranslation: function() {
      this.translateModel.set(this.translateModel.diff(this.editView.data()));
      if(!this.translateCollection.contains(this.translateModel)) {
        this.translateCollection.add(this.translateModel, {nest: true});
      }
    },
    afterRender: function() {
      if(this.editView) {
        this.insertView("#translateEditFormEntry", this.editView);
        this.editView.render();
      }
    },
    initialize: function(options) {
      this.translateId = options.translateId;
      this.translateSettings = options.translateSettings;
      this.translateRelationship = options.translateRelationship;

      if(this.model.id) {
        this.listenToOnce(this.model, 'sync', this.updateTranslateConnection);
      } else {
        this.updateTranslateConnection();
      }
    },

    updateTranslateConnection: function() {
      this.translateCollection = this.model.get(this.translateId);
      var tracking = function(model) {
        model.startTracking();
      };

      this.translateCollection.each(tracking);
      this.translateCollection.on('add', tracking);

      this.languageCollection = EntriesManager.getInstance(this.translateSettings.languages_table);
      this.listenTo(this.languageCollection, 'sync', function() {this.initializeTranslateView();});
      this.languageCollection.fetch();
    },

    initializeTranslateView: function(language) {
      if(language === undefined) {
        this.activeLanguageId = this.translateSettings.default_language_id;
      } else {
        this.activeLanguageId = language;
      }

      var that = this;
      this.translateModel = null;

      this.translateCollection.forEach(function(model) {
        if(model.get(that.translateSettings.left_column_name) === that.activeLanguageId) {
          that.translateModel = model;
        }
      });

      if(!this.translateModel) {
        this.translateModel = new this.translateCollection.model({}, {collection: this.translateCollection, parse: true});
        var data = {};
        data[this.translateSettings.left_column_name] = this.activeLanguageId;
        data[this.translateRelationship.junction_key_right] = this.model.id;
        this.translateModel.set(data);
      }

      this.editView = new Directus.EditView({
        model: this.translateModel,
        hiddenFields: [this.translateSettings.left_column_name, this.translateRelationship.junction_key_right],
      });

      this.render();
    },
    serialize: function() {
      var data = {};
      data.translateField = app.capitalize(this.translateId);

      var that = this;

      if(this.languageCollection) {
        data.languages = this.languageCollection.map(function(item) {
          return {val: item.id, name: item.get(that.translateSettings.languages_name_column), active: (item.id == that.activeLanguageId)};
        });
      }

      return data;
    }
  });
});

define('modules/tables/views/EditView',[
  'app',
  'backbone',
  'handlebars',
  'core/t',
  'core/directus',
  'core/BasePageView',
  'core/widgets/widgets',
  'modules/tables/views/HistoryView',
  'modules/tables/views/TranslationView'
],

function(app, Backbone, Handlebars, __t, Directus, BasePageView, Widgets, HistoryView, TranslationView) {

  var EditView = Backbone.Layout.extend({
    template: Handlebars.compile('<div id="editFormEntry"></div><div id="translateFormEntry"></div><div id="historyFormEntry"></div>'),
    afterRender: function() {
      this.insertView("#editFormEntry", this.editView);
      this.insertView("#historyFormEntry", this.historyView);

      if (this.translateViews.length) {
        _.each(this.translateViews, function(view) {
          this.insertView("#translateFormEntry", view);
        }, this);
      }

      if (this.skipFetch || this.model.isNew()) {
        this.editView.render();
      }
    },
    beforeSaveHook: function() {
      if (this.translateViews.length) {
        _.each(this.translateViews, function(view) {
          view.saveTranslation();
        }, this);
      }
    },
    data: function() {
      return this.editView.data();
    },
    initialize: function(options) {
      this.skipFetch = options.skipFetch;
      this.translateViews = [];

      options.hiddenFields = [];
      options.model.structure.each(function(model) {
        if (model.get('ui') === 'translation') {
          var translateId = model.id;
          options.hiddenFields.push(translateId);
          var view = new TranslationView({
            model: options.model,
            translateId: translateId,
            translateSettings: model.options.attributes,
            translateRelationship: model.relationship.attributes
          });

          this.translateViews.push(view);
        }
      }, this);

      this.editView = new Directus.EditView(options);
      this.historyView = new HistoryView(options);
    },
    serialize: function() {
      return {};
    }
  });

  return BasePageView.extend({
    events: {
      'change input, select, textarea': 'checkDiff',
      'keyup input, textarea': 'checkDiff',
      'click .saved-success > #save': 'saveConfirm',
      'change #saveSelect': 'saveConfirm',
      'submit': function(e) {
        // prevent user submit the form using Enter key
        // @todo handle this event to or as 'saveConfirm'
        e.preventDefault();
      }
    },

    getHeaderOptions: function() {
      return {
        route: {
          title: 'Editing Item',
          isOverlay: false
        }
      };
    },

    checkDiff: function(e) {
      var diff = this.model.diff(this.editView.data());
      delete diff.id;

      //this.saveWidget.setSaved(_.isEmpty(diff));
    },

    deleteItem: function(e) {
      var success = function() {
        var route = Backbone.history.fragment.split('/');
        route.pop();
        app.router.go(route);
      };
      //@todo: who trigger this?
      var options = {success: success, patch: true, wait: true, validate: false};
      try {
        app.changeItemStatus(model, value, options);
      } catch(e) {
        setTimeout(function() {
          app.router.openModal({type: 'alert', text: e.message});
        }, 0);
      }
    },

    saveConfirm: function(e) {
      var data = this.editView.data();
      var that = this;
      if(data[app.statusMapping.status_name] && data[app.statusMapping.status_name] === app.statusMapping.deleted_num) {
        app.router.openModal({type: 'confirm', text: 'Are you sure you want to delete this item?', callback: function() {
          that.save(e);
        }});
      } else {
        this.save(e);
      }
    },

    save: function(e) {
      this.editView.beforeSaveHook();

      var action = this.single ? 'save-form-stay' : 'save-form-leave';
      if (e.target.options !== undefined && !this.single) {
        action = $(e.target.options[e.target.selectedIndex]).val();
      }

      var data = this.editView.data();

      var model = this.model;
      var isNew = this.model.isNew();
      var collection = this.model.collection;
      var success;

      for(var key in data) {
        if(model.structure.get(key).options && model.structure.get(key).options.get('allow_null') === '1') {
          if(data[key] === '') {
            data[key] = null;
          }
        }
      }

      if (action === 'save-form-stay') {
        success = function(model, response, options) {
          var route = Backbone.history.fragment.split('/');
          if(!model.table.get('single')) {
            route.pop();
            route.push(model.get('id'));
            app.router.go(route);
          }
        };
      } else {
        var self = this;
        success = function(model, response, options) {
          var route = Backbone.history.fragment.split('/');

          route.pop();
          if (action === 'save-form-add') {
            // Trick the router to refresh this page when we are dealing with new items
            if (isNew) app.router.navigate("#", {trigger: false, replace: true});
            route.push('new');
          }

          if (self.onSuccess) {
            self.onSuccess(model, response, options);
          }

          // @TODO: check if this view is a overlay then close the overlay
          //        instead redirecting to the listing page
          // -------------------------------------------------------------
          // if it's an overlay view do not go to any route
          if (!self.headerOptions.route.isOverlay) {
            app.router.go(route);
          }
        };
      }
      if (action === 'save-form-copy') {
        console.log('cloning...');
        var clone = model.toJSON();
        delete clone.id;
        model = new collection.model(clone, {collection: collection, parse: true});
        collection.add(model);
        console.log(model);
      }

      var changedValues = model.diff(data);

      if(changedValues[app.statusMapping.status_name] && changedValues[app.statusMapping.status_name] === app.statusMapping.deleted_num ) {
        var value = app.statusMapping.deleted_num;
        var options = {success: success, wait: true, patch: true, includeRelationships: true};
        try {
          app.changeItemStatus(this.model, value, options);
        } catch(e) {
          setTimeout(function() {
            app.router.openModal({type: 'alert', text: e.message});
          }, 0);
        }
      } else {
        // patch only the changed values
        model.save(changedValues, {
          success: success,
          error: function(model, xhr, options) {
            console.error('err');
            //Duplicate entry, forced but works
            //@todo finds a better way to determine whether there's an duplicate error
            // and what's the column's name
            var response = JSON.parse(xhr.responseText);
            if (response.message.indexOf('Duplicate entry') !== -1) {
              var columnName = response.message.split('for key')[1].trim();
              columnName = columnName.substring(1, columnName.lastIndexOf("'"));
              app.router.openModal({type: 'alert', text: 'This item was not saved because its "' + columnName + '" value is not unique.'});
              return;
            }
          },
          wait: true,
          patch: true,
          includeRelationships: true
        });
      }
      this.$el.find('#saveSelect').val('');
    },

    afterRender: function() {
      this.setView('#page-content', this.editView);

      //Fetch Model if Exists
      if (!this.skipFetch && this.model.has(this.model.idAttribute)) {
        this.model.fetch({
          dontTrackChanges: true,
          error: function(model, XMLHttpRequest) {
            //If Cant Find Model Then Open New Entry Page
            if(404 === XMLHttpRequest.status) {
              var route = Backbone.history.fragment;

              route = route.split('/');
              if(route.slice(-2)[0] !== "tables") {
                route.pop();
              }
              route.push('new');
              app.router.go(route);
            }
          }
        });
      }
      this.editView.render();
    },

    leftToolbar: function() {
      this.saveWidget = new Widgets.SaveWidget({widgetOptions: {basicSave: this.headerOptions.basicSave, singlePage: this.single}});
      this.saveWidget.setSaved(false);
      return [
        this.saveWidget
      ];
    },

    initialize: function(options) {
      options = _.defaults({}, options, {skipFetch: false});
      this.headerOptions = this.getHeaderOptions();
      this.isBatchEdit = options.batchIds !== undefined;
      this.single = this.model.collection.table.get('single');
      this.editView = new EditView(options);
      this.headerOptions.route.isOverlay = false;
      this.headerOptions.basicSave = false;
      this.skipFetch = options.skipFetch;
      this.onSuccess = options.onSuccess;

      if (this.single) {
        this.headerOptions.route.title = 'Editing ' + this.model.collection.table.id;
        this.headerOptions.route.breadcrumbs = [{ title: __t('tables'), anchor: '#tables'}];
      } else {
        this.headerOptions.route.title = this.model.get(this.model.idAttribute) ? __t('editing_item') : __t('creating_new_item');
        this.headerOptions.route.breadcrumbs = [{ title: __t('tables'), anchor: '#tables'}, {title: this.model.collection.table.id, anchor: "#tables/" + this.model.collection.table.id}];
      }
    }
  });
});

define('modules/tables/views/TablesView',[
  'app',
  'backbone',
  'core/directus',
  'core/t',
  'core/BasePageView'
],

function(app, Backbone, Directus, __t, BasePageView) {

  return BasePageView.extend({

    headerOptions: {
      route: {
        title: __t('tables')
      }
    },

    beforeRender: function() {
      this.setView('#page-content', new Directus.TableSimple({
        collection: this.collection,
        tagName: 'div',
        attributes: {
          'class': 'table-shadow'
        },
        template: 'modules/tables/tables'
      }));
      BasePageView.prototype.beforeRender.call(this);
    }

  });

});

define('modules/tables/views/TableView',[
  'app',
  'backbone',
  'core/t',
  'core/BasePageView',
  'core/ListViewManager',
  'core/widgets/widgets'
],

function(app, Backbone, __t, BasePageView, ListViewManager, Widgets) {

  return BasePageView.extend({

    headerOptions: {
      route: {
        title: 'Table View',
        breadcrumbs: [{title: __t('tables'), anchor: '#tables'}]
      },
    },

    leftToolbar: function() {
      //if(!this.widgets.bookmarkWidget) {
        //this.widgets.bookmarkWidget = new Widgets.ButtonWidget({widgetOptions: {active: this.isBookmarked, buttonId: 'bookmarkBtn', iconClass: 'icon-star'}});
      //}
      var widgets = [
        //this.widgets.bookmarkWidget
      ];

      if (this.collection.structure.length > 1 && this.collection.hasPermission('add')) {
        if (!this.widgets.addWidget) {
          this.widgets.addWidget = new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "add", buttonClass: "", buttonText: __t('new_item')}});
        }

        widgets.push(this.widgets.addWidget);
      }
      return  widgets;
    },

    rightToolbar: function() {
      return [
        new Widgets.PaginatorWidget({collection: this.collection})
      ];
    },

    leftSecondaryToolbar: function() {
      this.leftSecondaryCurrentState = _.isUndefined(this.leftSecondaryCurrentState) ? 'default' : this.leftSecondaryCurrentState;

      switch(this.leftSecondaryCurrentState) {
        case 'default':
          if(!this.widgets.visibilityWidget) {
            this.widgets.visibilityWidget = new Widgets.VisibilityWidget({collection: this.collection, basePage: this});
          }

          if(!this.widgets.filterWidget) {
            this.widgets.filterWidget = new Widgets.FilterWidget({collection: this.collection, basePage: this});
          }

          return [
            this.widgets.visibilityWidget,
            this.widgets.filterWidget
          ];
        case 'actions':
          if(!this.widgets.selectionActionWidget) {
            this.widgets.selectionActionWidget = new Widgets.SelectionActionWidget({collection: this.collection, widgetOptions: {batchEdit: this.batchEdit}});
          }
          return [
            this.widgets.selectionActionWidget
          ];
      }

      return [];
    },

    rightSecondaryToolbar: function() {

      switch(this.leftSecondaryCurrentState) {
        case 'default':
          return [
            new Widgets.PaginationCountWidget({collection: this.collection})
          ];
        case 'actions':
          return [
            new Widgets.SelectedCountWidget({collection: this.collection})
          ];
      }

      return [];
    },

    events: {
      'click #addBtn': function() {
        app.router.go('#tables/'+this.collection.table.id+'/new');
      },
      'click #bookmarkBtn': function() {
        var data = {
          title: this.collection.table.id,
          url: Backbone.history.fragment,
          icon_class: 'icon-star',
          user: app.users.getCurrentUser().get("id"),
          section: 'table'
        };
        if(!this.isBookmarked)
        {
          app.getBookmarks().addNewBookmark(data);
        } else {
          app.getBookmarks().removeBookmark(data);
        }
        $('#bookmarkBtn').parent().toggleClass('active');
        this.isBookmarked = !this.isBookmarked;
      }
    },

    afterRender: function() {
      this.setView('#page-content', this.table);
      this.tryFetch();

      // Listen to preferences sync after the first sync
      this.listenToOnce(this.collection.preferences, 'sync', function() {
        this.listenTo(this.collection.preferences, 'sync', function() {
          app.trigger('tables:preferences', this, this.collection);
        });
      });
    },

    initialize: function() {
      this.widgets = {};

      this.table = ListViewManager.getInstance({collection: this.collection, navigate: true, maxColumns: 8, toolbar: true});
      this.headerOptions.route.title = this.collection.table.id;
      if(!this.collection.options) {
        this.collection.options = {};
      }

      this.collection.options['sort'] = false;

      this.collection.on('select', function() {

        this.actionButtons = Boolean($('.select-row:checked').length);
        this.batchEdit = $('.select-row:checked').length > 1;

        if(this.actionButtons || this.batchEdit) {
          if(this.leftSecondaryCurrentState !== 'actions') {
            this.leftSecondaryCurrentState = 'actions';
            this.reRender();
          }
        }
        else {
          if(this.leftSecondaryCurrentState !== 'default') {
            this.leftSecondaryCurrentState = 'default';
            this.reRender();
          }
        }
      }, this);

      this.collection.on('sort', function() {
        if(this.leftSecondaryCurrentState !== 'default') {
          this.leftSecondaryCurrentState = 'default';
          this.reRender();
        }
      }, this);

      this.isBookmarked = app.getBookmarks().isBookmarked(this.collection.table.id);
    }

  });

});

//  table.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com


define('modules/tables/table',[
  'app',
  'modules/tables/views/BatchEditView',
  'modules/tables/views/EditView',
  'modules/tables/views/TablesView',
  'modules/tables/views/TableView'
],

function(app, BatchEditView, EditView, TablesView, TableView) {

  

  var Table = app.module();

  Table.Views = {};

  Table.Views.Tables = TablesView;
  Table.Views.BatchEdit = BatchEditView;
  Table.Views.Edit = EditView;
  Table.Views.List = TableView;

  return Table;

});
define('core/doubleConfirmation',[
  'app',
  'backbone',
  'core/t',
  'core/notification'
],

function(
  app,
  Backbone,
  __t,
  Notification
) {

  

  return function(options, context) {

    var opts = _.extend({
      value: false,
      name: '',
      firstQuestion: __t('confirm_question'),
      secondQuestion: __t('confirm_question_confirm'),
      emptyValueMessage: __t('confirm_invalid_value'),
      notMatchMessage: __t('confirm_value_did_not_match'),
      callback: function() {}
    }, options);

    if (!context) {
      context = this;
    }

    if (!opts.value) {
      Notification.error('Error', opts.emptyValueMessage);
      return;
    }

    app.router.openModal({type: 'yesno', text: opts.firstQuestion, callback: function(will) {
      if (will !== 'yes') {
        return;
      }

      app.router.openModal({type: 'prompt', text: opts.secondQuestion, callback: function(confirmedValue) {
        if (confirmedValue !== opts.value) {
          Notification.error(__t('confirm_did_not_match'), opts.notMatchMessage);
          return;
        }

        opts.callback.apply(context);
     }});
    }});
  }
});

define('helpers/schema',[],function() {

  

  function cleanIdentifier(identifier) {
    return identifier.replace(/[^a-z0-9-_]+/ig, '_');
  }

  function cleanColumnName(name) {
    return cleanIdentifier(name).replace(/^[0-9]+/ig, '');
  }

  return {
    cleanColumnName: cleanColumnName,
    cleanTableName: cleanIdentifier
  }
});

define('modules/settings/SettingsConfig',['core/t'],
function(__t) {
    

    var SettingsConfig = {
        systemColumnDetails: {
            id: __t('system_column_details_id'),
            active: __t('system_column_details_active')+' <a target="_blank" class="link-underline" href="https://github.com/directus/docs/blob/master/01-getting-started/05-your-database.md#status-field">'+__t('learn_more')+'</a>',
            sort: __t('system_column_details_sort')+' <a target="_blank" class="link-underline" href="https://github.com/directus/docs/blob/master/01-getting-started/05-your-database.md#sort-field">'+__t('learn_more')+'</a>'
        }
    };

    return SettingsConfig;
});

//  tables.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com


define('modules/settings/views/TablesView',[
  'app',
  'underscore',
  'backbone',
  'core/directus',
  'core/BasePageView',
  'schema/TableModel',
  'schema/ColumnModel',
  'core/UIManager',
  'core/widgets/widgets',
  'schema/SchemaManager',
  'sortable',
  'core/notification',
  'core/doubleConfirmation',
  'core/t',
  'helpers/schema',
  '../SettingsConfig'
],

function(app, _, Backbone, Directus, BasePageView, TableModel, ColumnModel, UIManager, Widgets, SchemaManager, Sortable, Notification, DoubleConfirmation, __t, SchemaHelper, SettingsConfig) {
  

  var SettingsTables = app.module();

  // Handles new columns and aliases.
  // Rendered inside modal
  var NewColumnOverlay = BasePageView.extend({
    headerOptions: {
      route: {

        title: __t('new_field'),
        isOverlay: true
      }
    },

    leftToolbar: function() {
      return  [
        new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "check", buttonClass: "", buttonText: __t('save')}})
      ];
    },

    events: {
      'click #removeOverlay': function() {
        app.router.removeOverlayPage(this);
      },
      'click #addBtn': function() {
        this.save();
      }
    },

    save: function() {
      this.model.set({comment: ''});
      if(this.contentView.isValid()) {
        var that = this;
        this.model.save({},{success: function(data) {
          that.model.set(data.toJSON());
          that.model.url = app.API_URL + 'tables/' + that.collection.table.id + '/columns/' + data.get('id') + '/';
          app.router.removeOverlayPage(that); //, {title: 'Add new column', stretch: true}
          that.collection.add(that.model);
          that.collection.trigger('change');

          // Verify whether the UI requires options to be set
          // in order to work.
          var ui = UIManager._getUI(data.options.get('id'));
          if (ui.requireVariables === true) {
            openFieldUIOptionsView(data);
          }
        }});
      }
    },

    afterRender: function() {
      this.setView('#page-content', this.contentView);
    },

    initialize: function(options) {
      this.contentView = new NewColumn(options);
    }
  });

  var NewColumn = Backbone.Layout.extend({

    tagName: "form",

    attributes: {
      class: "two-column-form"
    },

    template: 'modules/settings/settings-columns-add',

    events: {
      'change select#dataType': function(e) {
        this.selectedDataType = $(e.target).val();
        this.render();
      },
      'change select#uiType': function(e) {
        var columnName = this.model.get('column_name');
        this.model.clear();
        this.model.set({column_name: columnName});
        this.selectedUI = $(e.target).val();
        this.selectedDataType = null;
        this.render();
      },
      'change input#columnName': function(e) {
        this.columnName =  $(e.target).val();
        this.model.set({column_name: this.columnName});
      },
      'change input#charLength': function(e) {
        this.model.set({char_length: $(e.target).val()});
      },
      'change select#related_table': function(e) {
        this.model.set({related_table: $(e.target).val()});
        this.render();
      },
      'change #junction_key_right': function(e) {
        this.model.set({junction_key_right: $(e.target).val()});
      },
      'change #junction_key_left': function(e) {
        this.model.set({junction_key_left: $(e.target).val()});
      },
      'change #table_junction': function(e) {
        this.model.set({junction_table: $(e.target).val()});
        this.render();
      }
    },

    serialize: function() {
      var tables;
      var tableRelated;
      var uis = _.clone(UIManager._getAllUIs());
      var data = {
        ui_types: [],
        data_types: [],
        column_name: this.model.get('column_name'),
        hideFieldName: this.hideFieldName
      };

      if (_.isFunction(this.uiFilter)) {
        _.each(uis, function(value, key) {
          if (this.uiFilter(value) !== true) {
            delete uis[key];
          }
        }, this);
      }

      for(var key in uis) {
        //If not system column
        if(key.indexOf('directus_') < 0 ) {
          if(!this.selectedUI) {
            this.selectedUI = key;
          }

          var item = {title: key};

          if(this.selectedUI === key) {
            item.selected = true;
          }

          data.ui_types.push(item);
        }
      }

      data.ui_types.sort(function(a, b) {
        if (a.title < b.title)
          return -1
        if (a.title > b.title)
          return 1
        return 0
      });

      var that = this;

      uis[this.selectedUI].dataTypes.forEach(function(dataType) {
        var item = {title: dataType};
        if (['MANYTOMANY', 'ONETOMANY'].indexOf(dataType) >= 0) {
          item.value = 'ALIAS';
        }

        if (!that.selectedDataType) {
          that.selectedDataType = dataType;
        }

        if(dataType === that.selectedDataType) {
          item.selected = true;
        }

        data.data_types.push(item);
      });

      // Check if the data type needs length
      // ENUM and SET doesn't actually needs a LENGTH,
      // but the "length" value is a list of string separate by comma
      if (['VARCHAR', 'CHAR', 'ENUM', 'SET'].indexOf(this.selectedDataType) > -1) {
        data.SHOW_CHAR_LENGTH = true;
        if (!this.model.get('char_length')) {
          var charLength = ['ENUM', 'SET'].indexOf(this.selectedDataType) > -1 ? '' : 100;
          this.model.set({char_length: charLength});
        }
        data.char_length = this.model.get('char_length');
      } else {
        delete data.char_length;
        if(this.model.has('char_length')) {
          this.model.unset('char_length', {silent: true});
        }
      }

      if (['many_to_one', 'single_file', 'many_to_one_typeahead'].indexOf(this.selectedUI) > -1) {
        data.MANYTOONE = true;
        tableRelated = this.model.get('related_table');
        this.model.set({junction_key_right: this.columnName});

        if (this.selectedUI === 'single_file') {
          tables = [{id: 'directus_files', selected: true}];
        } else {
          tables = app.schemaManager.getTables();
          tables = tables.map(function(model) {
            if(!tableRelated) {
              tableRelated = model.id;
              this.model.set({related_table: model.id});
            }
            return {id: model.get('table_name'), selected: (model.id === this.model.get('related_table'))};
          }, this);
        }

        data.columns_right = [{column_name: (this.columnName || __t('this_column')), selected: true}];
        data.disabledJunctionKeyRight = true;

        data.tables = tables;
      }

      //If Single_file UI, force related table to be directus_files
      if (['single_file', 'multiple_files'].indexOf(this.selectedUI) > -1) {
        this.model.set({related_table: 'directus_files'});
        data.disabledTableRelated = true;
      }

      if (['ONETOMANY', 'MANYTOMANY'].indexOf(this.selectedDataType) > -1) {
        data[this.selectedDataType] = true;
        data.selectedRelationshipType = this.selectedRelationshipType = this.selectedDataType;
        this.isAlias = true;

        tableRelated = this.model.get('related_table');
        var junctionTable = this.model.get('junction_table');
        var junctionKeyRight = this.model.get('junction_key_right');

        // List of junction tables
        tables = app.schemaManager.getTables();
        tables = tables.map(function (model) {
          if (!tableRelated) {
            tableRelated = model.id;
            this.model.set({related_table: model.id});
          }
          return {id: model.get('table_name'), selected: (model.id === this.model.get('related_table'))};
        }, this);

        data.tables = tables;

        if(this.selectedDataType === 'MANYTOMANY') {
          data.junctionTables = _.chain(tables)
            .map(function(model) {
              if(!junctionTable){
                junctionTable = model.id;
                this.model.set({junction_table: model.id});
              }
              return {id: model.id, selected: (model.id === this.model.get('junction_table'))};
            }, this).value();

          if (junctionTable !== undefined) {
            data.columns_left = app.schemaManager.getColumns('tables', junctionTable).map(function(model) {
              return {column_name: model.id, selected: (model.id === this.model.get('junction_key_left'))};
            }, this);
            data.columns_right = app.schemaManager.getColumns('tables', junctionTable).map(function(model) {
              return {column_name: model.id, selected: (model.id === this.model.get('junction_key_right'))};
            }, this);
          }
        } else {
          if (tableRelated !== undefined) {
            data.columns = app.schemaManager.getColumns('tables', tableRelated).map(function(model) {
              return {column_name: model.id, selected: (model.id === junctionKeyRight)};
            }, this);
          }

          // hotfix: make sure the column exists in the junction table schema
          // @TODO: Verify that any other related/junction columns exists
          if (junctionKeyRight === undefined) {
            junctionKeyRight = '';
          }

          if (data.columns.length > 0) {
            var column = _.find(data.columns, function(column) {
              return column.column_name === junctionKeyRight;
            });

            if (column === undefined) {
              column = _.first(data.columns);
            }

            junctionKeyRight = column.column_name;
          }

          this.model.set({junction_key_right: junctionKeyRight});
        }

        this.model.set({relationship_type: this.selectedDataType});
      }

      var dataType = this.selectedDataType;
      if (this.isAlias === true) {
        dataType = 'ALIAS';
      }
      this.model.set({data_type: dataType, ui: this.selectedUI});

      data.isAlias = this.isAlias;

      return data;
    },

    isValid: function() {
      if(this.model.get('column_name')) {
        return true;
      }

      return false;
    },

    afterRender: function() {
      var $el = this.$el;
      var $inputColumnName = $el.find('input#columnName');
      $inputColumnName.on('change keypress paste focus textInput input', function() {
        var rawColumnName = $(this).val();
        var cleanColumnName = SchemaHelper.cleanColumnName(rawColumnName);
        var columnNameText = '';

        if (cleanColumnName && rawColumnName !== cleanColumnName) {
          columnNameText = __t('this_column_will_be_saved_as_x', {column_name: cleanColumnName});
        }

        $el.find('#cleanColumnName').text(columnNameText);
      });
    },

    initialize: function(options) {
      options = options || {};
      this.uiFilter = options.ui_filter || false;
      this.selectedUI = _.isString(this.model.get('ui')) ? this.model.get('ui') : undefined;
      this.selectedDataType = this.model.get('type') || undefined;
      this.selectedRelationshipType = this.model.get('relationship_type') || undefined;
      this.isAlias = ['ONETOMANY', 'MANYTOMANY'].indexOf(this.selectedRelationshipType) >= 0;
      if (this.isAlias) {
        this.selectedDataType = this.selectedRelationshipType;
      }
      this.columnName = this.model.get('column_name') || undefined;
      this.hideFieldName = (options.hiddenFields && options.hiddenFields.indexOf('field_name') >= 0);

      this.render();
    }
  });

  var EditColumn = BasePageView.extend({
    headerOptions: {
      route: {
        title: 'UI Settings',
        isOverlay: true
      }
    },

    leftToolbar: function() {
      this.saveWidget = new Widgets.SaveWidget({widgetOptions: {basicSave: true}});
      return [
        this.saveWidget
      ];
    },

    events: {
      'click .saved-success': function() {
        this.save();
      },
      'click #removeOverlay': function() {
        app.router.removeOverlayPage(this);
      }
    },
    save: function() {
      console.log("Save");
    },
    afterRender: function() {
      this.setView('#page-content', this.table);
    },
    initialize: function(options) {
      this.table = new Directus.EditView({model: this.model, structure: this.options.schema});
    }
  });

  var EditRelationship = NewColumnOverlay.extend({
    headerOptions: {
      route: {
        title: __t('relationship_settings'),
        isOverlay: true
      }
    }
  });

  //
  var Columns = Backbone.Layout.extend({

    tagName: 'form',

    attributes: {
      id: "table-settings"
    },

    template: 'modules/settings/settings-columns',

    events: {
      'click i[data-action=ui]': 'editUI',
      'click i[data-action=relationship]': 'editRelationship',
      'change select,input': 'bindForm',
      'click .destroy': 'verifyDestroyColumn',
      'click button[data-action=new-field]': 'newField'
    },

    newField: function(e) {
      var collection = this.collection;
      //@todo: link real col
      var model = new ColumnModel({'data_type':'ALIAS','ui':{}}, {collection: this.collection});
      var view = new NewColumnOverlay({model: model, collection: collection});
      app.router.overlayPage(view);
    },

    // Updates the models when user interacts with the form.
    bindForm: function(e) {
      var id = e.target.getAttribute('data-id');
      var attr = e.target.name;
      var value = e.target.value;
      var uiName = null;
      var model = this.collection.get(id);
      var relationship = model.relationship;
      var data = {};

      if (e.target.type === 'checkbox' || e.target.type === 'radio') {
        value = $(e.target).is(':checked') ? 1 : 0;
      }

      // hotfix: uiName was depending on the target element that was changed
      //         if the element triggering the event is not the dropdown
      //         the uiName should be the one already on the model.
      if (e.target.type === 'select-one') {
        uiName = value;
      } else {
        uiName = model.get('ui');
      }

      // hotfix #1069 single_file UI not saving relational settings
      // If Single_file UI, force related table to be directus_files
      // and relationship type to manytoone
      data['related_table'] = null;
      data['data_type'] = null;
      data['relationship_type'] = null;
      data['junction_key_right'] = null;
      data['junction_key_left'] = null;
      data['junction_table'] = null;

      if (relationship) {
        data['related_table'] = relationship.get('related_table');
        data['relationship_type'] = relationship.get('type');
        data['junction_key_right'] = relationship.get('junction_key_right');
        data['junction_key_left'] = relationship.get('junction_key_left');
        data['junction_table'] = relationship.get('junction_table');
      }

      switch(uiName) {
        case 'multiple_files':
          data['related_table'] = 'directus_files';
        case 'many_to_many':
          data['data_type'] = 'ALIAS';
          data['relationship_type'] = 'MANYTOMANY';
          break;
        case 'single_file':
          data['related_table'] = 'directus_files';
        case 'many_to_one':
        case 'many_to_one_typeahead':
          data['data_type'] = 'INT';
          data['relationship_type'] = 'MANYTOONE';
          data['junction_key_right'] = id;
          break;
        case 'one_to_many':
          data['data_type'] = 'ALIAS';
          data['relationship_type'] = 'ONETOMANY';
          break;
      }

      if (data['relationship_type'] && !model.relationship) {
        model.relationship = new Backbone.Model({
          type: data['relationship_type'],
          related_table: data['related_table'],
          junction_table: data['junction_table'],
          junction_key_right: data['junction_key_right'],
          junction_key_left: data['junction_key_left']
        });
      } else if (!data['relationship_type']) {
        model.relationship = undefined;
      }

      data[attr] = value;
      model.set(data);

      this.render();
    },

    destroyColumn: function(columnName) {
      var originalColumnModel = this.collection.get(columnName);
      var columnModel = originalColumnModel.clone();
      // url can be a function or a string
      // getting the result directly from the original model will prevent issue calling the function
      // calling the url() on the cloned model will throw an error because it doesn't have a collection object
      columnModel.url = _.result(originalColumnModel, 'url');

      if (!columnModel) {
        Notification.error('Error', 'Column '+columnName+' not found.');
        return;
      }

      var self = this;
      var onSuccess = function(model, response) {
        if (!response.success) {
          Notification.error('Column not removed', response.message);
        } else {
          self.collection.remove(originalColumnModel);
          self.$el.find('[data-id=' + model.get('id') + ']').remove();
          Notification.success('Column removed', '<b>' + columnName + '</b> was removed.');
        }
      };

      var onError = function(model, resp, options) {
        Notification.error('Column not removed', resp.responseJSON.message);
      };

      columnModel.destroy({success: onSuccess, error: onError, wait: true});
    },

    verifyDestroyColumn: function(event) {
      event.stopPropagation();

      var self = this;
      var columnName = $(event.target).closest('tr').attr('data-id');
      var destroyColumn = function() {
        self.destroyColumn(columnName);
      };

      DoubleConfirmation({
        value: columnName,
        emptyValueMessage: __t('invalid_column'),

        firstQuestion: __t('question_delete_this_column'),
        secondQuestion: __t('question_delete_this_column_confirm', {column_name: columnName}),
        notMatchMessage: __t('column_name_did_not_match'),
        callback: destroyColumn
      }, this);
    },

    sort: function() {
      var collection = this.collection;
      this.$el.find('tbody > tr').each(function(i) {
        var model = collection.get(this.getAttribute('data-id'));
        model.set({sort: i}, {silent: true});
        //console.log(model.id, {sort: i});
      });
      //collection.trigger('change');
      collection.sort();
    },

    editUI: function(e) {
      var id = e.target.getAttribute('data-id');
      var column = this.collection.get(id);
      openFieldUIOptionsView(column);
    },

    editRelationship: function(e) {
      var id = e.target.getAttribute('data-id');
      var column = this.collection.get(id);
      // NOTE: This create new attributes for the column attribute hash
      var dataType = column.get('type');
      var relationshipDataType = column.relationship.get('type');
      column.set(column.relationship.toJSON());
      // hotfix: type and relationship has to be passed as part of the hash
      // prevent the field dropdown to be empty
      // As there's not UI supporting relationship type
      column.set('relationship_type', relationshipDataType);
      column.set('type', dataType);
      var view = new EditRelationship({
        model: column,
        collection: this.collection,
        hiddenFields: ['field_name'],
        // Do not allow to select any other ui.
        ui_filter: function(ui) {
          return ui.id === column.get('ui');
        }
      });

      app.router.overlayPage(view);
    },

    serialize: function() {
      var ui = UIManager.getAllSettings({returnObject: true});
      var rows = this.collection.map(function(model) {
        var row = model.toJSON();

        row.uiHasVariables = ui.hasOwnProperty(row.ui) && ui[row.ui].hasOwnProperty('variables') && ui[row.ui].variables.length > 0;

        row.uiHasRelationship = model.relationship !== undefined;
        row.alias = ['ALIAS','ONETOMANY','MANYTOMANY'].indexOf(row.type) > -1;
        // Existing columns that should be type ALIAS
        row.type = row.alias ? 'ALIAS' : row.type;
        row.types = [];
        row.relationship = '';
        row.requiredDisabled = !row.alias && row.is_nullable === 'NO' && row.default_value === undefined;

        var validation = model.options.validate(model.options.toJSON());
        row.valid = validation === undefined;

        switch (model.getRelationshipType()) {
          case 'ONETOMANY':
            row.relationship = "⊣";
            row.relationshipTooltip = model.getRelated();
            break;
          case 'MANYTOONE':
            row.relationship = "⊢";
            row.relationshipTooltip = model.getRelated();
            break;
          case 'MANYTOMANY':
            row.relationship = "⊢⊣";
            row.relationshipTooltip = model.getRelated();
            break;
        }

        // Gather a list of UI alternatives
        _.each(ui, function(ui) {
          var dataType = (row.alias) ? model.getRelationshipType() : row.type;
          if (!ui.system && ui.dataTypes.indexOf(dataType) > -1) {
            row.types.push({id: ui.id, isActive: (ui.id === row.ui)});
          }

          //If System column and column name in config mapping, show detailed message
          if(ui.system && SettingsConfig.systemColumnDetails[row.column_name]) {
            row.systemDetails = SettingsConfig.systemColumnDetails[row.column_name];
          }
        });

        return row;
      });

      return {rows: rows};
    },

    afterRender: function() {
      var container = this.$el.find('tbody')[0];
      var that = this;
      var sort = new Sortable(container, {
        animation: 150, // ms, animation speed moving items when sorting, `0` — without animation
        handle: ".sort", // Restricts sort start click/touch to the specified element
        draggable: "tr", // Specifies which items inside the element should be sortable
        ghostClass: "sortable-ghost",
        filter: ".system", // Selectors that do not lead to dragging (String or Function)
        onStart: function (evt) {
          //var dragItem = jQuery(evt.item);
          var tbody = jQuery(container);
          tbody.addClass('remove-hover-state');
        },
        onEnd: function (evt) {
          //var dragItem = jQuery(evt.item);
          var tbody = jQuery(container);
          tbody.removeClass('remove-hover-state');
        },
        onUpdate: function (evt){
          that.sort();
        }
      });

    },

    initialize: function() {
      this.collection.on('change sync sort', this.render, this);
    }

  });

  var TableModule = Backbone.Layout.extend({
    template: 'modules/settings/module-table-settings',
    attributes: {'class': 'directus-module'},
    serialize: function() {
      return {
        hidden: this.model.get('hidden'),
        single: this.model.get('single'),
        footer: this.model.get('footer')
      };
    }
  });

  SettingsTables.Views.Table = BasePageView.extend({
    headerOptions: {
      route: {
        title: 'Classes',
        breadcrumbs: [{title: __t('settings'), anchor: '#settings'}, {title: __t('tables_and_inputs'), anchor: '#settings/tables'}]
      }
    },

    leftToolbar: function() {
      this.saveWidget = new Widgets.SaveWidget({widgetOptions: {basicSave: true}});
      return [
        this.saveWidget
      ];
    },

    events: {
      'change select,input': function(e) {
        this.saveWidget.setSaved(false); //Temporarily Just Set it to save once something is changed.
      },
      'click .saved-success': 'saveColumns'
    },

    saveColumns: function(e) {
      var data = {};

      //Take care of the checkboxes
      $('#table-settings').find('input[type=checkbox]:not(:checked)').each(function(){
        data[this.name] = 0;
      }).get();

      data = _.extend(data, $('#table-settings').serializeObject());

      this.model.save(data, {success: function(){
        app.router.go('settings','tables');
      }});
    },

    afterRender: function() {
      this.setView('#page-content', this.columns);
      this.collection.fetch();
    },

    initialize: function() {
      this.collection = this.model.columns;
      this.columns = new Columns({collection: this.collection});
      this.headerOptions.route.title = this.model.id;
    }
  });

  var Tables = Backbone.Layout.extend({

    template: 'modules/settings/settings-tables',

    addRowView: function(model, render) {
      var view = this.insertView('tbody', new TablesRow({model: model}));
      if (render !== false) {
        view.render();
      }
    },

    getPrevTableId: function(tableIndex) {
      if (tableIndex < 0) {
        tableIndex = 0;
      } else if (tableIndex > this.collection.length) {
        tableIndex = this.collection.length;
      }

      var model = this.collection.at(tableIndex);
      if (tableIndex === 0 || tableIndex === this.collection.length) {
        return model.id;
      }

      if (model.id.substring(0,9) === 'directus_') {
        return this.getPrevTableId(tableIndex-1);
      }

      return model.id;
    },

    moveRowView: function(model) {
      var currentModelIndex = this.collection.indexOf(model);
      var afterModelIndex = currentModelIndex-1;
      var tbody = this.$el.find('tbody');
      var tableId = model.id || false;
      // Get the previous table Id, ignoring `directus_` tables
      var prevTableId = this.getPrevTableId(afterModelIndex);

      if (tableId) {
        var currentRow = tbody.find('[data-id="'+tableId+'"]');
        var afterRow = tbody.find('[data-id="'+prevTableId+'"]');
        var currentRowIndex = currentRow.index();

        if(currentModelIndex === 0) {
          currentRow.prependTo(tbody);
        } else {
          currentRow.insertAfter(afterRow);
        }
      }
    },

    isValidModel: function(model) {
      //Filter out _directus tables
      if (model.id.substring(0,9) === 'directus_') return false;

      //Filter out tables you don't have alter permissions on
      var privileges = app.schemaManager.getPrivileges(model.id);

      // filter out tables with empty privileges
      if (privileges === undefined) return false;

      // only return tables with view permissions
      return privileges.has('allow_view') && privileges.get('allow_view') > 0;
    },

    flashItem: function(entryID, bodyScrollTop) {
      document.body.scrollTop = parseInt(bodyScrollTop, 10) || 0;
      app.on('load', function() {
        if(entryID) {
          this.$el.find('tr[data-id="' + entryID + '"]').flashRow();
        }
      }, this);
    },

    beforeRender: function() {
      this.collection.each(function(model) {
        if (!this.isValidModel(model)) {
          return false;
        }
        this.addRowView(model, false);
      }, this);
    },

    initialize: function() {
      this.listenTo(this.collection, 'add', function(model) {
        this.addRowView(model);
        this.moveRowView(model);
      });
      this.listenTo(app.router.v.main, 'flashItem', this.flashItem);
    }
  });

  var TablesUnRegistered = Tables.extend({

    template: 'modules/settings/settings-tables-unregistered',

    addRowView: function(model, render) {
      var view = this.insertView('tbody', new TablesRow({
        model: model,
        unregistered: true,
        parent: this
      }));
      if (render !== false) {
        view.render();
      }
    },

    beforeRender: function() {
      var self = this;
      this.unregistedCount = 0;
      this.collection.each(function(model) {
        var inactiveTable = app.schemaManager.getPrivileges(model.id) === null;
        if (!inactiveTable && !this.isValidModel(model)) {
          return false;
        }

        if (inactiveTable) {
          self.unregistedCount++;
          this.addRowView(model, false, inactiveTable);
        }
      }, this);
    },

    serialize: function() {
      return {
        unregisteredCount: this.unregistedCount
      }
    }
  });


  var TablesRow = Backbone.Layout.extend({

    template: 'modules/settings/settings-tables-rows',

    tagName: 'tr',

    attributes: function() {
      return {
        'data-id': this.model.get('table_name')
      };
    },

    events: {
      'click td span': function(e) {
        e.stopImmediatePropagation();
        var attr = $(e.target).closest('td').attr('data-attribute');

        this.toggleTableAttribute(SchemaManager.getTable($(e.target).closest('tr').attr('data-id')), attr, $(e.target));
      },
      'click td': function(e) {
        var tableName = $(e.target).closest('tr').attr('data-id');
        app.router.go(['settings','tables',tableName]);
      },
      'click .add': function(event) {
        event.stopPropagation();

        var $row = $(event.target).closest('tr');
        var tableName = $row.attr('data-id');
        var parentView = this.parentView;
        var self = this;
        app.schemaManager.addTable(tableName, function(tableModel) {
          app.router.bookmarks.addTable(tableModel);
          // a new table has been added
          // It wasn't actually added
          // As it already exists on the collection
          // this will trigger an event to add the table into the listing
          self.model.collection.trigger('add', self.model);
          if (parentView) {
            parentView.render();
          }
        });
      },
      'click .destroy': function(event) {
        event.stopPropagation();

        var tableName = $(event.target).closest('tr').attr('data-id') || this.model.get('table_name');

        DoubleConfirmation({
          value: tableName,
          emptyValueMessage: __t('invalid_table'),
          firstQuestion: __t('question_delete_this_table'),
          secondQuestion: __t('question_delete_this_table_confirm', {table_name: tableName}),
          notMatchMessage: __t('table_name_did_not_match'),
          callback: this.destroyTable
        }, this);
      }
    },

    toggleTableAttribute: function(tableModel, attr, element) {
      var data = {};

      data[attr] = !tableModel.get(attr);
      tableModel.save(data);

      app.trigger('tables:change:attributes', tableModel, attr);
      app.trigger('tables:change:attributes:' + attr, tableModel, attr);

      if(element.hasClass('add-color')) {
        element.addClass('delete-color');
        element.removeClass('add-color');
        element.removeClass('on');
      } else {
        element.addClass('add-color');
        element.removeClass('delete-color');
        element.addClass('on');
      }
    },

    destroyTable: function() {
      var options = {};
      var self = this;

      options.wait = true;
      options.success = function(model, response) {
        if (response.success === true) {
          var tableName = model.get('table_name');
          var bookmarks = app.router.bookmarks;

          self.remove();
          app.schemaManager.unregisterFullSchema(tableName);

          var model = bookmarks.findWhere({title: app.capitalize(tableName), section: 'table'});
          if (model) {
              bookmarks.remove(model);
          }

          Notification.success('Table removed', '<b>'+tableName+'</b> was removed.', 3000);
        } else {
          Notification.error(response.message);
        }
      };

      this.model.destroy(options);
    },

    serialize: function() {
      var data = this.model.toJSON();
      data.unregisteredTable = this.unregistedTable;

      return data;
    },

    initialize: function(options) {
      this.unregistedTable = options.unregistered === true;
      this.parentView = options.parent;
    }
  });

  SettingsTables.Views.List = BasePageView.extend({
    headerOptions: {
      route: {
        title: __t('tables_and_inputs'),
        breadcrumbs: [{title: __t('settings'), anchor: '#settings'}]
      },
    },

    leftToolbar: function() {
      if(!this.widgets.addWidget) {
        this.widgets.addWidget = new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "add", buttonClass: "", buttonText: __t('add')}});
      }
      return [this.widgets.addWidget];
    },

    beforeRender: function() {
      this.setView('#page-content', new Tables({collection: this.collection}));
      this.insertView('#page-content', new TablesUnRegistered({collection: this.collection}));
      BasePageView.prototype.beforeRender.call(this);
    },
    initialize: function() {
      this.widgets = {};
    },

    events: {
      'click #addBtn': 'addTableConfirmation'
    },

    addTableConfirmation: function() {
      app.router.openModal({type: 'prompt', text: __t('enter_the_name_of_a_new_or_existing_table_to_add'), callback: _.bind(this.addTable, this)});
    },

    addTable: function(tableName) {
      // @TODO: better error message.
      if (!tableName) {
        app.trigger('alert:error', __t('empty_table_name'), '', true, {
          timeout: 5000
        });
        return;
      }

      var rawTableName = tableName;
      tableName = SchemaHelper.cleanTableName(tableName);

      // Make sure it's an alphanumeric table name
      // and it has at least one character or one number
      if (!(/[a-z0-9]+/i.test(tableName) && /[_-]*/i.test(tableName))) {
        app.trigger('alert:error',
                    __t('you_must_enter_an_valid_table_name'),
                    'letters_az_numbers_andor_underscores_and_dashes',
                    true, {
          timeout: 5000
        });
        return;
      }

      if (app.schemaManager.getPrivileges(tableName)) {
        app.trigger('alert:error', 'Error', 'This table already exists!', true, {
          timeout: 5000
        });
        return;
      }

      // @TODO: make this save a table info rather than permissions.
      app.schemaManager.addTable(tableName, function(tableModel) {
        if (rawTableName !== tableName) {
          Notification.success(__t('this_table_was_saved_as_x', {table_name: tableName}));
        }
        app.router.bookmarks.addTable(tableModel);
      });
    },
  });

  function openFieldUIOptionsView(column) {
    var model = column.options;
    model.set({id: column.get('ui')});
    var schema = app.schemaManager.getColumns('ui', model.id);
    model.structure = schema;
    var view = new EditColumn({model: model, schema: schema});
    app.router.overlayPage(view);
    view.save = function() {
      model.save(view.table.data(), {success: function() {
        app.router.removeOverlayPage(view);
      }});
    };

    // hotfix: The server returns 404 not found when the ui settings are not set yet.
    // this cause the model to get error attributes as ui options
    model.fetch({
      // errorPropagation stop the application to catch this error and handle them as actual error
      errorPropagation: false,
      // edit module expect a sync event to render the page
      error: function() {
        model.trigger('sync', model);
      }
    });
  }

  return SettingsTables;

});

//  global.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('modules/settings/views/GlobalSettingsView',[
  'app',
  'backbone',
  'core/directus',
  'core/BasePageView',
  'core/widgets/widgets',
  'core/t',
],

function(app, Backbone, Directus, BasePageView, Widgets, __t) {

  

  var Global = BasePageView.extend({
    headerOptions: {
      route: {
        title: __t('settings'),
        breadcrumbs: [{ title: __t('settings'), anchor: '#settings'}]
      },
    },

    leftToolbar: function() {
      this.saveWidget = new Widgets.SaveWidget({widgetOptions: {basicSave: true}});
      this.saveWidget.setSaved(true);
      return [
        this.saveWidget
      ];
    },

    events: {
      'click .saved-success': function() {
        var data = this.editView.data();
        var success = function() { app.router.go('settings'); };
        this.model.save(data, {success: success});
      },
      'change select': 'checkDiff',
      'keyup input, textarea': 'checkDiff'
    },
    checkDiff: function(e) {
      this.saveWidget.setSaved(false);
    },

    beforeRender: function() {
      this.setView('#page-content', this.editView);
      BasePageView.prototype.beforeRender.call(this);
    },

    initialize: function(options) {
      this.editView = new Directus.EditView({model: this.model, structure: options.structure});
      this.headerOptions.route.title = this.options.title;
    }

  });

  return Global;

});

//  about.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('modules/settings/views/AboutView',[
  'app',
  'backbone',
  'core/BasePageView'
],

function(app, Backbone, BasePageView) {

  

  var About = BasePageView.extend({
    headerOptions: {
      route: {
        title: 'About',
        breadcrumbs: [{title: 'Settings', anchor: '#settings'}]
      },
    },
    afterRender: function() {
      var view = new Backbone.Layout({template: 'modules/settings/settings-about'});
      this.setView('#page-content', view);
      view.render();
    }
  });

  return About;
});
//  permissions.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('modules/settings/views/PermissionsView',[
  'app',
  'backbone',
  'core/widgets/widgets',
  'core/t',
  'core/BasePageView'
],

function(app, Backbone, Widgets, __t, BasePageView) {

  

  var Groups =  Backbone.Layout.extend({
    template: 'modules/settings/settings-groups',

    events: {
      'click button[data-action=new-group]': 'newGroup'
    },

    newGroup: function(e) {
      // @TODO either move this to permission or from permission to here
      //
      // console.log('@TODO: Create new group');
      // var collection = this.collection;
      // //@todo: link real col
      // var model = new ColumnModel({'data_type':'ALIAS','ui':{}}, {collection: this.collection});
      // var view = new NewColumnOverlay({model: model, collection: collection});
      // app.router.overlayPage(view);
    },

    serialize: function() {
      return {rows: this.collection.toJSON()};
    },

    addRowView: function(model, render) {
      var view = this.insertView('tbody', new GroupsRow({model: model}));
      if (render !== false) {
        view.render();
      }
    },

    beforeRender: function() {
      this.collection.each(function(model){
        this.addRowView(model, false);
      }, this);
    },

    initialize: function() {
      this.listenTo(this.collection, 'add', this.addRowView);
    }

  });

  var GroupsRow = Backbone.Layout.extend({

    template: 'modules/settings/settings-groups-rows',

    tagName: 'tr',

    events: {
      'click td': function(e) {
        var groupName = e.target.getAttribute('data-id');
        // Don't bypass Admins until their permissions are always guaranteed
        // if(groupName === 1) {
        //   return;
        // }
        app.router.go(['settings' ,'permissions', groupName]);
      }
    },

    serialize: function() {
      return this.model.toJSON();
    }
  });

  var Permissions = BasePageView.extend({
    headerOptions: {
      route: {
        title: __t('group_permissions'),
        breadcrumbs: [{title: 'Settings', anchor: '#settings'}]
      },
    },
    leftToolbar: function() {
      return  [
        new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "add", buttonClass: "", buttonText: __t('new_user_group')}})
      ];
    },
    events: {
      'click #addBtn': function() {
        var that = this;
        app.router.openModal({type: 'prompt', text: __t('what_would_you_like_to_name_this_group'), callback: function(groupName) {
          if(groupName && !app.schemaManager.getPrivileges('directus_permission')) {
            var model = new Backbone.Model();
            model.url = app.API_URL + 'groups';
            model.set({name: groupName});
            model.save({}, {success: function(model) {
              model.fetch({success: function(){
                that.collection.add(model);
              }});
            }});
          }
        }});
      }
    },
    beforeRender: function() {
      this.setView('#page-content', new Groups({collection: this.collection}));
      BasePageView.prototype.beforeRender.call(this);
    },
    afterRender: function() {
      // Don't bypass Admins until their permissions are always guaranteed
      // this.$el.find('td[data-id=1]').addClass('disabled');
    }
  });

  return Permissions;
});

//  system.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('modules/settings/views/SystemView',[
  'app',
  'backbone',
  'core/BasePageView'
],

function(app, Backbone, BasePageView) {

  

  var System = BasePageView.extend({
    headerOptions: {
      route: {
        title: 'System',
        breadcrumbs: [{title: 'Settings', anchor: '#settings'}]
      },
    },
    afterRender: function() {
      var view = new Backbone.Layout({template: 'modules/settings/settings-system'});
      this.setView('#page-content', view);
      view.render();
    }
  });

  return System;
});
//  permissions.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('modules/settings/views/GroupPermissionsView',[
  'app',
  'backbone',
  'handlebars',
  'core/BasePageView',
  'core/widgets/widgets',
  'core/t',
  'schema/TableModel'
],

function(app, Backbone, Handlebars, BasePageView, Widgets, __t, TableModel) {

  

  var GroupPermissions = {};

  GroupPermissions.Collection = Backbone.Collection.extend({

    getExpandedPermissions: function() {
    }

  });

  var EditFieldsOverlay = BasePageView.extend({
    headerOptions: {
      route: {
        title: __t('edit_fields'),
        isOverlay: true
      }
    },

    events: {
      'click #removeOverlay': function() {
        app.router.removeOverlayPage(this);
      }
    },

    afterRender: function() {
      this.setView('#page-content', this.contentView);
    },

    initialize: function(options) {
      this.contentView = new EditFields({model: this.model});
    }
  });

  var EditFields = Backbone.Layout.extend({
    template: 'modules/settings/settings-grouppermissions-editfield',

    events: {
      'click td > span': function(e) {
        var $target = $(e.target),
            $tr = $target.closest('tr');

        var readBlacklist = (this.model.get('read_field_blacklist')) ? this.model.get('read_field_blacklist').split(',') : [];
        var writeBlacklist = (this.model.get('write_field_blacklist')) ? this.model.get('write_field_blacklist').split(',') : [];

        //Removing so add to blacklist
        if($target.hasClass('on')) {
          $target.removeClass('on').removeClass('has-privilege');
          if($target.parent().data('value') === "read") {
            if(readBlacklist.indexOf($tr.data('column-name')) === -1) {
              readBlacklist.push($tr.data('column-name'));
              this.model.set({read_field_blacklist: readBlacklist.join(",")});
            }
          } else {
            if(writeBlacklist.indexOf($tr.data('column-name')) === -1) {
              writeBlacklist.push($tr.data('column-name'));
              this.model.set({write_field_blacklist: writeBlacklist.join(",")});
            }
          }
        } else {
          $target.addClass('on').addClass('has-privilege');;
          if($target.parent().data('value') === "read") {
            if(readBlacklist.indexOf($tr.data('column-name')) !== -1) {
              readBlacklist.splice(readBlacklist.indexOf($tr.data('column-name')), 1);
              this.model.set({read_field_blacklist: readBlacklist.join(",")});
            }
          } else {
            if(writeBlacklist.indexOf($tr.data('column-name')) !== -1) {
              writeBlacklist.splice(writeBlacklist.indexOf($tr.data('column-name')), 1);
              this.model.set({write_field_blacklist: writeBlacklist.join(",")});
            }
          }
        }

        this.model.save();
      }
    },

    serialize: function() {
      var data = {columns: []};
      var readBlacklist = (this.model.get('read_field_blacklist') || '').split(',');
      var writeBlacklist = (this.model.get('write_field_blacklist') || '').split(',');

      data.columns = app.schemaManager.getColumns('tables', this.model.get('table_name'))
            .filter(function(model) {if(model.id === 'id') {return false;} return true;})
            .map(function(model) {
              return {column_name: model.id, read: (readBlacklist.indexOf(model.id) === -1), write: (writeBlacklist.indexOf(model.id) === -1)};
            }, this);

      return data;
    },

    initialize: function(options) {
      this.render();
    }
  });

  GroupPermissions.Permissions = BasePageView.extend({
    headerOptions: {
      route: {
        title: 'Settings'
      },
    },

    template: 'modules/settings/settings-grouppermissions',

    events: {
      'click td.tableName > div': 'toggleRowPermissions',
      'click td.editFields > i': 'editFields',
      'click td > span': function(e) {
        var $target = $(e.target).parent(),
            $tr = $target.closest('tr'),
            permissions, cid, attributes, model;

        if($target.hasClass('editFields')) {
          return;
        }

        cid = $tr.data('cid');
        model = this.collection.get(cid);

        if(this.selectedState === 'all' && this.collection.where({table_name: model.get('table_name'), group_id: model.get('group_id')}).length > 1) {
          var permissionName = 'allow_'+$target.parent().data('value');
          var attribute = {};


          if($target.hasClass('big-priv')) {
            attribute[permissionName] = 0;
          } else if($target.hasClass('has-privilege')) {
            attribute[permissionName] = 2;
          } else {
            attribute[permissionName] = 1;
          }

          this.collection.each(function(cmodel) {
            if(cmodel.get('table_name') === model.get('table_name') && cmodel.get('group_id') === model.get('group_id')) {
              cmodel.set(attribute);
              cmodel.save();
              that.triggerPermissionChanged(model);
            }
          });

          return;
        }

        this.toggleIcon($target);

        attributes = this.parseTablePermissions($target);

        var fancySave = false;
        var oldModel = model;
        if(this.selectedState !== "all" && model.get('status_id') !== this.selectedState) {
          model = model.clone();
          this.model = model;
          model.collection = oldModel.collection;
          fancySave = true;
        }
        model.set(attributes);
        var that = this;
        model.save({activeState: this.selectedState}, {success: function(res) {
          if(fancySave) {
            that.collection.add(that.model);
          }
          that.triggerPermissionChanged(model);
          app.schemaManager.updatePrivileges(model.get('table_name'), attributes);
        }});
      }
    },

    // @todo: UPDATE this whole View, these value shouldn't be depending on class values.
    toggleIcon: function($span) {
      var dataValue = $span.parent().data('value');

      if($span.hasClass('yellow-color')) {
        $span.addClass('big-priv');
      } else {
        $span.toggleClass('add-color').toggleClass('delete-color').toggleClass('has-privilege');
      }
    },

    toggleRowPermissions: function(e) {
        var $target = $(e.target).parent(),
            $tr = $target.closest('tr'),
            cid = $tr.data('cid'),
            model = this.collection.get(cid),
            hasFullPermission = true,
            fullPermissions = {
                'allow_add': 1,
                'allow_edit': 2,
                'allow_delete': 2,
                'allow_alter': 1,
                'allow_view': 2
            };

        _.each(fullPermissions, function(value, key) {
            if (value !== model.get(key)) {
                hasFullPermission = false;
            }
        });

        if (!hasFullPermission) {
            model.set(fullPermissions);
        } else {
            _.each(fullPermissions, function(value, key) {
                model.set(key, 0);
            });
        }

        model.save();
        this.triggerPermissionChanged(model);
    },

    triggerPermissionChanged: function(model) {
      var tableName = model.get('table_name');
      app.schemaManager.getOrFetchTable(tableName, function(tableModel) {
        app.schemaManager.registerPrivileges([model.toJSON()]);
        app.trigger('tables:change:permissions', tableModel, model);
      });
    },

    // @todo: update this for newest permission model
    OldtoggleRowPermissions: function(e) {
      var $target = $(e.target).parent(),
        $tr = $target.closest('tr'),
        cid = $tr.data('cid'),
        model = this.collection.get(cid);

      //@todo: cleaner way to do this?
      var hasFullPerms = true;
      ['add','bigedit','bigdelete','bigview'].forEach(function (perm) {
        var permissions = model.get('permissions');
        if(!permissions || (permissions && permissions.indexOf(perm) === -1)) {
          hasFullPerms = false;
        }
      });

      var newPerms = '';

      if(!hasFullPerms)
      {
        newPerms = 'add,edit,bigedit,delete,bigdelete,view,bigview';
      }

      if(this.selectedState === 'all' && this.collection.where({table_name: model.get('table_name'), group_id: model.get('group_id')}).length > 1) {
        this.collection.each(function(cmodel) {
          if(cmodel.get('table_name') === model.get('table_name') && cmodel.get('group_id') === model.get('group_id')) {
            cmodel.set({permissions: newPerms});
            cmodel.save();
          }
        });
        return;
      }

      var fancySave = false;
      var oldModel = model;
      if(this.selectedState !== "all" && model.get('status_id') !== this.selectedState) {
        model = model.clone();
        this.model = model;
        model.collection = oldModel.collection;
        fancySave = true;
      }

      var isNewTable = model.get('permissions') ? false : true;
      model.set({permissions: newPerms});
      var that = this;
      model.save({activeState: this.selectedState}, {success: function(model) {
        if(fancySave) {
          that.collection.add(that.model);
        }

        if(isNewTable) {
          // @todo: make this a method is being used in add table as well.
          // DRY for later
          var tableName = model.get('table_name');
          var tableModel = new TableModel({id: tableName, table_name: tableName}, {parse: true, url: app.API_URL + 'tables/' + tableName});

          app.schemaManager.register('tables', [{schema: tableModel.toJSON()}]);
          app.schemaManager.registerPrivileges([{
            table_name: tableModel.get('table_name'),
            permissions: model.get('permissions'),
            group_id: model.get('group_id') || 1
          }]);
          var preferences = tableModel.preferences ? tableModel.preferences.toJSON() : {};
          app.schemaManager.registerPreferences([preferences]);
          app.router.bookmarks.add(new Backbone.Model({
            icon_class: '',
            title: app.capitalize(tableModel.get('table_name')),
            url: 'tables/' + tableModel.get('table_name'),
            section: 'table'
          }));
        }
      }});
    },

    parseTablePermissions: function($tr, model) {
      var permissions;
      var permissionPrefix = '';
      var permission = [];

      if ($tr.hasClass('big-priv')) {
        permissionPrefix = 'big';
      }

      var permissionName = $tr.closest('td').data('value');
      if(permissionPrefix) {
        permission.push(permissionName);
      }
      permission.push(permissionPrefix +  permissionName);

      var permissionLevel = 0;
      if ($tr.hasClass('delete-color')) {
        permissionLevel = 0;
      } else if (_.contains(permission, 'big' + permissionName)) {
        permissionLevel = 2;
      } else if (_.contains(permission, permissionName)) {
        permissionLevel = 1;
      }

      var attributes = {};
      attributes['allow_' + permissionName ] = permissionLevel;
      return attributes;
    },

    editFields: function(e) {
      var $target = $(e.target).parent(),
        $tr = $target.closest('tr'),
        cid, model;

        cid = $tr.data('cid');

      var model = this.collection.get(cid);
      //@todo: link real col
      var view = new EditFieldsOverlay({model: model});
      app.router.overlayPage(view);
    },

    updatePermissionList: function(value) {
      this.selectedState = value;
      this.render();
    },

    parsePermissions: function(model) {
      return {
        'add': (model.has('allow_add') && model.get('allow_add') !== 0) ? true : false,
        'edit': (model.has('allow_edit') && model.get('allow_edit') !== 0) ? true : false,
        'bigedit': (model.has('allow_edit') && model.get('allow_edit') === 2) ? true : false,
        'delete': (model.has('allow_delete') && model.get('allow_delete') !== 0) ? true : false,
        'bigdelete': (model.has('allow_delete') && model.get('allow_delete') === 2) ? true : false,
        'alter': (model.has('allow_alter') && model.get('allow_alter') !== 0) ? true : false,
        'view': (model.has('allow_view') && model.get('allow_view') !== 0) ? true : false,
        'bigview': (model.has('allow_view') && model.get('allow_view') === 2) ? true : false
      };
    },

    updateTableList: function(showCoreTables) {
      this.showCoreTables = showCoreTables;
      this.render();
    },

    serialize: function() {
      var collection = this.collection;
      var that = this;

      collection = collection.filter(function(model) {
        if(that.selectedState !== 'all') {
          var test = app.schemaManager.getColumns('tables', model.get('table_name'));
          if(test) {
            test = test.find(function(hat){return hat.id === app.statusMapping.status_name;});
            if(test) {
              return true;
            }
          }
          return false;
        }
        return true;
      });

      var tableStatusMapping = {};

      collection.forEach(function(priv) {
        if(!tableStatusMapping[priv.get('table_name')]) {
          tableStatusMapping[priv.get('table_name')] = {count: 0};
        }
        if(priv.get('status_id')) {
          tableStatusMapping[priv.get('table_name')][priv.get('status_id')] = priv;
        } else {
          tableStatusMapping[priv.get('table_name')][that.selectedState] = priv;
        }

        if(!tableStatusMapping[priv.get('table_name')][that.selectedState]) {
          tableStatusMapping[priv.get('table_name')][that.selectedState] = priv;
        }

        tableStatusMapping[priv.get('table_name')].count++;
      });

      // Create data structure suitable for view
      collection = [];

      for(var prop in tableStatusMapping) {
        collection.push(tableStatusMapping[prop][this.selectedState]);
      }

      var tableData = [];
      collection.forEach(function(model) {
        var permissions, read_field_blacklist,
            write_field_blacklist, data, defaultPermissions;

        // @TODO: use a list of actual core tables.
        if (that.showCoreTables !== true && model.get('table_name').indexOf('directus_') === 0) {
          return false;
        }

        data = model.toJSON();
        data.cid = model.cid;
        data.title = app.capitalize(data.table_name, '_', true);

        permissions = (model.get('permissions') || '').split(',');

        data.hasReadBlacklist = false;
        data.hasWriteBlacklist = false;

        var modelTable = app.schemaManager.getTable(model.get('table_name'));
        var userCreateColumnName = __t('permissions_user_created_column_no_chosen');
        if (modelTable && modelTable.has('user_create_column')) {
          userCreateColumnName = modelTable.get('user_create_column') || userCreateColumnName;
        }

        // Default permissions
        data.permissions = that.parsePermissions(model);
        data.permissions.user_create_column = userCreateColumnName;

        if(that.selectedState === 'all' && tableStatusMapping[data.table_name].count > 1) {
          var viewValConsistent = true;
          var lastView = (!data.permissions.bigview) ? ((!data.permissions.view) ? 0 : 1) : 2;
          var addValConsistent = true;
          var lastAdd = data.permissions.add;
          var editValConsistent = true;
          var lastEdit = (!data.permissions.bigedit) ? ((!data.permissions.edit) ? 0 : 1) : 2;
          var deleteValConsistent = true;
          var lastDelete = (!data.permissions.bigdelete) ? ((!data.permissions.delete) ? 0 : 1) : 2;
          for(var prop in tableStatusMapping[data.table_name]) {
            if(prop === 'all' || prop === 'count') {
              continue;
            }
            var permissions = that.parsePermissions(tableStatusMapping[data.table_name][prop]);

            if(addValConsistent) {
              addValConsistent = (permissions.add === lastAdd);
            }

            if(viewValConsistent) {
              if(permissions.bigview) {
                if(lastView !== 2) {
                  viewValConsistent = false;
                }
              }
              else if(permissions.view) {
                if(lastView !== 1) {
                  viewValConsistent = false;
                }
              }
              else if(lastView !== 0) {
                viewValConsistent = false;
              }
            }

            if(editValConsistent) {
              if(permissions.bigedit) {
                if(lastEdit !== 2) {
                  editValConsistent = false;
                }
              }
              else if(permissions.edit) {
                if(lastEdit !== 1) {
                  editValConsistent = false;
                }
              }
              else if(lastEdit !== 0) {
                editValConsistent = false;
              }
            }

            if(deleteValConsistent) {
              if(permissions.bigdelete) {
                if(lastDelete !== 2) {
                  deleteValConsistent = false;
                }
              }
              else if(permissions.delete) {
                if(lastDelete !== 1) {
                  deleteValConsistent = false;
                }
              }
              else if(lastDelete !== 0) {
                viewValConsistent = false;
              }
            }
          }

          data.permissions.addValConsistent = !addValConsistent;
          data.permissions.viewValConsistent = !viewValConsistent;
          data.permissions.editValConsistent = !editValConsistent;
          data.permissions.deleteValConsistent = !deleteValConsistent;
        }

        /*
        Don't blacklist columns yet
        read_field_blacklist = (model.get('read_field_blacklist') || '').split();
        write_field_blacklist = (model.get('write_field_blacklist') || '').split();

        data.blacklist = app.columns[data.table_name].map(function(model) {
          var readBlacklist = _.contains(read_field_blacklist, model.id);
          var writeBlacklist = _.contains(write_field_blacklist, model.id);

          if (readBlacklist) {
            data.hasReadBlacklist = true;
            data.hasWriteBlacklist = true;
          }

          return {
            column_name: model.id,
            read: readBlacklist,
            write: writeBlacklist
          };
        });
        */

        tableData.push(data);
      });

      return {tables: tableData};
    },

    initialize: function() {
      this.selectedState = "all";
      this.showCoreTables = false;
      this.collection.on('sync', this.render, this);
    }
  });

  var StatusSelectWidget = Backbone.Layout.extend({
    template: Handlebars.compile('\
    <div class="simple-select dark-grey-color simple-gray right"> \
      <span class="icon icon-triangle-down"></span> \
      <select id="statusSelect" name="status" class="change-visibility"> \
        <optgroup label="Status-Specific Editing"> \
          <option data-status value="all">Status: All Options</option> \
          {{#mapping}} \
            <option data-status value="{{id}}">Status: {{capitalize name}} Only</option> \
          {{/mapping}} \
        </optgroup> \
      </select> \
    </div>'),

    tagName: 'div',
    attributes: {
      'class': 'tool'
    },

    events: {
      'change #statusSelect': function(e) {
        var $target = $(e.target).find(":selected");
        if($target.attr('data-status') !== undefined && $target.attr('data-status') !== false) {
          this.baseView.updatePermissionList($(e.target).val());
          //var value = $(e.target).val();
          //var name = {currentPage: 0};
          //name[app.statusMapping.status_name] = value;
          //this.collection.setFilter(name);
        }
      }
    },

    serialize: function() {
      var data = {mapping: []};
      var mapping = app.statusMapping.mapping;

      for(var key in mapping) {
        //Do not show option for deleted status
        if(key !== app.statusMapping.deleted_num) {
          data.mapping.push({id: key, name: mapping[key].name});
        }
      }
      return data;
    },

    afterRender: function() {
      //$('#visibilitySelect').val(this.collection.preferences.get(app.statusMapping.status_name));
    },
    initialize: function(options) {
      this.baseView = options.baseView;
    }
  });

  var CoreTablesSelectWidget = Backbone.Layout.extend({
    template: Handlebars.compile('' +
      '<div class="checkbox">' +
      '<label for="CoreTablesSelect">{{t "show_directus_tables"}}</label><input type="checkbox" id="CoreTablesSelect" name="show-core-tables" value="1" {{#if selected}}checked="checked"{{/if}}>' +
      '</div>'),

    tagName: 'div',
    attributes: {
      'class': 'tool'
    },

    showCoreTables: false,

    events: {
      'change #CoreTablesSelect': function(e) {
        this.showCoreTables = !this.showCoreTables;
        this.baseView.updateTableList(this.showCoreTables);
      }
    },

    serialize: function() {
      return {
        selected: this.showCoreTables
      };
    },

    initialize: function(options) {
      this.baseView = options.baseView;
    }
  });

  GroupPermissions.Page = BasePageView.extend({
    headerOptions: {
      route: {
        title: __t('settings'),
        breadcrumbs: [{title: __t('settings'), anchor: '#settings'}, {title: __t('group_permissions'), anchor: '#settings/permissions'}]
      },
    },
    rightToolbar: function() {
      return [
        new StatusSelectWidget({baseView: this.view}),
        new CoreTablesSelectWidget({baseView: this.view})
      ];
    },
    afterRender: function() {
      this.setView('#page-content', this.view);
      this.collection.fetch();
      //this.insertView('#sidebar', new PaneSaveView({model: this.model, single: this.single}));
    },
    initialize: function() {
      this.headerOptions.route.title = this.options.title;
      this.view = new GroupPermissions.Permissions({collection: this.collection});
    }

  });

  return GroupPermissions;
});

//  settings.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com


define('modules/settings/settings',[
  'app',
  'backbone',
  'core/directus',
  'core/BasePageView',
  'modules/settings/views/TablesView',
  'modules/settings/views/GlobalSettingsView',
  'modules/settings/views/AboutView',
  'modules/settings/views/PermissionsView',
  'modules/settings/views/SystemView',
  'modules/settings/views/GroupPermissionsView',
  'core/t',
],

function(app, Backbone, Directus, BasePageView, Tables, Global, About, Permissions, System, GroupPermissions, __t) {

  

  var Settings = app.module();

  Settings.Global = Global;
  Settings.System = System;

  Settings.Table = Tables.Views.Table;
  Settings.Tables = Tables.Views.List;

  Settings.Permissions = Permissions;
  Settings.GroupPermissions = GroupPermissions;

  Settings.About = About;

  Settings.Main = BasePageView.extend({
    headerOptions: {
      route: {
        title: __t('settings')
      },
    },
    template: 'modules/settings/settings'
  });

  return Settings;
});

define('modules/users/views/EditUserView',[
  "app",
  "backbone",
  "core/directus",
  'core/BasePageView',
  'core/t',
  'core/widgets/widgets'
],

function(app, Backbone, Directus, BasePageView, __t, Widgets) {

  


  return BasePageView.extend({

    headerOptions: {
      route: {
        title: __t('edit_user'),
        breadcrumbs: [{ title: __t('users'), anchor: '#users'}]
      }
    },

    events: {
      'click .saved-success > #save': 'saveConfirm',
      'change #saveSelect': 'saveConfirm'
    },

    saveConfirm: function(e) {
      var data = this.editView.data();
      var that = this;
      if(data[app.statusMapping.status_name] && data[app.statusMapping.status_name] === app.statusMapping.deleted_num) {
        app.router.openModal({type: 'confirm', text: __t('confirm_delete_item'), callback: function() {
          that.save(e);
        }});
      } else {
        this.save(e);
      }
    },

    save: function(e) {
      var action = 'save-form-leave';
      if(e.target.options !== undefined) {
        action = $(e.target.options[e.target.selectedIndex]).val();
      }
      var data =  $('form').serializeObject();
      var model = this.model;
      var isNew = this.model.isNew();
      var collection = this.model.collection;
      var success;

      if (action === 'save-form-stay') {
        success = function(model, response, options) {
          var route = Backbone.history.fragment.split('/');
          route.pop();
          route.push(model.get('id'));
          app.router.go(route);
        };
      } else {
        success = function(model, response, options) {
          var route = Backbone.history.fragment.split('/');
          route.pop();
          if (action === 'save-form-add') {
            // Trick the router to refresh this page when we are dealing with new items
            if (isNew) app.router.navigate("#", {trigger: false, replace: true});
            route.push('new');
          }
          app.router.go(route);
        };
      }

      if (action === 'save-form-copy') {
        var clone = model.toJSON();
        delete clone.id;
        model = new collection.model(clone, {collection: collection, parse: true});
        collection.add(model);
      }

      // hotfix: if password is empty omit
      if (!data.password) {
        delete data.password;
      }

      // patch only the changed values
      model.save(model.diff(data), {
        success: success,
        error: function(model, xhr, options) {
          console.error('err');
        },
        wait: true,
        patch: true,
        includeRelationships: true
      });
    },

    leftToolbar: function() {
      var collection = this.model.collection;
      var canAdd = this.model.isNew() && collection.canAdd();
      var canEdit = !this.model.isNew() && collection.canEdit();
      if (!canAdd && !canEdit) {
        return;
      }

      this.saveWidget = new Widgets.SaveWidget({widgetOptions: {basicSave: this.headerOptions.basicSave}});
      this.saveWidget.setSaved(false);
      return [
        this.saveWidget
      ];
    },

    afterRender: function() {
      var editView = this.editView;
      this.setView('#page-content', editView);
      if (!this.model.isNew()) {
        this.model.fetch();
      } else {
        editView.render();
      }
    },

    initialize: function(options) {
      this.editView = new Directus.EditView({model: this.model});
      this.headerOptions.route.title = (this.model.id) ? this.model.get('first_name') + ' ' + this.model.get('last_name') : __t('new_user');
    }
  });
});

define('modules/users/views/ListUsers',[
  "app",
  "backbone",
  'handlebars',
  "core/directus",
  'core/BasePageView',
  'core/widgets/widgets',
  'core/t',
  'moment'
],

function(app, Backbone, Handlebars, Directus, BasePageView, Widgets, __t, moment) {

  

  var BodyView = Backbone.Layout.extend({

    tagName: 'span',

    events: {
      'click .header-image, .primary-info': function(e) {
        var id = $(e.target).closest('li.card').attr('data-id');
        var user = app.users.getCurrentUser();
        var userGroup = user.get('group');

        //@todo fix this so it respects ACL instead of being hardcoded
        if (!(parseInt(id,10) === user.id || userGroup.id === 1)) {
          return;
        }

        app.router.go('#users', id);
      }
    },

    template: Handlebars.compile(
      '{{#groups}}' +
      '<div class="section-header"><span class="big-label-text">{{title}}</div>' +
      '<ul class="cards row">' +
      '{{#rows}}' +
      '<li class="card card-shadow col-2 gutter-bottom {{#if online}}active{{/if}} {{#if inactive}}inactive{{/if}}" data-id="{{id}}" data-cid="{{cid}}">' +
        '<div class="header-image add-color-border rounded-corners">' +
          '{{avatar}} <div class="tool-item large-circle"><i class="material-icons">edit</i></div></div>' +
        '<div class="info rounded-corners">' +
          '<div class="featured">' +
            '<div class="primary-info">' +
              '<div>{{first_name}}</div>' +
              '<div>{{last_name}}</div>' +
            '</div>' +
            '<div title="{{position}}" class="secondary-info ellipsis">{{#if position}}{{position}}{{else}}<span class="secondary-info">--</span>{{/if}}</div>' +
          '</div>' +
          '<ul class="extra">' +
            '<li title="{{location}}">{{#if location}}{{location}}{{else}}<span class="secondary-info">--</span>{{/if}}<span class="icon icon-home"></span></li>' +
            '<li title="{{phone}}">{{#if phone}}{{phone}}{{else}}<span class="secondary-info">--</span>{{/if}}<span class="icon icon-phone"></span></li>' +
            '<li title="{{email}}">{{#if email}}<a href="mailto:{{email}}" target="_blank">{{email}}</a>{{else}}<span class="secondary-info">--</span>{{/if}}<span class="icon icon-mail"></span></li>' +
          '</ul>' +
        '</div>' +
      '</li>' +
      '{{/rows}}</ul>{{/groups}}' +
      '{{#unless groups}}' +
        '<div class="nothing-here secondary-info">' +
        '<h1>{{t "listing_items_not_found"}}</h1>' +
        '<!-- Maybe add a new file? -->' +
        '</div>' +
      '{{/unless}}'
    ),

    serialize: function() {
      var rows = this.collection.map(function(model) {

        var data = {
          "id": model.get('id'),
          "cid": model.cid,
          'avatar': model.getAvatar(),
          'avatar_file_id': model.get('avatar_file_id'),
          'first_name': model.get('first_name'),
          'last_name': model.get('last_name'),
          'email': model.get('email'),
          'position': model.get('position'),
          'location': model.get('location'),
          'phone': model.get('phone'),
          'online': (moment(model.get('last_access')).add('m', 5) > moment()),
          'group_id': model.get('group').id,
          'group_name': model.get('group').get('name'),
          'inactive': false
        };

        // Put non-active users into the Inactive Group.
        var hasStatusColumn = model.has(app.statusMapping.status_name);
        var statusValue = model.get(app.statusMapping.status_name);
        if (hasStatusColumn && statusValue !== app.statusMapping.active_num) {
          data.group_id = 0;
          data.group_name = 'Inactive';
          data.inactive = true;
        }

        var avatarSmall = model.getAvatar();

        data.avatar = new Handlebars.SafeString('<img src="' + avatarSmall + '" style="width:200px;height:200px"/>');

        return data;
      });

      rows = _(rows).sortBy('first_name');

      var groupedData = [];

      rows.forEach(function(group) {
        if(!groupedData["group_" + group.group_id]) {
          groupedData["group_" + group.group_id] = {title: group.group_name, rows: []};
        }
        groupedData["group_" + group.group_id].rows.push(group);
      });

      var data = [];

      for(var group in groupedData) {
        // skip inactive group
        // and push it at the end
        if (group !== 'group_0') {
          data.push(groupedData[group]);
        }
      }

      // if exists, push inactive users group at the end
      if (_.has(groupedData, 'group_0')) {
        data.push(groupedData['group_0']);
      }

      return {groups: data};
    },

    initialize: function(options) {
      this.collection.on('sort', this.render, this);
      this.listenTo(this.collection, 'sync', function(model, resp, options) {
        if (options.silent) return;
        this.render();
      });
    }

  });

  var ListBodyView = Backbone.Layout.extend({

    tagName: 'tbody',

    template: Handlebars.compile(
      '{{#rows}}' +
      '<tr data-id="{{id}}" data-cid="{{cid}}">' +
      '<td>{{avatar}}</td>' +
      '<td>{{first_name}}</td>' +
      '<td>{{last_name}}</td>' +
      '<td>{{email}}</td>' +
      '<td>{{position}}</td>' +
      '<td>{{last_access}}</td>' +
      '</tr>' +
      '{{/rows}}'
    ),

    serialize: function() {
      var rows = this.collection.map(function(model) {

        var data = {
          "id": model.get('id'),
          "cid": model.cid,
          'avatar': model.getAvatar(),
          'first_name': model.get('first_name'),
          'last_name': model.get('last_name'),
          'email': model.get('email'),
          'position': model.get('position'),
          'last_access': model.get('last_access')
        };

        if (data.avatar !== null) {
            //@todo this is a hack, maybe change avatar so it only includes a hash?
            var avatarSmall = data.avatar.replace('?s=100','?s=50');
            data.avatar = new Handlebars.SafeString('<img src="' + avatarSmall + '" style="max-width:none!important;"/>');
        }

        return data;

      });

      return {rows: rows};
    },

    initialize: function(options) {
      this.collection.on('sort', this.render, this);
    }

  });


  var ListView = Directus.Table.extend({

    TableBody: ListBodyView,

    navigate: function(id) {
      var user = app.users.getCurrentUser();
      var userGroup = user.get('group');

      //@todo fix this so it respects ACL instead of being hardcoded
      if (!(parseInt(id,10) === user.id || userGroup.id === 1)) {
        return;
      }

      app.router.go('#users', id);
    }
  });


  var View = BasePageView.extend({

    headerOptions: {
      route: {
        title: __t('users'),
      }
    },
    leftToolbar: function() {
      if(app.users.getCurrentUser().get('group').id === 1) {
        return [
          new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "add", buttonClass: "", buttonText: __t('new_user')}})
        ];
      }
      return [];
    },
    rightToolbar: function() {
      return [
        //new Widgets.SearchWidget(),
        //new Widgets.ButtonWidget({widgetOptions: {active: this.viewList, buttonId: "listBtn", iconClass: "icon-list"}}),
        //new Widgets.ButtonWidget({widgetOptions: {active: !this.viewList, buttonId: "gridBtn", iconClass: "icon-layout"}})
      ];
    },
    leftSecondaryToolbar: function() {
      if(!this.widgets.visibilityWidget) {
        this.widgets.visibilityWidget = new Widgets.VisibilityWidget({collection: this.collection, basePage: this});
      }
      if(!this.widgets.filterWidget) {
        this.widgets.filterWidget = new Widgets.FilterWidget({collection: this.collection, basePage: this});
      }

      return [this.widgets.visibilityWidget, this.widgets.filterWidget];
    },
    events: {
      'click #addBtn': function() {
        app.router.go('#users','new');
      },
      'click #gridBtn': function() {
        if(this.viewList) {
          this.viewList = false;
          $('#listBtn').parent().removeClass('active');
          $('#gridBtn').parent().addClass('active');
          this.table = new BodyView({collection:this.collection});
          this.render();
        }
      },
      'click #listBtn': function() {
        if(!this.viewList) {
          this.viewList = true;
          $('#listBtn').parent().addClass('active');
          $('#gridBtn').parent().removeClass('active');
          this.table = new ListView({collection:this.collection, selectable: false});
          this.render();
        }
      }
    },

    afterRender: function() {
      this.setView('#page-content', this.table);
      var status = this.collection.preferences.get('status');
      // Ignore preferences and get all users
      // @todo: make a better solution
      this.collection.preferences.unset('status');
      this.collection.filters['status'] = '0,1,2';
      this.collection.fetch();
      this.collection.preferences.set('status', status);
    },

    initialize: function() {
      this.viewList = false;
      this.table = new BodyView({collection:this.collection});
      this.widgets = [];
    }
  });


  return View;

});

define('modules/users/users',[
  'app',
  'modules/users/views/EditUserView',
  'modules/users/views/ListUsers'
],

function(app, EditUserView, ListUsers) {

  

  var users = app.module();

  users.Views.Edit = EditUserView;
  users.Views.List = ListUsers;

  return users;
});
define('modules/messages/views/ListMessagesView',[
  'app',
  'backbone',
  'core/t',
  'core/BasePageView',
  'core/widgets/widgets',
  'moment'
],

function(app, Backbone, __t, BasePageView, Widgets, moment) {

  var ListView = Backbone.Layout.extend({

    template: 'modules/messages/messages-list',

    events: {
      'click .message': function(e) {
        var id = $(e.target).closest('.message').attr('data-id');
        app.router.go('#messages', id);
      }
    },

    serialize: function() {
      var data = this.collection.map(function(model) {
        var data = model.toJSON();
        var momentDate = moment(data.date_updated);
        data.timestamp = parseInt(momentDate.format('X'), 10);
        data.niceDate = moment().diff(momentDate, 'days') > 1 ? momentDate.format('MMMM D') : momentDate.fromNow();
        data.read = model.getUnreadCount() === 0;
        data.responsesLength = data.responses.length;
        data.from = parseInt(data.from, 10);

        if(data.recipients) {
          var recipients = data.recipients.split(',');
        } else {
          var recipients = [];
        }

        data.recipients = [];
        var extra = 0;

        for(var i=0; i<recipients.length; i++) {
          if(i > 2) {
            extra = recipients.length - i;
            break;
          }

          var user = app.users.get(recipients[i]);
          if (user !== undefined) {
            data.recipients.push(user.get('first_name'));
          }
        }

        data.recipients = data.recipients.join(", ");

        if(extra) {
          data.recipients += " (+"+extra+" more)";
        }

        //console.log(_.map(data.responses, 'from'));
        return data;
      });

      // Order the data by timestamp
      data = _.sortBy(data, function(item) {
        return -item.timestamp;
      });

      return {messages: data};
    },

    initialize: function() {
      this.collection.on('sync', this.render, this);
    }

  });

  return BasePageView.extend({

    headerOptions: {
      route: {
        title: __t('messages')
      }
    },
    leftToolbar: function() {
      return [
        new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "add", buttonClass: "", buttonText: __t('new_message')}})
      ];
    },
    rightToolbar: function() {
      return [
        //new Widgets.SearchWidget()
      ];
    },

    events: {
      'click #addBtn': function() {
        app.router.go('#messages','new');
      }
    },

    serialize: function() {
      return {
        title: 'Messages',
        buttonTitle: 'Compose'
      };
    },

    beforeRender: function() {
      var view = new ListView({collection: this.collection});
      this.setView('#page-content', view);
      BasePageView.prototype.beforeRender.call(this);
    }
  });
});

define('modules/messages/views/NewMessageView',[
  'app',
  'backbone',
  'core/t',
  'core/directus',
  'core/BasePageView',
  'core/widgets/widgets',
  'moment',
  'core/notification'
],
function(app, Backbone, __t, Directus, BasePageView, Widgets, moment, Notification) {

  return BasePageView.extend({
    headerOptions: {
      route: {
        title: __t('message_compose'),
        breadcrumbs: [{title: __t('messages'), anchor: '#messages'}]
      }
    },

    leftToolbar: function() {
      return  [
        new Widgets.ButtonWidget({widgetOptions: {buttonId: "addBtn", iconClass: "send", buttonClass: "", buttonText: __t('send_message')}})
      ];
    },
    events: {
      'click #addBtn': function(e) {
        var data = this.editView.data();

        data.read = "1";
        data.date_updated = moment().format("YYYY-MM-DD HH:mm:ss")

        this.model.save(data, {success: function(model, res) {
          if(res.warning) {
            Notification.warning(null, res.warning, {timeout: 5000});
          }

          app.router.go('#messages');
        }});

        this.model.collection.add(this.model);
      }
    },

    afterRender: function() {
      this.editView = new Directus.EditView({model: this.model});
      this.setView('#page-content', this.editView);
      this.editView.render();
    }

  });
});

define('modules/messages/views/ReadMessageView',[
  'app',
  'underscore',
  'backbone',
  'handlebars',
  'moment',
  'core/BasePageView'
],
function(app, _, Backbone, Handlebars, moment, BasePageView) {


  var ReadView = Backbone.Layout.extend({

    maxRecipients: 10,

    template: 'modules/messages/messages-reading',

    events: {
      'click #messages-response-button': function() {
        var collection = this.model.get('responses');
        var Model = collection.model;
        var myId = app.users.getCurrentUser().get('id');

        if($('#messages-response').val() === "") {
          return;
        }

        var recipients = _.map(this.model.get('recipients').split(','), function(id) {
          return '0_' + id;
        });
        recipients.push('0_'+this.model.get('from'));

        var attrs = {
          'from': app.users.getCurrentUser().get('id'),
          'subject': 'RE: ' + this.model.get('subject'),
          'recipients': recipients.join(','),
          // @TODO: Server must set this attribute
          'datetime': moment().format("YYYY-MM-DD HH:mm:ss"),//new Date().toISOString(),
          'response_to': this.model.id,
          'message': $('#messages-response').val(),
          'responses': []
        };

        var model = new Model(attrs, {
          collection: collection,
          parse: true,
          url: app.API_URL + 'messages/rows/'
        });

        // @TODO: Get ID after create message
        // Create an API endpoint for new messages
        // returning a JSON with the new message
        model.save();
        collection.add(model);
        this.render();
      },
      'click #messages-show-recipients': function() {
        var $el = $('#messages-recipients');
        $el.toggle();
      }
    },

    serialize: function() {
      var data = this.model.toJSON();
      data.recipients = data.recipients.split(',');
      data.recipientsCount = data.recipients.length;
      data.collapseRecipients = data.recipients.length > this.maxRecipients;
      data.current_user = app.authenticatedUserId;

      data.responses = _.sortBy(data.responses, function(response) {
        return new Date(response.datetime);
      }).reverse();

      var title = data.message;
      var offset = 0;
      while(true) {
        if(title) {
          var atPos = title.indexOf('@[');
          if(atPos !== -1) {
            var spacePos = title.substring(atPos).indexOf(' ');
            if(spacePos !== -1) {
              var substring = title.substring(atPos + 2, spacePos + atPos);
              var contains = /^[0-9]|_+$/.test(substring);
              if(contains) {
                var bracketPos2 = title.indexOf(']');
                if(bracketPos2 !== -1) {
                  var name = title.substring(spacePos + 1 + atPos, bracketPos2);
                  var newTitle = data.message;
                  data.message = newTitle.substring(0, atPos + offset) + "<span class=\"mention-tag\">" + name + "</span>";
                  var newOffset = data.message.length;
                  data.message += newTitle.substring(bracketPos2 + offset + 1);
                  title = newTitle.substring(bracketPos2 + offset + 1);
                  offset = newOffset;
                  continue;
                }
              }
            }
          }
        }
        break;
      }

      data.message = new Handlebars.SafeString(app.replaceAll('\n', '<br>', data.message));

      return data;
    },

    initialize: function() {
      this.model.on('change:read', function() {
        this.model.markAsRead({save: true});
        this.render();
      }, this);
      this.model.markAsRead({save: true});
    }

  });

  return BasePageView.extend({
    headerOptions: {
      route: {
        title: "Read",
        breadcrumbs: [{title: 'Messages', anchor: '#messages'}]
      }
    },
    afterRender: function() {
      var readView = new ReadView({model: this.model});
      this.setView('#page-content', readView);
      if (this.model.has('message')) {
        readView.render();
      }
    },
    initialize: function() {
      this.headerOptions.route.title = this.model.get('subject');
    }
  });
});

define('modules/messages/MessageModel',[
  "app",
  "backbone",
  "core/entries/EntriesModel"
],

function(app, Backbone, EntriesModel) {
  return EntriesModel.extend({

    getUnreadCount: function() {
      var unread = this.get('read') === 1 ? 0 : 1;

      var unreadResponses = this.get('responses').reduce(function(memo, model){
        var unread = model.get('read') === 1 ? 0 : 1;
        return memo + unread;
      }, 0);

      return unread + unreadResponses;
    },

    markAsRead: function(options) {
      options = options || {};

      var unreadCount = this.getUnreadCount();

      // Do nothing if model is allready read
      if (unreadCount === 0) {
        return;
      }

      // Decrease unread counter
      this.collection.unread -= unreadCount;

      if (options.save) {
        return this.save({read: 1}, {patch: true, silent: true});
      }

      return this.set({read: "1"}, {silent: true});
    }

  });
});

define('modules/messages/MessageCollection',[
  "app",
  "backbone",
  "core/entries/EntriesCollection",
  "modules/messages/MessageModel"
],

function(app, Backbone, EntriesCollection, MessageModel) {

  return EntriesCollection.extend({

    model: MessageModel,

    updateFrequency: 10000,

    filters: {columns_visible: ['from','subject','date_updated'], sort: 'date_updated', sort_order: 'DESC'},

    updateMessages: function() {
      var that = this;
      var data = {
        'max_id': this.maxId
      };

      this.fetch({data: data, remove: false, global: false, error: function(collection, response, options) {
        that.trigger('error:polling');
        that.stopPolling();
      }});

    },

    startPolling: function(ms) {
      this.timerId = window.setInterval(this.updateMessages.bind(this), this.updateFrequency);
    },

    stopPolling: function(ms) {
      clearInterval(this.timerId);
      window.setTimeout(this.startPolling.bind(this), 30000);
    },

    parse: function(response) {
      if (response === null) return [];

      if (response.max_id !== undefined) {
        this.maxId = response.max_id;
        this.unread = response.unread;
        this.total = response.total;
      }

      return response.rows;
    },

    // Restore fetch to default style
    fetch: function(options) {
      this.trigger('fetch', this);
      EntriesCollection.prototype.fetch.call(this, options);
    }
  });
});
//  messages.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
define('modules/messages/messages',[
  'app',
  'modules/messages/views/ListMessagesView',
  'modules/messages/views/NewMessageView',
  'modules/messages/views/ReadMessageView',
  'modules/messages/MessageCollection'
],

function(app, ListMessagesView, NewMessageView, ReadMessageView, MessageCollection) {

  

  var Messages = app.module();

  Messages.Views.New = NewMessageView;
  Messages.Views.Read = ReadMessageView;
  Messages.Views.List = ListMessagesView;
  Messages.Collection = MessageCollection;

  return Messages;
});
//  router.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com

define('router',['require','exports','module','app','underscore','core/notification','core/tabs','core/bookmarks','schema/SchemaManager','core/EntriesManager','core/ExtensionManager','modules/activity/activity','modules/tables/table','modules/settings/settings','modules/files/files','modules/users/users','modules/messages/messages','core/modal','core/t','moment'],function(require, exports, module) {

  

  var app              = require('app'),
      _                = require('underscore'),
      Notification     = require('core/notification'),
      //Directus       = require('core/directus'),
      Tabs             = require('core/tabs'),
      Bookmarks        = require('core/bookmarks'),
      SchemaManager    = require('schema/SchemaManager'),
      EntriesManager   = require('core/EntriesManager'),
      ExtensionManager = require('core/ExtensionManager'),
      Activity         = require('modules/activity/activity'),
      Table            = require('modules/tables/table'),
      Settings         = require('modules/settings/settings'),
      Files            = require('modules/files/files'),
      Users            = require('modules/users/users'),
      Messages         = require('modules/messages/messages'),
      Modal            = require('core/modal'),
      __t              = require('core/t'),
      moment           = require('moment');

  var Router = Backbone.Router.extend({

    routes: {
      "":                                            "tables",
      "tables(/pref/:pref)":                         "tables",
      "tables/:name(/pref/:pref)(/pref/:pref)":      "entries",
      "tables/:name/:id(/pref/:pref)":               "entry",
      "activity(/pref/:pref)":                       "activity",
      "files(/pref/:pref)(/pref/:pref)":             "files",
      "files/:id(/pref/:pref)":                      "filesItem",
      "users(/pref/:pref)(/pref/:pref)":             "users",
      "users/:id(/pref/:pref)":                      "user",
      "settings(/pref/:pref)":                       "settings",
      "settings/:name(/pref/:pref)":                 "settings",
      "settings/tables/:table(/pref/:pref)":         "settingsTable",
      "settings/permissions/:groupId(/pref/:pref)":  "settingsPermissions",
      "messages(/pref/:pref)":                       "messages",
      "messages/new(/pref/:pref)":                   "newMessage",
      "messages/:id(/pref/:pref)":                   "message",
      '*notFound':                                   "notFound"
    },

    route: function(route, name, callback) {
      var router = this;
      var args = _.toArray(arguments);
      if (!callback) callback = this[name];

      var cb = function() {
        if (_.isFunction(this.before)) this.before.apply(router, args);
        callback.apply(router, arguments);
        if (_.isFunction(this.after)) this.after.apply(router, args);
      };
      return Backbone.Router.prototype.route.call(this, route, name, cb);
    },

    navigateTo: function(route, alertMessage) {
      this.showAlertNextRoute(alertMessage);
      this.navigate(route, {trigger: true});
    },

    getRouteParameters: function(route, fragment) {
      var r = this._routeToRegExp(route);
      var args = this._extractParameters(r, fragment);
      return args;
    },
    // @todo: refactoring
    before: function(route, name) {
      var fragment = Backbone.history.fragment;
      if(fragment) {
        var routeHistoryBase = fragment;
        if (this.routeHistory.base === '' || routeHistoryBase.indexOf(this.routeHistory.base) !== 0) {
          this.routeHistory.base = routeHistoryBase;
          this.routeHistory.stack = [];
          this.routeHistory.routes = {};
        }

        var currentRoute = _.last(this.routeHistory.stack);
        var nextRoute = {route: name, path: fragment, args: this.getRouteParameters(route, fragment)};

        // Exists
        if(currentRoute && nextRoute) {
          var current = currentRoute = this.routeHistory.routes[currentRoute.path];
          var next = this.routeHistory.routes[nextRoute.path];

          if(next) {
            delete this.routeHistory.routes[currentRoute.path];
            currentRoute = undefined;
          }
        }

        if(currentRoute) {
          currentRoute.scrollTop = parseInt(document.body.scrollTop, 10) || 0;
          currentRoute.toRoute = nextRoute;
        }
        this.routeHistory.stack.push(nextRoute);
        this.routeHistory.last = currentRoute ? currentRoute.path : fragment;
        if(!this.routeHistory.routes[fragment]) {
          this.routeHistory.routes[fragment] = nextRoute;
        }
      }

      var mainSidebar = document.getElementById('mainSidebar');
      if(mainSidebar) {
        this.scrollTop = parseInt(mainSidebar.scrollTop, 10) || 0;
      }
    },

    after: function(route, name) {
      var currentRoute = this.routeHistory.routes[this.routeHistory.last];
      var itemID, scrollTop = 0;
      if(currentRoute && currentRoute.path === Backbone.history.fragment) {
        if(currentRoute.toRoute) {
          itemID = _.last(_.filter(currentRoute.toRoute.args, function(v){ return v !== null}));
        }
        scrollTop = currentRoute.scrollTop;
      }

      this.v.main.trigger.apply(this.v.main, ['flashItem', itemID, scrollTop]);

      var mainSidebar = document.getElementById('mainSidebar');
      if(mainSidebar) {
        mainSidebar.scrollTop = this.scrollTop;
      }

      _.each(app.user_notifications, function(notification) {
        var title = notification.title;
        var text = notification.text;
        var type = notification.type || 'Information';

        Notification.show(title, text, type);
      });

      app.user_notifications = [];
    },

    go: function() {
      var array = _.isArray(arguments[0]) ? arguments[0] : _.toArray(arguments);
      return this.navigate(array.join("/"), true);
    },

    setTitle: function(title) {
      document.title = title;
    },

    showAlert: function(message, type) {
      if (!this.alert) {
        this.alert = new Backbone.Layout({template: 'alert', serialize: {message: message, type: type}});
        this.v.messages.insertView(this.alert).render();
      }
    },

    showAlertNextRoute: function(message) {
      if (!_.isString(message)) {
        return;
      }

      this.pendingAlert = {
        message: message,
        type: 'alert'
      };
    },

    hideAlert: function() {
      if (this.alert) {
        this.alert.remove();
        this.alert = undefined;
      }
    },

    notFound: function() {
      this.navigateTo('/tables', 'You don\'t have permission to view that page or it doesn\'t exist');
    },

    openModal: function(options, callback) {
      if(this.v.main.getViews('#modal-container')._wrapped.length >= 1) {
        return;
      }

      var modalView = new Modal.Prompt(options);
      this.v.main.insertView('#modal-container', modalView).render();
    },

    overlayPage: function(view) {
      if(this.v.main.getViews('#content')._wrapped.length <= 1) {
        this.baseRouteSave = Backbone.history.fragment;
        this.oldLoadUrlFunction = Backbone.History.prototype.loadUrl;
      }

      var lastView = this.v.main.getViews('#content').last()._wrapped;
      lastView.scrollTop = document.body.scrollTop;
      this.v.main.getViews('#content').each(function(view) {
        view.$el.hide();
      });

      // @TODO: move this into a global collection
      if (view.model) {
        if (!view.model._trackingChanges) {
          view.model.startTracking();
        }
      } else if (view.collection) {
        // TODO: make startTtracking part of Collection
        var cb = function(collection) {
          collection.each(function(model) {
            if (!model._trackingChanges) {
              model.startTracking();
            }
          });
        };

        cb(view.collection);
        view.collection.on('sync', cb);
      }

      function hasUnsavedAttributes() {
        if (view.model) {
          return !view.model.unsavedAttributes();
        } else if (view.collection) {
          return _.some(view.collection.models, function(model) {
            return !model.unsavedAttributes();
          });
        }

        return false;
      }

      this.v.main.insertView('#content', view).render();

      var that=this;
      Backbone.History.prototype.loadUrl = function() {
        if (hasUnsavedAttributes() || (that.baseRouteSave === this.getFragment() || window.confirm("All Unsaved changes will be lost, Are you sure you want to leave?"))) {
          Backbone.History.prototype.loadUrl = that.oldLoadUrlFunction;
          return that.oldLoadUrlFunction.apply(this, arguments);
        } else {
          this.navigate(that.baseRouteSave);
          that.navigate(that.baseRouteSave);
          return true;
        }
      };
    },

    removeOverlayPage: function(view) {
      view.remove(); //Remove Overlay Page
      var vieww = this.v.main.getViews('#content').last()._wrapped;
      vieww.$el.show();

      if(vieww.scrollTop !== undefined) {
        document.body.scrollTop = parseInt(vieww.scrollTop, 10);
      }

      if(this.v.main.getViews('#content')._wrapped.length <= 1) {
        Backbone.History.prototype.loadUrl = this.oldLoadUrlFunction;
        this.navigate(this.baseRouteSave);
        this.baseRouteSave = undefined;
      }
    },

    setPage: function(View, options) {
      this.v.main.setView('#content', new View(options)).render();
    },

    tables: function() {
      if (_.contains(this.navBlacklist,'tables'))
        return this.notFound();

      this.navigate('/tables'); //If going to / rewrite to tables
      this.setTitle(app.settings.get('global').get('project_name') + ' | Tables');
      this.v.main.setView('#content', new Table.Views.Tables({collection: SchemaManager.getTables()}));
      this.v.main.render();
    },

    entries: function(tableName, pref) {
      var privileges = SchemaManager.getPrivileges(tableName);
      if (_.contains(this.navBlacklist,'tables') || (privileges && privileges.get('allow_view') === 0)) {
        return this.notFound();
      }

      var collection;

      $.xhrPool.abortAll();

      if (!SchemaManager.getTable(tableName)) {
        return this.notFound();
      }

      // see if the collection is cached...
      if (this.currentCollection !== undefined && this.currentCollection.table.id === tableName) {
        collection = this.currentCollection;
      } else {
        collection = EntriesManager.getInstance(tableName);
      }

      if (collection.table.get('single')) {
        if(collection.models.length) {
          this.entry(tableName, collection.models[0].get('id'));
        } else {
          // Fetch collection so we know the ID of the "single" row
          collection.once('sync', _.bind(function(collection, xhr, status){
            if(0 === collection.length) {
              // Add new form
              this.router.entry(tableName, "new");
            } else {
              // Edit first model
              var model = collection.models[0];
              this.router.entry(tableName, model.get('id'));
            }
          }, {router:this}));
          collection.fetch();
        }
        return;
      }

      //Clear loaded preference if navigating to new entries
      if (this.loadedPreference) {
        this.loadedPreference = undefined;
      }

      if (pref) {
        this.loadedPreference = pref;
      }

      // Cache collection for next route
      this.currentCollection = collection;
      this.setTitle(app.settings.get('global').get('project_name') + ' | ' + app.capitalize(tableName));

      this.v.main.setView('#content', new Table.Views.List({collection: collection}));
      this.v.main.render();
    },

    entry: function(tableName, id) {
      if (_.contains(this.navBlacklist,'tables'))
        return this.notFound();

      this.setTitle(app.settings.get('global').get('project_name') + ' | Entry');

      var isBatchEdit = (typeof id === 'string') && id.indexOf(',') !== -1,
          collection,
          model,
          view;

      // see if the collection is cached...
      if (this.currentCollection !== undefined && this.currentCollection.table.id === tableName) {
        collection = this.currentCollection;
      } else {
        collection = EntriesManager.getInstance(tableName);
      }

      if (collection === undefined) {
        return this.notFound();
      }

      if (collection.structure.length <= 1) {
        var message = 'Table only has one or no fields.';
        this.navigateTo('/tables/' + tableName, message);
        return;
      }

      if (id === "new" || isBatchEdit) {
        // Passing parse:true will setup relations
        model = new collection.model({}, {collection: collection, parse: true});

      } else {
        model = collection.get(id);
        if (model === undefined) {
          var primaryColumn = collection.table.get('primary_column');
          var modelData = {};
          modelData[primaryColumn] = id;
          model = new collection.model(modelData, {collection: collection, parse: true});
          model.idAttribute = primaryColumn;
          model.id = id;
        }
      }

      if (isBatchEdit) {
        view = new Table.Views.BatchEdit({model: model, batchIds: id.split(',')});
      } else {
        view = new Table.Views.Edit({model: model});
      }

      this.v.main.setView('#content', view);
      view.render();
    },

    activity: function() {
      if (_.contains(this.navBlacklist,'activity'))
        return this.notFound();

      this.setTitle(app.settings.get('global').get('project_name') + ' | Activity');
      this.v.main.setView('#content', new Activity.Views.List({collection: app.activity}));
      this.v.main.render();
    },

    files: function(pref) {
      if (_.contains(this.navBlacklist,'files'))
        return this.notFound();

      if(pref) {
        this.navigate("/files");

        if(this.lastRoute === "files/" && this.loadedPreference === pref) {
          return;
        }

        this.loadedPreference = pref;
      } else {
        //If no LoadedPref unset
        if(this.loadedPreference && this.lastRoute.indexOf('files/pref/') === -1)
        {
          this.loadedPreference = null;
        }
      }

      this.setTitle(app.settings.get('global').get('project_name') + ' | Files');
      this.v.main.setView('#content', new Files.Views.List({collection: app.files}));
      this.v.main.render();
    },

    filesItem: function(id) {
      var model;

      this.setTitle(app.settings.get('global').get('project_name') + ' | File');

      if (id === "new") {
        model = new app.files.model({}, {collection: app.files});
      } else {
        model = app.files.get(id);
        if (model === undefined) {
          model = new app.files.model({id: id}, {collection: app.files, parse: true});
        }
      }

      this.v.main.setView('#content', new Files.Views.Edit({model: model}));
      this.v.main.render();
    },

    users: function(pref) {
      if(pref) {
        this.navigate("/users");

        if(this.lastRoute === "users/" && this.loadedPreference === pref) {
          return;
        }

        this.loadedPreference = pref;
      } else {
        //If no LoadedPref unset
        if(this.loadedPreference && this.lastRoute.indexOf('users/pref/') === -1)
        {
          this.loadedPreference = null;
        }
      }

      this.setTitle(app.settings.get('global').get('project_name') + ' | Users');
      this.v.main.setView('#content', new Users.Views.List({collection: app.users}));
      this.v.main.render();
    },

    user: function(id) {
      var user = app.users.getCurrentUser();
      var userGroup = user.get('group');

      if (!(parseInt(id,10) === user.id || userGroup.id === 1)) {
        return this.notFound();
      }

      var model;
      this.setTitle(app.settings.get('global').get('project_name') + ' | Users');

      if (id === "new") {
        model = new app.users.model({}, {collection: app.users, parse:true});
      } else {
        model = app.users.get(id);
      }
      this.v.main.setView('#content', new Users.Views.Edit({model: model}));
      this.v.main.render();
    },

    settings: function(name) {
      if (_.contains(this.navBlacklist, 'settings') || app.users.getCurrentUser().get('group').id !== 1) {
        return this.notFound();
      }

      this.setTitle(app.settings.get('global').get('project_name') + ' | '+__t('settings'));

      switch(name) {
        case 'tables':
          this.v.main.setView('#content', new Settings.Tables({collection: SchemaManager.getTables()}));
          break;
        case 'global':
          this.v.main.setView('#content', new Settings.Global({model: app.settings.get('global'), title: __t('global'), structure: SchemaManager.getColumns('settings', 'global')}));
          break;
        case 'files':
          this.v.main.setView('#content', new Settings.Global({model: app.settings.get('files'), title: __t('files'), structure: SchemaManager.getColumns('settings', 'files')}));
          break;
        case 'permissions':
          this.v.main.setView('#content', new Settings.Permissions({collection: app.groups}));
          break;
        case 'system':
          this.v.main.setView('#content', new Settings.System());
          break;
        case 'about':
          this.v.main.setView('#content', new Settings.About());
          break;
        default:
          this.v.main.setView('#content', new Settings.Main({tables: SchemaManager.getTables()}));
          break;
      }

      this.v.main.render();
    },

    settingsTable: function(tableName) {
      if (_.contains(this.navBlacklist, 'settings') || app.users.getCurrentUser().get('group').id !== 1) {
        return this.notFound();
      }

      this.setTitle(app.settings.get('global').get('project_name') + ' | Settings');

      this.v.main.setView('#content', new Settings.Table({model: SchemaManager.getTable(tableName)}));

      this.v.main.render();
    },

    settingsPermissions: function(groupId) {
      if (_.contains(this.navBlacklist, 'settings') || app.users.getCurrentUser().get('group').id !== 1) {
        return this.notFound();
      }

      this.setTitle(app.settings.get('global').get('project_name') + ' | Settings - Permissions');
      var collection = new Settings.GroupPermissions.Collection([], {url: app.API_URL + 'privileges/'+groupId});
      this.v.main.setView('#content', new Settings.GroupPermissions.Page({collection: collection, title: app.groups.get(groupId).get('name')}));
      this.v.main.render();
    },

    messages: function(name) {
      this.setTitle(app.settings.get('global').get('project_name') + ' | Messages')
      this.v.main.setView('#content', new Messages.Views.List({collection: app.messages}));
      this.v.main.render();
    },

    message: function(id) {
      var model = app.messages.get(id);
      this.setTitle(app.settings.get('global').get('project_name') + ' | Message');

      if (model === undefined) {
        model = new app.messages.model({id: id}, {collection: app.messages, parse: true});
        model.fetch();
      }

      this.v.main.setView('#content', new Messages.Views.Read({model: model}));
      this.v.main.render();
    },

    newMessage: function() {
      this.setTitle(app.settings.get('global').get('project_name') + ' | Compose');

      var model = new app.messages.model({from: app.users.getCurrentUser().id}, {collection: app.messages, parse: true});

      this.v.main.setView('#content', new Messages.Views.New({model: model}));
      this.v.main.render();
    },

    onRoute: function(route, fragments) {
      // try to set the current active nav
      var currentPath = Backbone.history.fragment;
      var bookmarksView = this.v.main.getView('#sidebar').getView('#mainSidebar');
      bookmarksView.setActive(currentPath);

      this.lastRoute = currentPath;
      if ( this.loadedPreference ) {
        this.lastRoute += '/' + this.loadedPreference;
      }

      // update user last route
      var currentUser = app.users.getCurrentUser().clone();
      var history = _.clone(Backbone.history);
      currentUser.updateLastRoute(route, history);

      // check for a pending alert to execute
      if(!_.isEmpty(this.pendingAlert)) {
        this.openModal({type: this.pendingAlert.type, text: this.pendingAlert.message});
        this.pendingAlert = {};
      }
    },

    initialize: function(options) {
      this.navBlacklist = (options.navPrivileges.get('nav_blacklist') || '').split(',');
      // @todo: Allow a queue of pending alerts, maybe?
      this.pendingAlert = {};

      //Fade out and remove splash
      $('body').addClass('initial-load');
      this.tabs = options.tabs;
      this.bookmarks = app.getBookmarks();
      this.extensions = {};

      _.each(options.extensions, function(item) {
        try {
          if (typeof item !== 'undefined') {
            this.extensions[item] = ExtensionManager.getInstance(item);
          }
        } catch (e) {
          console.error('failed to load:', e.stack);
          return;
        }
        //this.extensions[item.id].bind('all', logRoute);
        this.extensions[item].on('route', function() {
          this.trigger('subroute',item);
          this.trigger('route:'+item,item);
        }, this);
        //this.tabs.add({title: app.capitalize(item.id), id: item.id, extension: true});
      }, this);

      var user = app.users.getCurrentUser();
      var tabs = new Tabs.View({collection: this.tabs});

      var bookmarks = new Bookmarks.View({collection: this.bookmarks});

      //Top
      var Navbar = Backbone.Layout.extend(
      {

        template: "navbar",

        tagName: 'div',

        serialize: function() {
          return {
            siteUrl: this.model.get('project_url'),
            messageCounter: app.messages.unread,
            cms_thumbnail_url: this.model.get('cms_thumbnail_url')
          };
        },
        beforeRender: function() {
          this.insertView('#featureSidebar', tabs);
          this.insertView('#mainSidebar', bookmarks);
        },

        keep: true
      });

      //holds references to view instances
      this.v = {};
      var nav = new Navbar({model: app.settings.get('global')});

      //var nav = new Navbar({model: app.settings.get('global'), collection: this.tabs});
      this.v.main = new Backbone.Layout({

        el: "#main",

        views: {
          '#sidebar': nav
        }

      });

      this.v.messages = new Backbone.Layout({
        el: "#messages"
      });

      this.routeHistory = {stack: [], base: '', routes: []};
      this.bind('route', this.onRoute, this);

      this.v.main.render();
    }
  });

  return Router;

});

define('alerts',[
  'app',
  'core/notification'
], function(app, Notification) {

  
  // Messages Container
  var messages = new Backbone.Layout({el: '#messages'});

  // Default Error View
  var ErrorView = Backbone.Layout.extend({

      showDetails: false,

      events: {
        'click button.show-details': function() {
          this.showDetails = !this.showDetails;
          this.render();
        },
        'click button.close-alert': function() {
          app.unlockScreen();
          this.remove();
        }
      },

      template: 'error',

      serialize: function() {
        return {message: this.options.message, details: this.options.details, showDetails: this.showDetails};
      }
  });

  var showProgressNotification = function(message) {
    $('a[href$="#activity"] span').removeClass('icon-bell').addClass('icon-cycle');
    app.activityInProgress = true;
    $('#page-blocker').show();
    $('.directus-logo').removeClass('static');
    //app.lockScreen();
  };

  var hideProgressNotification = function() {
    $('a[href$="#activity"] span').addClass('icon-bell').removeClass('icon-cycle');
    app.activityInProgress = false;
    $('#page-blocker').fadeOut(100);

    // Stop animation after cycle completes
    $(".directus-logo").one('animationiteration webkitAnimationIteration', function() {
      $(this).addClass('static');
    });
    //app.unlockScreen();
  };

  // listen to alter events!
  app.on('progress', showProgressNotification);
  app.on('load', hideProgressNotification);

  app.on('alert:error', function(title, details, showDetails, moreOptions) {
    Notification.error(title, details, moreOptions);
  });
});

define('modules/settings/SettingsCollection',[
    'app',
    'backbone',
    'helpers/file',
    'core/collection'
  ],
  function (app, Backbone, FileHelper, Collection) {

    

    var Settings = Collection.extend({

      model: Backbone.Model.extend({
        getStructure: function () {
          return this.structure;
        }
      }),

      isFileAllowed: function (file) {
        var allowed_types = this.get('allowed_filetypes') || '';
        var file_type = file.type || '';
        var allowed = allowed_types.split('|').some(function (item) {
          return file_type.indexOf(item) > -1;
        });

        // this should not be here
        // but, we will let it slide for now.
        if (!allowed) {
          app.router.openModal({type: 'alert', text: 'This type of file is not allowed'});
        }

        return allowed;
      },

      getMaxFileSize: function() {
        var maxBytes = this.get('global').get('max_file_size');

        return FileHelper.humanBytesInfo(maxBytes).size;
      },

      getMaxFileSizeUnit: function() {
        var maxBytes = this.get('global').get('max_file_size');

        return FileHelper.humanBytesInfo(maxBytes).unit;
      },

      isMaxFileSizeExceeded: function(file) {
        var fileSize = (file && file.size) ? file.size : 0;
        var maxFileSizeInBytes = this.get('global').get('max_file_size');
        var exceeded = false;

        if (fileSize > maxFileSizeInBytes) {
          exceeded = true;
        }

        return exceeded;
      }
    });

    return Settings;
  });

define('core/idle',['require','exports','module','jquery'],function(require, exports, module) {

  

  var $ = require('jquery');

  var Idle = module.exports;
  var timerId = null;
  var interruptionEvents = 'mousemove click keydown';

  var resetTimer = function(id, fn, ms) {
    clearTimeout(id);
    return setTimeout(fn, ms);
  };

  Idle.interrupt = function() {
    clearTimeout(timerId);

    if (typeof this.options.interrupt === 'function') {
      this.options.interrupt();
    }

    if (this.options.repeat) {
      timerId = setTimeout(this.fn, this.ms);
    } else {
      this.unbindEvents();
    }
  };

  Idle.bindEvents = function() {
    $(document).on(interruptionEvents, this.interrupt.bind(this));
  };

  Idle.unbindEvents = function() {
    $(document).off(interruptionEvents, this.interrupt);
  };

  Idle.start = function(options) {
    var self = this;

    this.ms = options.delay;
    this.options = options;

    this.fn = function() {
      // stop listening to events after the callback
      self.unbindEvents();
      options.timeout();
    };

    this.bindEvents();

    timerId = resetTimer(timerId, this.fn, this.ms);
  };

});
define('tool-tips',[
  "app",
  "backbone"
], function(app, Backbone) {

  

  var tipManager;

  // Default Error View
  var ToolTip = Backbone.Layout.extend({

        showDetails: false,

        el: '#tool-tips',

        template: 'tool-tips',

        afterRender: function() {
          tipManager.init();
        }

     });

     tipManager = (function() {
        var tipsOn = false,
            tipPointerClass = 'tool-tip-pointer',
            positions = {
                top: 'top',
                bottom: 'bottom',
                left: 'left',
                right: 'right'
            },
            $helpButton,
            $toolTips,
            $elementsToToggle;

        function initToolTips() {
            //$helpButton = $helpButton || $(".global-help");
            $toolTips = $("[data-tool-tip-for]");
            $elementsToToggle = $('[data-tool-tip-toggle-class]');

            //console.log('init called');

            $toolTips.each(function(index, value) {
                var $toolTip = $(this),
                    toolSelector = $toolTip.data("tool-tip-for"),
                    $ttTarget = $(toolSelector),
                    $pointer;

                $toolTip.append('<span class="' + tipPointerClass + '"></span>');
                $pointer = $toolTip.find('.' + tipPointerClass);
                setPosition($toolTip);
                setPointerSize($pointer, $toolTip);
                $toolTip.data("nudge-x") || $toolTip.data("nudge-x", 0);
                $toolTip.data("nudge-y") || $toolTip.data("nudge-y", 0);
                $toolTip.data("offset-x") || $toolTip.data("offset-x", 0);
                $toolTip.data("offset-y") || $toolTip.data("offset-y", 0);
                $toolTip.data("width") ? $toolTip.width($toolTip.data("width")) : null;
                $toolTip.data("height") ? $toolTip.width($toolTip.data("height")) : null;
                offsetPointer($pointer, $toolTip);

                // Use IIFE to capture $ttTarget
                (function() {
                  var tipTimer;

                  $(document).on("mouseenter", $ttTarget.selector,  function() {
                      tipTimer = setTimeout(function() {
                        //console.log($ttTarget.selector);
                          positionToolTip($ttTarget.selector, $toolTip);
                          $toolTip.show();
                      }, 500);
                  }).on("mouseleave click", $ttTarget.selector, function() {
                      clearTimeout(tipTimer);
                      $toolTip.hide();
                  });
                })();

            });
        }

        function setPointerSize($pointer, $toolTip) {
            var borderWidths = $pointer.css(['border-top-width', 'border-right-width', 'border-bottom-width', 'border-left-width']),
                widthArray = [
                parseInt(borderWidths['border-top-width'], 10), parseInt(borderWidths['border-right-width'], 10), parseInt(borderWidths['border-bottom-width'], 10), parseInt(borderWidths['border-left-width'], 10)];
            $toolTip.data('tool-tip-pointer-size', Math.max(widthArray[0], widthArray[1], widthArray[2], widthArray[3]));
        }

        function setPosition($toolTip) {
            var position = positions.bottom;
            if ($toolTip.hasClass(positions.top)) {
                position = positions.top;
            }
            if ($toolTip.hasClass(positions.left)) {
                position = positions.left;
            }
            if ($toolTip.hasClass(positions.right)) {
                position = positions.right;
            }
            $toolTip.data('tool-tip-position', position);
            $toolTip.addClass(position);
            //return positions.bottom;
        }

        function offsetPointer($pointer, $toolTip) {
            if ($toolTip.data("offset-x")) {
                $pointer.css('margin-left', parseInt($pointer.css('margin-left'), 10) - $toolTip.data("offset-x"));
            }
            if ($toolTip.data("offset-y")) {
                $pointer.css('margin-top', parseInt($pointer.css('margin-top'), 10) - $toolTip.data("offset-y"));
            }
        }

        function positionToolTip(ttTarget, $toolTip) {
            var elementOffset, cssOptions, toolTipPointerSize;
            //console.log($ttTarget, $toolTip);
            var $ttTarget = _.isString(ttTarget) ? $(ttTarget) : ttTarget;

            function horizontalCenter() {
                return (($ttTarget.outerWidth() - $toolTip.outerWidth()) / 2) + elementOffset.left + $toolTip.data("offset-x");
            }

            function verticalCenter() {
                return (($ttTarget.outerHeight() - $toolTip.outerHeight()) / 2) + elementOffset.top + $toolTip.data("offset-y");
            }
            if ($ttTarget.length > 0) {
                elementOffset = $ttTarget.offset();
                cssOptions = {
                    position: $toolTip.data("fixed") ? "fixed" : "",
                    zIndex: $toolTip.data("fixed") ? "100" : ""
                };
                toolTipPointerSize = $toolTip.data('tool-tip-pointer-size');
                if ($toolTip.data("fixed")) {
                    elementOffset.top -= $window.scrollTop();
                }
                switch ($toolTip.data('tool-tip-position')) {
                case positions.top:
                    cssOptions.top = elementOffset.top - $toolTip.outerHeight() - toolTipPointerSize;
                    cssOptions.left = horizontalCenter();
                    break;
                case positions.bottom:
                    cssOptions.top = elementOffset.top + $ttTarget.outerHeight() + toolTipPointerSize;
                    cssOptions.left = horizontalCenter();
                    break;
                case positions.left:
                    cssOptions.top = verticalCenter();
                    cssOptions.left = elementOffset.left - $toolTip.outerWidth() - toolTipPointerSize;
                    break;
                case positions.right:
                    cssOptions.top = verticalCenter();
                    cssOptions.left = elementOffset.left + $ttTarget.outerWidth() + toolTipPointerSize;
                    break;
                }
                cssOptions.top += $toolTip.data("nudge-y");
                cssOptions.left += $toolTip.data("nudge-x");
                $toolTip.css(cssOptions);
            } else {
                $toolTip.hide();
            }
        }

        return {
          init: initToolTips
        };
    })();

    return ToolTip;
});
define('core/interval',[],function() {
  var interval = function(callback, wait) {
    setTimeout(function() {
      callback();
      interval(callback, wait);
    }, wait);
  };

  return interval;
});

define('contextual-date',['moment', 'jquery', 'core/interval'], function(moment, $, interval) {
  // time in milliseconds before update
  var waitTime = 60000;
  // loop through all the contextual date updater
  // every 60s and update its contextual date
  var updateTime = function() {
    var $elements = $('.contextual-date-updater[data-date]');

    _.each($elements, function(element) {
      var $element = $(element);
      var date = moment($element.data('date'));

      // @TODO: update gradually
      // update by minutes until an hour
      // update by hour until 24
      // update by date? maybe is too much
      if (date.isValid()) {
        $element.text(date.fromNow());
      }
    });
  };

  interval(updateTime, waitTime);
});


//  main.js
//  Directus 6.0

//  (c) RANGER
//  Directus may be freely distributed under the GNU license.
//  For all details and documentation:
//  http://www.getdirectus.com
require(["config", 'polyfills'], function() {

  require([
    'app',
    'core/UIManager',
    'router',
    'backbone',
    'alerts',
    'core/t',
    'core/tabs',
    'core/bookmarks',
    'modules/messages/messages',
    'schema/SchemaManager',
    'modules/settings/SettingsCollection',
    'core/ExtensionManager',
    'core/EntriesManager',
    'core/ListViewManager',
    'core/idle',
    'tool-tips',
    'contextual-date',
    'core/notification'
  ],

  function(app, UIManager, Router, Backbone, alerts, __t, Tabs, Bookmarks, Messages, SchemaManager, SettingsCollection, ExtensionManager, EntriesManager, ListViewManager, Idle, ToolTip, ContextualDate, Notification) {

    

    var defaultOptions = {
      locale: 'en',
      localesAvailable: [],
      timezone: 'America/New_York',
      timezones: [],
      countries: [],
      path: '/directus/',
      page: '',
      authenticatedUser: 7,
      groups: {},
      privileges: [],
      ui: [],
      active_files: {},
      users: {},
      bookmarks: {},
      extensions: [],
      messages: {},
      user_notifications: [],
      me: { id: 7 },
      settings: {
        global: {},
        files: {}
      },
      storage_adapters: {},
      // tab_privileges: {},
      preferences: [],
      tables: [],
      nonces: {
        pool: [],
        nonce_pool_size: 10,
        nonce_request_header: "X-Directus-Request-Nonce",
        nonce_response_header: "X-Directus-New-Request-Nonces"
      }
    };

    var options = _.defaults(window.directusData, defaultOptions);

    // Setup global variables
    app.root = options.path;
    app.DEFAULT_VALIDATION_MESSAGE = 'Invalid content...';
    app.API_URL = options.path + 'api/1/';
    app.RESOURCES_URL = '/resources/';
    app.PATH = options.path;
    app.authenticatedUserId = window.directusData.authenticatedUser;
    app.storageAdapters = window.directusData.storage_adapters;
    app.statusMapping = window.directusData.statusMapping;
    app.locale = options.locale;
    app.locales = options.localesAvailable;
    app.timezone = options.timezone;
    app.timezones = options.timezones;
    app.countries = options.countries;
    app.user_notifications = options.user_notifications;

    $.xhrPool = []; // array of uncompleted requests
    $.xhrPool.abortAll = function() { // our abort function
        $(this).each(function(idx, jqXHR) {
            jqXHR.abort();
        });
        $.xhrPool.length = 0;
    };

    $.ajaxSetup({
        beforeSend: function(jqXHR) { // before jQuery send the request we will push it to our array
            $.xhrPool.push(jqXHR);
        },
        complete: function(jqXHR) { // when some of the requests completed it will splice from the array
            var index = $.xhrPool.indexOf(jqXHR);
            if (index > -1) {
                $.xhrPool.splice(index, 1);
            }
        }
    });

    // This needs elegance
    app.settings = new SettingsCollection(options.settings, {parse: true});
    app.settings.url = app.API_URL + 'settings';

    UIManager.setup();
    SchemaManager.setup({apiURL: app.API_URL});

    app.schemaManager = SchemaManager;

    // Load extenral UI / extensions
    $.when(
      UIManager.load(options.ui),
      ExtensionManager.load(options.extensions),
      ListViewManager.load(options.listViews)

    ).done(function() {

      var autoLogoutMinutes = parseInt(app.settings.get('global').get('cms_user_auto_sign_out') || 60, 10);

      var waitForForAvtivity = function() {
        //console.log('minutes until automatic logout:', autoLogoutMinutes);

        Idle.start({
          timeout: function() {
            Notification.warning(null, 'You\'ve been inactive for ' + autoLogoutMinutes + ' minutes. You will be automatically logged out in 10 seconds');

            //Wait for another 10 seconds before kicking the user out
            Idle.start({
              timeout: function() {
                app.logOut(true);
              },
              interrupt: waitForForAvtivity,
              delay: 10000,
              repeat: false
            });

          },
          delay: autoLogoutMinutes * 60 * 1000,
          repeat: true
        });

      };

      waitForForAvtivity();

      // Register UI schemas
      SchemaManager.registerUISchemas(UIManager.getAllSettings());
      SchemaManager.addSettings(UIManager.getDirectusSettings());

      // Register Table Schemas
      SchemaManager.register('tables', options.tables);

      // Register Preferences
      SchemaManager.registerPreferences(options.preferences);

      // Register Privileges
      SchemaManager.registerPrivileges(options.privileges);

      // Extend user schema with extra fields
      SchemaManager.getColumns('tables', 'directus_users').add(options.extendedUserColumns, {parse: true});

      EntriesManager.setup({
        apiURL: app.API_URL,
        rowsPerPage: parseInt(app.settings.get('global').get('rows_per_page'), 10)
      });

      ////////////////////////////////////////////////////////////////////////////////////
      // Setup global instances

      app.users    = EntriesManager.getInstance('directus_users');
      app.files    = EntriesManager.getInstance('directus_files');
      app.activity = EntriesManager.getInstance('directus_activity');
      app.groups   = EntriesManager.getInstance('directus_groups');

      // Proxy to EntriesManager
      app.getEntries = function(tableName, options) { return EntriesManager.getInstance(tableName, options); };

      app.messages = new Messages.Collection([], _.extend({
        url: app.API_URL + 'messages/rows/'
      }, SchemaManager.getFullSchema('directus_messages')));

      app.messages.on('error:polling', function() {
        Notification.error('Directus can\'t reach the server', '<i>A new attempt will be made in 30 seconds</i>');
      });

      app.messages.on('sync', function(collection, object) {
        if (object !== null && object.rows) {
          object.rows.forEach(function(msg) {
            var message_excerpt = (msg.message && msg.message.length > 50) ? msg.message.substr(0, 50) : msg.message;
            Notification.show('New Message — <i>' + msg.subject + '</i>', message_excerpt + '<br><br><i>View message</i>', {timeout: 5000,
              callback: {
                onCloseClick: function() {
                  Backbone.history.navigate('/messages/' + msg.id, true);
                }
              }
            });
          });
        }
      });

      // Bootstrap data
      app.groups.reset(options.groups, {parse: true});
      app.users.reset(options.users, {parse: true});
      app.files.reset(options.active_files, {parse: true});
      app.messages.reset(options.messages, {parse: true});

      app.messages.startPolling();


      ////////////////////////////////////////////////////////////////////////////////////
      // Bind Progress Functions To App

      app.showProgressNotification = function(message) {
        alerts.showProgressNotification(message);
      };

      app.hideProgressNotification = function() {
        alerts.hideProgressNotification();
      };

      $('#page-blocker').fadeOut(0);

      ////////////////////////////////////////////////////////////////////////////////////
      // Setup Tabs @TODO: REMOVE
      // Default directus tabs

      var tabs = [
        {id: "users/" + app.users.getCurrentUser().get("id"), icon_class: "icon-pencil", avatar: ''},
        {id: "logout", icon_class: "icon-power-button"}
      ];

      if(app.users.getCurrentUser().get('group').id === 1) {
        tabs.unshift();
      }

      ////////////////////////////////////////////////////////////////////////////////////
      // Setup Bookmarks
      ////////////////////////////////////////////////////////////////////////////////////
      var bookmarks = [];

      options.tables.forEach(function(table) {
        table = table.schema;
        if(SchemaManager.getPrivileges(table.table_name)) {
        var privileges = SchemaManager.getPrivileges(table.table_name);
        if(privileges.get('allow_view') > 0 && !table.hidden && privileges.get('nav_listed') > 0) {
            bookmarks.push(new Backbone.Model({
              icon_class: '',
              title: app.capitalize(table.table_name),
              url: 'tables/' + encodeURIComponent(table.table_name),
              section: 'table'
            }));
          }
        }
      });

      var bookmarksData = window.directusData.bookmarks;
      _.each(bookmarksData, function(bookmark) {
        bookmarks.push(new Backbone.Model(bookmark));
      });

      var extensions = ExtensionManager.getIds();

      // Add extensions to bookmarks
      _.each(extensions, function(item) {
        item = ExtensionManager.getInfo(item);
        bookmarks.push(new Backbone.Model({
          icon_class: item.icon,
          title: item.title,
          url: item.path,
          section: 'extension'
        }));
      });

      // Grab nav permissions
      var currentUserGroupId = app.users.getCurrentUser().get('group').get('id');
      var currentUserGroup = app.groups.get(currentUserGroupId);
      var navBlacklist = (currentUserGroup.get('nav_blacklist') || '').split(',');

      // Custom Bookmarks Nav
      var customBookmarks = [];
      if (currentUserGroup.get('nav_override') !== false) {
        for (var section in currentUserGroup.get('nav_override')) {
          var sectionItems = currentUserGroup.get('nav_override')[section]
          // @todo: check this is not a string, but a valid object.
          for(var item in sectionItems) {
            var path = sectionItems[item].path || '';
            customBookmarks.push(new Backbone.Model({
              icon_class: item.icon,
              title: item,
              url: path,
              section: section
            }));
          }
        }
      } else {
        console.error("The nav override JSON for this user group is malformed – the default nav will be used instead");
      }

      var isCustomBookmarks = false;
      if(customBookmarks.length) {
        isCustomBookmarks = true;
        bookmarks = bookmarks.concat(customBookmarks);
      }

      // Filter out blacklisted bookmarks (case-sensitive)
      bookmarks = _.filter(bookmarks, function(bookmark) {
        return !_.contains(navBlacklist, bookmark.attributes.title);
      });

      // Turn into collection
      tabs = new Tabs.Collection(tabs);

      app.bookmarks = new Bookmarks.Collection(bookmarks, {isCustomBookmarks: isCustomBookmarks});

      //////////////////////////////////////////////////////////////////////////////
      //Override backbone sync for custom error handling
      var sync = Backbone.sync;

      Backbone.sync = function(method, model, options) {

        var existingErrorHandler = function(){};
        if(undefined !== options.error)
          existingErrorHandler = options.error;

        var errorCodeHandler = function(xhr, status, thrown) {
          //@todo: note that status is getting overwritten. don't!
          status = xhr.status;

          existingErrorHandler(xhr, status, thrown);

          switch(status) {
            case 404:
              app.router.notFound();
              break;
            case 401:
              window.location = app.root;
              break;
            case 500:
              break;
          }
        };

        if (options.errorPropagation !== false) {
          options.error = errorCodeHandler;
        }

        // Force fix: https://github.com/RNGR/Directus/issues/776
        // when $.ajax global is false there's not global event fired
        // the code below wouldn't run on .ajaxSend
        // therefore we run it here

        if(options.global === false) {
          var url = '';
          var collection = {};

          if (model.url) {
            collection = model;
          } else if(model.collection) {
            collection = model.collection;
          }

          if(typeof collection.url === "function") {
            url = collection.url();
          } else {
            url = collection.url;
          }

          if (url) {
            var isApiRequest = url.substr(0, app.API_URL.length) === app.API_URL;
            if(isApiRequest) {
              nonce = nonces.pool.unshift();
              options.beforeSend = function(xhr) {
                xhr.setRequestHeader(nonces.nonce_request_header, nonce);
              };
              options.complete = function(xhr) {
                var new_nonces = xhr.getResponseHeader(nonces.nonce_response_header);
                if(new_nonces) {
                  new_nonces = new_nonces.split(',');
                  nonces.pool.push.apply(nonces.pool, new_nonces);
                }
              };
            }
          }
        }

        return sync(method, model, options);
      };

      // Toggle responsive navigation
      $(document).on("click", ".responsive-nav-toggle", function(e) {
        $('#main').toggleClass('sidebar-active');
        $('.invisible-blocker').toggleClass('sidebar-active');
      });

      // Close sidebar when clicking
      $(document).on("click", "#sidebar", function(e) {
        $('#main').removeClass('sidebar-active');
        $('.invisible-blocker').removeClass('sidebar-active');
      });

      // Cancel default file drop
      $(document).on('drop dragover', function(e) {
        e.preventDefault();
      });

      $(document).on('mousewheel DOMMouseScroll', function(e) {
        if (app.noScroll && event.target.nodeName !== 'TEXTAREA') {
          e.preventDefault();
        }
      });

      //Cancel default CMD + S;
      $(window).keydown(_.bind(function(e) {
        if (e.keyCode === 83 && e.metaKey) {
          e.preventDefault();
        }
      }, this));

      //@todo: move these event handlers to alerts.js
      $(document).on('ajaxStart.directus', function(e) {
        app.trigger('progress');
      });

      $(document).on('ajaxStop.directus', function(e) {
        app.trigger('load');
      });

      // Capture sync errors...
      $(document).ajaxError(function(e, xhr, settings) {
        if (settings.errorPropagation === false) {
          return;
        }

        var type, messageTitle, messageBody, details;
        if(xhr.statusText === "abort") {
          return;
        }

        if(xhr.responseJSON) {
          messageBody = xhr.responseJSON.message;
        } else {
          messageBody = xhr.responseText;
        }

        switch(xhr.status) {
          case 404:
            messageTitle = __t('not_found');
            messageBody = __t('x_not_found', {what: 'URL'}) + '<br>' + settings.url;
            break;
          case 403:
            // var response = $.parseJSON(xhr.responseText);
            messageTitle = __t('restricted_access');
            // messageBody = "You don't have permission to access this table. Please send this to IT:<br>\n\n" + xhr.responseText;
            details = true;
            break;
          case 413:
            details = false;
            messageTitle = __t('max_file_size_exceeded_x_x', {
              size: app.settings.getMaxFileSize(),
              unit: app.settings.getMaxFileSizeUnit()
            });
            break;
          default:
            type = 'Server ' + xhr.status;
            messageTitle = __t('server_error');
            details = encodeURIComponent(xhr.responseText);

            if (_.isString(messageBody)) {
              try {
                messageBody = JSON.parse(messageBody);
              } catch (e) {
                // do nothing
              }
            }

            if (messageBody.message) {
              messageBody = messageBody.message;
              details = false;
            }

            // app.logErrorToServer(type, messageTitle, details);
            break;
        }

        app.trigger('alert:error', messageTitle, messageBody, details)
      });

      // And js errors...
      window.onerror = function(message, file, line) {
        var type = 'JS';
        var details = 'Error: ' + message + '\nFile: ' + file + '\n Line:' + line;
        // app.logErrorToServer(type, 'Error', details);
        app.trigger('alert:error', 'Error', details);
      };

      /**
       * Add nonce to API requests using custom request header
       *
       * @todo  modularize this logic
       */
      var nonces = window.directusData.nonces,
          nonce;

      $(document).ajaxSend(function(event, jqXHR, settings) {
        var isApiRequest = settings.url.substr(0, app.API_URL.length) === app.API_URL;
        if(isApiRequest) {
          nonce = nonces.pool.unshift();
          jqXHR.setRequestHeader(nonces.nonce_request_header, nonce);
          // console.log('Using a nonce. New pool size: ' + nonces.pool.length);
        }
      });

      /**
       * Pull in new nonces from response headers
       */

      $(document).ajaxSuccess(function(event, xhr, settings) {
        var new_nonces = xhr.getResponseHeader(nonces.nonce_response_header);
        if(new_nonces) {
          new_nonces = new_nonces.split(',');
          // console.log('Got ' + new_nonces.length + ' new nonces:', new_nonces);
          // console.log('Old nonce pool size: ' + nonces.pool.length);
          nonces.pool.push.apply(nonces.pool, new_nonces);
          // console.log('New nonce pool size: ' + nonces.pool.length);
        }
      });


      app.router = new Router({extensions: extensions, tabs: tabs, navPrivileges: app.users.getCurrentUser().get('group')});

      // Trigger the initial route and enable HTML5 History API support, set the
      // root folder to '/' by default.  Change in app.js.
      Backbone.history.start({ pushState: true, root: app.root });

      // All navigation that is relative should be passed through the navigate
      // method, to be processed by the router. If the link has a `data-bypass`
      // attribute, bypass the delegation completely.
      $(document).on("click", "a[href]:not([data-bypass])", function(evt) {
        // Get the absolute anchor href.
        var href = {
          prop: $(this).prop('href'),
          attr: $(this).attr('href'),
          target: $(this).attr('target')
        };
        // Get the absolute root.
        var root = location.protocol + "//" + location.host + app.root;

        // Ensure the root is part of the anchor href, meaning it's relative.
        // @NOTE: We don't need to strictly check for "_blank".
        //        it needs to be case insensitive.
        var target = (href.target || '').toLowerCase();
        if (href.prop.slice(0, root.length) === root && target !== '_blank') {
          // Stop the default event to ensure the link will not cause a page
          // refresh.
          evt.preventDefault();

          // Don't follow empty links
          if (href.attr === '#') return;

          // Remove the directus sub-path from the anchor href
          // Backbone.history already have app.root as root.
          var path = (href.attr || '/');
          if (path.startsWith(app.root)) {
            path = path.slice(app.root.length);
          }

          // `Backbone.history.navigate` is sufficient for all Routers and will
          // trigger the correct events. The Router's internal `navigate` method
          // calls this anyways.  The fragment is sliced from the root.

          Backbone.history.navigate(path, true);
        }
      }).on('scroll', function(){
        // Fade in header shadow based on scroll position
        var windowScroll = Math.max(Math.min($(window).scrollTop(), 100), 0) / 100;
        $('#header-shadow').css({ opacity: windowScroll });
      });

      var toolTip = new ToolTip();
      toolTip.render();

      $(document).on('click', '.toggle-help-text', function(event) {
        var text = $(this).data('help-text');
        if (text) {
          app.router.openModal({type: 'alert', text: text});
        }
      });

    });

  });
});

define("main", function(){});
}());